DBUG     TITLE 'Exec DEBUG and MONITOR Commands/Routines'                       
*******************************************************************             
*                                                                 *             
*     WYLBUR/370 - Release VI - Class I - Stanford Proprietary    *             
*                                                                 *             
*******************************************************************             
         HIBAL                                                                  
*                                                                               
         EJECT                                                                  
WYLDBUG  CSECT                                                                  
         REGS  FSR,,,,,,,BR,(WAR,LSR),PAR,PBR,CPR,CVR,SPR,RAR                   
*                                                                               
DBUG     IDENT 2163                19:08:17 06/11/92 (JDN)                      
*                                                                               
         SYSDEFN ,                 Define installation values                   
*                                                                               
         PUSH  DSECTS                                                           
         TITLE 'DSECTS'                                                         
         COPY  CONTROL             Copy CV/CP                                   
         TITLE 'DSECTS'                                                         
JCB      RECORD BEGIN                                                           
         COPY  JCB                                                              
         END                                                                    
         POP   DSECTS                                                           
WYLDBUG  CSECT                                                                  
         DC    C'DO IT TO IT!'                                                  
*                                                                               
         EJECT                                                                  
*-                                                                              
*-       COPY DSECTS TO HERE                                                    
*-                                                                              
         TITLE 'EXEC DEBUGGER DSECTS'                                           
         COPY  XDSNAME                                                          
         EJECT                                                                  
*-                                                                              
*-                                                                              
*-       DEBUG TRAP RECORDS                                                     
*-                                                                              
*-       THREE TYPES OF DEBUG TRAP RECORDS ARE KEPT:                            
*-         1. LINE TRAP                                                         
*-         2. PROC/XPROC NAME TRAP                                              
*-         3. PROC/XPROC RETURN TRAP                                            
*-                                                                              
*-       NOTE: ALL TRAPS  MUST HAVE A UNIQUE SEQUENCE NUMBER IN THE             
*-       TRAP RECORD NAME.  SO THAT TRAPS ON THE SAME LINE NUMBER OR            
*-       SAME PROC NAME IN DIFFERENT EXECS WILL HAVE UNIQUE TRAP                
*-       ENTRIES.                                                               
*-                                                                              
*-     NOTE: IF DT.ALL FLAG SET, WE STOP AT TRAP FOR ALL EXEC FILES.            
*-                                                                              
*-                                                                              
DTL      RECORD BEGIN              DEBUG TRAP LINE RECORD                       
DTLNAME  DS    XL16                NAME:                                        
         ORG   DTLNAME                                                          
DTLNMLIN DS    F                     LINE NUMBER                                
         ORG   DTLNAME+12                                                       
DTLNMSEQ DS    F                     SEQUENCE NUMBER                            
         ORG                                                                    
DTLDATA  DS    XL(4+4+L'XDSNAME)   DATA:                                        
         ORG   DTLDATA                                                          
DTLFLAGS FLAG  ,                     FLAGS,                                     
         FLAG  DTLALL                  GENERAL TRAP, TRAP ALL EXECS             
         FLAG  ,                                                                
         FLAG  ,                                                                
         FLAG  ,                                                                
DTLLINE  DS    F                     TRAP LINE                                  
DTLXNAME DS    XL(L'XDSNAME)         TRAP EXEC NAME                             
         END                                                                    
*                                                                               
*                                                                               
DTN      RECORD BEGIN              DEBUG TRAP NAME RECORD                       
DTNNAME  DS    XL16                NAME:                                        
         ORG   DTNNAME                                                          
DTNNMNAM DS    CL12                  NAME (12 CHARS)                            
         ORG   DTNNAME+12                                                       
DTNNMSEQ DS    F                     SEQUENCE NUMBER                            
         ORG                                                                    
DTNDATA  DS    XL(4+16+L'XDSNAME)   DATA:                                       
         ORG   DTNDATA                                                          
DTNFLAGS FLAG  ,                     FLAGS,                                     
         FLAG  DTNALL                  GENERAL TRAP, TRAP ALL EXECS             
         FLAG  ,                                                                
         FLAG  ,                                                                
         FLAG  ,                                                                
DTNPNAME DS    CL16                  TRAP PROC NAME                             
DTNXNAME DS    XL(L'XDSNAME)         TRAP EXEC NAME                             
         END                                                                    
*                                                                               
*                                                                               
DTR      RECORD BEGIN              DEBUG TRAP RETURN RECORD                     
DTRNAME  DS    XL16                NAME:                                        
         ORG   DTRNAME                                                          
DTRNMNAM DS    CL12                  NAME (12 CHARS)                            
         ORG   DTRNAME+12                                                       
DTRNMSEQ DS    F                     SEQUENCE NUMBER                            
         ORG                                                                    
DTRDATA  DS    XL(4+16+L'XDSNAME)   DATA:                                       
         ORG   DTRDATA                                                          
DTRFLAGS FLAG  ,                     FLAGS,                                     
         FLAG  DTRALL                  GENERAL TRAP, TRAP ALL EXECS             
         FLAG  ,                                                                
         FLAG  ,                                                                
         FLAG  ,                                                                
DTRPNAME DS    CL16                  TRAP PROC NAME                             
DTRXNAME DS    XL(L'XDSNAME)         TRAP EXEC NAME                             
         END                                                                    
         TITLE 'EXEC MONITOR DSECTS'                                            
*box                                                                            
*                                                                               
*                                                                               
*  MONITOR DSECTS AND EQU'S                                                     
*                                                                               
*                                                                               
*  MMB - MONITOR MEMORY BLOCK DSECT                                             
*                                                                               
*  NOTES ON MMB DSECT:                                                          
*  MMBEND IS USED TO TEST AGAINST TO SEE IF THERE IS ROOM TO                    
*  ADD ANOTHER ENTRY, THUS IT IS A BIT SHORT OF THE ACTUAL END                  
*  OF BLOCK.                                                                    
*  MMBLINK IS NEVER ZERO, IT IS A CIRCULARLY LINKED LIST, IF                    
*  MEMORY IS LESS THAN THE TOTAL ALLOWED, WE ADD A NEW BLOCK                    
*  EACH TIME WE GET TO THE END OF A CURRENT BLOCK, AFTER THAT                   
*  NEW ENTRIES WILL OVERWRITE SOME OF THE OLDEST ONES.                          
*                                                                               
*                                                                               
MMB      RECORD BEGIN              MONITOR MEMORY BLOCK LAYOUT                  
MMBLEN   DS    F                   MEMORY BLOCK LENGTH                          
MMBHEAD  DS    F                   FIRST BLOCK IN CHAIN                         
MMBLINK  DS    F                   LINK TO NEXT BLOCK IN CHAIN                  
MMBTMEM  DS    F                   MEMORY TOTAL IN ALL BLOCKS                   
MMBEND   DS    F                   MEMORY BLOCK END - L'MONENTRY                
MMBPTR   DS    F                   NEXT MONITOR MEMORY POINTER                  
MMBXLINE DS    F                   EXEC LINE NUMBER                             
MMBXSET  DS    F                   EXEC SET NUMBER                              
MMBDATA  EQU   *                   START OF ENTRIES                             
         END                                                                    
*-                                                                              
*-                                                                              
*-       MONITOR ENTRY DSECT                                                    
*-                                                                              
MONENTRY RECORD BEGIN              MONITOR ENTRY                                
MONXLINE DS    F                   EXEC LINE NUMBER                             
MONXSET  DS    F                   EXEC SET NUMBER                              
MONCPU   DS    F                   CPU TIME FOR LINE (IN TU'S)                  
         END                                                                    
*-                                                                              
*-                                                                              
*-       MONITOR EQU'S                                                          
*-                                                                              
MMEMMAX  EQU   1024*1000           MAX 1000K                                    
MMEMBIG  EQU   1024*100            BIG 100K                                     
MMEMMIN  EQU   1024*8-64           MIN 8K - 64                                  
MMEMFDGE EQU   256                 FUDGE FACTOR FOR MEM BLK HDR INFO            
MMEMDFLT EQU   MMEMMIN             DEFAULT IS MINIMUM                           
MMEMBSZ  EQU   1024*8-32           DEFAULT BLOCK SIZE REQUEST                   
MAXBIGCT EQU   3                   MAX XMON SESSIONS GT MMEMBIG                 
         EJECT                                                                  
*-                                                                              
*-                                                                              
*-       MONITOR INFORMATION RECORD DSECTS                                      
*-                                                                              
*-       THREE TYPES OF RECORDS ARE SAVED AS MONITOR INFORMATION:               
*-       1. RAW RECORDS, THE RAW MONITOR DATA, 1 ENTRY FOR EACH TIME            
*-          A LINE IS EXECUTED                                                  
*-       2. SUMMARY RECORDS, ONE RECORD FOR EACH EXEC LINE, CONTAINS            
*-          EXECUTION COUNT AND TOTAL CPU FOR EXEC LINE                         
*-      3. SET NUMBER / EXEC NAME RECORDS, THESE RECORDS ARE USED TO            
*-         ASSOCIATE SET NUMBERS WITH REAL EXEC DATA SET NAMES.  THE            
*-        DSN NAME IS SAVED IN XDSNAME FORMAT PADDED WITH BLANKS NOT            
*-          ZEROS.  SEE SETXNAME ROUTINE IN XCALL MODULE.                       
*-                                                                              
*-       CAUTION: NAME FIELD MUST BE 16 BYTES LONG !                            
*-                                                                              
MRR      RECORD BEGIN              MONITOR RAW RECORD DSECT                     
MRRNAME  DS    XL16                NAME:                                        
MRRNMSEQ EQU   MRRNAME               SEQUENCE NUMBER                            
MRRDATA  DS    XL12                DATA:                                        
         ORG   MRRDATA                                                          
MRRXLINE DS    F                     EXEC LINE NUMBER                           
MRRXSET  DS    F                     EXEC SET NUMBER                            
MRRCPU   DS    F                     CPU FOR LINE EXECUTION                     
         END                                                                    
*                                                                               
*                                                                               
MSR      RECORD BEGIN              MONITOR SUMMARY RECORD                       
MSRNAME  DS    XL16                NAME:                                        
MSRNMSET EQU   MSRNAME               EXEC SET NUMBER   [ORDER]                  
MSRNMLIN EQU   MSRNAME+4             EXEC SET LINE     [ORDER]                  
MSRDATA  DS    XL16                DATA:                                        
         ORG   MSRDATA                                                          
MSRXLINE DS    F                      LINE NUMBER                               
MSRXSET  DS    F                      SET NUMBER                                
MSRTCPU  DS    F                      TOTAL CPU TIME (TU'S)                     
MSRCNT   DS    F                      TOTAL EXECUTION COUNT                     
         END                                                                    
*                                                                               
*                                                                               
MNR      RECORD BEGIN              MONITOR NAME RECORD                          
MNRNAME  DS    XL16                NAME:                                        
MNRNMSET EQU   MNRNAME               EXEC SET NUMBER                            
MNRDATA  DS    CL64                DATA:                                        
         ORG   MNRDATA                                                          
MNRXNAME DS    CL(L'XDSNAME)         EXEC NAME FOR SET#                         
         END                                                                    
         TITLE 'DeBUG MoDULE'                                                   
*box                                                                            
*                                                                               
*                                                                               
*  INITDBUG - INITIALIZE DEBUG MODULE                                           
*                                                                               
*                                                                               
*  CALLED AT USER LOGON.                                                        
*                                                                               
*                                                                               
*                                                                               
INITDBUG XPROC ,                                                                
*                                                                               
         COMMENT                   INITIALIZE DEBUG STUFF                       
         CLEAR CPFDEBUG                                                         
         CLEAR CPFTRACE                                                         
         CLEAR CPFTTRAP                                                         
         CLEAR CPFDNEXT                                                         
         CLEAR CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         CLEAR CPFISTOP                                                         
         CLEAR CPFISTPD                                                         
         CLEAR CPFIDONE                                                         
         CLEAR CPTRAPSQ                                                         
*                                                                               
         COMMENT                   INITIALIZE MONITOR STUFF                     
         CLEAR CPFMON                                                           
         CLEAR CPMONPTR                                                         
         CLEAR CPMONCPU                                                         
         CLEAR CPMONMAX                                                         
*                                                                               
         PEND  ,                                                                
         TITLE 'DEBUG Execution Routines'                                       
*box                                                                            
*                                                                               
*                                                                               
*  DBLINE - DEBUG LINE                                                          
*                                                                               
*  ON ENTRY:                                                                    
*       CPEXLINE - EXEC LINE NUMBER                                             
*       CP#XSET - EXEC FILE SET NUMBER                                          
*                                                                               
*  THIS ROUTINE IS CALLED TO HANDLE ALL DEBUGING TRAPS.  IT                     
*  IS SOMEWHAT TRICKY IN THAT EVERYTHING MUST BE HANDLED IN                     
*  PROPER ORDER. SOME GENERAL EXPLANATION FOLLOWS...                            
*                                                                               
*  NORMAL TRAP FLAGS:                                                           
*    NEXT FLAG - STOP BEFORE NEXT COMMAND EXECUTION                             
*    STOP FLAG - STOP BEFORE EXECUTING THIS COMMAND                             
*    STOPPED FLAG - WE ARE AT A STOP                                            
*  AT EACH EXEC COMMAND EXECUTION THESE FLAGS ARE CHECKED AND                   
*  PROCESSED.  ORDER IN PROCESSING                                              
*  THESE FLAGS IS IMPORTANT... IF WE ARE 'STOPPED', WE DO NOT                   
*  PROCESS A 'STOP' FLAG,, AS IT HAS ALREADY BEEN PROCESSED AND                 
*  WE HAVE 'STOPPED', AND SO WE DO NOT STOP AGAIN.  THESE THREE                 
*  FLAGS ROTATE AROUND AS FOLLOWS:                                              
*       NEXT -> STOP -> STOPPED...                                              
*  WE PROCESS THE FOLLOWING CASES:                                              
*       NEXT,                                                                   
*       STOP,                                                                   
*       STOPPED,                  (IGNORE STOP FLAG IF SET)                     
*       NEXT AND STOPPED.                                                       
*                                                                               
*  IMMEDIATE STOP FLAGS:                                                        
*  A SIMILAR MECHANISM IS USED FOR STOPPING BEFORE A RETURN                     
*  COMMAND... THIS MECHANISM IS KNOWN AS AN IMMEDIATE STOP.                     
*  IT USES THE FOLLOWING 3 FLAGS:                                               
*       ISTOP  -> ISTOPPED  -> IDONE                                            
*  THE IDONE FLAG IS NEEDED SO THAT THE COMMAND CAN CHECK IF                    
*  IT HAS ALREADY BEEN STOPPED.  CURRENTLY THIS SET OF FLAGS IS                 
*  IS ONLY USED TO STOP BEFORE AN 'XRETURN' OR 'RETURN' COMMAND                 
*  IS EXECUTED.  THIS TYPE OF STOP OVERRIDES THE OTHER STOP FLAGS               
*  AS IT IS IMMEDIATELY TAKEN.                                                  
*  WE PROCESS THE FOLLOWING CASES:                                              
*       ISTOP,    (WE CLEAR ANY REGULAR NEXT, STOP, STOPPED FLAGS)              
*       ISTOPPED                                                                
*       NEXT AND ISTOPPED                                                       
*       IDONE                                                                   
*                                                                               
*  THE FOLLOWING ROUTINES SET THESE FLAGS EXTERNAL TO THIS ROUTINE:             
*       NEXT - 'DEBUG NEXT' TYPED      (ONLY ALLOWED AT TRAP BREAK)             
*       STOP - 'LINE NUMBER TRAP' HIT  (SET HERE)                               
*       STOP - 'PROC NAME TRAP' HIT    (IN XCALL,PCALL)                         
*       ISTOP - 'RETURN TRAP' HIT      (IN XRETURN, RETURN)                     
*  THE REMAINING FLAGS ARE STATE FLAGS AND ARE PROCESSED CAREFULLY              
*  BELOW.                                                                       
*                                                                               
*                                                                               
*                                                                               
DBLINE   XPROC                                                                  
*-                                                                              
*-       Only debug non-publoaded execs.                                        
*-                                                                              
         IF    ('CLC CP#XSET,=A(CV#FEXEC)',GE),EXIT  Scram                      
*                                                                               
         COMMENT                   CHECK FOR LINE TRAP                          
         L     R0,CP#XSET                                                       
         L     R1,CPEXLINE                                                      
         ACALL CHKLINE                                                          
         IF    Z,BEGIN             IF GOT TRAP, SET STOP FLAG                   
         SET   CPFDSTOP                                                         
         END                                                                    
         COMMENT                   PROCESS STOP FLAGS                           
         COMMENT                   NOTE: ORDER OF PROCESSING IS                 
         COMMENT                    CRITICAL, DO NOT MESS IT UP !!              
*                                                                               
         COMMENT                   CLEAR ANY LEFT OVER ISTOP DONE               
         CLEAR CPFIDONE                                                         
*                                                                               
         COMMENT                   IF STOPPED IMMEDIATE  (NO NEXT)              
         IF    (CPFISTPD,AND,^CPFDNEXT),BEGIN                                   
         CLEAR CPFDNEXT                                                         
         CLEAR CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         CLEAR CPFISTOP                                                         
         CLEAR CPFISTPD                                                         
         SET   CPFIDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   IF STOPPED IMMEDIATE  (NEXT SET)             
         ELSEIF (CPFISTPD,AND,CPFDNEXT),BEGIN                                   
         CLEAR CPFDNEXT                                                         
         SET   CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         CLEAR CPFISTOP                                                         
         CLEAR CPFISTPD                                                         
         SET   CPFIDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   IF STOP IMMEDIATE                            
         ELSEIF CPFISTOP,BEGIN                                                  
         CLEAR CPFDNEXT                                                         
         CLEAR CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         CLEAR CPFISTOP                                                         
         SET   CPFISTPD                                                         
         CLEAR CPFIDONE                                                         
         MVC   CPEXNEXT,CPEXLINE                                                
         ACALL STOPMSG                                                          
         VCALL EXPAUSE                                                          
         END                                                                    
*                                                                               
         COMMENT                   IF STOPPED  (NO NEXT)                        
         ELSEIF (CPFDSTPD,AND,^CPFDNEXT),BEGIN                                  
         CLEAR CPFDNEXT                                                         
         CLEAR CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         END                                                                    
*                                                                               
         COMMENT                   IF STOPPED  (NEXT SET)                       
         ELSEIF (CPFDSTPD,AND,CPFDNEXT),BEGIN                                   
         CLEAR CPFDNEXT                                                         
         SET   CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         END                                                                    
*                                                                               
         COMMENT                   IF STOP,                                     
         ELSEIF CPFDSTOP,BEGIN                                                  
         COMMENT NEXT CAN ONLY BE SET BY DEBUG NEXT COMMAND DURING              
         COMMENT ...                                                            
         IF    CPFDNEXT,BEGIN                                                   
*$  STOP AND NEXT CAN HAPPEN SOMEHOW IF DNEXT IS REPEATEDLY HIT                 
*$  THRU THE END AND START OF A NEW EXEC ??? OR SOMEHOW.!                       
*        BOMB                                                                   
         END                                                                    
         CLEAR CPFDSTOP                                                         
         SET   CPFDSTPD                                                         
         MVC   CPEXNEXT,CPEXLINE                                                
         ACALL STOPMSG                                                          
         VCALL EXPAUSE                                                          
         END                                                                    
*                                                                               
         COMMENT                   IF NEXT,                                     
         ELSEIF CPFDNEXT,BEGIN                                                  
         CLEAR CPFDNEXT                                                         
         SET   CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         END                                                                    
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  DBCALL - DEBUG XCALL, PCALL TRAPS, TRACE,,                                   
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*      @R1 - EXEC PROC NAME (16 CHAR, LEFT JUSTIFIED)                           
*                                                                               
*  SEE COMMENTS IN DBLINE ROUTINE.                                              
*                                                                               
*                                                                               
*                                                                               
DBCALL   XPROC                                                                  
*-                                                                              
*-       Only debug non-publoaded execs.                                        
*-                                                                              
         IF    ('CLC CP#XSET,=A(CV#FEXEC)',LT),BEGIN                            
         COMMENT                   CHECK FOR TRAP                               
         ACALL CHKNAME                                                          
*                                                                               
         COMMENT                   IF TRAP                                      
         IF    Z,BEGIN                                                          
         ACALL CALLMSG             GIVE PROC ENTERED... MSG                     
         SET   CPFDSTOP            STOP BEFORE EXECUTING NEXT CMD               
         END                                                                    
*                                                                               
         COMMENT                   OTHER WISE IF TRACE,,                        
         ELSEIF CPFTRACE,BEGIN                                                  
         ACALL CALLMSG             GIVE PROC ENTERED... MSG                     
         IF    CPFTTRAP,BEGIN      IF TRACE STOP, SET STOP                      
         SET   CPFDSTOP                                                         
         END                                                                    
         END                                                                    
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  DBRET - DEBUG XRETURN, RETURN TRAPS, TRACE                                   
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*      @R1 - EXEC PROC NAME (16 CHAR, LEFT JUSTIFIED)                           
*                                                                               
*  SEE COMMENTS IN DBLINE ROUTINE.                                              
*                                                                               
*                                                                               
*                                                                               
DBRET    XPROC                                                                  
*-                                                                              
*-       Only debug non-publoaded execs.                                        
*-                                                                              
         IF    ('CLC CP#XSET,=AL4(CV#FEXEC)',LT),BEGIN                          
*                                                                               
         COMMENT                   IF JUST PROCESSED STOP,                      
         IF    CPFIDONE,BEGIN      DO NOT STOP AGAIN !!                         
         CLEAR CPFIDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   IF NOT YET STOPPED,,,                        
         ELSE  BEGIN                 CHECK FOR TRAP,                            
         ACALL CHKRET                                                           
*                                                                               
         COMMENT                   IF TRAP                                      
         IF    Z,BEGIN                                                          
         ACALL RETMSG              GIVE PROC ENTERED... MSG                     
         MVC   CPEXNEXT,CPEXLINE   GET SET TO RE-EXCUTE THIS LINE               
         SET   CPFISTOP            STOP BEFORE EXECUTING NEXT CMD               
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         COMMENT                   OTHER WISE IF TRACE,,                        
         ELSEIF CPFTRACE,BEGIN                                                  
         ACALL RETMSG              GIVE PROC ENTERED... MSG                     
         IF    CPFTTRAP,BEGIN      IF TRACE STOP,                               
         MVC   CPEXNEXT,CPEXLINE   GET SET TO RE-EXCUTE THIS LINE               
         SET   CPFISTOP            STOP BEFORE EXECUTING NEXT CMD               
         B     CVNEXT                                                           
         END                                                                    
         END                                                                    
         END                                                                    
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CHKLINE - CHECK FOR LINE TRAP                                                
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*       R1 - EXEC LINE NUMBER                                                   
*       TRAP RECORD GROUP CONTAINS TRAP LIST                                    
*                                                                               
*  ON EXIT:                                                                     
*       R15 - CC=Z, TRAP SET                                                    
*             CC=NZ, NO TRAP SET                                                
*                                                                               
*                                                                               
*                                                                               
CKLWA    RECORD BEGIN                                                           
CKLSET   DS    F                                                                
CKLLINE  DS    F                                                                
CKLNAME  DS    XL(L'DTLNAME)                                                    
CKLXNAME DS    XL(L'XDSNAME)                                                    
CKLTRAP  DS    XL(L'DTL)                                                        
         END                                                                    
*                                                                               
*                                                                               
CHKLINE  PROC  CKLWA                                                            
         USING DTL,R6                                                           
         LA    R6,CKLTRAP                                                       
*                                                                               
         COMMENT                   INITALIZE WORK AREA                          
         ST    R0,CKLSET                                                        
         ST    R1,CKLLINE                                                       
         CLEAR CKLTRAP                                                          
         ST    R1,DTLNMLIN                                                      
*                                                                               
         COMMENT                   GET EXEC NAME                                
         L     R0,CKLSET                                                        
         LA    R1,CKLXNAME                                                      
         VCALL GETXNAME                                                         
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
*                                                                               
         COMMENT                   SET RECORD GROUP                             
         LA    R15,CPRG16                                                       
         LA    R0,CP#LTRAP                                                      
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   CHECK FOR TRAP                               
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R4,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R4,NZ),AND,(DTLNMLIN,EQ,CKLLINE)),BEGIN            
         IF    (DTLALL,OR,                                             X        
               ((DTLLINE,EQ,CKLLINE),AND,                              X        
               (DTLXNAME,EQ,CKLXNAME))),BEGIN                                   
         CLEAR R4                  FOUND TRAP                                   
         END                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         LR    R15,R4              SET CONDITION CODE                           
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CHKCALL - CHECK XCALL/PCALL TRAP                                             
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*       R1 - EXEC PROC NAME (16 CHAR, LEFT JUSTIFIED)                           
*       TRAP RECORD GROUP CONTAINS TRAP LIST                                    
*                                                                               
*  ON EXIT:                                                                     
*       R15 - CC=Z, TRAP SET                                                    
*             CC=NZ, NO TRAP SET                                                
*                                                                               
*                                                                               
*                                                                               
CKNWA    RECORD BEGIN                                                           
CKNSET   DS    F                                                                
CKNLINE  DS    F                                                                
CKNNAME  DS    XL(L'DTNNAME)                                                    
CKNXNAME DS    XL(L'XDSNAME)                                                    
CKNTRAP  DS    XL(L'DTN)                                                        
         END                                                                    
*                                                                               
*                                                                               
CHKNAME  PROC  CKNWA                                                            
         USING DTN,R6                                                           
         LA    R6,CKNTRAP                                                       
*                                                                               
         COMMENT                   INITALIZE WORK AREA                          
         ST    R0,CKNSET                                                        
         MVC   CKNNAME,@R1                                                      
         CLEAR CKNTRAP                                                          
         MVC   DTNNMNAM,@R1                                                     
*                                                                               
         COMMENT                   GET EXEC NAME                                
         L     R0,CKNSET                                                        
         LA    R1,CKNXNAME                                                      
         VCALL GETXNAME                                                         
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
*                                                                               
         COMMENT                   SET RECORD GROUP                             
         LA    R15,CPRG16                                                       
         LA    R0,CP#NTRAP                                                      
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   CHECK FOR TRAP                               
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R4,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R4,NZ),AND,(DTNNMNAM,EQ,CKNNAME)),BEGIN            
         IF    (DTNALL,OR,                                             X        
               ((DTNPNAME,EQ,CKNNAME),AND,                             X        
               (DTNXNAME,EQ,CKNXNAME))),BEGIN                                   
         CLEAR R4                  FOUND TRAP                                   
         END                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         LR    R15,R4              SET CONDITION CODE                           
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CHKRET - CHECK FOR PROC RETURN TRAP                                          
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*       R1 - EXEC PROC NAME (16 CHAR, LEFT JUSTIFIED)                           
*       TRAP RECORD GROUP CONTAINS TRAP LIST                                    
*                                                                               
*  ON EXIT:                                                                     
*       R15 - CC=Z, TRAP SET                                                    
*             CC=NZ, NO TRAP SET                                                
*                                                                               
*                                                                               
*                                                                               
CKRWA    RECORD BEGIN                                                           
CKRSET   DS    F                                                                
CKRLINE  DS    F                                                                
CKRNAME  DS    XL(L'DTRNAME)                                                    
CKRXNAME DS    XL(L'XDSNAME)                                                    
CKRTRAP  DS    XL(L'DTR)                                                        
         END                                                                    
*                                                                               
*                                                                               
CHKRET   PROC  CKRWA                                                            
         USING DTR,R6                                                           
         LA    R6,CKRTRAP                                                       
*                                                                               
         COMMENT                   INITALIZE WORK AREA                          
         ST    R0,CKRSET                                                        
         MVC   CKRNAME,@R1                                                      
         CLEAR CKRTRAP                                                          
         MVC   DTRNMNAM,@R1                                                     
*                                                                               
         COMMENT                   GET EXEC NAME                                
         L     R0,CKRSET                                                        
         LA    R1,CKRXNAME                                                      
         VCALL GETXNAME                                                         
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
*                                                                               
         COMMENT                   SET RECORD GROUP                             
         LA    R15,CPRG16                                                       
         LA    R0,CP#RTRAP                                                      
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   CHECK FOR TRAP                               
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R4,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R4,NZ),AND,(DTRNMNAM,EQ,CKRNAME)),BEGIN            
         IF    (DTRALL,OR,                                             X        
               ((DTRNAME,EQ,CKRNAME),AND,                              X        
               (DTRXNAME,EQ,CKRXNAME))),BEGIN                                   
         CLEAR R4                  FOUND TRAP                                   
         END                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         LR    R15,R4              SET CONDITION CODE                           
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'DEBUG Command Routines'                                         
*box                                                                            
*                                                                               
*                                                                               
*  DEBUG - ROOT AND ENTRY POINT FOR EXEC FILE DEBUGGING COMMAND                 
*                                                                               
*                                                                               
*                                                                               
*                                                                               
XDEBUG   XPROC ,                                                                
*                                                                               
         COMMENT                   SCAN DEBUG COMMANDS                          
         SCAN  DEBUGPRT                                                         
         SCANCHK                                                                
         CLEAR R15                                                              
*                                                                               
         B     CVNEXT                                                           
         PEND  ,                                                                
         SPACE 4                                                                
* DEBUG COMMANDS                                                                
DEBUGPRT SCKW  ,XDCMDNUL,NULL                                                   
         SCKW  START,DSTART,A                                                   
         SCKW  RESET,DSCNCLR,A                                                  
         SCKW  CLEAR,DSCNCLR,A                                                  
         SCKW  LOG,DLOG                                                         
         SCKW  NOLOG,DNOLOG,A                                                   
         SCKW  SET,DSCNSET                                                      
         SCKW  CLR,DSCNCLR                                                      
         SCKW  TRACE,DTRACE,A                                                   
         SCKW  NEXT,DNEXT,A                                                     
         SCKW  SHOW,DSHOW,A                                                     
         SCKW  ST,DST                                                           
         SCKW  CT,DCT                                                           
         SCKW  T,DTRACE,                                                        
         SCKW  N,DNEXT                                                          
         SCKW  STS,DSHOW                                                        
         SCKW  ,V(SCNINVAL)                                                     
         SPACE 2                                                                
* DEBUG SET, CLEAR                                                              
DSETPRT  SCKW  ,XDSETNUL,NULL                                                   
         SCKW  TRAP,DST,A                                                       
         SCKW  ,V(SCNINVAL)                                                     
DCLRPRT  SCKW  ,XDCLRNUL,NULL                                                   
         SCKW  TRAP,DCT,A                                                       
         SCKW  ,V(SCNINVAL)                                                     
         SPACE 2                                                                
*-                                                                              
*-       NULL OPTIONS INVALID                                                   
*-                                                                              
XDCMDNUL PROC  ,                                                                
         ERROR 'Missing DEBUG command.',,SYNTAX                                 
         PEND  ,                                                                
XDSETNUL PROC  ,                                                                
         ABORT 'Missing option.',,SYNTAX                                        
         PEND  ,                                                                
XDCLRNUL PROC  ,                                                                
         ACALL DCLEAR                                                           
         LA    R15,4                                                            
         PEND  ,                                                                
*-                                                                              
*-       SET,,                                                                  
*-                                                                              
DSCNSET  PROC  ,                                                                
         SCAN  DSETPRT                                                          
         SCANCHK                                                                
         LA    R15,4                                                            
         PEND  ,                                                                
*-                                                                              
*-       CLEAR/RESET                                                            
*-                                                                              
DSCNCLR  PROC  ,                                                                
         SCAN  DCLRPRT                                                          
         SCANCHK                                                                
         LA    R15,4                                                            
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
* DSTART - START EXEC DEBUGGING                                                 
*                                                                               
*                                                                               
*                                                                               
DSTART   XPROC ,                                                                
*                                                                               
         COMMENT                   NO OPTIONS ALLOWED                           
         VCALL NOOPTS                                                           
*                                                                               
         COMMENT                   CLEAR ANY DEBUG SESSION                      
         ACALL DBCLEAR                                                          
*                                                                               
         COMMENT                   START DEBUGGING SESSION                      
         SET   CPFDEBUG                                                         
*                                                                               
         LA    R15,4                                                            
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
* DCLEAR - CLEAR EXEC DEBUGGING                                                 
*                                                                               
*                                                                               
*                                                                               
DCLEAR   XPROC ,                                                                
*                                                                               
         COMMENT                   NO OPTIONS ALLOWED                           
         VCALL NOOPTS                                                           
*                                                                               
         COMMENT                   CLEAR DEBUGGING SESSION                      
         ACALL DBCLEAR                                                          
*                                                                               
         LA    R15,4                                                            
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  DLOG - DEBUG LOG                                                             
*                                                                               
*                                                                               
DLOG     XPROC ,                                                                
*                                                                               
         COMMENT                   NO OPTIONS ALLOWED                           
         VCALL NOOPTS                                                           
*                                                                               
         COMMENT                   SET LOG FLAG                                 
         SET   CPFXLOG                                                          
*                                                                               
         LA    R15,4                                                            
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*  DNOLOG - DEBUG NOLOG                                                         
*                                                                               
*                                                                               
DNOLOG   XPROC ,                                                                
*                                                                               
         COMMENT                   NO OPTIONS ALLOWED                           
         VCALL NOOPTS                                                           
*                                                                               
         COMMENT                   CLEAR LOG FLAG                               
         CLEAR CPFXLOG                                                          
*                                                                               
         LA    R15,4                                                            
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  DST - DEBUG SET TRAP <LOCATION> IN <EXEC FILE>                               
*                                                                               
*                                                                               
*                                                                               
*                                                                               
DSTWA    RECORD BEGIN                                                           
DSTLINE  DS    XL(L'DTL)           TRAP WORK AREAS                              
DSTNAME  DS    XL(L'DTN)                                                        
DSTRET   DS    XL(L'DTR)                                                        
DSTLINE2 DS    XL(L'DTL)                                                        
DSTNAME2 DS    XL(L'DTN)                                                        
DSTRET2  DS    XL(L'DTR)                                                        
         END                                                                    
*                                                                               
*                                                                               
DST      XPROC DSTWA                                                            
         USING DTL,R4                                                           
         USING DTN,R5                                                           
         USING DTR,R6                                                           
         LA    R4,DSTLINE                                                       
         LA    R5,DSTNAME                                                       
         LA    R6,DSTRET                                                        
*                                                                               
         COMMENT                   INIT WORK AREA                               
         CLEAR DTL                                                              
         CLEAR DTN                                                              
         CLEAR DTR                                                              
*                                                                               
         COMMENT                   DEBUG SESSION ACTIVE                         
         SET   CPFDEBUG                                                         
*                                                                               
         COMMENT                   SCAN TRAP                                    
         LA    R1,DTL                                                           
         LA    R2,DTN                                                           
         LA    R3,DTR                                                           
         ACALL SCANTRAP                                                         
*                                                                               
         COMMENT                   SCAN OK, SET TRAP                            
         COMMENT                                                                
         IF    (DTLNAME,NE,0),BEGIN     IF LINE TRAP, SAVE IT                   
         LA    R1,DTL                                                           
         LA    R2,DSTLINE2                                                      
         ACALL GTTLINE             CHECK IF ALREADY SET                         
         BZ    CVNEXT                                                           
         LA    R15,CPRG16          IF NOT, SET IT                               
         LA    R0,CP#LTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XPUT                                                             
         IF    NZ,BEGIN                                                         
         KAPUT TRAPFULL,'Session Data Record Group Overflow.'                   
         END                                                                    
         END                                                                    
         IF    (DTNNAME,NE,0),BEGIN     IF NAME TRAP, SAVE IT                   
         LA    R1,DTN                                                           
         LA    R2,DSTNAME2                                                      
         ACALL GTTNAME             CHECK IF ALREADY SET                         
         BZ    CVNEXT                                                           
         LA    R15,CPRG16          IF NOT, SET IT                               
         LA    R0,CP#NTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XPUT                                                             
         IF    NZ,BEGIN                                                         
         KAPUT TRAPFULL,'Session Data Record Group Overflow.'                   
         END                                                                    
         END                                                                    
         ELSEIF (DTRNAME,NE,0),BEGIN    IF RETURN TRAP, SAVE IT                 
         LA    R1,DTR                                                           
         LA    R2,DSTRET2                                                       
         ACALL GTTRET              CHECK IF ALREADY SET                         
         BZ    CVNEXT                                                           
         LA    R15,CPRG16          IF NOT, SET IT                               
         LA    R0,CP#RTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XPUT                                                             
         IF    NZ,BEGIN                                                         
         KAPUT TRAPFULL,'Session Data Record Group Overflow.'                   
         END                                                                    
         END                                                                    
*                                                                               
         B     CVNEXT              EXIT HERE!!                                  
*                                                                               
         CLEAR R15                 NOTE WE EXIT ABOVE                           
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  DCT - DEBUG CLEAR TRAP <LOCATION> IN <EXEC FILE>                             
*                                                                               
*                                                                               
*                                                                               
*                                                                               
DCTWA    RECORD BEGIN                                                           
DCTLINE  DS    XL(L'DTL)           TRAP WORK AREAS                              
DCTNAME  DS    XL(L'DTN)                                                        
DCTRET   DS    XL(L'DTR)                                                        
DCTLINE2 DS    XL(L'DTL)                                                        
DCTNAME2 DS    XL(L'DTN)                                                        
DCTRET2  DS    XL(L'DTR)                                                        
         END                                                                    
*                                                                               
*                                                                               
DCT      XPROC DCTWA                                                            
         USING DTL,R4                                                           
         USING DTN,R5                                                           
         USING DTR,R6                                                           
         LA    R4,DCTLINE                                                       
         LA    R5,DCTNAME                                                       
         LA    R6,DCTRET                                                        
*                                                                               
         COMMENT                   INIT WORK AREA                               
         CLEAR DTL                                                              
         CLEAR DTN                                                              
         CLEAR DTR                                                              
*                                                                               
         COMMENT                   DEBUG SESSION ACTIVE                         
         SET   CPFDEBUG                                                         
*                                                                               
         COMMENT                   SCAN TRAP                                    
         LA    R1,DTL                                                           
         LA    R2,DTN                                                           
         LA    R3,DTR                                                           
         ACALL SCANTRAP                                                         
*                                                                               
         COMMENT                   SCAN OK, SET TRAP                            
         COMMENT                                                                
         IF    (DTLNAME,NE,0),BEGIN  IF GOT LINE TRAP                           
         LA    R1,DTL                                                           
         LA    R2,DCTLINE2                                                      
         ACALL GTTLINE             CHECK IF SET                                 
         IF    NZ,BEGIN                                                         
         ERROR 'No such trap set.'                                              
         END                                                                    
         LA    R15,CPRG16          DELETE IT                                    
         LA    R0,CP#LTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         COMMENT R2 - TRAP TO DELETE                                            
         VCALL XDELETE                                                          
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
         END                                                                    
         IF    (DTNNAME,NE,0),BEGIN  IF GOT NAME TRAP                           
         LA    R1,DTN                                                           
         LA    R2,DCTNAME2                                                      
         ACALL GTTNAME             CHECK IF ALREADY SET                         
         IF    NZ,BEGIN                                                         
         ERROR 'No such trap set.'                                              
         END                                                                    
         LA    R15,CPRG16          DELETE IT                                    
         LA    R0,CP#NTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         COMMENT R2 - TRAP TO DELETE                                            
         VCALL XDELETE                                                          
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
         END                                                                    
         ELSEIF (DTRNAME,NE,0),BEGIN  IF GOT RETURN TRAP                        
         LA    R1,DTR                                                           
         LA    R2,DCTRET2                                                       
         ACALL GTTRET              CHECK IF ALREADY SET                         
         IF    NZ,BEGIN                                                         
         ERROR 'No such trap set.'                                              
         END                                                                    
         LA    R15,CPRG16          DELETE IT                                    
         LA    R0,CP#RTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         COMMENT R2 - TRAP TO DELETE                                            
         VCALL XDELETE                                                          
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
         END                                                                    
*                                                                               
         B     CVNEXT              EXIT HERE!!                                  
*                                                                               
         CLEAR R15                 NOTE WE EXIT ABOVE                           
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  DSHOW - SHOW TRAPS                                                           
*                                                                               
*                                                                               
*                                                                               
*                                                                               
DSHWWA   RECORD BEGIN                                                           
DSHWLINE DS    XL(L'DTL)           TRAP WORK AREAS                              
DSHWNAME DS    XL(L'DTN)                                                        
DSHWRET  DS    XL(L'DTR)                                                        
         END                                                                    
*                                                                               
*                                                                               
DSHOW    XPROC DSHWWA                                                           
         USING DTL,R6                                                           
         USING DTN,R5                                                           
         USING DTR,R4                                                           
         LA    R6,DSHWLINE                                                      
         LA    R5,DSHWNAME                                                      
         LA    R4,DSHWRET                                                       
*                                                                               
         COMMENT                   INIT WORK AREA                               
         CLEAR DTL                                                              
         CLEAR DTN                                                              
         CLEAR DTR                                                              
*                                                                               
         COMMENT                   SCAN COLLECT OPTIONS                         
         VCALL COLLOPTS                                                         
*                                                                               
         COMMENT                   OUTPUT DEBUG STATUS                          
         IF    CPFDEBUG,BEGIN                                                   
         TSEG  'Debugging session active.',,CR                                  
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  'Debugging session not active.',,CR                              
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         COMMENT                   OUTPUT COMMAND LOGGING STATUS                
         IF    CPFXLOG,BEGIN                                                    
         TSEG  'Command logging on.',,CR                                        
         END                                                                    
*                                                                               
         COMMENT                   OUTPUT TRACE STATUS                          
         IF    CPFTRACE,BEGIN                                                   
         IF    CPFTTRAP,BEGIN                                                   
         TSEG  'Debug tracing traps on.',,CR                                    
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  'Debug tracing on.',,CR                                          
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   OUTPUT LINE TRAPS                            
         LA    R15,CPRG16                                                       
         LA    R0,CP#LTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETFRST                                                         
         IF    (R15,Z),BEGIN                                                    
         TSEG  'Line Traps:',,CR                                                
         BNZ   CVNEXT IF ATTN HIT                                               
         CLEAR R15                                                              
         WHILE (R15,Z),BEGIN                                                    
         L     R1,DTLLINE                                                       
         ACALL MSEGLNO                                                          
         IF    ^DTLALL,BEGIN                                                    
         TSEG  '          '                                                     
         LA    R1,DTLXNAME                                                      
         VCALL SEGFDSN                                                          
         END                                                                    
         TCR                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   OUTPUT NAME TRAPS                            
         LA    R15,CPRG16                                                       
         LA    R0,CP#NTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETFRST                                                         
         IF    (R15,Z),BEGIN                                                    
         TSEG  'Proc Name Traps:',,CR                                           
         BNZ   CVNEXT IF ATTN HIT                                               
         CLEAR R15                                                              
         WHILE (R15,Z),BEGIN                                                    
         TSEG  '  '                                                             
         TSEG  DTNPNAME,L'DTNPNAME                                              
         TSEG  '  '                                                             
         IF    ^DTNALL,BEGIN                                                    
         LA    R1,DTNXNAME                                                      
         VCALL SEGFDSN                                                          
         END                                                                    
         TCR                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   OUTPUT RETURN TRAPS                          
         LA    R15,CPRG16                                                       
         LA    R0,CP#RTRAP                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETFRST                                                         
         IF    (R15,Z),BEGIN                                                    
         TSEG  'Return Traps:',,CR                                              
         BNZ   CVNEXT IF ATTN HIT                                               
         CLEAR R15                                                              
         WHILE (R15,Z),BEGIN                                                    
         TSEG  '  '                                                             
         TSEG  DTRPNAME,L'DTRPNAME                                              
         TSEG  '  '                                                             
         IF    ^DTRALL,BEGIN                                                    
         LA    R1,DTRXNAME                                                      
         VCALL SEGFDSN                                                          
         END                                                                    
         TCR                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
*                                                                               
         B     CVNEXT              EXIT HERE !!                                 
*                                                                               
         CLEAR R15                 WE EXIT ABOVE, NOT HERE!!                    
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R5                                                               
         DROP  R4                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  DNEXT - DEBUG NEXT                                                           
*                                                                               
*                                                                               
*                                                                               
*                                                                               
DNEXT    XPROC ,                                                                
*                                                                               
         COMMENT                   NO OPTIONS                                   
         VCALL COLLOPTS                                                         
*                                                                               
         COMMENT                   CHECK IF DEBUG STARTED                       
         IF    ^CPFDEBUG,BEGIN                                                  
         ERROR 'Debugging session not active.'                                  
         END                                                                    
*                                                                               
         COMMENT                   CHECK IF ENTERED AT TERMINAL                 
         IF    CPFEXEC,BEGIN                                                    
         ERROR 'DEBUG NEXT: may not be issued from EXEC file.'                  
         END                                                                    
*                                                                               
         COMMENT                   CHECK FOR EXEC FILE                          
         VCALL EXECHK                                                           
*                                                                               
         COMMENT                   SET DEBUG NEXT FLAG,,,                       
         SET   CPFDNEXT                                                         
*                                                                               
         COMMENT                   RESTART EXEC                                 
         SET   CPFEXEC                                                          
         B     CVNEXT                                                           
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  DTRC - DEBUG TRACE                                                           
*                                                                               
*                                                                               
*                                                                               
*                                                                               
DTRACE   XPROC ,                                                                
*                                                                               
         COMMENT                   DEBUG SESSION ACTIVE                         
         SET   CPFDEBUG                                                         
*                                                                               
         COMMENT                   RESET TRACE FLAGS                            
         CLEAR CPFTRACE                                                         
         CLEAR CPFTTRAP                                                         
*                                                                               
         SCAN DTRCPRT                                                           
         SCANCHK                                                                
         CLEAR R15                                                              
*                                                                               
         B     CVNEXT                                                           
         PEND  ,                                                                
         SPACE 4                                                                
*-                                                                              
*-       TRACE OPTIONS                                                          
*-                                                                              
DTRCPRT  SCKW  ,DTRCON,NULL        DEFAULT IS TRACE ON                          
         SCKW  ON,DTRCON                                                        
         SCKW  OFF,DTRCOFF                                                      
         SCKW  TRAPS,DTRCTRAP,A                                                 
         SCKW  ,V(SCNINVAL)                                                     
*                                                                               
DTRCON   DPROC ,                                                                
         SET   CPFTRACE                                                         
         PEND  ,                                                                
*                                                                               
DTRCOFF  DPROC ,                                                                
         CLEAR CPFTRACE                                                         
         CLEAR CPFTTRAP                                                         
         PEND  ,                                                                
*                                                                               
DTRCTRAP DPROC ,                                                                
         SET   CPFTRACE                                                         
         SET   CPFTTRAP                                                         
         PEND  ,                                                                
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'Common Routines for DEBUG Commands.'                            
*box                                                                            
*                                                                               
*                                                                               
*  GTTLINE - GET EXISTING LINE TRAP, IF ANY                                     
*                                                                               
*  ON ENTRY:                                                                    
*      @R1 - TRAP RECORD, CONTAINS LINE NUMBER, EXEC NAME                       
*      @R2 - TRAP RECORD RETURN AREA, IF TRAP ALREADY EXISTS                    
*                                                                               
*                                                                               
*  ON EXIT:                                                                     
*       @R2 - EXISTING TRAP RECORD RETURNED, IF ANY                             
*       R15 - CC=Z, TRAP SET                                                    
*             CC=NZ, NO TRAP SET                                                
*                                                                               
*                                                                               
*                                                                               
GTTLINE  PROC  ,                                                                
         USING DTL,R6                                                           
         LR    R6,R1                                                            
         LA    R5,DTLLINE          @R5 - LINE NUMBER                            
         LA    R4,DTLXNAME         R4 - EXEC FILE NAME, =0 IF ALL               
         IF    DTLALL,BEGIN                                                     
         CLEAR R4                                                               
         END                                                                    
         LR    R6,R2               DTL - RETURN AREA                            
*                                                                               
         COMMENT                   INITALIZE RETURN AREA                        
         CLEAR DTL                                                              
         MVC   DTLNMLIN,@R5                                                     
*                                                                               
         COMMENT                   SET RECORD GROUP                             
         LA    R15,CPRG16                                                       
         LA    R0,CP#LTRAP                                                      
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   CHECK FOR GENERAL TRAP                       
         IF    (R4,Z),BEGIN                                                     
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R3,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R3,NZ),AND,(DTLNMLIN,EQ,@R5)),BEGIN                
         IF    DTLALL,BEGIN                                                     
         CLEAR R3                  FOUND TRAP                                   
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
         LR    R15,R3              SET CONDITION CODE                           
         END                                                                    
*                                                                               
         COMMENT                   CHECK FOR SPECIFIC TRAP                      
         IF    (R4,NZ),BEGIN                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R3,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R3,NZ),AND,(DTLNMLIN,EQ,@R5)),BEGIN                
         IF    ((DTLLINE,EQ,@R5),AND,                                  X        
               (DTLXNAME,EQ,@R4)),BEGIN                                         
         CLEAR R3                  FOUND TRAP                                   
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,CPRG16                                                       
         LA    R0,L'DTLDATA                                                     
         LA    R1,DTLDATA                                                       
         LA    R2,DTLNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
         LR    R15,R3              SET CONDITION CODE                           
         END                                                                    
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  GTTNAME - GET EXISTING PROC NAME TRAP, IF ANY                                
*                                                                               
*  ON ENTRY:                                                                    
*      @R1 - TRAP RECORD, CONTAINS PROC NAME, EXEC NAME                         
*      @R2 - TRAP RECORD RETURN AREA, IF TRAP ALREADY EXISTS                    
*                                                                               
*                                                                               
*  ON EXIT:                                                                     
*       @R2 - EXISTING TRAP RECORD RETURNED, IF ANY                             
*       R15 - CC=Z, TRAP SET                                                    
*             CC=NZ, NO TRAP SET                                                
*                                                                               
*                                                                               
*                                                                               
GTTNAME  PROC  ,                                                                
         USING DTN,R6                                                           
         LR    R6,R1                                                            
         LA    R5,DTNPNAME         R5 - PROC NAME                               
         LA    R4,DTNXNAME         R4 - EXEC FILE NAME, =0 IF ALL               
         IF    DTNALL,BEGIN                                                     
         CLEAR R4                                                               
         END                                                                    
         LR    R6,R2               DTN - RETURN AREA                            
*                                                                               
         COMMENT                   INITALIZE RETURN AREA                        
         CLEAR DTN                                                              
         MVC   DTNNMNAM,@R5                                                     
*                                                                               
         COMMENT                   SET RECORD GROUP                             
         LA    R15,CPRG16                                                       
         LA    R0,CP#NTRAP                                                      
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   CHECK FOR GENERAL TRAP                       
         IF    (R4,Z),BEGIN                                                     
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R3,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R3,NZ),AND,(DTNNMNAM,EQ,@R5)),BEGIN                
         IF    DTNALL,BEGIN                                                     
         CLEAR R3                  FOUND TRAP                                   
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
         LR    R15,R3              SET CONDITION CODE                           
         END                                                                    
*                                                                               
         COMMENT                   CHECK FOR SPECIFIC TRAP                      
         IF    (R4,NZ),BEGIN                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R3,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R3,NZ),AND,(DTNNMNAM,EQ,@R5)),BEGIN                
         IF    ((DTNPNAME,EQ,@R5),AND,                                 X        
               (DTNXNAME,EQ,@R4)),BEGIN                                         
         CLEAR R3                  FOUND TRAP                                   
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,CPRG16                                                       
         LA    R0,L'DTNDATA                                                     
         LA    R1,DTNDATA                                                       
         LA    R2,DTNNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
         LR    R15,R3              SET CONDITION CODE                           
         END                                                                    
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  GTTRET  - GET EXISTING RETURN TRAP, IF ANY                                   
*                                                                               
*  ON ENTRY:                                                                    
*      @R1 - TRAP RECORD, CONTAINS RETURN NAME, EXEC NAME                       
*      @R2 - TRAP RECORD RETURN AREA, IF TRAP ALREADY EXISTS                    
*                                                                               
*                                                                               
*  ON EXIT:                                                                     
*       @R2 - EXISTING TRAP RECORD RETURNED, IF ANY                             
*       R15 - CC=Z, TRAP SET                                                    
*             CC=NZ, NO TRAP SET                                                
*                                                                               
*                                                                               
*                                                                               
GTTRET   PROC  ,                                                                
         USING DTR,R6                                                           
         LR    R6,R1                                                            
         LA    R5,DTRPNAME         R5 - PROC NAME                               
         LA    R4,DTRXNAME         R4 - EXEC FILE NAME, =0 IF ALL               
         IF    DTRALL,BEGIN                                                     
         CLEAR R4                                                               
         END                                                                    
         LR    R6,R2               DTR - RETURN AREA                            
*                                                                               
         COMMENT                   INITALIZE RETURN AREA                        
         CLEAR DTR                                                              
         MVC   DTRNMNAM,@R5                                                     
*                                                                               
         COMMENT                   SET RECORD GROUP                             
         LA    R15,CPRG16                                                       
         LA    R0,CP#RTRAP                                                      
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   CHECK FOR GENERAL TRAP                       
         IF    (R4,Z),BEGIN                                                     
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R3,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R3,NZ),AND,(DTRNMNAM,EQ,@R5)),BEGIN                
         IF    DTRALL,BEGIN                                                     
         CLEAR R3                  FOUND TRAP                                   
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
         LR    R15,R3              SET CONDITION CODE                           
         END                                                                    
*                                                                               
         COMMENT                   CHECK FOR SPECIFIC TRAP                      
         IF    (R4,NZ),BEGIN                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETFRST                                                         
         COMMENT                   LOOP LOOKING FOR SPECIFIC TRAP               
         LA    R3,4                ASSUME TRAP NOT FOUND                        
         WHILE ((R15,Z),AND,(R3,NZ),AND,(DTRNMNAM,EQ,@R5)),BEGIN                
         IF    ((DTRPNAME,EQ,@R5),AND,                                 X        
               (DTRXNAME,EQ,@R4)),BEGIN                                         
         CLEAR R3                  FOUND TRAP                                   
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,CPRG16                                                       
         LA    R0,L'DTRDATA                                                     
         LA    R1,DTRDATA                                                       
         LA    R2,DTRNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
         END                                                                    
         LR    R15,R3              SET CONDITION CODE                           
         END                                                                    
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
* DBCLEAR - CLEAR DEBUGGING SESSION                                             
*                                                                               
*                                                                               
*                                                                               
DBCLEAR  XPROC ,                                                                
*                                                                               
         COMMENT                   CLEAR TRAPS                                  
         ACALL CLRTRAPS                                                         
*                                                                               
         COMMENT                   CLEAR CP FIELDS                              
         CLEAR CPFDEBUG                                                         
         CLEAR CPFTRACE                                                         
         CLEAR CPFTTRAP                                                         
         CLEAR CPFXLOG                                                          
         CLEAR CPFDNEXT                                                         
         CLEAR CPFDSTOP                                                         
         CLEAR CPFDSTPD                                                         
         CLEAR CPFISTOP                                                         
         CLEAR CPFISTPD                                                         
         CLEAR CPFIDONE                                                         
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*                                                                               
**                                                                              
** DBXSTART - START OF XPROC, EXEC;  WE CLEAR NEXT/STOP FLAGS                   
**                                                                              
*$ delete on 1/1/88,  Happy New Year !                                          
*                                                                               
*BXSTART XPROC ,                                                                
*                                                                               
*        COMMENT                   CLEAR CP FIELDS                              
*        CLEAR CPFDNEXT                                                         
*        CLEAR CPFDSTOP                                                         
*        CLEAR CPFDSTPD                                                         
*        CLEAR CPFISTOP                                                         
*        CLEAR CPFISTPD                                                         
*        CLEAR CPFIDONE                                                         
*                                                                               
*        CLEAR R15                                                              
*        PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CLRTRAPS - CLEAR ALL TRAPS                                                   
*                                                                               
*                                                                               
*                                                                               
CLRTRAPS PROC  ,                                                                
*                                                                               
         COMMENT                   CLEAR EM                                     
         LA    R15,CPRG16                                                       
         LA    R0,CP#LTRAP                                                      
         VCALL XDELSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,CP#NTRAP                                                      
         VCALL XDELSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,CP#RTRAP                                                      
         VCALL XDELSET                                                          
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  SCANTRAP - SCAN TRAP <LOCATION> IN <EXEC FILE>                               
*                                                                               
*  ON ENTRY:                                                                    
*       @R1 - LINE TRAP WORK AREA                                               
*       @R2 - NAME TRAP WORK AREA                                               
*       @R3 - RETURN TRAP WORK AREA                                             
*       SCANCB - TRAP STRING                                                    
*                                                                               
*  ON EXIT:                                                                     
*       TRAP WORK AREAS CLEARED, APPROPRIATE ENTRY FILLED IN.                   
*       ERRORS EXIT DIRECTLY TO CVERROR.                                        
*                                                                               
*                                                                               
SCANTRAP PROC  ,                                                                
         USING DTL,R3                                                           
         USING DTN,R4                                                           
         USING DTR,R5                                                           
         LR    R5,R3                                                            
         LR    R4,R2                                                            
         LR    R3,R1                                                            
*                                                                               
         COMMENT                   CLEAR TRAP WORK AREAS                        
         CLEAR DTL                                                              
         CLEAR DTN                                                              
         CLEAR DTR                                                              
*                                                                               
         COMMENT                   SCAN FOR LOCATION                            
         SCAN  TLOCPRT                                                          
         SCANCHK                                                                
         CLEAR R15                                                              
         PEND  ,                                                                
         SPACE 2                                                                
* LOCATION OPTIONS                                                              
TLOCPRT  SCKW  ,STNULL,NULL                                                     
         SCKW  ,STLINENO,SYMLN                                                  
         SCKW  ,STNAME                                                          
         SPACE 2                                                                
*  NO OPTIONS, INVALID                                                          
STNULL   PROC  ,                                                                
         ERROR 'Missing trap specification.',,SYNTAX                            
         PEND  ,                                                                
*                                                                               
* LINE NUMBER TRAP                                                              
*                                                                               
STLINENO PROC  ,                                                                
         ST    R0,DTLLINE                                                       
         ST    R0,DTLNMLIN                                                      
         L     R1,CPTRAPSQ                                                      
         INCR  R1                                                               
         ST    R1,CPTRAPSQ                                                      
         ST    R1,DTLNMSEQ                                                      
         SCAN  ,                                                                
         SCANCHK                                                                
         SCUPTOK (R1)                                                           
         IF    (R0,Z),BEGIN                                                     
         SET   DTLALL                                                           
         END                                                                    
         ELSEIF ((R0,NE,2),OR,(@R1,NE,'IN')),BEGIN                              
         VCALL NOTVALID                                                         
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R1,DTLXNAME                                                      
         ACALL SCNXNAME                                                         
         END                                                                    
         LA    R15,4                                                            
         PEND  ,                                                                
         SPACE 2                                                                
*                                                                               
* NAME TRAP                                                                     
*                                                                               
STNAME   PROC  ,                                                                
         IF    (R0,GT,16),' VCALL NOTVALID'                                     
         SCUPCASE DTNNAME                                                       
         SCUPCASE DTNPNAME                                                      
         L     R1,CPTRAPSQ                                                      
         INCR  R1                                                               
         ST    R1,CPTRAPSQ                                                      
         ST    R1,DTNNMSEQ                                                      
         SCAN  ,                                                                
         SCANCHK                                                                
         SCUPTOK (R1)                                                           
         IF    (R0,Z),BEGIN                                                     
         SET   DTNALL                                                           
         END                                                                    
         ELSEIF    ((R0,GE,3),AND,(@R1,EQ,'RET')),BEGIN                         
         ACALL STRET                                                            
         END                                                                    
         ELSEIF ((R0,NE,2),OR,(@R1,NE,'IN')),BEGIN                              
         VCALL NOTVALID                                                         
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R1,DTNXNAME                                                      
         ACALL SCNXNAME                                                         
         END                                                                    
         LA    R15,4                                                            
         PEND  ,                                                                
         SPACE 2                                                                
*                                                                               
* RETURN TRAP                                                                   
*                                                                               
STRET    PROC  ,                                                                
         MVC   DTRNAME,DTNNAME                                                  
         MVC   DTRPNAME,DTNPNAME                                                
         CLEAR DTN                                                              
         COMMENT                   CHECK FOR 'RETURN' KEYWORD                   
         IF    ((R0,LT,3),OR,(R0,GT,6)),' VCALL NOTVALID'                       
         LA    R14,=CL6'RETURN'                                                 
         LA    R15,R0                                                           
         LR    R0,R1                                                            
         LR    R1,R15                                                           
         CLCL  R14,R0                                                           
         IF    NE,' VCALL NOTVALID'                                             
         SCAN  ,                                                                
         SCANCHK                                                                
         SCUPTOK (R1)                                                           
         IF    (R0,Z),BEGIN                                                     
         SET   DTRALL                                                           
         END                                                                    
         ELSEIF ((R0,NE,2),OR,(@R1,NE,'IN')),BEGIN                              
         VCALL NOTVALID                                                         
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R1,DTRXNAME                                                      
         ACALL SCNXNAME                                                         
         END                                                                    
         LA    R15,4                                                            
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  SCNXNAME - SCAN EXEC NAME                                                    
*                                                                               
*                                                                               
*  ON ENTRY:                                                                    
*       R1 - EXEC NAME AREA (IN XDSNAME FORMAT)                                 
*       SCANCB - WYLBUR FORMAT DATA SET NAME                                    
*                                                                               
*  ON EXIT:                                                                     
*       R1 - EXEC NAME (XDSNAME FORMAT)                                         
*       R15 - CC=Z                                                              
*             ANY ERRORS EXIT VIA CVERROR                                       
*                                                                               
*                                                                               
*                                                                               
SCNXNAME PROC  ,                                                                
*                                                                               
         COMMENT                   R5 - DATA SET NAME RETURN AREA               
         LR    R5,R1                                                            
*                                                                               
         COMMENT                   SCAN DATA SET NAME                           
         VCALL DOFNAME                                                          
         VCALL FNAMOPTS                                                         
         VCALL FNAMEFIN                                                         
         VCALL NRESOLVE                                                         
*                                                                               
         COMMENT                   GET DATA SET NAME IN PROPER FORMAT           
         LR    R1,R5                                                            
         VCALL SETXNAME                                                         
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R3                                                               
         DROP  R4                                                               
         DROP  R5                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  STOPMSG - GIVE EXEC STOP MESSAGE                                             
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*       R1 - EXEC LINE NUMBER                                                   
*                                                                               
*  NOTE: WE IGNORE ATTNS, WE ARE STOPPING ANYWAY                                
*                                                                               
*                                                                               
*                                                                               
STPWA    RECORD BEGIN                                                           
STPXNAME DS    XL(L'XDSNAME)                                                    
         END                                                                    
*                                                                               
*                                                                               
STOPMSG  PROC  STPWA                                                            
*                                                                               
         COMMENT                   R2 - EXEC SET #, R3 - EXEC LINE              
         LR    R2,R0                                                            
         LR    R3,R1                                                            
*                                                                               
         COMMENT                   GIVE MESSAGE                                 
         TSEG  '- Stopped at line '                                             
*                                                                               
         COMMENT                   GIVE LINE NUMBER                             
         LR    R0,R3                                                            
         IF    ((R0,NL),AND,(R0,LT,CVMAXLNO)),BEGIN                             
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  '######'                                                         
         END                                                                    
*                                                                               
         TSEG  ' in '                                                           
*                                                                               
         COMMENT                   GIVE EXEC NAME                               
         LR    R0,R2                                                            
         LA    R1,STPXNAME                                                      
         VCALL GETXNAME                                                         
         VCALL SEGXDSN                                                          
*                                                                               
         COMMENT                   OUTPUT MSG                                   
         TCR                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CALLMSG - GIVE PROC ENTERED MESSAGE                                          
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*      @R1 - EXEC PROC NAME (16 CHAR, LEFT JUSTIFIED)                           
*                                                                               
*  NOTE: WE IGNORE ATTNS, WE MUST COMPLETE THE XCALL/PCALL                      
*                                                                               
*                                                                               
*                                                                               
CMWA     RECORD BEGIN                                                           
CM#XSET  DS    F                                                                
CMPNAME  DS    XL(L'DTNPNAME)                                                   
CMXNAME  DS    XL(L'XDSNAME)                                                    
         END                                                                    
*                                                                               
*                                                                               
CALLMSG  PROC  CMWA                                                             
         ST    R0,CM#XSET                                                       
         MVC   CMPNAME,@R1                                                      
*-                                                                              
*-       Only debug non-publoaded execs.                                        
*-                                                                              
         IF    ('CLC CM#XSET,=A(CV#FEXEC)',LT),BEGIN                            
         COMMENT                   INIT WORK AREA                               
*                                                                               
         COMMENT                   GIVE MESSAGE                                 
         TSEG  '- Entering '                                                    
         TSEG  CMPNAME,L'CMPNAME,TB                                             
*                                                                               
         COMMENT                   IF XPROC, GIVE EXEC NAME                     
         IF    (CMPNAME,EQ,'XPROC   '),BEGIN                                    
         TSEG  'in '                                                            
         L     R0,CM#XSET                                                       
         LA    R1,CMXNAME                                                       
         VCALL GETXNAME                                                         
         VCALL SEGXDSN                                                          
         END                                                                    
*                                                                               
         COMMENT                   OUTPUT MSG                                   
         TCR                                                                    
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  RETMSG - GIVE PROC RETURN MESSAGE                                            
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - EXEC SET NUMBER                                                    
*      @R1 - EXEC PROC NAME (16 CHAR, LEFT JUSTIFIED)                           
*                                                                               
*  NOTE: WE IGNORE ATTNS, WE MUST COMPLETE THE RETURN                           
*                                                                               
*                                                                               
*                                                                               
RETMSG   PROC  ,                                                                
*-                                                                              
*-       Only debug non-publoaded execs.                                        
*-                                                                              
         IF    (R0,LT,=A(CV#FEXEC)),BEGIN                                       
         COMMENT                   @R2 - PROC NAME                              
         LR    R2,R1                                                            
*                                                                               
         COMMENT                   GIVE MESSAGE                                 
         TSEG  '- Returning from '                                              
         TSEG  @R2,16,TB                                                        
*                                                                               
         COMMENT                   OUTPUT MSG                                   
         TCR                                                                    
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'MONITOR STATISTICS GATHERING ROUTINES'                          
*box                                                                            
*                                                                               
*                                                                               
*  MONCMD - MONITOR COMMAND EXECUTION                                           
*                                                                               
*  WE COME HERE TO MONITOR EACH COMMAND EXECUTION.                              
*  WE MONITOR ONLY EXEC COMMAND EXECUTION.                                      
*  THIS ROUTINE MUST BE SHORT AND FAST.                                         
*                                                                               
*  CAUTION: CPFMON MUST BE SET, AND CPMONPTR MUST BE NON ZERO!                  
*                                                                               
*                                                                               
MONCMD   XPROC ,                                                                
         USING MMB,R6                                                           
         USING MONENTRY,R1                                                      
         L     R6,CPMONPTR                                                      
         L     R5,CPMONCPU         R5 - CPU TIME AT START OF CMD                
*                                                                               
         COMMENT                   GET CURRENT CPU TIME IN TU'S                 
         VCALL GETCPU                                                           
         LR    R3,R0                                                            
         L     R15,CVCURJCB                                                     
         WITH  (JCB,R15),'AL R3,JCBWCPU'  Total user CPU time                   
         ST    R3,CPMONCPU                                                      
*                                                                               
         COMMENT                   IF WE HAD EXEC CMD,                          
         IF    (MMBXSET,NE,0),BEGIN   SAVE MONITOR ENTRY FOR CMD                
*                                                                               
         COMMENT                   SAVE MON INFO,                               
         L     R1,MMBPTR           R1 - MONITOR ENTRY                           
         L     R2,MMBXLINE                                                      
         ST    R2,MONXLINE                                                      
         L     R2,MMBXSET                                                       
         ST    R2,MONXSET                                                       
         L     R2,CPMONCPU         CURRENT-START TIME = TIME USED               
         SR    R2,R5                                                            
         ST    R2,MONCPU                                                        
*                                                                               
         COMMENT                   INITIALIZE FOR NEXT COMMAND                  
         CLEAR R2                                                               
         ST    R2,MMBXLINE                                                      
         ST    R2,MMBXSET                                                       
         COMMENT                   TRY QUICK BUMP OF MON ENTRY PTR              
         LA    R2,MONENTRY+L'MONENTRY                                           
         IF    (R2,LT,MMBEND),BEGIN    IF QUICK OK                              
         ST    R2,MMBPTR                                                        
         END                                                                    
         ELSE  BEGIN               ELSE                                         
         ACALL NEXTPTR             IF POINTER INCREMENT IS LONG                 
         VCALL GETCPU              RESET CPU TIME FOR NEXT CMD                  
         LR    R3,R0                                                            
         L     R15,CVCURJCB                                                     
         WITH  (JCB,R15),'AL R3,JCBWCPU'  Total user CPU time                   
         ST    R3,CPMONCPU                                                      
         END                                                                    
         END , OF GOT EXEC CMD                                                  
*                                                                               
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  SETXLINE - SET EXEC LINE NUMBER FOR MONITOR                                  
*                                                                               
*  ON ENTRY:                                                                    
*       CPEXLINE - CURRENT EXEC LINE                                            
*       CP#XSET - CURRENT EXEC SET NUMBER                                       
*                                                                               
*  WE COME HERE TO SET THE EXEC COMMAND LINE AND SET NUMBER.                    
*  THIS ROUTINE MUST BE SHORT AND FAST.                                         
*                                                                               
*  CAUTION: CPFMON MUST BE SET, AND CPMONPTR MUST BE NON-ZERO!                  
*                                                                               
*                                                                               
SETXLINE XPROC ,                                                                
         USING MMB,R6                                                           
         L     R6,CPMONPTR                                                      
*                                                                               
         MVC   MMBXLINE,CPEXLINE                                                
         MVC   MMBXSET,CP#XSET                                                  
*                                                                               
         PEND  ,              SHORT, SWEET                                      
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'MONITOR COMMAND/ROUTINES'                                       
*box                                                                            
*                                                                               
*                                                                               
*  MONITOR - WYLBUR'S MONITOR COMMAND                                           
*                                                                               
*  THIS COMMAND IS USED TO MONITOR EXEC FILES.                                  
*                                                                               
*                                                                               
*                                                                               
XMONITOR XPROC ,                                                                
*                                                                               
         COMMENT                   SCAN FOR OPTIONS                             
         SCAN  MONPRT                                                           
         SCANCHK                                                                
         CLEAR R15                                                              
*                                                                               
         B     CVNEXT              ALL DONE                                     
         PEND  ,                                                                
         SPACE 4                                                                
*-                                                                              
*-       MONITOR SCAN OPTIONS/ROUTINES                                          
*-                                                                              
MONPRT   SCKW  START,MONSTART,A                                                 
         SCKW  STOP,MONSTOP,A                                                   
         SCKW  CLEAR,MONCLEAR,A                                                 
         SCKW  CLR,MONCLEAR,A                                                   
         SCKW  RESET,MONRESET,A                                                 
         SCKW  ,V(SCNINVAL)                                                     
         SPACE 2                                                                
*                                                                               
*                                                                               
MSTRTPRT SCKW  COUNT,MONCOUNT,(P,I,A)                                           
         SCKW  ,V(SCNINVAL)                                                     
         DS    0H                                                               
         SPACE 4                                                                
*                                                                               
*  NULL OPTIONS - INVALID                                                       
*                                                                               
MCMDNULL PROC  ,                                                                
         ERROR 'Missing options.'                                               
         PEND  ,                                                                
*-                                                                              
*-       MONITOR START                                                          
*-                                                                              
MONSTART PROC  ,                                                                
         CLEAR R4                                                               
         SCAN  MSTRTPRT                                                         
         LR    R0,R4               MONITOR ENTRY COUNT, IF ANY                  
         ACALL MSTART              START MONITOR                                
         LA    R15,4                                                            
         PEND                                                                   
*-                                                                              
*-       MONITOR START COUNT=                                                   
*-                                                                              
MONCOUNT PROC  ,                                                                
         CLEAR CPMONMAX            CLEAR FORMER MAX MEM                         
         LR    R4,R0                                                            
         PRETURN (R4)                                                           
         CLEAR R15                                                              
         PEND  ,                                                                
*-                                                                              
*-       MONITOR STOP                                                           
*-                                                                              
MONSTOP  PROC  ,                                                                
         VCALL NOOPTS                                                           
         ACALL MSTOP                                                            
         LA    R15,4                                                            
         PEND                                                                   
*-                                                                              
*-       MONITOR CLEAR                                                          
*-                                                                              
MONCLEAR PROC  ,                                                                
         VCALL NOOPTS                                                           
         ACALL MCLEAR                                                           
         LA    R15,4                                                            
         PEND  ,                                                                
*-                                                                              
*-       MONITOR RESET                                                          
*-                                                                              
MONRESET PROC  ,                                                                
         VCALL NOOPTS                                                           
         ACALL MSTART                                                           
         LA    R15,4                                                            
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  MSTART  - START MONITOR                                                      
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - MAX MONITOR ENTRY COUNT                                            
*            (IF R0=0, WE USE DEFAULT ENTRY LIMITS)                             
*                                                                               
*                                                                               
MSTART   PROC  ,                                                                
*                                                                               
         COMMENT                   ARBITRATE MON MAX MEMORY                     
         ACALL GETMMAX                                                          
         ST    R0,CPMONMAX                                                      
*                                                                               
         COMMENT                   START FRESH, FREE UP MONITOR                 
         ACALL CLRMMEM               MEMORY, MONITOR INFO                       
         ACALL CLRMINFO                                                         
*                                                                               
         COMMENT                   GET 1ST MEMORY BLOCK                         
         ACALL INITMMEM                                                         
*                                                                               
         COMMENT                   TURN MONITOR ON AND TAKE OFF !               
         CLEAR CPMONCPU            START TIMER                                  
         SET   CPFMON              START MONITOR                                
*                                                                               
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  MSTOP - STOP MONITOR                                                         
*                                                                               
*  NOTE: WE STOP COLLECTING MONITOR ENTRIES, ALSO WE MOVE                       
*        MONITOR INFO OUT OF MEMORY TO PAGED DATA SET, JUST                     
*        TO KEEP MEMORY USAGE AT A MINIMUM.                                     
*                                                                               
*                                                                               
MSTOP    PROC  ,                                                                
*                                                                               
         COMMENT                   CHECK IF STOPPED, ALREADY                    
         IF    (CPMONPTR,NE,0),BEGIN     IF NOT, CONTINUE                       
*                                                                               
         COMMENT                   CLEAR MONITOR INFO                           
         ACALL CLRMINFO                                                         
*                                                                               
         COMMENT                   SET UP MONITOR INFO                          
         ACALL GETMINFO                                                         
*                                                                               
         COMMENT                   CLEAR MONITOR MEMORY                         
         ACALL CLRMMEM                                                          
         END                                                                    
*                                                                               
         COMMENT                   TURN OFF MONITOR                             
         CLEAR CPFMON                                                           
         CLEAR CPMONPTR                                                         
         CLEAR CPMONCPU                                                         
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  MCLEAR - TURN OFF MONITOR, GET RID OF ALL MONITOR STUFF                      
*                                                                               
*                                                                               
*                                                                               
MCLEAR   XPROC ,                                                                
*                                                                               
         COMMENT                   CLEAR MONITOR INFO, MEMORY                   
         ACALL CLRMMEM                                                          
         ACALL CLRMINFO                                                         
*                                                                               
         COMMENT                   TURN OFF MONITOR                             
         CLEAR CPFMON                                                           
         CLEAR CPMONPTR                                                         
         CLEAR CPMONCPU                                                         
         CLEAR CPMONMAX                                                         
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  INITMMEM - GET FIRST MONITOR MEMORY BLOCK, AND                               
*             INITIALIZE RELATED THINGS                                         
*                                                                               
*                                                                               
*                                                                               
INITMMEM PROC  ,                                                                
         USING  MMB,R6                                                          
*                                                                               
         COMMENT                   BOMB IF WE ALREADY HAVE MON MEM              
         IF    (CPMONPTR,NE,0),BEGIN                                            
         BOMB                                                                   
         END                                                                    
*                                                                               
         COMMENT                   GET MEMORY BLOCK                             
         L     R0,=AL4(MMEMBSZ)                                                 
         VCALL GETCORE                                                          
         ST    R1,CPMONPTR                                                      
*                                                                               
         COMMENT                   INITIALIZE MEMORY BLOCK                      
         LR    R6,R1                                                            
         LR    R2,R1                                                            
         LR    R3,R0                                                            
         SR    R5,R5                                                            
         MVCL  R2,R4               CLEAR IT                                     
         ST    R0,MMBLEN           INIT HEADER IN ORDER OF APPEARANCE           
         ST    R6,MMBHEAD                                                       
         ST    R6,MMBLINK                                                       
         ST    R0,MMBTMEM                                                       
         LA    R2,MMB                                                           
         A     R2,MMBLEN                                                        
         S     R2,=AL4(L'MONENTRY)                                              
         ST    R2,MMBEND                                                        
         LA    R2,MMBDATA                                                       
         ST    R2,MMBPTR                                                        
*                                                                               
         IF    (CPMONMAX,GT,=A(MMEMBIG)),BEGIN                                  
         INCR  R15,CVXMONCT                                                     
         SET   CPFBIGXMON                                                       
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  ADDMMEM - ADD MONITOR MEMORY BLOCK, UPDATE CPMONPTR                          
*                                                                               
*  ON EXIT:                                                                     
*       CPMONPTR - UPDATED TO NEW (NEXT) BLOCK                                  
*       MMBPTR - POINTS TO START OF NEW BLOCK                                   
*       R15 - CC=Z, NEW MEMORY BLOCK OBTAINED                                   
*             CC=NZ, MEMORY LIMIT EXCEEDED, CIRCULAR LINK ADDED                 
*                                                                               
*                                                                               
*  NOTE: WE ADD MEMORY BLOCKS UNTIL THE MEMORY LIMIT IS EXCEEDED.               
*    AT THAT POINT, WE ADD NO MORE BLOCKS, BUT REUSE THE THE BLOCKS             
*    MAKING A CIRCULAR CHAIN, AND A CIRCULAR LIST.                              
*                                                                               
ADDMMEM  PROC  ,                                                                
         USING  MMB,R6                                                          
         L     R6,CPMONPTR                                                      
*                                                                               
         COMMENT                   BOMB IF WE HAVE NO BLOCKS                    
         COMMENT                   BOMB IF WE HAVE TOO MANY BLOCKS              
         IF    (CPMONPTR,EQ,0),BEGIN                                            
         BOMB                                                                   
         END                                                                    
         IF    (MMBTMEM,GE,CPMONMAX),BEGIN                                      
         BOMB                                                                   
         END                                                                    
*                                                                               
         COMMENT                   GET NEW MEMORY BLOCK                         
         L     R0,=AL4(MMEMBSZ)                                                 
         VCALL GETCORE                                                          
         ST    R1,CPMONPTR                                                      
         ST    R1,MMBLINK                                                       
*                                                                               
         COMMENT                   INITIALIZE MEMORY BLOCK                      
         COMMENT                   R1,R0 - NEW BLK LOC, LEN                     
         LA    R15,MMB             R15 - LAST MONITOR MEM BLOCK                 
         LR    R6,R1               R6 - NEW MONITOR MEM BLOCK                   
         LR    R2,R1                                                            
         LR    R3,R0                                                            
         SR    R5,R5                                                            
         MVCL  R2,R4               CLEAR IT                                     
         ST    R0,MMBLEN           INIT HEADERS IN ORDER OF APPEARANCE          
         L     R2,MMBHEAD-MMB(R15)                                              
         ST    R2,MMBHEAD                                                       
         ST    R2,MMBLINK                                                       
         L     R2,MMBTMEM-MMB(R15)                                              
         A     R2,MMBLEN                                                        
         ST    R2,MMBTMEM                                                       
         LA    R2,MMB                                                           
         A     R2,MMBLEN                                                        
         S     R2,=AL4(L'MONENTRY)                                              
         ST    R2,MMBEND                                                        
         LA    R2,MMBDATA                                                       
         ST    R2,MMBPTR                                                        
*                                                                               
         COMMENT                   UPDATE MEM TOTAL, IN ALL BLOCKS              
         L     R2,MMBTMEM                                                       
         LA    R4,MMB                                                           
         L     R6,MMBLINK                                                       
         WHILE (R6,NE,R4),BEGIN                                                 
         ST    R2,MMBTMEM                                                       
         L     R6,MMBLINK                                                       
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CLRMMEM - RETURN ALL MONITOR GETCORED MEMORY                                 
*                                                                               
*                                                                               
*                                                                               
CLRMMEM  PROC  ,                                                                
         USING  MMB,R6                                                          
*                                                                               
         COMMENT                   IF MON MEM BLKS TO FREE, DO IT               
         IF    (CPMONPTR,NE,0),BEGIN                                            
*                                                                               
         COMMENT                   POINT TO HEAD OF MON BLK CHAIN               
         L     R6,CPMONPTR                                                      
         L     R6,MMBHEAD                                                       
*                                                                               
         COMMENT                   LOOP FREEING ALL MONITOR BLOCKS              
         LA    R2,MMB                                                           
         LA    R1,MMB                                                           
         L     R6,MMBLINK          CLEAR HEAD BLOCK                             
         VCALL FREECORE                                                         
         LA    R1,MMB                                                           
         WHILE (R1,NE,R2),BEGIN    CLEAR REMAINING BLOCKS                       
         L     R6,MMBLINK                                                       
         VCALL FREECORE                                                         
         LA    R1,MMB                                                           
         END                                                                    
*                                                                               
         COMMENT                   MEMORY CLEARED, CLEAR MEM POINTER            
         CLEAR CPMONPTR                                                         
         COMMENT                   IF NEEDED, DECREMENT BIG XMON CT             
         IF    CPFBIGXMON,BEGIN                                                 
         CLEAR CPFBIGXMON                                                       
         L     R15,CVXMONCT                                                     
         IF    (R15,POS),BEGIN                                                  
         DECR  R15                                                              
         ST    R15,CVXMONCT                                                     
         END                                                                    
         END                                                                    
         END , OF BLKS FREED                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CLRMINFO - CLEAR MONITOR INFO SAVED IN RECORD GROUP                          
*                                                                               
*                                                                               
*                                                                               
CLRMINFO PROC  ,                                                                
*                                                                               
         COMMENT                   DELETE MONITOR INFO RECORD SETS              
         LA    R15,CPRG16                                                       
         LA    R0,CP#MRAW                                                       
         VCALL XDELSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,CP#MSUM                                                       
         VCALL XDELSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,CP#MNAME                                                      
         VCALL XDELSET                                                          
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  GETMINFO - CREATE MONITOR INFO IN MONITOR RECORD SET                         
*                                                                               
*  ON ENTRY:                                                                    
*       CPMONPTR - POINTS TO MEMORY BLOCK FOR NEXT ENTRY                        
*       MCBPTR - POINTS TO LOCATION FOR NEXT ENTRY                              
*                                                                               
*  ON EXIT:                                                                     
*       MONITOR RECORD SET CREATED                                              
*                                                                               
*                                                                               
*                                                                               
GETMINFO PROC  ,                                                                
*                                                                               
         COMMENT                   CLEAR ANY CURRENT MONITOR INFO               
         ACALL CLRMINFO                                                         
*                                                                               
         COMMENT                   IF MONITOR MEMORY, WE DO IT TO IT            
         IF    (CPMONPTR,NE,0),BEGIN                                            
         ACALL CHKOFLOW                                                         
         ACALL GETRAW                                                           
         ACALL GETSUM                                                           
         ACALL GETNAMES                                                         
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CHKOFLOW - CHECK IF MONITOR DATA HAS OVERFLOWED                              
*                                                                               
*  ON ENTRY:                                                                    
*       CPMONPTR,MMBPTR - POINTER AT POINT WHEN MONITOR STOPPED                 
*                                                                               
*  WE CHECK IF MONITOR POINTER POINTS TO EMPTY ENTRY, IF NOT                    
*  THEN WE ARE DESTRUCTIVELY REWRITTING EARIER DATA                             
*                                                                               
*                                                                               
CHKOFLOW PROC  ,                                                                
         USING MMB,R6                                                           
         USING MONENTRY,R1                                                      
*                                                                               
         L     R6,CPMONPTR                                                      
         L     R1,MMBPTR                                                        
         IF    (MONENTRY,NE,0),BEGIN                                            
         TSEG  'Note: Monitor buffer full, '                                    
         TSEG  'earlier data has been overwritten.',,CR                         
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R1                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  GETRAW - GET/ SAVE RAW MONITOR DATA IN MON RECORD SET                        
*                                                                               
*  ON ENTRY:                                                                    
*       CPMONPTR - POINTS TO MEMORY BLOCK FOR NEXT ENTRY                        
*       MMBPTR - POINTS TO LOCATION FOR NEXT ENTRY                              
*                                                                               
*  ON EXIT:                                                                     
*       MONITOR RECORD SET CREATED                                              
*       CPMONPTR,MMBPTR - SAME AS ON ENTRY                                      
*                                                                               
*                                                                               
GRWA     RECORD BEGIN                                                           
GRMONPTR DS    F                   MON MEMORY BLK PTR AT ENTRY                  
GRMMBPTR DS    F                   MON ENTRY PTR AT ENTRY                       
GRCURPTR DS    F                   CURRENT MONITOR ENTRY PTR                    
GRRAW    DS    XL(L'MRR)           RAW MONITOR INFO RECORD                      
GRPARMS  DS    4F                  R15-R2 XPUT PARMS                            
         END                                                                    
*                                                                               
*                                                                               
GETRAW   PROC  GRWA                                                             
         USING MRR,R6                                                           
         USING MONENTRY,R1                                                      
         LA    R6,GRRAW                                                         
*                                                                               
         COMMENT                   INIT WORK AREA                               
         L     R1,CPMONPTR                                                      
         ST    R1,GRMONPTR                                                      
         L     R1,MMBPTR-MMB(R1)                                                
         ST    R1,GRMMBPTR                                                      
         ACALL NEXTNTRY                                                         
         ST    R1,GRCURPTR                                                      
         CLEAR GRRAW                                                            
         CLEAR GRPARMS                                                          
*                                                                               
         COMMENT                   SET MONITOR RECORD SET                       
         LA    R15,CPRG16                                                       
         LA    R0,CP#MRAW                                                       
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   REGISTER USAGE:                              
         COMMENT                   R15 - RECORD GROUP INFO PTR                  
         COMMENT                   R0 - DATA LEN FOR XPUT                       
         COMMENT                   R1 - DATA ADDR FOR XPUT                      
         COMMENT                   R1 - ADDR OF CUR MON ENTRY IN MEM            
         COMMENT                   R2 - DATA NAME (SEQ NUM) FRO XPUT            
         COMMENT                   R3 - SEQUENCE COUNTER                        
         COMMENT                   R5 - ENDING MONITOR ENTRY ADDR               
*                                                                               
         COMMENT                   SKIP ALL NULL ENTRY                          
         L     R5,GRMMBPTR                                                      
         L     R1,GRCURPTR                                                      
         WHILE ((R1,NE,R5),AND,(MONENTRY,EQ,0)),BEGIN                           
         ACALL NEXTNTRY                                                         
         END                                                                    
         ST    R1,GRCURPTR                                                      
*                                                                               
         COMMENT                   WRITE OUT NON NULL ENTRIES                   
         IF    (R1,NE,R5),BEGIN    IF NON-NULL ENTRIES                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MRRDATA                                                     
         LA    R1,MRRDATA                                                       
         LA    R2,MRRNAME                                                       
         STM   R15,R2,GRPARMS      SAVE XPUT PARMS                              
         CLEAR R3                                                               
         L     R5,GRMMBPTR         R5 - END OF MON ENTRYS                       
         L     R1,GRCURPTR         R1 - CURRENT MON ENTRY PTR                   
         COMMENT                                                                
         WHILE (R1,NE,R5),BEGIN    LOOP WRITING RAW ENTRIES                     
         LA    R3,1(R3)            NAME IS SEQUENCE NUMBER                      
         ST    R3,MRRNMSEQ                                                      
         MVC   MRRDATA,MONENTRY    DATA IS RAW MONITOR ENTRY                    
         LM    R15,R2,GRPARMS                                                   
         VCALL XPUT                                                             
         IF    NZ,BEGIN                                                         
         KAPUT MONFULL,'Session Data Record Group Overflow.'                    
         END                                                                    
         L     R1,GRCURPTR                                                      
         ACALL NEXTNTRY                                                         
         ST    R1,GRCURPTR                                                      
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   RESTORE MONITOR POINTERS                     
         L     R1,GRMONPTR                                                      
         ST    R1,CPMONPTR                                                      
         L     R2,GRMMBPTR                                                      
         ST    R2,MMBPTR-MMB(R1)                                                
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R1                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  GETSUM - GET/ SAVE SUMMARY MONITOR DATA IN MON RECORD SET                    
*                                                                               
*  ON ENTRY:                                                                    
*       CPMONPTR - POINTS TO MEMORY BLOCK FOR NEXT ENTRY                        
*       MMBPTR - POINTS TO LOCATION FOR NEXT ENTRY                              
*                                                                               
*  ON EXIT:                                                                     
*       MONITOR RECORD SET CREATED                                              
*       CPMONPTR,MMBPTR - SAME AS ON ENTRY                                      
*                                                                               
*                                                                               
GSWA     RECORD BEGIN                                                           
GSMONPTR DS    F                   MON MEMORY BLK PTR AT ENTRY                  
GSMMBPTR DS    F                   MON ENTRY PTR AT ENTRY                       
GSCURPTR DS    F                   CURRENT MONITOR ENTRY PTR                    
GSSUM    DS    XL(L'MSR)           SUMMARY MONITOR INFO RECORD                  
GSPARMS  DS    4F                  R15-R2 XPUT PARMS                            
         END                                                                    
*                                                                               
*                                                                               
GETSUM   PROC  GSWA                                                             
         USING MSR,R6                                                           
         USING MONENTRY,R1                                                      
         LA    R6,GSSUM                                                         
*                                                                               
         COMMENT                   INIT WORK AREA                               
         L     R1,CPMONPTR                                                      
         ST    R1,GSMONPTR                                                      
         L     R1,MMBPTR-MMB(R1)                                                
         ST    R1,GSMMBPTR                                                      
         ACALL NEXTNTRY                                                         
         ST    R1,GSCURPTR                                                      
         CLEAR GSSUM                                                            
         CLEAR GSPARMS                                                          
*                                                                               
         COMMENT                   SET MONITOR RECORD SET                       
         LA    R15,CPRG16                                                       
         LA    R0,CP#MSUM                                                       
         VCALL XSETSET                                                          
*                                                                               
         COMMENT                   REGISTER USAGE:                              
         COMMENT                   R15 - RECORD GSOUP INFO PTR                  
         COMMENT                   R0 - DATA LEN FOR XPUT                       
         COMMENT                   R1 - DATA ADDR FOR XPUT                      
         COMMENT                   R1 - ADDR OF CUR MON ENTRY IN MEM            
         COMMENT                   R2 - DATA NAME (SEQ NUM) FRO XPUT            
         COMMENT                   R5 - ENDING MONITOR ENTRY ADDR               
*                                                                               
         COMMENT                   SKIP ALL NULL ENTRY                          
         L     R5,GSMMBPTR                                                      
         L     R1,GSCURPTR                                                      
         WHILE ((R1,NE,R5),AND,(MONENTRY,EQ,0)),BEGIN                           
         ACALL NEXTNTRY                                                         
         END                                                                    
         ST    R1,GSCURPTR                                                      
*                                                                               
         COMMENT                   WRITE OUT NON NULL ENTRIES                   
         IF    (R1,NE,R5),BEGIN    IF NON-NULL ENTRIES                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MSRDATA                                                     
         LA    R1,MSRDATA                                                       
         LA    R2,MSRNAME                                                       
         STM   R15,R2,GSPARMS      SAVE XGET/XPUT PARMS                         
         CLEAR R3                                                               
         L     R5,GSMMBPTR         R5 - END OF MON ENTRYS                       
         L     R1,GSCURPTR         R1 - CURRENT MON ENTRY PTR                   
         COMMENT                                                                
         WHILE (R1,NE,R5),BEGIN    LOOP WRITING SUMMARY ENTRIES                 
         L     R3,MONXLINE         NAME IS LINE #/SET #                         
         ST    R3,MSRNMLIN                                                      
         L     R3,MONXSET                                                       
         ST    R3,MSRNMSET                                                      
         LM    R15,R2,GSPARMS                                                   
         VCALL XGET                GET CURRENT LINE ENTRY                       
         IF    NZ,BEGIN            IF NO, ENTRY MAKE ONE                        
         L     R1,GSCURPTR                                                      
         CLEAR MSRDATA                                                          
         L     R3,MONXLINE                                                      
         ST    R3,MSRXLINE                                                      
         L     R3,MONXSET                                                       
         ST    R3,MSRXSET                                                       
         END                                                                    
         COMMENT                   ADD MONITOR INFO TO LINE SUMMARY             
         L     R1,GSCURPTR                                                      
         L     R3,MSRTCPU          ADD ENTRY TIME TO SUMMARY                    
         A     R3,MONCPU                                                        
         ST    R3,MSRTCPU                                                       
         L     R3,MSRCNT           UPDATE CMD EXECUTION COUNT                   
         LA    R3,1(R3)                                                         
         ST    R3,MSRCNT                                                        
         LM    R15,R2,GSPARMS                                                   
         VCALL XPUT                                                             
         IF    NZ,BEGIN                                                         
         KAPUT MONFULL,'Session Data Record Group Overflow.'                    
         END                                                                    
         L     R1,GSCURPTR                                                      
         ACALL NEXTNTRY                                                         
         ST    R1,GSCURPTR                                                      
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   RESTORE MONITOR POINTERS                     
         L     R1,GSMONPTR                                                      
         ST    R1,CPMONPTR                                                      
         L     R2,GSMMBPTR                                                      
         ST    R2,MMBPTR-MMB(R1)                                                
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R1                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  GETNAMES - GET XNAME INFOMATION                                              
*                                                                               
*                                                                               
*  ON ENTRY:                                                                    
*       MONITOR RAW, SUMMARY INFORMATION SET UP                                 
*                                                                               
*  ON EXIT:                                                                     
*       EXEC NAMES SAVED FOR EACH SET NUMBER IN MON INFO                        
*                                                                               
*                                                                               
*                                                                               
GXWA     RECORD BEGIN                                                           
GXXNAME  DS    XL(L'MNR)           MON NAME INFO RECORD                         
GXSUM    DS    XL(L'MSR)           MON SUMMARY RECORD                           
         END                                                                    
GXMAXCNT EQU   60                  MUST BE < ALISTCNT IN XCALL                  
*                                                                               
*                                                                               
GETNAMES PROC  GXWA                                                             
         USING MNR,R6                                                           
         USING MSR,R5                                                           
         LA    R6,GXXNAME                                                       
         LA    R5,GXSUM                                                         
*                                                                               
         COMMENT                   INITIALIZE WORK AREA                         
         CLEAR GXXNAME                                                          
         CLEAR GXSUM                                                            
         CLEAR R4                  COUNT OF PRIVATE EXECS MONITORED             
*                                                                               
         COMMENT                   LOOP READING SUMMARY SET NUMBERS             
         LA    R15,CPRG16                                                       
         LA    R0,CP#MSUM                                                       
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MSRDATA                                                     
         LA    R1,MSRDATA                                                       
         LA    R2,MSRNAME                                                       
         LA    R3,1                                                             
         CLEAR MSRNAME                                                          
         ST    R3,MSRNMSET                                                      
         VCALL XGETFRST            READ 1ST SET                                 
         WHILE Z,BEGIN             LOOP READING SET NUMBERS                     
         L     R3,MSRXSET                                                       
         IF    (R3,LT,CV#FEXEC),BEGIN   COUNT LOADED EXECS                      
         LA    R4,1(R4)                                                         
         END                                                                    
         CLEAR MNRNAME             SET UP NAME REOCRD                           
         ST    R3,MNRNMSET                                                      
         LA    R1,MNRXNAME                                                      
         LR    R0,R3                                                            
         VCALL GETXNAME            GET EXEC NAME FROM SET #                     
         IF    NZ,BEGIN                                                         
         LA    R4,GXMAXCNT                                                      
         MVC   MNRXNAME(7),=CL7'UNKNOWN'                                        
         LA    R0,7                                                             
         END                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,CP#MNAME                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16          SAVE NAME RECORD                             
         LA    R0,L'MNRDATA                                                     
         LA    R1,MNRDATA                                                       
         LA    R2,MNRNAME                                                       
         VCALL XPUT                                                             
         IF    NZ,BEGIN                                                         
         KAPUT MONFULL,'Session Data Record Group Overflow.'                    
         END                                                                    
         CLEAR GXSUM               GET NEXT SET NUMBER                          
         LA    R3,1(R3)                                                         
         ST    R3,MSRNMSET                                                      
         LA    R15,CPRG16                                                       
         LA    R0,CP#MSUM                                                       
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MSRDATA                                                     
         LA    R1,MSRDATA                                                       
         LA    R2,MSRNAME                                                       
         VCALL XGETFRST            READ 1ST REC OF NEXT SET NUMBER              
         COMMENT ,                 (IE. GET NEXT EXEC SET IN SUM)               
         END                                                                    
*                                                                               
         COMMENT                   IF TOO MANY EXECS LOADED,                    
         COMMENT                     EXEC NAMES MAY NOT CORRESPOND              
         IF    (R4,GE,GXMAXCNT),BEGIN                                           
         ACALL MCLEAR                                                           
         TSEG  'Too many execs loaded/unloaded or called. ',,CR                 
         ERROR 'Error: Unable to resolve exec data set names. '                 
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  NEXTPTR - GET POINTER TO NEXT MONITOR ENTRY TO *ADD*!                        
*                                                                               
*  ON ENTRY:                                                                    
*       CPMONPTR - POINTER TO CURRENT MON MEMORY BLOCK                          
*       MMBPTR - POINTER TO CURRENT ENTRY IN BLOCK                              
*  ON EXIT:                                                                     
*       CPMONPTR - UPDATED                                                      
*       MMBPTR - UPDATED                                                        
*       R1 - POINTER TO NEXT ENTRY                                              
*                                                                               
*  WARNING!: USE THIS ROUTINE ONLY TO ADD MONITOR ENTRIES,                      
*        AS IT WILL ADD MEMORY BLOCKS AS NEEDED.                                
*                                                                               
NEXTPTR  PROC  ,                                                                
         USING MMB,R6                                                           
         L     R6,CPMONPTR                                                      
*                                                                               
         COMMENT                   GET, BUMP POINTER                            
         L     R1,MMBPTR                                                        
         LA    R1,L'MONENTRY(R1)                                                
         IF    (R1,LT,MMBEND),BEGIN     IF NOT PAST END OF PAGE,                
         ST    R1,MMBPTR                                                        
         END                                                                    
*                                                                               
         COMMENT                   IF ON NEXT PAGE,,                            
         ELSE  BEGIN                                                            
         COMMENT                   GET A NEW PAGE IF OK                         
         IF    (MMBTMEM,LT,CPMONMAX),BEGIN                                      
         ACALL ADDMMEM                                                          
         END                                                                    
         ELSE  BEGIN               OTHERWISE GET NEXT PAGE,                     
         L     R6,MMBLINK             FOLLOW CIRCULAR LINKS                     
         ST    R6,CPMONPTR                                                      
         END                                                                    
         COMMENT                   GET 1ST ENTRY POINTER ON PAGE                
         L     R6,CPMONPTR                                                      
         LA    R1,MMBDATA                                                       
         ST    R1,MMBPTR                                                        
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PRETURN (R0,R1)                                                        
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  NEXTNTRY - GET POINTER TO NEXT MONITOR ENTRY TO *READ*!                      
*                                                                               
*  ON ENTRY:                                                                    
*       CPMONPTR - POINTER TO CURRENT MON MEMORY BLOCK                          
*       MMBPTR - POINTER TO CURRENT ENTRY IN BLOCK                              
*  ON EXIT:                                                                     
*       CPMONPTR - UPDATED                                                      
*       MMBPTR - UPDATED                                                        
*       R1 - POINTER TO NEXT ENTRY                                              
*                                                                               
*  WARNING!: USE THIS ROUTINE ONLY TO READ MONITOR ENTRIES,                     
*        AS IT WILL NOT ADD MEMORY BLOCKS AS NEEDED.                            
*                                                                               
*                                                                               
NEXTNTRY PROC  ,                                                                
         USING MMB,R6                                                           
         L     R6,CPMONPTR                                                      
*                                                                               
         COMMENT                   GET, BUMP POINTER                            
         L     R1,MMBPTR                                                        
         LA    R1,L'MONENTRY(R1)                                                
         IF    (R1,LT,MMBEND),BEGIN     IF NOT PAST END OF PAGE,                
         ST    R1,MMBPTR                                                        
         END                                                                    
*                                                                               
         COMMENT                   IF ON NEXT PAGE,,                            
         ELSE  BEGIN                                                            
         COMMENT                   GET NEXT PAGE                                
         L     R6,MMBLINK             FOLLOW CIRCULAR LINKS                     
         ST    R6,CPMONPTR                                                      
         COMMENT                   GET 1ST ENTRY POINTER ON PAGE                
         L     R6,CPMONPTR                                                      
         LA    R1,MMBDATA                                                       
         ST    R1,MMBPTR                                                        
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PRETURN (R0,R1)                                                        
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  GETMMAX - ARBITRATE MAX AMOUNT OF MEMORY TO GET                              
*                                                                               
*  ON ENTRY:                                                                    
*       R0 - NUMBER OF ENTRIES REQUESTED                                        
*            (IF R0=0, WE RETURN 8K MEMORY DEFAULT)                             
*                                                                               
*  ON EXIT:                                                                     
*       R0 - MAX AMOUNT OF MEMORY TO GET                                        
*                                                                               
*                                                                               
*                                                                               
GETMMAX  PROC  ,                                                                
*                                                                               
         COMMENT                   GET MEMORY MAX IN BYTES                      
         IF    (R0,Z),BEGIN                                                     
         L     R2,=AL4(MMEMDFLT)    DEFAULT IS ABOUT 8K                         
         END                                                                    
         ELSE  BEGIN                                                            
         LR    R2,R0                                                            
         MH    R2,=AL2(L'MONENTRY)                                              
         A     R2,=AL4(MMEMFDGE)                                                
         END                                                                    
*                                                                               
         COMMENT                   ARBITRATE AMOUNT                             
         IF    (R2,LT,CPMONMAX),BEGIN                                           
         L     R2,CPMONMAX                                                      
         END                                                                    
         IF    (R2,LT,=A(MMEMMIN)),BEGIN                                        
         L     R2,=AL4(MMEMMIN)                                                 
         END                                                                    
         IF    (R2,GT,=A(MMEMMAX)),BEGIN                                        
         L     R2,=AL4(MMEMMAX)                                                 
         END                                                                    
         COMMENT ,                 ONLY THREE BIG XMONS ALLOWED                 
         IF   ((R2,GT,=A(MMEMBIG)),AND,(CVXMONCT,GE,MAXBIGCT)),BEGIN            
         TSEG  'Too many big XMON sessions. '                                   
         TSEG  'Count value ignored.',,CR                                       
         L     R2,=AL4(MMEMBIG)                                                 
         END                                                                    
*                                                                               
         LR    R0,R2                                                            
         CLEAR R15                                                              
         PRETURN (R0)                                                           
         PEND  ,                                                                
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'SHOW MONITOR ROUTINES'                                          
*box                                                                            
*                                                                               
*                                                                               
*  SHOWMON - SHOW MONITOR INFORMATION                                           
*                                                                               
*  SHOW EXEC MONITOR INFORMATION                                                
*                                                                               
*                                                                               
*                                                                               
SHOWMON  XPROC ,                                                                
*                                                                               
         COMMENT                   MAKE SURE MONITOR IS STOPPED                 
         IF    (CPMONPTR,NE,0),BEGIN                                            
         ACALL MSTOP                                                            
         END                                                                    
*                                                                               
         COMMENT                   SCAN OPTIONS                                 
         SCAN  SHOWMPRT                                                         
         SCANCHK                                                                
         CLEAR R15                                                              
*                                                                               
         B     CVNEXT                                                           
         PEND  ,                                                                
         SPACE 4                                                                
*-                                                                              
*-       SHOW MONITOR OPTIONS AND ROUTINES                                      
*-                                                                              
SHOWMPRT SCKW  ,MSUMMARY,NULL                                                   
         SCKW  SUMMARY,MSUMMARY,A                                               
         SCKW  RAW,MRAW                                                         
         SCKW  NAMES,MNAMES,A                                                   
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(SCNINVAL)                                                     
         SPACE 2                                                                
*-                                                                              
*-       SHOW MONITOR SUMMARY                                                   
*-                                                                              
MSUMMARY PROC  ,                                                                
         VCALL COLLOPTS                                                         
         ACALL SHOWSUM                                                          
         LA    R15,4                                                            
         PEND  ,                                                                
*-                                                                              
*-       SHOW MONITOR RAW                                                       
*-                                                                              
MRAW     PROC  ,                                                                
         VCALL COLLOPTS                                                         
         ACALL SHOWRAW                                                          
         LA    R15,4                                                            
         PEND  ,                                                                
*-                                                                              
*-       SHOW MONITOR NAMES                                                     
*-                                                                              
MNAMES   PROC  ,                                                                
         VCALL COLLOPTS                                                         
         ACALL SHOWNAMS                                                         
         LA    R15,4                                                            
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  SHOWRAW - SHOW MONITOR RAW                                                   
*                                                                               
*                                                                               
*  ON ENTRY                                                                     
*       MONITOR INFO IN MONITOR RECORD SETS.                                    
*                                                                               
*                                                                               
*                                                                               
*                                                                               
SMRWA    RECORD BEGIN                                                           
SMRRAW   DS    XL(L'MRR)                                                        
SMRNAME  DS    XL(L'MNR)                                                        
SMRXSET  DS    F                                                                
         END                                                                    
*                                                                               
*                                                                               
SHOWRAW  PROC  SMRWA                                                            
         USING MRR,R6                                                           
         USING MNR,R5                                                           
         LA    R6,SMRRAW                                                        
         LA    R5,SMRNAME                                                       
*                                                                               
         COMMENT                   INITIALIZE WORK AREA                         
         CLEAR SMRRAW                                                           
         CLEAR SMRNAME                                                          
         CLEAR SMRXSET                                                          
*                                                                               
         COMMENT                   WRITE OUT HEADER LINES                       
         TSEG  'Monitor Raw Data:',,CR                                          
         BNZ   CVNEXT              IF ATTN, SCRAM                               
*                                                                               
         COMMENT                   WRITE ALL RAW RECORDS                        
         LA    R15,CPRG16          GET 1ST RAW RECORD                           
         LA    R0,CP#MRAW                                                       
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MRRDATA                                                     
         LA    R1,MRRDATA                                                       
         LA    R2,MRRNAME                                                       
         VCALL XGETFRST                                                         
         WHILE Z,BEGIN             LOOP WRITING RECORDS,,                       
         L     R3,MRRXSET                                                       
         IF    (R3,NE,SMRXSET),BEGIN    IF NEW EXEC, GET EXEC NAME              
         ST    R3,SMRXSET                                                       
         ST    R3,MNRNMSET                                                      
         LA    R15,CPRG16                                                       
         LA    R0,CP#MNAME                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MNRDATA                                                     
         LA    R1,MNRDATA                                                       
         LA    R2,MNRNAME                                                       
         VCALL XGET                                                             
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
         VCALL SEGFDSN             WRITE OUT EXEC NAME, IF NEW EXEC             
         TCR                                                                    
         TSEG  '   Line           ID    CPU ',,CR                               
         END                                                                    
         L     R1,MRRXLINE         WRITE OUT MONITOR INFO FOR LINE              
         ACALL MSEGLNO                                                          
         L     R1,MRRXSET                                                       
         ACALL MSEGNO                                                           
         L     R1,MRRCPU                                                        
         ACALL MSEGCPU                                                          
         TCR                                                                    
         TWRITE                                                                 
         LA    R15,CPRG16          GET NEXT RAW RECORD                          
         LA    R0,CP#MRAW                                                       
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MRRDATA                                                     
         LA    R1,MRRDATA                                                       
         LA    R2,MRRNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R5                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  SHOWSUM - SHOW MONITOR SUMMARY                                               
*                                                                               
*                                                                               
*  ON ENTRY                                                                     
*       MONITOR INFO IN MONITOR RECORD SET.                                     
*                                                                               
*                                                                               
*                                                                               
*                                                                               
SMSWA    RECORD BEGIN                                                           
SMSSUM   DS    XL(L'MSR)                                                        
SMSNAME  DS    XL(L'MNR)                                                        
SMSXSET  DS    F                                                                
         END                                                                    
*                                                                               
*                                                                               
SHOWSUM  PROC  SMSWA                                                            
         USING MSR,R6                                                           
         USING MNR,R5                                                           
         LA    R6,SMSSUM                                                        
         LA    R5,SMSNAME                                                       
*                                                                               
         COMMENT                   INITIALIZE WORK AREA                         
         CLEAR SMSSUM                                                           
         CLEAR SMSNAME                                                          
         CLEAR SMSXSET                                                          
*                                                                               
         COMMENT                   WRITE OUT HEADER LINES                       
         TSEG  'Monitor Data Summary:',,CR                                      
         BNZ   CVNEXT              IF ATTN, SCRAM                               
*                                                                               
         COMMENT                   WRITE ALL SUMMARY RECORDS                    
         LA    R15,CPRG16          GET 1ST SUMMARY RECORD                       
         LA    R0,CP#MSUM                                                       
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MSRDATA                                                     
         LA    R1,MSRDATA                                                       
         LA    R2,MSRNAME                                                       
         VCALL XGETFRST                                                         
         WHILE Z,BEGIN             LOOP WRITING RECORDS,,                       
         L     R3,MSRXSET                                                       
         IF    (R3,NE,SMSXSET),BEGIN    IF NEW EXEC, GET EXEC NAME              
         ST    R3,SMSXSET                                                       
         ST    R3,MNRNMSET                                                      
         LA    R15,CPRG16                                                       
         LA    R0,CP#MNAME                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MNRDATA                                                     
         LA    R1,MNRDATA                                                       
         LA    R2,MNRNAME                                                       
         VCALL XGET                                                             
         IF    NZ,BEGIN                                                         
         BOMB                                                                   
         END                                                                    
         VCALL SEGFDSN             WRITE OUT EXEC NAME, IF NEW EXEC             
         TCR                                                                    
         TSEG  '   Line           ID    CPU        Count',,CR                   
         END                                                                    
         L     R1,MSRXLINE         WRITE OUT MONITOR INFO FOR LINE              
         ACALL MSEGLNO                                                          
         L     R1,MSRXSET                                                       
         ACALL MSEGNO                                                           
         L     R1,MSRTCPU                                                       
         ACALL MSEGCPU                                                          
         L     R1,MSRCNT                                                        
         ACALL MSEGNO                                                           
         TCR                                                                    
         TWRITE                                                                 
         LA    R15,CPRG16          GET NEXT SUMMARY RECORD                      
         LA    R0,CP#MSUM                                                       
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MSRDATA                                                     
         LA    R1,MSRDATA                                                       
         LA    R2,MSRNAME                                                       
         VCALL XGETNEXT                                                         
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R5                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  SHOWNAMS - SHOW MONITOR EXEC NAMES                                           
*                                                                               
*  ON ENTRY:                                                                    
*       MONITOR INFO IN MONITOR RECORD SET.                                     
*                                                                               
*                                                                               
*                                                                               
SMNWA    RECORD BEGIN                                                           
SMNNAME  DS    XL(L'MNR)                                                        
         END                                                                    
*                                                                               
*                                                                               
SHOWNAMS PROC  SMNWA                                                            
         USING MNR,R6                                                           
         LA    R6,SMNNAME                                                       
*                                                                               
         COMMENT                   INIT WORK AREA                               
         CLEAR SMNNAME                                                          
*                                                                               
         COMMENT                   WRITE OUT HEADER LINES                       
         TSEG  'Monitor Exec Name Data:',,CR                                    
         TSEG  '        ID  Name',,CR                                           
         BNZ   CVNEXT              IF ATTN, SCRAM                               
*                                                                               
         COMMENT                   LOOP WRITING EXEC SET #/ NAME                
         LA    R15,CPRG16                                                       
         LA    R0,CP#MNAME                                                      
         VCALL XSETSET                                                          
         LA    R15,CPRG16                                                       
         LA    R0,L'MNRDATA                                                     
         LA    R1,MNRDATA                                                       
         LA    R2,MNRNAME                                                       
         VCALL XGETFRST            GET FIRST RECORD                             
         WHILE Z,BEGIN             LOOP WRITING RECORDS                         
         XPUSH R0,R1                                                            
         L     R1,MNRNMSET                                                      
         ACALL MSEGNO              SEG SET NUMBER                               
         TSEG  '  '                                                             
         XPOP  R0,R1                                                            
         VCALL SEGFDSN             SEG NAME                                     
         TCR                                                                    
         LA    R15,CPRG16                                                       
         LA    R0,L'MNRDATA                                                     
         LA    R1,MNRDATA                                                       
         LA    R2,MNRNAME                                                       
         VCALL XGETNEXT            GET NEXT RECORD                              
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  MSEGLNO - SEG LINE NUMBER IN 10 BYTE FIELD, IE. '  4239.123'                 
*                                                                               
*  ON ENTRY:                                                                    
*       R1 - LINE NUMBER                                                        
*                                                                               
*  NOTE: IF ATTN, EXITS TO CVNEXT                                               
*                                                                               
*                                                                               
MSEGLNO  PROC  ,                                                                
*                                                                               
         LR    R3,R1                                                            
         TSEG  ' '                                                              
         LR    R0,R3                                                            
         VCALL CVEXNO                                                           
         TSEG  CPDOUB,9                                                         
         BNZ   CVNEXT              IF ATTN, OUT OF HERE                         
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  MSEGNO - SEG NUMBER IN 10 BYTE FIELD, IE. '     12340'                       
*                                                                               
*  ON ENTRY:                                                                    
*       R1 - NUMBER                                                             
*                                                                               
*  NOTE: IF ATTN, EXITS TO CVNEXT                                               
*                                                                               
*                                                                               
MSEGNO   PROC  ,                                                                
*                                                                               
         LR    R3,R1                                                            
         TNUM  (R3),10                                                          
         BNZ   CVNEXT              IF ATTN, OUT OF HERE                         
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  MSEGCPU - SEG CPU TIME IN 10 BYTE FIELD IE. '   123.321'                     
*                                                                               
*  ON ENTRY:                                                                    
*       R1 - CPU TIME IN TU'S                                                   
*                                                                               
*  NOTE: IF ATTN, EXITS TO CVNEXT                                               
*                                                                               
*                                                                               
MSEGCPU  PROC  ,                                                                
*                                                                               
* CODE COPIED FROM 'GETCHRG'1 IN ACCT, DIG IT !                                 
*                                                                               
         COMMENT                   CONVERT FROM TU'S TO VIRT SECS               
         LR    R15,R1                                                           
         VCALL CPUFIX              CONVERT TO VIRTURL TU'S                      
         CLEAR R14                                                              
         M     R14,=F'10'                                                       
         D     R14,=F'384'         1000 THS OF CPU SECONDS                      
         IF    (R14,GE,384/2),'INCR R15'  Round                                 
         LR    R1,R15                                                           
*                                                                               
         COMMENT                   WRITE LIKE LINE NUMBER NOW                   
         ACALL MSEGLNO                                                          
*                                                                               
         CLEAR R15                                                              
         PEND  ,                                                                
         EJECT                                                                  
         QLTORG                                                                 
         VLTORG                                                                 
         END   .                                                                
