MODE     TITLE 'WYLBUR''s SET/SHOW/CLEAR Commands'                              
*******************************************************************             
*                                                                 *             
*     WYLBUR/370 - Release VI - Class I - Stanford Proprietary    *             
*                                                                 *             
*******************************************************************             
         HIBAL                                                                  
*                                                                               
         SYSDEFN ,                 Define installation parms                    
         GBLB  &JOBAUTH            (See SYSDEFN)                                
*                                                                               
WYLMODE  CSECT                                                                  
MODE     IDENT 4072                10:30:07 03/12/04  (SLP)                     
         SPACE 2                                                                
         REGS  FSR,,,,,,,BR,(WAR,LSR),PAR,PBR,CPR,CVR,SPR,RAR                   
*                                                                               
         PUSH  DSECTS                                                           
USERCVT  RECORD 'USERCVT'                                                       
*                                                                               
         CVT   DSECT=YES                                                        
*                                                                               
         IHAASCB                                                                
*                                                                               
UCBDSECT DSECT                                                                  
         IEFUCBOB                                                               
*                                                                               
         COPY  RTNCODES                                                         
*                                                                               
SDSNBUF  DSECT                                                                  
         SDSNBUF                                                                
         SCATBUF                                                                
*                                                                               
KWR      RECORD 'KWR'                                                           
*                                                                               
         COPY  CONTROL                                                          
*                                                                               
PFCB     RECORD BEGIN                                                           
         COPY  PFCB                                                             
         END                                                                    
*                                                                               
JCB      RECORD BEGIN                                                           
         COPY  JCB                                                              
         END                                                                    
*                                                                               
         COPY   FFINFO                                                          
*                                                                               
VOLDSECT VOLUME DSECT=YES                                                       
VOLENTSZ EQU   *-VOLDSECT                                                       
         POP   DSECTS                                                           
         TITLE 'SET Command'                                                    
*box                                                                            
*                                                                               
*  SET -- SET command                                                           
*                                                                               
SET      XPROC  ,                                                               
*-                                                                              
*-       The following is for dual-scanner compatibility only!!!                
*-                                                                              
         SCPUSH ,                                                               
         SCAN ,                                                                 
         SCINFO ,                                                               
         OSCINIT (R1),(R0)         OLD SCANNER COMPATIBILTY                     
         SCPOP ,                                                                
*                                                                               
         IF    ((CPSACCT,Z),AND,^CPFEXEC),BEGIN                                 
         SCAN  SETPRTL                                                          
         SCANCHK                                                                
         END                                                                    
         ELSE  BEGIN                                                            
         SCAN  SETPRT                                                           
         SCANCHK                                                                
         END                                                                    
         B     CVNEXT              !!!                                          
         PEND                                                                   
         EJECT ,                                                                
SETNULL  PROC                                                                   
         ERROR 'Missing SET option.',,MISSSET                                   
         PEND                                                                   
*                                                                               
SETPLOG  PROC                                                                   
         VCALL NOOPTS                                                           
         IF    ^CPSFPERM,BEGIN                                                  
         LA    R2,5                                                             
         LOOP  BEGIN                                                            
         SET   CPSFPERM            Set permanent logon                          
         VCALL UPDCPSIB                                                         
         IF    Z,EXIT                                                           
         DECR  R2                                                               
         IF    (R2,NEG),EXIT                                                    
         END                                                                    
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SETNPLOG PROC                                                                   
         VCALL NOOPTS                                                           
         IF    CPSFPERM,BEGIN                                                   
         LA    R2,5                                                             
         LOOP  BEGIN                                                            
         CLEAR CPSFPERM            Clear permanent logon                        
         VCALL UPDCPSIB                                                         
         IF    Z,EXIT                                                           
         DECR  R2                                                               
         IF    (R2,NEG),EXIT                                                    
         END                                                                    
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SETTER   PROC                                                                   
         SCAN  ,                                                                
         SCANCHK                                                                
         IF    (R0,POS),'SCBKUP; VCALL SETTERM'  set terminal                   
*                                                                               
         IF    CPGFCPR,CVNEXT      Ignore if CPROMPT already set                
         CLEAR CPCPLEN             SET TERSE compat. (no CPROMPT)               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SETVER   PROC                                                                   
         IF    CPGFCPR,CVNEXT      Ignore if CPROMPT already set                
         MVC   CPCPLEN,=H'7'       SET VERBOSE compat.                          
         MVC   CPCPRMT,=C'Command'                                              
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SETLEN   PROC                                                                   
         STH   R0,CPLENGTH                                                      
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SETSING  PROC                                                                   
         CLEAR CPGFMULT            Clear multi-command mode                     
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SETMULT  PROC                                                                   
         SET   CPGFMULT            Set multi-command mode                       
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
DELTAX   PROC                                                                   
         IF    (R0,NP),'VCALL NOTVALID'    Must be pos                          
         ST    R0,CPDELTA          Store delta                                  
         B     CVNEXT              New command                                  
         PEND                                                                   
*                                                                               
SETVOL   PROC ,                                                                 
         SCAN ,                                                                 
         SCANCHK ,                                                              
         IF    (R0,Z),'CLEAR CPVOLUME; B CVNEXT'                                
         SCUPTOK R1                                                             
         MVC   CPVOLUME,@R1        Save volume name                             
         IF    (@R1,EQ,'CAT'),'CLEAR CPVOLUME'  (compatability)                 
         VCALL NOOPTS                                                           
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
SETLIB   PROC                                                                   
         MVC   CPDOUB,=CL8'LIB'                                                 
         SCAN                                                                   
         IF    (R0,NZ),BEGIN                                                    
         IF    (R0,GT,L'CPLIB),'VCALL NOTVALID'                                 
         SCUPTOK R1                                                             
         MVC   CPDOUB,@R1          Save                                         
         VCALL NOOPTS                                                           
         END                                                                    
         MVC   CPLIB,CPDOUB        Set library                                  
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
SETRETRN PROC ,                                                                 
         SET   CPFRDEXE            Set to use exec line no                      
         VCALL SCNEXFR                                                          
         CLEAR R5                                                               
         SCAN  CURRPRT1                                                         
         SCANCHK                                                                
         ST    R5,CPRETURN                                                      
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SETCURR  PROC                                                                   
         VCALL SCNEXFR             See if exec or active wanted                 
         CLEAR R5                  Use 0 as default set                         
         SCAN  CURRPRT1            Scan options                                 
         COMMENT                   Set * for active or exec                     
         IF    CPFRDEXE,BEGIN      if exec                                      
         ST    R5,CPEXLINE                                                      
         END                                                                    
         ELSE  BEGIN               else, must be active                         
         ST    R5,CPACLNO          Set current for active file                  
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
CURRTO   PROC                                                                   
         SCPUSH ,                                                               
         SCAN  ,                                                                
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
         SCPOP ,                                                                
         PEND                                                                   
*                                                                               
CURLINE  PROC                                                                   
         LR    R5,R0               current value                                
         PRETURN (R5)              Remember specified line no                   
         PEND                                                                   
*                                                                               
CURMIN   PROC                                                                   
         L     R5,=F'-1'           Set current to -1                            
         PRETURN (R5)              Remember specified line no                   
         PEND                                                                   
*                                                                               
SETEXEC  PROC                                                                   
         SCAN  SETEXPRT                                                         
         SCANCHK                                                                
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
         QLTORG                                                                 
         EJECT                                                                  
*                                                                               
ESCWA    RECORD BEGIN                                                           
ESCCH    DS    CL2                 1 CHAR W/1CHAR OVERFLOW                      
         END                                                                    
*                                                                               
SETESCAP PROC  ESCWA                                                            
         SCAN  ,                                                                
         SCANCHK                                                                
         SCDQUOTE ESCCH,L'ESCCH                                                 
         IF    (R0,Z),BEGIN                                                     
         CLEAR CPESCAPE                                                         
         ACALL SETIGNOR                                                         
         B     CVNEXT                                                           
         END                                                                    
         IF    (R0,NE,1),BEGIN                                                  
         VCALL NOTVALID                                                         
         END                                                                    
         IF    (@R1,LT,X'4A'),BEGIN                                             
         ERROR 'Supplied character is not valid for escape use',,INVESC         
         END                                                                    
         IF    ((CPSKIP,NE,0),AND,(CPSKIP,EQ,@R1)),BEGIN                        
         ERROR 'ESCAPE AND SKIP CHAR CAN''T BE THE SAME'                        
         END                                                                    
         MVC   CPESCAPE,ESCCH                                                   
         ACALL SETIGNOR                                                         
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SKIPWA   RECORD BEGIN                                                           
SKIPCH   DS    CL2                 1 CHAR W/1CHAR OVERFLOW                      
         END                                                                    
*                                                                               
SETSKIP  PROC  SKIPWA                                                           
         SCAN  ,                                                                
         SCANCHK                                                                
         SCDQUOTE SKIPCH,L'SKIPCH                                               
         IF    (R0,Z),BEGIN                                                     
         CLEAR CPSKIP                                                           
         ACALL SETIGNOR                                                         
         B     CVNEXT                                                           
         END                                                                    
         IF    (R0,NE,1),BEGIN                                                  
         VCALL NOTVALID                                                         
         END                                                                    
         IF    ((CPESCAPE,NE,0),AND,(CPESCAPE,EQ,@R1)),BEGIN                    
         ERROR 'ESCAPE AND SKIP CHAR CAN''T BE THE SAME'                        
         END                                                                    
         MVC   CPSKIP,SKIPCH                                                    
         ACALL SETIGNOR                                                         
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
SETRSCN  PROC                                                                   
         STH   R0,CPRSCNVL         Set rescan count                             
         ACALL SETIGNOR            NO RETURN                                    
         PEND                                                                   
*                                                                               
SETIGNOR PROC                                                                   
         SCAN  ,                                                                
         SCANCHK                                                                
         IF    (R0,Z),CVNEXT                                                    
         LOOP  BEGIN                                                            
         TSEG  (R1),(R0),B                                                      
         SCAN  ,                   More?                                        
         UNTIL (R0,Z),END                                                       
         SETMSG '-- IGNORED'                                                    
         B     CVNXTMSG                                                         
         PEND                                                                   
*                                                                               
SETORVYL PROC                                                                   
         IF    (CPCMNM,EQ,'N'),BEGIN  Set noorvyl...                            
         CLEAR CPORVYL             Clear subsystem name                         
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         SCAN  ,                                                                
         SCANCHK ,                                                              
         SCUPTOK R15                                                            
         IF    (R0,Z),BEGIN             Set to default...                       
         LA    R15,CVORVSSN        Our ORVYL                                    
         IF    CVFRLG,'LA R15,CVRLGSSN'  ...their ORVYL                         
         SETMSG (R15),8                                                         
         IF    (@R15,EQ,X'00'),BEGIN                                            
         TSEG  'No default ORVYL for',,B                                        
         ERROR CVWYLSSN                                                         
         END                                                                    
         END                                                                    
         IF    (R0,GT,8),'VCALL NOTVALID'                                       
*                                                                               
         IF    (@R15,NE,'ORVYL'),BEGIN                                          
         IF    (@R15,EQ,'TORVYL'),EXIT                                          
         IF    (@R15,EQ,'TEST'),EXIT                                            
         IF    (@R15,EQ,'NIZ'),EXIT                                             
         IF    ^CPSFSPR,'VCALL NOTVALID'   Can't set a funny name               
         END                                                                    
*                                                                               
         IF    ((@R15,EQ,CVMILSSN),OR,(@R15,EQ,CVWYLSSN)),BEGIN                 
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         MVC   CPORVYL,@R15        Set ORVYL subsystem name                     
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
STMODE   PROC                                                                   
         SCAN  STMODPRT      Scan for modes                                     
         SCANCHK                                                                
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
STRTRY   PROC                                                                   
         IF    CPSTCONS,EXIT       Console can't SET MODE RETRY                 
         SET   CPGFLG3.CPFCMDFX                                                 
         PEND                                                                   
*                                                                               
STWARN   PROC                                                                   
         MVC   CPWRNCNT,=H'30'     Set default                                  
         SCAN  WARNPRT                                                          
         SCANCHK                                                                
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STNOWA   PROC                                                                   
         CLEAR CPWRNCNT                                                         
         PEND                                                                   
*                                                                               
* integer max count for warn                                                    
*                                                                               
WARNPRT  SCKW  ,WRNNOINT,NULL                                                   
         SCKW  ,WRNINT,I,32767                                                  
         SCKW  ,WRNNOINT                                                        
*                                                                               
WRNNOINT PROC                                                                   
         CLEAR CPWRNCNT                                                         
         SCBKUP ,                                                               
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
WRNINT   PROC  ,                   IF NOT WARN = <INT>                          
         STH   R0,CPWRNCNT         SET NOWARN AND BACKUP SCAN                   
         LA    R15,4                                                            
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SET LOGMODE command.                                                         
*                                                                               
SETLMODE PROC                                                                   
         SCAN  LMODEPRT      Scan for vmodes                                    
         SCANCHK                                                                
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
STNOLPAT PROC                                                                   
         CLEAR   CVLGPATH                                                       
         PEND                                                                   
*                                                                               
STLPATH  PROC                                                                   
         SET     CVLGPATH                                                       
         PEND                                                                   
*-                                                                              
*-       SET LOGMODE options.                                                   
*-                                                                              
LMODEPRT SCKW  NOPATH,STNOLPAT                                                  
         SCKW  PATH,STLPATH                                                     
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SET VMODE command.                                                           
*                                                                               
SETVMODE PROC                                                                   
         SCAN  VMODEPRT      Scan for vmodes                                    
         SCANCHK                                                                
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
STNOSPI  PROC                                                                   
         SET   CPGFNOSPIEDIT                                                    
         PEND                                                                   
*                                                                               
STSPI    PROC                                                                   
         CLEAR CPGFNOSPIEDIT                                                    
         PEND                                                                   
*-                                                                              
*-       SET VMODE options.                                                     
*-                                                                              
VMODEPRT SCKW  NOSPIEDIT,STNOSPI                                                
         SCKW  SPIEDIT,STSPI                                                    
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETCPRMT -- SET CPROMPT Command.                                             
*                                                                               
SETCPR   PROC                                                                   
*                                                                               
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,Z),BEGIN        Reset to default...                          
         CLEAR CPCPLEN,CPCPRMT                                                  
         CLEAR CPGFCPR             No explicit CPROMPT now                      
         END                                                                    
*                                                                               
         ELSE  BEGIN               Set new CPROMPT...                           
         IF    ((@R1,NE,'"'),AND,(@R1,NE,'''')),BEGIN                           
         TSEG  (R1),(R0)                                                        
         ERROR ': Command prompt string not properly quoted.'                   
         END                                                                    
*                                                                               
         SCDQUOTE CPCPRMT,L'CPCPRMT                                             
         STH   R0,CPCPLEN          Save command prompt length                   
         SET   CPGFCPR             CPROMPT text set explicitly                  
         END                                                                    
*                                                                               
         VCALL NOOPTS              Don't allow trailing junk                    
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*        SET XDUMP                                                              
*                                                                               
SXDUMP   PROC                                                                   
*                                                                               
         COMMENT                   If bad option, give msg                      
         VCALL NOOPTS                                                           
         SET   CPFXDUMP                                                         
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       SET NOXDUMP                                                            
*-                                                                              
SNOXDUMP PROC                                                                   
*                                                                               
         COMMENT                   If bad option, give msg                      
         VCALL NOOPTS                                                           
         CLEAR CPFXDUMP                                                         
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       SET XQUIET                                                             
*-                                                                              
SXQUIET  PROC                                                                   
*                                                                               
         COMMENT                   If bad option, give msg                      
         VCALL NOOPTS                                                           
         SET   CPFXQT                                                           
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       SET NOXQUIET                                                           
*-                                                                              
SNOXQT   PROC                                                                   
*                                                                               
         COMMENT                   If bad option, give msg                      
         VCALL NOOPTS                                                           
         CLEAR CPFXQT                                                           
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETACCT -- SET ACCOUNT command.                                              
*             (Also, SET USER and SET GROUP commands.)                          
*                                                                               
SETACCT  PROC                                                                   
         VCALL EXIT12              LOCAL exit - Set local account               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*     SET PREFIX command enters at "SETPFX"                                     
*     SET operand of other commands enters at "SETPFXNS"                        
*                                                                               
*                                                                               
*                                                                               
SETPFX   PROC                                                                   
         MVC   CPCMNM,=C'PFX'      Indicate set prefix                          
         OI    CPLFLG2,CPFDSNMS    Null/no default on dsn ok                    
         SCPUSH ,                                                               
         SCAN  ,                                                                
         SCANCHK                                                                
         IF    (R0,Z),BEGIN        no prefix                                    
         CLEAR CPAFNAMEL,CPAHOSTL                                               
         B     CVNEXT                                                           
         END                                                                    
         SCPOP ,                                                                
         VCALL DOFNAME             Get the name                                 
         SCAN  NAMEPRT             Also scan for dsn options                    
         SCANCHK                                                                
         VCALL FNAMEFIN            Process all dsn options                      
         VCALL NRESOLVE            Resolve name for prefix                      
         ACALL SETPFXNS                                                         
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
*  SET PREFIX - internal version                                                
*                                                                               
*  NOTE:                                                                        
*  this 'internal' version of set prefix, presumes that the                     
*  file info dsect (ffinfo) is set up correctly.  (ie. that                     
*  an EXTOPEN, or EXTRNAME has taken place.                                     
*                                                                               
*  NOTE2:                                                                       
*  EXTRNAME will be name resolve call.                                          
*                                                                               
*                                                                               
SETPFXNS XPROC                                                                  
         XPUSH R15                 ,, IS THIS A YUCK OR WHAT                    
*                                                                               
*        IF    (CPCMNM,EQ,'PFX'),BEGIN  it's set prefix...                      
*        VCALL NOOPTS                                                           
*        END                                                                    
*                                                                               
         COMMENT                   GET NAME FROM FFINFO DSECT                   
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         IF    ((R6,NZ),AND,(FFRNAMEL,NE,0),AND,^FFFOLD),BEGIN                  
         MVC   CPAFNAMEL,FFRNAMEL                                               
         MVC   CPAFNAME,FFRNAME                                                 
         MVC   CPAHOSTL,FFHOSTL                                                 
         MVC   CPAHOST,FFHOST                                                   
         MVC   CPAFTYPE,FFTYPE                                                  
         IF    FFFSAM,'CLEAR CPAHOSTL'  NO HOST FOR SAMSON FILES                
         DROP  R6                                                               
         END                                                                    
*                                                                               
         ELSE  BEGIN               ** DEBUG ** OLD FILE NAME STUFF              
*                                                                               
         COMMENT                   SET NAME                                     
         LH    R0,DSNWANL          Dsname length                                
         CEIL  R0,L'CPAFNAME                                                    
         ST    R0,CPAFNAMEL                                                     
         LA    R1,DSNWADSN         Dsname                                       
         LR    R2,R0                                                            
         MOVE  R2,CPAFNAME,DSNWADSN                                             
*                                                                               
         COMMENT                   IF MEMBER ADD IT                             
         LA    R4,DSNWAMBR                                                      
         IF    ((@R4,NE,' '),AND,(@R4,NE,X'00')),BEGIN                          
         LA    R3,CPAFNAME                                                      
         A     R3,CPAFNAMEL                                                     
         MVI   @R3,C'('                                                         
         INCR  R3                                                               
         MVC   @R3(8),DSNWAMBR                                                  
         A     R3,=F'8'                                                         
         DECR  R3                                                               
         WHILE (@R3,EQ,' '),BEGIN                                               
         DECR  R3                                                               
         END                                                                    
         INCR  R3                                                               
         MVI   @R3,C')'                                                         
         INCR  R3                                                               
         LA    R2,CPAFNAME                                                      
         SR    R3,R2                                                            
         ST    R3,CPAFNAMEL                                                     
         END                                                                    
*                                                                               
         COMMENT                   ADD HOST                                     
         LA    R2,DSNON                                                         
         LA    R3,DSNON                                                         
         A     R3,=A(L'DSNON)                                                   
         DECR  R3                                                               
         WHILE ((R3,GE,R2),AND,(@R3,EQ,' ')),BEGIN                              
         DECR  R3                                                               
         END                                                                    
         WHILE ((R3,GE,R2),AND,(@R3,EQ,X'00')),BEGIN                            
         DECR  R3                                                               
         END                                                                    
         INCR  R3                                                               
         SR    R3,R2                                                            
         ST    R3,CPAHOSTL                                                      
         MOVE  R3,CPAHOST,DSNON                                                 
*                                                                               
         COMMENT                   ADD TYPE                                     
         COMMENT  FFTYPE SET IN EXT FOR ANY AND ALL TYPES                       
         CLEAR CPAFTYPE                                                         
         L     R6,CPFINFOP                                                      
         IF    (R6,NZ),BEGIN                                                    
         USING FFINFO,R6                                                        
         MVC   CPAFTYPE,FFTYPE                                                  
         DROP  R6                                                               
         END                                                                    
         IF    (CPAFTYPE,Z),BEGIN  FORCE TYPE IF NO FFINFO                      
         MVI   CPAFTYPE,L'FFFOLD   (IE. FORCE TYPE FOR OLD SAVE)                
         END                                                                    
*                                                                               
         COMMENT                   UNSET VOL IF CATALOG VOL                     
         IF    ((CPCMNM,NE,'PFX'),AND,(DSNON6,EQ,DSNCATV)),BEGIN                
         CLEAR CPAHOSTL                                                         
         END                                                                    
         END                                                                    
*-                                                                              
*-       Zap generic "Text from ORVYL" Active file title if                     
*-         the prefix has changed.  See Dick Guertin for an                     
*-         explanation of why this is a good idea.  9/91, Niz                   
*-                                                                              
         IF    (CPATITL,EQ,'Text from ORVYL'),'CLEAR CPATITL'                   
*                                                                               
         SET   CPFSETP             This command set the prefix                  
         XPOP  R15                                                              
         PEND                                                                   
         EJECT                                                                  
         AIF   (NOT &JOBAUTH).AUTH1A                                            
SETAUTH  PROC                                                                   
         SCAN  AUTHPRT                                                          
         SCANCHK                                                                
         NI    CPGFLG4,255-CPFAUSET  indicate auth field unset                  
         B     CVNEXT              Get next command                             
         PEND                                                                   
*                                                                               
GOTACCT  PROC                                                                   
         SCUPTOK R1                                                             
         IF    ((R0,LT,6),OR,(R0,GT,8)),BEGIN                                   
         VCALL NOTVALID                                                         
         END                                                                    
         IF    (@R1+3,NE,'$'),'VCALL NOTVALID'                                  
         LR    R4,R1               Save ptr to account                          
         LR    R5,R13              Pt to kwr space                              
         LA    R13,(KWRSIZE+3)/4*4(,R13)  get space                             
         USING KWR,R5                                                           
         CLEAR KWR                 Init kwr                                     
         MVC   KWRGRP,@R1+4        Move in group                                
         MVC   KWRUSER,@R1         And user                                     
         LR    R1,R5               And pt to kwr for chkkw                      
         CLEAR R0                  Standard options                             
         VCALL CHKKW               Find out if he knows kwd                     
         MVC   CPAUTHUS,@R4        Move in user field                           
         MVC   CPAUTHGP,@R4+4      And group                                    
         OI    CPGFLG4,CPFAUSET    Authority set                                
         DROP  KWR                                                              
         B     CVNEXT              Get another commnad                          
         PEND                                                                   
.AUTH1A  ANOP                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWVOL -- SET WVOLUMES command.                                             
*                                                                               
SETWVOL  PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'   Naugty naugty                        
*                                                                               
         XPUSH ,,L'CVVOL,PTR=R6                                                 
         CLEAR (@R6,L'CVVOL)                                                    
         LR    R5,R6                                                            
         CLEAR R4                                                               
*                                                                               
         LOOP  BEGIN                                                            
         SCAN  ,                                                                
         SCANCHK                                                                
         SCUPTOK R1                                                             
         IF    (R0,Z),BEGIN                                                     
         IF    (R4,Z),CVABSENT     Nothing                                      
         MVC   CVVOL,@R6           Set volumes                                  
         STH   R4,CVVOLMAX         No. of volumes                               
         CLEAR CVVOLCUR            Last volume used                             
         INCR  R15,CVCHKUC         Time for checkpoint I/O                      
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         IF    (R4,GE,CVVOL#),BEGIN                                             
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid; too many volumes'                                    
         END                                                                    
*                                                                               
         MVC   @R5(6),@R1          Volume name                                  
         LA    R5,@R5+6                                                         
         LA    R4,@R4+1                                                         
         END                                                                    
*                                                                               
         PEND                                                                   
         SPACE 2                                                                
         QLTORG                                                                 
         TITLE 'SCKW''s'                                                        
*box                                                                            
*                                                                               
*  SET command options...                                                       
*                                                                               
SETPRT   SCKW  ,SETNULL,NULL                                                    
         SCKW  VALUE,V(OLDSETV),A                                               
         SCKW  TERSE,SETTER,A                                                   
         SCKW  VERBOSE,SETVER,A                                                 
         SCKW  LENGTH,SETLEN,(A,P,PI),&LINESZ                                   
         SCKW  DELTA,DELTAX,(P,LN,A)                                            
         SCKW  TABS,V(SETTABS),A                                                
         SCKW  MASTER,V(SETMAST),A                                              
         SCKW  PASSWORD,V(SETPASS),A                                            
         SCKW  KEYWORD,V(SETPASS),A                                             
         SCKW  SMF,V(SETSMF),S                                                  
         SCKW  NOSMF,V(SETSMF),S                                                
         SCKW  VOLUME,SETVOL,A                                                  
         SCKW  AUTO,V(SETAUTO),A                                                
         SCKW  MSTATUS,V(SETMST),A                                              
         SCKW  MAIL,V(SETMAIL),(A,S)                                            
         SCKW  NOMAIL,V(SETMAIL),(A,S)                                          
         SCKW  XMAIL,V(SETXMAIL),(A,S)                                          
         SCKW  NOXMAIL,V(SETXMAIL),(A,S)                                        
         SCKW  ACTIVE,V(SETACT),(A,S)                                           
         SCKW  PREFIX,SETPFX,A                                                  
         SCKW  FDEFAULT,V(SETFDEF),A                                            
         SCKW  FPATH,V(SETFPAT),A                                               
         SCKW  FNOTIMEOUT,SETFNTMO,A                                            
         SCKW  FTIMEOUT,SETFTMO,A                                               
         SCKW  NAME,V(SETNAME),A                                                
         SCKW  ACCOUNT,SETACCT,(A,S)                                            
         SCKW  GROUP,SETACCT,(A,S)                                              
         SCKW  GRP,SETACCT,S                                                    
         SCKW  USER,SETACCT,(A,S)                                               
         SCKW  USR,SETACCT,S                                                    
         SCKW  PACCOUNT,V(SETPACCT),(A,S)                                       
         SCKW  PACCT,V(SETPACCT),(A,S)                                          
         SCKW  LIBRARY,SETLIB,A                                                 
         SCKW  SAMSON,V(SETSAM),A                                               
         SCKW  SUBGR,V(CMDFIN),A                                                
         SCKW  SUBGROUP,V(SETPROJ),(A,S)                                        
         SCKW  SUBGRP,V(SETPROJ),S                                              
         SCKW  MODES,STMODE,A                                                   
         SCKW  VMODE,SETVMODE,A                                                 
         SCKW  CURRENT,SETCURR,A                                                
         SCKW  *,SETCURR                                                        
         SCKW  RETURN,SETRETRN,A                                                
         SCKW  EXECUTE,SETEXEC,A                                                
         SCKW  ESCAPE,SETESCAP,A                                                
         SCKW  SKIP,SETSKIP,A                                                   
         SCKW  RESCAN,SETRSCN,(A,P,I),100                                       
         SCKW  ORVYL,SETORVYL,(A,S)                                             
         SCKW  NOORVYL,SETORVYL,(A,S)                                           
         SCKW  LINE,V(SETLINE),(A,S)                                            
         SCKW  HISTORY,V(SETHIST),(A,S,P,PI),9999                               
         SCKW  JES,V(SETJES)                                                    
         SCKW  TAPE,V(TAPE),A                                                   
         SCKW  PRO,SETPRO                                                       
         SCKW  PROJECT,V(SETPROJ),(A,S)                                         
         SCKW  WPROJECT,V(SETWPROJ),(A,S)                                       
         SCKW  WAPP,V(SETWAPP),(A,S)                                            
         SCKW  SPROTECT,V(PROTECT),A      (Old: Stanford security)              
         SCKW  LOGON,V(SETLOGON),S                                              
         SCKW  PLOGON,SETPLOG,A                                                 
         SCKW  NOPLOGON,SETNPLOG,A                                              
         SCKW  VSESSIONS,V(SETVSES),(A,S)                                       
         SCKW  VOPTIONS,V(SETVOPT),(A,S)                                        
         AIF   (NOT &JOBAUTH).AUTH2A                                            
         SCKW  AUTHORITY,SETAUTH,A                                              
.AUTH2A  ANOP                                                                   
         SCKW  COST,V(SETCOST),(A,S)                                            
         SCKW  JOB,V(SETJOB)                                                    
         SCKW  OUTPUT,V(SETOUT),A                                               
         SCKW  WCHARGE,V(SETWCH),A                                              
         SCKW  WCOUNT,V(SETWCTR),(A,S)                                          
         SCKW  WCINIT,V(SETWCIN),S                                              
         SCKW  WDEBUG,V(SETDEBUG),A                                             
         SCKW  HOST,V(SETHOST),(A,S)                                            
         SCKW  QUERY,V(SETQUERY),(A,S)                                          
         SCKW  OPERATOR,V(SETOPER),(A,S)                                        
         SCKW  NOOPERATOR,V(SETOPER),(A,S)                                      
         SCKW  PRIV,V(SETPRIV),(A,S)                                            
         SCKW  NOPRIV,V(SETPRIV),(A,S)                                          
         SCKW  WORD,SETWORD,A                                                   
         SCKW  MSG,SETMSG,S                                                     
         SCKW  MESSAGE,SETMSG,(A,S)                                             
         SCKW  AME,V(CMDFIN)                                                    
         SCKW  AMSG,SETMSG,S                                                    
         SCKW  AMESSAGE,SETMSG,(A,S)                                            
         SCKW  UME,V(CMDFIN)                                                    
         SCKW  UMSG,SETMSG,S                                                    
         SCKW  UMESSAGE,SETMSG,(A,S)                                            
         SCKW  VME,V(CMDFIN)                                                    
         SCKW  VMSG,SETMSG,S                                                    
         SCKW  VMESSAGE,SETMSG,(A,S)                                            
         SCKW  CPROMPT,SETCPR,A                                                 
         SCKW  XDUMP,SXDUMP,A                                                   
         SCKW  NOXDUMP,SNOXDUMP,A                                               
         SCKW  XQUIET,SXQUIET,A                                                 
         SCKW  NOXQUIET,SNOXQT,A                                                
         SCKW  WNETWORK,V(SETWNET),(A,S)                                        
         SCKW  WVOLUMES,SETWVOL,(A,S)                                           
         SCKW  WBACKUP,SETWBKUP,(A,S)                                           
         SCKW  WNOBACKUP,CLRWBKUP,(A,S)                                         
         SCKW  WNEWS,V(SETWNEWS),(A,S)                                          
         SCKW  WHELP,V(SETWHELP),(A,S)                                          
         SCKW  WHOSTS,V(SETWHOST),(A,S)                                         
         SCKW  WTERMINALS,V(SETWTERM),(A,S)                                     
         SCKW  WPRINTERS,V(SETWPRT),(A,S)                                       
         SCKW  WDICTIONARY,V(SETWDICT),(A,S)                                    
         SCKW  WMACHINE,SETWMACH,A                                              
         SCKW  WFACTOR,SETWFACT,(A,P,LN)                                        
         SCKW  WFDEF,SETWFDEF,S                                                 
         SCKW  WFPATH,SETWFPAT,S                                                
         SCKW  CHRISTA,V(SETCHR)                                                
         SCKW  CHRISUID,V(SETCHRU)                                              
         SCKW  WPAGES,SETWPGS,A                                                 
         SCKW  WRELOAD,SETWREL,(A,S)                                            
         SCKW  WNORELOAD,SETWREL,(A,S)                                          
         SCKW  LOGMODE,SETLMODE,S                                               
         SCKW  WTRACE,SETWTRC,S                                                 
         SCKW  WNOTRACE,SETWTRC,S                                               
         SCKW  WROTATE,SETWROT,S                                                
         SCKW  WNOROTATE,SETWROT,S                                              
         SCKW  RACF,SETRACF,S                                                   
         SCKW  NORACF,SETRACF,S                                                 
         SCKW  WNOTASK,SETWTASK,S                                               
         SCKW  WTASK,SETWTASK,S                                                 
         SCKW  WSLICE,SETWSL,(A,P,PI),9999999                                   
*-                                                                              
*-       Set commands after here are allowed even if the user isn't             
*-         logged on.                                                           
*-                                                                              
SETPRTL  SCKW  ,SETNULL,NULL                                                    
         SCKW  TERMINAL,V(SETTERM),A                                            
         SCKW  LPRINTER,V(SETLPR),A                                             
         SCKW  VIEW,V(SETVIEW),A                                                
         SCKW  IDLES,V(SETMIL),(A,S)                                            
         SCKW  NOIDLES,V(SETMIL),(A,S)                                          
         SCKW  WIDTH,V(SETMIL),A                                                
         SCKW  HEIGHT,V(SETMIL),A                                               
         SCKW  NOHEIGHT,V(SETMIL),A                                             
         SCKW  BACK,V(SETMIL),A                                                 
         SCKW  NOBACK,V(SETMIL),A                                               
         SCKW  BREAK,V(SETMIL),A                                                
         SCKW  NOBREAK,V(SETMIL),A                                              
         SCKW  CASE,V(SETMIL),A                                                 
         SCKW  UPPER,V(SETMIL),A                                                
         SCKW  UPLOW,V(SETMIL),A                                                
         SCKW  APL,V(SETMIL)                                                    
         SCKW  APLB,V(SETMIL)                                                   
         SCKW  NOAPL,V(SETMIL)                                                  
         SCKW  NOAPLB,V(SETMIL)                                                 
         SCKW  COMM,V(SETMIL),A                                                 
         SCKW  NOCOMM,V(SETMIL),A                                               
         SCKW  SLOWLIST,V(SETMIL),A                                             
         SCKW  FASTLIST,V(SETMIL),A                                             
         SCKW  NOTIME,V(SETNOTM),A                                              
         SCKW  TIMEOUT,V(SCNNOOP),A  ** Ignored -- compatiblity **              
         SCKW  XON,V(SETMIL)                                                    
         SCKW  NOXON,V(SETMIL),A                                                
         SCKW  PSPECIAL,V(SETMIL)                                               
         SCKW  NOPSPEC,V(SETMIL)                                                
         SCKW  RI,V(SETMIL)                                                     
         SCKW  TI,V(SETMIL)                                                     
         SCKW  ,V(CMDFIN)                                                       
         EJECT                                                                  
*                                                                               
* for set current                                                               
*                                                                               
CURRPRT1 SCKW  EXECUTE,V(SCNNOOP),A                                             
         SCKW  ACTIVE,V(SCNNOOP),A                                              
         SCKW  TO,CURRTO                                                        
         SCKW  ,CURLINE,SYMLN                                                   
         SCKW  -,CURMIN,(P,LN)                                                  
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
CURRPRT2 SCKW  ,CURLINE,SYMLN                                                   
         SCKW  -,CURMIN,(P,LN)                                                  
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
* for set exec                                                                  
*                                                                               
SETEXPRT SCKW  ,V(STEXEPSH),PUSH                                                
         SCKW  AUTH,SETXAUTH                                                    
         SCKW  NOAUTH,SETNAUTH                                                  
         SCKW  OVERHEAD,SETOVER,A                                               
         SCKW  NOOVERHEAD,SETNOVER,A                                            
         SCKW  SECURE,SETSEC,A                                                  
         SCKW  NOSECURE,SETNOSEC,A                                              
         SCKW  LOCKED,SETSLOCK,A                                                
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SETOVER  PROC                                                                   
         SET   CPFXOVER            (Ignored unless CPFXAUTH on also)            
         PEND                                                                   
*                                                                               
SETNOVER PROC                                                                   
         CLEAR CPFXOVER            (Ignored unless CPFXAUTH on also)            
         PEND                                                                   
*                                                                               
SETXAUTH PROC                                                                   
         IF    ^CPFXAUTHLIB,EXIT   Not coming from authorized lib               
         SET   CPFXAUTH                                                         
         PEND                                                                   
*                                                                               
SETNAUTH PROC                                                                   
         IF    ^CPFXAUTHLIB,EXIT   Not coming from authorized lib               
         CLEAR CPFXAUTH                                                         
         PEND                                                                   
*                                                                               
SETSEC   PROC                                                                   
         SET   CPFSEC                                                           
         PEND                                                                   
*                                                                               
SETNOSEC PROC                                                                   
         IF    CPFSLOCK,EXIT                                                    
         CLEAR CPFSEC                                                           
         PEND                                                                   
*                                                                               
SETSLOCK PROC                                                                   
         SET   CPFSEC+CPFSLOCK                                                  
         PEND                                                                   
         AIF   (NOT &JOBAUTH).AUTH3A                                            
*-                                                                              
*-       For SET AUTH.                                                          
*-                                                                              
AUTHPRT  SCKW  FOR,GOTACCT,P                                                    
         SCKW  ACCOUNT,GOTACCT,(A,P)                                            
         SCKW  ,GOTACCT                                                         
.AUTH3A  ANOP                                                                   
*                                                                               
NAMEPRT  SCKW  ,V(FNAMPSH),PUSH                                                 
KEYWDPRT SCKW  KEYWORD,V(SCNNOOP),A                                             
         SCKW  PASSWORD,V(SCNNOOP),A                                            
         SCKW  ,V(NOTVALID)                                                     
*-                                                                              
*-       For set mode.                                                          
*-                                                                              
STMODPRT SCKW  RETRY,STRTRY,A                                                   
         OPTION NORETRY,CLEAR,A,CPGFLG3.CPFCMDFX                                
         OPTION MODIFY,CLEAR,A,CPGFLG3.CPFCMDED                                 
         OPTION EDIT,SET,A,CPGFLG3.CPFCMDED                                     
         OPTION SHORT,SET,A,CPGFLG3.CPF3IMED                                    
         OPTION NOSHORT,CLEAR,A,CPGFLG3.CPF3IMED                                
         OPTION LIST,CLEAR,A,CPGFNLST                                           
         OPTION NOLIST,SET,A,CPGFNLST                                           
         OPTION CLEAR,SET,A,CPGFCLR                                             
         OPTION CLR,SET,,CPGFCLR                                                
         OPTION NOCLEAR,CLEAR,A,CPGFCLR                                         
         OPTION NOCLR,CLEAR,,CPGFCLR                                            
         OPTION ATTN,CLEAR,A,CPGFNATN                                           
         OPTION NOATTN,SET,A,CPGFNATN                                           
         SCKW  WARN,STWARN,A                                                    
         SCKW  NOWARN,STNOWA,A                                                  
         SCKW  ,V(NOTVALID)                                                     
         EJECT                                                                  
*-                                                                              
*-       SET PRO is ambiguous.                                                  
*-                                                                              
SETPRO   PROC                                                                   
         TSEG  'PRO is ambiguous.  Specify PROT for PROTECT or '                
         SETMSG 'PROJ for PROJECT.'                                             
         B     CVABTMSG                                                         
         PEND                                                                   
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'CLEAR Command'                                                  
*box                                                                            
*                                                                               
*  CLEAR -- CLEAR command.                                                      
*                                                                               
CLEAR    XPROC                                                                  
*-                                                                              
*-       The following is for dual-scanner compatibility only!!!                
*-                                                                              
         SCPUSH ,                                                               
         SCAN ,                                                                 
         SCINFO ,                                                               
         OSCINIT (R1),(R0)         OLD SCANNER COMPATIBILTY                     
         SCPOP ,                                                                
*                                                                               
         SCAN  CLEARPRT                                                         
         SCANCHK ,                                                              
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
         QLTORG                                                                 
         EJECT                                                                  
***                                                                             
***  CLEAR Commands.                                                            
***                                                                             
CLEARPRT SCKW  ,CLRNULL,NULL                                                    
         SCKW  ACTIVE,CACT,A                                                    
         SCKW  ACTIVES,CACTS                                                    
         SCKW  ACTS,CACTS                                                       
         SCKW  TEXT,CACT,A                                                      
         SCKW  EXECUTE,CEXEC,A                                                  
         SCKW  TABS,CTABS,A                                                     
         SCKW  PREFIX,CPREF,A                                                   
         SCKW  NAME,CPREF,A        (Compatibility)                              
         SCKW  VARIABLES,CVARS,A                                                
         SCKW  VARS,CVARS,A                                                     
         SCKW  VALUES,CVARS,A                                                   
         SCKW  DEFINED,CDEF,A                                                   
         SCKW  HISTORY,CHIST,A                                                  
         SCKW  XD,CXDEBUG,A                                                     
         SCKW  XDEBUG,CXDEBUG,A                                                 
         SCKW  XMONITOR,CXMON,A                                                 
         SCKW  XDUMP,CXDUMP,A                                                   
         SCKW  XQUIET,CXQUIET,A                                                 
         SCKW  ERROR,CERROR,A                                                   
         SCKW  ATTN,CATTN,A                                                     
         SCKW  ATTENTION,CATTN,A                                                
         SCKW  GETSTACK,CGETSTK,A                                               
         SCKW  HOSTS,V(CLRHOSTS),A                                              
         SCKW  FTPLOG,V(CLRFTP),A                                               
         SCKW  DEVICES,CDEV,A                                                   
         SCKW  LEARNED,CLEARN,A                                                 
         SCKW  SCREEN,CSCREEN,A                                                 
         SCKW  SCRN,CSCREEN                                                     
         SCKW  WD,CWDEBUG,A                                                     
         SCKW  WDEBUG,CWDEBUG,A                                                 
         SCKW  ,CUNREC                                                          
         EJECT                                                                  
*                                                                               
*                                                                               
CLRNULL  PROC                                                                   
         ERROR 'Missing CLEAR option.',,MISSCLR                                 
         PEND                                                                   
*                                                                               
CUNREC   PROC  ,                   Unrecognized CLEAR option                    
         VCALL CMDFIN              Pass command on to others                    
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR SCREEN                                                           
*-                                                                              
CSCREEN  PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR SCREEN option.'                                 
         END                                                                    
*-                                                                              
*-       Model terminal clear screen sequence.                                  
*-                                                                              
         SETMSG X'27ADF2D127AD86'   Clear screen sequence                       
*-                                                                              
*-       IF the front-end can not handle a model terminal clear                 
*-         screen sequence then we have to do the terminal dependent            
*-         stuff ourselves.                                                     
*-                                                                              
         IF    CPSFDUMB,BEGIN      Dumb front-end...                            
         IF    (CPSTCLS,EQ,'VT'),EXIT  VT100                                    
         IF    (CPSTCLS,EQ,'SAM'),EXIT  SAMSON                                  
*                                                                               
         IF    (CPSTCLS,EQ,'TEK4023'),'SETMSG X"270C"'  ESC Ctrl-L              
         ELSEIF (CPSTCLS,EQ,'Z19'),'SETMSG X"2745"'  ESC E                      
         ELSEIF (CPSTCLS,EQ,'TVI'),'SETMSG X"3F"'  Ctrl-Z                       
         ELSEIF (CPSTCLS,EQ,'ADM'),'SETMSG X"0C"'  Ctrl-L                       
         ELSEIF (CPSTCLS,EQ,'RLG'),'SETMSG X"0C"'  Ctrl-L                       
         ELSE  'SETMSG X"151515"'     Triple space                              
         END                                                                    
*                                                                               
         TSEG  (R1),(R0)           Clear the screen                             
         TMARK ,                   (Don't add NL)                               
*                                                                               
         IF    CPVFPAGE,BEGIN      Page mode...                                 
         SET   CPFDISP             Make it a display mode write                 
         TWRITE                                                                 
*                                                                               
         CLEAR CPFDISP,CPVFPAGE    Reset page mode                              
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR ACTIVE                                                           
*-                                                                              
CACTWA   RECORD BEGIN                                                           
CACTFLAG FLAG                                                                   
         FLAG  CACTFEXE            - Compatability: CLEAR ACT EXEC              
         FLAG  CACTFVAR            - Compatability: CLEAR ACT VARS              
         END                                                                    
*-                                                                              
CACT     PROC  CACTWA                                                           
         LA    R6,CACTWA                                                        
         USING CACTWA,R6                                                        
         CLEAR CACTWA                                                           
*                                                                               
         SCAN  CACTPRT                                                          
         SCANCHK                                                                
*                                                                               
         IF    (CPALNCT,NZ),BEGIN  Active file...                               
         SET   CPFCLEAR            Set clear ok                                 
         VCALL CLRTEXT             Clear                                        
         END                                                                    
*                                                                               
         ELSE  BEGIN               Otherwise...                                 
         CLEAR CPAFNAMEL,CPAHOSTL  Clear prefix (safety)                        
         MVC   CPERRID,=CL8'NOACTIVE'                                           
         IF    CPFTYPED,BEGIN      Answer if typed...                           
         TSEG  'No ACTIVE file.',,CR                                            
         END                                                                    
         END                                                                    
*-                                                                              
*-       Check for other things to clear for compatability.                     
*-                                                                              
         IF    CACTFVAR,'VCALL CLRVARS'  Do CLEAR VARS                          
*                                                                               
         IF    CACTFEXE,'ACALL CEXECSUB'  Do CLEAR EXEC                         
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
***                                                                             
***  CLEAR ACTIVE Options.                                                      
***                                                                             
CACTPRT  OPTION WARN,CLEAR,A,CPFNWARN                                           
         OPTION NOWARN,SET,A,CPFNWARN                                           
         OPTION EXECUTE,SET,A,CACTFEXE                                          
         OPTION VARIABLES,SET,A,CACTFVAR                                        
         OPTION VARS,SET,A,CACTFVAR                                             
         OPTION VALUES,SET,A,CACTFVAR                                           
         SCKW  PREFIX,V(SCNNOOP),A                                              
         SCKW  NAME,V(SCNNOOP),A             (Compatability)                    
         SCKW  ,CACTERR                                                         
*                                                                               
CACTERR  PROC                                                                   
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid CLEAR ACTIVE option.'                                 
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
CACTSWA  RECORD BEGIN                                                           
CACTSFL  FLAG                                                                   
         FLAG  CACTSFR                                                          
         END                                                                    
         SPACE 2                                                                
*-                                                                              
*-       CLEAR ACTIVES                                                          
*-                                                                              
CACTS    PROC  CACTSWA                                                          
         LA    R6,CACTSWA                                                       
         USING CACTSWA,R6                                                       
         CLEAR CACTSWA                                                          
*                                                                               
         SCAN  CACTSPRT                                                         
         SCANCHK                                                                
*-                                                                              
*-       RESET means zap the entire record group.                               
*-                                                                              
         IF    CACTSFR,BEGIN       Reset...                                     
         VCALL ACTRESET            Blow 'em away                                
         B     CVNEXT                                                           
         END                                                                    
*-                                                                              
*-       Regular CLEAR ACTIVES just marks Actives as cleared.                   
*-                                                                              
         SET   CPFCLEAR            OK to clear the unchanged Actives            
         VCALL CLRACTS             Clear Actives                                
         B     CVNEXT                                                           
         PEND                                                                   
***                                                                             
***  CLEAR ACTIVES Options.                                                     
***                                                                             
CACTSPRT OPTION WARN,CLEAR,A,CPFNWARN                                           
         OPTION NOWARN,SET,A,CPFNWARN                                           
         OPTION RESET,SET,A,CACTSFR                                             
         SCKW  ,CACTSERR                                                        
*                                                                               
CACTSERR PROC                                                                   
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid CLEAR ACTIVES option.'                                
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
CEXECWA  RECORD BEGIN                                                           
CEXEFLAG FLAG                                                                   
         FLAG  CEXEFACT            - Compatability: CLEAR EXEC ACT              
         FLAG  CEXEFVAR            - Compatability: CLEAR EXEC VARS             
         END                                                                    
         SPACE 2                                                                
*-                                                                              
*-       CLEAR EXEC                                                             
*-                                                                              
CEXEC    PROC  CEXECWA                                                          
         LA    R6,CEXECWA                                                       
         USING CEXECWA,R6                                                       
         CLEAR CEXECWA                                                          
*                                                                               
         SCAN  CEXECPRT                                                         
         SCANCHK                                                                
*                                                                               
         ACALL CEXECSUB            Do CLEAR EXEC                                
*-                                                                              
*-       Check for other stuff to clear for compatability.                      
*-                                                                              
         IF    CEXEFVAR,'VCALL CLRVARS'  Do a CLEAR VARS                        
*                                                                               
         IF    CEXEFACT,'ACALL CACT'     Do a CLEAR ACTIVE                      
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
***                                                                             
***  CLEAR EXEC Options.                                                        
***                                                                             
CEXECPRT OPTION ACTIVE,SET,A,CEXEFACT                                           
         OPTION VARIABLES,SET,A,CEXEFVAR                                        
         OPTION VARS,SET,,CEXEFVAR                                              
         OPTION VALUES,SET,A,CEXEFVAR                                           
         SCKW  PREFIX,V(SCNNOOP),A                                              
         SCKW  NAME,V(SCNNOOP),A             (Compatability)                    
         SCKW  ,CEXECERR                                                        
*                                                                               
CEXECERR PROC                                                                   
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR EXEC option.'                                   
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  CEXECSUB -- Routine to do CLEAR EXEC.                                        
*                                                                               
CEXECSUB PROC                                                                   
         VCALL CHKXOLD                                                          
         IF    NZ,BEGIN                                                         
         VCALL CLREX               Clear the exec file                          
         VCALL SETPAUSE                                                         
         END                                                                    
         ELSE  BEGIN                                                            
         MVC   CPERRID,=CL8'NOEXEC'                                             
         IF    CPFTYPED,BEGIN                                                   
         TSEG  'No EXEC file.',,CR                                              
         END                                                                    
         END                                                                    
         PEND                                                                   
         EJECT                                                                  
         QLTORG                                                                 
         EJECT                                                                  
*-                                                                              
*-       CLEAR TABS                                                             
*-                                                                              
CTABS    PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR TABS option.'                                   
         END                                                                    
*                                                                               
         LOOP  BEGIN                                                            
         CLEAR CPSTABS             Clear tabs                                   
         VCALL UPDCPSIB                                                         
         UNTIL Z                                                                
         END                                                                    
*                                                                               
         VCALL PAGETABS            Update page tabs                             
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
CPREFWA  RECORD BEGIN                                                           
CPFXFLAG FLAG                                                                   
         FLAG  CPFXFACT            - Compatability: CLEAR PFX ACT               
         FLAG  CPFXFEXE            - Compatability: CLEAR PFX EXEC              
         FLAG  CPFXFVAR            - Compatability: CLEAR PFX VARS              
         END                                                                    
         SPACE 2                                                                
*-                                                                              
*-       CLEAR PREFIX                                                           
*-                                                                              
CPREF    PROC  CPREFWA                                                          
         LA    R6,CPREFWA                                                       
         USING CPREFWA,R6                                                       
         CLEAR CPREFWA                                                          
*                                                                               
         SCAN  CPFXPRT                                                          
         SCANCHK                                                                
*                                                                               
         CLEAR CPAFNAMEL,CPAHOSTL  Clear prefix                                 
         MVC   CPACCTSV,CPSACCT                                                 
*-                                                                              
*-       Check other stuff to clear for compatability.                          
*-                                                                              
         IF    CPFXFVAR,'VCALL CLRVARS'  Do a CLEAR VARS                        
*                                                                               
         IF    CPFXFEXE,'ACALL CEXECSUB'  Do a CLEAR EXEC                       
*                                                                               
         IF    CPFXFACT,'ACALL CACT'  Do a CLEAR ACTIVE                         
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
***                                                                             
***  CLEAR PREFIX Options.                                                      
***                                                                             
CPFXPRT  OPTION ACTIVE,SET,A,CPFXFACT                                           
         OPTION EXECUTE,SET,A,CPFXFEXE                                          
         OPTION VARIABLES,SET,A,CPFXFVAR                                        
         OPTION VARS,SET,,CPFXFVAR                                              
         OPTION VALUES,SET,A,CPFXFVAR                                           
         SCKW  ,CPFXERR                                                         
*                                                                               
CPFXERR  PROC                                                                   
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR PREFIX option.'                                 
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
CVARSWA  RECORD BEGIN                                                           
CVARFLAG FLAG                                                                   
         FLAG  CVARFACT            - Compatability: CLEAR VARS ACT              
         FLAG  CVARFEXE            - Compatability: CLEAR VARS EXEC             
         END                                                                    
         SPACE 2                                                                
*-                                                                              
*-       CLEAR VARIABLES                                                        
*-                                                                              
CVARS    PROC  CVARSWA                                                          
         LA    R6,CVARSWA                                                       
         USING CVARSWA,R6                                                       
         CLEAR CVARSWA                                                          
*                                                                               
         SCAN  CVARSPRT                                                         
         SCANCHK                                                                
*                                                                               
         VCALL CLRVARS             Clear variables                              
*-                                                                              
*-       Check for other things to clear for compatability.                     
*-                                                                              
         IF    CVARFACT,BEGIN      Do CLEAR ACTIVE...                           
         SET   CPFCLEAR                                                         
         VCALL CLRTEXT                                                          
         END                                                                    
*                                                                               
         IF    CVARFEXE,'ACALL CEXECSUB'  Do CLEAR EXEC                         
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
***                                                                             
***  CLEAR VARS Options.                                                        
***                                                                             
CVARSPRT OPTION ACTIVE,SET,A,CVARFACT                                           
         OPTION EXECUTE,SET,A,CVARFEXE                                          
         SCKW  PREFIX,V(SCNNOOP),A                                              
         SCKW  NAME,V(SCNNOOP),A             (Compatability)                    
         SCKW  ,CVARERR                                                         
*                                                                               
CVARERR  PROC                                                                   
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR VARIABLES option.'                              
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
         QLTORG                                                                 
         EJECT                                                                  
*-                                                                              
*-       CLEAR DEFINES                                                          
*-                                                                              
CDEF     PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR DEFINES option.'                                
         END                                                                    
*                                                                               
         VCALL CLRDEF              CLEAR DEFINES                                
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR LEARNED                                                          
*-                                                                              
CLEARN   PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR LEARNED option.'                                
         END                                                                    
*                                                                               
         VCALL CLRLRN              Clear learned                                
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR HISTORY                                                          
*-                                                                              
CHIST    PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR HISTORY option.'                                
         END                                                                    
*                                                                               
         VCALL CLRHCMDS            Clear history                                
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR XDEBUG                                                           
*-                                                                              
CXDEBUG  PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         TSEG  ': invalid CLEAR XDEBUG option.'                                 
         END                                                                    
*                                                                               
         COMMENT                   Clear XDEBUG                                 
         VCALL DBCLEAR                                                          
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR XMONITOR                                                         
*-                                                                              
CXMON    PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         TSEG  ': invalid CLEAR XMONITOR option.'                               
         END                                                                    
*                                                                               
         COMMENT                   Clear monitor memory, records                
         VCALL MCLEAR                                                           
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR XDUMP                                                            
*-                                                                              
CXDUMP   PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid. ',,SYNTAX                                            
         END                                                                    
         CLEAR CPFXDUMP                                                         
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR XQUIET                                                           
*-                                                                              
CXQUIET  PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid. ',,SYNTAX                                            
         END                                                                    
         CLEAR CPFXQT                                                           
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR ERROR                                                            
*-                                                                              
CERROR   PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR ERROR option.'                                  
         END                                                                    
*                                                                               
         COMMENT                   Clear user error variables                   
         VCALL CLRERROR                                                         
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*                                                                               
*  CLEAR ATTENTION                                                              
*                                                                               
*                                                                               
*                                                                               
CATTN    PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR ATTN option.'                                   
         END                                                                    
*                                                                               
         COMMENT                   Clear user attn variables                    
         VCALL CLRATTN                                                          
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR DEVICES                                                          
*-                                                                              
CDEV     PROC                                                                   
         ERROR 'Devices: invalid clear option.'                                 
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR DEVICES option.'                                
         END                                                                    
*                                                                               
*        VCALL CLRDEV              Clear devices                                
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR WDEBUG                                                           
*-                                                                              
CWDEBUG  PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR WDEBUG option.'                                 
         END                                                                    
*                                                                               
         VCALL CLRDEBUG            Clear debug                                  
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*-                                                                              
*-       CLEAR GETSTACK                                                         
*-                                                                              
CGETSTK  PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         TSEG  (R1),(R0)                                                        
         ABORT ': invalid CLEAR GETSTACK option.'                               
         END                                                                    
*                                                                               
         CLEAR CPGETLN                                                          
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'SHOW OPTIONS Command'                                           
*box                                                                            
*                                                                               
*  SHOWOPTS -- SHOW OPTIONS command.                                            
*                                                                               
SHOWOPTS PROC  KWR                                                              
         LA    R5,KWR              Kwr ptr                                      
         USING KWR,R5                                                           
         CLEAR KWR                                                              
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         SCAN  OPTPRT                                                           
         SCANCHK                                                                
*                                                                               
         MVC   KWRGRP,CPCGRP                                                    
         MVC   KWRUSER,CPCUSER                                                  
         LH    R0,=H'-1'           Prompt for kw (allow acct privs)             
         LA    R1,KWR                                                           
         VCALL GETKWR              Read kwr, etc.                               
*                                                                               
         TSEG  CPCGRP,2                                                         
         TSEG  '.'                                                              
         TSEG  CPCUSER,,B                                                       
*                                                                               
         IF    (KWRNAME,NZ),BEGIN                                               
         TSEG  '"'                                                              
         TSEG  KWRNAME,,T                                                       
         TSEG  '"',,B                                                           
         END                                                                    
*                                                                               
         TSEG  'Options:'                                                       
         TCR                                                                    
         TCR                                                                    
*                                                                               
         TSEG  'Permanent Options:',,CR                                         
*                                                                               
         TSEG  CVBLANKS,2                                                       
         LA    R1,KWR                                                           
         VCALL AUTODISP            Auto signon options                          
*                                                                               
         TSEG  CVBLANKS,2                                                       
         LA    R1,KWR                                                           
         VCALL JOBDISP             Job options                                  
*                                                                               
         TSEG  CVBLANKS,2                                                       
         LA    R1,KWR                                                           
         VCALL OUTDISP             Output options                               
         IF    (CPSACCT,NE,KWRUSER),'CLEAR KWR; B CVNEXT'                       
         CLEAR KWR                                                              
         SPACE 2                                                                
         TCR                                                                    
         VCALL TERMDISP            Terminal options                             
         SPACE 2                                                                
         TCR                                                                    
         TSEG  'Session Options:',,CR                                           
*                                                                               
         TSEG  '  ACCOUNT='                                                     
         TSEG  CPGRPSV                                                          
         TSEG  '.'                                                              
         TSEG  CPUSERSV                                                         
         IF    CPGFLG3.CPFKWENT,'TSEG " (Password)"'                            
*                                                                               
         CLEAR R0                                                               
         IF    (CPVOLUME,NZ),BEGIN                                              
         TSEG  ', VOLUME='                                                      
         SETMSG CPVOLUME                                                        
         VCALL LRTRIM                                                           
         END                                                                    
         TSEG  (R1),(R0)                                                        
         TSEG  ', LENGTH='                                                      
         TNUM  LH:CPLENGTH                                                      
         TSEG  ', DELTA='                                                       
         L     R0,CPDELTA                                                       
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0),CR                                                     
*                                                                               
         TSEG  '  LIBRARY='                                                     
         SETMSG CPLIB                                                           
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0)                                                        
         IF    (CPAFNAMEL,EQ,0),'TSEG ", NO PREFIX"'                            
         ELSE  BEGIN                                                            
         TSEG  ', PREFIX='                                                      
         COMMENT                   FILE NAME                                    
         SETMSG CPAFNAME,L:CPAFNAMEL                                            
         VCALL RETFNAME                                                         
         TSEG  (R1),(R0)                                                        
         COMMENT                   #MEMBER NAME, IF ANY                         
         SETMSG CPAFNAME,L:CPAFNAMEL                                            
         VCALL RETFMEM                                                          
         IF    (R0,POS),BEGIN                                                   
         XPUSH R0,R1                                                            
         TSEG  '#'                                                              
         XPOP  R0,R1                                                            
         TSEG  (R1),(R0)                                                        
         END                                                                    
         COMMENT                   ON HOST, IF ANY                              
         IF    (CPAHOSTL,NE,0),BEGIN                                            
         TSEG  ' on '                                                           
         TSEG  CPAHOST,L:CPAHOSTL                                               
         END                                                                    
         END                                                                    
         TWRITE                                                                 
         BNZ   CVABORT                                                          
*                                                                               
         TSEG  CVBLANKS,2                                                       
         ACALL MODEDISP            Modes                                        
*                                                                               
         TSEG  CVBLANKS,2                                                       
         VCALL JESDISP             Jes options                                  
*                                                                               
         TSEG  CVBLANKS,2                                                       
         VCALL JESDISP2            Put out job numbers                          
         TSEG  CVBLANKS,2          Indent                                       
         VCALL EXECDISP            Exec options                                 
*                                                                               
         TSEG  CVBLANKS,2                                                       
         IF    (CPESCAPE,Z),'SETMSG "NO ESCAPE CHAR"'                           
         ELSE  'TSEG "ESCAPE="; SETMSG CPESCAPE'                                
         TSEG  (R1),(R0)                                                        
         IF    (CPSKIP,Z),'SETMSG ", NO SKIP CHAR"'                             
         ELSE  'TSEG ", SKIP="; SETMSG CPSKIP'                                  
         TSEG  (R1),(R0)                                                        
         TSEG  ', RESCAN='                                                      
         BTD   CPDOUB,0,LH:CPRSCNVL                                             
         TSEG  (R1),(R0),WR                                                     
         BNZ   CVABORT                                                          
*                                                                               
         TSEG  CVBLANKS,2                                                       
         VCALL LPRDISP                                                          
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         DROP  KWR                                                              
         SPACE 2                                                                
OPTPRT   SCKW  ,V(ACCTPSHC),PUSH                                                
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW MODE Command'                                              
*box                                                                            
*                                                                               
*  SHOMODE -- SHOW MODE command.                                                
*  MODEDISP -- Subroutine (called by "SHOW OPTIONS").                           
*                                                                               
SHOMODE  PROC                                                                   
         VCALL COLLOPTS       Allow collect options                             
         ACALL MODEDISP                                                         
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
MODEDISP PROC                                                                   
         IF    ^CPGFLG3.CPFCMDFX,'TSEG "NO"'                                    
         TSEG  'RETRY '                                                         
*                                                                               
         SETMSG 'MODIFY'                                                        
         IF    CPGFLG3.CPFCMDED,'SETMSG "EDIT"'                                 
         TSEG  (R1),(R0),B                                                      
*                                                                               
         IF    CPGFNLST,'TSEG "NO"'                                             
         TSEG  'LIST '                                                          
*                                                                               
         IF    ^CPGFCLR,'TSEG "NO"'                                             
         TSEG  'CLEAR '                                                         
*                                                                               
         IF    ^CPGFLG3.CPF3IMED,'TSEG "NO"'                                    
         TSEG  'SHORT '                                                         
*                                                                               
         IF    CPGFNATN,'TSEG "NO"'                                             
         TSEG  'ATTN '                                                          
*                                                                               
         IF    (CPWRNCNT,Z),'SETMSG "NOWARN"'                                   
         ELSE  BEGIN                                                            
         TSEG  'WARN='                                                          
         BTD   CPDOUB,0,LH:CPWRNCNT                                             
         END                                                                    
         TSEG  (R1),(R0),B                                                      
         TSEG  '(CHANGES='                                                      
         BTD   CPDOUB,0,L:CPACHCT                                               
         TSEG  (R1),(R0)                                                        
         TSEG  ') '                                                             
*                                                                               
         TSEG  '- MODES',,WR                                                    
         BNZ   CVABORT                                                          
         PEND                                                                   
         TITLE 'SHOW LOGMODE Command'                                           
*box                                                                            
*                                                                               
*  SHOLMODE -- SHOW LOGMODE command.                                            
*                                                                               
SHOLMODE PROC                                                                   
         VCALL COLLOPTS       Allow collect options                             
         IF    ^CVLOGMOD.CVLGPATH,'TSEG "NO"'                                   
         TSEG  'PATH '                                                          
*                                                                               
         TCR                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
         TITLE 'SHOW VMODE Command'                                             
*box                                                                            
*                                                                               
*  SHOVMODE -- SHOW VMODE command.                                              
*                                                                               
SHOVMODE PROC                                                                   
         VCALL COLLOPTS       Allow collect options                             
*                                                                               
         IF    CPGFNOSPIEDIT,'TSEG "NO"'                                        
         TSEG  'SPIEDIT'                                                        
*                                                                               
         SETMSG ' - Orvyl modes'                                                
         B     CVNXTMSG                                                         
         PEND                                                                   
         TITLE 'SHOW and DUMP Commands'                                         
*box                                                                            
*                                                                               
*                                                                               
*                                                                               
*  show/dump -- entries for the show and dump commands.                         
*                                                                               
*                                                                               
*                                                                               
*                                                                               
DUMP     XPROC                                                                  
         IF    ((CPCMNM,EQ,'$'),AND,(R0,LT,4)),'VCALL CMDFIN'  ($du)            
         MVI   CPDMPLST,X'80'      Lineno not yet set                           
         MVC   CPACLNO,=F'-1000'   No current lineno                            
         SET   CPFDUMP             Turn on the stow flag                        
         IF    (CPCMNM,EQ,'$'),'VCALL JESCMD'  $dump is special                 
         MVC   CPCMNM,=C'SHO'      Make it a show command!                      
         ACALL SHOW                                                             
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
*        SHOW                                                                   
*                                                                               
*                                                                               
SHOW     XPROC                                                                  
*-                                                                              
*-       The following is for dual-scanner compatibility only!!!                
*-                                                                              
         SCPUSH ,                                                               
         SCAN ,                                                                 
         SCINFO ,                                                               
         OSCINIT (R1),(R0)         OLD SCANNER COMPATIBILTY                     
         SCPOP ,                                                                
*                                                                               
         COMMENT                   SCAN EXEC/ACTIVE OPTION                      
         VCALL SCNEX                                                            
*                                                                               
         COMMENT                   SCAN FOR TOKEN AFTER 'SHOW'                  
         IF    ((CPSACCT,Z),AND,^CPFEXEC),BEGIN                                 
         SCAN  SHOWPRTL                                                         
         SCANCHK                                                                
         END                                                                    
         ELSE  BEGIN                                                            
         SCAN  SHOWPRT                                                          
         SCANCHK                                                                
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT ,                                                                
MISSSHOW PROC                                                                   
         IF    CPFDUMP,BEGIN                                                    
         ERROR 'Missing DUMP/SHOW option.',,SYNTAX                              
         END                                                                    
         ELSE  BEGIN                                                            
         ERROR 'Missing SHOW option.',,SYNTAX                                   
         END                                                                    
         PEND                                                                   
         EJECT                                                                  
*                                                                               
*  SHOW - LINE NUMBER/ SYMBOLIC LINE NUMBER                                     
*                                                                               
*                                                                               
SHOWLNO  PROC                                                                   
*                                                                               
         COMMENT                   PRINT LINE NUMBER                            
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0),B                                                      
*                                                                               
         COMMENT                   NOW PRINT WHAT TYPE ...                      
         SCPUSH                                                                 
         SCBKUP                                                                 
         SCAN  SHOWLPRT                                                         
         IF    (R15,NE,4),BEGIN                                                 
         TSEG  '- LINE NUMBER'                                                  
         END                                                                    
*                                                                               
         VCALL COLLOPTS                                                         
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
*                                                                               
SHOWLPRT SCKW  ,SHOWLLNO,NULL                                                   
         SCKW  PREVIOUS,SHOWLPRE,A                                              
         SCKW  CURRENT,SHOWLCUR,A                                               
         SCKW  *,SHOWLCUR                                                       
         SCKW  NEXT,SHOWLNEX,A                                                  
         SCKW  LAST,SHOWLLAS,A                                                  
         SCKW  L,SHOWLLAS,A                                                     
         SCKW  FIRST,SHOWLFIR,A                                                 
         SCKW  F,SHOWLFIR,A                                                     
         SCKW  END,SHOWLEND,A                                                   
         SCKW  ,SHOWLLNO                                                        
*                                                                               
SHOWLPRE PROC                                                                   
         TSEG  '- PREVIOUS'                                                     
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
SHOWLCUR PROC                                                                   
         TSEG  '- CURRENT'                                                      
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
SHOWLNEX PROC                                                                   
         TSEG  '- NEXT'                                                         
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
SHOWLLAS PROC                                                                   
         TSEG  '- LAST'                                                         
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
SHOWLFIR PROC                                                                   
         TSEG  '- FIRST'                                                        
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
SHOWLEND PROC                                                                   
         TSEG  '- PEND  ,'                                                      
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
SHOWLLNO PROC                                                                   
         TSEG  '- LINE NUMBER'                                                  
         LA    R15,4                                                            
         PEND                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
SHODELTA PROC                                                                   
         VCALL COLLOPTS                                                         
         L     R0,CPDELTA                                                       
         VCALL CVEXNO              Convert                                      
         TSEG  (R1),(R0),B                                                      
         TSEG  '- DELTA'                                                        
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
INSTALN  PROC                                                                   
         VCALL COLLOPTS                                                         
         TSEG  CVINSTAL,,TB                                                     
         TSEG  '- INSTALLATION'                                                 
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         AIF   (NOT &JOBAUTH).AUTH4A                                            
SHOAUTH  PROC                                                                   
         VCALL COLLOPTS                                                         
         TM    CPGFLG4,CPFAUSET    Authority field set?                         
         IF    NO,BEGIN            Yes, go list it                              
         TSEG  'NO AUTHORITY SET' Otherwise tell him its not se                 
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  CPAUTHGP                                                         
         TSEG  '.'                                                              
         TSEG  CPAUTHUS                                                         
         TSEG  '- AUTHORITY'                                                    
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
.AUTH4A  ANOP                                                                   
*                                                                               
SHOLEN   PROC                                                                   
         VCALL COLLOPTS                                                         
         LH    R0,CPLENGTH                                                      
         IF    (R0,GT,&LINESZ),BEGIN                                            
         TSEG  'NO LENGTH'                                                      
         END                                                                    
         ELSE  BEGIN                                                            
         TNUM  LH:CPLENGTH                                                      
         TSEG  ' - LENGTH'                                                      
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
VOLSHOW  PROC                                                                   
         VCALL COLLOPTS                                                         
         IF    (CPVOLUME,Z),BEGIN                                               
         TSEG  'NO VOLUME'                                                      
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  CPVOLUME,,B                                                      
         TSEG  '- VOLUME'                                                       
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SHOWORV  PROC                                                                   
         VCALL COLLOPTS                                                         
         IF    (CPORVYL,Z),BEGIN                                                
         TSEG  'ORVYL access is blocked.'                                       
         END                                                                    
         ELSE  BEGIN                                                            
         SETMSG CPORVYL                                                         
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),B                                                      
         TSEG  'access is allowed.'                                             
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SHOESCAP PROC                                                                   
         VCALL COLLOPTS                                                         
         IF    (CPESCAPE,Z),BEGIN                                               
         TSEG  'No escape character.'                                           
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  CPESCAPE,,B                                                      
         TSEG  '- escape character.'                                            
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SHOSKIP  PROC                                                                   
         VCALL COLLOPTS                                                         
         IF    (CPSKIP,Z),BEGIN                                                 
         TSEG  'No skip character.'                                             
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  CPSKIP                                                           
         TSEG  ' - skip character.'                                             
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SHORSCN  PROC                                                                   
         TNUM  LH:CPRSCNVL                                                      
         TSEG  ' - rescan count'                                                
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SHOWCPR  PROC                                                                   
         VCALL COLLOPTS                                                         
         TSEG  '"'                                                              
         TSEG  CPCPRMT,LH:CPCPLEN                                               
         TSEG  '" is the command prompt string.'                                
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
***                                                                             
***  SHOW Commands.                                                             
***                                                                             
SHOWPRT  SCKW  ,MISSSHOW,NULL                                                   
         SCKW  OPTIONS,SHOWOPTS,(A,S)                                           
         SCKW  GETSTACK,SHOWGETS,A                                              
         SCKW  ACTIVE,V(SHOWACT),(A,S)                                          
         SCKW  ACTIVES,V(SHOWACTS),(A,S)                                        
         SCKW  ACTS,V(SHOWACTS),S                                               
         SCKW  AINFO,V(SHOWAINF),(A,S)                                          
         SCKW  LENGTH,SHOLEN,A                                                  
         SCKW  DSNAMES,V(SHODSN),(A,S)                                          
         SCKW  AUTO,V(SHOWAUTO),A                                               
         SCKW  MSTATUS,V(SHOWMST),A                                             
         SCKW  DIRECTORY,V(SHOWDIR),(A,S)                                       
         SCKW  VOLUME,VOLSHOW,A                                                 
         SCKW  NAME,V(SHOWNAME),(A,S)                                           
         SCKW  ANAME,V(SHOWNAME),(A,S)                                          
         SCKW  PREFIX,SHOWPREF,(A,S)                                            
         SCKW  FDEFAULT,V(SHOWFDEF),A                                           
         SCKW  FPATH,V(SHOWFPAT),A                                              
         SCKW  GROUP,SHOWACCT,(A,S)                                             
         SCKW  GRP,SHOWACCT,(A,S)                                               
         SCKW  USER,SHOWACCT,(A,S)                                              
         SCKW  USR,SHOWACCT,(A,S)                                               
         SCKW  _USERS,V(SHOWUSRS)                                               
         SCKW  HOST,V(SHOWHOST),(A,S)                                           
         SCKW  HOSTS,V(SHOWHSTS),(A,S)                                          
         SCKW  QUERY,V(SHOWQRY),(A,S)                                           
         SCKW  FTPLOG,V(SHOWFTP),(A,S)                                          
         SCKW  LINS,V(SHOWLINE),(A,S)                                           
         SCKW  LINES,V(SHOWLINE),(A,S)                                          
         SCKW  VLINES,V(SHOWLINE),(A,S)                                         
         SCKW  _LINES,V(SHOWILIN),S                                             
         SCKW  VIRTUAL,V(SHOWNET),(A,S)                                         
         SCKW  LIBRARY,SHOWLIB,(A,S)                                            
         SCKW  SIZE,V(SHOSIZ),A                                                 
         SCKW  CATALOG,V(SHOWCAT),(A,S)                                         
         SCKW  CATLG,V(SHOWCAT),(A,S)                                           
         SCKW  SPACE,V(SHOWSPCE),(A,S)                                          
         SCKW  TRACKS,V(SHOWTRKS),(A,S)                                         
         SCKW  VOLUMES,SHOWVOLS                                                 
         SCKW  VOLS,SHOWVOLS                                                    
         SCKW  NEWS,V(SHOWNEWS),A                                               
         SCKW  MAIL,V(SHOWMAIL),A                                               
         SCKW  EXECUTE,V(SHOWEXEC),A                                            
         SCKW  XLOAD,V(SHXLOAD),A                                               
         SCKW  PUB,V(CMDFIN)                                                    
         SCKW  PUBLOAD,V(SHPBLOAD),A                                            
         SCKW  MASTER,V(SHOWMAST),A                                             
         SCKW  SMF,V(SHOWSMF)                                                   
         SCKW  LTIME,V(SHOWLTIM),(A,S)                                          
         SCKW  PTIME,V(SHOWKTIM),(A,S)                                          
         SCKW  KTIME,V(SHOWKTIM),(A,S)                                          
         SCKW  OPERATOR,V(SHOWLINE),(A,S)                                       
         SCKW  PRIV,V(SHOWPRIV),(A,S)                                           
         SCKW  ACCOUNT,SHOWACCT,A                                               
         SCKW  SUBGR,V(CMDFIN),A                                                
         SCKW  SUBGROUP,V(SHOWPROJ),A                                           
         SCKW  SUBGRP,V(SHOWPROJ)                                               
         SCKW  SAMSON,V(SHOWSAM),A                                              
         SCKW  VAR,V(SHOWVAL),A                                                 
         SCKW  VALUE,V(SHOWVAL),A                                               
         SCKW  VALS,V(SHOWVARS)                                                 
         SCKW  VARS,V(SHOWVARS)                                                 
         SCKW  VARIABLES,V(SHOWVARS)                                            
         SCKW  ARRAY,V(SHOWARRY),A                                              
         SCKW  DEFINED,V(SHOWDEF),A                                             
         SCKW  LEARNED,V(SHOWLRN),A                                             
         SCKW  ESCAPE,SHOESCAP,A                                                
         SCKW  SKIP,SHOSKIP,A                                                   
         SCKW  RESCAN,SHORSCN,A                                                 
         SCKW  DELTA,SHODELTA,A                                                 
         SCKW  MODES,SHOMODE,A                                                  
         SCKW  VMODE,SHOVMODE,A                                                 
         SCKW  HISTORY,V(SHOWHIST),A                                            
         SCKW  JES,V(SHOWJES),A                                                 
         SCKW  JOB,V(SHOWJOB)                                                   
         SCKW  OUTPUT,V(SHOWOUT),A                                              
         SCKW  XD,V(DSHOW),A                                                    
         SCKW  XDEBUG,V(DSHOW)                                                  
         SCKW  XMONITOR,V(SHOWMON),(A,S)                                        
         SCKW  VSESSIONS,V(SHOWVSES),(A,S)                                      
         SCKW  VOPTIONS,V(SHOWVOPT),(A,S)                                       
         SCKW  WCHARGE,V(SHOWWCH),(A,S)                                         
         SCKW  WCOUNT,V(SHOWWCTR),(A,S)                                         
         SCKW  WCINIT,V(SHOWWCIN),S                                             
         SCKW  WDEBUG,V(SHOWDBUG),A                                             
         AIF   (NOT &JOBAUTH).AUTH5A                                            
         SCKW  AUTHORITY,SHOAUTH,A                                              
.AUTH5A  ANOP                                                                   
         SCKW  TAPE,V(TAPE),A                                                   
         SCKW  ORVYL,SHOWORV,A                                                  
         SCKW  PRO,V(CMDFIN)                                                    
         SCKW  PROJECT,V(SHOWPROJ),A                                            
****     SCKW  PROTECT,V(PROTECT),A       (--REMOVE ME--)                       
         SCKW  SPROTECT,V(PROTECT),A      (Old: Stanford security)              
         SCKW  WPROJECT,V(SHOWWPRJ),A                                           
         SCKW  INSTALLATION,INSTALN,A                                           
         SCKW  CPROMPT,SHOWCPR,A                                                
         SCKW  WORD,SHOWWORD,A                                                  
         SCKW  WVOLUMES,SHOWWVOL,(A,S)                                          
         SCKW  WVERSION,V(SHOWVERS),(A,S)                                       
         SCKW  MVERSION,V(SHOWMVER),(A,S)                                       
         SCKW  WLINE,V(SHOWWLIN),(A,S)                                          
         SCKW  WLINES,V(SHOWWLNS),(A,S)                                         
         SCKW  WSYMBOLS,V(SHOWSYM),(A,S)                                        
         SCKW  WJCBS,V(SHOWJCB),(A,S)                                           
         SCKW  WMONITOR,V(SHOWWMON),(A,S)                                       
         SCKW  LOGMODE,SHOLMODE,S                                               
         SCKW  WLOG,V(SHOWWLOG),(A,S)                                           
         SCKW  WMACHINE,SHOWWMAC,(A,S)                                          
         SCKW  WFACTOR,SHOWWFAC,(A,S)                                           
         SCKW  WFDEF,SHOWWFD,S                                                  
         SCKW  WFPATH,SHOWWFPA,S                                                
         SCKW  CHRISTA,V(SHOWCHR),S                                             
         SCKW  WBUFFER,SHOWWBUF,(A,S)                                           
         SCKW  WPAGES,SHOWWPGS,(A,S)                                            
         SCKW  WYLP,SHOWWYLP,S                                                  
         SCKW  WYLPAGES,SHOWWYLP,S                                              
         SCKW  WSLICE,SHOWWSL,(A,S)                                             
         SCKW  WLRA,SHOWWLRA,(A,S)                                              
         SCKW  IO,V(JESCMD),A                                                   
         SCKW  STATUS,V(JESCMD),A                                               
         SCKW  DISPLAY,V(JESCMD),A                                              
         SCKW  BLOCK,V(JESCMD)                                                  
         SCKW  JVERSION,V(JESCMD),A                                             
         SCKW  QUEUE,V(JESCMD),A1                                               
*-                                                                              
*-       SHOW commands after here are allowed even if the user isn't            
*-       logged on.                                                             
*-                                                                              
SHOWPRTL SCKW  ,MISSSHOW,NULL                                                   
         SCKW  TERMINAL,V(SHOWTERM),(A,S)                                       
         SCKW  LPRINTER,V(SHOWLPR),(A,S)                                        
         SCKW  VIEW,V(SHOWVIEW),(A,S)                                           
         SCKW  IDLES,V(SHOWIDLE),(A,S)                                          
         SCKW  TIME,V(SHOWTIME),(A,S)                                           
         SCKW  COUNT,V(SHOWCNT),(A,S)                                           
         SCKW  INFO,SHOWINFO,(A,S)                                              
         SCKW  MINFO,V(SHOWMINF),(A,S)                                          
         SCKW  WINFO,SHOWWINF,(A,S)                                             
         SCKW  KINFO,V(SHOWKINF),(A,S)                                          
         SCKW  WMAIL,SHOWWMAI,(A,S)                                             
         SCKW  WCAPTURE,SHOWWCAP,(A,S)                                          
         SCKW  TABS,V(SHOWTABS),A                                               
         SCKW  COLUMNS,SHOWCOLS,A                                               
         SCKW  COLS,SHOWCOLS                                                    
         SCKW  DATE,SHOWDATE,(A,S)                                              
         SCKW  XDATE,SHOWDATE,(A,S)                                             
         SCKW  WIDTH,V(SHOWMIL),(A,S)                                           
         SCKW  HEIGHT,V(SHOWMIL),(A,S)                                          
         SCKW  MDEVICE,V(SHOWMDEV),(A,S)                                        
         SCKW  WPATHS,V(SHOWWPAT),(A,S)                                         
         SCKW  WNETWORK,V(SHOWWNET),(A,S)                                       
         SCKW  SYSTEMS,V(SHOWSYS),(A,S)                                         
         SCKW  BACK,V(SHOWMIL),(A,S)                                            
         SCKW  BREAK,V(SHOWMIL),(A,S)                                           
         SCKW  CASE,V(SHOWCASE),A                                               
         SCKW  UPPER,V(SHOWCASE),A                                              
         SCKW  UPLOW,V(SHOWCASE),A                                              
         SCKW  COMM,V(SHOWMIL),(A,S)                                            
         SCKW  SLOWLIST,V(SHOWMIL),(A,S)                                        
         SCKW  FASTLIST,V(SHOWMIL),(A,S)                                        
         SCKW  NOTIME,V(SHOWNOTM),(A,S)                                         
         SCKW  XON,V(SHOWMIL),S                                                 
         SCKW  NOXON,V(SHOWMIL),(A,S)                                           
         SCKW  RI,V(SHOWMIL),S                                                  
         SCKW  TI,V(SHOWMIL),S                                                  
         SCKW  CHARGES,V(SHOWCHAR),(A,S)                                        
         SCKW  COST,V(SHOWCOST),(A,S)                                           
         SCKW  SCOST,V(SHOWSCOS),(A,S)                                          
         SCKW  SCOSTS,V(SHOWSCS),(A,S)                                          
         SCKW  IPLTIME,SHOWIPL,(A,S)                                            
         SCKW  MSG,SHOWMSG,S                                                    
         SCKW  MESSAGE,SHOWMSG,(A,S)                                            
         SCKW  AME,V(CMDFIN)                                                    
         SCKW  AMSG,SHOWMSG,S                                                   
         SCKW  AMESSAGE,SHOWMSG,(A,S)                                           
         SCKW  UME,V(CMDFIN)                                                    
         SCKW  UMSG,SHOWMSG,S                                                   
         SCKW  UMESSAGE,SHOWMSG,(A,S)                                           
         SCKW  VME,V(CMDFIN)                                                    
         SCKW  VMSG,SHOWMSG,S                                                   
         SCKW  VMESSAGE,SHOWMSG,(A,S)                                           
         SCKW  _NETWORK,V(SHOWNET),(A,S)                                        
         SCKW  _PORTS,V(SHOWPORT),(A,S)                                         
         SCKW  ,SHOWLNO,SYMLN                                                   
         SCKW  ,V(CMDFIN)                                                       
         TITLE 'SHOW Commands'                                                  
*box                                                                            
*                                                                               
*  SHOWACCT -- SHOW ACCOUNT command.                                            
*      (Also the entry for SHOW USER and SHOW GROUP.)                           
*                                                                               
SHOWACCT PROC                                                                   
*                                                                               
         VCALL EXIT13              LOCAL exit - Show local account              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWLIB -- SHOW LIBRARY command.                                             
*                                                                               
SHOWLIB  PROC                                                                   
         VCALL COLLOPTS                                                         
*                                                                               
         TSEG  CPLIB,,B                                                         
         SETMSG '- Library.'                                                    
         B     CVNXTMSG                                                         
*                                                                               
         PEND                                                                   
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SHOWPREF -- SHOW PREFIX command.                                             
*              (Also, SHOW MEMBER command.)                                     
*                                                                               
SHOWPREF PROC                                                                   
         VCALL COLLOPTS                                                         
*                                                                               
         IF    (CPAFNAMEL,EQ,0),'TSEG "NO PREFIX"'                              
         ELSE  BEGIN                                                            
         TSEG  'PREFIX='                                                        
         COMMENT                   FILE NAME                                    
         SETMSG CPAFNAME,L:CPAFNAMEL                                            
         VCALL RETFNAME                                                         
         TSEG  (R1),(R0)                                                        
         COMMENT                   #MEMBER NAME, IF ANY                         
         SETMSG CPAFNAME,L:CPAFNAMEL                                            
         VCALL RETFMEM                                                          
         IF    (R0,POS),BEGIN                                                   
         XPUSH R0,R1                                                            
         TSEG  '#'                                                              
         XPOP  R0,R1                                                            
         TSEG  (R1),(R0)                                                        
         END                                                                    
         COMMENT                   ON HOST, IF ANY                              
         IF    (CPAHOSTL,NZ),BEGIN                                              
         TSEG  ' on '                                                           
         TSEG  CPAHOST,L:CPAHOSTL                                               
         END                                                                    
         COMMENT                   IF NO HOST, TELL FILE TYPE                   
         IF    (CPAHOSTL,Z),BEGIN                                               
         IF    (CPAFTYPE,EQ,L'FFFSAM),BEGIN                                     
         TSEG  ' (samson)'                                                      
         END                                                                    
         IF    (CPAFTYPE,EQ,L'FFFNET),BEGIN                                     
         TSEG  ' (network)'                                                     
         END                                                                    
         END                                                                    
         END                                                                    
         TWRITE                                                                 
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW COLUMNS Command'                                           
*box                                                                            
*                                                                               
*  SHOWCOLS -- SHOW COLUMNS command.                                            
*                                                                               
SHOWCOLS PROC                                                                   
         CLEAR R3                  No. of columns to display (0=def)            
         CLEAR R4                  Default offset is zero                       
         SCAN  SHCOLPRT                                                         
         SCANCHK                                                                
         IF    CPFDUMP,BEGIN       Different defaults if dump...                
         IF    ^CPLFLG5.CPFFOPT,'SET CPLFLG5.CPFUNUM'  unnumbered               
         END                                                                    
         LR    R0,R3                                                            
         LR    R15,R4                                                           
         ACALL DOSHCOLS                                                         
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SHCOLPRT SCKW  ,SHNUM,PI,&LINESZ                                                
         SCKW  LENGTH,SHNUM,(A,P,PI),&LINESZ                                    
         SCKW  WIDTH,SHNUM,(A,P,PI),&LINESZ                                     
         SCKW  START,SHSTART,(A,P,PI),&LINESZ                                   
         SCKW  ,V(NUMPSH),PUSH                                                  
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SHNUM    PROC                                                                   
         IF    (R3,NZ),'VCALL NOTVALID'  already scanned                        
         LR    R3,R0                                                            
         PRETURN (R3)                                                           
         PEND                                                                   
*                                                                               
SHSTART  PROC                                                                   
         LR    R4,R0                                                            
         PRETURN (R4)                                                           
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  DOSHCOLS -- Routine to display columns.  Called by SET TABS and              
*    SHOW COLUMNS command.                                                      
*                                                                               
DOSHCOLS XPROC                                                                  
         IF    (R0,Z),'LA R0,150'  Universal default                            
*                                                                               
         LR    R3,R15              Starting (logical) offset                    
         IF    (R3,P),'DECR R3'    Rel to zero, not one                         
*                                                                               
         LPR   R6,R0                                                            
         CEIL  R6,&LINESZ          Keep it within bounds                        
*                                                                               
         IF    ^CPLFLG5.CPFUNUM,'TSEG CVBLANKS,11'                              
*                                                                               
         CLEAR R4                                                               
         LR    R5,R3                                                            
         D     R4,=F'10'           Tens count in r5, rem in r4                  
         IF    (R4,NZ),BEGIN                                                    
         LA    R0,9                                                             
         SR    R0,R4               No. of chars to seg                          
         CEIL  R0,R6               can't go over max                            
         SR    R6,R0                                                            
         LA    R1,=C'....v....'                                                 
         TSEG  @R1(R4),(R0)        Seg partial start                            
         IF    (R6,NP),CVNEXT                                                   
         DECR  R6                                                               
         B     DOSHCX              Join common code                             
         END                                                                    
*                                                                               
         WHILE (R6,POS),BEGIN                                                   
         LR    R0,R6                                                            
         CEIL  R0,9                                                             
         TSEG  LA:=C'....v....',(R0)                                            
         IF    ('S R6,=F"10"',NEG),EXIT                                         
DOSHCX   TSEG  COLSDISP(R5),1                                                   
         LA    R5,@R5+1            Kick tens counter                            
         END                                                                    
         TWRITE                                                                 
         PEND                                                                   
*                                                                               
COLSDISP DC    C'123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'                           
         DC    C'abcdefghijklmnopqrstuvwxyz'                                    
         DROP  BR                                                               
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW IPL Command'                                               
*box                                                                            
*                                                                               
*  SHOWIPL -- SHOW IPL Command.                                                 
*                                                                               
SHOWIPL  PROC                                                                   
         VCALL COLLOPTS       Allow collect options                             
*                                                                               
         L     R5,CVTPTR                                                        
         USING CVT,R5                                                           
         TSEG  'Last IPL',,B                                                    
         LT    R4,CVTUSER          SCIPCVT ptr                                  
         IF    NZ,BEGIN                                                         
         WITH  (USERCVT,R4)                                                     
         IF    (USERCVT,NE,'SCIP'),EXIT  Forget it                              
         L     R0,USEIPLTM         Ipl time (STCK format)                       
         IF    (R0,Z),EXIT         No ipl time, scram                           
         TSEG  'at '                                                            
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         LR    R3,R1                                                            
         LM    R0,R1,USEIPLTM                                                   
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0),B                                                      
         XPOP  ,,30                                                             
         END                                                                    
*-                                                                              
*-       Sysres volume info.                                                    
*-                                                                              
         L     R4,CVTSYSAD         Sysres UCB                                   
         USING UCBOB,R4                                                         
         TSEG  'from '                                                          
         TSEG  UCBVOLI,6,B         Seg volser                                   
         TSEG  '('                                                              
         L2    R15,UCBCHAN                                                      
         BTX   CPDOUB,0,(R15)                                                   
         TSEG  (R1),(R0)           Unit                                         
         TSEG  '), '                                                            
*-                                                                              
*-       SMF system id.                                                         
*-                                                                              
         LT    R1,CVTSMCA                                                       
         IF    NZ,BEGIN                                                         
         TSEG  @R1+16,4,TB         SMF system id                                
         END                                                                    
*-                                                                              
*-       System information.                                                    
*-                                                                              
         SETMSG 'MVS'                                                           
         IF    CVTDCB.CVTMVSE,BEGIN  XA or ESA...                               
         SETMSG 'MVS/ESA'           Assume ESA                                  
         IF    (CVTDCB,EQ,X'93'),'SETMSG "MVS/XA"'  XA                          
         END                                                                    
         TSEG  (R1),(R0),B                                                      
*                                                                               
         LA    R1,CVT                                                           
         SH    R1,=H'40'           CVT-X'28' = Product number text              
         TSEG  @R1,8,T                                                          
*                                                                               
         TSEG  ' ('                                                             
         LA    R1,CVT                                                           
         SH    R1,=H'32'           CVT-X'20' = FMID text                        
         TSEG  @R1,8,T                                                          
         TSEG  ')'                                                              
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         DROP  UCBOB,CVT                                                        
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW INFO Command'                                              
*box                                                                            
*                                                                               
*  SHOWINFO -- SHOW INFO command.                                               
*                                                                               
SHOWINFO PROC                                                                   
         VCALL COLLOPTS                                                         
*                                                                               
         VCALL LOCALTOD                                                         
         XPUSH ,,64,PTR=R15                                                     
         VCALL FMTXDATE            (SHOW XDATE style)                           
         TSEG  (R1),(R0),CR                                                     
         TCR                                                                    
         XPOP  ,,64                                                             
*                                                                               
         VCALL MINFDISP            Show minfo                                   
         TSEG  CVBLANKS,1,CR                                                    
*                                                                               
         CLEAR R0                  Default                                      
         ACALL WINFDISP            Show winfo                                   
*                                                                               
         TSEG  CVBLANKS,1,WR                                                    
         BNZ   CVABORT                                                          
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         EJECT                                                                  
         QLTORG                                                                 
         TITLE 'SHOW WINFO Command'                                             
*-                                                                              
*-  Paging statistics record (must match CVPNSTAT entries exactly!).            
*-                                                                              
PAT      RECORD BEGIN                                                           
PATNAME  DS    CL4                 Page type                                    
PATIO    DS    F                   No. of page I/O's                            
PATWR    DS    F                   No. of page writes                           
*                                                                               
PATNEXT  EQU   *                   (Last entry has NAME of zeros)               
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SHOWWINF -- SHOW WINFO command.                                              
*                                                                               
SHOWWINF PROC                                                                   
         CLEAR R6                  Default                                      
         SCAN  WINFOPRT                                                         
         SCANCHK                                                                
*                                                                               
         LR    R0,R6               Pass ALL option                              
         ACALL WINFDISP                                                         
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
WINFOPRT SCKW  ALL,WINFALL                                                      
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
WINFALL  PROC                                                                   
         LA    R6,1                ALL info                                     
         PRETURN (R6)                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  WINFDISP -- Routine to display WYLBUR statistics.                            
*                                                                               
*    On entry:                                                                  
*      R0 - 0=default                                                           
*           1=ALL                                                               
*                                                                               
WINFDISP PROC                                                                   
         LR    R6,R0                                                            
*                                                                               
         TSEG  CVWYLSSN,,T                                                      
         TSEG  ':',,CR                                                          
         TCR                                                                    
*                                                                               
         IF    CVFNOSMF,BEGIN                                                   
         TSEG  '*** SMF charging records turned off ***',,CR                    
         TCR                                                                    
         END                                                                    
*                                                                               
         IF    CVFRLOAD,'TSEG "*** Reload pending ***",,CR; TCR'                
*                                                                               
         IF    (CVENTON,OR,CVFPGROT),BEGIN  Debugging...                        
         CLEAR R0                                                               
         IF    CVENTON,'SETMSG "*** Tracing ***"'                               
         IF    CVFPGROT,'SETMSG "*** Rotate ***"'                               
         IF    (R0,Z),EXIT                                                      
         TSEG  (R1),(R0),CR                                                     
         TCR                                                                    
         END                                                                    
*                                                                               
         TSEG  'Started at '                                                    
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         LR    R3,R1                                                            
         LM    R0,R1,CVSCLCK                                                    
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0)                                                        
         XPOP  ,,30                                                             
*                                                                               
         TSEG  ' (running for '                                                 
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         LR    R3,R1                                                            
         SDL   R2,R3,CVSCLCK       Calculate elapsed time                       
         SRDL  R2,12               .000001 of a sec                             
         D     R2,=A(100000*60*60)  Number of hours * 10                        
         IF    (R2,GE,=A(10000*60*60/2)),'INCR R3'  Round                       
         BTR   CPDOUB,(0,1),(R3)   Format as "n.n"                              
         TSEG  (R1),(R0)                                                        
         TSEG  ' hours)'                                                        
         TCR                                                                    
*-                                                                              
*-       File system access.                                                    
*-                                                                              
         TCR                                                                    
         TSEG  'Default file system access is: '                                
         SETMSG 'OLDIBM (not Wings)'                                            
         IF    CVFWINGS,'SETMSG "Wings"'                                        
         TSEG  (R1),(R0),CR                                                     
*-                                                                              
*-       Wings statistics.                                                      
*-                                                                              
         TCR                                                                    
         TSEG  'Wings: '                                                        
         L     R15,CVWGRDOP                                                     
         A     R15,CVWGWROP                                                     
         TNUM  (R15)                                                            
         TSEG  ' file opens ('                                                  
         TNUM  L:CVWGWROP                                                       
         TSEG  ' were writes)',,CR                                              
*-                                                                              
*-       Query information.                                                     
*-                                                                              
         TCR                                                                    
         TSEG  'Query: '                                                        
         TNUM  L:CVCSCONN                                                       
         TSEG  ' connections, '                                                 
         TNUM  L:CVCSREQ                                                        
         TSEG  ' requests, '                                                    
         TNUM  L:CVCSNIO                                                        
         TSEG  ' I/O''s',,CR                                                    
*-                                                                              
*-       QSERV information.                                                     
*-                                                                              
         AGO   .NOQSERV                                                         
         TSEG  '        QSERV: '                                                
         TNUM  L:CVNQSERV                                                       
         TSEG  ' requests, '                                                    
         TNUM  L:CVNQSERR                                                       
         TSEG  ' errors',,CR                                                    
.NOQSERV ANOP                                                                   
*-                                                                              
*-       CPU time information.                                                  
*-                                                                              
         TCR                                                                    
         XPUSH ,,32,PTR=R2                                                      
         TSEG  ' User Charged CPU time = '                                      
         CLEAR R0                                                               
         L     R1,CVTIME           Charged time in tu's                         
         M     R0,=A((40960000+(384/2))/384)  Convert to clck                   
         LR    R15,R2                                                           
         VCALL FMTTIME             Hh:mm:ss.hh                                  
         TSEG  (R1),8,B                                                         
         TCR                                                                    
*                                                                               
         TSEG  '   Task Total CPU time = '                                      
         VCALL GETCPU              Get cpu time in tu's                         
         CLEAR R0                                                               
         M     R0,=A((40960000+(384/2))/384)  Convert to clck                   
         LR    R15,R2                                                           
         VCALL FMTTIME             Hh:mm:ss.hh                                  
         TSEG  (R1),8                                                           
         TCR                                                                    
*                                                                               
         TSEG  '          SRB CPU time = '                                      
         L     R15,CVASCBP                                                      
         WITH  (ASCB,R15),'LM R0,R1,ASCBSRBT'                                   
         IF    ((R0,Z),AND,(R1,Z)),'LA R1,1'                                    
         LR    R15,R2                                                           
         VCALL FMTTIME             Hh:mm:ss.hh                                  
         TSEG  (R1),8                                                           
         TCR                                                                    
*                                                                               
         TSEG  'Address Space CPU time = '                                      
         L     R15,CVASCBP                                                      
         WITH  (ASCB,R15),'LM R0,R1,ASCBEJST'  MVS total CPU time               
         LR    R15,R2                                                           
         VCALL FMTTIME             Hh:mm:ss.hh                                  
         TSEG  (R1),8                                                           
         TCR                                                                    
         TCR                                                                    
         TSEG  'Capture ratio is '                                              
*-                                                                              
*-       Total CPU time (from ASCB).                                            
*-                                                                              
         L     R15,CVASCBP                                                      
         WITH  (ASCB,R15),'LM R2,R3,ASCBEJST'  MVS total CPU time               
         SLDL  R2,8                Only take middle bits                        
         LR    R3,R2                                                            
         CLEAR R2                                                               
*-                                                                              
*-       Total billed CPU time.                                                 
*-                                                                              
         CLEAR R0                                                               
         L     R1,CVTIME           Charged time in tu's                         
         M     R0,=A((40960000+(384/2))/384)  Convert to clck                   
         SLDL  R0,8                Only take middle bits                        
*-                                                                              
*-       Display ratio of "total/billed".                                       
*-                                                                              
         IF    (R0,Z),'LA R3,100'  Dummy capture ratio                          
*                                                                               
         ELSE  BEGIN               Calculate it...                              
         M     R2,=F'100'          We want ratio*100                            
         DR    R2,R0                                                            
         END                                                                    
*                                                                               
         IF    (R3,LT,100),'SETMSG "not available."'  (Overflow)                
         ELSE  BEGIN               Normal...                                    
         BTR   CPDOUB,(0,2),(R3)   Format as "n.nn"                             
         END                                                                    
         TSEG  (R1),(R0)                                                        
         TCR                                                                    
         TCR                                                                    
         XPOP  ,,32                                                             
*                                                                               
         TNUM  L:CVNCOM                                                         
         TSEG  ' commands total, '                                              
         TNUM  L:CVNCOME                                                        
         TSEG  ' exec '                                                         
         L     R0,CVNCOME                                                       
         L     R1,CVNCOM                                                        
         ACALL PRCT                Nn.n%                                        
         TCR                                                                    
         TCR                                                                    
         TNUM  LH:CVNFAIL                                                       
         TSEG  ' failsoft recoveries ('                                         
         TNUM  LH:CVNDISPF                                                      
         TSEG  ' dispatcher, '                                                  
         TNUM  LH:CVNSUBF                                                       
         TSEG  ' subtask)',,CR                                                  
*                                                                               
         IF    (CVFCLCK,NZ),BEGIN  Last failsoft info...                        
         TSEG  CVBLANKS,2                                                       
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         L     R0,CVFCLCK                                                       
         CLEAR R1,R3                                                            
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0),B                                                      
         XPOP  ,,30                                                             
         SETMSG CVFINFO                                                         
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),CR                                                     
         END                                                                    
*-                                                                              
*-                                                                              
*-                                                                              
         IF    CVFMEMPAGE,BEGIN    Memory paging only...                        
         TCR                                                                    
         TSEG  'No paging (memory paging only).',,CR                            
         END                                                                    
*-                                                                              
*-       One minute summary (from statistics subtask).                          
*-                                                                              
         ELSE  BEGIN               Paging information...                        
         TCR                                                                    
         TSEG  'Summary for the last minute:',,CR                               
*                                                                               
         L     R0,CV#CPU                                                        
         L     R1,CV#INTVL                                                      
         ACALL PRCT                Percent CPU used                             
         TSEG  ' CPU used (single processor)',,CR                               
*                                                                               
         TNUM  LH:CV#IOSEC,5       Page I/O's per second                        
         TSEG  '  page I/O''s per second ('                                     
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         L     R0,CV#IOCLK         Clock at calculation                         
         CLEAR R1,R3                                                            
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0)                                                        
         XPOP  ,,30                                                             
         TSEG  ')',,CR                                                          
*                                                                               
         TCR                                                                    
         L     R5,CVFPFCB                                                       
         LOOP  BEGIN                                                            
         WITH  (PFCB,R5)                                                        
         IF    (PFCBNP,NZ),BEGIN   Some pages...                                
         TNUM  L:PFCBNO,5          Page file no.                                
         L     R2,PFCBUCBP         UCB ptr                                      
         TSEG  ' ('                                                             
         TSEG  @R2+13,3            Unit address (UCBNAME)                       
         TSEG  ')',,B                                                           
         TSEG  @R2+28,6,B          Volume serial (UCBVOLI)                      
         TNUM  LH:PFCB#IOS,5       Page I/O's per second                        
         TSEG  'p/s '                                                           
         TNUM  LH:PFCB#IOT,5       Milliseconds per page I/O                    
         TSEG  'ms '                                                            
         TCR                                                                    
         END                                                                    
         LA    R5,PFCBNEXT                                                      
         UNTIL (R5,GE,CVLPFCB)                                                  
         END                                                                    
         END                                                                    
*                                                                               
         IF    (R6,Z),BEGIN        Short form...                                
         TCR                                                                    
         TSEG  '[SHOW WINFO ALL will give you more information.]'               
         B     CVNEXT                                                           
         END                                                                    
*-                                                                              
*-       Dispatcher information.                                                
*-                                                                              
         TCR                                                                    
         TSEG  'Dispatcher:  '                                                  
         TNUM  L:CVNDISP                                                        
         TSEG  ' dispatches, '                                                  
         TNUM  L:CVNSLICE                                                       
         TSEG  ' timeslice expirations',,CR                                     
*                                                                               
         TNUM  L:CVNTIDLE                                                       
         TSEG  ' terminal I/O''s after max idle time',,CR                       
*-                                                                              
*-       Autopilot information.                                                 
*-                                                                              
         TCR                                                                    
         TSEG  'Autopilot recommends:',,CR                                      
*                                                                               
         TSEG  CVBLANKS,2                                                       
         L     R15,CVSLICE                                                      
         SRL   R15,12              Convert to .000001 sec (mics)                
         TNUM  (R15)                                                            
         TSEG  ' microseconds maximum timeslice',,CR                            
*                                                                               
         TSEG  CVBLANKS,2                                                       
         TNUM  L:CVPCSEC                                                        
         TSEG  ' seconds before checkpoint write',,CR                           
*                                                                               
         TSEG  CVBLANKS,2                                                       
         TNUM  LH:CVRUNMAX                                                      
         TSEG  ' max run queue allowed ('                                       
         TNUM  LH:CVRUNCUR                                                      
         TSEG  ' current depth)',,CR                                            
*-                                                                              
*-       Display paging/memory information.                                     
*-                                                                              
         TCR                                                                    
         TSEG  'Memory usage:',,CR                                              
         LH    R2,CVNPG                                                         
         LR    R15,R2                                                           
         MH    R15,=AL2((CVPSZ+4095)/4096*4)  Memory in K                       
         TNUM  (R15),9                                                          
         TSEG  'K paging space ('                                               
         TNUM  (R2)                                                             
         TSEG  ' buffers)',,CR                                                  
*                                                                               
         L     R15,CVCPMEM         Memory used for CPs                          
         SRL   R15,10              Convert to kilobytes                         
         TNUM  (R15),9                                                          
         TSEG  'K CP     space',,CR                                             
*                                                                               
         L     R15,CVSTKMEM        Memory use for STACK/HEAP                    
         SRL   R15,10              Convert to kilobytes                         
         TNUM  (R15),9                                                          
         TSEG  'K STACK  space',,CR                                             
*                                                                               
         L     R15,CVMPGMEM        Memory used for memory pages                 
         SRL   R15,10              Convert to kilobytes                         
         TNUM  (R15),9                                                          
         TSEG  'K public space',,CR                                             
*                                                                               
         TCR                                                                    
         TSEG  'GETCORE has allocated '                                         
         L     R15,CVMEMTOT        Memory GETCORE allocated                     
         SRL   R15,10              Convert to kilobytes                         
         TNUM  (R15)                                                            
         TSEG  'K bytes.',,CR                                                   
*-                                                                              
*-       General statistics.                                                    
*-                                                                              
         TCR                                                                    
         TNUM  L:CVNDIO                                                         
         TSEG  ' disk I/O''s, '                                                 
*                                                                               
         TNUM  L:CVNRJE                                                         
         TSEG  ' jobs submitted, '                                              
         TNUM  L:CVNPRINT                                                       
         TSEG  ' prints',,CR                                                    
*                                                                               
         TNUM  L:CVNSMF                                                         
         TSEG  ' SMF records written, '                                         
         TNUM  L:CVNASMF                                                        
         TSEG  ' accounting',,CR                                                
*                                                                               
         SETMSG 'No checkpointing'                                              
         IF    ^CVFNCHK,BEGIN                                                   
         TNUM  L:CVCHKNIO                                                       
         SETMSG ' checkpoint I/O''s'                                            
         END                                                                    
         TSEG  (R1),(R0),CR                                                     
*                                                                               
         TCR                                                                    
         TNUM  L:CVNPIO            Total page I/O's                             
         TSEG  ' page I/O''s ('                                                 
         TNUM  L:CV#COUT           Number of checkpoint I/O writes              
         TSEG  ' checkpoint '                                                   
         L     R0,CV#COUT                                                       
         L     R1,CVNPIO                                                        
         ACALL PRCT                Nn.n%                                        
         TSEG  ')',,CR                                                          
*                                                                               
*dont    TCR                                                                    
*dont    L     R2,CV#SNEM                                                       
*dont    AL    R2,CV#SNB                                                        
*dont    TNUM  (R2)                                                             
*dont    TSEG  ' page snatches',,CR                                             
*                                                                               
*dont    TNUM  L:CV#SNEM,9                                                      
*dont    TSEG  ' empty      '                                                   
*dont    L     R0,CV#SNEM                                                       
*dont    LR    R1,R2                                                            
*dont    ACALL PRCT                Nn.n%                                        
*dont    TCR                                                                    
*                                                                               
*dont    TNUM  L:CV#SNB,9                                                       
*dont    TSEG  ' unchanged  '                                                   
*dont    L     R0,CV#SNB                                                        
*dont    LR    R1,R2                                                            
*dont    ACALL PRCT                Nn.n%                                        
*dont    TCR                                                                    
*                                                                               
         TNUM  L:CV#SNC                                                         
         TSEG  ' running with max ready',,CR                                    
*-                                                                              
*-       Display paging information.                                            
*-                                                                              
         TCR                                                                    
         ACALL WINFPDIS            Display paging information                   
*                                                                               
WINFEXIT PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  WINFPDIS -- Local routine to display paging information.                     
*                                                                               
WINFPDIS PROC                                                                   
*-                                                                              
*-       Paging by page type.                                                   
*-                                                                              
         TSEG  'Paging by page type',,CR                                        
         TSEG  '-------------------',,CR                                        
*                                                                               
         LA    R6,CV#PAT           Start of paging statistics                   
         LOOP  BEGIN                                                            
         WITH  (PAT,R6)                                                         
         WHILE (PATNAME,NZ)        Go through page types...                     
         CLEAR R0                                                               
         IF    (PATNAME,EQ,'MISC'),'SETMSG "(other)  "'                         
         IF    (R0,Z),BEGIN                                                     
         TSEG  CVBLANKS,1                                                       
         TSEG  PATNAME             Page type name                               
         SETMSG CVBLANKS,4                                                      
         END                                                                    
         TSEG  (R1),(R0)                                                        
*                                                                               
         L     R0,PATIO            Page I/O's for this type                     
         L     R1,CVNPIO           Total page I/O's                             
         ACALL PRCT                Nn.n%                                        
*                                                                               
         TNUM  L:PATIO,8                                                        
         TSEG  ' I/O''s   ('                                                    
         L     R0,PATWR            Page writes for this type                    
         L     R1,PATIO            Page I/O's for this type                     
         ACALL PRCT                Nn.n%                                        
         TSEG  ' write)',,CR                                                    
*                                                                               
         LA    R6,PATNEXT          Next PAT entry                               
         END                                                                    
*-                                                                              
*-       Paging by device.                                                      
*-                                                                              
         TCR                                                                    
         TSEG  'Paging by device',,CR                                           
         TSEG  '----------------',,CR                                           
*                                                                               
         IF    CVFMEMPAGE,BEGIN                                                 
         TSEG  'Memory paging is in effect.',,CR                                
         END   ELSE,BEGIN                                                       
         L     R6,CVFPFCB                                                       
         LOOP  BEGIN                                                            
         WITH  (PFCB,R6)                                                        
         IF    (PFCBNP,NZ),BEGIN   Some pages...                                
         TNUM  L:PFCBNO,2          Page file no.                                
         L     R2,PFCBUCBP         UCB ptr                                      
         TSEG  ' ('                                                             
         TSEG  @R2+13,3            Unit address (UCBNAME)                       
         TSEG  ')',,B                                                           
         TSEG  @R2+28,6,B          Volume serial (UCBVOLI)                      
         TNUM  L:PFCBNIO,8                                                      
         TSEG  ' I/O''s '                                                       
         L     R0,PFCBNIO                                                       
         L     R1,CVNPIO                                                        
         ACALL PRCT                Nn.n%                                        
         TNUM  L:PFCBNP,8          Total no. of pages                           
         TSEG  ' pages'                                                         
         TNUM  L:PFCBMP,8          Max no. of pages                             
         TSEG  ' max'                                                           
         TNUM  L:PFCBCP,8          Current no. of pages                         
         TSEG  ' cur',,CR                                                       
         END                                                                    
         LA    R6,PFCBNEXT                                                      
         UNTIL (R6,GE,CVLPFCB)                                                  
         END                                                                    
         END   ,                                                                
*                                                                               
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         AIF   (&$PCODE).NULWCAP                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWCAP -- SHOW WCAPTURE Command.                                           
*     Show global CPU overhead values.                                          
*                                                                               
SHOWWCAP PROC                                                                   
         IF    (WCAPSCLK,Z),'MVC WCAPSCLK,CVSCLCK'  Init field                  
*                                                                               
         SCAN  WCAPPRT             Options                                      
         SCANCHK                                                                
*-                                                                              
*-       Display capture info.                                                  
*-                                                                              
         IF    (WCAPACCT,NZ),BEGIN  Restarted...                                
         TSEG  'Restarted by '                                                  
         TSEG  WCAPACCT+3,2                                                     
         TSEG  '.'                                                              
         TSEG  WCAPACCT,3                                                       
         TSEG  '... '                                                           
         END                                                                    
*                                                                               
         TSEG  CVWYLSSN,,T                                                      
         TSEG  ' capture ratio is '                                             
*-                                                                              
*-       Total CPU time (from ASCB).                                            
*-                                                                              
         L     R15,CVASCBP                                                      
         WITH  (ASCB,R15),'LM R2,R3,ASCBEJST'  MVS total CPU time               
         SDL   R2,R3,WCAPTOTC      Deduct time before RESET                     
         SLDL  R2,12               Only take middle bits                        
         LR    R3,R2                                                            
         CLEAR R2                                                               
*-                                                                              
*-       Total billed CPU time.                                                 
*-                                                                              
         CLEAR R0                                                               
         L     R1,CVTIME           Charged time in tu's                         
         SL    R1,WCAPCPU          Deduct time before RESET                     
         M     R0,=A((40960000+(384/2))/384)  Convert to clck                   
         SLDL  R0,12               Only take middle bits                        
*-                                                                              
*-       Display ratio of "total/billed".                                       
*-                                                                              
         IF    (R0,LT,1000),'SETMSG "???"'  (not significant)                   
         ELSE  BEGIN                                                            
         M     R2,=F'100'          We want ratio*100                            
         DR    R2,R0                                                            
         BTR   CPDOUB,(0,2),(R3)   Format as "n.nn"                             
         END                                                                    
         TSEG  (R1),(R0)                                                        
*-                                                                              
*-       Display number of hours WYLBUR has been running.                       
*-                                                                              
         TSEG  '  (average for '                                                
         STCK  @R13                                                             
         LM    R2,R3,@R13          Current time                                 
         SDL   R2,R3,WCAPSCLK      Calculate elapsed time                       
         SRDL  R2,12               .000001 of a sec                             
         D     R2,=A(10000*60*60)  Number of hours * 100                        
         IF    (R2,GE,=A(10000*60*60/2)),'INCR R3'  Round                       
         BTR   CPDOUB,(0,2),(R3)   Format as "n.nn"                             
         TSEG  (R1),(R0)                                                        
         TSEG  ' hours)'                                                        
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*-                                                                              
*-       SHOW WCAPTURE options.                                                 
*-                                                                              
WCAPPRT  SCKW  RESET,WCAPRES,A                                                  
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(SCNINVAL)                                                     
*                                                                               
WCAPRES  PROC                                                                   
         MVC   WCAPACCT,CPSACCT    Our account                                  
         L     R15,CVASCBP                                                      
         WITH  (ASCB,R15),'MVC WCAPTOTC,ASCBEJST'  Total CPU                    
         MVC   WCAPCPU,CVTIME      Billed CPU                                   
         STCK  WCAPSCLK            Now                                          
         SETMSG 'Done.'                                                         
         B     CVNXTMSG                                                         
         PEND                                                                   
*                                                                               
WCAPACCT DC    XL5'00'             Account                                      
WCAPSCLK DC    D'0'                Time/date at start                           
WCAPTOTC DC    D'0'                Total CPU when restarted                     
WCAPCPU  DC    F'0'                Billed CPU when restarted                    
*                                                                               
         AGO   .ENDWCAP                                                         
.NULWCAP ANOP                                                                   
SHOWWCAP PROC  ,                                                                
         B     CVNEXT                                                           
         PEND  ,                                                                
.ENDWCAP ANOP  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWMAI -- SHOW WMAIL Command.                                              
*                                                                               
SHOWWMAI PROC                                                                   
         VCALL COLLOPTS                                                         
*                                                                               
         TSEG  CVWYLSSN,,T                                                      
         TSEG  ' Mail Statistics:'                                              
         TCR                                                                    
         TCR                                                                    
*                                                                               
*                                                                               
         TSEG  'Started at '                                                    
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         LR    R3,R1                                                            
         LM    R0,R1,CVSCLCK                                                    
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0)                                                        
         XPOP  ,,30                                                             
         TCR                                                                    
         TCR                                                                    
*                                                                               
*                                                                               
         TNUM  L:CVMSENT,6                                                      
         TSEG  ' mail items sent; breakdown is:',,CR                            
*                                                                               
         L     R15,CVMSENT                                                      
         S     R15,CVMSEND                                                      
         S     R15,CVMEMS                                                       
         TNUM  (R15),12                                                         
         TSEG  ' were from WYLBUR mail',,CR                                     
*                                                                               
         TNUM  L:CVMEMS,12                                                      
         TSEG  ' were from EMS',,CR                                             
*                                                                               
         TNUM  L:CVMSEND,12                                                     
         TSEG  ' were SEND commands',,CR                                        
         TCR                                                                    
*                                                                               
         TNUM  L:CVMBIT,12                                                      
         TSEG  ' were to BITNET recipients',,CR                                 
         TCR                                                                    
*                                                                               
*                                                                               
         TNUM  L:CVMSHML,6                                                      
         TSEG  ' SHOW/DUMP MAIL commands; breakdown is:',,CR                    
*                                                                               
         L     R15,CVMSHML                                                      
         S     R15,CVMSHMLD                                                     
         TNUM  (R15),12                                                         
         TSEG  ' were SHOW MAIL commands',,CR                                   
*                                                                               
         TNUM  L:CVMSHMLD,12                                                    
         TSEG  ' were DUMP MAIL commands',,CR                                   
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWREL -- SET WRELOAD/WNORELOAD Commands (Priv'd).                          
*                                                                               
SETWREL  PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         SET   CVFRLOAD                                                         
         IF    (CPCMNM,EQ,'WNO'),'CLEAR CVFRLOAD'  No reload                    
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETWTRC -- SET WTRACE/WNOTRACE Commands (Priv'd).                            
*                                                                               
SETWTRC  PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         SET   CVENTON                                                          
         IF    (CPCMNM,EQ,'WNO'),'SET CVENTOFF'  No tracing                     
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETWROT -- SET WROTATE/WNOROTATE Commands (Priv'd).                          
*                                                                               
SETWROT  PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         CLEAR CVFPGROT                                                         
         ERROR 'WROTATE cleared.  WROTATE currently bombs wylbur.'              
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETRACF -- SET RACF/NORACF Commands (Priv'd).                                
*     This is a temporary command used to enable or disable                     
*     the RACF interface in Wylbur.                                             
*                                                                               
SETRACF  PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         CLEAR CVFNORACF                                                        
         IF    (CPCMNM,EQ,'WNO'),'SET CVFNORACF'  NO RACF                       
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETWTASK -- SET WTASK/WNOTASK Commands (Priv'd).                             
*                                                                               
SETWTASK PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         CLEAR CVFNDSUB                                                         
         IF    (CPCMNM,EQ,'WNO'),'SET CVFNDSUB'  No subtasking                  
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
WACCWA   RECORD BEGIN                                                           
WACCMACH FLAG  ,                   ** Must match CVMACH/USEMACH defn            
         FLAG  WACCFSYSA           - SYSA access allowed                        
         FLAG  WACCFSYSB           - SYSB access allowed                        
         FLAG  WACCFSYSC           - SYSC access allowed                        
         FLAG  WACCFSYSD           - SYSD access allowed                        
         FLAG  WACCFSYSE           - SYSH access allowed                        
         FLAG  WACCFSYSF           - SYSF access allowed                        
         FLAG  WACCFSYSG           - SYSG access allowed                        
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETWMACH -- SET WMACHINE Command (Priv'd).                                   
*                                                                               
SETWMACH PROC  WACCWA                                                           
         LA    R6,WACCWA                                                        
         USING WACCWA,R6                                                        
         CLEAR WACCWA                                                           
*                                                                               
         SCAN  WACCPRT             Scan for allowable machines                  
         SCANCHK                                                                
*                                                                               
         MVC   CVMACH,WACCMACH     Update CVMACH mask                           
         INCR  R15,CVCHKUC         Force checkpoint I/O                         
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
***                                                                             
***  SET WMACHINE machine                                                       
***                                                                             
WACCPRT  OPTION SYSA,SET,,WACCFSYSA                                             
         OPTION SYSB,SET,,WACCFSYSB                                             
         OPTION SYSC,SET,,WACCFSYSC                                             
         OPTION SYSD,SET,,WACCFSYSD                                             
         OPTION SYSH,SET,,WACCFSYSE                                             
         OPTION SYSF,SET,,WACCFSYSF                                             
         OPTION SYSG,SET,,WACCFSYSG                                             
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         DROP  R6                                                               
*                                                                               
*box                                                                            
*                                                                               
*  SHOWWMAC -- SHOW WMACHINE Command (Priv'd).                                  
*                                                                               
SHOWWMAC PROC                                                                   
         VCALL COLLOPTS                                                         
*                                                                               
         IF    (CVMACH,Z),BEGIN                                                 
         SETMSG 'No machine set (try SET WMACHINE SYSA).'                       
         B     CVNXTMSG                                                         
         END                                                                    
*                                                                               
         TSEG  'Machine is'                                                     
         IF    CVFSYSA,'TSEG " SYSA"'                                           
         IF    CVFSYSB,'TSEG " SYSB"'                                           
         IF    CVFSYSC,'TSEG " SYSC"'                                           
         IF    CVFSYSD,'TSEG " SYSD"'                                           
         IF    CVFSYSE,'TSEG " SYSH"'                                           
         IF    CVFSYSF,'TSEG " SYSF"'                                           
         IF    CVFSYSG,'TSEG " SYSG"'                                           
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWFACT -- SET WFACTOR Command (Priv'd).                                    
*                                                                               
SETWFACT PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
         IF    (R0,GT,=A(50*1000)),BEGIN                                        
         ABORT 'CPU multiplier is too big!'                                     
         END                                                                    
*                                                                               
         ST    R0,CVCPUMUL         CPU multiplication factor                    
         INCR  R15,CVCHKUC         Force checkpoint I/O                         
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SHOWWFAC -- SHOW WFACTOR Command.                                            
*                                                                               
SHOWWFAC PROC                                                                   
         VCALL COLLOPTS                                                         
*                                                                               
         IF    (CVCPUMUL,Z),BEGIN                                               
         SETMSG 'No CPU multiplier.'                                            
         B     CVNXTMSG                                                         
         END                                                                    
*                                                                               
         TSEG  'CPU multiplication factor is '                                  
         L     R0,CVCPUMUL                                                      
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWFDEF - SET WYLBUR FILE SYSTEM DEFAULT                                    
*                                                                               
SETWFDEF PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         SCAN  SWFDPRT                                                          
         SCANCHK                                                                
*                                                                               
         ACALL SHOWWFD                                                          
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
SWFDPRT  SCKW  ,SWFDNULL,NULL                                                   
         OPTION WINGS,SET,,CVFWINGS,CVFOLDIBM                                   
         OPTION OLDIBM,SET,,CVFOLDIBM,CVFWINGS                                  
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SWFDNULL PROC                                                                   
         ERROR 'Missing file system type.'                                      
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWFD - SHOW WYLBUR FILE SYSTEM DEFAULT                                    
*                                                                               
SHOWWFD  PROC                                                                   
         TSEG  'Wylbur default file system is '                                 
*                                                                               
         IF    CVFWINGS,BEGIN                                                   
         SETMSG 'Wings.'                                                        
         END                                                                    
         IF    CVFOLDIBM,BEGIN                                                  
         SETMSG 'OLDIBM.'                                                       
         END                                                                    
         IF    (^CVFOLDIBM,AND,^CVFWINGS),BEGIN                                 
         SETMSG 'OLDIBM.'                                                       
         END                                                                    
         TSEG  (R1),(R0)                                                        
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWFPAT - SET WYLBUR DEFAULT WINGS PATH NAME                                
*                                                                               
SETWFPAT PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         SCAN  SWFPPRT                                                          
         SCANCHK                                                                
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
SWFPPRT  SCKW  ,SWFPNULL,NULL                                                   
         SCKW  ,SWFPNAME                                                        
*                                                                               
SWFPNULL PROC                                                                   
         MVC   CVWPATH,=CL8'WINGSV00'                                           
         PEND                                                                   
*                                                                               
SWFPNAME PROC                                                                   
         SCUPCASE CVWPATH                                                       
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
* SHOWWFPA - SHOW WFPATH, WINGS PATH                                            
*                                                                               
*                                                                               
SHOWWFPA PROC                                                                   
         IF    (CVWPATH,EQ,0),BEGIN                                             
         TSEG  'WINGSV00'                                                       
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  CVWPATH                                                          
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         SPACE 2                                                                
         QLTORG ,                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SET FNOTIMEOUT - DO NOT LET WINGS TIMEOUT,                                   
*                                                                               
*  THIS IS A PATCH FOR TESTING WINGS FOR PJ, CH, NIZ                            
*  ETC.                                                                         
*                                                                               
SETFNTMO PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
         SET   CPFNTMO                                                          
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*box                                                                            
*                                                                               
*  SET FTIMEOUT - LET WINGS TIMEOUT,  THE NORM                                  
*                                                                               
*  THIS IS A PATCH FOR TESTING WINGS FOR PJ, CH, NIZ                            
*  ETC.                                                                         
*                                                                               
SETFTMO  PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
         CLEAR CPFNTMO                                                          
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWPGS -- SET WPAGES Command (Priv'd).                                      
*                                                                               
WPGWA    RECORD BEGIN                                                           
WPGFLAG  FLAG                                                                   
         FLAG  WPGFREAL            - Page fix page buffers                      
         FLAG  WPGFVIRT            - Don't page fix page buffers                
         FLAG  WPGFAUTO            - Auto switch between real/virt              
WPGHI    DS    H                   High paging rate                             
WPGLO    DS    H                   Low paging rate                              
WPGMEG   DS    H                   If tot mach is <= megs then small            
WPGLMIN  DS    H                   Large config: min pages allowed              
WPGLMAX  DS    H                   Large config: max pages allowed              
WPGSMIN  DS    H                   Small config: min pages allowed              
WPGSMAX  DS    H                   Small config: max pages allowed              
WPGSECS  DS    H                   Seconds between adjustments                  
WPGNEW   DS    H                   Current number of pages                      
*                                                                               
WPGWORK  DS    D                   Working area (for formatting)                
         END                                                                    
*-                                                                              
SETWPGS  PROC  WPGWA                                                            
         LA    R6,WPGWA                                                         
         USING WPGWA,R6                                                         
         CLEAR WPGWA                                                            
*                                                                               
         IF    (CPSFSPR+CPSFOPR,Z),'VCALL NOTVALID'  Not priv'd                 
*-                                                                              
*-       Start off with existing values.                                        
*-                                                                              
         IF    CVPGFREAL,'SET WPGFREAL'                                         
         IF    CVPGFVIRT,'SET WPGFVIRT'                                         
         IF    CVPGFAUTO,'SET WPGFAUTO'                                         
         IF    (WPGFREAL+WPGFVIRT+WPGFAUTO,Z),BEGIN                             
         SET   WPGFAUTO+WPGFVIRT                                                
         END                                                                    
*                                                                               
         MVC   WPGHI,CVPGHI        High rate                                    
         MVC   WPGLO,CVPGLO        Low rate                                     
         MVC   WPGMEG,CVPGMEG      Meg (small/large config switch)              
         MVC   WPGLMIN,CVPGLMIN    Min pages                                    
         MVC   WPGLMAX,CVPGLMAX    Max pages                                    
         MVC   WPGSMIN,CVPGSMIN    Min pages                                    
         MVC   WPGSMAX,CVPGSMAX    Max pages                                    
         MVC   WPGSECS,CVPGSECS    Seconds between adjustments                  
         MVC   WPGNEW,CVNPG        Cur pages                                    
*-                                                                              
*-       Get new values.                                                        
*-                                                                              
         SCAN  WPGPRT              Wpages options                               
         SCANCHK                                                                
*-                                                                              
*-       Just checking.                                                         
*-                                                                              
         LH    R5,WPGNEW           New current                                  
         IF    (R5,GT,4000),BEGIN                                               
         TSEG  'Wow!!  That''s a lot of memory Niz!',,CR                        
         SETMSG 'Should we go for it'                                           
         VCALL YESREQ                                                           
         END                                                                    
*-                                                                              
*-       Update paging performance parameters.                                  
*-                                                                              
         CLEAR CVPGFAUTO+CVPGFREAL+CVPGFVIRT                                    
*                                                                               
         IF    WPGFAUTO,BEGIN      Automatic real/virtual...                    
         SET   CVPGFAUTO                                                        
*-                                                                              
*-       Automatic means:  REAL during DAY and PEAK timeblocks;                 
*-                         VIRTUAL during other timeblocks                      
*-                                                                              
         LA    R2,99               Assume non-day setting                       
         IF    ^CVFTEST,BEGIN      Only check for day if prod...                
         L     R15,CVTPTR                                                       
         WITH  (CVT,R15),'L R15,CVTUSER'                                        
         IF    ((R15,NZ),AND,(@R15,EQ,'SCIP')),BEGIN                            
         WITH  (USERCVT,R15),'LC R2,USEBLOCK'  Current time-block               
         END                                                                    
         END                                                                    
*                                                                               
         IF    ((R2,Z),OR,(R2,EQ,4)),'SET WPGFREAL'  Day/peak blocks            
         ELSE  'SET WPGFVIRT'      All other blocks                             
         END                                                                    
*                                                                               
         IF    WPGFREAL,'SET CVPGFREAL'                                         
         ELSE  'SET CVPGFVIRT'                                                  
*                                                                               
         MVC   CVPGHI,WPGHI        High rate                                    
         MVC   CVPGLO,WPGLO        Low rate                                     
         MVC   CVPGMEG,WPGMEG      Meg value                                    
         MVC   CVPGLMIN,WPGLMIN    Large config: min pages                      
         MVC   CVPGLMAX,WPGLMAX    Large config: max pages                      
         MVC   CVPGSMIN,WPGSMIN    Small config: min pages                      
         MVC   CVPGSMAX,WPGSMAX    Small config: max pages                      
         MVC   CVPGSECS,WPGSECS    Seconds between adjustments                  
*                                                                               
         INCR  R15,CVCHKUC         Update the checkpoint record                 
*                                                                               
         VCALL CALCPGC             Calculate page min/max values                
*-                                                                              
*-       Increase/decrease the number of pages by slowly                        
*-         adding/deleting the number of pages.                                 
*-                                                                              
         SH    R5,CVNPG            Signed change in no of pages                 
         BZ    CVNEXT              Nothing to do, scram                         
*                                                                               
         IF    (R5,POS),BEGIN      Add page buffers...                          
*-                                                                              
*-       Add page buffers.                                                      
*-                                                                              
         TSEG  'Adding pages buffers...'                                        
         TNUM  LH:CVNPG,4                                                       
         TSEG  ' buffers'                                                       
         TSEG  =8X'16',8           (backspaces)                                 
         TMARK                                                                  
         TWRITE                                                                 
*                                                                               
         WHILE (R5,POS),BEGIN      Add a page at a time...                      
         VCALL GETPCB              Add a page                                   
         DECR  R5                                                               
         BTD   WPGWORK,4,LH:CVNPG                                               
         IF    (WPGWORK+3,EQ,'0'),BEGIN                                         
         TSEG  X'16161616'                                                      
         TSEG  WPGWORK,4                                                        
         TMARK                                                                  
         TWRITE                                                                 
*                                                                               
         LA    R15,50              1/2 second                                   
         VCALL WAITER              Wait a bit                                   
         END                                                                    
*                                                                               
         TSTAT                                                                  
         IF    NZ,'TCR; ABORT "Stopped."'                                       
         END                                                                    
*                                                                               
         TSEG  X'16161616'                                                      
         TNUM  LH:CVNPG,4                                                       
         SETMSG ' buffers'                                                      
         B     CVNXTMSG                                                         
         END                                                                    
*-                                                                              
*-       Deleting page buffers.                                                 
*-                                                                              
         TSEG  'Deleting page buffers...'                                       
         TNUM  LH:CVNPG,4                                                       
         TSEG  ' buffers'                                                       
         TSEG  =8X'16',8           (backspaces)                                 
         TMARK                                                                  
         TWRITE                                                                 
*                                                                               
         LPR   R5,R5               Number of pages to delete                    
         WHILE (R5,POS),BEGIN      Delete a page at a time...                   
         VCALL FREEPCB             Free a page                                  
         IF    NZ,BEGIN            No empty pages...                            
         VCALL PGETNEW             Get a new page                               
         IF    Z,'PFREE PAR,EMPTY'  Free it and put page on emptyQ              
         END                                                                    
         ELSE  BEGIN               Deleted...                                   
         DECR  R5                                                               
         BTD   WPGWORK,4,LH:CVNPG                                               
         IF    (WPGWORK+3,EQ,'0'),BEGIN                                         
         TSEG  X'16161616'                                                      
         TSEG  WPGWORK,4                                                        
         TMARK                                                                  
         TWRITE                                                                 
*                                                                               
         LA    R15,50              1/2 second                                   
         VCALL WAITER              Wait a bit                                   
         END                                                                    
*                                                                               
         TSTAT                                                                  
         IF    NZ,'TCR; ABORT "Stopped."'                                       
         END                                                                    
         END                                                                    
*                                                                               
         TSEG  X'16161616'                                                      
         TNUM  LH:CVNPG,4                                                       
         SETMSG ' buffers'                                                      
         B     CVNXTMSG                                                         
         PEND                                                                   
         EJECT                                                                  
***                                                                             
***  SET WPAGES Options.                                                        
***                                                                             
WPGPRT   OPTION REAL,SET,A,WPGFREAL,WPGFVIRT+WPGFAUTO                           
         OPTION VIRTUAL,SET,A,WPGFVIRT,WPGFREAL+WPGFAUTO                        
         OPTION AUTOMATIC,SET,A,WPGFAUTO,WPGFREAL+WPGFVIRT                      
         SCKW  SECONDS,XSECS,(A,P,PI),99999                                     
         SCKW  HIGH,XHI,(A,P,PI),99999                                          
         SCKW  LOW,XLOW,(A,P,PI),99999                                          
         SCKW  MEGS,XMEGS,(A,P,PI),999                                          
         SCKW  LMINIMUM,XLMIN,(A,P,PI),99999                                    
         SCKW  LMAXIMUM,XLMAX,(A,P,PI),99999                                    
         SCKW  SMINIMUM,XSMIN,(A,P,PI),99999                                    
         SCKW  SMAXIMUM,XSMAX,(A,P,PI),99999                                    
         SCKW  MINIMUM,XOLDERR,A                                                
         SCKW  MAXIMUM,XOLDERR,A                                                
         SCKW  ,XNUM,PI,99999                                                   
         SCKW  ,V(NOTVALID)                                                     
         EJECT                                                                  
*-                                                                              
XSECS    PROC                                                                   
         STH   R0,WPGSECS                                                       
         PEND                                                                   
*                                                                               
XHI      PROC                                                                   
         STH   R0,WPGHI                                                         
         PEND                                                                   
*                                                                               
XLOW     PROC                                                                   
         STH   R0,WPGLO                                                         
         PEND                                                                   
*                                                                               
XMEGS    PROC                                                                   
         STH   R0,WPGMEG                                                        
         PEND                                                                   
*                                                                               
XOLDERR  PROC                                                                   
         ABORT 'Use LMIN/LMAX and SMIN/SMAX; look at SHOW WPAGES.'              
         PEND                                                                   
*                                                                               
XLMIN    PROC                                                                   
         STH   R0,WPGLMIN                                                       
         PEND                                                                   
*                                                                               
XLMAX    PROC                                                                   
         STH   R0,WPGLMAX                                                       
         PEND                                                                   
*                                                                               
XSMIN    PROC                                                                   
         STH   R0,WPGSMIN                                                       
         PEND                                                                   
*                                                                               
XSMAX    PROC                                                                   
         STH   R0,WPGSMAX                                                       
         PEND                                                                   
*                                                                               
XNUM     PROC                                                                   
         STH   R0,WPGNEW                                                        
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWPGS -- SHOW WPAGES Command.                                             
*                                                                               
SHOWWPGS PROC                                                                   
         TSEG  'Pages = '                                                       
         TNUM  LH:CVNPG            Current number of pages                      
         TSEG  ' ('                                                             
         TNUM  LH:CVNPG16M         Number of pages below 16M line)              
         TSEG  ' are below the 16M line)',,CR                                   
         TCR                                                                    
*                                                                               
         TSEG  'Page buffers are '                                              
*                                                                               
         IF    CVPGFAUTO,BEGIN     Automatic...                                 
         TSEG  'AUTO'                                                           
         SETMSG ', currently VIRTUAL'                                           
         IF    CVPGFREAL,'SETMSG ", currently REAL"'                            
         TSEG  (R1),(R0)                                                        
         END                                                                    
*                                                                               
         ELSE  BEGIN               Static...                                    
         SETMSG 'VIRTUAL'                                                       
         IF    CVPGFREAL,'SETMSG "REAL"'                                        
         TSEG  (R1),(R0)                                                        
         END                                                                    
*                                                                               
         TSEG  ' (choices: REAL, VIRTUAL, AUTO)'                                
         TCR                                                                    
         TCR                                                                    
*                                                                               
         TSEG  'Buffers: '                                                      
         LH    R15,CVNPG                                                        
         ACALL SEGPGNUM                                                         
         TSEG  ', '                                                             
         TNUM  LH:CV#IOSEC                                                      
         TSEG  ' pages/second',,CR                                              
         TCR                                                                    
         TSEG  'Autopilot '                                                     
         LTH   R2,CVPGADJ                                                       
         IF    Z,'TSEG "has not changed this value."'                           
         ELSE  BEGIN                                                            
         SETMSG 'added '                                                        
         IF    (R2,NEG),'SETMSG "released "; LCR R2,R2'                         
         TSEG  (R1),(R0)                                                        
         LR    R15,R2                                                           
         ACALL SEGPGNUM                                                         
         TSEG  ' at '                                                           
         XPUSH ,,32,PTR=R15                                                     
         L     R0,CVPGCLK                                                       
         CLEAR R1                                                               
         VCALL FMTTIME             Get "hh:mm:ss.hh"                            
         TSEG  (R1),5                                                           
         TSEG  '.'                                                              
         END                                                                    
         TCR                                                                    
         TCR                                                                    
*-                                                                              
*-       Also show tuning information.                                          
*-                                                                              
         TSEG  '<.U+>Tuning information<.U->',,CR                               
         TNUM  LH:CVPGSECS                                                      
         TSEG  ' seconds between adjustments.',,CR                              
*                                                                               
         TSEG  'Under'                                                          
         TNUM  LH:CVPGLO,3                                                      
         TSEG  ' pages/second is too low.',,CR                                  
*                                                                               
         TSEG  'Over'                                                           
         TNUM  LH:CVPGHI,4                                                      
         TSEG  ' pages/second is too high.',,CR                                 
*                                                                               
         LH    R15,CVPGMIN                                                      
         ACALL SEGPGNUM                                                         
         TSEG  ' is the minimum allowed.',,CR                                   
*                                                                               
         LH    R15,CVPGMAX                                                      
         ACALL SEGPGNUM                                                         
         TSEG  ' is the maximum allowed.',,CR                                   
         TCR                                                                    
*                                                                               
         TSEG  'Small if real memory <= '                                       
         TNUM  LH:CVPGMEG                                                       
         TSEG  'M, currently '                                                  
         L     R15,CVTPTR                                                       
         WITH  (CVT,R15),'L R15,CVTRCEP'  SRM RCE ptr                           
         L     R15,@R15+4          RCEPOOL = memory online & avail              
         SRL   R15,8               Amount in megabytes                          
         TNUM  (R15)                                                            
         TSEG  'M',,CR                                                          
*                                                                               
         TSEG  'Small configuration: '                                          
         TSEG  'SMIN='                                                          
         TNUM  LH:CVPGSMIN                                                      
         TSEG  ', SMAX='                                                        
         TNUM  LH:CVPGSMAX                                                      
         TCR                                                                    
*                                                                               
         TSEG  'Large configuration: '                                          
         TSEG  'LMIN='                                                          
         TNUM  LH:CVPGLMIN                                                      
         TSEG  ', LMAX='                                                        
         TNUM  LH:CVPGLMAX                                                      
         TCR                                                                    
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*                                                                               
*  SHOW WYLPAGES <lno>                                                          
*                                                                               
*                                                                               
SHOWWYLP PROC                                                                   
*                                                                               
         CLEAR R5                  R5 - JCB OF OPTIONAL LINE NUMBER             
         SCAN SWYLPPRT                                                          
         SCANCHK                                                                
*                                                                               
         COMMENT                   DEFAULT LINE NUMBER IS SELF                  
         IF    (R5,Z),BEGIN                                                     
         L     R5,CVCURJCB                                                      
         END                                                                    
*                                                                               
         USING JCB,R5                                                           
         IF    JCBWFSO,BEGIN                                                    
         TSEG  'Line '                                                          
         TNUM  LH:JCBSEQ                                                        
         TSEG  ' is not logged on (or not in this WYLBUR).'                     
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         TNUM  LH:JCBNPG                                                        
         TSEG  ' pages'                                                         
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  R5                                                               
*                                                                               
*                                                                               
*                                                                               
SWYLPPRT SCKW ,SWYLPLIN,PI,5000                                                 
         SCKW ,V(NOTVALID)                                                      
*                                                                               
*                                                                               
SWYLPLIN PROC ,                                                                 
         IF    (R5,NZ),'VCALL NOTVALID'  NO 2ND LINE NO                         
         LR    R5,R0                                                            
         MH    R5,=AL2(L'JCB)                                                   
         A     R5,CVFJCB                                                        
         IF    (R5,GT,CVLJCB),'VCALL NOTVALID'  LINE NO TOO BIG                 
         PRETURN (R5)                                                           
         CLEAR R15                                                              
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SEGPGNUM -- Local routine to seg page number followed by                     
*    by the corresponding value in kilobytes.                                   
*                                                                               
*    On entry:                                                                  
*       R15 - number of pages                                                   
*                                                                               
SEGPGNUM PROC                                                                   
         XPUSH R15                                                              
         MH    R15,=AL2((CVPSZ+4095)/4096*4)  Memory in K                       
         TNUM  (R15)                                                            
         TSEG  'K ('                                                            
         XPOP  R15                                                              
*                                                                               
         XPUSH R15                                                              
         TNUM  (R15)                                                            
         XPOP  R15                                                              
         SETMSG ' page)'                                                        
         IF    (R15,NE,1),'SETMSG " pages)"'                                    
         TSEG  (R1),(R0)                                                        
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWBUF -- SHOW WBUFFER command.                                            
*                                                                               
SHOWWBUF PROC                                                                   
         VCALL COLLOPTS                                                         
*                                                                               
         L     R15,=F'4000'                                                     
         VCALL FMTWBUF             Do SHOW WBUF (see DISP)                      
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         AIF   (&$PCODE).NULWLRA                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWLRA -- SHOW WLRA Command (Priv'd).                                      
*                                                                               
SHOWWLRA PROC                                                                   
*-                                                                              
*-     Command to get a page and then find out how long it takes                
*-         for it to be paged out.                                              
*-                                                                              
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
         GETMAIN RU,LV=4096,BNDRY=PAGE,LOC=ANY  One MVS page                    
         LR    R5,R1                                                            
         MVI   @R5,0               Mark page as changed                         
*                                                                               
         LOOP  BEGIN                                                            
         MODESET MODE=SUP          ********                                     
         CLEAR R2                  Flag: assume paged in                        
         LRA   R15,@R5             Is page still valid?                         
         IF    NZ,'LA R2,1'        No, it's been paged out                      
         MODESET MODE=PROB         ********                                     
*                                                                               
         SETMSG '+'                 In                                          
         IF    (R2,NZ),'SETMSG "-"'   Out                                       
         TSEG  (R1),(R0)                                                        
         TMARK                                                                  
         TWRITE                                                                 
         IF    NZ,EXIT             Scram                                        
*                                                                               
         LA    R15,5*100                                                        
         VCALL WAITER              Wait 5 seconds                               
         IF    NZ,EXIT             Scram                                        
         END                                                                    
*-                                                                              
*-       All done, now free the page.                                           
*-                                                                              
         LR    R1,R5               Page ptr                                     
         FREEMAIN RU,A=(5),LV=4096  Free MVS page                               
         B     CVNEXT                                                           
         PEND                                                                   
         AGO   .ENDWLRA                                                         
.NULWLRA ANOP                                                                   
SHOWWLRA PROC ,                                                                 
         B     CVNEXT                                                           
         PEND                                                                   
.ENDWLRA ANOP  ,                                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWSL -- SET WSLICE Command (Priv'd).                                       
*                                                                               
SETWSL   PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  Not priv'd, sorry                     
*                                                                               
         SLL   R0,12               Convert to low order STCK                    
         ST    R0,CVSLICE          Set new timeslice interval                   
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWSL -- SHOW WSLICE Command.                                              
*                                                                               
SHOWWSL  PROC                                                                   
         L     R15,CVSLICE                                                      
         SRL   R15,12              .000001 of a sec (mics)                      
         TNUM  (R15)                                                            
         SETMSG ' microseconds maximum timeslice.'                              
         B     CVNXTMSG                                                         
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  PRCT -- Local routine to do percentage.                                      
*                                                                               
PRCT     PROC                                                                   
         CLEAR R14,R15                                                          
         IF    (R1,NZ),BEGIN                                                    
         LR    R15,R0                                                           
         M     R14,=A(1000)                                                     
         DR    R14,R1                                                           
         END                                                                    
         BTR   CPDOUB,(5,1),(R15)  Percentage -- nnn.n                          
         TSEG  (R1),(R0)                                                        
         TSEG  '%'                                                              
         PEND                                                                   
         TITLE 'SHOW DATE Command'                                              
SHDTWA   RECORD BEGIN                                                           
SHDTCLCK DS    D                   Time of day clock                            
SHDTMSG  DS    CL40                Message area                                 
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SHOWDATE -- SHOW DATE command.                                               
*                                                                               
SHOWDATE PROC  SHDTWA                                                           
         LA    R6,SHDTWA                                                        
         USING SHDTWA,R6                                                        
         CLEAR SHDTWA                                                           
*                                                                               
         VCALL LOCALTOD                                                         
         STM   R0,R1,SHDTCLCK      Current time/date                            
*                                                                               
         CLEAR R5                  Zero (for error checking below)              
         SCAN  DATEPRT             Look for options                             
         SCANCHK                                                                
*                                                                               
         IF    (R5,GT,1),BEGIN                                                  
         ABORT 'You can only specify one alternate time zone.'                  
         END                                                                    
*-                                                                              
*-       Display the time and date.                                             
*-                                                                              
         LM    R0,R1,SHDTCLCK      Time and date to display                     
         XPUSH ,,64,PTR=R15                                                     
         IF    (CPCMNM,NE,'XDA'),BEGIN  (SHOW DATE)                             
         VCALL FMTCLCK                                                          
         MVC   15(13,R1),17(R1)    Eliminate the century                        
         MVC   19(7,R1),21(R1)      for now                                     
         S     R0,=F'4'                                                         
         END                                                                    
*                                                                               
         ELSE  BEGIN                                                            
         VCALL FMTXDATE            SHOW XDATE style                             
         MVC   12(15,R1),14(R1)    Squeeze out century                          
         S     R0,=F'2'                                                         
         IF    (R5,NZ),'SH R0,=H"4"'  We don't know the timezone                
         END                                                                    
*                                                                               
         TSEG  (R1),(R0)           Show time/date                               
         XPOP  ,,64                                                             
*                                                                               
         IF    (SHDTMSG,NZ),'TSEG SHDTMSG'  Added message (if any)              
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
***                                                                             
***  SHOW DATE/XDATE options                                                    
***                                                                             
DATEPRT  SCKW  BANGKOK,DTBANG,A                                                 
         SCKW  MOSCOW,DTMOSCOW,A                                                
         SCKW  WASHINGTON,DTWASH,A                                              
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,DTCLCK                                                          
*                                                                               
*                                                                               
$1HOUR   EQU   3433,,C'N'          Number of 2**31 ticks in an hr               
*                                                                               
*                                                                               
DTBANG   PROC                                                                   
         VCALL LOCALTOD            Current time/date                            
         XPUSH ,,64,PTR=R15                                                     
         VCALL FMTXDATE            SHOW XDATE for our timezone                  
         AR    R1,R0                                                            
         SH    R1,=H'2'                                                         
         IF    (@R1,EQ,'D'),'L R15,=A(14*$1HOUR)'  Offset if PDT                
         ELSE  'L R15,=A(15*$1HOUR)'               Offset if PST                
         XPOP  ,,64                                                             
*                                                                               
         MVC   SHDTMSG,=CL(L'SHDTMSG)' (Bangkok time)'                          
         AL    R15,SHDTCLCK        +15 hours (or +14 if PDT)                    
         ST    R15,SHDTCLCK                                                     
         PRETURN (R5)                                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
DTWASH   PROC                                                                   
         LA    R5,@R5+1            Number of zones specified                    
         MVC   SHDTMSG,=CL(L'SHDTMSG)' (Washington D.C. time)'                  
         L     R15,SHDTCLCK                                                     
         AL    R15,=A(3*$1HOUR)    +3 hours                                     
         ST    R15,SHDTCLCK                                                     
         PRETURN (R5)                                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
DTMOSCOW PROC                                                                   
         LA    R5,@R5+1            Number of zones specified                    
         MVC   SHDTMSG,=CL(L'SHDTMSG)' (Moscow time)'                           
         L     R15,SHDTCLCK                                                     
         AL    R15,=A(11*$1HOUR)   +11 hours                                    
         ST    R15,SHDTCLCK                                                     
         PRETURN (R5)                                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
DTCLCK   PROC                                                                   
         IF    (R0,NE,16),'VCALL NOTVALID'                                      
         LA    R5,@R5+1            Specific zone specified                      
         MVC   SHDTMSG,=CL(L'SHDTMSG)' (STCK time)'                             
         LR    R2,R1                                                            
         XTB   (R1),8              First word                                   
         IF    NZ,'VCALL NOTVALID'                                              
         ST    R15,SHDTCLCK                                                     
         XTB   @R2+8,8             Second word                                  
         IF    NZ,'VCALL NOTVALID'                                              
         ST    R15,SHDTCLCK+4                                                   
         PRETURN (R5)                                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
*                                                                               
         DROP  R6                                                               
         SPACE 2                                                                
*-                                                                              
*-       DATEDISP:                                                              
*-         On entry: R0,R1 - TOD clock                                          
*-                                                                              
DATEDISP PROC                                                                   
         XPUSH ,,64,PTR=R15                                                     
         TSEG  (R1),(R0),CR                                                     
         XPOP  ,,64                                                             
         PEND                                                                   
         TITLE 'SHOW GETSTACK Command'                                          
*box                                                                            
*                                                                               
*  SHOWGETS -- SHOW GETSTACK Command                                            
*                                                                               
SHOWGETS PROC                                                                   
         IF    (CPGETLN,Z),'TSEG "No text in GET stack.",,WR'                   
         ELSE  BEGIN                                                            
         L     R2,CPGETSTK         Load pointer to GET stack                    
         TSEG  ''''                                                             
         TSEG  @R2,LH:CPGETLN                                                   
         TSEG  ''' - GET stack text.',,WR                                       
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
         TITLE 'SHOW WVOLUME command'                                           
*box                                                                            
*                                                                               
*  SHOWWVOL -- SHOW WVOLUME command.                                            
*                                                                               
SHOWWVOL PROC                                                                   
         VCALL COLLOPTS       Allow collect options                             
*                                                                               
         IF    (CVVOLMAX,Z),BEGIN                                               
         SETMSG 'No volumes.'                                                   
         B     CVNXTMSG                                                         
         END                                                                    
*                                                                               
         CLEAR R2                                                               
         WHILE (R2,LT,CVVOLMAX),BEGIN                                           
         LR    R15,R2                                                           
         MH    R15,=H'6'                                                        
         TSEG  CVVOL(R15),6,B                                                   
         LA    R2,@R2+1                                                         
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW VOLUMES Command'                                           
*box                                                                            
*                                                                               
*  SHOWVOLS -- SHOW VOLUMES command.                                            
*                                                                               
SHOWVOLS PROC                                                                   
         VCALL EXIT1               LOCAL exit - Show vols                       
         B     CVNEXT                                                           
         PEND                                                                   
         TITLE 'SET/SHOW MESSAGE Commands'                                      
*box                                                                            
*                                                                               
*  SETMSG -- SET MESSAGE command  (priv'd).                                     
*                                                                               
SETMSG   PROC                                                                   
         VCALL ORVCPASS            (Allow SPIRES to intercept)                  
*                                                                               
         CLEAR R6                                                               
*                                                                               
         IF    (CPCMNM,EQ,'M'),BEGIN  Set message...                            
         LA    R6,CVMSGCK                                                       
         IF    (CPSFSPR+CPSFOPR,NZ),EXIT                                        
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         IF    (CPCMNM,EQ,'A'),BEGIN  Set amessage...                           
         LA    R6,CVAMSGCK                                                      
         IF    (CPSFSPR+CPSFAPR,NZ),EXIT                                        
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         IF    (CPCMNM,EQ,'U'),BEGIN  Set umessage...                           
         LA    R6,CVUMSGCK                                                      
         IF    (CPSFSPR+CPSFOPR,NZ),EXIT                                        
         IF    (CPSFADM,AND,(CPSGRP,EQ,'GA')),EXIT                              
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         IF    (CPCMNM,EQ,'V'),BEGIN  Set vmessage...                           
         LA    R6,CVVMSGCK                                                      
         IF    (CPSFSPR+CPSFOPR,Z),'VCALL NOTVALID'                             
         END                                                                    
*                                                                               
         IF    (R6,Z),'VCALL NOTVALID'                                          
*                                                                               
         SCINFO                                                                 
         VCALL LRTRIM                                                           
         VCALL DEQUOTE             Dequote, if needed                           
         VCALL LRTRIM                                                           
*                                                                               
         XPUSH R0,R1                                                            
         VCALL LOCALTOD            Current time of day                          
         ST    R0,0(,R6)                                                        
         CLEAR (@R6+4,L'CVMSG)                                                  
         XPOP  R0,R1                                                            
*                                                                               
         IF    (R0,POS),BEGIN      New message...                               
         MVC   @R6+4(L'CVMSG),CVBLANKS                                          
         CEIL  R0,L'CVMSG                                                       
         LR    R15,R0                                                           
         MOVE  R15,@R6+4,@R1                                                    
         END                                                                    
*                                                                               
         INCR  R15,CVCHKUC         Checkpointing needed                         
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWMSG -- SHOW MESSAGE command.                                             
*                                                                               
SHOWMSG  PROC                                                                   
         VCALL COLLOPTS                                                         
         LA    R6,CVMSGCK                                                       
         SETMSG 'No message.'                                                   
*                                                                               
         IF    (CPCMNM,EQ,'A'),BEGIN  Show amessage...                          
         LA    R6,CVAMSGCK                                                      
         SETMSG 'No accounting message.'                                        
         END                                                                    
*                                                                               
         IF    (CPCMNM,EQ,'U'),BEGIN  Show umessage...                          
         LA    R6,CVUMSGCK                                                      
         SETMSG 'No user message.'                                              
         END                                                                    
*                                                                               
         IF    (CPCMNM,EQ,'V'),BEGIN  Show vmessage...                          
         LA    R6,CVVMSGCK                                                      
         SETMSG 'No View message.'                                              
         END                                                                    
*                                                                               
         OC    @R6+4(L'CVMSG),@R6+4                                             
         IF    Z,BEGIN                                                          
         IF    ((CPCMNM,EQ,'M'),AND,(CVUMSG,NZ)),SHOWUMSG                       
         IF    CPFTYPED,CVNXTMSG                                                
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         L     R0,@R6                                                           
         CLEAR R1,R3                                                            
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0)                                                        
         XPOP  ,,30                                                             
         TSEG  CVBLANKS,2                                                       
         SETMSG @R6+4,L'CVMSG                                                   
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),WR                                                     
         BNZ   CVABORT                                                          
*                                                                               
         IF    ((CPCMNM,EQ,'M'),AND,(CVUMSG,NZ)),BEGIN                          
SHOWUMSG VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         L     R0,CVUMSGCK                                                      
         CLEAR R1,R3                                                            
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0)                                                        
         XPOP  ,,30                                                             
         TSEG  CVBLANKS,2                                                       
         SETMSG CVUMSG                                                          
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),WR        Also give user message                       
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
         TITLE 'SET/SHOW WORD Commands'                                         
WORDWA   RECORD BEGIN                                                           
WORDFLAG FLAG                                                                   
         FLAG  WORDFSYS            - Allow systems account                      
*                                                                               
WORDNAME DS    CL8                 Word                                         
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETWORD -- SET WORD command  (priv'd).                                       
*                                                                               
SETWORD  PROC  WORDWA                                                           
         LA    R6,WORDWA                                                        
         USING WORDWA,R6                                                        
         CLEAR WORDWA                                                           
*                                                                               
         IF    (CPSFSPR+CPSFOPR,Z),'VCALL NOTVALID'  Priv'd                     
*                                                                               
         SCAN  ,                                                                
         SCANCHK ,                                                              
         IF    (R0,NZ),BEGIN            Word given...                           
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"')),'VCALL NOTVALID'                 
         IF    (@R1,EQ,'('),'VCALL NOTVALID'                                    
         SCUPCASE WORDNAME         Save upper cased token                       
*                                                                               
         SET   WORDFSYS            Assume systems allowed                       
         SCAN  WORDPRT                                                          
         SCANCHK                                                                
         END                                                                    
*                                                                               
         CLEAR R2                  Assume breaks not needed                     
         IF    ((CVWORD,Z),AND,(WORDNAME,NZ)),'LA R2,1'                         
         IF    ((CVWORD,NZ),AND,(WORDNAME,Z)),'LA R2,1'                         
         IF    (CVFSYST,AND,^WORDFSYS),'LA R2,1'                                
         IF    (^CVFSYST,AND,WORDFSYS),'LA R2,1'                                
*                                                                               
         MVC   CVWORD,WORDNAME     Set word                                     
         CLEAR CVFSYST                                                          
         IF    WORDFSYS,'SET CVFSYST'                                           
         ACALL UPDWORD             Update word in SCIPCVT                       
*                                                                               
         IF    (R2,NZ),'ACALL BRKLGN'  halt logon reads if needed               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
WORDPRT  OPTION SYSTEMS,SET,A,WORDFSYS                                          
         OPTION NOSYSTEMS,CLEAR,A,WORDFSYS                                      
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         DROP  R6                                                               
         AIF   (&$PCODE).NULWORD                                                
         EJECT                                                                  
*box                                                                            
*                                                                               
*  UPDWORD -- Local routine to update the word in the SCIPCVT,                  
*    if possible.                                                               
*                                                                               
UPDWORD  PROC                                                                   
         IF    ^CVFTEST,BEGIN      Only for production...                       
         L     R6,CVTPTR                                                        
         WITH  (CVT,R6),'L R5,CVTUSER'                                          
         IF    (R5,NZ),BEGIN                                                    
         WITH  (USERCVT,R5)                                                     
         IF    (USERCVT,EQ,'SCIP'),BEGIN                                        
         MODESET KEY=ZERO          ********                                     
         MVC   USEWORD,CVWORD      Update system WORD                           
         IF    CVFSYST,'SET USEHSPFL.HSPFSYST'  allow systems                   
         MODESET KEY=NZERO         ********                                     
         END                                                                    
         END                                                                    
         END                                                                    
         PEND                                                                   
         AGO   .ENDWORD                                                         
.NULWORD ANOP                                                                   
UPDWORD  PROC                                                                   
         B     CVNEXT                                                           
         PEND                                                                   
.ENDWORD ANOP                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  BRKLGN -- Local routine to halt logon reads because something                
*    has changed.                                                               
*                                                                               
BRKLGN   PROC                                                                   
         L     R6,CVFJCB                                                        
         LOOP  BEGIN                                                            
         WITH  (JCB,R6)                                                         
         IF    (JCBACCT,Z),BEGIN   In logon process...                          
         IF    JCBWFSO,EXIT        Not logged on, scram                         
         IF    JCBBFPS,EXIT        psuedo sessions don't count                  
         LH    R0,JCBSEQ           Session number                               
         VCALL TBREAK              Halt read                                    
         END                                                                    
         LA    R6,JCBNEXT                                                       
         UNTIL (R6,GE,CVLJCB),END                                               
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWORD -- SHOW WORD command  (priv'd).                                     
*                                                                               
SHOWWORD PROC                                                                   
         IF    (CPSFSPR+CPSFOPR,Z),'VCALL NOTVALID'  priv'd                     
*                                                                               
         SCAN  SWORDPRT                                                         
         SCANCHK                                                                
*                                                                               
         IF    (CVWORD,Z),'SETMSG "No word."'                                   
*                                                                               
         ELSE  BEGIN                                                            
         TSEG  CVWORD,,TB                                                       
         TSEG  'is the word'                                                    
         IF    ^CVFSYST,'TSEG " (Nosys)"'                                       
         SETMSG '.'                                                             
         END                                                                    
*                                                                               
         B     CVNXTMSG                                                         
         PEND                                                                   
*                                                                               
*                                                                               
*                                                                               
SWORDPRT SCKW  MILTEN,V(SCNNOOP)                                                
         SCKW  WYLBUR,V(SCNNOOP)                                                
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         QLTORG                                                                 
         TITLE 'SET WBACKUP -- Set volume backup status'                        
SETWBWRK RECORD BEGIN                                                           
SETWBONT DS    CL5                 - Online time                                
         DS    CL21                - Pad SETWBONT to 26 chars                   
         DS    CL6                 - Add another 6 for new FMTCLCK              
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
* SET WBACKUP -- Set WYLBUR volume(s) for backup                                
*                                                                               
SETWBKUP PROC  SETWBWRK                                                         
         LA    R6,SETWBWRK                                                      
         USING SETWBWRK,R6                                                      
         IF    (^CPSFSPR,AND,^CPSFOPR),'VCALL NOTVALID'   Naugty                
         CLEAR SETWBWRK            Clear work area                              
         CLEAR R4                  Clear volume count                           
*                                                                               
         LOOP  BEGIN                                                            
         SCAN  ,                   Pick up a volser                             
         SCANCHK ,                                                              
         IF    (R0,Z),BEGIN                                                     
         IF    (R4,Z),CVABSENT     Nothing                                      
         B     CVNEXT              End of list                                  
         END                                                                    
         IF    ((@R15,GE,'0'),AND,(@R15,LE,'9')),BEGIN                          
         VCALL DTB                 Convert minutes to binary                    
         IF    (R0,NZ),BEGIN       Invalid number ...                           
         TSEG  (R1),(R0)                                                        
         TSEG  ': Invalid digit -- Operand ignored.',,WR                        
         END   ELSE,BEGIN                                                       
         IF    (R15,Z),BEGIN       Zero - clear the time                        
         CLEAR SETWBONT            Clear back-online time                       
         END   ELSE,BEGIN          Non-zero value ...                           
         LR    R5,R15              Copy value into work reg                     
         MH    R5,=H'60'           Convert minutes to seconds                   
         VCALL LOCALTOD            Get TOD clock value                          
         AR    R0,R5               Add in minutes specified                     
         LA    R15,SETWBONT        R15 -> String format area                    
         VCALL FMTCLCK             Format HH:MM                                 
         END                                                                    
         END                                                                    
         END   ELSE,BEGIN          Assume its a volser ...                      
         LA    R4,@R4+1            Count the volume                             
         ACALL TAGBKUP             Tag the backup volume                        
         END                                                                    
         END                                                                    
         B     CVNEXT              Just to be safe ...                          
         PEND                                                                   
*                                                                               
TAGBKUP  PROC                                                                   
         L     R3,CVVOLIST         Load pointer to volume table                 
         USING VOLDSECT,R3                                                      
         WHILE (VNAME,NE,@R15),BEGIN                                            
         LA    R3,VOLENTSZ(R3)     Skip to next entry ...                       
         IF    (VOLDSECT,EQ,X'FF'),BEGIN                                        
         TSEG  (R1),(R0),B                                                      
         TSEG  ': Ignored -- volume not found',,WR                              
         B     TAGBKUPX            Return with no action                        
         END                                                                    
         END                                                                    
         IF    ^VFLG3.VF3BKUP,BEGIN                                             
         SET   VFLG3.VF3BKUP                                                    
         MVC   VOLONTIM,SETWBONT   Move in current back-online time             
         INCR  R1,CVBKUPCT         Increment global backup count                
         END   ELSE,BEGIN                                                       
         TSEG  (R1),(R0)                                                        
         TSEG  ': Ignored -- volume already marked for backup',,WR              
         END                                                                    
TAGBKUPX PEND                                                                   
*                                                                               
         DROP  R3                                                               
         DROP  R6                                                               
         TITLE 'CLEAR WBACKUP -- Clear volume backup status'                    
*box                                                                            
*                                                                               
* CLEAR WBACKUP -- Reset WYLBUR volume(s) backup status                         
*                                                                               
CLRWBKUP PROC                                                                   
         IF    (^CPSFSPR,AND,^CPSFOPR),'VCALL NOTVALID'   Naugty                
         CLEAR R4                  Clear volume count                           
*                                                                               
         LOOP  BEGIN                                                            
         SCAN  ,                   Pick up a volser                             
         SCANCHK                                                                
         IF    (R0,Z),BEGIN                                                     
         IF    (R4,Z),CVABSENT     Nothing                                      
         B     CVNEXT              End of list                                  
         END                                                                    
         LA    R4,@R4+1            Count the volume                             
         ACALL UTAGBKUP            Un-Tag the backup volume                     
         END                                                                    
         B     CVNEXT              Just to be safe ...                          
         PEND                                                                   
*                                                                               
UTAGBKUP PROC                                                                   
         L     R3,CVVOLIST         Load pointer to volume table                 
         USING VOLDSECT,R3                                                      
         WHILE (VNAME,NE,@R15),BEGIN                                            
         LA    R3,VOLENTSZ(R3)     Skip to next entry ...                       
         IF    (VOLDSECT,EQ,X'FF'),BEGIN                                        
         TSEG  (R1),(R0),B                                                      
         TSEG  ': Ignored -- volume not found',,WR                              
         B     UTAGBKPX            Return with no action                        
         END                                                                    
         END                                                                    
         IF    VFLG3.VF3BKUP,BEGIN                                              
         CLEAR VFLG3.VF3BKUP       Reset backup status                          
         CLEAR VOLONTIM            Reset back-online time                       
         DECR  R1,CVBKUPCT         Decrement global backup count                
         END   ELSE,BEGIN                                                       
         TSEG  (R1),(R0)                                                        
         TSEG  ': Ignored -- volume not marked for backup',,WR                  
         END                                                                    
UTAGBKPX PEND                                                                   
*                                                                               
         DROP  R3                                                               
         TITLE 'SHOWBKUP -- Show volumes in backup status'                      
*box                                                                            
*                                                                               
* SHOWBKUP -- Display volumes in backup status                                  
*                                                                               
SHOWBKUP XPROC                                                                  
         IF    (CVBKUPCT,NZ),BEGIN                                              
         CLEAR R4                  Clear heading flag                           
         L     R3,CVVOLIST         Load pointer to volume table                 
         USING VOLDSECT,R3                                                      
         WHILE (VOLDSECT,NE,X'FF'),BEGIN                                        
         IF    ^VFLG3.VF3BKUP,SHOBKNXT                                          
         IF    (VOLUCBAD,Z),SHOBKNXT                                            
         IF    (VFLG1.VF1PRIV,OR,^VFLG3.VF3SHOW),BEGIN                          
         IF    (CPSFSPR+CPSFOPR,Z),SHOBKNXT                                     
         END                                                                    
         IF    ^VFLG1.VF1AVAIL,SHOBKNXT                                         
         IF    (R4,Z),BEGIN        Need heading ...                             
         TSEG  'The following online volumes are being backed up:'              
         TCR                                                                    
         END                                                                    
         TSEG  CVBLANKS,4          Indent volsers                               
         TSEG  VNAME,,B            Plant the volser                             
         IF    (VOLONTIM,NZ),BEGIN                                              
         TSEG  '   (Back online by',,B                                          
         TSEG  VOLONTIM                                                         
         TSEG  ')'                                                              
         END   ,                                                                
         TCR                       Add a carriage return                        
         INCR  R4                  We put out one volume                        
SHOBKNXT LA    R3,VOLENTSZ(R3)     Skip to next entry ...                       
         END                                                                    
         IF    (R4,NZ),BEGIN       Double check ...                             
         TSEG  'Datasets on these volumes are inaccessible until',,B            
         TSEG  'the backup process ends.'                                       
         TCR                                                                    
         TSEG  ' ',,WR             Add a blank line for readability             
         END                                                                    
         END                                                                    
         PEND                                                                   
*                                                                               
         DROP  R3                                                               
*                                                                               
         VLTORG                                                                 
         END   .                                                                
