TOPS     TITLE 'WYLBUR''s Terminal Option Commands'                             
*******************************************************************             
*                                                                 *             
*     WYLBUR/370 - Release VI - Class I - Stanford Proprietary    *             
*                                                                 *             
*******************************************************************             
         HIBAL                                                                  
*                                                                               
WYLTOPS  CSECT                                                                  
TOPS     IDENT 2025                11:49:36 01/25/02  (SLP)                     
         REGS  FSR,,,,,,,BR,(WAR,LSR),PAR,PBR,CPR,CVR,SPR,RAR                   
         SPACE 2                                                                
         SYSDEFN ,                 Define installation params                   
*                                                                               
         PUSH  DSECTS                                                           
         COPY  CONTROL                                                          
*                                                                               
         COPY  SYSDSNS                                                          
         TITLE 'DSECTS'                                                         
JCB      RECORD BEGIN                                                           
         COPY  JCB                                                              
         END                                                                    
*                                                                               
         POP   DSECTS                                                           
         EJECT                                                                  
PDB      RECORD 'PDB'                                                           
         EJECT                                                                  
         RECORD 'MIB'                                                           
         EJECT                                                                  
         COPY  FSB                                                              
         EJECT                                                                  
         COPY  FDB                                                              
         EJECT                                                                  
         COPY  PSB                                                              
         EJECT                                                                  
         COPY  SSB                                                              
         EJECT                                                                  
         RECORD 'SIB'                                                           
         EJECT                                                                  
         COPY  TRANGE                                                           
         TITLE 'Terminal Type Table Update Routine'                             
STYPWA   RECORD BEGIN                                                           
STYPFLAG FLAG                                                                   
*                                                                               
STYPQH   DS    A                   New TTYPE queue head ptr                     
STYPQT   DS    A                   New TTYPE queue tail ptr                     
*                                                                               
SINITQT  DS    A                   TTYPE "init text" queue tail                 
*                                                                               
STTYPE   DS    XL(L'TTYPE)         Working TYP entry                            
*                                                                               
STYPLINE DS    CL(&LINESZ)         Working line buffer                          
STYPSKIP DS    XL256               Scan skip chars                              
STYPSTOP DS    XL256               Scan stop chars                              
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETWTRM -- SET WTERMINAL Command.  (Priv'd.)                                 
*                                                                               
*    NOTE:  THIS ROUTINE IS NOT ENTERD AFTER SAVE OF TERMINAL                   
*           FILE.... THAT WAS A YUCK !!                                         
*    Note:  This routine is also called after a successful save                 
*           of "TERMINAL ACCOUNT GS.WYL".                                       
*                                                                               
SETWTERM XPROC STYPWA                                                           
         CLEAR STYPWA                                                           
         LA    R6,STYPWA                                                        
         ST    R6,CPCWA                                                         
*                                                                               
         IF    (CPCMNM,NE,'W'),BEGIN  Entered after SAVE...                     
         TCCR                                                                   
         TSEG  'Type SET WTERMINAL to reset terminal tables.'                   
         B     CVNEXT                                                           
         END                                                                    
         ELSE  BEGIN               Command entry...                             
         IF    ^CPSFSPR,'VCALL NOTVALID'   Sorry pal                            
         END                                                                    
*                                                                               
         AIF   (&$PCODE).RDACT     *** PCODE                                    
         LA    R0,SDSNTERM         Want TERMINAL dsn                            
         VCALL EXIT0               LOCAL exit - format system dsname            
         SCINIT (R1),(R0)                                                       
         VCALL DOFNAME                                                          
         VCALL FNAMOPTS            SCAN FILE NAME, FILE OPTIONS                 
         SCANCHK                                                                
         VCALL FNAMEFIN                                                         
*                                                                               
         SET   CPLFLG1.CPFALL                                                   
         SET   CPFRDEXT                                                         
         VCALL NDETRNG                                                          
*                                                                               
         VCALL EXTOPEN             Open the file                                
         IF    (R15,NZ),CVNEXT                                                  
*                                                                               
         COMMENT                   PROCESS RANGE                                
         RDRNG STYPRTN,(DESRTRN+LXCATRTN+UNPRST)                                
*                                                                               
         VCALL EXTCLOSE            All done                                     
         AGO   .RDDONE             *** PCODE                                    
.RDACT   ANOP  ,                   *** PCODE                                    
* if elf read terminal info from active for now                                 
         SCCLR                                                                  
         SET   CPLFLG1.CPFALL                                                   
         VCALL NDETRNG                                                          
         RDRNG STYPRTN,(DESRTRN+LOCATRTN+UNPRST)                                
.RDDONE  ANOP  ,                   *** PCODE                                    
*-                                                                              
*-       Now do post-processing.                                                
*-                                                                              
         IF    (STYPQH,Z),BEGIN    Nothing there...                             
         IF    CVFINIT,EXIT                                                     
         TCCR                                                                   
         TSEG  'No terminal types defined.',,CR                                 
         END                                                                    
*-                                                                              
*-       Make new TTYPE table the system default.                               
*-                                                                              
         L     R5,CVTTYQH          Save old table ptr                           
         MVC   CVTTYQH,STYPQH      Make new version available                   
*-                                                                              
*-       Release old TTYPE table.                                               
*-                                                                              
         WHILE (R5,NZ),BEGIN       Freemain each entry...                       
         WITH  (TTYPE,R5)                                                       
         L     R4,TTYLINK                                                       
*                                                                               
         SET   TTYFREL             Released when entry is unused                
         IF    (TTYUSE,Z),BEGIN    Free it now...                               
*-                                                                              
*-       Release init write text.                                               
*-                                                                              
         L     R3,TTYINITQ                                                      
         WHILE (R3,NZ),BEGIN       Free "init text"...                          
         L     R2,@R3              Get next "init text" entry ptr               
         SETMSG (R3),LH:@R3+4                                                   
         MVC   @R3(4),=F'-1'       (Neatness)                                   
*        FREEMAIN R,A=(1),LV=(0)   Free text entry                              
         VCALL FREECORE                                                         
         LR    R3,R2                                                            
         END                                                                    
*-                                                                              
*-       Release TTYPE entry.                                                   
*-                                                                              
         CLEAR TTYPE               (Neatness)                                   
         LR    R1,R5                                                            
*        FREEMAIN R,A=(R1),LV=L'TTYPE                                           
         VCALL FREECORE                                                         
         END                                                                    
*                                                                               
         LR    R5,R4                                                            
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  STYPRTN -- Co-routine to process lines from the TERMINAL file.               
*                                                                               
*    On entry:                                                                  
*      R1,R0 - line loc, len                                                    
*                                                                               
STYPRTN  PROC                                                                   
         L     R6,CPCWA                                                         
         USING STYPWA,R6                                                        
*                                                                               
         LA    R5,STTYPE                                                        
         USING TTYPE,R5                                                         
*                                                                               
         COMMENT                   SAVE LINE                                    
         CEIL  R0,L'STYPLINE                                                    
         LR    R15,R0                                                           
         MOVE  R15,STYPLINE,@R1                                                 
*                                                                               
         COMMENT                   SCAN LINE                                    
         SCINIT STYPLINE,(R0)      Input line                                   
         SCAN  STYPPRT                                                          
         IF    (R15,NZ),BEGIN                                                   
         ACALL STYPINV                                                          
         END                                                                    
         PEND                                                                   
*                                                                               
*                                                                               
STYPTERM PROC                                                                   
         SCANSTR ,                 SCAN FOR TERMINAL NAME                       
         BNZ   STYPTERR                                                         
         IF    (R0,Z),STYPTERR                                                  
         CLEAR TTYPE                                                            
         LA    R2,TTYINITQ                                                      
         ST    R2,SINITQT          Reset "init text" queue tail                 
         SCUPTOK R1                                                             
         MVC   TTYNAME,@R1         Save terminal name                           
         MVC   TTYTCLS,@R1         Save generic terminal class                  
         LA    R3,1                                                             
         LA    R4,TTYNAME+L'TTYNAME                                             
STYPTLP  SCANSTR ,                 SCAN FOR TERMINAL NAME ALIASES               
         BNZ   STYPTERR                                                         
         SCUPTOK R15                                                            
         IF    (R0,Z),STYPTOK                                                   
         IF    (@R15,EQ,'BEGIN'),STYPTOK  End of terminal list                  
         IF    (R3,GE,TTYMAX#),STYPTERR  Too many names                         
         MVC   @R4(L'TTYNAME),@R15                                              
         LA    R4,@R4+L'TTYNAME                                                 
         LA    R3,@R3+1                                                         
         B     STYPTLP                                                          
STYPTERR LA    R15,4                                                            
         B     STYPTDON                                                         
STYPTOK  CLEAR R15                                                              
         B     STYPTDON                                                         
STYPTDON LABEL                                                                  
         PEND                                                                   
*                                                                               
*                                                                               
STYPTCLS PROC                                                                   
         SCANSTR ,                                                              
         IF    ((R15,Z),AND,(R0,NZ)),BEGIN                                      
         SCUPTOK R1                                                             
         MVC   TTYTCLS,@R1                                                      
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,4               IF ERROR                                     
         END                                                                    
         PEND                                                                   
*                                                                               
*                                                                               
STYPINIT PROC                                                                   
         SCUPTOK R2                                                             
         IF    ((R0,EQ,1),AND,(@R2,EQ,'X')),BEGIN  X'hex'...                    
         SCAN                                                                   
         IF    (R15,NZ),STYPIERR                                                
         VCALL HEXCONV             Convert hex string in place                  
         BNP   STYPIERR            Trouble, skip it                             
         END                                                                    
*                                                                               
         ELSE  BEGIN               Dequote regular string...                    
         VCALL DEQUOTE                                                          
         BNP   STYPIERR            Trouble, skip it                             
         END                                                                    
*                                                                               
         AH    R0,=H'8'            Include prefix length                        
         LR    R3,R1               Save string loc                              
         LR    R2,R0               ... and len                                  
*        GETMAIN R,LV=(0)          Get room for string text                     
         VCALL GETCORE                                                          
         L     R15,SINITQT                                                      
         ST    R1,@R15             Link prev entry to us                        
         ST    R1,SINITQT          We are the new tail                          
         CLEAR (@R1,8)             Clear the prefix                             
         STH   R2,@R1+4            Save length                                  
         SH    R2,=H'8'            Deduct prefix length                         
         MOVEL @R1+8,@R3,(R2)      Save the string text                         
         B     STYPIOK                                                          
STYPIERR LA    R15,4                                                            
         B     STYPIDON                                                         
STYPIOK  CLEAR R15                                                              
         B     STYPIDON                                                         
STYPIDON LABEL                                                                  
         PEND                                                                   
*                                                                               
STYPHEI  PROC                                                                   
         STH   R0,TTYHEI           Save height                                  
         PEND                                                                   
*                                                                               
STYPWID  PROC                                                                   
         STH   R0,TTYWID           Save width                                   
         CLEAR TTYAWID             Assume no alternate width                    
         SCAN                                                                   
         IF    (R15,NZ),' EXIT STYPWID'                                         
         IF    (R0,NZ),BEGIN                                                    
         DTB   (R1),(R0)                                                        
         IF    Z,BEGIN                                                          
         STH   R15,TTYAWID         Save alternate width                         
         END                                                                    
         ELSE  BEGIN                                                            
         SCBKUP ,                                                               
         END                                                                    
         END                                                                    
         CLEAR R15                                                              
         PEND ,                                                                 
*                                                                               
STYPMOD  PROC                                                                   
         SET   TTYFMOD                                                          
         PEND                                                                   
*                                                                               
STYPNMOD PROC                                                                   
         CLEAR TTYFMOD                                                          
         PEND                                                                   
*                                                                               
STYPVTAM PROC                                                                   
         SET   TTYFVTAM                                                         
         PEND                                                                   
*                                                                               
STYPSAM  PROC                                                                   
         SET   TTYFSAM                                                          
         PEND                                                                   
*                                                                               
STYPNSAM PROC                                                                   
         CLEAR TTYFSAM                                                          
         PEND                                                                   
*                                                                               
STYPSCR  PROC                                                                   
         SET   TTYFSCR                                                          
         CLEAR TTYFQSCR                                                         
         PEND                                                                   
*                                                                               
STYPQSCR PROC                                                                   
         SET   TTYFQSCR                                                         
         CLEAR TTYFSCR                                                          
         PEND                                                                   
*                                                                               
STYPNSCR PROC                                                                   
         CLEAR TTYFSCR+TTYFQSCR                                                 
         PEND                                                                   
*                                                                               
STYPNORM PROC                                                                   
         SCDQUOTE TTYNORM,L'TTYNORM                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPBOLD PROC                                                                   
         SCDQUOTE TTYBOLD,L'TTYBOLD                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPMSG  PROC                                                                   
         SCDQUOTE TTYMSG,L'TTYMSG                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPERR  PROC                                                                   
         SCDQUOTE TTYERR,L'TTYERR                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPNEW  PROC                                                                   
         SCDQUOTE TTYNEW,L'TTYNEW                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPMARK PROC                                                                   
         SCDQUOTE TTYMARK,L'TTYMARK                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPOPT  PROC                                                                   
         SCDQUOTE TTYOPT,L'TTYOPT                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPDIM  PROC                                                                   
         SCDQUOTE TTYDIM,L'TTYDIM                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPSTAT PROC                                                                   
         SCDQUOTE TTYSTAT,L'TTYSTAT                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPPF   PROC                                                                   
         SCDQUOTE TTYPF,L'TTYPF                                                 
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPPFHI PROC                                                                   
         SCDQUOTE TTYPFHI,L'TTYPFHI                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPCOL  PROC                                                                   
         SCDQUOTE TTYCOL,L'TTYCOL                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPCOLT PROC                                                                   
         SCDQUOTE TTYCOLT,L'TTYCOLT                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPCOLR PROC                                                                   
         SET   TTYFCOLOR                                                        
         PEND                                                                   
*                                                                               
STYPLNOR PROC                                                                   
         SCDQUOTE TTYLNORM,L'TTYLNORM                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPLCOL PROC                                                                   
         SCDQUOTE TTYLCOL,L'TTYLCOL                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPLDIM PROC                                                                   
         SCDQUOTE TTYLDIM,L'TTYLDIM                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPLMAR PROC                                                                   
         SCDQUOTE TTYLMARK,L'TTYLMARK                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPLNEW PROC                                                                   
         SCDQUOTE TTYLNEW,L'TTYLNEW                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPCOLM PROC                                                                   
         SCDQUOTE TTYCOLM,L'TTYCOLM                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPSPEL PROC                                                                   
         SCDQUOTE TTYSPELL,L'TTYSPELL                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPFMRK PROC                                                                   
         SET   TTYFMARK                                                         
         PEND                                                                   
*                                                                               
STYPCMD  PROC                                                                   
         SCDQUOTE TTYCMD,L'TTYCMD                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPBACK PROC                                                                   
         SCDQUOTE TTYBACK,L'TTYBACK                                             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
*                                                                               
*                                                                               
*                                                                               
STYPEND  PROC                                                                   
         L     R0,=A(L'TTYPE)                                                   
*        GETMAIN R,LV=(0)                                                       
         VCALL GETCORE                                                          
         LR    R2,R1               Newly getmained TTYPE entry ptr              
         MOVEL @R2,STTYPE,L'TTYPE  Save new TTYPE entry                         
         IF    (STYPQH,Z),'ST R2,STYPQH; ST R2,STYPQT'  First                   
         ELSE  BEGIN                                                            
         L     R15,STYPQT                                                       
         WITH  (TTYPE,R15),'ST R2,TTYLINK'  Link us to last entry               
         ST    R2,STYPQT                                                        
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
STYPBAD  PROC                                                                   
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
STYPINV  PROC                                                                   
         TSEG  (R1),(R0)                                                        
         TSEG  ': unrecognized option (on line '                                
         L     R0,CPLCNO                                                        
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ')',,WR                                                          
         PEND                                                                   
*                                                                               
         DROP  TTYPE                                                            
         DROP  STYPWA                                                           
         EJECT                                                                  
         QLTORG                                                                 
         EJECT                                                                  
STYPPRT  SCKW  TERMINAL,STYPTERM,A                                              
         SCKW  TCLASS,STYPTCLS,A                                                
         SCKW  INITIALIZE,STYPINIT,(A,P)                                        
         SCKW  WIDTH,STYPWID,(A,P,I),255                                        
         SCKW  HEIGHT,STYPHEI,(A,P,I),255                                       
         SCKW  MODEL,STYPMOD,A                                                  
         SCKW  NOMODEL,STYPNMOD,A                                               
         SCKW  VTAM,STYPVTAM                                                    
         SCKW  SAMSON,STYPSAM,A                                                 
         SCKW  NOSAMSON,STYPNSAM,A                                              
         SCKW  SCROLL,STYPSCR,A                                                 
         SCKW  QSCROLL,STYPQSCR,A                                               
         SCKW  NOSCROLL,STYPNSCR,A                                              
         SCKW  NORMAL,STYPNORM,(A,P)                                            
         SCKW  BOLD,STYPBOLD,(A,P)                                              
         SCKW  MESSAGE,STYPMSG,(A,P)                                            
         SCKW  MSG,STYPMSG,P                                                    
         SCKW  ERROR,STYPERR,(A,P)                                              
         SCKW  NEW,STYPNEW,(A,P)                                                
         SCKW  MARKED,STYPMARK,(A,P)                                            
         SCKW  LNORMAL,STYPLNOR,(A,P)                                           
         SCKW  LCOLLECT,STYPLCOL,(A,P)                                          
         SCKW  LDIM,STYPLDIM,(A,P)                                              
         SCKW  LMARKED,STYPLMAR,(A,P)                                           
         SCKW  LNEW,STYPLNEW,(A,P)                                              
         SCKW  OPTION,STYPOPT,(A,P)                                             
         SCKW  DIM,STYPDIM,(A,P)                                                
         SCKW  STATUS,STYPSTAT,(A,P)                                            
         SCKW  PF,STYPPF,(A,P)                                                  
         SCKW  PFHIGH,STYPPFHI,(A,P)                                            
         SCKW  COLUMN,STYPCOL,(A,P)                                             
         SCKW  COLTAB,STYPCOLT,(A,P)                                            
         SCKW  COLMARGIN,STYPCOLM,(A,P)                                         
         SCKW  COLOR,STYPCOLR,A                                                 
         SCKW  SPELL,STYPSPEL,(A,P)                                             
         SCKW  FMARKED,STYPFMRK,A                                               
         SCKW  COMMAND,STYPCMD,(A,P)                                            
         SCKW  BACKGROUND,STYPBACK,(A,P)                                        
         SCKW  END,STYPEND  ,                                                   
         SCKW  ,STYPBAD                                                         
         AIF   (&$PCODE).NOSUBS    *** PCODE                                    
         TITLE 'SUBSYS Command'                                                 
*box                                                                            
*                                                                               
*  SUBSYS -- SUBSYS command.                                                    
*                                                                               
SBSWA    RECORD BEGIN                                                           
SBSNAME  DS    CL8                 Subsystem name                               
         END                                                                    
*-                                                                              
SUBSYS   XPROC SBSWA                                                            
         IF    (CPCMNM,EQ,'SUB'),BEGIN                                          
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
         END                                                                    
*                                                                               
         SCUPCASE SBSNAME,L'SBSNAME                                             
         IF    (SBSNAME,EQ,'MILTEN'),'VCALL NOTVALID'                           
         IF    (SBSNAME,EQ,'ORVYL'),'VCALL NOTVALID'                            
         IF    (SBSNAME,EQ,'#'),'VCALL NOTVALID'                                
*-                                                                              
*-       Check to see if we are already in the target subsystem.                
*-                                                                              
         IF    (SBSNAME,EQ,CVWYLSSN),BEGIN                                      
         TSEG  'You are already in '                                            
         TSEG  SBSNAME,,T                                                       
         ERROR '.  No action taken.',,OURSYS                                    
         B     CVNXTMSG                                                         
         END                                                                    
*-                                                                              
*-       Check to see if the target subsystem is running.                       
*-                                                                              
         LA    R1,SBSNAME                                                       
         VCALL SYSCHECK            Is it running?                               
         IF    NZ,BEGIN            No...                                        
         TSEG  SBSNAME,,TB                                                      
         ERROR 'is not available.',,NOSYS                                       
         END                                                                    
*-                                                                              
*-       Pass whatever else is on the line as a parm to the                     
*-         subsystem.                                                           
*-                                                                              
         SCINFO ,                                                               
         WHILE ((R0,POS),AND,(@R1,EQ,' ')),'LA R1,@R1+1; DECR R0'               
         TSEG  (R1),(R0)           Pass                                         
*-                                                                              
*-       Transfer control to other subsystem.                                   
*-                                                                              
         TXCTL SBSNAME             Transfer to the other subsystem              
******                                                                          
******   Wait here until the other subsystem returns to us.                     
******                                                                          
*-                                                                              
*-       Handle a response from ORVYL a little differently.                     
*-         Since this is the completion from a SUBSYS command                   
*-         we should never be getting a request from ORVYL here.                
*-                                                                              
         IF    (CPSYS,EQ,CPORVYL),'VCALL ORVRQST'  Handle ORVYL                 
*-                                                                              
*-       General transfer control completion.                                   
*-                                                                              
         IF    (CPSYS,EQ,'MILTEN  '),'CLEAR CPSYS'                              
         MVC   CPORGSYS,CPSYS      Save originating subsystem                   
*                                                                               
         IF    (R0,NZ),'VCALL EDTCOMMV'  Execute new command                    
         B     CVNEXT                                                           
         PEND                                                                   
         TITLE 'XCTL Command'                                                   
*box                                                                            
*                                                                               
*  XCTL -- Logoff and transfer control to a different subsystem.                
*                                                                               
XCTLWA   RECORD BEGIN                                                           
XCTLNAME DS    CL8                 Subsystem name                               
         END                                                                    
*-                                                                              
XCTL     XPROC XCTLWA                                                           
*                                                                               
         IF    (CPCMNM,EQ,'XCT'),BEGIN                                          
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
         END                                                                    
*-                                                                              
*-       Check for special subsystem names and block entry.                     
*-                                                                              
         SCUPCASE XCTLNAME,L'XCTLNAME                                           
*                                                                               
         IF    (XCTLNAME,EQ,'MILTEN'),'VCALL NOTVALID'                          
         IF    (XCTLNAME,EQ,'ORVYL'),'VCALL NOTVALID'                           
         IF    (XCTLNAME,EQ,'#'),'VCALL NOTVALID'                               
*-                                                                              
*-       Check to see if we are already in the target subsystem.                
*-                                                                              
         IF    (XCTLNAME,EQ,CVWYLSSN),BEGIN                                     
         TSEG  'You are already in '                                            
         TSEG  XCTLNAME,,T                                                      
         ERROR '.  No action taken.',,OURSYS                                    
         END                                                                    
*-                                                                              
*-       Check to see if the target subsystem is running.                       
*-                                                                              
         LA    R1,XCTLNAME                                                      
         VCALL SYSCHECK            Is it running?                               
         IF    NZ,BEGIN            No...                                        
         TSEG  XCTLNAME,,TB                                                     
         ERROR 'is not available.',,NOSYS                                       
         END                                                                    
*-                                                                              
*-       Don't allow a user to hop out of WYLBUR before logging                 
*-         on if a system word is set.                                          
*-                                                                              
         IF    ((CPSACCT,Z),AND,(CVWORD,NZ)),CVABORT                            
*                                                                               
ALLOWX   LABEL                                                                  
*-                                                                              
*-       Make sure the Active files are cleared.                                
*-                                                                              
         VCALL CLRACTS             Clear Actives                                
*-                                                                              
*-       Pass whatever else is on the line as a parm to the                     
*-         subsystem.                                                           
*-                                                                              
         SCINFO ,                                                               
         WHILE ((R0,POS),AND,(@R1,EQ,' ')),'LA R1,@R1+1; DECR R0'               
         TSEG  (R1),(R0)           Pass                                         
*-                                                                              
*-       Set new subsystem to get control.                                      
*-                                                                              
         MVC   CPLGFSYS,XCTLNAME   New subsystem name                           
*                                                                               
         L     R15,CVCURJCB                                                     
         WITH  (JCB,R15),'SET JCBAFALO'  Logging off                            
         B     CVNEXT              Change subsystems                            
*                                                                               
         PEND                                                                   
*                                                                               
.NOSUBS  ANOP  ,                   *** PCODE                                    
         QLTORG                                                                 
         TITLE 'SET/SHOW TERMINAL Commands'                                     
*box                                                                            
*                                                                               
*  SETMIL -- SET <terminal options> command.                                    
*                                                                               
*  BACKUP AND PASS OPTION TO 'SET TERMINAL'                                     
*  (EG. SET WID XXX, WE PASS THE 'WID XXX' PART                                 
*   TO THE SET TERMINAL ROUTINE. THUS IT LOOKS                                  
*   LIKE 'SET TERMINAL WID XXX'                                                 
*                                                                               
SETMIL   XPROC  ,                                                               
         SCBKUP                                                                 
*                                                                               
*  SIMPLIFY !!                                                                  
*                                                                               
*        SCPUSH                                                                 
*                                                                               
*        SCUPTOK R1                                                             
*        IF    (@R1,EQ,'CAS'),BEGIN  Set case...                                
*        SCAN                                                                   
*        SCANCHK                                                                
*        IF    (R0,Z),CVABSENT                                                  
*        END                                                                    
*                                                                               
*        SCAN  SETMPRT                                                          
*        SCANCHK                                                                
*        IF    (R0,NZ),'VCALL NOTVALID'                                         
*                                                                               
*        SCPOP                                                                  
         ACALL SETTERM             NO RETURN                                    
         PEND                                                                   
*                                                                               
*                                                                               
*SETMPRT  SCKW  ,V(SCNNOOP),I       (Skip past numbers)                         
*         SCKW  ,V(NOTVALID)                                                    
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWMIL -- SHOW <terminal option> command.                                   
*                                                                               
SHOWMIL  XPROC  ,                                                               
         IF    (CPCMNM,EQ,'COM'),'VCALL ORVCPASS'  (SPIRES command)             
*                                                                               
         TSEG  'Use the SHOW TERMINAL command in the future.',,WR               
         ACALL SHOWTERM            NO RETURN                                    
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWCASE -- SHOW CASE command.                                               
*                                                                               
SHOWCASE XPROC  ,                                                               
         VCALL COLLOPTS                                                         
*                                                                               
         SETMSG 'UPPER'                                                         
         IF    CPSFUPL,'SETMSG "UPLOW"'                                         
         TSEG  (R1),(R0),B                                                      
         SETMSG '- CASE'                                                        
         B     CVNXTMSG                                                         
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETTERM -- SET TERMINAL command.                                             
*                                                                               
SETTERM  XPROC SIB                                                              
         MVC   SIB,CPSIB                                                        
         LA    R6,SIB                                                           
         USING SIB,R6                                                           
*                                                                               
         SCPUSH                                                                 
*                                                                               
         LA    R5,100              Maximum loop count                           
SETTLP   SCPOP                                                                  
         SCPUSH ,                                                               
         SCAN  TERMPRT                                                          
         SCANCHK                                                                
         INCR  R15,SIBUC           Kick update count                            
         TCLEAR                                                                 
         TSEG  SIBOPT                                                           
         TCNTL CTLSETI             Set SIB options                              
         BM    CVMILERR                                                         
         IF    POS,BEGIN                                                        
         MVC   SIB,@R1             New copy                                     
         BCT   R5,SETTLP           Retry                                        
         LA    R15,100             Can't update.. rc=100                        
         B     CVMILERR                                                         
         END                                                                    
*                                                                               
         MVC   CPS,SIB             Update our copy                              
*-                                                                              
*-       Check to see if a Samson terminal type has just been set,              
*-         if it has we will call SAMPARMS to send a Samson packet              
*-         to get additional terminal settings.                                 
*-                                                                              
         IF    CPSFSAM,BEGIN       Samson terminal type...                      
         CLEAR R0                  Don't set time/date                          
         VCALL SAMPARMS            Get Samson parameter block                   
*-                                                                              
*-       If SAMPARMS failed it means that someone SET TERMINAL                  
*-         SAMSON on a non-Samson terminal.  If this is the case                
*-         then we will change the terminal type to be a VT100 (if              
*-         for some strange reason the VT100 terminal type is not               
*-         defined then the universal default ("TTY") will be used              
*-         instead.                                                             
*-                                                                              
         IF    NZ,BEGIN            Not a Samson terminal...                     
         TSEG  X'0D'               (CR only)                                    
         TSEG  'This is not a Samson terminal, '                                
         TSEG  'terminal type changed to VT100.',,WR                            
*                                                                               
         LA    R15,=CL8'VT100'     VT100 terminal type                          
         ACALL CHKTTYPE            Look up terminal type name                   
         ACALL SETTTYPE            Set terminal type                            
         END                                                                    
*-                                                                              
*-       If it is a Samson terminal but no explicit terminal type               
*-         is given then use the terminal type returned by Samson.              
*-                                                                              
         IF    (CPSTTYPE,Z),BEGIN  No terminal type set yet...                  
         LA    R15,CPSAMTRM        Terminal type Samson gave us                 
         ACALL CHKTTYPE            Look up terminal type name                   
         IF    Z,EXIT              Unknown terminal type                        
         ACALL SETTTYPE            Set terminal type                            
         END                                                                    
         END                                                                    
*                                                                               
         ELSE  BEGIN               Non-Samson terminal...                       
         VCALL SAMINIT             Reset any old Samson info                    
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
TERMPRT  SCKW  ,MISSSETT,NULL                                                   
         SCKW  ID,TID,P                                                         
         SCKW  BREAK,TBREAK,A                                                   
         SCKW  NOBREAK,TNOBREAK,A                                               
         SCKW  COMM,TCOMM,A                                                     
         SCKW  NOCOMM,TNOCOMM,A                                                 
         SCKW  MSG,TMSG,A                                                       
         SCKW  MESSAGE,TMSG,A                                                   
         SCKW  NOMSG,TNOMSG,A                                                   
         SCKW  NOMESSAGE,TNOMSG,A                                               
         SCKW  SLOWLIST,TSLOW,A                                                 
         SCKW  NOECHO,TNOECHO,A                                                 
         SCKW  ECHO,TECHO,A                                                     
         SCKW  VSLOW,TNOVFAST,A                                                 
         SCKW  NOVFAST,TNOVFAST,A                                               
         SCKW  VFAST,TVFAST,A                                                   
         SCKW  TYPEAHEAD,TTYPEQ,A                                               
         SCKW  NOTYPEAHEAD,TNOTYPEQ,A                                           
         SCKW  FILTER,TFILTER,A                                                 
         SCKW  NOFILTER,TNOFILT,A                                               
         SCKW  FASTLIST,TFAST,A                                                 
         SCKW  BACK,TBACK,A                                                     
         SCKW  NOBACK,TNOBACK,A                                                 
         SCKW  CASE,V(SCNNOOP),A                                                
         SCKW  UPPER,TUPPER,A                                                   
         SCKW  UPLOW,TUPLOW,A                                                   
         SCKW  ERASE,TERASE,A                                                   
         SCKW  NOERASE,TNOERASE,A                                               
         SCKW  XON,TXON,A                                                       
         SCKW  NOXON,TNOXON,A                                                   
         SCKW  SAMSON,TSAM,A                                                    
         SCKW  NOSAMSON,TNOSAM,A                                                
         SCKW  PSPECIAL,TPSPEC                                                  
         SCKW  NOPSPEC,TNOPSPEC                                                 
         SCKW  NOTIME,TNOTIME,A                                                 
         SCKW  TIMEOUT,TTIMEOUT,A                                               
         SCKW  TRACE,TTRACE,A                                                   
         SCKW  NOTRACE,TNOTRACE,A                                               
         SCKW  KEEP,TKEEP,A                                                     
         SCKW  NOKEEP,TNOKEEP,A                                                 
         SCKW  CHARS,TCHARS,(A,P)                                               
         SCKW  APL,TCHARS                                                       
         SCKW  APLB,TCHARS                                                      
         SCKW  NOAPL,TNOCHARS                                                   
         SCKW  NOAPLB,TNOCHARS                                                  
         SCKW  WIDTH,TWIDTH,(A,P,PI),255                                        
         SCKW  HEIGHT,THEIGHT,(A,P,I),255                                       
         SCKW  NOHEIGHT,TNOHEI,A                                                
         SCKW  TABS,TTABS,A                                                     
         SCKW  TI,TTI                                                           
         SCKW  RI,TRI                                                           
         SCKW  PARITY,TPAR,A                                                    
         SCKW  NOPARITY,TNOPAR,A                                                
         SCKW  EVEN,TEVEN,A                                                     
         SCKW  ODD,TODD                                                         
         SCKW  MARK,TMARK,A                                                     
         SCKW  QUIET,TQUIET,A                                                   
         SCKW  NOQUIET,TNOQUIET,A                                               
         SCKW  IDLES,TIDLES,A                                                   
         SCKW  NOIDLES,TNOIDL,A                                                 
         SCKW  CRI,TCRI,(P,I),5000                                              
         SCKW  LFI,TLFI,(P,I),5000                                              
         SCKW  HTI,THTI,(P,I),5000                                              
         SCKW  ,TTYP                                                            
         EJECT                                                                  
MISSSETT PROC                                                                   
         ERROR 'Missing SET TERMINAL options.'                                  
         PEND                                                                   
*                                                                               
TIGNORE  PROC                                                                   
         PEND                                                                   
*                                                                               
TTYP     PROC                                                                   
         SCBKUP ,                                                               
         SCANSTR ,                 ALLOW ODD CHARS IN TERM TYPE NAME            
         SCANCHK                                                                
         SCUPTOK R1                                                             
         LR    R15,R1              WHICH REGS ARE REALLY NEEDED?                
         LR    R2,R1                                                            
         ACALL CHKTTYPE            Anything we know about?                      
         IF    Z,BEGIN             No...                                        
         IF    (R0,EQ,3),BEGIN     Terminal id compatability...                 
         IF    (@R2,GE,'0'),EXIT                                                
         IF    (@R2+1,LT,'0'),EXIT                                              
         IF    (@R2+2,LT,'0'),EXIT                                              
         LR    R15,R2                                                           
         ACALL TID                 Set the terminal id                          
         EXIT  TTYP                                                             
         END                                                                    
*                                                                               
         TSEG  (R1),(R0),B                                                      
         TSEG  'is an unknown terminal type.',,CR                               
         ERROR 'Type ? for more information.',,BADTERM                          
         END                                                                    
*                                                                               
         ACALL SETTTYPE            Set the terminal type                        
*                                                                               
         MVC   SIBUC,CPSUC         Keep our copy accurate                       
         MVC   SIBTTYPE,CPSTTYPE   Update terminal type name                    
         MVC   SIBTCLS,CPSTCLS     ...and generic class                         
         MVC   SIBTFLAG,CPSTFLAG   ...and flags                                 
         MVC   SIBHEI,CPSHEI       ...height                                    
         MVC   SIBWID,CPSWID       ...and width                                 
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TID      PROC                                                                   
         SCUPTOK R1                                                             
         MVC   SIBTID,@R1                                                       
         IF    (SIBTID,EQ,CVBLANKS),'CLEAR SIBTID'                              
         IF    CPSFPTID,BEGIN                                                   
         ABORT 'Pre-assigned terminal id can''t be changed.'                    
         END                                                                    
*                                                                               
         IF    (SIBTID,NE,'V'),BEGIN  VT100/temp...                             
         CLEAR R15                                                              
         IF    CPSTPDP,'LA R15,=CL8"TEK4023"'                                   
         IF    (SIBTID,EQ,'U'),'LA R15,=CL8"TVI912"'                            
         IF    (SIBTID,EQ,'H'),'LA R15,=CL8"HP2621"'                            
****     IF    (SIBTID,EQ,'V'),'LA R15,=CL8"VT100"'                             
         IF    (R1,NZ),'MVC CPSTTYPE,@R15'                                      
         END                                                                    
*                                                                               
         IF    (CPSTTYPE,NZ),BEGIN  Compatability...                            
         LA    R15,CPSTTYPE        Terminal type                                
         VCALL CHKTTYPE            Look up name                                 
         VCALL SETTTYPE            Set terminal related info                    
*                                                                               
         MVC   SIBUC,CPSUC         Keep our copy accurate                       
         MVC   SIBTTYPE,CPSTTYPE   Update terminal type name                    
         MVC   SIBTCLS,CPSTCLS     ...and generic class                         
         MVC   SIBTFLAG,CPSTFLAG   ...and flags                                 
         MVC   SIBHEI,CPSHEI       ...height                                    
         MVC   SIBWID,CPSWID       ...and width                                 
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
*                                                                               
TBREAK   PROC                                                                   
         CLEAR SIBFNBRK                                                         
         PEND                                                                   
*                                                                               
TNOBREAK PROC                                                                   
         SET   SIBFNBRK                                                         
         PEND                                                                   
*                                                                               
TCOMM    PROC                                                                   
         CLEAR SIBFNCOM                                                         
         PEND                                                                   
*                                                                               
TNOCOMM  PROC                                                                   
         SET   SIBFNCOM                                                         
         PEND                                                                   
*                                                                               
TMSG     PROC                                                                   
         CLEAR SIBFNMSG                                                         
         PEND                                                                   
*                                                                               
TNOMSG   PROC                                                                   
         SET   SIBFNMSG                                                         
         PEND                                                                   
*                                                                               
TSLOW    PROC                                                                   
         CLEAR SIBFFAST                                                         
         PEND                                                                   
*                                                                               
TFAST    PROC                                                                   
         SET   SIBFFAST                                                         
         PEND                                                                   
*                                                                               
TNOVFAST PROC                                                                   
         CLEAR SIBFVFAST                                                        
         PEND                                                                   
*                                                                               
TVFAST   PROC                                                                   
         SET   SIBFVFAST                                                        
         PEND                                                                   
*                                                                               
TNOECHO  PROC                                                                   
         SET   SIBFNECH                                                         
         PEND                                                                   
*                                                                               
TECHO    PROC                                                                   
         CLEAR SIBFNECH                                                         
         PEND                                                                   
*                                                                               
TTYPEQ   PROC                                                                   
         CLEAR SIBFNTYP                                                         
         PEND                                                                   
*                                                                               
TNOTYPEQ PROC                                                                   
         SET   SIBFNTYP                                                         
         PEND                                                                   
*                                                                               
TFILTER  PROC                                                                   
         SET   SIBFFILT                                                         
         PEND                                                                   
*                                                                               
TNOFILT  PROC                                                                   
         CLEAR SIBFFILT                                                         
         PEND                                                                   
*                                                                               
TBACK    PROC                                                                   
         SET   SIBFBACK                                                         
         PEND                                                                   
*                                                                               
TNOBACK  PROC                                                                   
         CLEAR SIBFBACK                                                         
         PEND                                                                   
*                                                                               
TUPPER   PROC                                                                   
         CLEAR SIBFUPL                                                          
         PEND                                                                   
*                                                                               
TUPLOW   PROC                                                                   
         SET   SIBFUPL                                                          
         PEND                                                                   
*                                                                               
TERASE   PROC                                                                   
         SET   SIBFERA                                                          
         PEND                                                                   
*                                                                               
TNOERASE PROC                                                                   
         CLEAR SIBFERA                                                          
         PEND                                                                   
*                                                                               
TXON     PROC                                                                   
         SET   SIBFXON                                                          
         PEND                                                                   
*                                                                               
TNOXON   PROC                                                                   
         CLEAR SIBFXON                                                          
         PEND                                                                   
*                                                                               
TSAM     PROC                                                                   
         CLEAR SIBTCLS,SIBTTYPE                                                 
         VCALL SAMINIT             Reset old Samson info                        
         SET   SIBFSAM             It's a Samson terminal                       
         PEND                                                                   
*                                                                               
TNOSAM   PROC                                                                   
         CLEAR SIBTCLS,SIBTTYPE                                                 
         VCALL SAMINIT             Reset old Samson info                        
         CLEAR SIBFSAM             Not a Samson terminal                        
         PEND                                                                   
*                                                                               
TPSPEC   PROC                                                                   
         SET   SIBFPSP                                                          
         PEND                                                                   
*                                                                               
TNOPSPEC PROC                                                                   
         CLEAR SIBFPSP                                                          
         PEND                                                                   
*                                                                               
TNOTIME  PROC                                                                   
         SET   SIBFNTIM                                                         
         PEND                                                                   
*                                                                               
TTIMEOUT PROC                                                                   
         CLEAR SIBFNTIM                                                         
         PEND                                                                   
*                                                                               
TTRACE   PROC                                                                   
         SET   SIBFTRC                                                          
         PEND                                                                   
*                                                                               
TNOTRACE PROC                                                                   
         CLEAR SIBFTRC                                                          
         PEND                                                                   
*                                                                               
TKEEP    PROC                                                                   
         SET   SIBFKEEP                                                         
         PEND                                                                   
*                                                                               
TNOKEEP  PROC                                                                   
         CLEAR SIBFKEEP                                                         
         PEND                                                                   
*                                                                               
TNOCHARS PROC                                                                   
         SCUPTOK R1                                                             
         IF    (@R1,EQ,'NOAPL'),'CLEAR SIBFBACK'                                
         LA    R15,CVBLANKS                                                     
         MVC   SIBCHAR,@R15                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TCHARS   PROC                                                                   
         SCUPTOK R1                                                             
         MVC   SIBCHAR,@R1                                                      
         IF    (SIBCHAR,EQ,'APL'),'SET SIBFBACK+SIBFUPL'                        
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TWIDTH   PROC                                                                   
         STH   R0,SIBWID                                                        
         PEND                                                                   
*                                                                               
THEIGHT  PROC                                                                   
         STH   R0,SIBHEIP                                                       
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         DTB   (R1),(R0)                                                        
         IF    Z,BEGIN                                                          
         STH   R15,SIBHEI                                                       
         END                                                                    
         ELSE  BEGIN                                                            
         SCBKUP                                                                 
         END                                                                    
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TNOHEI   PROC                                                                   
         CLEAR SIBHEIP                                                          
         PEND                                                                   
*                                                                               
TTABS    PROC                                                                   
         ABORT 'Use the SET TABS command to set tab stops.'                     
         PEND                                                                   
*                                                                               
TTI      PROC                                                                   
         ACALL IDLECONV            Convert idles to new style                   
         ST4   R15,SIBHTI                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TRI      PROC                                                                   
         ACALL IDLECONV            Convert idles to new style                   
         ST4   R15,SIBCRI                                                       
         CLEAR SIBLFI                                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TPAR     PROC                                                                   
         SET   SIBFPAR+SIBFEVEN+SIBFMARK  even,mark                             
         CLEAR SIBFODD                                                          
         PEND                                                                   
*                                                                               
TNOPAR   PROC                                                                   
         CLEAR SIBFPAR+SIBFEVEN+SIBFODD+SIBFMARK                                
         PEND                                                                   
*                                                                               
TEVEN    PROC                                                                   
         SET   SIBFPAR+SIBFEVEN                                                 
         CLEAR SIBFODD+SIBFMARK                                                 
         PEND                                                                   
*                                                                               
TODD     PROC                                                                   
         SET   SIBFPAR+SIBFODD                                                  
         CLEAR SIBFEVEN+SIBFMARK                                                
         PEND                                                                   
*                                                                               
TMARK    PROC                                                                   
         SET   SIBFPAR+SIBFMARK                                                 
         CLEAR SIBFEVEN+SIBFODD                                                 
         PEND                                                                   
*                                                                               
TQUIET   PROC                                                                   
         SET   SIBFQUIET                                                        
         PEND                                                                   
*                                                                               
TNOQUIET PROC                                                                   
         CLEAR SIBFQUIET                                                        
         PEND                                                                   
*                                                                               
TIDLES   PROC                                                                   
         SCAN  TIDLPRT                                                          
         SCANCHK                                                                
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TIDLLN   PROC                                                                   
         LR    R15,R0                                                           
         IF    (R15,GT,99*1000),'VCALL NOTVALID'                                
         CLEAR SIBIDLE                                                          
*-                                                                              
*-       standard idles are:  cri=20,2  hti=20,2  lfi=20                        
*-         (idles=n applies "n" as a multiplication factor.)                    
*-                                                                              
         LR    R2,R15                                                           
         MH    R15,=H'20'                                                       
         A     R15,=F'999'                                                      
         CLEAR R14                                                              
         D     R14,=F'1000'                                                     
         CEIL  R15,=F'5000'                                                     
         STH   R15,SIBCRI                                                       
         STH   R15,SIBLFI                                                       
         STH   R15,SIBHTI                                                       
*                                                                               
         LR    R15,R2                                                           
         MH    R15,=H'2'                                                        
         A     R15,=F'999'                                                      
         CLEAR R14                                                              
         D     R14,=F'1000'                                                     
         CEIL  R15,=F'5000'                                                     
         STH   R15,SIBCRI+2                                                     
         STH   R15,SIBHTI+2                                                     
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
TIDLDFLT PROC                                                                   
         SCBKUP                                                                 
         LA    R0,1000                                                          
         ACALL TIDLLN                                                           
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
TIDLPRT  SCKW  ,TIDLDFLT,NULL                                                   
         SCKW  ,TIDLLN,LN                                                       
         SCKW  ,TIDLDFLT                                                        
*                                                                               
TNOIDL   PROC                                                                   
         CLEAR SIBIDLE                                                          
         PEND                                                                   
*                                                                               
TCRI     PROC                                                                   
         ACALL IDLESCAN                                                         
         ST4   R15,SIBCRI                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
TLFI     PROC                                                                   
         STH   R0,SIBLFI                                                        
         PEND                                                                   
*                                                                               
THTI     PROC                                                                   
         ACALL IDLESCAN                                                         
         ST4   R15,SIBHTI                                                       
         CLEAR R15                                                              
         PEND                                                                   
         EJECT                                                                  
IDLESCAN PROC                                                                   
         LR    R2,R0               First number                                 
         SLL   R2,16                                                            
         SCAN  ,                   Look for second number...                    
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         DTB   (R1),(R0)                                                        
         IF    NZ,'SCBKUP'         Not a number, back up                        
         ELSE  BEGIN                                                            
         IF    (R15,GT,5000),'VCALL NOTVALID'  too big                          
         AR    R2,R15                                                           
         END                                                                    
         END                                                                    
         LR    R15,R2                                                           
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  IDLECONV -- Local routine to convert old style idle numbers to               
*    new style idle delays.                                                     
*                                                                               
*      On entry:                                                                
*        scanner: a,b,c -- idles in the form:  (ax+b)/c                         
*                                                                               
*      On exit:                                                                 
*        R15 - fixed*x'10000'+perchar ms idle time                              
*                                                                               
IDLECONV PROC                                                                   
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
         DTB   (R1),(R0)           A                                            
         IF    NZ,'VCALL NOTVALID'                                              
         LR    R2,R15                                                           
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
         DTB   (R1),(R0)           *,B                                          
         IF    NZ,'VCALL NOTVALID'                                              
         LR    R3,R15                                                           
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
         DTB   (R1),(R0)           *,*,C                                        
         IF    NZ,'VCALL NOTVALID'                                              
         LTR   R4,R15                                                           
         IF    NP,'VCALL NOTVALID'                                              
*                                                                               
         CLEAR R15                 Assume no idles                              
         LH    R5,=H'960'          Assume 960 cps (9600 baud)                   
         MR    R4,R4               R5 = cps*c                                   
         LR    R4,R5                                                            
         SRL   R4,1                R4 = (cps*c)/2                               
         LR    R1,R2               A                                            
         MH    R1,=H'1000'                                                      
         CLEAR R0                                                               
         DR    R0,R5               R0 = (a*1000/cps)/c                          
         IF    ((R4,NZ),AND,(R0,NZ)),'INCR R1'                                  
         IF    (R1,GT,5000),'L R1,=F"5000"'                                     
         LR    R15,R1              Perchar ms delay                             
         LR    R1,R3               B                                            
         MH    R1,=H'1000'                                                      
         CLEAR R0                                                               
         DR    R0,R5               R0 = (b*1000/cps)/c                          
         IF    ((R4,NZ),AND,(R0,NZ)),'INCR R1'                                  
         IF    (R1,GT,5000),'L R1,=F"5000"'                                     
         SLL   R1,16                                                            
         AR    R15,R1              Add in fixed ms delay                        
         PEND                                                                   
*                                                                               
         DROP  SIB                                                              
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  CHKTTYPE -- Routine to check the terminal type to see if it's                
*    one we know about.                                                         
*                                                                               
*    On entry:                                                                  
*      R15 - terminal type loc (8 characters)                                   
*                                                                               
*    On exit, R15 (and cc):                                                     
*      0 - unknown terminal type                                                
*      nz- terminal type is known (R15=TTYPE loc)                               
*                                                                               
CHKTTYPE XPROC  ,                                                               
         LR    R5,R15                                                           
         LA    R6,CVTTYQH-(TTYLINK-TTYPE)                                       
*                                                                               
         CLEAR R15                                                              
         LOOP  BEGIN                                                            
         WITH  (TTYPE,R6)                                                       
         WHILE ('LT R6,TTYLINK',NZ)                                             
         CLEAR R2                                                               
         LA    R3,TTYNAME                                                       
         WHILE (R2,LT,TTYMAX#),BEGIN                                            
         IF    ('CLC @R3(8),@R5',EQ),BEGIN  Matched...                          
         LR    R15,R6                                                           
         B     CHKTEXIT                                                         
         END                                                                    
*                                                                               
         LA    R3,@R3+L'TTYNAME                                                 
         LA    R2,@R2+1                                                         
         END                                                                    
         END                                                                    
*                                                                               
CHKTEXIT PEND                                                                   
         EJECT                                                                  
SETTWA   RECORD BEGIN                                                           
SETTOLD  DS    CL8                 Old terminal name                            
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETTTYPE -- Routine to set device information based on the                   
*    terminal type.                                                             
*                                                                               
*    On entry:                                                                  
*      R15 - TTYPE entry (0=universal defaults)                                 
*                                                                               
SETTTYPE XPROC SETTWA                                                           
         CLEAR SETTOLD             Initialize old terminal name                 
*                                                                               
         LTR   R5,R15                                                           
         IF    Z,'L R5,CVTTYQH'    Use the first entry (the default)            
*-                                                                              
*-       Decrement the use count for the TTYPE entry being released.            
*-                                                                              
         LT    R4,CPTTYPEP         Current TTYPE ptr                            
         IF    NZ,BEGIN                                                         
         WITH  (TTYPE,R4)                                                       
         MVC   SETTOLD,TTYNAME     Save old terminal type name                  
*                                                                               
         DECR  R0,TTYUSE           Decrement use count                          
         IF    (TTYFREL,AND,(R0,Z)),BEGIN  Release old TTYPE entry...           
*-                                                                              
*-       Release init write text.                                               
*-                                                                              
         L     R3,TTYINITQ                                                      
         WHILE (R3,NZ),BEGIN       Free "init text"...                          
         L     R2,@R3              Get next "init text" entry ptr               
         SETMSG (R3),LH:@R3+4                                                   
         MVC   @R3(4),=F'-1'       (Neatness)                                   
*        FREEMAIN R,A=(1),LV=(0)   Free text entry                              
         VCALL FREECORE                                                         
         LR    R3,R2                                                            
         END                                                                    
*-                                                                              
*-       Release TTYPE entry.                                                   
*-                                                                              
         CLEAR TTYPE               (Neatness)                                   
         LR    R1,R4                                                            
*        FREEMAIN R,A=(R1),LV=L'TTYPE  Free TTYPE entry                         
         VCALL FREECORE                                                         
         END                                                                    
         END                                                                    
*-                                                                              
*-       Now set the new TTYPE entry and kick it's use count.                   
*-                                                                              
         ST    R5,CPTTYPEP         Save TTYPE ptr                               
         IF    (R5,NZ),BEGIN       We have a terminal type...                   
         WITH  (TTYPE,R5)                                                       
         INCR  R0,TTYUSE           Kick TTYPE's use count                       
*-                                                                              
*-       If it is a Samson terminal type then get info from Samson.             
*-                                                                              
         IF    TTYFSAM,BEGIN       Samson terminal...                           
*-                                                                              
*-       Special compatibility feature, if the Samson terminal type             
*-      is "OLDxxx" then don't sense the Samson version and terminal            
*-         information.                                                         
*-                                                                              
         IF    (TTYNAME,EQ,'OLD'),BEGIN                                         
         VCALL SAMINIT             Reset Samson defaults                        
         SET   CPSAMFDEF           Fake it: Samson parms are defined            
         END                                                                    
*                                                                               
         ELSE  BEGIN               Sense information from Samson...             
         CLEAR R0                  Don't set time/date                          
         VCALL SAMPARMS            Get Samson information                       
*                                                                               
         IF    Z,BEGIN             Got the Samson info...                       
         IF    (TTYNAME,EQ,'SAMSON '),BEGIN  Generic Samson...                  
         LA    R15,CPSAMTRM        Change to real terminal type                 
         ACALL CHKTTYPE            Lookup terminal type                         
         IF    Z,EXIT              (Unknown terminal, forget it)                
         ACALL SETTTYPE            Change to real ttype (recursive)             
         B     SETXEXIT            Scram                                        
         END                                                                    
         END                                                                    
*                                                                               
         ELSE  BEGIN               Not a Samson terminal...                     
*-                                                                              
*-      We get here when the user has set a Samson terminal type but            
*-     is probably not using Samson.  We have to try to do something            
*-        reasonable, the best thing to do is to change the terminal            
*-         type to VT100.                                                       
*-                                                                              
         TSEG  X'0D'               (CR only)                                    
         TSEG  'This is not a Samson terminal, '                                
         TSEG  'terminal type changed to VT100.',,WR                            
*                                                                               
         LA    R15,=CL8'VT100'     Change terminal type to VT100                
         ACALL CHKTTYPE            Lookup terminal type                         
         ACALL SETTTYPE            Change to VT100 (recursive call)             
         B     SETXEXIT            Scram                                        
         END                                                                    
         END                                                                    
         END                                                                    
*-                                                                              
*-       Non-Samson terminal type.                                              
*-                                                                              
         ELSE  BEGIN               Non-Samson terminal type...                  
         VCALL SAMINIT             Reset Samson defaults                        
         END                                                                    
*-                                                                              
*-       Update terminal type information in CP/SIB.                            
*-                                                                              
         CLEAR CPVFVTAM            Assume not VTAM terminal                     
         IF    TTYFVTAM,'SET CPVFVTAM'                                          
*                                                                               
         LOOP  BEGIN                                                            
         MVC   CPSTTYPE,TTYNAME    Save terminal type name                      
         MVC   CPSTCLS,TTYTCLS     Save terminal class                          
         CLEAR CPSFMOD+CPSFSAM                                                  
         IF    TTYFMOD,'SET CPSFMOD'  Model terminal                            
         IF    TTYFSAM,'SET CPSFSAM'  Samson terminal                           
*                                                                               
         CLEAR R15                                                              
         LTH   R15,CPSAMHEI        Samson height                                
         IF    Z,'LH R15,TTYHEI'   Height in ttype entry                        
         IF    (R15,NZ),'STH R15,CPSHEI'  Height                                
*                                                                               
         CLEAR R15                                                              
         LTH   R15,CPSAMWID        Samson width                                 
         IF    Z,'LH R15,TTYWID'   Width in ttype entry                         
         IF    (R15,NZ),'STH R15,CPSWID'  Width                                 
*                                                                               
         VCALL UPDCPSIB            Update SIB                                   
         UNTIL Z                                                                
         END                                                                    
*-                                                                              
*-       Reinitialize page image.  If we don't yet have view control            
*-         blocks then don't bother.                                            
*-                                                                              
         CLEAR CPVHEI,CPVWID,CPVTWID  Reset (PAGEINIT picks values)             
*                                                                               
         IF    (CPVWCNT,NZ),BEGIN  Re-initalize...                              
         VCALL PAGEINIT            Reinitialize page image                      
         END                                                                    
*-                                                                              
*-       Write any initialization text out now.                                 
*-                                                                              
         IF    (TTYNAME,NE,SETTOLD),BEGIN  Changing terminal types...           
         TCLEAR                                                                 
         XPUSH ,,L'CPTRM,PTR=R4                                                 
         MVC   @R4(L'CPTRM),CPTRM  Save terminal I/O flags                      
         CLEAR CPTRM               Reset flags                                  
         SET   CPFNONL,CPFCLEAN,CPFSLOW,CPFNMOD,CPFNPAU  Good stuff             
*                                                                               
         LA    R3,TTYINITQ         Init text queue ptr (or zero)                
         WHILE ('LT R3,@R3',NZ),BEGIN  Write any text...                        
         LH    R0,@R3+4            Total entry length                           
         SH    R0,=H'8'            Subtract the length of the prefix            
         TSEG  @R3+8,(R0)          Write the init text                          
         TMARK                                                                  
         END                                                                    
         TWRITE                                                                 
*                                                                               
         MVC   CPTRM,@R4           Restore terminal I/O flags                   
         XPOP  ,,L'CPTRM                                                        
         END                                                                    
         END                                                                    
*                                                                               
SETXEXIT PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWTERM -- SHOW TERMINAL command.                                           
*  TERMDISP -- Subroutine (called by SHOW OPTIONS).                             
*                                                                               
SHOWTERM XPROC  ,                                                               
         VCALL COLLOPTS                                                         
*                                                                               
         ACALL TERMDISP                                                         
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
TERMDISP XPROC  ,                                                               
         TSEG  'Terminal Options:',,CR                                          
         TSEG  CVBLANKS,2                                                       
         IF    ((CPSTID,NZ),AND,(CPSTID,NE,CVBLANKS)),BEGIN                     
         TSEG  'ID='                                                            
         SETMSG CPSTID                                                          
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),B                                                      
         END                                                                    
*                                                                               
         IF    ((CPSCHAR,NZ),AND,(CPSCHAR,NE,CVBLANKS)),BEGIN                   
         TSEG  'CHARS='                                                         
         TSEG  CPSCHAR,,TB                                                      
         END                                                                    
*                                                                               
         IF    (CPSINMX,NZ),BEGIN                                               
         TSEG  'INMAX='                                                         
         BTD   CPDOUB,0,LH:CPSINMX                                              
         TSEG  (R1),(R0),B                                                      
         END                                                                    
*                                                                               
         IF    (CPSOUMX,NZ),BEGIN                                               
         TSEG  'OUTMAX='                                                        
         BTD   CPDOUB,0,LH:CPSOUMX                                              
         TSEG  (R1),(R0),B                                                      
         END                                                                    
*                                                                               
         IF    ((CPSTTYPE,NZ),AND,(CPSTTYPE,NE,CVBLANKS)),BEGIN                 
         TSEG  'TYPE='                                                          
         SETMSG CPSTTYPE                                                        
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),B                                                      
         END                                                                    
*                                                                               
         IF    CPSFNBRK,'TSEG "NO"'                                             
         TSEG  'BREAK',,B                                                       
         IF    CPSFNCOM,'TSEG "NO"'                                             
         TSEG  'COMM',,B                                                        
         IF    CPSFNMSG,'TSEG "NO"'                                             
         TSEG  'MSG',,B                                                         
         IF    CPSFNTYP,'TSEG "NO"'                                             
         TSEG  'TYPEAHEAD '                                                     
         IF    CPSFSAM,'TSEG "SAMSON "'                                         
         TCR                                                                    
*                                                                               
         TSEG  CVBLANKS,2                                                       
         IF    CPSFNECH,'TSEG "NO"'                                             
         TSEG  'ECHO '                                                          
         SETMSG 'SLOW '                                                         
         IF    CPSFFAST,'SETMSG "FAST "'                                        
         TSEG  (R1),(R0)                                                        
         IF    ^CPSFBACK,'TSEG "NO"'                                            
         TSEG  'BACK '                                                          
         IF    ^CPSFFILT,'TSEG "NO"'                                            
         TSEG  'FILTER '                                                        
         SETMSG 'UPPER '                                                        
         IF    CPSFUPL,'SETMSG "UPLOW "'                                        
         TSEG  (R1),(R0)                                                        
*                                                                               
         IF    ^CPSFXON,'TSEG "NO"'                                             
         TSEG  'XON '                                                           
*                                                                               
         IF    CPSFPSP,'TSEG "PSPECIAL "'                                       
*                                                                               
         IF    CPSFQUIET,'TSEG "QUIET "'                                        
*                                                                               
         IF    CPSFTRC,'TSEG "TRACE "'                                          
*                                                                               
         IF    CPSFKEEP,'TSEG "KEEP "'                                          
*                                                                               
         IF    ^CPSFVFAST,'TSEG "NO"'                                           
         TSEG  'VFAST '                                                         
*                                                                               
         TSEG  'WIDTH='                                                         
         TNUM  LH:CPSWID                                                        
*                                                                               
         TSEG  ' HEIGHT='                                                       
         TNUM  LH:CPSHEIP                                                       
         TSEG  ','                                                              
         TNUM  LH:CPSHEI                                                        
*                                                                               
         TCR                                                                    
         BNZ   CVABORT                                                          
*                                                                               
***      TSEG  '  PARITY:',,B                                                   
***      SETMSG 'NOPARITY'                                                      
***      IF    CPSFPAR,BEGIN                                                    
***      CLEAR R0                                                               
***      IF    CPSFEVEN,'SETMSG "EVEN"'                                         
***      IF    CPSFODD,'SETMSG "ODD"'                                           
***      IF    CPSFMARK,BEGIN                                                   
***      IF    (R0,NZ),'TSEG (R1),(R0); TSEG ","'                               
***      SETMSG 'MARK'                                                          
***      END                                                                    
***      END                                                                    
***      TSEG  (R1),(R0)                                                        
***                                                                             
***      TSEG  CVBLANKS,2                                                       
***      LA    R1,CPSIB                                                         
***      ACALL IDLEDISP                                                         
TERMDXIT PEND                                                                   
         EJECT                                                                  
SEGHEXB  PROC                                                                   
         IF    (@R1,EQ,X'00'),'TSEG "0",,B'                                     
         ELSE  BEGIN                                                            
         LR    R3,R1                                                            
         LR    R2,R0                                                            
         LOOP  BEGIN                                                            
         BTX   CPDOUB,2,IC:@R3                                                  
         TSEG  (R1),(R0)                                                        
         LA    R3,@R3+1                                                         
         DECR  R2                                                               
         WHILE ((R2,POS),AND,(@R3,NE,X'00')),END                                
         TSEG  CVBLANKS,1                                                       
         END                                                                    
         PEND                                                                   
*                                                                               
*                                                                               
         QLTORG                                                                 
         AIF   (&$PCODE).NOLINE    *** PCODE                                    
         TITLE 'SET LINE Command'                                               
*box                                                                            
*                                                                               
*  SETLINE -- SET LINE command.                                                 
*                                                                               
SETLINE  XPROC SIB                                                              
         MVC   SIB,CPSIB                                                        
         SCPUSH                                                                 
*                                                                               
         LA    R5,100              Maximum loop count                           
SETNLP   SCPOP                                                                  
         SCPUSH ,                                                               
         SCAN                                                                   
         SCANCHK ,                                                              
         IF    (R0,Z),BEGIN                                                     
         ABORT 'Missing "name" for SET LINE command.'                           
         END                                                                    
         VCALL DEQUOTE                                                          
         MVC   SIBNAME,CVBLANKS                                                 
         LR    R15,R0                                                           
         CEIL  R15,L'SIBNAME                                                    
         MOVE  R15,SIBNAME,@R1                                                  
         IF    (R0,Z),'MVC SIBNAME,CPNAME'                                      
         IF    (SIBNAME,EQ,CVBLANKS),'CLEAR SIBNAME'                            
         VCALL NOOPTS              Dont allow trailing junk                     
*                                                                               
         INCR  R15,SIBUC           Kick update count                            
         TSEG  SIBOPT                                                           
         TCNTL CTLSETI             Set SIB options                              
         BM    CVMILERR                                                         
         IF    POS,BEGIN                                                        
         MVC   SIB,@R1             New copy                                     
         BCT   R5,SETNLP           Retry                                        
         LA    R15,100             Can't update.. rc=100                        
         B     CVMILERR                                                         
         END                                                                    
         MVC   CPS,SIB             Update our copy                              
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
.NOLINE  ANOP  ,                   *** PCODE                                    
         TITLE 'SET/SHOW TABS Commands'                                         
TABWA    RECORD BEGIN                                                           
TABFLAG  FLAG                                                                   
         FLAG  TABFAUTO            - auto                                       
         FLAG  TABFTRNC            - only first 16 tabs used                    
*                                                                               
TABSTOPS DS    16H                 Room for tabs                                
*                                                                               
TABS     DS    XL16                Tab set area                                 
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETTABS -- SET TABS command.                                                 
*                                                                               
SETTABS  XPROC TABWA                                                            
         CLEAR TABWA                                                            
*                                                                               
         IF    ^CPVFPAGE,'SET CPFVER'  Default is VERIFY                        
         CLEAR R6                  TABSTOPS offset                              
         LH    R5,=H'-11'          Prev tab                                     
         LA    R4,TABWA            TABWA addressability                         
         SCAN  SETTBPRT                                                         
         SCANCHK                                                                
         IF    (R6,Z),BEGIN        No tabs given...                             
         IF    ((CPSTABS,NE,X'00'),AND,TABFAUTO),SETTBC                         
         TSEG  'Type a T beneath each position at which',,B                     
         TSEG  'a tab is to be set.',,WR                                        
         CLEAR R0,R1               Show columns -- use defaults                 
         VCALL DOSHCOLS                                                         
         SETMSG '     Tabs? '                                                   
         IF    CPLFLG5.CPFUNUM,'CLEAR R0'  (No prompt)                          
         SET   CPFCASE+CPFUPPER                                                 
         TREAD  (R1),(R0)                                                       
         BNZ   CVABORT                                                          
         LA    R5,1                Column                                       
         WHILE (R0,POS),BEGIN                                                   
         IF    ((@R1,EQ,'T'),OR,(@R1,EQ,'t'),OR,(@R1,EQ,'1')),BEGIN             
         IF    (R6,GE,16*2),'SET TABFTRNC'  Too many settings                   
         ELSE  'STH R5,TABSTOPS(R6); LA R6,@R6+2'                               
         END                                                                    
         IF    (@R1,NE,X'27'),'LA R5,@R5+1'                                     
         LA    R1,@R1+1                                                         
         DECR  R0                                                               
         END                                                                    
         END                                                                    
*                                                                               
         LA    R4,11               Offset for numbered                          
         IF    CPLFLG5.CPFUNUM,'CLEAR R4'                                       
         CLEAR R5                                                               
         SRL   R6,1                No. of tabs                                  
         WHILE (R5,LT,R6),BEGIN                                                 
         LA    R15,TABSTOPS(R5)                                                 
         LH    R15,@R15(R5)        Get tab                                      
         AR    R15,R4              Adjust, if necessary                         
         CEIL  R15,256             Safety                                       
         IF    (R15,NEG),BEGIN                                                  
         ERROR 'Tabs must be positive.  Tabs not set.'                          
         END                                                                    
         STC   R15,TABS(R5)        Save tab                                     
         LA    R5,@R5+1                                                         
         END                                                                    
*                                                                               
         LOOP  BEGIN                                                            
         MVC   CPSTABS,TABS                                                     
         VCALL UPDCPSIB            Set tabs                                     
         UNTIL Z,END                                                            
*                                                                               
         VCALL PAGETABS            Set new page tabs                            
*                                                                               
SETTBC   IF    (CPSTABS,EQ,X'00'),'SETMSG "No tabs set."; B CVNXTMSG'           
         IF    TABFTRNC,'TSEG "Only the first 16 were tabs used.",,WR'          
*                                                                               
         IF    TABFAUTO,BEGIN      Auto...                                      
*  this generally works...                                                      
         TSEG  X'27F227F327F4271627D90D'  Clear tabs                            
         LA    R5,CPSTABS          Start of tabs                                
         LA    R4,16               Max no of tabs                               
         LA    R3,1                Column                                       
         WHILE ((R4,POS),AND,(@R5,NE,X'00')),BEGIN                              
         LC    R2,@R5              Get tab                                      
         LR    R0,R2                                                            
         SR    R0,R3               No. of chars to this tab                     
         IF   ^NEG,BEGIN           Double check ascending order                 
         TSEG  CVBLANKS,(R0)                                                    
         TSEG  X'27F1A3'           Set tab & display T                          
         END                                                                    
         LA    R3,@R2+1            Current column                               
         LA    R5,@R5+1            Next tab                                     
         DECR  R4                                                               
         END                                                                    
         SET   CPFSLOW             don't use tabs for this line                 
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         IF    CPFVER,'ACALL DOSHTABS'  go display tabs                         
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
*                                                                               
         USING  TABWA,R4                                                        
*                                                                               
*                                                                               
*                                                                               
SETTBPRT SCKW  ,SETTBP,I,&LINESZ                                                
         SCKW  -,SETTBN,(P,I),&LINESZ                                           
         SCKW  AUTO,SETTBA,A                                                    
         SCKW  ,V(VERPSH),PUSH                                                  
         SCKW  ,V(NUMPSH),PUSH                                                  
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SETTBN   PROC                                                                   
         LCR   R0,R0                                                            
         ACALL SETTBP                                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
SETTBP   PROC                                                                   
         IF    (R6,GE,16*2),'SET TABFTRNC; EXIT SETTBP'                         
         IF    (R0,LE,R5),BEGIN                                                 
         ERROR 'Tabs must be given in ascending order.  No tabs set.'           
         END                                                                    
         STH   R0,TABSTOPS(R6)    Save tab                                      
         LR    R5,R0                                                            
         LA    R6,@R6+2                                                         
         PRETURN (R5,R6)                                                        
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
SETTBA   PROC                                                                   
         SET   TABFAUTO                                                         
         PEND                                                                   
*                                                                               
         DROP  TABWA                                                            
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWTABS -- SHOW TABS command.                                               
*                                                                               
SHOWTABS XPROC  ,                                                               
         SCAN  SHTABPRT                                                         
         SCANCHK ,                                                              
         ACALL DOSHTABS                                                         
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SHTABPRT SCKW  ,V(VERPSH),PUSH                                                  
         SCKW  ,V(NUMPSH),PUSH                                                  
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  DOSHTABS -- Routine to display tabs.  Called by set and show                 
*    tabs commands.                                                             
*                                                                               
DOSHTABS PROC                                                                   
         IF    (CPSTABS,EQ,X'00'),'TSEG "No tabs set.",,WR; B DOSHTX'           
         LA    R6,11               Spaces for numbered                          
         IF    (^CPLFLG5.CPFFOPT,AND,(CPSTABS,LT,X'0C')),'CLEAR R6'             
         IF    CPLFLG5.CPFUNUM,'CLEAR R6'                                       
         IF    ^CPFVER,BEGIN                                                    
         LA    R5,CPSTABS          Start of tabs                                
         LA    R4,16               Max no of tabs                               
         WHILE ((R4,POS),AND,(@R5,NE,X'00')),BEGIN                              
         LC    R15,@R5                                                          
         SR    R15,R6              Adjust, if necessary                         
         BTD   CPDOUB,0,(R15)                                                   
         TSEG  (R1),(R0),B                                                      
         LA    R5,@R5+1                                                         
         DECR  R4                                                               
         END                                                                    
         SETMSG '- Tabs'                                                        
         IF    (R6,Z),'SETMSG "- Unnumbered tabs"'                              
         TSEG  (R1),(R0),WR                                                     
         B     DOSHTX                                                           
         END                                                                    
*                                                                               
         XPUSH ,,&LINESZ,PTR=R3                                                 
         MVC   @R3(&LINESZ),CVBLANKS                                            
         IF    (R6,NZ),'MVC @R3(6),=C"Verify"'                                  
         LA    R5,CPSTABS          Start of tabs                                
         LA    R4,16               Max no of tabs                               
         DECR  R3                  Point to buffer-1                            
         WHILE ((R4,POS),AND,(@R5,NE,X'00')),BEGIN                              
         LC    R15,@R5                                                          
         CEIL  R15,&LINESZ-1       Better safe than sorry                       
         LA    R15,@R15(R3)                                                     
         MVI   @R15,C't'           Tab stop here                                
         LA    R5,@R5+1                                                         
         DECR  R4                                                               
         END                                                                    
         SET   CPFSLOW             Slowlist                                     
         TSEG  @R3+1,&LINESZ,WR                                                 
*                                                                               
         SH    R4,=H'16'                                                        
         LCR   R0,R4               No. of tabs set                              
         AR    R0,R0               Two chars for every tab                      
         TSEG  TABSDISP,(R0),WR                                                 
DOSHTX   PEND                                                                   
*                                                                               
TABSDISP DC    16X'05A3'           Tab, "t"                                     
*                                                                               
         QLTORG                                                                 
*                                                                               
         TITLE 'SHOW IDLES Command'                                             
*box                                                                            
*                                                                               
*  SHOWIDLE -- SHOW IDLES command.                                              
*                                                                               
SHOWIDLE XPROC  ,                                                               
         VCALL COLLOPTS                                                         
*                                                                               
         LA    R1,CPSIB                                                         
         ACALL IDLEDISP                                                         
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         SPACE 2                                                                
IDLEDISP PROC                                                                   
         LR    R6,R1                                                            
         USING SIB,R6                                                           
*                                                                               
         TSEG  'IDLES: CRI='                                                    
         BTD   CPDOUB,0,LH:CPSCRI                                               
         TSEG  (R1),(R0)                                                        
         TSEG  ','                                                              
         BTD   CPDOUB,0,LH:CPSCRI+2                                             
         TSEG  (R1),(R0),B                                                      
         TSEG  'LFI='                                                           
         BTD   CPDOUB,0,LH:CPSLFI                                               
         TSEG  (R1),(R0),B                                                      
         TSEG  'HTI='                                                           
         BTD   CPDOUB,0,LH:CPSHTI                                               
         TSEG  (R1),(R0)                                                        
         TSEG  ','                                                              
         TNUM  LH:CPSHTI+2                                                      
         TCR                                                                    
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  SIB                                                              
         AIF   (&$PCODE).NOMIL     *** PCODE                                    
         TITLE 'SHOW MVERSION Command'                                          
*box                                                                            
*                                                                               
*  SHOWMVER -- SHOW MVERSION command.                                           
*                                                                               
SHOWMVER XPROC  ,                                                               
         VCALL COLLOPTS                                                         
*                                                                               
         TCNTL CTLSNSM             Get milten info                              
         BNZ   CVMILERR                                                         
         XPUSH ,,L'MIB,PTR=R6                                                   
         USING MIB,R6                                                           
         CLEAR MIB                                                              
         CEIL  R0,L'MIB                                                         
         LR    R15,R0                                                           
         MOVE  R15,MIB,@R1                                                      
*                                                                               
         SETMSG MIBVERS                                                         
         VCALL LRTRIM                                                           
        IF ((MIBVERS,Z),OR,(MIBVERS,EQ,CVBLANKS)),'SETMSG "NO VERSION"'         
         B     CVNXTMSG                                                         
         PEND                                                                   
*                                                                               
         DROP  MIB                                                              
         TITLE 'SHOW MINFO Command'                                             
*box                                                                            
*                                                                               
*  SHOWMINF -- SHOW MINFO command.                                              
*  MINFDISP -- Subroutine (called by SHOW INFO).                                
*                                                                               
SHOWMINF XPROC  ,                                                               
         VCALL COLLOPTS                                                         
*                                                                               
         ACALL MINFDISP                                                         
         B     CVNEXT                                                           
         PEND                                                                   
         SPACE 2                                                                
MINFDISP XPROC  ,                                                               
         TWRITE                                                                 
*                                                                               
         TCNTL CTLSNSM             Get milten info                              
         BNZ   CVMILERR                                                         
         XPUSH ,,L'MIB,PTR=R6                                                   
         USING MIB,R6                                                           
         CLEAR MIB                                                              
         CEIL  R0,L'MIB                                                         
         LR    R15,R0                                                           
         MOVE  R15,MIB,@R1         Save copy of mib                             
*                                                                               
         SETMSG MIBNAME                                                         
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0)                                                        
         IF    ((MIBJOBNM,NZ),AND,(MIBJOBNM,NE,MIBNAME)),BEGIN                  
         TSEG  ' (job',,B                                                       
         SETMSG MIBJOBNM                                                        
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ')'                                                              
         END                                                                    
         TSEG  ':',,CR                                                          
         TCR                                                                    
*                                                                               
         TSEG  'Started at',,B                                                  
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         L     R0,MIBCLCK                                                       
         CLEAR R1,R3                                                            
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK                                                         
         TSEG  (R1),(R0)                                                        
         XPOP  ,,30                                                             
         TCR                                                                    
*                                                                               
         LA    R1,MIB                                                           
         ACALL CNTDISP                                                          
*                                                                               
         TNUM  L:MIBNIO                                                         
         TSEG  ' I/O''s, '                                                      
         TNUM  L:MIBNAPP                                                        
         TSEG  ' appendage entries',,CR                                         
*                                                                               
         TCR                                                                    
         TNUM  LH:MIBNFAIL                                                      
         TSEG  ' failsoft recoveries, '                                         
         TNUM  LH:MIBNAPPF                                                      
         TSEG  ' appendage failsofts',,CR                                       
         BNZ   CVABORT                                                          
         IF    (MIBFCLCK,NZ),BEGIN                                              
         TSEG  CVBLANKS,2                                                       
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         L     R0,MIBFCLCK                                                      
         CLEAR R1,R3            Compare to current date                         
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK                                                         
         TSEG  (R1),(R0),B                                                      
         XPOP  ,,30                                                             
         SETMSG MIBFINFO                                                        
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),CR                                                     
         END                                                                    
*                                                                               
         TCR                                                                    
         TSEG  'Halt I/O information:',,CR                                      
         TNUM  LH:MIBNHIOT,8                                                    
         TSEG  ' halt I/O subtasks',,CR                                         
         TNUM  LH:MIBHQCUR,8                                                    
         TSEG  ' is the current halt queue depth',,CR                           
         TNUM  LH:MIBHQMAX,8                                                    
         TSEG  ' is the maximum halt queue depth reached',,CR                   
         TSEG  CVBLANKS,5                                                       
         THEX  LH:MIBHQDEV,3                                                    
         TSEG  ' is the last device halting (or halted)',,CR                    
*                                                                               
         TCR                                                                    
         BTD   CPDOUB,0,LH:MIBNFULQ                                             
         TSEG  (R1),(R0),B                                                      
         TSEG  'subsystem full queues',,CR                                      
*                                                                               
         TCR                                                                    
         TSEG  'Memory: ',,B                                                    
         BTD   CPDOUB,0,L:MIBNLOWM                                              
         TSEG  (R1),(R0),B                                                      
         TSEG  'low,',,B                                                        
         BTD   CPDOUB,0,L:MIBNNOM                                               
         TSEG  (R1),(R0),B                                                      
         TSEG  'none',,WR                                                       
         BNZ   CVABORT                                                          
         TSEG  CVBLANKS,1,CR                                                    
         TSEG  'Buffers: '                                                      
         CLEAR R14                                                              
         L     R15,MIBPGCUR                                                     
         LA    R15,@R15+512                                                     
         D     R14,=A(1024)                                                     
         TNUM  (R15),4                                                          
         TSEG  'K paged ('                                                      
         CLEAR R14                                                              
         L     R15,MIBPGMAX                                                     
         LA    R15,@R15+512                                                     
         D     R14,=A(1024)                                                     
         TNUM  (R15),4                                                          
         TSEG  'K max), '                                                       
         BTD   CPDOUB,7,L:MIBPGCNT                                              
         TSEG  (R1),(R0)                                                        
         TSEG  ' requests',,CR                                                  
*                                                                               
         TSEG  CVBLANKS,9                                                       
         CLEAR R14                                                              
         L     R15,MIBFXCUR                                                     
         LA    R15,@R15+512                                                     
         D     R14,=A(1024)                                                     
         TNUM  (R15),4                                                          
         TSEG  'K fixed ('                                                      
         CLEAR R14                                                              
         L     R15,MIBFXMAX                                                     
         LA    R15,@R15+512                                                     
         D     R14,=A(1024)                                                     
         TNUM  (R15),4                                                          
         TSEG  'K max), '                                                       
         BTD   CPDOUB,7,L:MIBFXCNT                                              
         TSEG  (R1),(R0)                                                        
         TSEG  ' requests',,CR                                                  
*                                                                               
         TSEG  CVBLANKS,9                                                       
         CLEAR R14                                                              
         L     R15,MIBCSCUR                                                     
         LA    R15,@R15+512                                                     
         D     R14,=A(1024)                                                     
         TNUM  (R15),4                                                          
         TSEG  'K CSA   ('                                                      
         CLEAR R14                                                              
         L     R15,MIBCSMAX                                                     
         LA    R15,@R15+512                                                     
         D     R14,=A(1024)                                                     
         TNUM  (R15),4                                                          
         TSEG  'K max), '                                                       
         BTD   CPDOUB,7,L:MIBCSCNT                                              
         TSEG  (R1),(R0)                                                        
         TSEG  ' requests',,CR                                                  
*                                                                               
         PEND                                                                   
         DROP  MIB                                                              
         TITLE 'SHOW COUNT Command'                                             
*box                                                                            
*                                                                               
*  SHOWCNT -- SHOW COUNT command.                                               
*  CNTDISP -- Subroutine (called by SHOW MINFO).                                
*               On entry: R1 - MIB ptr                                          
*                                                                               
SHOWCNT  XPROC MIB                                                              
         CLEAR MIB                                                              
         VCALL COLLOPTS                                                         
         TCNTL CTLSNSM             Get milten info                              
         BNZ   CVMILERR                                                         
         CEIL  R0,L'MIB                                                         
         LR    R15,R0                                                           
         MOVE  R15,MIB,@R1         Move in copy of mib                          
         LA    R1,MIB                                                           
         ACALL CNTDISP                                                          
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         SPACE 2                                                                
CNTDISP  PROC                                                                   
         LR    R6,R1                                                            
         USING MIB,R6                                                           
*                                                                               
         BTD   CPDOUB,0,LH:MIBCRSES                                             
         TSEG  (R1),(R0),B                                                      
         TSEG  'users logged on'                                                
         IF    (MIBMXSES,GT,MIBCRSES),BEGIN                                     
         TSEG  ' ('                                                             
         BTD   CPDOUB,0,LH:MIBMXSES                                             
         TSEG  (R1),(R0),B                                                      
         TSEG  'max at',,B                                                      
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         L     R0,MIBCKSES                                                      
         CLEAR R1,R3            Compare to current date                         
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK                                                         
         TSEG  (R1),(R0)                                                        
         XPOP  ,,30                                                             
         TSEG  ')'                                                              
         END                                                                    
*                                                                               
         TSEG  ',',,B                                                           
         BTD   CPDOUB,0,LH:MIBCRVIR                                             
         TSEG  (R1),(R0),B                                                      
         TSEG  'virtual jobs',,B                                                
*                                                                               
         IF    MIBFSTOP,'TSEG " (stopping)"'                                    
         TCR                                                                    
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  MIB                                                              
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW LINE/LINES Commands'                                       
*box                                                                            
*                                                                               
*  SHOWLINE -- SHOW LINE/LINES command.                                         
*                                                                               
SHWLWA   RECORD BEGIN                                                           
SHWLRNG  DS    XL(L'RNGCB)                                                      
         END                                                                    
*                                                                               
SHOWLINE XPROC SHWLWA                                                           
         CLEAR SHWLRNG                                                          
         SCUPTOK R15                                                            
         IF    (CPCMNM,NE,'LIN'),BEGIN                                          
         LA    R15,=C'LINES'                                                    
         IF    (CPCMNM,NE,'V'),BEGIN                                            
         SCBKUP                                                                 
         SCINFO                                                                 
         END                                                                    
         END                                                                    
*                                                                               
         LA    R0,RNGTSES*256+L'RNGFDOUR  Our line                              
         IF    ((@R15,EQ,'LINES'),OR,(@R15,EQ,'LINS')),BEGIN                    
         IF    (CPCMNM,NE,'V'),'MVC CPCMNM,=C"LNS"'                             
         LA    R0,RNGTSES*256+L'RNGFDALL  All lines                             
         END                                                                    
         SETSCKWS GETRPRT                                                       
         LA    R15,SHWLRNG                                                      
         ACALL GETTRNG                                                          
         BZ    CVABORT                                                          
*                                                                               
         WITH  (RNGCB,R15),'SET RNGFMULT+RNGFLIST; CLEAR RNGFVER'               
         CLEAR R0                  No selection co-routine                      
         LA    R1,LINERTN          Range co-routine                             
         ACALL TRANGE                                                           
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  LINERTN -- SHOW LINE(S) range co-routine.                                    
*                                                                               
*    On entry:                                                                  
*      R1 - SIB ptr                                                             
*                                                                               
LINERTN  PROC                                                                   
         LR    R6,R1                                                            
         USING SIB,R6                                                           
*                                                                               
         LR    R5,R15                                                           
         WITH  (RNGCB,R5),BEGIN                                                 
         IF    ^RNGFSOME,BEGIN                                                  
         IF    (CPCMNM,NE,'LNS'),EXIT                                           
         TSEG  'Line Account  User name            '                            
         SETMSG 'Program  Port'                                                 
         TSEG  (R1),(R0),WR                                                     
         BNZ   CVABORT                                                          
         END                                                                    
         END                                                                    
*                                                                               
         IF    (CPCMNM,EQ,'VLI'),BEGIN                                          
         TSEG  'Idle'                                                           
         TNUM  LH:SIBTMINC,5                                                    
         TSEG  ' mins: '                                                        
         END                                                                    
*                                                                               
         LA    R1,SIB                                                           
         ACALL LINEDISP                                                         
*                                                                               
         WITH  (RNGCB,R5),BEGIN                                                 
         IF    RNGFSMF,BEGIN                                                    
         TSEG  '<'                                                              
         TSEG  SIBTETYP                                                         
         TSEG  '>',,B                                                           
         END                                                                    
         END                                                                    
*                                                                               
         IF    (CPCMNM,EQ,'VLI'),BEGIN                                          
         TSEG  '('                                                              
         TSEG  SIBSUB,,T                                                        
         TSEG  ','                                                              
         TSEG  SIBVPGM,,T                                                       
         TSEG  ') '                                                             
         END                                                                    
*                                                                               
         IF    SIBSFOP,'TSEG "(Oper) "'                                         
*                                                                               
         IF    (SIBNMSG,NZ),BEGIN                                               
         TSEG  '(Msgs='                                                         
         TNUM  LH:SIBNMSG                                                       
         TSEG  ') '                                                             
         END                                                                    
*                                                                               
         IF    SIBFNMSG,'TSEG "(Nomsg) "'                                       
         ELSE  BEGIN                                                            
         IF    SIBFNCOM,'TSEG "(Nocomm) "'                                      
         IF    SIBFNBRK,'TSEG "(Nobreak) "'                                     
         END                                                                    
*                                                                               
         IF    SIBFTRC,'TSEG "(Tracing) "'                                      
*                                                                               
         CLEAR R0                                                               
         IF    SIBFKEEP,'SETMSG "(Keep) "'                                      
         IF    SIBFKEPT,'SETMSG "(Kept) "'                                      
         IF    (R0,NZ),'TSEG (R1),(R0)'                                         
*                                                                               
         IF    SIBFDISP,BEGIN                                                   
         SETMSG '(Viewing) '                                                    
         IF    (SIBSUB,EQ,'ORVYL'),'SETMSG "(Display) "'                        
         IF    (SIBSUB,EQ,'VISTA'),'SETMSG "(TSO) "'                            
         TSEG  (R1),(R0)                                                        
         END                                                                    
*-                                                                              
*-       Now display stuff that only WYLBUR knows about.                        
*-                                                                              
         LH    R5,SIBNO            Session number                               
         MH    R5,=AL2(L'JCB)                                                   
         A     R5,CVFJCB           This user's WYLBUR JCB                       
         WITH  (JCB,R5),BEGIN                                                   
*                                                                               
         IF    JCBSFMIC,'TSEG "(Micro) "'  Currently in Micro mode              
         END                                                                    
*                                                                               
         TWRITE                                                                 
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  SIB                                                              
         TITLE 'SHOW _LINES Commands'                                           
*box                                                                            
*                                                                               
*  SHOWILIN -- SHOW _LINES command.                                             
*                                                                               
SHLIWA   RECORD BEGIN                                                           
SHLIRNG  DS    XL(L'RNGCB)                                                      
         END                                                                    
*                                                                               
SHOWILIN XPROC SHLIWA                                                           
         CLEAR SHLIWA                                                           
*                                                                               
         LA    R0,RNGTSES*256+L'RNGFDALL  All lines                             
*                                                                               
         SETSCKWS GETRPRT                                                       
         LA    R15,SHLIRNG                                                      
         ACALL GETTRNG                                                          
         BZ    CVABORT                                                          
*                                                                               
         WITH  (RNGCB,R15),'SET RNGFMULT+RNGFLIST; CLEAR RNGFVER'               
         CLEAR R0                  No selection co-routine                      
         LA    R1,ILINERTN         Range co-routine                             
         ACALL TRANGE                                                           
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  ILINERTN -- SHOW _LINES range co-routine.                                    
*                                                                               
*    On entry:                                                                  
*      R1 - SIB ptr                                                             
*                                                                               
ILWA     RECORD BEGIN                                                           
ILID     DS    CL40                Userid                                       
         END                                                                    
*-                                                                              
ILINERTN PROC  ILWA                                                             
         LR    R6,R1                                                            
         USING SIB,R6                                                           
*-                                                                              
*-       Internal formatted SHOW LINES.                                         
*-                                                                              
         TSEG  '+'                                                              
*                                                                               
         TNUM  L2:SIBNO,4                                                       
*                                                                               
         TSEG  ','                                                              
         TSEG  SIBGRP                                                           
         TSEG  '.'                                                              
         TSEG  SIBUSER                                                          
*                                                                               
         TSEG  ','                                                              
         LA    R15,SIBACCT         Account in uuugg format                      
         SETMSG ILID                Put userid here                             
         VCALL GETUID              Get userid for this account                  
         TSEG  (R1),L'ILID         Userid (or GG.UUU)                           
         TSEG  ','                                                              
         TSEG  SIBNAME             User name                                    
         TWRITE                                                                 
         BNZ   CVABORT                                                          
         PEND                                                                   
*                                                                               
         DROP  SIB                                                              
         TITLE 'SHOW _USERS Command'                                            
*box                                                                            
*                                                                               
*  SHOWUSRS -- SHOW _USERS command.                                             
*                                                                               
*    The SHOW USERS command is now an exec which internally                     
*    executes this command and then reformats the results.                      
*                                                                               
SHUWA    RECORD BEGIN                                                           
SHUFLAG  FLAG                                                                   
         FLAG  SHUFUSER            - Just display user id                       
*                                                                               
SHUID    DS    CL2                                                              
*                                                                               
SHWUID   DS    CL20                Working userid                               
*                                                                               
SHURNG   DS    XL(L'RNGCB)         Range work area                              
         END                                                                    
*-                                                                              
SHOWUSRS XPROC SHUWA                                                            
         LA    R6,SHUWA                                                         
         ST    R6,CPCWA                                                         
         USING SHUWA,R6                                                         
         CLEAR SHUWA                                                            
*                                                                               
         LA    R0,RNGTSES*256+L'RNGFMULT+L'RNGFDALL  All lines                  
         SETSCKWS GETRPRT                                                       
         LA    R15,SHURNG                                                       
         ACALL GETTRNG                                                          
         BZ    CVABORT                                                          
*                                                                               
         WITH  (RNGCB,R15),BEGIN                                                
         SET   RNGFMULT            We insist                                    
         CLEAR RNGFLIST+RNGFVER    Ditto                                        
*                                                                               
         IF    (RNGM,EQ,L'RNE),BEGIN  One item...                               
         LA    R2,RNG                                                           
         WITH  (RNE,R2)                                                         
         IF    (RNETEXT,NE,'@'),EXIT  not group selection                       
         IF    (RNELEN,GT,3),EXIT                                               
         MVC   SHUID(1),RNETEXT+1                                               
         MVI   SHUID+1,C' '                                                     
         IF    (RNELEN,EQ,3),'MVC SHUID,RNETEXT+1; SET SHUFUSER'                
         END                                                                    
         END                                                                    
*-                                                                              
*-       Write out TITLE lines.                                                 
*-                                                                              
         TSEG  '>'                                                              
         TSEG  'Sort_field'                                                     
         TCOL  35                                                               
         TSEG  'Account'                                                        
         TCOL  50                                                               
         TSEG  'Userid'                                                         
         TCR                                                                    
*                                                                               
         TSEG  '>----------'                                                    
         TCOL  35                                                               
         TSEG  '-------'                                                        
         TCOL  50                                                               
         TSEG  '------'                                                         
         TWRITE                                                                 
         BNZ   CVABORT                                                          
*                                                                               
         CLEAR R0                  No selection co-routine                      
         LA    R1,USRSRTN          Range co-routine                             
         LA    R15,SHURNG          RNGCB ptr                                    
         ACALL TRANGE                                                           
         BNZ   CVABORT                                                          
*                                                                               
         TCCR                                                                   
         TSEG  '< '                                                             
         IF    (SHUID,NZ),BEGIN                                                 
         SETMSG SHUID                                                           
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),B                                                      
         END                                                                    
         SETMSG 'Users'                                                         
         B     CVNXTMSG                                                         
         PEND                                                                   
*                                                                               
         DROP  SHUWA                                                            
         EJECT                                                                  
*box                                                                            
*                                                                               
*  USRSRTN -- SHOW _USERS range co-routine.                                     
*                                                                               
USRSRTN  PROC                                                                   
         L     R6,CPCWA                                                         
         USING SHUWA,R6                                                         
         LR    R5,R1                                                            
         USING SIB,R5                                                           
*                                                                               
         IF    (SIBACCT,Z),USRSEXIT  Not logged on                              
*-                                                                              
*-       Add one line per user.                                                 
*-                                                                              
         LA    R15,SIBACCT         Account in uuugg format                      
         SETMSG SHWUID              Put userid here                             
         VCALL GETUID              Get userid for this account                  
*-                                                                              
*-       This account has a userid.                                             
*-                                                                              
         IF    Z,BEGIN             Found the userid...                          
         LR    R3,R1                                                            
         LR    R2,R0                                                            
         TSEG  '0'                 Leading zero                                 
         LR    R4,R3                                                            
         AR    R4,R2               End of userid string                         
         LOOP  BEGIN               Backscan for "_" or "."                      
         DECR  R4                                                               
         WHILE (R4,GE,R3)                                                       
         IF    ((@R4,EQ,'_'),OR,(@R4,EQ,'.')),EXIT                              
         END                                                                    
         INCR  R4                  Skip over special char                       
         SR    R4,R3               Indentation length                           
         XPUSH R3                                                               
         AR    R3,R4                                                            
         SR    R2,R4                                                            
         TSEG  (R3),(R2)           Part of userid to sort on                    
         XPOP  R3                                                               
         IF    (R4,POS),'TSEG (R3),(R4)'  Continued part                        
*                                                                               
         TCOL  35                                                               
         TSEG  SIBGRP                                                           
         TSEG  '.'                                                              
         TSEG  SIBUSER                                                          
         L2    R2,SIBANO                                                        
         IF    (R2,GT,1),'TSEG "#"; TNUM (R2)'                                  
*                                                                               
         TCOL  50                                                               
         TSEG  SHWUID,,T           Userid                                       
         END                                                                    
*-                                                                              
*-       No userid for this user.                                               
*-                                                                              
         ELSE  BEGIN               No userid...                                 
         TSEG  '1'                 |Sort field                                  
         TSEG  SHWUID,,T           |                                            
*                                                                               
         TCOL  35                                                               
         TSEG  SHWUID,,T           Account                                      
*                                                                               
         TCOL  50                                                               
         TSEG  SHWUID              Account again (userid)                       
         END                                                                    
*                                                                               
         TWRITE                                                                 
         BNZ   CVABORT                                                          
*                                                                               
USRSEXIT PEND                                                                   
         DROP  SIB,SHUWA                                                        
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW PRIV Command'                                              
*box                                                                            
*                                                                               
*  SHOWPRIV -- SHOW PRIV command.                                               
*                                                                               
SHWPWA   RECORD BEGIN                                                           
SHWPRNG  DS    XL(L'RNGCB)                                                      
         END                                                                    
*                                                                               
*                                                                               
SHOWPRIV XPROC SHWPWA                                                           
         CLEAR SHWPWA                                                           
         SCPUSH                                                                 
         SCAN                                                                   
         SCANCHK                                                                
         SCUPTOK R1                                                             
         IF    ((R0,NZ),AND,(@R1,EQ,'SUB')),BEGIN                               
         VCALL ORVCPASS            (allow SPIRES to intercept)                  
         END                                                                    
         SCPOP                                                                  
*                                                                               
         IF    (CPSFSPR+CPSFOPR+CPSFAPR,Z),BEGIN                                
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         LA    R0,RNGTSES*256+L'RNGFDALL                                        
         SETSCKWS GETRPRT                                                       
         LA    R15,SHWPRNG                                                      
         ACALL GETTRNG                                                          
         BZ    CVABORT                                                          
*                                                                               
         WITH  (RNGCB,R15),'SET RNGFMULT+RNGFLIST; CLEAR RNGFVER'               
*                                                                               
         LA    R0,PRIVSEL          Range selection co-routine                   
         LA    R1,PRIVRTN          Range co-routine                             
         ACALL TRANGE                                                           
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  PRIVSEL -- SHOW PRIV range selection co-routine.                             
*                                                                               
*    On entry:                                                                  
*      R1 - SIB ptr                                                             
*                                                                               
*    On exit, R15 (and CC):                                                     
*      0 - use item                                                             
*      4 - skip item                                                            
*                                                                               
PRIVSEL  PROC                                                                   
         LR    R6,R1                                                            
         USING SIB,R6                                                           
*                                                                               
         BEGIN                                                                  
         CLEAR R15                 Assume ok                                    
         IF    SIBFAPR,EXIT                                                     
         IF    SIBFSPR,EXIT                                                     
         IF    SIBFOPR,EXIT                                                     
         IF    SIBFADM,EXIT                                                     
         IF    SIBFPC,EXIT                                                      
         LA    R15,4               User has no privs, skip                      
         END                                                                    
         PEND                                                                   
         DROP  SIB                                                              
         EJECT                                                                  
*box                                                                            
*                                                                               
*  PRIVRTN -- SHOW PRIV range co-routine.                                       
*                                                                               
*    On entry:                                                                  
*      R1 - SIB ptr                                                             
*                                                                               
PRIVRTN  PROC                                                                   
         LR    R6,R1                                                            
         USING SIB,R6                                                           
*                                                                               
         LA    R1,SIB                                                           
         ACALL LINEDISP                                                         
*                                                                               
         IF    SIBFAPR,'TSEG "(ACCT)",,B'                                       
         IF    SIBFSPR,'TSEG "(SYS)",,B'                                        
         IF    SIBFOPR,'TSEG "(OPR)",,B'                                        
         IF    SIBFSBM,'TSEG "(SUBMIT)",,B'                                     
         IF    SIBFADM,'TSEG "(ADMIN)",,B'                                      
         IF    SIBFPC,'TSEG  "(PC)",,B'                                         
*                                                                               
         TWRITE                                                                 
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  SIB                                                              
         TITLE 'TO Command'                                                     
*box                                                                            
*                                                                               
*  TO -- _TO command.                                                           
*                                                                               
*    The TO command is now an exec which internally                             
*    executes this command and then reformats the results.                      
*                                                                               
*                                                                               
TOWA     RECORD BEGIN                                                           
TOSG     SEGCB                                                                  
TORNG    DS    XL(L'RNGCB)                                                      
*                                                                               
TOSGBUF  DS    CL(&LINESZ)                                                      
         END                                                                    
*-                                                                              
TO       XPROC TOWA                                                             
         CLEAR TOWA                                                             
         LA    R6,TOWA                                                          
         ST    R6,CPCWA            Towa ptr                                     
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,Z),BEGIN                                                     
         ERROR 'Missing line-range for the TO command.'                         
         END                                                                    
         LR    R5,R1               Save line-range ptrs                         
         LR    R4,R0                                                            
*                                                                               
         IF    (CPSFNMSG+CPSFNCOM+CPSFNBRK,NZ),BEGIN                            
         TSEG  'Warning: Your terminal has',,B                                  
         IF    CPSFNMSG,'TSEG "NOMSG",,B'                                       
         IF    CPSFNCOM,'TSEG "NOCOMM",,B'                                      
         IF    CPSFNBRK,'TSEG "NOBREAK",,B'                                     
         TSEG  'set.',,WR                                                       
         BNZ   CVNOACTN                                                         
         END                                                                    
*                                                                               
         SEGINIT TOSGBUF,,TOSG                                                  
         VCALL LOCALTOD                                                         
         XPUSH ,,11,PTR=R15                                                     
         VCALL FMTTIME                                                          
         SEGB  (R1),5              Hh:mm                                        
         XPOP  ,,11                                                             
*-                                                                              
*-       Old style is: hh:mm From GG.JDN "Jim Nisbet" (12): message             
*-                                                                              
         XPUSH ,,L'CPUID,PTR=R1                                                 
         MVC   @R1(L'CPUID),CVBLANKS                                            
         MVC   @R1(2),CPSGRP                                                    
         MVI   @R1+2,C'.'                                                       
         MVC   @R1+3(3),CPSUSER                                                 
         CLEAR R2                  Assume old style userid                      
         IF    (CPUID,NE,@R1),'LA R2,1'  New style userid                       
         XPOP  ,,L'CPUID                                                        
*                                                                               
         LTR   R2,R2               !!! room to ZAP to "SR R2,R2"                
         IF    (R2,Z),BEGIN        Use old-style if no userid...                
         SEG   'From '                                                          
*                                                                               
         IF    CPSSFOP,'SEG "OPER "'                                            
*                                                                               
         IF    CPSTCONS,BEGIN      Just give console name...                    
         IF    (CPSNAME,Z),EXIT                                                 
         SEGT  CPSNAME                                                          
         END                                                                    
*                                                                               
         ELSE  BEGIN                                                            
         SEG   CPSGRP                                                           
         SEG   '.'                                                              
         SEG   CPSUSER                                                          
         L2    R2,CPSANO                                                        
         IF    (R2,GT,1),'SEG "#"; SEGDC (R2)'                                  
         IF    (CPSNAME,NZ),BEGIN                                               
         SEG   ' "'                                                             
         SEGT  CPSNAME                                                          
         SEG   '"'                                                              
         END                                                                    
         END                                                                    
*                                                                               
         SEG   ' ('                                                             
         SEGDC L2:CPSNO                                                         
         SEGB  '):'                                                             
         END                                                                    
*-                                                                              
*-       New style is: hh:mm From 12 Jim Nisbet <NIZ>: message                  
*-                                                                              
         ELSE  BEGIN               New style...                                 
         SEG   'From line '                                                     
         SEGDC L2:CPSNO            Line number                                  
         SEG   ' '                                                              
*                                                                               
         IF    CPSSFOP,'SEG "OPER "'                                            
*                                                                               
         IF    CPSTCONS,BEGIN      Just give console name...                    
         IF    (CPSNAME,Z),EXIT                                                 
         SEGT  CPSNAME                                                          
         END                                                                    
*                                                                               
         ELSE  BEGIN               Not a console...                             
         CLEAR R3                  Flag: assume no user name                    
         IF    (CPSNAME,NZ),BEGIN  Give our user name...                        
         SEGT  CPSNAME                                                          
         LA    R3,1                Flag: we have a user name                    
         END                                                                    
*                                                                               
         SEG   ' '                                                              
         IF    (R3,NZ),'SEG "<"'                                                
         IF    (CPUID,NZ),'SEGT CPUID'  Userid                                  
         ELSE  BEGIN               Give account if no userid...                 
         SEG   CPSGRP                                                           
         SEG   '.'                                                              
         SEG   CPSUSER                                                          
         L2    R2,CPSANO                                                        
         IF    (R2,GT,1),'SEG "#"; SEGDC (R2)'                                  
         END                                                                    
         IF    (R3,NZ),'SEG ">"'                                                
         END                                                                    
*                                                                               
         SEGB  ':'                                                              
         END                                                                    
*-                                                                              
*-       Now add message text.                                                  
*-                                                                              
         SCINFO ,                                                               
         WHILE ((R0,POS),AND,(@R1,EQ,' ')),'LA R1,@R1+1; DECR R0'               
         SEGT  (R1),(R0)                                                        
*-                                                                              
*-       Process "user@host" TO command.                                        
*-                                                                              
         IF    (@R5,NE,'('),BEGIN  Single id only...                            
         LR    R1,R5                                                            
         LR    R0,R4                                                            
         WHILE (R0,POS),BEGIN                                                   
         IF    (@R1,EQ,'@'),BEGIN  It's "user@host"...                          
         TCLEAR                                                                 
         TSEG  '$SEND '                                                         
         TSEG  (R5),(R4),B         user@host                                    
*                                                                               
         SETMSG L:TOSGLOC,L:TOSGLENF                                            
         LA    R1,@R1+18                                                        
         SH    R0,=H'18'           Skip past MILTEN hdr                         
*                                                                               
         IF    (R0,GT,160),BEGIN   Command is too long...                       
         SH    R0,=H'160'                                                       
         LR    R2,R0                                                            
         TCLEAR                                                                 
         TSEG  'Command is '                                                    
         TNUM  (R2)                                                             
         ERROR ' characters too long.'                                          
         END                                                                    
*                                                                               
         TSEG  (R1),(R0)                                                        
*                                                                               
         XPUSH ,,256,PTR=R1                                                     
         L     R0,CPSEGLENF                                                     
         L     R2,CPSEGLOC                                                      
         LR    R15,R0                                                           
         MOVE  R15,@R1,@R2         Save $SEND command                           
         TCLEAR                                                                 
*                                                                               
         CLEAR R15                                                              
         VCALL JESSND              Send the command to JES                      
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         LA    R1,@R1+1                                                         
         DECR  R0                                                               
         END                                                                    
         END                                                                    
*-                                                                              
*-       Process line-range.                                                    
*-                                                                              
         SCINIT (R5),(R4)          Line-range                                   
         LA    R0,RNGTSES*256+L'RNGFMULT                                        
         SETSCKWS GETRPRT                                                       
         LA    R15,TORNG                                                        
         ACALL GETTRNG                                                          
         BZ    CVABORT                                                          
*                                                                               
         CLEAR R0                  No selection co-routine                      
         LA    R1,TORTN            Range co-routine                             
         ACALL TRANGE                                                           
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  TORTN -- TO command range co-routine.                                        
*                                                                               
TORTN    PROC                                                                   
         L     R6,CPCWA                                                         
         USING TOWA,R6                                                          
         LR    R5,R1                                                            
         USING SIB,R5                                                           
         LR    R4,R15                                                           
         USING RNGCB,R4                                                         
*-                                                                              
*-       Complain about NOCOMM/NOMSG being set.                                 
*-                                                                              
         IF    SIBFNMSG+SIBFNCOM,BEGIN  Nomsg or nocomm will block...           
         TSEG  '-'                                                              
         TNUM  L2:SIBNO,4                                                       
         TSEG  ','                                                              
         TSEG  SIBGRP                                                           
         TSEG  '.'                                                              
         TSEG  SIBUSER                                                          
         TSEG  ': '                                                             
*                                                                               
         TSEG  'Message not sent to '                                           
         LA    R15,SIB                                                          
         ACALL TSEGLID             "line n Jim Nisbet", etc.                    
         TSEG  ' because '                                                      
         SETMSG 'nocomm'                                                        
         IF    SIBFNMSG,'SETMSG "nomsg"'                                        
         TSEG  (R1),(R0)                                                        
         TSEG  ' is set.',,WR                                                   
         B     TOREXIT                                                          
         END                                                                    
*                                                                               
         IF    ^SIBTCONS,BEGIN                                                  
         TSEG  X'2F15'             Bel,cr                                       
         LH    R2,RNGN                                                          
         LA    R2,RNG(R2)          Current rne                                  
         WITH  (RNE,R2)                                                         
         IF    (RNETEXT,EQ,'OPERATOR'),'TSEG "(OPER)",,B'                       
         END                                                                    
*                                                                               
         TSEG  L:TOSGLOC,L:TOSGLENF                                             
*                                                                               
         IF    ^SIBTCONS,'TSEG X"15"'                                           
*-                                                                              
*-       Send the message.                                                      
*-                                                                              
         L     R1,SIBID            Session id                                   
         VCALL TASWRITE            Async write                                  
         IF    NZ,BEGIN            Couldn't sent it...                          
         TSEG  '-'                                                              
         TNUM  L2:SIBNO,4                                                       
         TSEG  ','                                                              
         TSEG  SIBGRP                                                           
         TSEG  '.'                                                              
         TSEG  SIBUSER                                                          
         TSEG  ': '                                                             
*                                                                               
         TSEG  'Unable to send message to '                                     
         LA    R15,SIB                                                          
         ACALL TSEGLID             "line n Jim Nisbet", etc.                    
         TWRITE                                                                 
         B     TOREXIT                                                          
         END                                                                    
*-                                                                              
*-       Normal completion.                                                     
*-                                                                              
         TSEG  '+'                                                              
         TNUM  L2:SIBNO,4                                                       
         TSEG  ','                                                              
         TSEG  SIBGRP                                                           
         TSEG  '.'                                                              
         TSEG  SIBUSER                                                          
         TSEG  ': Message sent to '                                             
         LA    R15,SIB                                                          
         ACALL TSEGLID             "line n Jim Nisbet", etc.                    
         TWRITE                                                                 
*                                                                               
TOREXIT  PEND                                                                   
         DROP  TOWA,SIB                                                         
         EJECT                                                                  
*box                                                                            
*                                                                               
*  TSEGLID -- Routine to add the line identification for a session.             
*                                                                               
*     On entry:                                                                 
*       R15 - SIB ptr                                                           
*                                                                               
TUWA     RECORD BEGIN                                                           
TUID     DS    CL20                Working userid area                          
         END                                                                    
*-                                                                              
TSEGLID  PROC  TUWA                                                             
         LR    R5,R15                                                           
         WITH  (SIB,R5)                                                         
*                                                                               
         TSEG  'line '                                                          
         TNUM  L2:SIBNO            Line number                                  
*                                                                               
         TSEG  ' '                                                              
         CLEAR R3                  Flag: assume no user name                    
         IF    (SIBNAME,NZ),BEGIN  Give our user name...                        
         TSEG  SIBNAME,,TB                                                      
         LA    R3,1                Flag: we have a user name                    
         END                                                                    
*                                                                               
         IF    (R3,NZ),'TSEG "<"'                                               
         LA    R15,SIBACCT         Account in uuugg format                      
         SETMSG TUID                Put userid here                             
         VCALL GETUID              Get userid for this account                  
         TSEG  (R1),(R0)           Userid or GG.UUU                             
         IF    (R3,NZ),'TSEG ">"'                                               
*                                                                               
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
*                                                                               
         QLTORG                                                                 
         TITLE 'Subroutines'                                                    
*box                                                                            
*                                                                               
*  GETTRNG -- Routine to scan fe, port, or line range.                          
*                                                                               
*    On entry:                                                                  
*      R0 - RNGOPT options                                                      
*      R1 - scan table for additional options (or zero)                         
*      R6 - addressability for RNGOPT options (do not change r6!)               
*      R15 - RNGCB ptr                                                          
*                                                                               
*    On exit, R15 (and CC):                                                     
*      R15 - UNCHANGED                                                          
*      **** NO LONGER ! 0  - error (msg has already been typed)                 
*                                                                               
GETRWA   RECORD BEGIN                                                           
GETRSKIP DS    XL256               SKIP                                         
GETRSTOP DS    XL256               STOP                                         
         END                                                                    
*                                                                               
*                                                                               
GETTRNG  XPROC GETRWA                                                           
         LR    R5,R15                                                           
         USING RNGCB,R5                                                         
         CLEAR RNGCB                                                            
         ST    R0,RNGOPT                                                        
         SETSKIP ,                                                              
         SETSTOP ,                                                              
         SCAN  TABLES=NOSET                                                     
         SCANCHK                                                                
         IF    (R15,EQ,4),RFIN     nothing was scanned                          
         IF    (R15,EQ,8),BEGIN    unrecognized was scanned                     
         IF    (@R1,NE,'('),BEGIN  try to add range spec                        
         SCBKUP                                                                 
         ACALL ADDRNG                                                           
         END                                                                    
         ELSE  BEGIN               Multiple items...                            
         SCPUSH ,                                                               
         SH    R0,=Y(2)                                                         
         SCINIT @R1+1,(R0)                                                      
         LOOP  BEGIN                                                            
         ACALL ADDRNG                                                           
         WHILE Z,END                                                            
         SCPOP                                                                  
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   continue scan                                
         SCAN  TABLES=NOSET                                                     
         SCANCHK                                                                
         IF    (R15,EQ,4),RFIN     nothing was scanned                          
         IF    (R15,EQ,8),BEGIN    unrecognized was scanned                     
         VCALL NOTVALID            HEY,,, THIS IS STRONG EXIT                   
         END                                                                    
*                                                                               
RFIN     IF    (RNGM,Z),BEGIN      If nothing,,, set default or err             
         CLEAR R0                                                               
         IF    RNGFDOUR,'SETMSG "*"'                                            
         IF    (RNGFALL,OR,RNGFDALL),'SETMSG "ALL"'                             
         IF    (R0,Z),BEGIN                                                     
         SETMSG 'MISSING RANGE'                                                 
         IF    (RNGTYPE,EQ,RNGTFE),'SETMSG "Missing front-end range."'          
         IF    (RNGTYPE,EQ,RNGTPORT),'SETMSG "Missing port range."'             
         IF    (RNGTYPE,EQ,RNGTSES),'SETMSG "Missing line range."'              
         ERROR (R1),(R0),WR                                                     
         END                                                                    
         SCPUSH                                                                 
         SCINIT (R1),(R0)                                                       
         ACALL  ADDRNG                                                          
         SCPOP                                                                  
         END                                                                    
*                                                                               
         LR    R15,R5              RNGCB ptr                                    
         PEND                                                                   
         EJECT                                                                  
*                                                                               
GETRPRT  SCKW  ,GETRPSH,PUSH                                                    
         SCKW  ,,END                                                            
*                                                                               
GETRPSH  XPUSHRTN GETRKWS                                                       
*                                                                               
GETRKWS  SCKW  ,RNULL,NULL                                                      
         SCKW  MULTIPLE,RMULT,A                                                 
         SCKW  VERIFY,RVER,A                                                    
         SCKW  NOVERIFY,RNOVER,A                                                
         SCKW  LIST,RLIST,A                                                     
         SCKW  NOLIST,RNOLIST,A                                                 
         SCKW  ALL,RALL                                                         
         SCKW  CONSOLE,RCONSOLE,A                                               
         SCKW  VIRTUAL,RVIRTUAL,A                                               
         SCKW  SMF,RSMF                                                         
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,RUNREC                                                          
*                                                                               
RNULL    PROC                                                                   
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
RUNREC   PROC                                                                   
         LA    R15,8                                                            
         PEND                                                                   
*                                                                               
RMULT    PROC                                                                   
         SET   RNGFMULT                                                         
         PEND                                                                   
*                                                                               
RSMF     PROC                                                                   
         SET   RNGFSMF                                                          
         PEND                                                                   
*                                                                               
RVER     PROC                                                                   
         SET   RNGFVER                                                          
         PEND                                                                   
*                                                                               
RNOVER   PROC                                                                   
         CLEAR RNGFVER                                                          
         PEND                                                                   
*                                                                               
RLIST    PROC                                                                   
         SET   RNGFLIST                                                         
         PEND                                                                   
*                                                                               
RNOLIST  PROC                                                                   
         CLEAR RNGFLIST                                                         
         PEND                                                                   
*                                                                               
RALL     PROC                                                                   
         SET   RNGFALL                                                          
         PEND                                                                   
*                                                                               
RCONSOLE PROC                                                                   
         SET   RNGFALL                                                          
         MVI   RNGTTYPE,L'SIBTCONS                                              
         PEND                                                                   
*                                                                               
RVIRTUAL PROC                                                                   
         SET   RNGFALL                                                          
         MVI   RNGTTYPE,L'SIBTVIRT                                              
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  ADDRNG -- Local routine to add item to range.                                
*                                                                               
*    On entry:  scanner set up for scan                                         
*                                                                               
*    On exit, R15 (and CC):                                                     
*      4 - nothing left to scan                                                 
*      0 - ok                                                                   
ARNGWA   RECORD BEGIN                                                           
ARNGSKIP DS    256X                                                             
ARNGSTOP DS    256X                                                             
         END                                                                    
*                                                                               
*                                                                               
ADDRNG   PROC  ARNGWA                                                           
         LH    R3,RNGM                                                          
         IF    (R3,GE,RNG#*L'RNG),BEGIN                                         
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid -- too many items.',,WR                               
         END                                                                    
         LA    R4,RNG(R3)                                                       
         USING RNE,R4                                                           
         CLEAR RNE                                                              
*                                                                               
         IF    (RNGTYPE,EQ,RNGTSES),BEGIN                                       
         SCPUSH TABLES                                                          
         SETSKIP ARNGSKIP,' ,='                                                 
         SETSTOP ARNGSTOP,'(W)-(-)'     dont isolate "-"                        
         SETSCKWS RIPRTU                                                        
         SCAN  TABLES=NOSET                                                     
         SCPOP TABLES                                                           
         SCANCHK                                                                
         END                                                                    
         ELSE  BEGIN                                                            
         SCPUSH TABLES                                                          
         SETSKIP ARNGSKIP,' ,='                                                 
         SETSTOP ARNGSTOP,'(W)-(-)'     dont isolate "-"                        
         SETSCKWS RIPRT                                                         
         SCAN  TABLES=NOSET                                                     
         SCPOP TABLES                                                           
         SCANCHK                                                                
         END                                                                    
         IF    (R15,EQ,4),BEGIN    null scan                                    
         END                                                                    
         IF    (R15,EQ,8),BEGIN    regurlar item scan                           
         LH    R3,RNGM                                                          
         LA    R3,L'RNG(R3)                                                     
         STH   R3,RNGM                                                          
         CLEAR R15                                                              
         END                                                                    
         PEND                                                                   
*                                                                               
*  ADDRNG  --  SCKWS                                                            
*                                                                               
RIPRTU   SCKW  ,ADDRNULL,NULL                                                   
         SCKW  ACCOUNT,RIACCT,(A,P)                                             
         SCKW  ACCT,RIACCT,P                                                    
         SCKW  USER,RIUSER,(A,P)                                                
         SCKW  USR,RIUSER,P                                                     
         SCKW  GROUP,RIGROUP,(A,P)                                              
         SCKW  GRP,RIGROUP,P                                                    
         SCKW  OPERATOR,RIOPER,A                                                
         SCKW  OPR,RIOPER                                                       
         SCKW  0,RIOPER                                                         
RIPRT    SCKW  ,ADDRNULL,NULL                                                   
         SCKW  ,RINAME                                                          
*                                                                               
ADDRNULL PROC                                                                   
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
RIACCT   PROC                                                                   
         SCUPTOK R1                Upper case scanned token                     
         IF    (R0,NE,6),'VCALL NOTVALID'                                       
         IF    ((@R1+2,NE,'.'),AND,(@R1+3,NE,'$')),'VCALL NOTVALID'             
         ACALL RINAME                                                           
         LA    R15,8                                                            
         PEND                                                                   
*                                                                               
RIUSER   PROC                                                                   
         SCUPTOK R1                Upper case scanned token                     
         IF    (R0,NE,3),'VCALL NOTVALID'                                       
         SCUPTOK R1                                                             
         MVC   RNETEXT,CVBLANKS                                                 
         MVI   RNETEXT,C'&&'                                                    
         MVC   RNETEXT+1(3),@R1                                                 
         A     R0,CVONE                                                         
         STC   R0,RNELEN                                                        
         LA    R15,8                                                            
         PEND                                                                   
*                                                                               
RIGROUP  PROC                                                                   
         SCUPTOK R1                Upper case scanned token                     
         IF    (R0,GT,2),'VCALL NOTVALID'                                       
         MVC   RNETEXT,CVBLANKS                                                 
         MVI   RNETEXT,C'@'                                                     
         LR    R15,R0                                                           
         MOVE  R15,RNETEXT+1,@R1                                                
         A     R0,CVONE                                                         
         STC   R0,RNELEN                                                        
         LA    R15,8                                                            
         PEND                                                                   
*                                                                               
RIOPER   PROC                                                                   
         SET   RNEFMULT                                                         
         MVC   RNETEXT(8),=C'OPERATOR'                                          
         LA    R0,8                                                             
         STC   R0,RNELEN                                                        
         LA    R15,8                                                            
         PEND                                                                   
*                                                                               
RINAME   PROC                                                                   
         VCALL DEQUOTE                                                          
         IF    NEG,BEGIN           NOT QUOTED                                   
         SCUPCASE RNETEXT          UPPER CASE BLANK PAD TOKEN                   
         END                                                                    
         ELSE  BEGIN               IF QUOTED                                    
         SET   RNEFQ                                                            
         MVC   RNETEXT,CVBLANKS                                                 
         CEIL  R0,L'RNETEXT                                                     
         LR    R15,R0                                                           
         MOVE  R15,RNETEXT,@R1                                                  
         END                                                                    
         STC   R0,RNELEN                                                        
         LA    R15,8                                                            
         PEND                                                                   
         DROP  RNE,RNGCB                                                        
         EJECT                                                                  
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  TRANGE -- Routine to process range.                                          
*                                                                               
*    On entry:                                                                  
*      R0 - range selection co-routine addr                                     
*      R1 - range co-routine addr                                               
*      R15- RNGCB ptr                                                           
*                                                                               
*    On exit, R15 (and CC):                                                     
*       0 - ok                                                                  
*       4 - error                                                               
*                                                                               
*    On entry to co-routine:                                                    
*      R15- RNGCB ptr                                                           
*      R0 - range type (see "rngtype")                                          
*      R1 - FSB/PSB/SIB ptr                                                     
*                                                                               
TRNGWA   RECORD BEGIN                                                           
TRNGRNG  DS    XL(L'RNGCB)                                                      
         END                                                                    
*                                                                               
*                                                                               
TRANGE   XPROC TRNGWA                                                           
         CLEAR TRNGWA                                                           
         LR    R6,R15                                                           
         USING RNGCB,R6                                                         
         STM   R0,R1,RNGCOSEL      Save co-routine addrs                        
*                                                                               
         WHILE (RNGN,LT,RNGM),BEGIN  go through range items...                  
         LH    R5,RNGN                                                          
         LA    R5,RNG(R5)          Range item                                   
         WITH  (RNE,R5)                                                         
         CLEAR RNGFSOME,RNGITEM                                                 
         MVC   RNGLTYPE,RNGTYPE    Copy range type                              
         IF    (RNGLTYPE,Z),BEGIN  No range type...                             
         MVI   RNGLTYPE,RNGTPORT   Assume port range                            
         TSEG  RNETEXT,LC:RNELEN                                                
         TCNTL CTLSNST             Sense symbol type                            
         IF    NEG,'VCALL MILERR; B CVERROR'                                    
         IF    POS,'MVI RNGLTYPE,RNGTFE'  front-end range                       
         END                                                                    
*                                                                               
RANGELP  ACALL RNGNEXT             Next entry for this item                     
         BP    RNGNX               All done, next item                          
         MVC   RNGITEM,@R1                                                      
         IF    ^RNEFMULT,BEGIN     Make sure only one...                        
         ACALL RNGNEXT                                                          
         IF    POS,EXIT            Fine, only one                               
         IF    ((RNETEXT,NE,'ALL'),AND,(RNELEN,NE,3)),BEGIN                     
         TSEG  RNETEXT,LC:RNELEN                                                
         TSEG  ': '                                                             
         END                                                                    
         TSEG  'multiple '                                                      
         SETMSG 'users'                                                         
         IF    (RNGLTYPE,EQ,RNGTPORT),'SETMSG "ports"'                          
         IF    (RNGLTYPE,EQ,RNGTFE),'SETMSG "front-ends"'                       
         TSEG  (R1),(R0)                                                        
         TSEG  '...',,WR                                                        
         BNZ   RNGREPR                                                          
RNGMLP   LA    R1,RNGITEM                                                       
         LA    R15,RNGCB                                                        
         LA    RAR,LINEDISP                                                     
         IF    (RNGLTYPE,EQ,RNGTPORT),'LA RAR,PORTDISP'                         
         IF    (RNGLTYPE,EQ,RNGTFE),'LA RAR,NETPDISP'                           
         BASR  RAR,RAR             Go to appropriate default rtn                
         BNZ   RNGREPR                                                          
         TWRITE                                                                 
         BNZ   RNGREPR                                                          
         ACALL RNGNEXT                                                          
         IF    Z,BEGIN                                                          
         MVC   RNGITEM,@R1                                                      
         B     RNGMLP                                                           
         END                                                                    
RNGREPR  TREAD  'Select',,Q                                                     
         BNZ   RNGNX                                                            
         SCINIT (R1),(R0)                                                       
         L     R0,RNGOPT                                                        
         ICM   R0,B'0010',RNGLTYPE                                              
         N     R0,=A(-1-L'RNGFDALL-L'RNGFDOUR)                                  
         SETSCKWS GETRPRT                                                       
         LA    R15,TRNGRNG                                                      
         ACALL GETTRNG                                                          
         BZ    RNGREPR                                                          
         LM    R0,R1,RNGCOSEL      Get co-routines                              
         ACALL TRANGE              Recursive call                               
         BNZ   RNGREPR                                                          
         SET   RNGFSOME                                                         
         B     RNGNX                                                            
         END                                                                    
*                                                                               
         IF    RNGFVER,BEGIN                                                    
         LA    R1,RNGITEM                                                       
         LA    R15,RNGCB                                                        
         LA    RAR,LINEDISP                                                     
         IF    (RNGLTYPE,EQ,RNGTPORT),'LA RAR,PORTDISP'                         
         IF    (RNGLTYPE,EQ,RNGTFE),'LA RAR,NETPDISP'                           
         BASR  RAR,RAR                                                          
         TCR                                                                    
         SETMSG 'OK'                                                            
         VCALL YESRTN                                                           
         BM    RNGERR                                                           
         BP    RANGELP                                                          
         END                                                                    
*                                                                               
         LA    R15,RNGCB                                                        
         LC    R0,RNGLTYPE                                                      
         LA    R1,RNGITEM                                                       
         LT    RAR,RNGCORTN                                                     
         IF    NZ,'BASR RAR,RAR'                                                
         SET   RNGFSOME                                                         
         B     RANGELP                                                          
*                                                                               
RNGNX    IF    ^RNGFSOME,BEGIN     Nothing found...                             
         SETMSG RNETEXT,LC:RNELEN                                               
         IF    ((R0,EQ,3),AND,(@R1,EQ,'ALL')),'CLEAR R0'                        
         IF    (RNGLTYPE,EQ,RNGTSES),BEGIN                                      
         IF    (R0,Z),'SETMSG "No users found."; B RNGVM'                       
         IF    (@R1,EQ,'@'),BEGIN                                               
         XPUSH R0,R1                                                            
         TSEG  'No group',,B                                                    
         XPOP  R0,R1                                                            
         LA    R1,@R1+1                                                         
         DECR  R0                                                               
         TSEG  (R1),(R0),B                                                      
         SETMSG 'users found.'                                                  
         B     RNGVM                                                            
         END                                                                    
         TSEG  (R1),(R0)                                                        
         SETMSG ': user not found.'                                             
         B     RNGVM                                                            
         END                                                                    
         IF    (RNGLTYPE,EQ,RNGTPORT),BEGIN                                     
         IF    (R0,Z),'SETMSG "No ports found."; B RNGVM'                       
         TSEG  (R1),(R0)                                                        
         SETMSG ': port not found.'                                             
         B     RNGVM                                                            
         END                                                                    
         IF    (R0,Z),'SETMSG "No front-ends found."; B RNGVM'                  
         TSEG  (R1),(R0)                                                        
         SETMSG ': front-end not found.'                                        
RNGVM    TSEG  (R1),(R0),WR                                                     
         BNZ   RNGERR                                                           
         END                                                                    
*                                                                               
         LH    R15,RNGN                                                         
         LA    R15,@R15+L'RNE                                                   
         STH   R15,RNGN                                                         
         END                                                                    
         CLEAR R15                                                              
         B     RNGEXIT                                                          
*                                                                               
RNGERR   LA    R15,4                                                            
RNGEXIT  PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  RNGNEXT -- Local routine to get next matching item.                          
*    (Note: Entry/exit parameters described in actual routine.)                 
*                                                                               
RNGNEXT  PROC                                                                   
         IF     (RNGLTYPE,EQ,RNGTFE),'ACALL NEXTFSB' front-end range            
         ELSEIF (RNGLTYPE,EQ,RNGTPORT),'ACALL NEXTPSB' port range               
         ELSE   'ACALL NEXTSIB'                       Line range                
         PRETURN (R1)                                                           
         PEND                                                                   
*box                                                                            
*                                                                               
*  NEXTFSB -- Local routine to get next matching fsb.                           
*                                                                               
*    On entry:  RNGITEM - current FSB                                           
*                                                                               
*    On exit, R15 (and CC):                                                     
*      0 - ok (R1 - next FSB ptr)                                               
*      4 - all done                                                             
*                                                                               
NEXTFSB  PROC                                                                   
         LA    R5,RNGITEM                                                       
         WITH  (FSB,R5),'TSEG FSBID'  id                                        
*                                                                               
NFSBDO   LH    R4,RNGN                                                          
         LA    R4,RNG(R4)          Current range entry                          
         USING RNE,R4                                                           
         IF    RNGFMULT,'SET RNEFMULT'                                          
         IF    RNGFALL,'SET RNEFALL'                                            
         LC    R0,RNELEN                                                        
         AH    R0,=Y(L'RNEHDR)                                                  
         TSEG  RNEHDR,(R0)         Range info                                   
         TCNTL CTLSNSF             Sense fsb                                    
         IF    NEG,'VCALL MILERR; B CVERROR'                                    
         BP    NFSBEXIT                                                         
*                                                                               
         WITH  (FSB,R1),BEGIN                                                   
         IF    ((RNGTTYPE,NZ),AND,(RNGTTYPE,NE,FSBTYPE)),NFSBNEXT               
*                                                                               
         LA    R15,RNGCB                                                        
         LA    R0,RNGTFE                                                        
         LT    RAR,RNGCOSEL        Selection routine                            
         IF    NZ,'BASR RAR,RAR; BNZ NFSBNEXT'                                  
         CLEAR R15                                                              
         B     NFSBEXIT                                                         
*                                                                               
NFSBNEXT XPUSH ,,2,PTR=R2                                                       
         MVC   @R2(2),FSBID        Front-end identifier                         
         TSEG  (R2),2                                                           
         XPOP  ,,2                                                              
         B     NFSBDO                                                           
         END                                                                    
*                                                                               
NFSBEXIT LABEL                                                                  
         PRETURN (R1)                                                           
         PEND                                                                   
         DROP  RNE                                                              
         EJECT                                                                  
*box                                                                            
*                                                                               
*  NEXTPSB -- Local routine to get next matching PSB.                           
*                                                                               
*    On entry:  RNGITEM - current PSB                                           
*                                                                               
*    On exit, R15 (and CC):                                                     
*      0 - ok (R1 - next PSB ptr)                                               
*      4 - all done                                                             
*                                                                               
NEXTPSB  PROC                                                                   
         LA    R5,RNGITEM                                                       
         WITH  (PSB,R5),'TSEG PSBFEID; TSEG PSBPNO'  id                         
*                                                                               
NPSBDO   LH    R4,RNGN                                                          
         LA    R4,RNG(R4)          Current range entry                          
         USING RNE,R4                                                           
         IF    RNGFMULT,'SET RNEFMULT'                                          
         IF    RNGFALL,'SET RNEFALL'                                            
         LC    R0,RNELEN                                                        
         AH    R0,=Y(L'RNEHDR)                                                  
         TSEG  RNEHDR,(R0)         Range info                                   
         TCNTL CTLSNSP             Sense psb                                    
         IF    NEG,'VCALL MILERR; B CVERROR'                                    
         BP    NPSBEXIT            All done                                     
*                                                                               
         WITH  (PSB,R1),BEGIN                                                   
         IF    ((RNGTTYPE,NZ),AND,(RNGTTYPE,NE,PSBTTYPE)),NPSBNEXT              
         IF    (RNGFDIAL,AND,^PSBFDIAL),NPSBNEXT                                
         IF    (RNGFDIR,AND,^PSBFDIR),NPSBNEXT                                  
         IF    (RNGFLEAS,AND,^PSBFLEAS),NPSBNEXT                                
*                                                                               
         LA    R15,RNGCB                                                        
         LA    R0,RNGTPORT                                                      
         LT    RAR,RNGCOSEL        Selection co-routine                         
         IF    NZ,'BASR RAR,RAR; BNZ NPSBNEXT'                                  
         CLEAR R15                 Aok                                          
         B     NPSBEXIT                                                         
*                                                                               
NPSBNEXT XPUSH ,,4,PTR=R2                                                       
         MVC   @R2(2),PSBFEID                                                   
         MVC   @R2+2(2),PSBPNO                                                  
         TSEG  (R2),4              Port identifier                              
         XPOP  ,,4                                                              
         B     NPSBDO                                                           
         END                                                                    
*                                                                               
NPSBEXIT LABEL                                                                  
         PRETURN (R1)                                                           
         PEND                                                                   
         DROP  RNE                                                              
         EJECT                                                                  
*box                                                                            
*                                                                               
*  NEXTSIB -- Local routine to get next matching SIB.                           
*                                                                               
*    On entry:  RNGITEM - current SIB                                           
*                                                                               
*    On exit, R15 (and CC):                                                     
*      0 - ok (R1 - next SIB ptr)                                               
*      4 - all done                                                             
*                                                                               
NEXTSIB  PROC                                                                   
         LA    R5,RNGITEM                                                       
         WITH  (SIB,R5),'TSEG SIBID; TSEG SIBNO'  Session id                    
*                                                                               
NSIBDO   LH    R4,RNGN                                                          
         LA    R4,RNG(R4)          Current range entry                          
         USING RNE,R4                                                           
         IF    RNGFMULT,'SET RNEFMULT'                                          
         IF    RNGFALL,'SET RNEFALL'                                            
         TSEG  RNEHDR              Fixed header                                 
         IF    RNEFQ,BEGIN         If quoted, give as is                        
         TSEG  RNETEXT,LC:RNELEN                                                
         END                                                                    
         ELSE  BEGIN               If not quoted, treat as account              
         XPUSH ,,8,PTR=R2          Room for "uuugg" account                     
         SETMSG RNETEXT,LC:RNELEN   User-id                                     
         LR    R15,R2              Put account here                             
         VCALL GETACCT             Get account if this is a userid              
         IF    NZ,'TSEG (R1),(R0)'  Not a userid                                
         ELSE  BEGIN               Ask Milten about account...                  
         TSEG  @R2+3,2             gg                                           
         TSEG  '.'                                                              
         TSEG  @R2,3               uuu                                          
         END                                                                    
         XPOP  ,,8                                                              
         END                                                                    
*                                                                               
         TCNTL CTLSNSI             Sense SIB                                    
         IF    NEG,'VCALL MILERR; B CVERROR'                                    
         BP    NSIBEXIT                                                         
*                                                                               
         WITH  (SIB,R1),BEGIN                                                   
         IF    ((RNGTTYPE,NZ),AND,(RNGTTYPE,NE,SIBTYPE)),NSIBNEXT               
         IF    (RNGFDIAL,AND,^SIBFDIAL),NSIBNEXT                                
         IF    (RNGFDIR,AND,^SIBFDIR),NSIBNEXT                                  
         IF    (RNGFLEAS,AND,^SIBFLEAS),NSIBNEXT                                
*                                                                               
         LA    R15,RNGCB                                                        
         LA    R0,RNGTSES                                                       
         LT    RAR,RNGCOSEL                                                     
         IF    NZ,'BASR RAR,RAR; BNZ NSIBNEXT'                                  
         CLEAR R15                                                              
         B     NSIBEXIT                                                         
*                                                                               
NSIBNEXT XPUSH ,,6,PTR=R2                                                       
         MVC   @R2(4),SIBID                                                     
         MVC   @R2+4(2),SIBNO                                                   
         TSEG  (R2),6              Session identifier                           
         XPOP  ,,6                                                              
         B     NSIBDO                                                           
         END                                                                    
*                                                                               
NSIBEXIT LABEL                                                                  
         PRETURN (R1)                                                           
         PEND                                                                   
         DROP  RNE                                                              
*                                                                               
         DROP  RNGCB                                                            
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  NETPDISP -- Routine to display the status of a front-end.                    
*                                                                               
*    On entry:                                                                  
*      R1 - FSB ptr                                                             
*                                                                               
*    On exit, R15 (and CC):                                                     
*      0 - ok                                                                   
*      4 - attn during write                                                    
*                                                                               
NETPDISP XPROC  ,                                                               
         LR    R6,R1                                                            
         USING FSB,R6                                                           
         LR    R5,R15                                                           
         USING RNGCB,R5                                                         
*                                                                               
         TSEG  FSBNAME,,B                                                       
*                                                                               
         OC    FSBINFO,CVBLANKS    (make zeros = blanks)                        
         SETMSG FSBINFO                                                         
         IF    FSBFCLS,BEGIN                                                    
         SETMSG '--closing-- '                                                  
         IF    FSBFDOWN,'SETMSG "--closed--  "'                                 
         END                                                                    
         IF    FSBFDET,'SETMSG "--detached--"'                                  
         TSEG  (R1),(R0)                                                        
*                                                                               
         TNUM  LH:FSBSCUR,4                                                     
         TSEG  ' users'                                                         
*                                                                               
         TNUM  LH:FSBSMAX,5                                                     
         TSEG  ' max'                                                           
*                                                                               
         TNUM  L:FSBNIO,9                                                       
         TSEG  ' I/O''s'                                                        
*                                                                               
         IF    (FSBNHWE,NZ),BEGIN                                               
         TSEG  ' ('                                                             
         TNUM  L:FSBNHWE                                                        
         TSEG  ' err)'                                                          
         END                                                                    
*                                                                               
         IF    (FSBQMAX,NZ),BEGIN                                               
         TSEG  ' (Depth='                                                       
         TNUM  LH:FSBQMAX                                                       
         TSEG  ')'                                                              
         END                                                                    
*                                                                               
         TCR                                                                    
*                                                                               
         IF    (FSBMSG,NZ),BEGIN                                                
         TSEG  CVBLANKS,2                                                       
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         LR    R3,R1                                                            
         LM    R0,R1,FSBMCLCK                                                   
         IF    (R0,NZ),BEGIN                                                    
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK                                                         
         TSEG  (R1),(R0),B                                                      
         XPOP  ,,30                                                             
         END                                                                    
         TSEG  FSBMSG,,WR                                                       
         BNZ   FEXIT                                                            
         END                                                                    
         TWRITE                                                                 
*                                                                               
FEXIT    PEND                                                                   
         DROP  RNGCB,FSB                                                        
         EJECT                                                                  
*box                                                                            
*                                                                               
*  PORTDISP -- Routine to display the status of a port.                         
*                                                                               
*    On entry:                                                                  
*      R1 - PSB ptr                                                             
*                                                                               
*    On exit, R15 (and CC):                                                     
*      0 - ok                                                                   
*      4 - attn during write                                                    
*                                                                               
PORTDISP XPROC  ,                                                               
         LR    R6,R1                                                            
         USING PSB,R6                                                           
         LR    R5,R15                                                           
         USING RNGCB,R5                                                         
*                                                                               
         SETMSG PSBFENM                                                         
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  '-'                                                              
         SETMSG PSBNAME                                                         
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),B                                                      
*                                                                               
         SETMSG PSBINFO                                                         
         IF    (PSBINFO,Z),'LA R1,CVBLANKS'                                     
         TSEG  (R1),(R0),B                                                      
*                                                                               
         SETMSG PSBLOC                                                          
         IF    (PSBLOC,Z),'LA R1,CVBLANKS'                                      
         TSEG  (R1),(R0),B                                                      
*                                                                               
         IF    PSBFDUM,BEGIN                                                    
         TSEG  '(Dummy)',,B                                                     
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  'I/O''S='                                                        
         BTD   CPDOUB,0,L:PSBNIO                                                
         TSEG  (R1),(R0),B                                                      
         IF    (PSBNHWE,NZ),BEGIN                                               
         TSEG  '('                                                              
         BTD   CPDOUB,0,L:PSBNHWE                                               
         TSEG  (R1),(R0),B                                                      
         TSEG  'err)',,B                                                        
         END                                                                    
*                                                                               
         IF    PSBFDIAL,'TSEG "(DIAL)",,B'                                      
         IF    PSBFDIR,'TSEG "(DIRECT)",,B'                                     
         IF    PSBFGAND,'TSEG "(GANDALF)",,B'                                   
         IF    PSBFRLIN,'TSEG "(RLIN)",,B'                                      
         IF    PSBFLEAS,'TSEG "(LEASED)",,B'                                    
         IF    PSBFTEL,'TSEG "(TELENET)",,B'                                    
         IF    PSBFTYM,'TSEG "(TYMNET)",,B'                                     
*                                                                               
         IF    PSBFHU,'TSEG "(HUNG-UP)",,B'                                     
*                                                                               
         IF    PSBFSTOP,BEGIN                                                   
         SETMSG '(STOPPING)'                                                    
         IF    PSBFDOWN,'SETMSG "(STOPPED)"'                                    
         TSEG  (R1),(R0),B                                                      
         END                                                                    
         IF    PSBFDET,'TSEG  "(DETACHED)",,B'                                  
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
         DROP  RNGCB,PSB                                                        
         EJECT                                                                  
*box                                                                            
*                                                                               
*  LINEDISP -- Routine to display status of a session.                          
*                                                                               
*    On entry:                                                                  
*      R1 - SIB ptr                                                             
*                                                                               
*    On exit, R15 (and CC):                                                     
*      0 - ok                                                                   
*      4 - attn during write                                                    
*                                                                               
LINEDISP XPROC  ,                                                               
         LR    R6,R1                                                            
         USING SIB,R6                                                           
*-                                                                              
*-       Milten line number.                                                    
*-                                                                              
         BTD   CPDOUB,4,LH:SIBNO                                                
         TSEG  (R1),(R0),B                                                      
*-                                                                              
*-       Userid (or account).                                                   
*-                                                                              
         IF    (SIBACCT,Z),BEGIN   No account...                                
         TSEG  '------'                                                         
         TSEG  CVBLANKS,3                                                       
         END                                                                    
*                                                                               
         ELSE  BEGIN               Account...                                   
         LA    R15,SIBACCT         Account in "gg.uuu" format                   
         XPUSH ,,32,PTR=R1                                                      
         SETMSG @R1,32                                                          
*                                                                               
         VCALL GETUID              Get userid for this account                  
         IF    Z,BEGIN             Found it...                                  
         IF    (R0,LT,8),'LA R0,8'                                              
         LR    R2,R0                                                            
         TSEG  (R1),(R0),B         Seg userid                                   
         IF    (R2,GT,8),'TSEG " "'                                             
         END                                                                    
*                                                                               
         ELSE  BEGIN               No userid, use account...                    
         TSEG  SIBGRP                                                           
         TSEG  '.'                                                              
         TSEG  SIBUSER                                                          
         L2    R2,SIBANO                                                        
         SETMSG CVBLANKS,2                                                      
         IF    (R2,GT,1),'TSEG "#"; BTD CPDOUB,0,(R2)'                          
         TSEG  (R1),(R0),B                                                      
         END                                                                    
*                                                                               
         XPOP  ,,20                                                             
         END                                                                    
*-                                                                              
*-       User name.                                                             
*-                                                                              
         SETMSG SIBNAME                                                         
         IF    (SIBNAME,Z),'CLEAR R0'                                           
         VCALL RTRIM                                                            
*                                                                               
         IF    ^SIBFKEPT,BEGIN     Not a 'kept' session...                      
         IF    SIBFLGF,'SETMSG "--logging off--"'                               
         IF    SIBFDSC,'SETMSG "--disconnected--"'                              
         IF    SIBFHU,'SETMSG "--hung-up--"'                                    
         IF    SIBFSTOP,BEGIN                                                   
         SETMSG '--stopping--'                                                  
         IF    SIBFDOWN,'SETMSG "--stopped--"'                                  
         END                                                                    
         IF    SIBFDET,'SETMSG "--detached--"'                                  
         END                                                                    
         VCALL CHARFMT                                                          
*                                                                               
         TCOL  36                                                               
         SETMSG CVBLANKS,8                                                      
         IF    (SIBSUB,NZ),'SETMSG SIBSUB'  Subsystem name                      
         IF    (SIBSUB,EQ,'ORVYL'),BEGIN                                        
         IF    ((SIBVPGM,NZ),AND,(SIBVPGM,NE,' ')),'SETMSG SIBVPGM'             
         END                                                                    
         TSEG  (R1),(R0),B                                                      
*                                                                               
         IF    (SIBFE,NZ),BEGIN    We have the port info...                     
*-                                                                              
*-       Show ELF ports as "hostname-pid", usually.  The logic                  
*-         is a little more complex than just "fename-portname".                
*-                                                                              
         IF    SIBTELF,BEGIN       ELF style...                                 
         IF    (SIBPINFO,NZ),'TSEG SIBPINFO,,T'                                 
         ELSE  'TSEG SIBFE,,T; TSEG "-"; TSEG SIBPORT,,T'                       
*                                                                               
         IF    (SIBPLOC,NZ),'TSEG  " ["; TSEG  SIBPLOC,,T; TSEG "]"'            
         END                                                                    
*-                                                                              
*-       Display port identification as "fename-portname".                      
*-                                                                              
         ELSE  BEGIN               All other front-ends...                      
         TSEG  SIBFE,,T                                                         
         IF    (SIBPORT,NZ),'TSEG "-"; TSEG SIBPORT,,T'                         
         END                                                                    
         END                                                                    
*                                                                               
         ELSE  BEGIN               No front-end info...                         
         IF    SIBFKEPT,'TSEG "LOGGED OFF"'                                     
         END                                                                    
*                                                                               
         TSEG  CVBLANKS,1                                                       
*                                                                               
         CLEAR R15                 Good RC                                      
         PEND                                                                   
         DROP  SIB                                                              
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
SENDWA   RECORD BEGIN                                                           
*                                                                               
SENDID   DS    F                   Session id                                   
SENDNO   DS    H                   Session number                               
         DS    XL12                Flags, etc.                                  
SENDGRP  DS    CL2                 gg                                           
SENDDOT  DS    C                     .                                          
SENDUSER DS    CL3                    uuu                                       
SENDHDR  EQU   SENDID,*-SENDID,C'X'                                             
*                                                                               
SENDPTRS DS    2A                  Text location, length                        
SENDRC   DS    H                   Return code                                  
*                                                                               
SENDINIT EQU   SENDID,*-SENDID,C'X'                                             
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SENDMSG -- Routine to send an asynchronous message to another                
*    user.                                                                      
*                                                                               
*    On entry:                                                                  
*      R1,R0 - text location, length                                            
*      R15 - account (uuugg format)                                             
*                                                                               
*    On exit, R15 (and CC):                                                     
*      -4 - user not found                                                      
*       0 - sent                                                                
*       4 - user found but not sent (NOCOMM)                                    
*                                                                               
SENDMSG  XPROC SENDWA                                                           
         CLEAR SENDINIT                                                         
*                                                                               
         STM   R0,R1,SENDPTRS                                                   
         MVC   SENDGRP,@R15+3                                                   
         MVI   SENDDOT,C'.'                                                     
         MVC   SENDUSER,@R15                                                    
*                                                                               
         MVC   SENDRC,=H'-4'       Assume not found                             
*                                                                               
         LOOP  BEGIN                                                            
SENDLP   TCLEAR                                                                 
*                                                                               
         CLEAR R2                                                               
         IF    CPFQUIET,'LA R2,1; CLEAR CPFQUIET'                               
         TSEG  SENDHDR                                                          
         IF    (R2,NZ),'SET CPFQUIET'                                           
*                                                                               
         TCNTL CTLSNSI             Sense next session                           
         IF    NZ,EXIT             All done, scram                              
*                                                                               
         WITH  (SIB,R1),BEGIN                                                   
         MVC   SENDID,SIBID                                                     
         MVC   SENDNO,SIBNO                                                     
*                                                                               
         IF    SIBFNMSG+SIBFNCOM,BEGIN  Can't send...                           
         IF    (SENDRC,NZ),'MVC SENDRC,=H"4"'  Set rc                           
         B     SENDLP                                                           
         END                                                                    
         END                                                                    
*-                                                                              
*-       Send asynchronous message.                                             
*-                                                                              
         CLEAR R2                                                               
         IF    CPFQUIET,'LA R2,1; CLEAR CPFQUIET'                               
*                                                                               
         TSEG  X'2F15'             Bel,nl                                       
         VCALL LOCALTOD                                                         
         XPUSH ,,11,PTR=R15                                                     
         VCALL FMTTIME                                                          
         TSEG  (R1),5,B            Hh:mm                                        
         XPOP  ,,11                                                             
         LM    R0,R1,SENDPTRS                                                   
         TSEG  (R1),(R0)           Message to send                              
         TSEG  X'15'               Nl                                           
*                                                                               
         IF    (R2,NZ),'SET CPFQUIET'                                           
*                                                                               
         L     R1,SENDID           Session id                                   
         VCALL TASWRITE            Send it                                      
         IF    Z,'CLEAR SENDRC'                                                 
         END                                                                    
*                                                                               
         LH    R15,SENDRC          Return code                                  
         PEND                                                                   
*                                                                               
.NOMIL   ANOP  ,                   *** PCODE                                    
         QLTORG                                                                 
*                                                                               
         VLTORG                                                                 
*                                                                               
         END   .                                                                
