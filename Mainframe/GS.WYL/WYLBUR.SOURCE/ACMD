ACMD     TITLE 'WYLBUR''S Accounting Commands'                                  
*******************************************************************             
*                                                                 *             
*     WYLBUR/370 - Release VI - Class I - Stanford Proprietary    *             
*                                                                 *             
*******************************************************************             
         HIBAL                                                                  
*                                                                               
WYLACMD  CSECT                                                                  
ACMD     IDENT 4072                10:30:05 03/12/04  (SLP)                     
         REGS  FSR,,,,,,,BR,(WAR,LSR),PAR,PBR,CPR,CVR,SPR,RAR                   
*                                                                               
         SYSDEFN ,                 Define installation params                   
*                                                                               
         GBLC  &INSTALN,                   (See SYSDEFN)                        
         GBLC  &STDFORM                    (See SYSDEFN)                        
         GBLB  &JOBAUTH,&SETLTIM,&KEYUPLO  (See SYSDEFN)                        
         GBLB  &SPACE,&BUDGET              (See SYSDEFN)                        
*                                                                               
         PUSH  DSECTS                                                           
         COPY  CONTROL             Copy CV/CP                                   
         TITLE 'DSECTS'                                                         
         RECORD 'SIB'                                                           
*                                                                               
         RECORD 'PDB'                                                           
*                                                                               
         COPY  UTYPDEFN                                                         
*                                                                               
         COPY  RTNCODES                                                         
*                                                                               
JCB      RECORD BEGIN                                                           
         COPY  JCB                                                              
         END                                                                    
*                                                                               
UCE      RECORD BEGIN                                                           
         COPY  UCE                                                              
         END                                                                    
*                                                                               
SMFHDR   RECORD BEGIN                                                           
         COPY  SMFHDR                                                           
         END                                                                    
*                                                                               
SMFACCT  RECORD BEGIN                                                           
         DS    XL(L'SMFHDR)        Standard header                              
         COPY  SMFACCT                                                          
         END                                                                    
*                                                                               
SMFKWR   RECORD BEGIN                                                           
         DS    XL(L'SMFHDR)        Standard header                              
*                                                                               
         DS    XL4                 Reserved                                     
*                                                                               
         COPY  SMFKWR                                                           
         END                                                                    
*                                                                               
         COPY  KRB                 KLOGIN record                                
*                                                                               
         POP   DSECTS                                                           
         EJECT                                                                  
WA       RECORD BEGIN                                                           
KWR      KWR                                                                    
*                                                                               
WAFLAG   FLAG                                                                   
         FLAG  WAFOP               - At least one option specified              
         FLAG  WAFMAST             - Set master command                         
         FLAG  WAFXSYS             - SYSx specified (SET MASTER)                
         FLAG  WAFTEMP             - TEMPORARY option specified                 
*                                                                               
WAFLAG2  FLAG                                                                   
         FLAG  WAFDHEX             - SHOW MASTER.. display in hex               
         FLAG  WAFNEW              - New account (set master)                   
         FLAG  WAFDEL              - Set master delete                          
         FLAG  WAFCRE              - Set master create                          
         FLAG  WAFUPDPW            - Set master: update password                
*                                                                               
         DS    0D                                                               
WASCSAVE DS    XL(L'NSCNCB)        Scan CB save area                            
         END                                                                    
         TITLE 'SET/SHOW NAME Commands'                                         
*box                                                                            
*                                                                               
*  SETNAME -- SET NAME command.                                                 
*                                                                               
SETNAME  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         IF    (CPSTCONS,AND,(CPSNAME,NZ)),BEGIN                                
         ABORT 'CONSOLE name can''t be changed'                                 
         END                                                                    
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
*                                                                               
         LOOP  BEGIN                                                            
         SCRSTR AREA=WASCSAVE                                                   
         SCAN  NAMEPRT                                                          
         SCANCHK                                                                
         IF    ^WAFOP,'ERROR "Missing SET NAME options"'                        
         ACALL PUTKWR                                                           
         UNTIL Z,END               Loop until re-write is ok                    
*                                                                               
         IF    (CPCACCT,EQ,CPSACCT),BEGIN                                       
         WHILE ((CPSNAME,Z),OR,(CPSNAME,EQ,CPNAME)),BEGIN                       
         MVC   CPSNAME,KWRNAME     Update session name too                      
         VCALL UPDCPSIB                                                         
         IF    Z,EXIT                                                           
         END                                                                    
         MVC   CPNAME,KWRNAME      Save our new name                            
         END                                                                    
*                                                                               
***      LA    R0,SMFWNAME+SMFWAUTH                                             
***      VCALL LOGKWR              write smf log record                         
*                                                                               
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                   NOTE: we exit to CVNEXT above                
         DROP  WA                                                               
         EJECT                                                                  
**                                                                              
**  SET NAME Options                                                            
**                                                                              
NAMEPRT  SCKW  ,KNAME                                                           
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWNAME -- SHOW NAME/ANAME command.                                         
*                                                                               
SHOWNAME XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LA    R0,1                                                             
         ACALL GETAENT                                                          
         VCALL COLLOPTS            Allow standard options                       
*                                                                               
         ACALL SEGACCT                                                          
         SETMSG KWRNAME                                                         
         IF    (KWRNAME,Z),'SETMSG "No name set."'                              
         TSEG  (R1),(R0)                                                        
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                   NOTE: we exit to CVNEXT above                
         DROP  WA                                                               
         EJECT                                                                  
         TITLE 'SET PACCOUNT Command'                                           
*box                                                                            
*                                                                               
*  SETPACCT -- SET PACCOUNT Command.                                            
*                                                                               
SETPACCT XPROC WA                                                               
*                                                                               
         IF    ^CPFXAUTH,BEGIN                                                  
         ABORT 'Authorized command not allowed here.'                           
         END                                                                    
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LA    R0,1                                                             
         ACALL GETAENT                                                          
         VCALL COLLOPTS                                                         
*                                                                               
         IF    (CPCACCT,EQ,CPSACCT),'CLEAR CPPACCT'                             
         ELSE  'MVC CPPACCT,CPCACCT'                                            
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                   NOTE: we exit to CVNEXT above                
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETXMAIL -- SET XMAIL/NOXMAIL Commands.                                      
*                                                                               
SETXMAIL XPROC                                                                  
         SETMSG '"XCALL WYL.GG.JDN.MS#SETXMAIL/"'                               
         IF    (CPCMNM,EQ,'N'),BEGIN                                            
         SETMSG '"XCALL WYL.GG.JDN.MS#SETXMAIL/OFF"'                            
         END                                                                    
         VCALL GBLCMD              Shouldn't return                             
         ABORT 'Can''t SET XMAIL/NOXMAIL.'                                      
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETMAIL -- SET MAIL/NOMAIL Commands.                                         
*                                                                               
SETMAIL  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
*                                                                               
         LOOP  BEGIN                                                            
         SCRSTR AREA=WASCSAVE                                                   
         SET   KWROFL.KWRFMAIL     User wants mail                              
         IF    (CPCMNM,EQ,'N'),'CLEAR KWROFL.KWRFMAIL'                          
         SCAN  MAILPRT                                                          
         SCANCHK                                                                
         ACALL PUTKWR                                                           
         UNTIL Z,END               Loop until re-write is ok                    
*                                                                               
***      LA    R0,SMFWMAIL+SMFWAUTH                                             
***      VCALL LOGKWR              write smf log record                         
*                                                                               
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL MBOXDISP            Show mail box status                         
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                   NOTE: we exit to CVNEXT above                
         EJECT                                                                  
**                                                                              
**  SET MAIL Options                                                            
**                                                                              
MAILPRT  SCKW  NOFORWARD,KNOFWD,A                                               
         SCKW  FORWARD,KFORWARD,A                                               
         SCKW  ATTN,KATTN,A                                                     
         SCKW  NOATTN,KNOATTN,A                                                 
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,KMAILTXT                                                        
         SPACE 2                                                                
KFORWARD PROC                                                                   
*                                                                               
         COMMENT                   Scan mail addr, allow wierd chars            
         SCANSTR                                                                
         SCANCHK                                                                
*                                                                               
         IF    (R0,Z),'ERROR "Missing FORWARD mail address."'                   
*                                                                               
         COMMENT                   IF 'UUU'                                     
         IF    (R0,EQ,3),BEGIN     Convert 'uuu' to 'gg.uuu'...                 
         SCUPTOK R1                                                             
         IF    (@R1,EQ,CPCUSER),BEGIN                                           
         CLEAR KWRMFOR                                                          
         END                                                                    
         ELSE  BEGIN                                                            
         MVC   KWRMFOR,CVBLANKS                                                 
         MVC   KWRMFOR(2),CPSGRP                                                
         MVI   KWRMFOR+2,C'.'                                                   
         MVC   KWRMFOR+3(3),@R1                                                 
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   IF 'GG.UUU'                                  
         ELSEIF  ((R0,EQ,6),AND,(@R1+2,EQ,'.')),BEGIN                           
         SCUPTOK R1                                                             
         IF    ((@R1,EQ,CPCGRP),AND,(@R1+3,EQ,CPCUSER)),BEGIN                   
         CLEAR KWRMFOR                                                          
         END                                                                    
         ELSE  BEGIN                                                            
         MVC   KWRMFOR,CVBLANKS                                                 
         MVC   KWRMFOR(6),@R1                                                   
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   IF 'GG$UUU'                                  
         ELSEIF  ((R0,EQ,6),AND,(@R1+2,EQ,'$')),BEGIN                           
         SCUPTOK R1                                                             
         IF    ((@R1,EQ,CPCGRP),AND,(@R1+3,EQ,CPCUSER)),BEGIN                   
         CLEAR KWRMFOR                                                          
         END                                                                    
         ELSE  BEGIN                                                            
         MVC   KWRMFOR,CVBLANKS                                                 
         MVC   KWRMFOR(6),@R1                                                   
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   IF 'UUU$GG'                                  
         ELSEIF  ((R0,EQ,6),AND,(@R1+3,EQ,'$')),BEGIN                           
         SCUPTOK R1                                                             
         IF    ((@R1,EQ,CPCUSER),AND,(@R1+4,EQ,CPCGRP)),BEGIN                   
         CLEAR KWRMFOR                                                          
         END                                                                    
         ELSE  BEGIN                                                            
         MVC   KWRMFOR,CVBLANKS                                                 
         MVC   KWRMFOR(6),@R1                                                   
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   ALL OTHER ADDRESSES                          
         ELSE  BEGIN                                                            
         MVC   KWRMFOR,CVBLANKS                                                 
         LR    R15,R0                                                           
         CEIL  R15,L'KWRMFOR                                                    
         MOVE  R15,KWRMFOR,@R1                                                  
         END                                                                    
*                                                                               
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNOFWD   PROC                                                                   
         CLEAR KWRMFOR                                                          
         PEND                                                                   
*                                                                               
KNOATTN  PROC                                                                   
         SET   KWRTFL2.KWRTFMNOATTN                                             
         PEND                                                                   
*                                                                               
KATTN    PROC                                                                   
         CLEAR KWRTFL2.KWRTFMNOATTN                                             
         PEND                                                                   
*                                                                               
KMAILTXT PROC                                                                   
         VCALL DEQUOTE                                                          
         IF    M,BEGIN                                                          
         VCALL NOTVALID                                                         
         END                                                                    
         MVC   KWRMTXT,CVBLANKS                                                 
         LR    R15,R0                                                           
         CEIL  R15,L'KWRMTXT                                                    
         MOVE  R15,KWRMTXT,@R1                                                  
         IF    (KWRMTXT,EQ,CVBLANKS),'CLEAR KWRMTXT'                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  MBOXDISP -- Routine to display mail box status (also called                  
*    by the SHOW MAIL STATUS command).                                          
*                                                                               
*    On entry:                                                                  
*      R1 - KWR ptr                                                             
*                                                                               
MBOXDISP XPROC                                                                  
         LR    R6,R1               Kwr ptr                                      
         USING KWR,R6                                                           
         SETMSG 'Your account can not receive new mail.'                        
         IF    KWROFL.KWRFMAIL,BEGIN                                            
         SETMSG 'Your account can receive new mail.'                            
         IF    (KWRMFOR,NZ),BEGIN                                               
         TSEG  'New mail is being forwarded to '                                
         SETMSG KWRMFOR                                                         
         END                                                                    
         END                                                                    
         TSEG  (R1),(R0),CR                                                     
*                                                                               
         IF    (KWRMTXT,NZ),BEGIN                                               
         TSEG  'Your mail message is: '                                         
         TSEG  KWRMTXT,,T                                                       
         TCR                                                                    
         END                                                                    
*                                                                               
         IF    KWRTFL2.KWRTFMNOATTN,'TSEG "NO"'                                 
         TSEG  'ATTN '                                                          
*                                                                               
         TSEG  '- SHOW MAIL options',,CR                                        
*                                                                               
         TWRITE                                                                 
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  KWR                                                              
         TITLE 'SET/SHOW WCHARGE Commands'                                      
*box                                                                            
*                                                                               
*  SETWCH -- SET WCHARGE Command.                                               
*                                                                               
         MACRO                                                                  
&L       SETWCH &OLD,&NEW                                                       
&L       IF    (SETWCHAR,EQ,'&OLD '),BEGIN                                      
         MVC   SETWCHAR,=CL(L'SETWCHAR)'&NEW'                                   
         END                                                                    
         MEND                                                                   
*-                                                                              
         MACRO                                                                  
&L       SETWPASS &COMP,&PASS                                                   
&L       IF    (SETWCHAR,EQ,'&COMP'),BEGIN  Component stem match...             
         CLC   SETWPASS,=CL(L'SETWPASS)'&PASS'  Correct password?               
         IF    EQ,'LA R2,1'        Yes                                          
         END                                                                    
         MEND                                                                   
*-                                                                              
SETWWA   RECORD BEGIN                                                           
SETWCHAR DS    CL(L'CPWCHAR)       WCHARGE component                            
SETWPASS DS    CL8                 Associated password                          
         END                                                                    
*-                                                                              
SETWCH   XPROC SETWWA                                                           
         LA    R6,SETWWA                                                        
         USING SETWWA,R6                                                        
         CLEAR SETWWA                                                           
*-                                                                              
*-       Save WCHARGE component name.                                           
*-                                                                              
         SCAN                                                                   
         SCANCHK                                                                
         IF    (R0,NP),'MVC SETWCHAR,=CL(L"SETWCHAR)"GENERAL"'                  
*                                                                               
         ELSE  BEGIN                                                            
         SCUPCASE SETWCHAR         Set component name                           
*                                                                               
         SETWCH FOLIO,FOLIO_GENERAL                                             
         SETWCH FOLIOSOC,FOLIO_SOCRATES                                         
         SETWCH FOLIOAIR,FOLIO_AIR                                              
         SETWCH FOLIOBST,FOLIO_BOOKSTORE                                        
         SETWCH FOLIOCIP,FOLIO_COMMINFO                                         
         SETWCH FOLIOHBR,FOLIO_HBR                                              
         SETWCH FOLIOHOV,FOLIO_HOOVER                                           
         SETWCH FOLIOINV,FOLIO_INVEST                                           
         SETWCH FOLIOMLK,FOLIO_MLKING                                           
         SETWCH PRISM,PRISM_GENERAL                                             
         SETWCH PRISMNC,PRISM_NC                                                
         SETWCH PRISMSMS,PRISM_SMAS                                             
         SETWCH PRISMPEV,PRISM_PUBEVENTS                                        
         SETWCH PRISMSUF,PRISM_SUFIN                                            
         SETWCH PRISMNSI,PRISM_NSI                                              
         SETWCH PRISMSNP,PRISM_SNAP                                             
         SETWCH PRISMCLS,PRISM_CLASS                                            
         SETWCH PRISMOTH,PRISM_MISC                                             
         END                                                                    
*-                                                                              
*-       Scan SET WCHARGE options.                                              
*-                                                                              
         SCAN  SETWPRT                                                          
         SCANCHK                                                                
*-                                                                              
*-       Only save the new charge component name if an authorized               
*-         program is currently running.                                        
*-                                                                              
         CLEAR R2                  Assume not authorized                        
         IF    CPSVFLAG.CPSVFRUN*CPSVFATH,'LA R2,1'  Authorized pgm             
         IF    CPFXAUTH,'LA R2,1'  Authorized exec                              
*-                                                                              
*-       A "typed command" should never be considered authorized.               
*-         This is a bypass-fix for the fact that Orvyl doesn't                 
*-         currently clear the VFRUN flag when a program pauses.                
*-                                                                              
         IF    CPFTYPED,'CLEAR R2'  Typed command is never auth                 
*-                                                                              
*-       Allow setting these component names if the password is                 
*-         supplied.                                                            
*-                                                                              
         SETWPASS FEEDIT_,ALGERNON                                              
         SETWPASS EMS_,UMAIL4US                                                 
         SETWPASS WYLMAIL,<internal>                                            
         SETWPASS XBEGIN_,LEVEL2                                                
         SETWPASS PUBLISH,POSTFIX                                               
*                                                                               
         IF    (R2,Z),BEGIN        Not authorized...                            
         IF    (SETWCHAR,EQ,'GENERAL '),EXIT  Always allow a reset              
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
         MVC   CPWCHAR,SETWCHAR    Set charging component                       
*                                                                               
         B     CVNEXT                                                           
         PEND  ,                   NOTE: we exit to CVNEXT above                
         SPACE                                                                  
*-                                                                              
*-       SET WCHARGE Options.                                                   
*-                                                                              
SETWPRT  SCKW  /,SWPASS,(A,P)                                                   
         SCKW  ,V(SCNINVAL)                                                     
*                                                                               
SWPASS   PROC                                                                   
         SCUPCASE SETWPASS                                                      
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWCH -- SHOW WCHARGE Command.                                             
*                                                                               
SHOWWCH  XPROC ,                                                                
         VCALL COLLOPTS            Allow standard options                       
*                                                                               
         IF    (CPWCHAR,Z),BEGIN   (Should ever happen, but...)                 
         TSEG  'No charging component is set.'                                  
         END                                                                    
*                                                                               
         ELSE  BEGIN                                                            
         TSEG  CPWCHAR,,TB                                                      
         TSEG  '- charging component.'                                          
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                   NOTE: we exit to CVNEXT above                
         DROP  BR                                                               
         TITLE 'WEVENT Command'                                                 
*box                                                                            
*                                                                               
*  WEVENT -- WEVENT command.                                                    
*                                                                               
WEVENT   XPROC                                                                  
*                                                                               
         SCINFO                                                                 
         VCALL LRTRIM              Everything after WEVENT                      
         LA    R15,=CL8'COMMAND'   Log type                                     
         VCALL LOGEVENT            Log it                                       
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                   NOTE: we exit to CVNEXT above                
*                                                                               
         QLTORG                                                                 
         TITLE 'SET/SHOW AUTO Commands'                                         
*box                                                                            
*                                                                               
*  SETAUTO -- SET AUTO command.                                                 
*                                                                               
SETAUTO  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
*                                                                               
         LOOP  BEGIN                                                            
         SCRSTR AREA=WASCSAVE                                                   
         SCAN  AUTOPRT                                                          
         SCANCHK                                                                
         IF    ^WAFOP,'ERROR "Missing SET AUTO options."'                       
         ACALL PUTKWR                                                           
         UNTIL Z,END               Loop until re-write is ok                    
*                                                                               
         LA    R0,SMFWAUTO+SMFWAUTH                                             
         VCALL LOGKWR              Write smf log record                         
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL AUTODISP                                                         
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                                                                
         EJECT                                                                  
**                                                                              
**  SET AUTO Options                                                            
**                                                                              
AUTOPRT  SCKW  NEWS,KNEWS,A                                                     
         SCKW  NONEWS,KNONEWS,A                                                 
         SCKW  MULTIPLE,KMULT,A                                                 
         SCKW  SINGLE,KNOMULT,A                                                 
         SCKW  NOMULTIPLE,KNOMULT,A                                             
         SCKW  XMULTIPLE,KXMULT,A                                               
         SCKW  NDATE,KNDATE,A                                                   
         SCKW  MAIL,KAMAIL,A                                                    
         SCKW  NOMAIL,KANOMAIL,A                                                
         SCKW  RECOVERY,KRCVY,A                                                 
         SCKW  NORECOVERY,KNORCVY,A                                             
         SCKW  NEWEXEC,KNEWEXEC,A                                               
         SCKW  PUBEXEC,KPUBEXEC,A                                               
         SCKW  EXECUTE,KEXEC,A                                                  
         SCKW  NOEXECUTE,KNOEXEC,A                                              
         SCKW  COMMAND,KCMD,(A,P)                                               
         SCKW  NOCOMMAND,KNOCMD,A                                               
         SCKW  CMD,KCMD,(A,P)                                                   
         SCKW  NOCMD,KNOCMD,A                                                   
         SCKW  SYSTEM,KSYS,(A,P)                                                
         SCKW  NOSYSTEM,KNOSYS,A                                                
         SCKW  WYLBUR,KNOSYS,A                                                  
         SCKW  SERVWYL,KSYS                                                     
         SCKW  DEVWYL,KSYS                                                      
         SCKW  TESTWYL,KSYS                                                     
         SCKW  OLDWYL,KSYS                                                      
         SCKW  ORVYL,KORV,(A,P)                                                 
         SCKW  STATISTICS,KSTAT,A                                               
         SCKW  NOSTATISTICS,KNOSTAT,A                                           
         AIF   (NOT &SETLTIM).LTIME1A                                           
         SCKW  LTIME,KLTIME,A                                                   
         SCKW  NOLTIME,KNOLTIME,A                                               
.LTIME1A ANOP                                                                   
         SCKW  KTIME,KPTIME,A                                                   
         SCKW  PTIME,KPTIME,A                                                   
         SCKW  NOKTIME,KNOPTIME,A                                               
         SCKW  NOPTIME,KNOPTIME,A                                               
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
*-                                                                              
KNEWS    PROC                                                                   
         SET   WAFOP,KWRTFL.KWRTFAN                                             
         PEND                                                                   
*                                                                               
KNONEWS  PROC                                                                   
         SET   WAFOP,(KWRTFL.KWRTFAN,OFF)                                       
         PEND                                                                   
*                                                                               
KNDATE   PROC                                                                   
         SET   WAFOP               SET OPERAND FLAG                             
         IF    ^CPSFSPR,BEGIN                                                   
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         SCANSTR ,                  SCAN DATE                                   
         SCANCHK                                                                
*                                                                               
         IF    (R0,NE,8),BEGIN                                                  
         VCALL NOTVALID                                                         
         END                                                                    
         LR    R3,R1               SAVE POINTER TO "MM/DD/YY"                   
         IF    ((@R3+2,NE,'/'),OR,(@R3+5,NE,'/')),BEGIN                         
         VCALL NOTVALID                                                         
         END                                                                    
         SETMSG @R3+6,2             POINT TO "YY"                               
         IF    ('VCALL DTB',NEG),BEGIN                                          
         VCALL NOTVALID                                                         
         END                                                                    
         LR    R2,R15              PUT IN RIGHT BYTE OF WORK REG                
         SLL   R2,8                SHIFT LEFT ONE BYTE                          
         SETMSG @R3,2               POINT TO "MM"                               
         IF    ('VCALL DTB',NEG),BEGIN                                          
         VCALL NOTVALID                                                         
         END                                                                    
         AR    R2,R15              PUT IN RIGHT BYTE OF WORK REG                
         SLL   R2,8                SHIFT LEFT ONE BYTE                          
         SETMSG @R3+3,2             POINT TO "DD"                               
         IF    ('VCALL DTB',NEG),BEGIN                                          
         VCALL NOTVALID                                                         
         END                                                                    
         AR    R2,R15              PUT IN RIGHT BYTE OF WORK REG                
         SLL   R2,8                SHIFT LEFT ONE BYTE                          
         IF    (R2,Z),BEGIN                                                     
         VCALL NOTVALID                                                         
         END                                                                    
         ST    R2,KWRNEWDT         UPDATE KWR NEWS DATE                         
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KAMAIL   PROC  ,                                                                
         SET   WAFOP,KWRTFL.KWRTFAM                                             
         PEND                                                                   
*                                                                               
KANOMAIL PROC  ,                                                                
         SET   WAFOP,(KWRTFL.KWRTFAM,OFF)                                       
         PEND                                                                   
*                                                                               
KRCVY    PROC                                                                   
         SET   WAFOP,KWRTFL.KWRTFAR                                             
         PEND                                                                   
*                                                                               
KNORCVY  PROC                                                                   
         SET   WAFOP,(KWRTFL.KWRTFAR,OFF)                                       
         PEND                                                                   
*                                                                               
KNEWEXEC PROC                                                                   
         SET   WAFOP                                                            
         SET   KWRTFL.KWRTFAE,KWRTFL2.KWRTFANE                                  
         CLEAR KWRTFL2.KWRTFAPE                                                 
         PEND                                                                   
*                                                                               
KPUBEXEC PROC                                                                   
         SET   WAFOP                                                            
         SET   KWRTFL.KWRTFAE,KWRTFL2.KWRTFAPE                                  
         CLEAR KWRTFL2.KWRTFANE                                                 
         PEND                                                                   
*                                                                               
KEXEC    PROC                                                                   
         SET   WAFOP,KWRTFL.KWRTFAE                                             
         CLEAR KWRTFL2.KWRTFAPE+KWRTFANE                                        
         PEND                                                                   
*                                                                               
KNOEXEC  PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRTFL.KWRTFAE,KWRTFL2.KWRTFAPE+KWRTFANE                         
         PEND                                                                   
*                                                                               
         AIF   (NOT &SETLTIM).LTIME2A                                           
KLTIME   PROC                                                                   
         SET   WAFOP,KWRTFL.KWRTFAL                                             
         PEND                                                                   
*                                                                               
KNOLTIME PROC                                                                   
         SET   WAFOP,(KWRTFL.KWRTFAL,OFF)                                       
         PEND                                                                   
.LTIME2A ANOP                                                                   
*                                                                               
KPTIME   PROC                                                                   
         SET   WAFOP,KWRTFL.KWRTFAK                                             
         PEND                                                                   
*                                                                               
KNOPTIME PROC                                                                   
         SET   WAFOP,(KWRTFL.KWRTFAK,OFF)                                       
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWAUTO -- SHOW AUTO command.                                               
*                                                                               
SHOWAUTO XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         VCALL COLLOPTS            Allow standard options                       
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL AUTODISP                                                         
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  AUTODISP -- Routine to display AUTO Options (also                            
*    called by SHOW OPTIONS command).                                           
*                                                                               
*    On entry:                                                                  
*      R1 - KWR ptr                                                             
*                                                                               
AUTODISP XPROC                                                                  
         LR    R6,R1               KWR ptr                                      
         USING KWR,R6                                                           
*                                                                               
         IF    (KWRSYS,NZ),BEGIN                                                
         TSEG  'System='                                                        
         TSEG  KWRSYS,,TB                                                       
         END                                                                    
*                                                                               
         IF    (KWRORV,NZ),BEGIN                                                
         TSEG  'Orvyl='                                                         
         TSEG  KWRORV,,TB                                                       
         END                                                                    
*-                                                                              
*-       New style.                                                             
*-                                                                              
         IF    (KWRCMD,NZ),BEGIN                                                
         TSEG  'Command="'                                                      
         TSEG  KWRCMD,,T                                                        
         TSEG  '" '                                                             
         END                                                                    
*-                                                                              
*-       Old style.                                                             
*-                                                                              
         ELSE  BEGIN                                                            
         SETMSG 'NONEWS '                                                       
         IF    KWRTFL.KWRTFAN,'LA R1,@R1+2; SH R0,=H"2"'                        
         TSEG  (R1),(R0)                                                        
*                                                                               
         SETMSG 'NOMAIL '                                                       
         IF    KWRTFL.KWRTFAM,'LA R1,@R1+2; SH R0,=H"2"'                        
         TSEG  (R1),(R0)                                                        
*                                                                               
         SETMSG 'NORECOVERY '                                                   
         IF    KWRTFL.KWRTFAR,'LA R1,@R1+2; SH R0,=H"2"'                        
         TSEG  (R1),(R0)                                                        
*                                                                               
         SETMSG 'NOEXEC '                                                       
         IF    KWRTFL.KWRTFAE,'LA R1,@R1+2; SH R0,=H"2"'                        
         IF    KWRTFL2.KWRTFAPE,'SETMSG "PUBEXEC "'                             
         IF    KWRTFL2.KWRTFANE,'SETMSG "NEWEXEC "'                             
         TSEG  (R1),(R0)                                                        
*                                                                               
         AIF   (NOT &SETLTIM).LTIME3A                                           
         SETMSG 'NOLTIME '                                                      
         IF    KWRTFL.KWRTFAL,'LA R1,@R1+2; SH R0,=H"2"'                        
         TSEG  (R1),(R0)                                                        
.LTIME3A ANOP                                                                   
*                                                                               
         SETMSG 'NOPTIME '                                                      
         IF    KWRTFL.KWRTFAK,'LA R1,@R1+2; SH R0,=H"2"'                        
         TSEG  (R1),(R0)                                                        
         END                                                                    
*                                                                               
         SETMSG 'NOMULTIPLE '                                                   
         IF    KWROFL.KWRFMULT,'SETMSG "MULTIPLE "'                             
         IF    KWROFL.KWRFMNPR,'SETMSG "XMULTIPLE "'                            
         TSEG  (R1),(R0)                                                        
*                                                                               
         SETMSG 'STATISTICS '                                                   
         IF    KWRTACF.KWRTNST,'SETMSG "NOSTATISTICS "'                         
         TSEG  (R1),(R0)                                                        
*                                                                               
         TSEG  '- AUTO Options',,WR                                             
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  KWR                                                              
*                                                                               
         QLTORG                                                                 
         TITLE 'SET/SHOW MSTATUS Commands'                                      
*box                                                                            
*                                                                               
*  SETMSTAT -- SET MSTATUS command.                                             
*                                                                               
SETMST   XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
*                                                                               
         LOOP  BEGIN                                                            
         SCRSTR AREA=WASCSAVE                                                   
         SCAN  MSTATPRT                                                         
         SCANCHK                                                                
         IF    ^WAFOP,'ERROR "Missing SET MSTATUS options."'                    
         ACALL PUTKWR                                                           
         UNTIL Z,END               Loop until re-write is ok                    
*                                                                               
         CLEAR KWR                                                              
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
**                                                                              
**  SET MSTATUS Options                                                         
**                                                                              
MSTATPRT SCKW  MAIL,UMAIL,A                                                     
         SCKW  NOMAIL,UNOMAIL,A                                                 
         SCKW  KEPT,UKEPT,A                                                     
         SCKW  NOKEPT,UNOKEPT,A                                                 
         SCKW  DEFQ,UDEFQ,A                                                     
         SCKW  NODEFQ,UNODEFQ,A                                                 
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
UMAIL    PROC                                                                   
         SET   WAFOP                                                            
         SET   KWRSFL.KWRSFMAI                                                  
         PEND                                                                   
*                                                                               
UNOMAIL  PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRSFL.KWRSFMAI                                                  
         PEND                                                                   
*                                                                               
UKEPT    PROC                                                                   
         SET   WAFOP                                                            
         SET   KWRSFL.KWRSFKEP                                                  
         PEND                                                                   
*                                                                               
UNOKEPT  PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRSFL.KWRSFKEP                                                  
         PEND                                                                   
*                                                                               
UDEFQ    PROC                                                                   
         SET   WAFOP                                                            
         SET   KWRSFL.KWRSFMLQ                                                  
         PEND                                                                   
*                                                                               
UNODEFQ  PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRSFL.KWRSFMLQ                                                  
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWMST -- SHOW MSTATUS command.                                             
*                                                                               
SHOWMST  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LA    R0,1                                                             
         ACALL GETAENT                                                          
*                                                                               
         VCALL COLLOPTS            Allow standard options                       
         TSEG  'Mailbox status for '                                            
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER,,B                                                       
*                                                                               
         IF    (KWRNAME,NZ),BEGIN                                               
         TSEG  '"'                                                              
         TSEG  KWRNAME,,T                                                       
         TSEG  '"'                                                              
         END                                                                    
         TSEG  ':',,CR                                                          
*                                                                               
         SETMSG '  No mail message is set.'                                     
         IF    (KWRMTXT,NZ),BEGIN                                               
         TSEG  '  Mail message: '                                               
         SETMSG KWRMTXT                                                         
         END                                                                    
         TSEG  (R1),(R0),T                                                      
         TCR                                                                    
*                                                                               
         SETMSG '  Account can NOT receive new mail.'                           
         IF    KWROFL.KWRFMAIL,BEGIN                                            
         SETMSG '  Account can receive new mail.'                               
         IF    (KWRMFOR,NZ),BEGIN                                               
         TSEG  '  New mail is being forwarded to '                              
         SETMSG KWRMFOR                                                         
         END                                                                    
         END                                                                    
         TSEG  (R1),(R0),CR                                                     
*                                                                               
         TSEG  '  SHOW MAIL options: '                                          
         IF    KWRTFL2.KWRTFMNOATTN,'TSEG "NO"'                                 
         TSEG  'ATTN '                                                          
         TCR                                                                    
*                                                                               
         TSEG  '  Status flags: '                                               
         IF    ^KWRSFL.KWRSFMAI,'TSEG "NO"'                                     
         TSEG  'MAIL '                                                          
         IF    ^KWRSFL.KWRSFKEP,'TSEG "NO"'                                     
         TSEG  'KEPT '                                                          
         IF    ^KWRSFL.KWRSFMLQ,'TSEG "NO"'                                     
         TSEG  'DEFQ '                                                          
*                                                                               
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
         TITLE 'SET/SHOW NOTIME Commands'                                       
*box                                                                            
*                                                                               
*  SETNOTIM -- SET NOTIME command.                                              
*                                                                               
SETNOTM  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
*                                                                               
         LOOP  BEGIN                                                            
         SCRSTR AREA=WASCSAVE                                                   
         SCAN  NOTMPRT             SET NOTIME options                           
         SCANCHK                                                                
         IF    WAFTEMP,EXIT        Only set session options, scram              
         ACALL PUTKWR                                                           
         UNTIL Z                   Loop until re-write is ok                    
         END                                                                    
*-                                                                              
*-       Update current session notime limit too.                               
*-                                                                              
         IF    (CPCACCT,EQ,CPSACCT),BEGIN  Update session...                    
         LA    R2,100                                                           
         LOOP  BEGIN                                                            
         SET   CPSFNTIM            Compatibility style NOTIME                   
         MVC   CPSIDMAX,KWRNTDEF   Set new default notime value                 
         VCALL UPDCPSIB            Update MILTEN SIB                            
         IF    Z,EXIT                                                           
         DECR  R2                                                               
         UNTIL (R2,Z)                                                           
         END                                                                    
         END                                                                    
*                                                                               
         CLEAR KWR                 (Neatness)                                   
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
*-                                                                              
*-       SET NOTIME Options.                                                    
*-                                                                              
NOTMPRT  SCKW  TEMPORARY,NTTEMP,A                                               
         SCKW  OLD,NTOLD                                                        
         SCKW  ,NTNUM,I                                                         
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
*-                                                                              
NTOLD    PROC                                                                   
         SET   WAFOP                                                            
         MVC   KWRNTDEF,=H'-1'     Set old style NOTIME                         
         PEND                                                                   
*                                                                               
NTNUM    PROC                                                                   
         SET   WAFOP                                                            
         IF  ((KWRNTMAX,NZ),AND,(R0,GT,KWRNTMAX)),'LH R0,KWRNTMAX'              
         IF    (R0,Z),'LH R0,KWRNTMAX'  Use maximum allowed                     
         STH   R0,KWRNTDEF        Set default notime number                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
NTTEMP   PROC                                                                   
         SET   WAFOP,WAFTEMP       TEMP option                                  
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWNOTM -- SHOW NOTIME command.                                             
*                                                                               
SHOWNOTM XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         VCALL COLLOPTS            Allow standard options                       
         ACALL SEGACCT                                                          
*                                                                               
         LH    R3,CPSIDMAX         Current session value                        
         IF    (CPCACCT,NE,CPSACCT),'LH R3,KWRNTDEF'                            
*                                                                               
         IF    (R3,Z),BEGIN        No timeouts at all...                        
         TSEG  'This session can be idle forever '                              
         TSEG  'without being logged off.'                                      
         END                                                                    
*                                                                               
         ELSEIF (R3,EQ,-1),BEGIN   Old style...                                 
         TSEG  'Old style NOTIME in effect (compatibility mode).'               
         END                                                                    
*                                                                               
         ELSE  BEGIN               Timeouts...                                  
         TSEG  'This session can be idle for '                                  
         TNUM  (R3)                                                             
         TSEG  ' minutes before being logged off'                               
         END                                                                    
*                                                                               
         IF    (KWRNTMAX,NZ),BEGIN  Display limit...                            
         TSEG  ' (max='                                                         
         TNUM  LH:KWRNTMAX                                                      
         TSEG  ')'                                                              
         TSEG  '.'                                                              
         END                                                                    
*                                                                               
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
         TITLE 'SET/SHOW OUTPUT Commands'                                       
*box                                                                            
*                                                                               
*  SETOUT -- SET OUTPUT command.                                                
*                                                                               
SETOUT   XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
*                                                                               
         LOOP  BEGIN                                                            
         SCRSTR AREA=WASCSAVE                                                   
         SCAN  OUTPRT                                                           
         SCANCHK                                                                
         IF    ^WAFOP,'ERROR "Missing SET OUTPUT options."'                     
         ACALL PUTKWR                                                           
         UNTIL Z,END               Loop until re-write is ok                    
*                                                                               
         LA    R0,SMFWOUT+SMFWAUTH                                              
         VCALL LOGKWR              Write smf log record                         
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL OUTDISP                                                          
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
*-                                                                              
*-       SET OUTPUT Options.                                                    
*-                                                                              
OUTPRT   SCKW  DESTINATION,KDEST,(A,P)                                          
         SCKW  FORMS,KFORMS,(A,P)                                               
         SCKW  PRTFORMS,KPFORMS,(A,P)                                           
         SCKW  NOPRTFORMS,KPNOFORM,A                                            
         SCKW  BIN,KBIN,(A,P)                                                   
         SCKW  HOLD,KHOLD,A                                                     
         SCKW  NOHOLD,KNOHOLD,A                                                 
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
KHOLD    PROC                                                                   
         SET   WAFOP,KWRJFL.KWRJFHOL                                            
         PEND                                                                   
*                                                                               
KNOHOLD  PROC                                                                   
         SET   WAFOP,(KWRJFL.KWRJFHOL,OFF)                                      
         PEND                                                                   
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWOUT -- SHOW OUTPUT command.                                              
*                                                                               
SHOWOUT  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LA    R0,1                                                             
         IF    CPSTCONS,'LA R0,1'  No password prompt for console               
         ACALL GETAENT                                                          
*                                                                               
         VCALL COLLOPTS            Allow standard options                       
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL OUTDISP                                                          
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  OUTDISP -- Routine to display OUTPUT Options (also called                    
*      by SHOW OPTIONS command).                                                
*                                                                               
*        On entry:                                                              
*          R1 - KWR ptr                                                         
*                                                                               
OUTDISP  XPROC                                                                  
         LR    R6,R1               Kwr ptr                                      
         USING KWR,R6                                                           
         LA    R4,1                                                             
         IF    (KWRDEST,NZ),BEGIN                                               
         TSEG  'DEST='                                                          
         TSEG  KWRDEST,,TB                                                      
         CLEAR R4                                                               
         END                                                                    
*                                                                               
         IF    (KWRFORM,NZ),BEGIN                                               
         TSEG  'FORMS='                                                         
         TSEG  KWRFORM,,TB                                                      
         CLEAR R4                                                               
         END                                                                    
*                                                                               
         IF    (KWRPFORM,NZ),BEGIN                                              
         TSEG  'PRTFORMS='                                                      
         TSEG  KWRPFORM,,TB                                                     
         CLEAR R4                                                               
         END                                                                    
*                                                                               
         IF    (KWRBIN,NZ),BEGIN                                                
         TSEG  'BIN='                                                           
         TSEG  KWRBIN,,TB                                                       
         CLEAR R4                                                               
         END                                                                    
*                                                                               
         IF    (R4,NZ),'TSEG "(No DEST/FORMS/BIN) "'                            
*                                                                               
         IF    ^KWRJFL.KWRJFHOL,'TSEG "NO"'                                     
         TSEG  'HOLD '                                                          
*                                                                               
         TSEG  '- OUTPUT Options',,WR                                           
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  KWR                                                              
*                                                                               
         QLTORG                                                                 
         TITLE 'SET/SHOW JOB Commands'                                          
*box                                                                            
*                                                                               
*  SETJOB -- SET JOB command.                                                   
*                                                                               
SETJOB   XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
*                                                                               
         LOOP  BEGIN                                                            
         SCRSTR AREA=WASCSAVE                                                   
         SCAN  JOBPRT                                                           
         SCANCHK                                                                
         IF    ^WAFOP,'ERROR "Missing SET JOB options."'                        
         ACALL PUTKWR                                                           
         UNTIL Z,END               Loop until re-write is ok                    
*                                                                               
         LA    R0,SMFWJOB+SMFWAUTH                                              
         VCALL LOGKWR              Write smf log record                         
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL JOBDISP                                                          
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
**                                                                              
**  SET JOB Options                                                             
**                                                                              
JOBPRT   SCKW  NUMBERED,KNUM,A                                                  
         SCKW  UNNUMBERED,KUNN,A                                                
         SCKW  NONUMBER,KUNN,A                                                  
         SCKW  FORCE,KFORCE,A                                                   
         SCKW  NOFORCE,KNOFORCE,A                                               
         SCKW  PREFIX,KPREFIX,(A,P)                                             
         SCKW  NOPREFIX,KNOPREFX,A                                              
         SCKW  COUNT,KCOUNT,(A,P,I),20000                                       
         AIF   (NOT &JOBAUTH).AUTH1A                                            
         SCKW  AUTHORITY,KAUTH,(A,P)                                            
.AUTH1A  ANOP                                                                   
         SCKW  NOTIFY,KNOT,A                                                    
         SCKW  NONOTIFY,KNONOT,A                                                
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
         SPACE 2                                                                
*                                                                               
KNUM     PROC                                                                   
         SET   WAFOP,KWRJFL.KWRJFNUM                                            
         PEND                                                                   
*                                                                               
KUNN     PROC                                                                   
         SET   WAFOP,(KWRJFL.KWRJFNUM,OFF)                                      
         PEND                                                                   
*                                                                               
KFORCE   PROC                                                                   
         SET   WAFOP,KWRJFL.KWRJFFOR                                            
         PEND                                                                   
*                                                                               
KNOFORCE PROC                                                                   
         SET   WAFOP,(KWRJFL.KWRJFFOR,OFF)                                      
         PEND                                                                   
*                                                                               
KPREFIX  PROC  ,                                                                
         SET   WAFOP                                                            
         SCUPTOK R15                                                            
         MVC   KWRJPFX,@R15                                                     
         XC    KWRJPFX,=C'JOBMASK.'                                             
         IF    (R0,GT,L'KWRJPFX),BEGIN                                          
         VCALL NOTVALID                                                         
         END                                                                    
         VCALL CHARCHKA            Check for valid chars                        
         IF    POS,BEGIN                                                        
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid characters in prefix.',,INVCHARS                      
         END                                                                    
         PEND                                                                   
*                                                                               
KNOPREFX PROC  ,                                                                
         SET   WAFOP                                                            
         CLEAR KWRJPFX             Clear the job prefix                         
         PEND                                                                   
*                                                                               
KCOUNT   PROC  ,                                                                
         SET   WAFOP                                                            
         STH   R0,KWRJNO                                                        
         IF    WAFMAST,'STH R0,KWRRJE'                                          
         PEND                                                                   
*                                                                               
         AIF   (NOT &JOBAUTH).AUTH2A                                            
KAUTH    PROC  ,                                                                
         SCPUSH                                                                 
         SET   WAFOP                                                            
         CLEAR KWRJFL.KWRJFATH                                                  
         SCINIT (R1),(R0)                                                       
         SCAN  KAUTHPRT                                                         
         SCANCHK                                                                
         SCPOP                                                                  
         PEND                                                                   
*                                                                               
KAUTHPRT SCKW  ,KAUTHNUL,NULL                                                   
         SCKW  PUBLIC,KAUTHPUB,A                                                
         SCKW  COMMUNITY,KAUTHCOM,A                                             
         SCKW  GROUP,KAUTHGRP,A                                                 
         SCKW  GRP,KAUTHGRP                                                     
         SCKW  USER,KAUTHRTN,A                                                  
         SCKW  USR,KAUTHRTN                                                     
         SCKW  ,KAUTHINV                                                        
*                                                                               
KAUTHNUL PROC                                                                   
         ERROR 'Missing authority.'                                             
         PEND                                                                   
*                                                                               
KAUTHPUB PROC                                                                   
         SET   KWRJFL.KWRJFPUB                                                  
         PEND                                                                   
*                                                                               
KAUTHCOM PROC                                                                   
         SET   KWRJFL.KWRJFCOM                                                  
         PEND                                                                   
*                                                                               
KAUTHGRP PROC                                                                   
         SET   KWRJFL.KWRJFGRP                                                  
         PEND                                                                   
*                                                                               
KAUTHINV PROC                                                                   
         TSEG  (R1),(R0)                                                        
         TSEG  ': invalid authority,',,B                                        
         ERROR 'Expecting PUBLIC/COMMUNITY/GROUP/USER.'                         
         PEND                                                                   
*                                                                               
KAUTHRTN PROC                                                                   
         PEND                                                                   
.AUTH2A  ANOP                                                                   
*                                                                               
*                                                                               
KNOT     PROC                                                                   
         SET   WAFOP,KWRJFL.KWRJFNOT                                            
         PEND                                                                   
*                                                                               
KNONOT   PROC                                                                   
         SET   WAFOP,(KWRJFL.KWRJFNOT,OFF)                                      
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWJOB -- SHOW JOB command.                                                 
*                                                                               
SHOWJOB  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         VCALL COLLOPTS            Allow standard options                       
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL JOBDISP                                                          
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  JOBDISP -- Routine to display job submission options (also called            
*      by SHOW OPTIONS command).                                                
*                                                                               
*      On entry:                                                                
*        R1 - KWR ptr                                                           
*                                                                               
JOBDISP  XPROC                                                                  
         LR    R6,R1               Kwr ptr                                      
         USING KWR,R6                                                           
         IF    ^KWRJFL.KWRJFNOT,'TSEG "NO"'                                     
         TSEG  'NOTIFY',,B                                                      
         IF    ^KWRJFL.KWRJFNUM,'TSEG "UN"'                                     
         TSEG  'NUMBERED',,B                                                    
         IF    KWRJFL.KWRJFFOR,'TSEG "FORCE",,B'                                
         IF    (KWRJPFX,NZ),BEGIN                                               
         TSEG  'PREFIX='                                                        
         MVC   CPDOUB,KWRJPFX                                                   
         XC    CPDOUB,=C'JOBMASK.'  unscramble                                  
         SETMSG CPDOUB                                                          
         TSEG  (R1),(R0),TB                                                     
         END                                                                    
         TSEG  'COUNT='                                                         
         BTD   CPDOUB,0,L2:KWRJNO                                               
         TSEG  (R1),(R0),B                                                      
         TSEG  '(TOTAL='                                                        
         BTD   CPDOUB,0,L2:KWRRJE                                               
         TSEG  (R1),(R0)                                                        
         TSEG  ')',,B                                                           
         AIF   (NOT &JOBAUTH).AUTH3A                                            
         TSEG  'AUTH='                                                          
         SETMSG 'USER'                                                          
         IF    KWRJFL.KWRJFGRP,'SETMSG "GROUP"'                                 
         IF    KWRJFL.KWRJFCOM,'SETMSG "COMMUNITY"'                             
         IF    KWRJFL.KWRJFPUB,'SETMSG "PUBLIC"'                                
         TSEG  (R1),(R0),B                                                      
.AUTH3A  ANOP                                                                   
         TSEG  '- JOB Options',,WR                                              
         BNZ   CVABORT                                                          
         PEND                                                                   
         DROP  KWR                                                              
*                                                                               
         QLTORG                                                                 
         TITLE 'SHOW SPACE Command'                                             
*box                                                                            
*                                                                               
*  SHOWSPCE -- SHOW SPACE command.                                              
*                                                                               
*                                                                               
SHOWSPCE XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*-                                                                              
*-       Allow "SHOW SPACE ON volume" as an alias for                           
*-       "SHOW TRACKS ON volume", which is handled elsewhere...                 
*-                                                                              
         SCSAVE AREA=WASCSAVE                                                   
         SCAN   ONVOLPRT            Look for "on"                               
         SCANCHK                                                                
         SCRSTR AREA=WASCSAVE                                                   
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LA    R0,1                Password not required                        
         ACALL GETAENT                                                          
*                                                                               
         SCAN  SPACEPRT                                                         
         SCANCHK                                                                
*                                                                               
         CLEAR R0                  Unconditional                                
         LA    R1,KWR              R1 -> KWR                                    
         VCALL EXIT3               LOCAL exit - show space                      
*                                                                               
         CLEAR KWR                                                              
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SPACEPRT SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
ONVOLPRT SCKW  ON,ONVOL                                                         
         SCKW  ,V(SCNNOOP)                                                      
*                                                                               
ONVOL    PROC  ,                                                                
         SCRSTR AREA=WASCSAVE      Back up scanner                              
         DROP  R4                                                               
         VCALL SHOWTRKS            Go do SHOW TRACKS                            
         DC    H'0'                (no return)                                  
         PEND  ,                                                                
*                                                                               
         DROP  WA                                                               
         TITLE 'SET/SHOW PROJECT Commands'                                      
*box                                                                            
*                                                                               
*  SETPROJ -- SET PROJECT Command.                                              
*                                                                               
SETPROJ  XPROC                                                                  
*                                                                               
         SCAN                                                                   
         SCANCHK                                                                
         SCUPTOK R6                                                             
*                                                                               
         COMMENT                   CHECK PROJECT ID                             
         IF    (R0,GT,L'CPSPROJ),BEGIN                                          
         TSEG  (R1),(R0),B                                                      
         ERROR 'is too long for a project id.'                                  
         END                                                                    
         IF    (R0,Z),'LA R6,=XL8"00"'                                          
         COMMENT QUOTED PROJECTS ARE IGNORED                                    
         IF    ((@R6,EQ,''''),OR,(@R6,EQ,'"')),'LA R6,=XL8"00"'                 
*                                                                               
         LA    R5,100                                                           
         LOOP  BEGIN                                                            
         MVC   CPSPROJ,@R6         Set project id                               
         VCALL UPDCPSIB            Update MILTEN's copy                         
         IF    Z,EXIT                                                           
         DECR  R5                                                               
         IF    (R5,Z),'LA R15,100; B CVMILERR'  can't update                    
         END                                                                    
*-                                                                              
*-       For the RLG version, WPROJECT and PROJECT are always                   
*-         the same.                                                            
*-                                                                              
         IF    CVFRLG,'MVC CPWPROJ,CPSPROJ'  Set the same                       
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWPROJ -- SHOW PROJECT Command.                                            
*                                                                               
SHOWPROJ XPROC                                                                  
         VCALL COLLOPTS                                                         
         IF    ((CPSPROJ,Z),OR,(CPSPROJ,EQ,CVBLANKS)),BEGIN                     
         SETMSG 'No project id.'                                                
         END                                                                    
*                                                                               
         ELSE  BEGIN                                                            
         TSEG  CPSPROJ,,T                                                       
         SETMSG ' is your current project id.'                                  
         END                                                                    
*                                                                               
         B     CVNXTMSG                                                         
         PEND                                                                   
         TITLE 'SET/SHOW WPROJECT Commands'                                     
*box                                                                            
*                                                                               
*  SETWPROJ -- SET WPROJECT Command.                                            
*                                                                               
SETWPROJ XPROC                                                                  
         IF    CVFRLG,'VCALL SETPROJ; B CVNEXT'  RLG version                    
*                                                                               
         SCAN                                                                   
         SCANCHK                                                                
         SCUPTOK R6                                                             
*                                                                               
         IF    (R0,Z),'LA R6,=XL8"00"'                                          
         ELSE  BEGIN                                                            
         IF    (R0,GT,L'CPWPROJ),BEGIN                                          
         TSEG  (R1),(R0),B                                                      
         ERROR 'is too long for a project id.'                                  
         END                                                                    
         END                                                                    
*                                                                               
         MVC   CPWPROJ,@R6         Set WPROJECT id                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWWPRJ -- SHOW WPROJECT Command.                                           
*                                                                               
SHOWWPRJ XPROC                                                                  
         VCALL COLLOPTS                                                         
         IF    ((CPWPROJ,Z),OR,(CPWPROJ,EQ,CVBLANKS)),BEGIN                     
         SETMSG 'No WPROJECT set.'                                              
         END                                                                    
*                                                                               
         ELSE  BEGIN                                                            
         TSEG  CPWPROJ,,T                                                       
         SETMSG ' is your WPROJECT.'                                            
         END                                                                    
*                                                                               
         B     CVNXTMSG                                                         
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         TITLE 'SET WAPP Command'                                               
*box                                                                            
*                                                                               
*  SETWAPP -- SET WAPP Command.  This is an internal command used               
*    to allow the double-logon application 8 bytes of information               
*    which can be passed in the accounting record.                              
*                                                                               
SETWAPP  XPROC                                                                  
*                                                                               
         SCAN                                                                   
         SCANCHK                                                                
         SCUPTOK R1                                                             
*                                                                               
         IF    (R0,Z),BEGIN                                                     
         ERROR 'Missing APPLICATION name.'                                      
         END                                                                    
*                                                                               
         IF    (CPWAPP,Z),BEGIN    Only set WAPP info once...                   
         MVC   CPWAPP,@R1          Save WAPP info                               
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
         TITLE 'SHOW CHARGES Command'                                           
*box                                                                            
*                                                                               
*  SHOWCHAR -- SHOW CHARGES command.                                            
*                                                                               
SHOWCHAR XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
*                                                                               
         COMMENT                   CHECK FOR ACCOUNT                            
         SCAN                                                                   
         SCANCHK                                                                
         SCUPTOK R15                                                            
         IF    NZ,BEGIN                                                         
         IF    (@R15,NE,'FOR '),EXIT                                            
         TSEG  'FOR is not needed and has been ignored.',,WR                    
         END                                                                    
         ELSE  BEGIN                                                            
         SCBKUP                                                                 
         END                                                                    
*                                                                               
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         SCAN  CHARPRT                                                          
         SCANCHK                                                                
*                                                                               
         IF    ^CPFINT,BEGIN                                                    
         IF    (CVAMSG,NZ),BEGIN                                                
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         CLEAR R3                                                               
         L     R0,CVAMSGCK                                                      
         CLEAR R1                                                               
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0)                                                        
         TSEG  CVBLANKS,2                                                       
         XPOP  ,,30                                                             
         SETMSG CVAMSG                                                          
         VCALL LRTRIM                                                           
         TSEG  (R1),(R0),WR                                                     
         END                                                                    
         IF    ((KWRGRP,NE,CPSGRP),OR,(KWRUSER,NE,CPSUSER)),BEGIN               
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER                                                          
         TSEG  ' - '                                                            
         END                                                                    
         IF    (KWRBGT,NZ),BEGIN                                                
         TSEG  'BUDGET: '                                                       
         L3    R15,KWRBGT          Budget                                       
         ACALL SEGXDOL                                                          
         TSEG  ', '                                                             
         END                                                                    
         TSEG  'Charges: '                                                      
         L3    R15,KWRMTD          Mtd charges                                  
         ACALL SEGXDOL                                                          
         TSEG  ' MTD, '                                                         
         L3    R15,KWRBAL          Balance (ytd charges)                        
         ACALL SEGXDOL                                                          
         TSEG  ' YTD'                                                           
         IF    (KWRCDATE,NZ),BEGIN                                              
         TSEG  '  ('                                                            
         L3    R15,KWRBAL          Current ytd charges                          
         IF    (R15,GE,X'800000'),'O R15,=A(X"FF000000")'                       
         L3    R2,KWRPBAL          Yesterday's ytd charges                      
         IF    (R2,GE,X'800000'),'O R2,=A(X"FF000000")'                         
         SR    R15,R2                                                           
         ACALL SEGXDOL                                                          
         TSEG  ' charged on '                                                   
         L     R0,KWRCDATE                                                      
         LA    R1,CPDOUB                                                        
         VCALL DATE                                                             
         TSEG  (R1),5              Mm/dd                                        
         TSEG  ')'                                                              
         END                                                                    
*                                                                               
         IF    ^KWRAFL.KWRAFVAL,BEGIN  Suspended...                             
         TSEG  CVBLANKS,2                                                       
         SETMSG '(Suspended)'                                                   
         IF    (KWRSTAT,EQ,KWRSEXP),'SETMSG "(Expired)"'                        
         IF    (KWRSTAT,EQ,KWRSOVB),'SETMSG "(Over budget)"'                    
         IF (KWRSTAT,EQ,KWRSUHL),'SETMSG "(Suspended--see Accounting)"'         
         TSEG  (R1),(R0)                                                        
         END                                                                    
         TWRITE                                                                 
         BNZ   CVABORT                                                          
*                                                                               
         IF    (KWRHRSAL,NZ),BEGIN                                              
         LH    R0,KWRHRSUS                                                      
         MH    R0,=H'100'                                                       
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ' hours used'                                                    
         IF    (KWRHRSAL,NE,-1),BEGIN                                           
         TSEG  ', '                                                             
         LH    R0,KWRHRSAL                                                      
         MH    R0,=H'100'                                                       
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ' hours allowed'                                                 
         END                                                                    
         TWRITE                                                                 
         END                                                                    
         END                                                                    
*-                                                                              
*-       Show charges INTERNAL formatting.                                      
*-                                                                              
         ELSE  BEGIN               Internal format...                           
*-                                                                              
*-       internal format:  ("." represents a blank)                             
*-        (....v....1....v....2....v....3....v..)                               
*-         gguuuslaaaaaaaaa.uuuuuuuuu.bbbbbbbbb.                                
*-                                                                              
*-                   (..4....v....5....v....6....v....7..)                      
*-         (cont'd)   yyyyyyyyy.mmmmmmmmm.ppppppppp.ddddd                       
*-                                                                              
*-       where:                                                                 
*-         gguuu - account                                                      
*-         s - blank if account is active, "e" if expired,                      
*-         "o" if over budget, "s" if account is suspended                      
*-         l - blank if regular account, "l" if lcip account                    
*-         aaaaaaaaa - no. of interactive hours allowed (lcip only)             
*-         uuuuuuuuu - no. of interactive hours used (lcip only)                
*-         bbbbbbbbb - current budget                                           
*-         yyyyyyyyy - current ytd charges                                      
*-         mmmmmmmmm - current mtd charges                                      
*-         ppppppppp - previous days charges                                    
*-        ddddd - date charges were last calculated.  format:  mm/dd            
*-         what follows is reserved for future use                              
*-                                                                              
         TSEG  KWRGRP                                                           
         TSEG  KWRUSER                                                          
         SETMSG CVBLANKS,1                                                      
         IF    ^KWRAFL.KWRAFVAL,BEGIN                                           
         SETMSG 'S'                                                             
         IF    (KWRSTAT,EQ,KWRSEXP),'SETMSG "E"'                                
         IF    (KWRSTAT,EQ,KWRSOVB),'SETMSG "O"'                                
         END                                                                    
         TSEG  (R1),(R0)                                                        
         SETMSG CVBLANKS,1          Always blank                                
         TSEG  (R1),(R0)                                                        
         LH    R15,KWRHRSAL                                                     
         BTR   CPDOUB,(9,2),(R15)                                               
         TSEG  (R1),(R0),B                                                      
         BTR   CPDOUB,(9,2),L2:KWRHRSUS                                         
         TSEG  (R1),(R0),B                                                      
         L3    R15,KWRBGT                                                       
         IF    (R15,GE,X'800000'),'O R15,=A(X"FF000000")'                       
         IF    (R15,Z),'LH R15,=H"-1"'                                          
         BTD   CPDOUB,9,(R15)                                                   
         TSEG  (R1),(R0),B                                                      
         L3    R15,KWRBAL                                                       
         IF    (R15,GE,X'800000'),'O R15,=A(X"FF000000")'                       
         BTD   CPDOUB,9,(R15)                                                   
         TSEG  (R1),(R0),B                                                      
         L3    R15,KWRMTD                                                       
         IF    (R15,GE,X'800000'),'O R15,=A(X"FF000000")'                       
         BTD   CPDOUB,9,(R15)                                                   
         TSEG  (R1),(R0),B                                                      
         L3    R15,KWRBAL                                                       
         IF    (R15,GE,X'800000'),'O R15,=A(X"FF000000")'                       
         L3    R1,KWRPBAL                                                       
         IF    (R1,GE,X'800000'),'O R1,=A(X"FF000000")'                         
         IF    ('SR R15,R1',NEG),'CLEAR R15'                                    
         BTD   CPDOUB,9,(R15)      Latest charge increment                      
         TSEG  (R1),(R0),B                                                      
         SETMSG '??/??'                                                         
         IF    (KWRCDATE,NZ),BEGIN                                              
         L     R0,KWRCDATE                                                      
         LA    R1,CPDOUB                                                        
         VCALL DATE                                                             
         SETMSG (R1),5              Mm/dd                                       
         END                                                                    
         TSEG  (R1),(R0),B                                                      
         END                                                                    
*                                                                               
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
*-                                                                              
*-       SHOW CHARGES Options.                                                  
*-                                                                              
CHARPRT  SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(INTPSH),PUSH                                                  
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         TITLE 'SET/SHOW COST Command'                                          
*box                                                                            
*                                                                               
*  SETCOST -- SET COST command (no longer supported).                           
*                                                                               
SETCOST  XPROC                                                                  
         B     CVNEXT              NOT SUPPORTED                                
         PEND                                                                   
         AGO   .SKIPSC                                                          
         LH    R5,=H'-1'                                                        
SETCSCAN *O*SCAN SETCPRT           OLD SCAN COMMENTED OUT                       
         IF    (R5,NEG),BEGIN                                                   
         ERROR 'Missing "WARN=$n" on the SET COST command.'                     
         END                                                                    
*                                                                               
*DONT    ST    R5,CPWARN$          Set new warning value                        
         B     CVNEXT                                                           
         SPACE 2                                                                
SETCPRT  SCKW  WARN,SETCWARN,(A,P)                                              
         SCKW  NOWARN,SETCNWRN,A                                                
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SETCLPRT SCKW  ,SETCVAL,LN                                                      
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SETCNWRN CLEAR R5                                                               
         BR    RAR                                                              
*                                                                               
SETCWARN IF    (@R1,EQ,'$'),'LA R1,@R1+1; DECR R0'                              
         *O*SCSAVE                 OLD SCANNER STUFF COMMENTED OUT              
         *O*SCINIT (R1),(R0)                                                    
         *O*SCAN SETCLPRT                                                       
         *O*SCRSTR                                                              
         B     SETCSCAN                                                         
*                                                                               
SETCVAL  LR    R5,R15                                                           
         BR    RAR                                                              
*                                                                               
         DROP  BR                                                               
.SKIPSC  ANOP                                                                   
         EJECT                                                                  
WCWA     RECORD BEGIN                                                           
WCKEY    DS    CL16                Token name                                   
*                                                                               
WCPASS   DS    CL8                 Password                                     
WCCOST   DS    F                   Dollar value                                 
WCDATA   EQU   WCPASS,*-WCPASS,C'X'                                             
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SHOWWCIN -- SHOW WCINIT command.                                             
*                                                                               
SHOWWCIN XPROC WCWA                                                             
         CLEAR WCWA                                                             
*                                                                               
         VCALL COLLOPTS            Scan for collect options                     
*                                                                               
         LOOP  BEGIN                                                            
         LA    R0,CV#WC            WCINIT record set                            
         LA    R15,CVRG16                                                       
         VCALL XSETSET             Set correct record set                       
*                                                                               
         LA    R2,WCKEY            Key is the WCOUNTER name                     
         SETMSG WCDATA                                                          
         LA    R15,CVRG16                                                       
         VCALL XGETNEXT            Get previous info (if any)                   
         BNZ   CVNEXT              All done                                     
*                                                                               
         TSEG  WCKEY                                                            
         TSEG  '  '                                                             
*                                                                               
         IF    (WCCOST,NZ),BEGIN   There is a per count cost...                 
         TSEG  'Cost='                                                          
         L     R0,WCCOST                                                        
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ' '                                                              
         END                                                                    
*                                                                               
         IF    (WCPASS,NZ),'TSEG "(Password) "'                                 
*                                                                               
         TCR                                                                    
         END                                                                    
*                                                                               
         PEND  ,                   NOTE: we exit via CVNEXT above               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SETWCIN -- SET WCINIT command (priv'd).                                      
*                                                                               
SETWCIN  XPROC WCWA                                                             
         CLEAR WCWA                                                             
         LA    R6,WCWA                                                          
         USING WCWA,R6                                                          
*                                                                               
         IF    ^CPSFSPR,BEGIN      Priv'd command                               
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         SCAN  ,                   Get WCOUNTER name                            
         SCANCHK                                                                
*                                                                               
         IF    (R0,Z),BEGIN                                                     
         ERROR 'Missing option.'                                                
         END                                                                    
*                                                                               
         SCUPCASE WCKEY                                                         
*-                                                                              
*-       Get old WCINIT entry.                                                  
*-                                                                              
         LA    R0,CV#WC            WCINIT record set                            
         LA    R15,CVRG16                                                       
         VCALL XSETSET             Set correct record set                       
*                                                                               
         LA    R2,WCKEY            Key is the WCOUNTER name                     
         SETMSG WCDATA                                                          
         LA    R15,CVRG16                                                       
         VCALL XGET                Get previous info (if any)                   
*-                                                                              
*-       Scan for new options.                                                  
*-                                                                              
         SCAN  SETWCPRT            Scan SET WCINIT options                      
         SCANCHK                                                                
*-                                                                              
*-       Add/Update WCINIT entry.                                               
*-                                                                              
         LA    R0,CV#WC            WCINIT record set                            
         LA    R15,CVRG16                                                       
         VCALL XSETSET             Set correct record set                       
*                                                                               
         LA    R2,WCKEY            Key is the WCOUNTER name                     
         SETMSG WCDATA                                                          
         LA    R15,CVRG16                                                       
         VCALL XPUT                Update information                           
         IF    NZ,'ABORT "No more room (or record set error)."'                 
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*-                                                                              
*-       SET WCINIT options.                                                    
*-                                                                              
SETWCPRT SCKW  PASSWORD,XWCPAS,(A,P)                                            
         SCKW  NOPASSWORD,XWCNOPAS,A                                            
         SCKW  COST,XWCCOS,(A,P,LN)                                             
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
XWCNOPAS PROC                                                                   
         CLEAR WCPASS                                                           
         PEND                                                                   
*                                                                               
XWCPAS   PROC                                                                   
         SCUPCASE WCPASS                                                        
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
XWCCOS   PROC                                                                   
         ST    R0,WCCOST                                                        
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWCOST -- SHOW COST command.                                               
*                                                                               
SHOWCOST XPROC ,                                                                
         SCAN  COSTPRT                                                          
         SCANCHK                                                                
*-                                                                              
*-       Display session costs.                                                 
*-                                                                              
         VCALL DISPCOST            Display session cost                         
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
COSTPRT  SCKW  ,V(INTPSH),PUSH                                                  
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         QLTORG                                                                 
         TITLE 'FORCPASS -- Force PASSWORD change at logon'                     
*box                                                                            
*                                                                               
*  FORCPASS -- Routine to force PASSWORD change at logon                        
*                                                                               
*      ON ENTRY:  R1 -> KWR                                                     
*                                                                               
*      ON EXIT:   PASSWORD is changed (or user is logged off)                   
*                                                                               
FORCPASS XPROC                                                                  
         LR    R5,R1               Copy KWR ptr                                 
         USING (KWR,R5)                                                         
         TSEG  'The PASSWORD for this privileged account has not been c*        
               hanged for',,B                                                   
         BTD   CPDOUB,0,(R3)                                                    
         TSEG  (R1),(R0),B                                                      
         TSEG  'days.',,WR                                                      
         TSEG  'You must change it at this time or be logged off.',,WR          
*                                                                               
FORCNEW  TSEG  'Enter your NEW PASSWORD.',,WR                                   
         CLEAR R15                 Prompt for PASSWORD                          
         ACALL READPW              Get a PASSWORD                               
         IF    Z,BEGIN             Hit break - naughty naughty                  
         L     R15,CVCURJCB        Point to current JCB                         
         WITH  (JCB,R15),'SET JCBAFALO'  Logoff                                 
         B     CVNEXT              Sorry, Charlie ...                           
         END                                                                    
*                                                                               
         IF    (KWRPASS,EQ,@R15),BEGIN                                          
         TSEG  'Re-statement of the old PASSWORD does not constitute a *        
               CHANGE.',,WR                                                     
         B     FORCNEW             Try again                                    
         END                                                                    
*                                                                               
         IF    (R0,LT,5),BEGIN                                                  
         TSEG  'The PASSWORD must be at least 5 characters long.',,WR           
         B     FORCNEW             Try again                                    
         END                                                                    
*                                                                               
         MVC   KWRPASS,@R15        Move in new PASSWORD                         
         TSEG 'Enter the same new password again for verification.',,WR         
         CLEAR R15                 Prompt for PASSWORD                          
         ACALL READPW              Ask again                                    
         IF    Z,BEGIN             Hit break - naughty naughty                  
         L     R15,CVCURJCB        Point to current JCB                         
         WITH  (JCB,R15),'SET JCBAFALO'  Logoff                                 
         B     CVNEXT              Sorry, charlie ...                           
         END                                                                    
*                                                                               
         IF    (KWRPASS,NE,@R15),BEGIN                                          
         TSEG  'PASSWORD verification error',,WR                                
         L     R15,CVCURJCB        POINT TO CURRENT JCB                         
         WITH  (JCB,R15),'SET JCBAFALO'  Logoff                                 
         B     CVNEXT              Sorry, Charlie ...                           
         END                                                                    
*                                                                               
         LOOP  BEGIN                                                            
         STCK  CPDOUB                                                           
         MVC   KWRKTIM,CPDOUB      SAVE TIME & DATE                             
         ACALL PUTKWR                                                           
         UNTIL Z,END                                                            
*                                                                               
         LA    R0,SMFWKEY+SMFWAUTH SET PASSWORD command                         
         VCALL LOGKWR              Write smf log record                         
*                                                                               
         PEND                                                                   
         DROP  BR,R5,R6                                                         
         TITLE 'SET PASSWORD Command'                                           
*box                                                                            
*                                                                               
*  SETPASS -- SET PASSWORD command.                                             
*                                                                               
KEYWA    RECORD BEGIN                                                           
KEYNEW   DS    CL8                 New password                                 
KEYWAWA  DS    XL(L'WA)                                                         
         END                                                                    
*-                                                                              
SETPASS  XPROC KEYWA                                                            
         CLEAR KEYWA                                                            
*                                                                               
         LA    R5,KEYWAWA                                                       
         USING WA,R5                                                            
*                                                                               
         VCALL ORVCPASS            Send to SPIRES first                         
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
*                                                                               
         LA    R0,1                                                             
         ACALL GETAENT                                                          
*                                                                               
         SCAN  KEYPRT                                                           
         SCANCHK                                                                
         ACALL SEGACCT                                                          
         TWRITE                                                                 
*                                                                               
         IF    ((KWRPASS,NZ),AND,(KWRPASS,NE,CVBLANKS)),BEGIN                   
         TSEG  'Enter '                                                         
         SETMSG 'your'                                                          
         IF    (CPCACCT,NE,CPSACCT),'SETMSG "the"'                              
         TSEG  (R1),(R0)                                                        
         TSEG  ' current password.',,WR                                         
         ACALL READPW                                                           
         BZ    CVNOACTN            (ATTENTION)                                  
         DELAY                     Wait a bit ...                               
         IF    (@R15,NE,KWRPASS),BEGIN                                          
         ACALL WATCHKW                                                          
         ERROR 'Incorrect password.',,BADKW                                     
         END                                                                    
         END                                                                    
*                                                                               
KEYREP   TSEG  'Enter '                                                         
         SETMSG 'your'                                                          
         IF    (CPCACCT,NE,CPSACCT),'SETMSG "the"'                              
         TSEG  (R1),(R0)                                                        
         TSEG  ' new password.',,WR                                             
         ACALL READPW                                                           
         BZ    CVNOACTN            (ATTENTION)                                  
         MVC   KEYNEW,@R15                                                      
*                                                                               
         IF    (R0,GT,L'KWRPASS),BEGIN  Too long...                             
         TSEG  'Your password can''t be longer than 8 characters.',,WR          
         B     KEYREP                                                           
         END                                                                    
*                                                                               
         IF    (R0,LT,5),BEGIN     Too short...                                 
         TSEG  'Your password must be at least 5 characters long.',,WR          
         B     KEYREP                                                           
         END                                                                    
*-                                                                              
*-       Make sure that new passwords conform to IBM's wishes.                  
*-         (For more information look in the PROT module.)                      
*-                                                                              
         LA    R1,KEYNEW                                                        
         VCALL RACPASCK            Check password validity                      
         IF    NZ,BEGIN            Not good...                                  
         IF    (R15,EQ,8),BEGIN    Too short...                                 
         TSEG  'This password is too short, '                                   
         TSEG  'please use a longer one.',,CR                                   
         B     KEYREP                                                           
         END                                                                    
         TSEG  'Please pick a password without "special"'                       
         TSEG  ' characters in it.',,CR                                         
         TSEG  'Passwords can only contain alphabetic, numeric'                 
         TSEG  ' and national (#,$,@) characters.',,CR                          
         TSEG  'For example, 54132 is a valid password and TRY23% '             
         TSEG  'is not a valid password.',,CR                                   
         TCR                                                                    
         B     KEYREP                                                           
         END                                                                    
*                                                                               
KEYREP2  TSEG  'Enter the same new password again '                             
         TSEG  'for verification.',,WR                                          
         ACALL READPW                                                           
         BZ    CVNOACTN            (ATTENTION)                                  
         IF    (@R15,NE,KEYNEW),BEGIN                                           
         TSEG  'The passwords are not the same, '                               
         ABORT 'the new password has not been set.'                             
         END                                                                    
*                                                                               
         LOOP  BEGIN                                                            
         MVC   KWRPASS,KEYNEW                                                   
         AIF   (&KEYUPLO).KEYUPL1                                               
         OC    KWRPASS,CVBLANKS    Force upper case                             
.KEYUPL1 ANOP                                                                   
         STCK  CPDOUB                                                           
         MVC   KWRKTIM,CPDOUB      Save time & date                             
         ACALL PUTKWR                                                           
         UNTIL Z,END                                                            
*-                                                                              
*-       Tell RACF that the password has changed.                               
*-                                                                              
         LA    R15,KWRACCT         Account (in "uuugg" form)                    
         LA    R1,KWRPASS          Password                                     
         VCALL RACUPDPW            Update password                              
*-                   p                                                          
*-       Log the SET PASSWORD command.                                          
*-                                                                              
         LA    R0,SMFWKEY+SMFWAUTH                                              
         VCALL LOGKWR              Write SMF log record                         
*                                                                               
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
*                                                                               
KEYPRT   SCKW  ,V(NOTVALID)                                                     
*                                                                               
         QLTORG                                                                 
*                                                                               
         TITLE 'SHOW LTIME Command'                                             
*box                                                                            
*                                                                               
*  SHOWLTIM -- SHOW LTIME command.                                              
*                                                                               
SHOWLTIM XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LA    R0,1                                                             
         ACALL GETAENT                                                          
*                                                                               
         VCALL COLLOPTS            Allow standard options                       
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL LTIMDISP                                                         
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  LTIMDISP -- Routine to display time of last logoff (also called              
*    by COMM at logon).                                                         
*                                                                               
*      On entry:                                                                
*        R1 - KWR ptr                                                           
*                                                                               
*      On exit, R15 (and CC):                                                   
*        0 - ok                                                                 
*        nz- attn on twrite                                                     
*                                                                               
LTIMDISP XPROC                                                                  
         LR    R6,R1                                                            
         USING KWR,R6                                                           
*                                                                               
         IF    (KWRLTIM,Z),'TSEG "No last logoff time."'                        
*                                                                               
         ELSE  BEGIN                                                            
         TSEG  'Last logoff was '                                               
         L     R0,KWRLTIM                                                       
         CLEAR R1                                                               
         XPUSH ,,32,PTR=R15                                                     
         VCALL FMTXDATE            Nicely formatted time/date                   
         TSEG  (R1),(R0)                                                        
*                                                                               
         IF    ((KWRLPORT,NZ),AND,(KWRLPORT,NE,CVBLANKS)),BEGIN                 
         TSEG  ' from port '                                                    
         TSEG  KWRLPORT                                                         
         END                                                                    
         END                                                                    
*                                                                               
         TWRITE                                                                 
         PEND                                                                   
         DROP  KWR                                                              
         TITLE 'SHOW KTIME Command'                                             
*box                                                                            
*                                                                               
*  SHOWKTIM -- SHOW KTIME command.                                              
*                                                                               
SHOWKTIM XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         MVC   CPCACCT,CPSACCT                                                  
         LH    R0,=H'-1'                                                        
         ACALL GETAENT                                                          
*                                                                               
         VCALL COLLOPTS            Allow standard options                       
         ACALL SEGACCT                                                          
         LA    R1,KWR                                                           
         ACALL KTIMDISP                                                         
         CLEAR KWR                                                              
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  KTIMDISP -- Routine to display time of the last password                     
*    change (also called by COMM at logon).                                     
*                                                                               
*      On entry:                                                                
*        R1 - KWR ptr                                                           
*                                                                               
*      On exit, R15 (and CC):                                                   
*        0 - ok                                                                 
*        nz- attn on twrite                                                     
*                                                                               
KTIMDISP XPROC                                                                  
         LR    R6,R1                                                            
         USING KWR,R6                                                           
*                                                                               
         IF    (KWRKTIM,Z),'TSEG "No last password change time."'               
         ELSE  BEGIN                                                            
         TSEG  'Last password change at',,B                                     
         VCALL LOCALTOD                                                         
         LR    R2,R0                                                            
         CLEAR R3                                                               
         L     R0,KWRKTIM                                                       
         CLEAR R1                                                               
         XPUSH ,,30,PTR=R15                                                     
         VCALL FMTRCLCK            "hh:mm" or "hh:mm mm/dd/yyyy"                
         TSEG  (R1),(R0),B                                                      
         XPOP  ,,30                                                             
*                                                                               
         L     R14,KWRKTIM         Time/date of last kw change                  
         CLEAR R15                                                              
         SRDL  R14,12+6            .000001*64 of a sec                          
         D     R14,=A(1000000/64*60*60*24)  No. of days since 1900              
         STCK  CPDOUB                                                           
         LM    R2,R3,CPDOUB        Current time/date                            
         SRDL  R2,12+6                                                          
         D     R2,=A(1000000/64*60*60*24)                                       
         SR    R3,R15              No. of elapsed days                          
         IF    POS,BEGIN                                                        
         TSEG  '('                                                              
         BTD   CPDOUB,0,(R3)                                                    
         TSEG  (R1),(R0),B                                                      
         TSEG  'days ago)'                                                      
         END                                                                    
         END                                                                    
         TWRITE                                                                 
         PEND                                                                   
         DROP  KWR                                                              
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SMF -- SMF command  (secret)                                                 
*                                                                               
*                                                                               
*                                                                               
SMFWA    RECORD BEGIN                                                           
SMFNAME  DS    CL8                 Smf logging name                             
         END                                                                    
*                                                                               
*                                                                               
SMF      XPROC SMFWA                                                            
         USING SMFWA,WAR                                                        
         CLEAR SMFWA                                                            
         SCAN  SMFPRT              Scan smf type                                
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
*                                                                               
         SCUPCASE SMFNAME          Save smf type                                
*                                                                               
         SCAN  ,                   Scan smf record text                         
         SCANCHK                                                                
         IF    (R0,Z),CVABSENT                                                  
*                                                                               
* WE ACCEPT: 'SMF TEST "..."'  OR  'SMF TEST / ... '                            
*                                                                               
         IF    (@R1,EQ,'/'),BEGIN                                               
         SCINFO                                                                 
         END                                                                    
         ELSE  BEGIN                                                            
         VCALL CKQUOTES                                                         
         VCALL DEQUOTE                                                          
         END                                                                    
         LA    R15,SMFNAME                                                      
         VCALL SMFLOG              Go write SMF record                          
         B     CVNEXT                                                           
         PEND  ,                                                                
*                                                                               
SMFPRT   SCKW  RLIN,SMFCOM                                                      
         SCKW  RLINCMD,SMFCOM                                                   
         SCKW  RLINTEST,SMFCOM                                                  
         SCKW  SSA,SMFCOM                                                       
         SCKW  RACF,SMFCOM                                                      
         SCKW  PASSWORD,SMFCOM                                                  
         SCKW  SECURITY,SMFCOM                                                  
         SCKW  PRODLIBS,SMFCOM                                                  
         SCKW  PROGUSE,SMFCOM                                                   
         SCKW  TEST,SMFCOM                                                      
         SCKW  QAS,SMFCOM                                                       
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SMFCOM   PROC  ,                                                                
         LA    R15,4                                                            
         PEND  ,                                                                
         TITLE 'SET/SHOW SMF Commands'                                          
*box                                                                            
*                                                                               
*  SETSMF -- SET SMF/NOSMF command  (priv'd)                                    
*                                                                               
SETSMF   XPROC                                                                  
*                                                                               
         IF    (CPSFAPR+CPSFSPR,Z),BEGIN                                        
         VCALL NOTVALID                                                         
         END                                                                    
*                                                                               
         TSEG  'SMF session accounting will be turned',,B                       
         SETMSG 'on'                                                            
         IF    (CPCMNM,NE,'SMF'),'SETMSG "off"'                                 
         TSEG  (R1),(R0),CR                                                     
         SETMSG 'OK'                                                            
         VCALL YESREQ                                                           
*                                                                               
         MVC   SMSGON,=C'ON '                                                   
         IF    (CPCMNM,NE,'SMF'),'MVC SMSGON,=C"OFF"'                           
         MVC   SMSGGRP,CPSGRP                                                   
         MVC   SMSGUSER,CPSUSER                                                 
         XWTO  SMSG                                                             
*                                                                               
         LA    R15,=CL8'SETSMF'                                                 
         SETMSG CPCMD,LH:CPCMDLEN                                               
         VCALL SMFLOG              For the record                               
*                                                                               
         CLEAR CVFNOSMF            Assume smf                                   
         IF    (CPCMNM,NE,'SMF'),'SET CVFNOSMF'                                 
         INCR  R15,CVCHKUC         Time to do checkpoint I/O                    
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
SMSGSTRT DC    C'SMF session accounting turned '                                
SMSGON   DC    C'***',C' by '                                                   
SMSGGRP  DC    C'??',C'.'                                                       
SMSGUSER DC    C'???'                                                           
SMSG     EQU   SMSGSTRT,*-SMSGSTRT,C'X'                                         
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWSMF -- SHOW SMF command.                                                 
*                                                                               
SHOWSMF  XPROC                                                                  
         TSEG  'SMF session accounting is turned',,B                            
         SETMSG 'on'                                                            
         IF    CVFNOSMF,'SETMSG "off"'                                          
         B     CVNXTMSG                                                         
*                                                                               
         PEND                                                                   
         SPACE 2                                                                
         QLTORG                                                                 
         TITLE 'SET PRIV Command'                                               
PRIVWA   RECORD BEGIN                                                           
PRIVKIFL DS    X                                                                
PRIVKAFL DS    X                                                                
*                                                                               
PRIVKWR  DS    XL(L'KWR)                                                        
*                                                                               
PRIVSIB  DS    XL(L'SIB)                                                        
         END                                                                    
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  SETPRIV -- SET PRIV command  (priv'd)                                        
*                                                                               
SETPRIV  XPROC PRIVWA                                                           
*                                                                               
         CLEAR PRIVWA                                                           
         LA    R4,PRIVWA                                                        
         USING PRIVWA,R4                                                        
*                                                                               
         MVC   PRIVKIFL,CPSKIFL                                                 
         MVC   PRIVKAFL,CPSKAFL                                                 
*                                                                               
         IF    (CPCMNM,EQ,'N'),BEGIN  nopriv...                                 
         MVI   PRIVKIFL,KWRIFVAL                                                
         MVI   PRIVKAFL,KWRAFVAL                                                
         END                                                                    
*                                                                               
         LA    R6,PRIVKWR                                                       
         USING KWR,R6                                                           
         MVC   KWRUSER,CPSUSER     uuu                                          
         MVC   KWRGRP,CPSGRP       gg                                           
         KREAD KWR                                                              
*                                                                               
         SCPUSH                                                                 
         SCAN  ,                                                                
         SCANCHK                                                                
         IF    (R0,NZ),BEGIN                                                    
         IF    (@R1,NE,X'D9C1E9E9D3C54BC4C1E9E9D3C5'),EXIT                      
         MVC   @R1(13),=X'9589A9A993854B8689A9A99385'                           
         SETMSG X'D5C9E9'                                                       
         LCR   R0,R0                                                            
         SCPOP , GOT WHAT WE WANT RESTORE AND RESCAN                            
         SCAN                                                                   
         B     PRIVNF                                                           
         END                                                                    
         SCPOP ,  NOT WHAT WE WERE LOOKING FOR, START AGAIN                     
*                                                                               
         IF    ^KWRHFL.KWRHFCK,BEGIN  no account file...                        
         TSEG  'No account file.',,CR                                           
         SETMSG 'OK'                                                            
PRIVNF   SCPUSH                                                                 
         VCALL YESREQ                                                           
         SCPOP                                                                  
         END                                                                    
*                                                                               
         ELSE  BEGIN                                                            
         IF    (CPSGRP,NE,'G'),BEGIN                                            
         VCALL NOTVALID                                                         
         END                                                                    
         IF    (KWRIFL.KWRIFVAL+KWRIFSPR,^ONES),BEGIN                           
         VCALL NOTVALID                                                         
         END                                                                    
         IF    (CPCMNM,EQ,'N'),EXIT  nopriv                                     
         MVC   PRIVKIFL,KWRIFL                                                  
         MVC   PRIVKAFL,KWRAFL                                                  
         END                                                                    
*                                                                               
         SCAN  PRIVPRT                                                          
         SCANCHK                                                                
*                                                                               
         LA    R15,=CL8'MAGIC'                                                  
         XPUSH ,,8,PTR=R3                                                       
         MVC   @R3(8),CPCMD                                                     
         MVC   CPCMD(8),=CL8'MAGIC'                                             
*                                                                               
         SETMSG CPCMD,LH:CPCMDLEN                                               
         VCALL SMFLOG              For the record                               
*                                                                               
         MVC   CPCMD(8),@R3                                                     
         XPOP  ,,8                                                              
*                                                                               
         LOOP  BEGIN                                                            
         LA    R5,PRIVSIB                                                       
         WITH  (SIB,R5)                                                         
         MVC   SIB,CPS                                                          
         MVC   SIBKIFL,PRIVKIFL    Update                                       
         MVC   SIBKAFL,PRIVKAFL    ...privs                                     
         INCR  R15,SIBUC           Kick update count                            
         TSEG  SIBID                                                            
         TSEG  SIBNO                                                            
         TSEG  SIBUC                                                            
         TSEG  SIBSESS                                                          
         TCNTL CTLPSETO            Set session options                          
         IF    Z,EXIT              Ok                                           
         IF    (R15,NE,4),CVMILERR                                              
         MVC   SIB,@R1             Must re-update                               
         END                                                                    
*                                                                               
         MVC   CPS,PRIVSIB         Keep cp copy accurate                        
         B     CVNEXT                                                           
         PEND                                                                   
         EJECT                                                                  
PRIVPRT  SCKW  SYSTEMS,PRIVSYS,A                                                
         SCKW  OPERATOR,PRIVOPR,A                                               
         SCKW  OPR,PRIVOPR                                                      
         SCKW  ACCOUNT,PRIVACCT,A                                               
         SCKW  ACCT,PRIVACCT                                                    
         SCKW  ADMIN,PRIVADM,A                                                  
         SCKW  SUBMIT,PRIVSBM,A                                                 
         SCKW  PC,PRIVPC                                                        
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
*                                                                               
PRIVSYS  PROC                                                                   
         SET   PRIVKIFL.KWRIFSPR                                                
         PEND                                                                   
*                                                                               
PRIVOPR  PROC                                                                   
         SET   PRIVKIFL.KWRIFOPR                                                
         PEND                                                                   
*                                                                               
PRIVACCT PROC                                                                   
         SET   PRIVKIFL.KWRIFAPR                                                
         PEND                                                                   
*                                                                               
PRIVADM  PROC                                                                   
         SET   PRIVKIFL.KWRIFADM                                                
         PEND                                                                   
*                                                                               
PRIVSBM  PROC                                                                   
         SET   PRIVKIFL.KWRIFSBM                                                
         PEND                                                                   
*                                                                               
PRIVPC   PROC                                                                   
         SET   PRIVKIFL.KWRIFPC                                                 
         PEND                                                                   
*                                                                               
         DROP  KWR,PRIVWA                                                       
*                                                                               
         QLTORG                                                                 
         TITLE 'SET/SHOW MASTER Commands'                                       
*box                                                                            
*                                                                               
*  SETMAST -- SET MASTER command.  (Priv'd)                                     
*                                                                               
SETMAST  XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         SET   CPFVER                                                           
         LA    R0,2                Acct might exist, no kw prompt               
         ACALL GETAENT                                                          
*                                                                               
         IF    (CPSFAPR+CPSFADM+CPSFSUB,Z),BEGIN                                
         LA    R0,SMFWMAST         Attempted set master                         
         VCALL LOGKWR              Log attempt                                  
         VCALL NOTVALID                                                         
         END                                                                    
*-                                                                              
*-       Special RLIN group code check.                                         
*-                                                                              
         IF    (KWRGRP,NE,CPSGRP),BEGIN                                         
         IF    (CPSFAPR+CPSFADM,Z),'ACALL BADAGRP'  No match, scram             
         IF    (((KWRGRP,EQ,'B'),OR,(KWRGRP,EQ,'Y'),OR,                *        
               (KWRGRP,EQ,'Z'),OR,                                     *        
               (KWRGRP,EQ,'DQ'),OR,                                    *        
               (KWRGRP,EQ,'HH'),OR,(KWRGRP,EQ,'HN')),AND,              *        
               (CPSGRP,EQ,'B')),EXIT                                            
         IF    ^CPSFAPR,'ACALL BADAGRP'    Not your group                       
         END                                                                    
*-                                                                              
*-       Special HOSPITAL (SYSC) group code check.                              
*-                                                                              
         IF    ((CPSGRP,EQ,'CV'),OR,(CPSGRP,EQ,'C1')),BEGIN                     
         IF    (KWRGRP,EQ,'CV'),EXIT                                            
         IF    (KWRGRP,EQ,'C1'),EXIT                                            
         ACALL BADAGRP                                                          
         END                                                                    
*-                                                                              
*-       The first character of the user-id must match for SUBADMIN.            
*-                                                                              
         IF    CPSFSUB,BEGIN       SUBADMIN privs...                            
         IF    ('CLC KWRUSER(1),CPSUSER',NE),'ACALL BADAGRP'                    
         END                                                                    
*                                                                               
         SET   WAFMAST             SET MASTER command                           
*                                                                               
         IF    ^KWRIFL.KWRIFVAL,BEGIN  New acct...                              
         IF    (CPCUSER,EQ,'ALL'),BEGIN                                         
         ABORT 'Can''t create account ALL.'                                     
         END                                                                    
         SET   WAFNEW              Creating new account                         
         MVC   KWRUSER,=C'PUB'     Use pub as template acct                     
         LA    R1,KWR                                                           
         LA    R0,2                                                             
         ACALL GETKWR                                                           
         IF    KWRIFL.KWRIFVAL,BEGIN  Template account exists...                
         CLEAR KWRPASS,KWRRJE,KWRSPUSD,KWRWRCT                                  
         CLEAR KWRBAL,KWRSFL,KWRJNO,KWRACCH,KWRHRSUS,KWRHRSFR                   
         CLEAR KWRAFL.KWRAFASV                                                  
         CLEAR KWRCRDT             Clear account creation date                  
         CLEAR KWRKTIM,KWRLTIM     Clear LTIME and KTIME too                    
         CLEAR KWRXCNT,KWRXTIM     Clear logon attempt counters                 
         END                                                                    
         ELSE  BEGIN               No template account...                       
         IF    (KWRUSER,NE,'PUB'),'ACALL BADACCT'                               
         L     R2,=A(DEFKWR)                                                    
         MOVEL KWR,(R2)            Move in universal defaults                   
         MVC   KWRFORM,=CL4'&STDFORM' Set standard forms ID                     
         AIF   ('&INSTALN' NE 'STANFORD').NOUSTYP                               
         MVC   CPDOUB(2),CPCUSER                                                
         MVC   CPDOUB+3(2),CPCGRP                                               
         HASPSERV USERTYPE,CPDOUB                                               
         IF    (R15,Z),BEGIN                                                    
         STC   R0,CPDOUB           User type                                    
         MVI   KWRMPRIM,KWRFSYSA   Assume SYSA                                  
         IF    CVFRLG,'MVI KWRMPRIM,KWRFSYSB'  SYSB (RLG)                       
         MVC   KWRMACC,KWRMPRIM    Allow access to primary machine              
         IF    CPDOUB.$USOPEN,BEGIN                                             
         CLEAR KWRBFL.KWRBFP       Noprod                                       
         MVI   KWRJFL,KWRJFPUB     Job auth=public                              
         END                                                                    
         END                                                                    
.NOUSTYP ANOP                                                                   
         END                                                                    
*                                                                               
         MVC   KWRGRP,CPCGRP                                                    
         MVC   KWRUSER,CPCUSER                                                  
         MVC   KWRJPFX,CVBLANKS                                                 
         MVC   KWRJPFX(5),KWRUSER                                               
         XC    KWRJPFX,=C'JOBMASK.'                                             
         SET   KWRTFL.KWRTFAM+KWRTFAR+KWRTFAE  AUTO stuff                       
         CLEAR KWRTFL2.KWRTFAPE    Clear AUTO PUBEXEC                           
         SET   KWRTFL2.KWRTFANE    Set AUTO NEWEXEC                             
*                                                                               
         AIF   ('&INSTALN' NE 'STANFORD').NOSTAMX                               
         IF    ((KWRGRP,EQ,'EC'),OR,(KWRGRP,EQ,'ED')),STAMX                     
*                                                                               
         IF    ((KWRGRP,EQ,'BN'),OR,(KWRGRP,EQ,'BS'),OR,               *        
               (KWRGRP,EQ,'BT'),OR,(KWRGRP,EQ,'BQ'),OR,                *        
               (KWRGRP,EQ,'BG'),OR,(KWRGRP,EQ,'BU'),OR,                *        
               (KWRGRP,EQ,'BX'),OR,(KWRGRP,EQ,'BD'),OR,                *        
               (KWRGRP,EQ,'BF')),BEGIN    (Ballots)                             
STAMX    CLEAR KWRTFL.KWRTFAN      No AUTO news                                 
         CLEAR KWRTFL2.KWRTFANE    Clear AUTO NEWEXEC                           
         SET   KWRTFL2.KWRTFAPE    Set AUTO PUBEXEC                             
         END                                                                    
.NOSTAMX ANOP                                                                   
*                                                                               
         STCK  @R13                                                             
         MVC   KWRKTIM,@R13        Set password change time                     
         MVC   KWRCRDT,@R13        Set account creation date                    
*                                                                               
         XPUSH ,,10,PTR=R3         Room for "mm/dd/yyyy"                        
         VCALL LOCALTOD            Get current time/date                        
         LR    R15,R3                                                           
         VCALL FMTDATE             "mm/dd/yyyy"                                 
         SETMSG @R3+8,2             "yy"                                        
         VCALL DTB                                                              
         LR    R2,R15                                                           
         SLL   R2,8                                                             
         SETMSG @R3,2               "mm"                                        
         VCALL DTB                                                              
         AR    R2,R15                                                           
         SLL   R2,8                                                             
         SETMSG @R3+3,2             "dd"                                        
         VCALL DTB                                                              
         AR    R2,R15                                                           
         SLL   R2,8                                                             
         ST    R2,KWRNEWDT         Today's date as last news date               
         XPOP  ,,8                                                              
         END                                                                    
*                                                                               
         SCSAVE AREA=WASCSAVE                                                   
         ACALL MASTSCAN            Scan SET MASTER options                      
*                                                                               
         IF    WAFDEL*WAFCRE,BEGIN                                              
         ABORT 'CREATE and DELETE options conflict.'                            
         END                                                                    
         IF    WAFDEL,BEGIN                                                     
         IF    WAFOP,BEGIN                                                      
         ERROR 'DELETE can''t be specified with other options.'                 
         END                                                                    
         SET   WAFOP                                                            
         IF    WAFNEW,'ACALL BADACCT'      Account doesn't exist                
         CLEAR KWRIFL.KWRIFVAL                                                  
         END                                                                    
         IF    (WAFNEW,AND,^WAFCRE),'ACALL BADACCT'                             
         IF    (^WAFNEW,AND,WAFCRE),BEGIN                                       
         TSEG  'Account '                                                       
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER                                                          
         ABORT ' already exists.'                                               
         END                                                                    
         IF    ^WAFOP,'ERROR "Missing SET MASTER options."'                     
*                                                                               
         LA    R1,KWR                                                           
         ACALL MASTDISP            Do show master                               
         IF    CPFVER,BEGIN                                                     
         SETMSG 'Update'                                                        
         IF    WAFNEW,'SETMSG "Create"'                                         
         IF    WAFDEL,'SETMSG "Delete"'                                         
         VCALL YESREQ                                                           
         END                                                                    
*                                                                               
         LOOP  BEGIN                                                            
         IF    ('ACALL PUTKWR',Z),EXIT  Re-write record                         
         SCRSTR AREA=WASCSAVE                                                   
         ACALL MASTSCAN                                                         
         END                                                                    
*-                                                                              
*-       Tell RACF about the new account.                                       
*-                                                                              
         IF    WAFNEW,BEGIN        New account just created...                  
         LA    R1,KWRACCT          Account (in "uuugg" form)                    
         VCALL RACADD              Add new account to RACF                      
         IF    NZ,BEGIN            Trouble...                                   
         XPUSH R0,R1                                                            
         TSEG  'Note: Account not added to RACF data base -- '                  
         XPOP  R0,R1                                                            
         TSEG  (R1),(R0),CR                                                     
         END                                                                    
         END                                                                    
*-                                                                              
*-       Tell RACF about the account that was just deleted.                     
*-                                                                              
         IF    WAFDEL,BEGIN        Account just deleted...                      
         LA    R1,KWRACCT          Account (in "uuugg" form)                    
         VCALL RACDEL              Delete account from RACF                     
         IF    NZ,BEGIN            Trouble...                                   
         XPUSH R0,R1                                                            
         TSEG  'Note: Account not deleted from RACF data base -- '              
         XPOP  R0,R1                                                            
         TSEG  (R1),(R0),CR                                                     
         END                                                                    
         END                                                                    
*-                                                                              
*-       Tell RACF that the password has changed.                               
*-                                                                              
         IF    WAFUPDPW,BEGIN      Password has changed...                      
         LA    R15,KWRACCT         Account (in "uuugg" form)                    
         LA    R1,KWRPASS          Password                                     
         VCALL RACUPDPW            Update password                              
         END                                                                    
*-                                                                              
*-       Log the SET MASTER command.                                            
*-                                                                              
         LA    R0,SMFWMAST+SMFWAUTH                                             
         VCALL LOGKWR              Log command                                  
*                                                                               
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
**                                                                              
**                                                                              
**  SET MASTER options;  MASTPRT  if accounting privs                           
**                       MASTPRTA if just admin privs                           
**                                                                              
MASTPRT  SCKW  SUSPEND,KSUSP,A                                                  
         SCKW  NOSUSPEND,KNOSUSP,A                                              
         SCKW  ACTIVE,KNOSUSP,A                                                 
         SCKW  ACCOUNT,KACCT                                                    
         SCKW  NOACCOUNT,KNOACCT                                                
         SCKW  SYSTEMS,KSPR,A                                                   
         SCKW  NOSYSTEMS,KNOSPR,A                                               
         SCKW  OPERATOR,KOPR,A                                                  
         SCKW  OPR,KOPR                                                         
         SCKW  NOOPERATOR,KNOOPR,A                                              
         SCKW  NOOPR,KNOOPR,A                                                   
         SCKW  SUBMIT,KSBM,A                                                    
         SCKW  NOSUBMIT,KNOSBM,A                                                
         SCKW  ADMIN,KADMIN,A                                                   
         SCKW  SUBADMIN,KSUBADM,A                                               
         SCKW  SUPERADMIN,KSUPADM,A                                             
         SCKW  NOADMIN,KNOADMIN,A                                               
         SCKW  PC,KPC                                                           
         SCKW  NOPC,KNOPC          (Must come before "NOPCHECK")                
         SCKW  USER,KUCP,A                                                      
         AIF   ('&INSTALN' NE 'STANFORD').NOSOF1                                
         SCKW  FUNDS,KFUNDS,(A,P)                                               
.NOSOF1  ANOP                                                                   
         SCKW  STATUS,KSTATUS,(A,P)                                             
         AIF   (NOT &BUDGET).NOBUDG1                                            
         SCKW  NOBUDGET,KNOBUDG,A                                               
         SCKW  BUDGET,KBUDGET,A                                                 
.NOBUDG1 ANOP                                                                   
         AIF   (NOT &SPACE).SPACE1                                              
         SCKW  ASPACE,KASPACE,A                                                 
.SPACE1  ANOP                                                                   
         SCKW  CREATE,KCREATE,A                                                 
         SCKW  DELETE,KDELETE,A                                                 
****                                                                            
****  SCKW's above this line are only allowed for ACCT priv                     
****  accounts;  SCKW's below this line are allowed for either ACCT             
****  or ADMIN priv'd accounts.                                                 
****                                                                            
MASTPRTA SCKW  PASSWORD,KPASS,(A,P)                                             
         SCKW  KEYWORD,KPASS,(A,P)                                              
         SCKW  MULTIPLE,KMULT,A                                                 
         SCKW  XMULTIPLE,KXMULT,A                                               
         SCKW  NOMULTIPLE,KNOMULT,A                                             
         SCKW  SINGLE,KNOMULT,A                                                 
         SCKW  LPASSWORD,KLPASS,A                                               
         SCKW  NOLPASSWORD,KNOLPASS,A                                           
         SCKW  SYSA,KSYSA                                                       
         SCKW  SYSB,KSYSB                                                       
         SCKW  SYSC,KSYSC                                                       
         SCKW  SYSD,KSYSD                                                       
         SCKW  SYSH,KSYSH                                                       
         SCKW  SYSF,KSYSF                                                       
         SCKW  SYSG,KSYSG                                                       
         SCKW  NAME,KNAME,(A,P)                                                 
         SCKW  COMMENT,KCOMM,(A,P)                                              
         SCKW  MAIL,KMAIL,A                                                     
         SCKW  NOMAIL,KNOMAIL,A                                                 
         SCKW  HOURS,KHOURS,A                                                   
         SCKW  AHOURS,KAHOURS,A                                                 
         SCKW  UHOURS,KUHOURS,A                                                 
         SCKW  FHOURS,KFHOURS,A                                                 
         SCKW  TIME,KIGNNUM,A      ** Compatiblity **                           
         SCKW  WAIT,KIGNNUM,A      ** Compatiblity **                           
         SCKW  EXPRESS,KEXPRESS,A                                               
         SCKW  NOEXPRESS,KNOEXP,A                                               
         SCKW  INTERACTIVE,KINT,A                                               
         SCKW  NOINTERACTIVE,KNOINT,A                                           
         SCKW  STATISTICS,KSTAT,A                                               
         SCKW  NOSTATISTICS,KNOSTAT,A                                           
         SCKW  DAYTIME,KDAY,A                                                   
         SCKW  NODAYTIME,KNODAY,A                                               
         SCKW  NOTIME,KNOTIME,A                                                 
         SCKW  SECURE,KSECURE,A                                                 
         SCKW  NOSECURE,KNOSEC,A                                                
         SCKW  BATCH,KBATCH,A                                                   
         SCKW  NOBATCH,KNOBATCH,A                                               
         SCKW  PRIORITY,KPRIO,A                                                 
         SCKW  NOPRIORITY,KNOPRIO,A                                             
         SCKW  PRODUCTION,KPROD,A                                               
         SCKW  NOPRODUCTION,KNOPROD,A                                           
         SCKW  SETUP,KSETUP,A                                                   
         SCKW  NOSETUP,KNOSET,A                                                 
         SCKW  PSETUP,KPSETUP,A                                                 
         SCKW  NOPSETUP,KNOPSET,A                                               
         SCKW  DESTINATION,KDEST,(A,P)                                          
         SCKW  FORMS,KFORMS,(A,P)                                               
         SCKW  PRTFORMS,KPFORMS,(A,P)                                           
         SCKW  BIN,KBIN,(A,P)                                                   
         SCKW  NOCPU,KNOCPU,A                                                   
         SCKW  CPU,KCPU,A                                                       
         SCKW  NOCARDS,KNOCARDS,A                                               
         SCKW  CARDS,KCARDS,A                                                   
         SCKW  NOLINES,KNOLINES,A                                               
         SCKW  LINES,KLINES,A                                                   
         AIF   (NOT &SPACE).SPACE2                                              
         SCKW  SPACE,KSPACE,A                                                   
         SCKW  NOSPACE,KNOSPACE,A                                               
.SPACE2  ANOP                                                                   
         SCKW  VOLUME,KVOL,(A,P)                                                
         SCKW  NOVOLUME,KNOVOL,A                                                
         SCKW  NETUSER,KNETU,(A,P)                                              
         SCKW  NONETUSER,KNONETU,A                                              
         SCKW  NETHOST,KNETH,(A,P)                                              
         SCKW  NONETHOST,KNONETH,A                                              
         SCKW  ,V(VERPSH),PUSH                                                  
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  MASTSCAN -- Routine to scan SET MASTER options.  (This is a                  
*    separate routine because it is almost 4K of code and needs                 
*    separate addressabity.  COMMENT NO LONGER VALID 4/92 .CH)                  
*                                                                               
*  Note about IOWA STATE &KEYUPLO password mod:                                 
*    ISU added the ability to have upper and lower case passwords               
*    based on the setting of the &KEYUPLO SETB.  This is still                  
*    preserved; however, to set an upper-lower case password on                 
*    SET MASTER you must now quote the password (e.g.                           
*    password 'UpLow').  Doing it this way simplified the scanning,             
*    I hope that's ok with you Bill/Steve! (8/87, /j)                           
*                                                                               
MASTSCAN PROC                                                                   
         IF    CPSFAPR,BEGIN                                                    
         SCAN  MASTPRT             ACCT priv is superset                        
         SCANCHK                                                                
         END                                                                    
         ELSE  BEGIN                                                            
         SCAN  MASTPRTA            ADMIN priv                                   
         SCANCHK                                                                
         END                                                                    
         PEND                                                                   
         SPACE 2                                                                
***                                                                             
***  Scan routines for MASTPRT/MASTPRTA.                                        
***                                                                             
KSUSP    PROC                                                                   
         SET   WAFOP,(KWRAFL.KWRAFVAL,OFF)                                      
         PEND                                                                   
*                                                                               
KNOSUSP  PROC                                                                   
         SET   WAFOP,KWRAFL.KWRAFVAL                                            
         PEND                                                                   
*                                                                               
KLPASS   PROC                                                                   
         SET   WAFOP,(KWROFL.KWRFNPAS,OFF)                                      
         PEND                                                                   
*                                                                               
KNOLPASS PROC                                                                   
         SET   WAFOP,KWROFL.KWRFNPAS                                            
         PEND                                                                   
*                                                                               
KSYSA    PROC                                                                   
         LA    R15,KWRFSYSA                                                     
         ACALL KXSYS                                                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSYSB    PROC                                                                   
         LA    R15,KWRFSYSB                                                     
         ACALL KXSYS                                                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSYSC    PROC                                                                   
         LA    R15,KWRFSYSC                                                     
         ACALL KXSYS                                                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSYSD    PROC                                                                   
         LA    R15,KWRFSYSD                                                     
         ACALL KXSYS                                                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSYSH    PROC                                                                   
         LA    R15,KWRFSYSE                                                     
         ACALL KXSYS                                                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSYSF    PROC                                                                   
         LA    R15,KWRFSYSF                                                     
         ACALL KXSYS                                                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSYSG    PROC                                                                   
         XWTO  'KSYSG'                                                          
         LA    R15,KWRFSYSG                                                     
         ACALL KXSYS                                                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KXSYS    PROC                                                                   
         SET   WAFOP                                                            
         IF    ^WAFXSYS,BEGIN      First machine specified...                   
         SET   WAFXSYS             One machine has been specified               
         EX    R15,'MVI KWRMPRIM,0'  Set primary machine                        
         MVC   KWRMACC,KWRMPRIM    Allow access to primary machine              
         END                                                                    
         ELSE  BEGIN               Secondary machine specified...               
         EX    R15,'OI KWRMACC,0'  Set secondary machine also                   
         XWTO  'KXSYS secondary'   *** slp debug ***                            
         END                                                                    
         PEND                                                                   
*                                                                               
KDAY     PROC                                                                   
         SET   WAFOP,(KWRTACF.KWRTNDAY,OFF)                                     
         PEND                                                                   
*                                                                               
KNODAY   PROC                                                                   
         SET   WAFOP,KWRTACF.KWRTNDAY                                           
         PEND                                                                   
*                                                                               
KACCT    PROC                                                                   
         SET   WAFOP,KWRIFL.KWRIFAPR                                            
         CLEAR KWRPFL.KWRFPCHK                                                  
         CLEAR KWRIFL.KWRIFADM+KWRIFSUB                                         
         PEND                                                                   
*                                                                               
KNOACCT  PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFAPR,OFF)                                      
         PEND                                                                   
*                                                                               
KSPR     PROC                                                                   
         SET   WAFOP,KWRIFL.KWRIFSPR                                            
         PEND                                                                   
*                                                                               
KNOSPR   PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFSPR,OFF)                                      
         PEND                                                                   
*                                                                               
KOPR     PROC                                                                   
         SET   WAFOP,KWRIFL.KWRIFOPR                                            
         PEND                                                                   
*                                                                               
KNOOPR   PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFOPR,OFF)                                      
         PEND                                                                   
*                                                                               
KSBM     PROC                                                                   
         SET   WAFOP,KWRIFL.KWRIFSBM                                            
         PEND                                                                   
*                                                                               
KNOSBM   PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFSBM,OFF)                                      
         PEND                                                                   
*                                                                               
KADMIN   PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFSUB,OFF),KWRIFL.KWRIFADM                      
         PEND                                                                   
*                                                                               
KSUBADM  PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFADM,OFF),KWRIFL.KWRIFSUB                      
         PEND                                                                   
*                                                                               
KSUPADM  PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFADM+KWRIFSUB,OFF)                             
         PEND                                                                   
*                                                                               
KNOADMIN PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFADM+KWRIFSUB,OFF)                             
         PEND                                                                   
*                                                                               
KPC      PROC                                                                   
         SET   WAFOP,KWRIFL.KWRIFPC                                             
         PEND                                                                   
*                                                                               
KNOPC    PROC                                                                   
         SET   WAFOP,(KWRIFL.KWRIFPC,OFF)                                       
         PEND                                                                   
*                                                                               
KUCP     PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRIFL.KWRIFAPR+KWRIFSPR+KWRIFOPR+KWRIFPC                        
         CLEAR KWRIFL.KWRIFADM+KWRIFSUB                                         
         PEND                                                                   
*                                                                               
KMAIL    PROC                                                                   
         SET   WAFOP,KWROFL.KWRFMAIL                                            
         PEND                                                                   
*                                                                               
KNOMAIL  PROC                                                                   
         SET   WAFOP,(KWROFL.KWRFMAIL,OFF)                                      
         PEND                                                                   
*                                                                               
         AIF   ('&INSTALN' NE 'STANFORD').NOSOF2                                
KFUNDS   PROC                                                                   
         SET   WAFOP                                                            
         SCUPTOK R15                                                            
         IF    (R0,GT,2),'VCALL NOTVALID'                                       
*                                                                               
         IF    (@R15,GT,'9'),'VCALL NOTVALID'                                   
         IF    (@R15,LT,'0'),BEGIN                                              
         IF    ((@R15,LT,'A'),OR,(@R15,GT,'Z')),'VCALL NOTVALID'                
         END                                                                    
*                                                                               
         IF    (R0,EQ,2),BEGIN                                                  
         IF    (@R15+1,GT,'9'),'VCALL NOTVALID'                                 
         IF    (@R15+1,LT,'0'),BEGIN                                            
         IF    ((@R15+1,LT,'A'),OR,(@R15+1,GT,'Z')),'VCALL NOTVALID'            
         END                                                                    
         END                                                                    
*                                                                               
         MVC   KWRSOF(2),@R15      Funds code                                   
         CLEAR R15                                                              
         PEND                                                                   
.NOSOF2  ANOP                                                                   
*                                                                               
KSTATUS  PROC                                                                   
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         IF    (R0,NE,1),'VCALL NOTVALID'                                       
         IF    ((@R1,LE,'0'),OR,(@R1,GT,'9')),'VCALL NOTVALID'                  
         MVC   KWRSTAT,@R1                                                      
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
*                                                                               
KHOURS   PROC                                                                   
         SET   WAFOP                                                            
         L2    R15,KWRHRSAL                                                     
         MH    R15,=H'100'                                                      
         ACALL GETLNO                                                           
         FLOOR R15,0                                                            
         CLEAR R14                                                              
         D     R14,=F'100'         Convert .001 to .1                           
         STH   R15,KWRHRSAL                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KAHOURS  PROC                                                                   
         SET   WAFOP                                                            
         L2    R15,KWRACCH                                                      
         MH    R15,=H'100'                                                      
         ACALL GETLNO                                                           
         FLOOR R15,0                                                            
         CLEAR R14                                                              
         D     R14,=F'100'         Convert .001 to .1                           
         STH   R15,KWRACCH                                                      
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KUHOURS  PROC                                                                   
         SET   WAFOP                                                            
         L2    R15,KWRHRSUS                                                     
         MH    R15,=H'100'                                                      
         ACALL GETLNO                                                           
         FLOOR R15,0                                                            
         CLEAR R14                                                              
         D     R14,=F'100'         Convert .001 to .1                           
         STH   R15,KWRHRSUS                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KFHOURS  PROC                                                                   
         SET   WAFOP                                                            
         L2    R15,KWRHRSFR                                                     
         MH    R15,=H'100'                                                      
         ACALL GETLNO                                                           
         FLOOR R15,0                                                            
         CLEAR R14                                                              
         D     R14,=F'100'         Convert .001 to .1                           
         STH   R15,KWRHRSFR                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KIGNNUM  PROC  ,                  Do nothing -- compatibility                   
         SET   WAFOP                                                            
         ACALL GETNUM                                                           
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
         AIF   (NOT &BUDGET).NOBUDG2                                            
KNOBUDG  PROC                                                                   
         SET   WAFOP                                                            
         MVC   KWRBGT,=AL3(0)      Will be -1 in future                         
         PEND                                                                   
*                                                                               
KBUDGET  PROC  ,                                                                
         SET   WAFOP                                                            
         L3    R15,KWRBGT                                                       
         ACALL GETNUM                                                           
         IF    (R15,NP),'VCALL NOTVALID'                                        
         ST3   R15,KWRBGT                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KCHARGES PROC                                                                   
         SET   WAFOP                                                            
         L3    R15,KWRBAL                                                       
         ACALL GETNUM                                                           
         ST3   R15,KWRBAL                                                       
         CLEAR R15                                                              
         PEND                                                                   
.NOBUDG2 ANOP                                                                   
*                                                                               
KNOCPU   PROC                                                                   
         SET   WAFOP                                                            
         MVC   KWRLET,=H'0'        Will be -1 in future                         
         PEND                                                                   
*                                                                               
KCPU     PROC                                                                   
         SET   WAFOP                                                            
         LH    R15,KWRLET                                                       
         ACALL GETNUM                                                           
         FLOOR R15,0                                                            
         IF    (R15,Z),'VCALL NOTVALID'                                         
         STH   R15,KWRLET                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNOCARDS PROC                                                                   
         SET   WAFOP                                                            
         MVC   KWRLCP,=H'0'        Will be -1 in future                         
         PEND                                                                   
*                                                                               
KCARDS   PROC                                                                   
         SET   WAFOP                                                            
         LH    R15,KWRLCP                                                       
         FLOOR R15,0                                                            
         MH    R15,=H'100'                                                      
         ACALL GETNUM                                                           
         FLOOR R15,0                                                            
         IF    (R15,Z),'VCALL NOTVALID'                                         
         LA    R15,@R15+99                                                      
         CLEAR R14                                                              
         D     R14,=F'100'                                                      
         STH   R15,KWRLCP                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNOLINES PROC                                                                   
         SET   WAFOP                                                            
         MVC   KWRLLC,=H'0'        Will be -1 in future                         
         PEND                                                                   
*                                                                               
KLINES   PROC                                                                   
         SET   WAFOP                                                            
         LH    R15,KWRLLC                                                       
         FLOOR R15,0                                                            
         MH    R15,=H'1000'                                                     
         ACALL GETNUM                                                           
         FLOOR R15,0                                                            
         IF    (R15,Z),BEGIN       .temp                                        
         ABORT 'Specify NOLINES.'  .temp                                        
         END   ,                   .temp                                        
         LA    R15,@R15+999                                                     
         CLEAR R14                                                              
         D     R14,=A(1000)                                                     
         STH   R15,KWRLLC                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KEXPRESS PROC                                                                   
         SET   WAFOP,KWRBFL.KWRBFE  class e/f/q only                            
         PEND                                                                   
*                                                                               
KNOEXP   PROC                                                                   
         SET   WAFOP,(KWRBFL.KWRBFE,OFF)                                        
         PEND                                                                   
*                                                                               
KINT     PROC                                                                   
         SET   WAFOP,KWRAFL.KWRAFTOK                                            
         PEND                                                                   
*                                                                               
KNOINT   PROC                                                                   
         SET   WAFOP,(KWRAFL.KWRAFTOK,OFF)                                      
         PEND                                                                   
*                                                                               
KSTAT    PROC                                                                   
         SET   WAFOP,(KWRTACF.KWRTNST,OFF)                                      
         PEND                                                                   
*                                                                               
KNOSTAT  PROC                                                                   
         SET   WAFOP,KWRTACF.KWRTNST                                            
         PEND                                                                   
*                                                                               
KNOTIME  PROC                                                                   
         SET   WAFOP               Something specified                          
*                                                                               
         LH    R15,=H'-1'          Set default of -1                            
         ACALL GETCNUM             Get optional number                          
         IF    (R15,EQ,-1),BEGIN   Notime with no other options...              
         CLEAR KWRNTDEF,KWRNTMAX   No idle time limits at all                   
         SET   KWRTACF.KWRTNTM     Backward compatibility                       
         END                                                                    
*                                                                               
         ELSE  BEGIN               Notime=n or Notime=n,n....                   
         LR    R2,R15              Save default value                           
         LH    R15,=H'-1'          Set default of -1                            
         ACALL GETCNUM             Get 2nd optional number                      
         IF    (R15,EQ,-1),'LR R15,R2'  Max and default are the same            
         CEIL  R2,R15              Default can't be > max                       
         STH   R2,KWRNTDEF         Save default                                 
         STH   R15,KWRNTMAX        Save maximum                                 
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSECURE  PROC                                                                   
         SET   WAFOP,KWROFL.KWRFSEC                                             
         PEND                                                                   
*                                                                               
KNOSEC   PROC                                                                   
         SET   WAFOP,(KWROFL.KWRFSEC,OFF)                                       
         PEND                                                                   
*                                                                               
KBATCH   PROC                                                                   
         SET   WAFOP,KWRBFL.KWRBFVAL                                            
         PEND                                                                   
*                                                                               
KNOBATCH PROC                                                                   
         SET   WAFOP,(KWRBFL.KWRBFVAL,OFF)                                      
         PEND                                                                   
*                                                                               
KPRIO    PROC                                                                   
         SET   WAFOP,(KWRBFL.KWRBFNON,OFF)                                      
         PEND                                                                   
*                                                                               
KNOPRIO  PROC                                                                   
         SET   WAFOP,KWRBFL.KWRBFNON                                            
         PEND                                                                   
*                                                                               
KPROD    PROC                                                                   
         SET   WAFOP,KWRBFL.KWRBFP                                              
         PEND                                                                   
*                                                                               
KNOPROD  PROC                                                                   
         SET   WAFOP,(KWRBFL.KWRBFP,OFF)                                        
         PEND                                                                   
*                                                                               
KSETUP   PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRBFL.KWRBFIN                                                   
         PEND                                                                   
*                                                                               
KNOSET   PROC                                                                   
         SET   WAFOP,KWRBFL.KWRBFIN                                             
         PEND                                                                   
*                                                                               
KPSETUP  PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRBFL.KWRBFOUT                                                  
         PEND                                                                   
*                                                                               
KNOPSET  PROC                                                                   
         SET   WAFOP,KWRBFL.KWRBFOUT                                            
         PEND                                                                   
*                                                                               
KNOSPACE PROC                                                                   
         SET   WAFOP                                                            
         MVC   KWRSPMAX,=H'-1'                                                  
         PEND                                                                   
*                                                                               
KSPACE   PROC                                                                   
         SET   WAFOP                                                            
         LH    R15,KWRSPMAX                                                     
         FLOOR R15,0                                                            
         ACALL GETNUM                                                           
         FLOOR R15,0                                                            
         IF    (R15,GT,32767),'LH R15,=H"-1"'                                   
         STH   R15,KWRSPMAX                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KASPACE  PROC                                                                   
         SET   WAFOP                                                            
         LH    R15,KWRSPUSD                                                     
         ACALL GETNUM                                                           
         FLOOR R15,0                                                            
         IF    (R15,GT,32767),'LH R15,=H"-1"'                                   
         STH   R15,KWRSPUSD                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KPASS    PROC                                                                   
         VCALL DEQUOTE             De-quote, if quoted                          
         IF    (R0,GT,L'KWRPASS),'VCALL NOTVALID'                               
         SET   WAFOP                                                            
         MVC   KWRPASS,CVBLANKS                                                 
         LR    R15,R0                                                           
*                                                                               
         IF    (R15,LT,5),BEGIN    Too short...                                 
         IF    (CPSFAPR,AND,(CPSGRP,EQ,'GG')),EXIT  Allow for some              
         TSEG  'Password must be at least 5 characters long. '                  
         TSEG  'No action taken.'                                               
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         MOVE  R15,KWRPASS,@R1     Save password                                
*-                                                                              
*-       Convert to upper case if uplow passwords are not allowed.              
*-                                                                              
         AIF   (&KEYUPLO).KPUPLOW                                               
         L     R15,CVUPPTBL                                                     
         TR    KWRPASS,@R15                                                     
.KPUPLOW ANOP                                                                   
*                                                                               
         STCK  @R13                                                             
         MVC   KWRKTIM,@R13        Set password change time                     
         SET   WAFUPDPW            Remember we updated the password             
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KVOL     PROC                                                                   
         IF    (R0,GT,6),'VCALL NOTVALID'                                       
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         MVC   KWRVOL,@R1                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNOVOL   PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRVOL                                                           
         PEND                                                                   
*                                                                               
KNETU    PROC                                                                   
         IF    (R0,GT,L'KWRNETU),'VCALL NOTVALID'                               
         SET   WAFOP                                                            
         SCUPCASE KWRNETU                                                       
*                                                                               
         IF    (KWRNETH,Z),'MVC KWRNETH,=CL(L"KWRNETH)"LINDY"'                  
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNONETU  PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRNETU                                                          
         PEND                                                                   
*                                                                               
KNETH    PROC                                                                   
         IF    (R0,GT,L'KWRNETH),'VCALL NOTVALID'                               
         SET   WAFOP                                                            
         SCUPCASE KWRNETH                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNONETH  PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRNETH                                                          
         PEND                                                                   
*                                                                               
KCREATE  PROC                                                                   
         SET   WAFOP,WAFCRE                                                     
         PEND                                                                   
*                                                                               
KDELETE  PROC                                                                   
         SET   WAFDEL                                                           
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
*                                                                               
         QLTORG                                                                 
*                                                                               
         PUSH  NOGEN                                                            
DEFKWR   KWR   PFX=DEF                                                          
         POP   PRINT                                                            
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SHOWMAST -- SHOW MASTER command.  (Priv'd)                                   
*                                                                               
SHOWMAST XPROC WA                                                               
*                                                                               
         CLEAR WA                                                               
         LA    R5,WA                                                            
         USING WA,R5                                                            
*                                                                               
         LA    R0,1                No password prompt                           
         ACALL GETAENT                                                          
*                                                                               
         IF    (CPSFAPR+CPSFADM+CPSFSUB,Z),BEGIN                                
         LA    R0,SMFWMAST         Attempted show master                        
         VCALL LOGKWR              Log attempt                                  
         VCALL NOTVALID                                                         
         END                                                                    
*-                                                                              
*-       Special RLIN group code check.                                         
*-                                                                              
         IF    (KWRGRP,NE,CPSGRP),BEGIN                                         
         IF    (CPSFAPR+CPSFADM,Z),'ACALL BADAGRP'  No match, scram             
         IF    (((KWRGRP,EQ,'B'),OR,(KWRGRP,EQ,'Y'),OR,                *        
               (KWRGRP,EQ,'Z'),OR,                                     *        
               (KWRGRP,EQ,'DQ'),OR,                                    *        
               (KWRGRP,EQ,'HH'),OR,(KWRGRP,EQ,'HN')),AND,              *        
               (CPSGRP,EQ,'B')),EXIT                                            
         IF    ^CPSFAPR,'ACALL BADAGRP'                                         
         END                                                                    
*-                                                                              
*-       Special HOSPITAL (SYSC) group code check.                              
*-                                                                              
         IF    ((CPSGRP,EQ,'CV'),OR,(CPSGRP,EQ,'C1')),BEGIN                     
         IF    (KWRGRP,EQ,'CV'),EXIT                                            
         IF    (KWRGRP,EQ,'C1'),EXIT                                            
         ACALL BADAGRP                                                          
         END                                                                    
*-                                                                              
*-       The first character of the user-id must match for SUBADMIN.            
*-                                                                              
         IF    CPSFSUB,BEGIN       SUBADMIN privs...                            
         IF    ('CLC KWRUSER(1),CPSUSER',NE),'ACALL BADAGRP'                    
         END                                                                    
*                                                                               
         SCAN  SMASTPRT                                                         
         SCANCHK                                                                
*                                                                               
         IF    WAFDHEX,BEGIN       Hex format...                                
         MVC   KWRPASS,=(L'KWRPASS)X'FF'  Wipe the password */                  
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER                                                          
         TSEG  ':',,WR                                                          
         BNZ   SMASTFIN                                                         
         LA    R4,KWR                                                           
         LA    R3,KWREND-KWR                                                    
         LOOP  BEGIN                                                            
         LA    R15,KWREND-KWR                                                   
         SR    R15,R3                                                           
         BTX   CPDOUB,3,(R15)                                                   
         TSEG  (R1),(R0)                                                        
         TSEG  CVBLANKS,2                                                       
         LA    R15,14                                                           
         SETMSG (R4),(R3)                                                       
         CEIL  R0,32                                                            
         VCALL HEXFMT                                                           
         BNZ   SMASTFIN                                                         
         LA    R4,@R4+32                                                        
         SH    R3,=H'32'                                                        
         UNTIL ^POS,END                                                         
         B     SMASTFIN                                                         
         END                                                                    
*                                                                               
         LA    R1,KWR                                                           
         ACALL MASTDISP                                                         
*                                                                               
SMASTFIN LA    R0,SMFWMAST+SMFWAUTH                                             
         VCALL LOGKWR              Write SMF log record                         
*                                                                               
         CLEAR KWR                                                              
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
*                                                                               
*                                                                               
SMASTPRT SCKW  HEX,SMASTHEX                                                     
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SMASTHEX PROC                                                                   
         SET   WAFDHEX             Display record in hex                        
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  MASTDISP -- Routine to display all account options.                          
*                                                                               
*    On entry:                                                                  
*      R1 - KWR ptr                                                             
*                                                                               
MASTDISP PROC                                                                   
         BASE  MASTDISP+4000,R4                                                 
         LR    R5,R1               KWR ptr                                      
         USING KWR,R5                                                           
*                                                                               
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER,,B                                                       
         IF    (KWRNAME,NZ),BEGIN                                               
         TSEG  '"'                                                              
         TSEG  KWRNAME,,T                                                       
         TSEG  '" '                                                             
         END                                                                    
         IF    (KWRCOMM,NZ),'TSEG "["; TSEG KWRCOMM,,T; TSEG "] "'              
         IF    (KWRUSER,EQ,'PUB'),'TSEG "(Template account) "'                  
         IF    KWROFL.KWRFMULT,BEGIN                                            
         SETMSG '(Multiple) '                                                   
         IF    KWROFL.KWRFMNPR,'SETMSG "(XMultiple) "'                          
         TSEG  (R1),(R0)                                                        
         END                                                                    
         IF    KWRIFL.KWRIFPC,'TSEG "(PC) "'                                    
         IF    KWRIFL.KWRIFSUB,'TSEG "(Subadmin) "'                             
         IF    KWRIFL.KWRIFADM,'TSEG "(Admin) "'                                
         IF    CPSFAPR,BEGIN                                                    
         IF    KWRIFL.KWRIFSPR,'TSEG "(Sys) "'                                  
         IF    KWRIFL.KWRIFAPR,'TSEG "(Acct) "'                                 
         IF    KWRIFL.KWRIFOPR,'TSEG "(Opr) "'                                  
         IF    KWRIFL.KWRIFSBM,'TSEG "(Submit) "'                               
         END                                                                    
         IF    ^KWRAFL.KWRAFVAL,'TSEG " ** Suspended ** "'                      
         TCR                                                                    
         IF    ^KWRIFL.KWRIFVAL,MASTEXIT  (Don't show options if del)           
         IF    CPFQUIET,MASTEXIT   (For SET MASTER...QUIET)                     
*                                                                               
*                                                                               
         IF    KWROFL.KWRFNPAS,BEGIN  No logon password needed...               
         TSEG  CVBLANKS,2                                                       
         TSEG  'No logon password needed.',,CR                                  
         END                                                                    
*                                                                               
*                                                                               
         TSEG  CVBLANKS,2                                                       
         TSEG  'Primary machine is'                                             
         LA    R1,KWRMPRIM                                                      
         ACALL SEGMACH                                                          
         TSEG  ', machine access allowed for'                                   
         LA    R1,KWRMACC                                                       
         ACALL SEGMACH                                                          
         TCCR                                                                   
*                                                                               
*                                                                               
         CLEAR R2                  Nothing output yet ...                       
         AIF   ('&INSTALN' NE 'STANFORD').NOSOF3                                
         LA    R2,4                                                             
         TSEG  '  Funds='                                                       
         SETMSG KWRSOF                                                          
         IF    ((KWRSOF,Z),OR,(KWRSOF,EQ,' ')),'SETMSG "?"'                     
         TSEG  (R1),(R0)                                                        
         IF    ((KWRAR,NZ),AND,(KWRAR,NE,' ')),'TSEG KWRAR'                     
*                                                                               
         CLEAR R0                                                               
         IF    (KWRSOF,EQ,'1'),'SETMSG  " (Library)"'                           
         IF    (KWRSOF,EQ,'2'),'SETMSG  " (Accts Receivable)"'                  
         IF    (KWRSOF,EQ,'3'),'SETMSG  " (Govt Sponsored)"'                    
         IF    (KWRSOF,EQ,'4'),'SETMSG  " (Departmental)"'                      
         IF    (KWRSOF,EQ,'5'),'SETMSG  " (Unsponsored Research)"'              
         IF    (KWRSOF,EQ,'6'),'SETMSG  " (Instructional)"'                     
         IF    (KWRSOF,EQ,'7'),'SETMSG  " (Med Ctr/Hosp/FPP)"'                  
         IF    (KWRSOF,EQ,'8'),'SETMSG  " (Overhead)"'                          
         IF    (KWRSOF,EQ,'9'),'SETMSG  " (University Admin)"'                  
         IF    (KWRSOF,EQ,'A'),'SETMSG  " (Internal Systems)"'                  
         IF    (KWRSOF,EQ,'B'),'SETMSG  " (Data Center staff)"'                 
         IF    (KWRSOF,EQ,'C'),'SETMSG  " (Core)"'                              
         IF    (KWRSOF,EQ,'CA'),'SETMSG " (Core/Class)"'                        
         TSEG  (R1),(R0)                                                        
.NOSOF3  ANOP                                                                   
*                                                                               
         IF    ((KWRSTAT,NZ),AND,(KWRSTAT,NE,' ')),BEGIN                        
         IF    (R2,Z),BEGIN        Nothing on this line yet ...                 
         LA    R2,4                But now there is                             
         TSEG  '  '                Indent it                                    
         END   ELSE,BEGIN                                                       
         TSEG  ', '                Need a comma                                 
         END                                                                    
         TSEG  'status='                                                        
         TSEG  KWRSTAT                                                          
         CLEAR R0                                                               
         IF    (KWRSTAT,EQ,'1'),'SETMSG " (Expired)"'                           
         IF    (KWRSTAT,EQ,'2'),'SETMSG " (Closed)"'                            
         IF    (KWRSTAT,EQ,'3'),'SETMSG " (Over budget)"'                       
         IF    (KWRSTAT,EQ,'4'),'SETMSG " (User hold)"'                         
         TSEG  (R1),(R0)                                                        
         END                                                                    
*                                                                               
         IF    (R2,NZ),'TCR'                                                    
*                                                                               
         AIF   (NOT &BUDGET).NOBUDG4                                            
         TSEG  CVBLANKS,2                                                       
         IF    ('L3 R15,KWRBGT',Z),'TSEG "No"'                                  
         ELSE  'ACALL SEGXDOL'                                                  
         TSEG  ' budget'                                                        
         IF    (KWRBAL,NZ),BEGIN                                                
         TSEG  ' ('                                                             
         L3    R15,KWRMTD                                                       
         ACALL SEGXDOL                                                          
         TSEG  ' MTD,',,B                                                       
         L3    R15,KWRBAL                                                       
         ACALL SEGXDOL                                                          
         TSEG  ' YTD)'                                                          
         END                                                                    
.NOBUDG4 ANOP                                                                   
*                                                                               
         AIF   (NOT &SPACE).SPACE3                                              
         TSEG  ', '                Indent                                       
         SETMSG 'No space limit'                                                
         IF    ('LTH R2,KWRSPMAX',^NEG),BEGIN                                   
         TSEG  'Space='                                                         
         TNUM  (R2)                                                             
         SETMSG ' tracks'                                                       
         END                                                                    
         TSEG  (R1),(R0)                                                        
         IF    ('LTH R2,KWRSPUSD',POS),BEGIN                                    
         TSEG  ' ('                                                             
         TNUM  (R2)                                                             
         TSEG  ' tracks accounted)'                                             
         END                                                                    
.SPACE3  ANOP                                                                   
         TCCR                                                                   
*                                                                               
         SETMSG CVBLANKS,1                                                      
         IF    (KWRDEST,NZ),BEGIN                                               
         TSEG  (R1),(R0)                                                        
         TSEG  ' Dest='                                                         
         TSEG  KWRDEST,,T                                                       
         SETMSG ','                                                             
         END                                                                    
         IF    (KWRFORM,NZ),BEGIN                                               
         TSEG  (R1),(R0)                                                        
         TSEG  ' Forms='                                                        
         TSEG  KWRFORM                                                          
         SETMSG ','                                                             
         END                                                                    
         IF    (KWRBIN,NZ),BEGIN                                                
         TSEG  (R1),(R0)                                                        
         TSEG  ' Bin='                                                          
         TSEG  KWRBIN                                                           
         END                                                                    
         TCCR                                                                   
*                                                                               
*                                                                               
         TSEG  CVBLANKS,2                                                       
         SETMSG 'No volume'                                                     
         IF    (KWRVOL,NZ),BEGIN                                                
         TSEG  'Volume='                                                        
         SETMSG KWRVOL                                                          
         END                                                                    
         TSEG  (R1),(R0),T                                                      
*                                                                               
         SETMSG ', No mail allowed'                                             
         IF    KWROFL.KWRFMAIL,'SETMSG ", Mail is allowed"'                     
         TSEG  (R1),(R0)                                                        
*                                                                               
*                                                                               
         IF    (KWRNETU,NZ),BEGIN                                               
         TSEG  ', Network user='                                                
         TSEG  KWRNETU,,T                                                       
         END                                                                    
         ELSE  'TSEG ", No network user id"'                                    
*                                                                               
         IF    (KWRNETH,NZ),BEGIN                                               
         TSEG  ', Network host='                                                
         TSEG  KWRNETH,,T                                                       
         END                                                                    
         TCCR                                                                   
*                                                                               
*                                                                               
         SETMSG CVBLANKS,1                                                      
         IF    ('LTH R2,KWRHRSAL',NZ),BEGIN                                     
         TSEG  (R1),(R0)                                                        
         TSEG  ' Hours='                                                        
         LR    R0,R2                                                            
         MH    R0,=H'100'                                                       
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ' allowed ('                                                     
         L2    R0,KWRHRSUS         Hours used                                   
         MH    R0,=H'100'                                                       
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ' used'                                                          
         IF    ('L2 R2,KWRHRSFR',NZ),BEGIN                                      
         TSEG  ',',,B                                                           
         LR    R0,R2                                                            
         MH    R0,=H'100'                                                       
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ' free'                                                          
         END                                                                    
         IF    ('L2 R2,KWRACCH',NZ),BEGIN                                       
         TSEG  ',',,B                                                           
         LR    R0,R2                                                            
         MH    R0,=H'100'                                                       
         VCALL CVEXNO                                                           
         TSEG  (R1),(R0)                                                        
         TSEG  ' accounted'                                                     
         END                                                                    
         TSEG  ')'                                                              
         SETMSG ','                                                             
         END                                                                    
         TCCR                                                                   
*                                                                               
         SETMSG '  BATCH limits:'                                               
         IF    ('LTH R2,KWRLET',NZ),BEGIN                                       
         TSEG  (R1),(R0),B                                                      
         TSEG  'CPU='                                                           
         BTD   CPDOUB,0,(R2)                                                    
         TSEG  (R1),(R0),B                                                      
         TSEG  'seconds'                                                        
         SETMSG ','                                                             
         END                                                                    
         IF    ('LTH R2,KWRLCP',NZ),BEGIN                                       
         TSEG  (R1),(R0),B                                                      
         TSEG  'Cards='                                                         
         MH    R2,=H'100'                                                       
         BTD   CPDOUB,0,(R2)                                                    
         TSEG  (R1),(R0)                                                        
         SETMSG ','                                                             
         END                                                                    
         IF    ('LTH R2,KWRLLC',NZ),BEGIN                                       
         TSEG  (R1),(R0),B                                                      
         TSEG  'Lines='                                                         
         MH    R2,=H'1000'                                                      
         BTD   CPDOUB,0,(R2)                                                    
         TSEG  (R1),(R0)                                                        
         END                                                                    
         TCCR                                                                   
*-                                                                              
*-       Interactive usage limits.                                              
*-                                                                              
         TSEG  CVBLANKS,1                                                       
         TSEG  ' Notime limits='                                                
         TNUM  LH:KWRNTDEF                                                      
         TSEG  ','                                                              
         TNUM  LH:KWRNTMAX                                                      
*                                                                               
         SETMSG CVBLANKS,1                                                      
         IF    ^KWRBFL.KWRBFVAL,BEGIN                                           
         TSEG  (R1),(R0),B                                                      
         TSEG  'No batch allowed'                                               
         SETMSG ','                                                             
         END                                                                    
*                                                                               
         IF    ^KWRAFL.KWRAFTOK,BEGIN                                           
         TSEG  (R1),(R0),B                                                      
         TSEG  'No interactive sessions allowed'                                
         SETMSG ','                                                             
         END                                                                    
*                                                                               
         IF    KWRTACF.KWRTNST,BEGIN                                            
         TSEG  (R1),(R0),B                                                      
         TSEG  'No Logoff cost statistics'                                      
         SETMSG ','                                                             
         END                                                                    
*                                                                               
         IF    KWROFL.KWRFSEC,BEGIN                                             
         TSEG  (R1),(R0),B                                                      
         TSEG  'Secure logon EXEC'                                              
         SETMSG ','                                                             
         END                                                                    
*                                                                               
         IF    KWRBFL.KWRBFE,BEGIN                                              
         TSEG  (R1),(R0),B                                                      
         TSEG  'CLASS=E jobs only'                                              
         SETMSG ','                                                             
         END                                                                    
         IF    KWRTACF.KWRTNDAY,BEGIN                                           
         TSEG  (R1),(R0),B                                                      
         TSEG  'No daytime sessions allowed'                                    
         SETMSG ','                                                             
         END                                                                    
         TCCR                                                                   
*                                                                               
         SETMSG CVBLANKS,1                                                      
         IF    KWRBFL.KWRBFNON,BEGIN                                            
         TSEG  (R1),(R0),B                                                      
         TSEG  'No priority'                                                    
         SETMSG ','                                                             
         END                                                                    
         IF    KWRBFL.KWRBFIN+KWRBFOUT,BEGIN                                    
         TSEG  (R1),(R0),B                                                      
         TSEG  'No',,B                                                          
         SETMSG 'input '                                                        
         IF    KWRBFL.KWRBFOUT,'SETMSG "output "'                               
         IF    KWRBFL.KWRBFIN*KWRBFOUT,'CLEAR R0'                               
         TSEG  (R1),(R0)                                                        
         TSEG  'setup allowed'                                                  
         END                                                                    
         TCCR                                                                   
*                                                                               
         HASPSERV USERTYPE,KWRUSER                                              
         IF    (R15,Z),BEGIN                                                    
         STC   R0,CPDOUB           User type                                    
         SETMSG CVBLANKS,1                                                      
         IF    CPDOUB.$USOPEN,BEGIN  Open shop...                               
         IF    ^KWRBFL.KWRBFP,EXIT                                              
         TSEG  (R1),(R0),B                                                      
         TSEG  'CLASS=P allowed'                                                
         SETMSG ','                                                             
         END                                                                    
         ELSE  BEGIN                                                            
         IF    KWRBFL.KWRBFP,EXIT                                               
         TSEG  (R1),(R0),B                                                      
         TSEG  'CLASS=P NOT allowed'                                            
         SETMSG ','                                                             
         END                                                                    
         END                                                                    
         TCCR                                                                   
*                                                                               
         TSEG  '  Creation date: '                                              
         IF    ('L4 R0,KWRCRDT',NZ),BEGIN                                       
         CLEAR R1                                                               
         XPUSH ,,64,PTR=R15                                                     
         VCALL FMTXDATE                                                         
         TSEG  (R1),(R0)                                                        
         XPOP  ,,64                                                             
         END   ELSE,'TSEG "Not available"'                                      
         TCCR                                                                   
MASTEXIT LABEL ,                                                                
         PEND                                                                   
         DROP  R4,KWR                                                           
*                                                                               
         QLTORG                                                                 
         TITLE 'Local Subroutines'                                              
*******************************************************************             
**                                                                              
**   Subroutine base.  All routines below here assume that R6                   
**      is pointing to KWBASE.                                                  
**                                                                              
*******************************************************************             
         SPACE 2                                                                
*box                                                                            
*                                                                               
*  GETAENT -- Routine to scan account and read kw entry                         
*                                                                               
*     On entry:                                                                 
*         R0 - options for GETKWR routine                                       
*         R5 - WA ptr                                                           
*                                                                               
*                                                                               
GETAENT  PROC  ,                                                                
         USING WA,R5                                                            
         LR    R4,R0               Save getkwr options                          
         CLEAR WA                                                               
*                                                                               
         COMMENT                   Scan for optional account                    
         SCAN  GETAPRT                                                          
         SCANCHK                                                                
         IF    (R15,EQ,8),BEGIN                                                 
         SCBKUP                                                                 
         END                                                                    
         CLEAR R15                                                              
*                                                                               
         COMMENT                   Process account                              
         IF    (CPCUSER,Z),'ERROR "Account not specified.",,NOACCT'             
         IF    (CPCGRP,Z),'MVC CPCGRP,CPSGRP'                                   
         MVC   KWRGRP,CPCGRP                                                    
         MVC   KWRUSER,CPCUSER                                                  
         LR    R0,R4                                                            
         LA    R1,KWR                                                           
         ACALL GETKWR                                                           
         PEND                                                                   
*                                                                               
*                                                                               
GETAPRT  SCKW  ,V(ACCTPSHC),PUSH                                                
         SCKW  ,GOTACCT,V(MATUID)                                               
         SCKW  ,NOTACCT                                                         
*                                                                               
GOTACCT  PROC  ,                   MATUID FILLS IN CPCACCT IF MATCH             
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
NOTACCT  PROC  ,                                                                
         LA    R15,8                                                            
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  PUTKWR -- Routine to re-write KWR entry.                                     
*                                                                               
PUTKWR   PROC                                                                   
         KWRITE KWR                                                             
         CLEAR R15                                                              
         IF    ^KWRHFL.KWRHFUOK,BEGIN  update didn't work...                    
         IF    KWRHFL.KWRHFFUL,BEGIN                                            
         ABORT 'Account File is full, new account not created.'                 
         END                                                                    
         IF    KWRHFL.KWRHFERR,BEGIN                                            
         TSEG  'I/O error in account file, retrying...',,WR                     
         BNZ   CVABORT                                                          
         END                                                                    
         LA    R15,4                                                            
         END                                                                    
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SEGACCT -- Routine to seg the account in the KWR, if it is                   
*    not that of the logged on user's.                                          
*                                                                               
SEGACCT  PROC                                                                   
         IF    ((KWRGRP,NE,CPSGRP),OR,(KWRUSER,NE,CPSUSER)),BEGIN               
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER,,B                                                       
         TSEG  '-',,B                                                           
         END                                                                    
         PEND                                                                   
         EJECT                                                                  
*                                                                               
*  BAD ACCOUNT ERROR , NO RETURN                                                
*                                                                               
BADACCT  PROC                                                                   
         TSEG  'Account',,B                                                     
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER,,B                                                       
         ERROR 'does not exist.',,BADACCT                                       
         PEND                                                                   
*                                                                               
*  BAD GROUP ERROR, NO RETURN                                                   
*                                                                               
BADAGRP  PROC                                                                   
         TSEG  'Account',,B                                                     
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER,,B                                                       
         ABORT 'is not in your group.'                                          
         PEND                                                                   
         EJECT                                                                  
**                                                                              
**  Common Scan Options                                                         
**                                                                              
KNAME    PROC                                                                   
         SET   WAFOP                                                            
         VCALL DEQUOTE                                                          
         IF    NEG,BEGIN                                                        
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid; quotes required.'                                    
         END                                                                    
         IF    Z,'CLEAR KWRNAME'                                                
         ELSE  BEGIN                                                            
         MVC   KWRNAME,CVBLANKS                                                 
         LR    R15,R0                                                           
         CEIL  R15,L'KWRNAME                                                    
         MOVE  R15,KWRNAME,@R1                                                  
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KCOMM    PROC                                                                   
         SET   WAFOP                                                            
         VCALL DEQUOTE                                                          
         IF    NEG,BEGIN                                                        
         TSEG  (R1),(R0)                                                        
         ERROR ': invalid; quotes required.'                                    
         END                                                                    
         IF    Z,'CLEAR KWRCOMM'                                                
         ELSE  BEGIN                                                            
         MVC   KWRCOMM,CVBLANKS                                                 
         LR    R15,R0                                                           
         CEIL  R15,L'KWRCOMM                                                    
         MOVE  R15,KWRCOMM,@R1                                                  
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KDEST    PROC                                                                   
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"')),'VCALL NOTVALID'                 
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         MVC   KWRDEST,@R1                                                      
         LA    R1,KWRDEST                                                       
         VCALL DESTVER                                                          
         PEND                                                                   
*                                                                               
KFORMS   PROC                                                                   
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"')),'VCALL NOTVALID'                 
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         MVC   KWRFORM,@R1                                                      
         IF    (KWRFORM,EQ,'SEL'),BEGIN                                         
         TSEG  'SELF is not a forms code.',,B                                   
         ERROR 'Use DEST=SELF for the self-service printer.'                    
         END                                                                    
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KPFORMS  PROC                                                                   
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"')),'VCALL NOTVALID'                 
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         MVC   KWRPFORM,@R1                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KPNOFORM PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRPFORM                                                         
         PEND                                                                   
*                                                                               
KBIN     PROC                                                                   
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"')),'VCALL NOTVALID'                 
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         MVC   KWRBIN,@R1                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KSYS     PROC                                                                   
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"')),'VCALL NOTVALID'                 
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         MVC   KWRSYS,@R1                                                       
         IF    (KWRSYS,EQ,'WYLBUR  '),'CLEAR KWRSYS'                            
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNOSYS   PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRSYS                                                           
         PEND                                                                   
*                                                                               
KORV     PROC                                                                   
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"')),'VCALL NOTVALID'                 
         SET   WAFOP                                                            
         SCUPTOK R1                                                             
         MVC   KWRORV,@R1                                                       
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KCMD     PROC                                                                   
         VCALL DEQUOTE                                                          
         SET   WAFOP                                                            
         MVC   KWRCMD,CVBLANKS                                                  
         LR    R15,R0                                                           
         CEIL  R15,L'KWRCMD                                                     
         MOVE  R15,KWRCMD,@R1                                                   
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
KNOCMD   PROC                                                                   
         SET   WAFOP                                                            
         CLEAR KWRCMD                                                           
         PEND                                                                   
*                                                                               
KMULT    PROC                                                                   
         SET   WAFOP,KWROFL.KWRFMULT                                            
         SET   (KWROFL.KWRFMNPR,OFF)                                            
         PEND                                                                   
*                                                                               
KXMULT   PROC                                                                   
         SET   WAFOP,KWROFL.KWRFMULT+KWRFMNPR                                   
         PEND                                                                   
*                                                                               
KNOMULT  PROC                                                                   
         SET   WAFOP,(KWROFL.KWRFMULT+KWRFMNPR,OFF)                             
         PEND                                                                   
*                                                                               
         DROP  WA                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SEGMACH -- Routine to seg the machines specified by the                      
*    flag byte passed as a parameter.                                           
*                                                                               
*    On entry:                                                                  
*      R1 - ptr to machine flag byte                                            
*                                                                               
*    On exit:                                                                   
*      Machine id tseg'd                                                        
*                                                                               
SEGMACH  PROC                                                                   
         LR    R2,R1               Flag byte ptr                                
*                                                                               
*        IF    @R2.KWRFSYSG,' XWTO "SEGMACH flag SYSG"' * slp debug *           
*        ELSE  ' XWTO "SEGMACH flag no SYSG"'           * slp debug *           
         IF    (@R2,EQ,X'00'),BEGIN  No machines...                             
         TSEG  ' NONE'                                                          
         END                                                                    
*                                                                               
         ELSE  BEGIN               Show appropriate machines...                 
         IF    @R2.KWRFSYSA,' TSEG " SYSA"'                                     
         IF    @R2.KWRFSYSB,' TSEG " SYSB"'                                     
         IF    @R2.KWRFSYSC,' TSEG " SYSC"'                                     
         IF    @R2.KWRFSYSD,' TSEG " SYSD"'                                     
         IF    @R2.KWRFSYSE,' TSEG " SYSH"'                                     
         IF    @R2.KWRFSYSF,' TSEG " SYSF"'                                     
         IF    @R2.KWRFSYSG,' TSEG " SYSG"'                                     
         END                                                                    
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  GETNUM/GETNUM -- Routine to get number, even if it is relative               
*        to the old value (e.g., +n or -n).                                     
*                                                                               
*    On entry:                                                                  
*      R15 - previous value                                                     
*                                                                               
*    On exit:                                                                   
*      R15 - new value                                                          
*                                                                               
*                                                                               
*                                                                               
*  GETNUM - integer number version                                              
*                                                                               
GETNUM   PROC                                                                   
         LR    R3,R15                                                           
         SCAN  RELPRT                                                           
         SCANCHK                                                                
         LR    R15,R3                                                           
         PEND                                                                   
*                                                                               
*                                                                               
*  GETLNO - line number version                                                 
*                                                                               
GETLNO   PROC                                                                   
         LR    R3,R15                                                           
         SCAN  RELLPRT                                                          
         SCANCHK                                                                
         LR    R15,R3                                                           
         PEND                                                                   
*                                                                               
*                                                                               
*                                                                               
RELPRT   SCKW  ,RELNULL,NULL                                                    
         SCKW  +,RELPLUS,(P,I)                                                  
         SCKW  -,RELMINUS,(P,I)                                                 
         SCKW  ,RELVAL,I                                                        
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
RELLPRT  SCKW  ,RELNULL,NULL                                                    
         SCKW  +,RELPLUS,(P,LN)                                                 
         SCKW  -,RELMINUS,(P,LN)                                                
         SCKW  ,RELVAL,LN                                                       
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
RELNULL  PROC                                                                   
         ERROR 'Missing operand.'                                               
         PEND                                                                   
*                                                                               
RELPLUS  PROC                                                                   
         AR    R3,R0                                                            
         PRETURN (R3)                                                           
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
RELMINUS PROC                                                                   
         SR    R3,R0                                                            
         PRETURN (R3)                                                           
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
RELVAL   PROC                                                                   
         LR    R3,R0                                                            
         PRETURN (R3)                                                           
         LA    R15,4                                                            
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  GETCNUM -- Routine to get an optional number.  If the next                   
*    parameter is numeric then return that, otherwise return the                
*    default value.                                                             
*                                                                               
*    On entry:                                                                  
*      R15 - default value                                                      
*                                                                               
*    On exit:                                                                   
*      R15 - new value                                                          
*                                                                               
GETCWA   RECORD BEGIN                                                           
GETCSAVE DS    XL(L'NSCNCB)                                                     
         END                                                                    
*                                                                               
*                                                                               
GETCNUM  PROC  GETCWA                                                           
         SCSAVE AREA=GETCSAVE                                                   
         LR    R3,R15              Save default value                           
         SCAN  ,                   Pick off possible number                     
         SCANCHK                                                                
         IF    (R0,Z),BEGIN        None, use default                            
         LR    R15,R3                                                           
         END                                                                    
         ELSE  BEGIN               If, something                                
         DTB   (R1),(R0)           Try to convert to number                     
         IF    NZ,BEGIN            Not a number, use default                    
         SCRSTR AREA=GETCSAVE                                                   
         LR    R15,R3                                                           
         END                                                                    
         COMMENT                   Is number, r15 - is number                   
         END                                                                    
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         TITLE 'Subroutines'                                                    
*box                                                                            
*                                                                               
*  GETKWR -- Routine to read password record and prompt for                     
*    password.                                                                  
*                                                                               
*    On entry:                                                                  
*      R1 - KWR ptr                                                             
*      R0 - -2 = account must exist, password MUST be given                     
*           -1 = account must exist, prompt for kw--if not acct priv            
*            0 = account must exist, prompt for password                        
*            1 = account must exist, no prompt for password                     
*            2 = account might exist, no prompt for password                    
*                                                                               
GETKWR   XPROC                                                                  
         LR    R5,R0               Code                                         
         LR    R6,R1               Kwr  (with acct filled in)                   
         USING KWR,R6                                                           
         KREAD KWR                                                              
         IF    ^KWRHFL.KWRHFCK,BEGIN                                            
         TSEG  'No account file.  '                                             
         ABORT 'This command can''t be executed.',,NOKWFILE                     
         END                                                                    
         IF    ^KWRIFL.KWRIFVAL,BEGIN                                           
         IF    (R5,EQ,2),GETKEXIT                                               
         TSEG  'Account',,B                                                     
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER,,B                                                       
         ERROR 'does not exist.',,BADACCT                                       
         END                                                                    
*                                                                               
         IF    (R5,NP),BEGIN       Check password...                            
         IF    ((CPSUSER,EQ,KWRUSER),AND,(CPSGRP,EQ,KWRGRP)),EXIT               
*                                                                               
         IF    (R5,EQ,-2),GETKCHK  No special bypass checks                     
*                                                                               
         IF    (CPGFLG3.CPFKWENT,AND,                                  *        
               (CPUSERSV,EQ,KWRUSER),AND,(CPGRPSV,EQ,KWRGRP)),EXIT              
*                                                                               
         IF    (R5,NEG),BEGIN      Allow accounting privs...                    
         IF    CPSFAPR,GETKEXIT                                                 
*                                                                               
         IF    (CPSFADM+CPSFSUB,Z),EXIT                                         
*                                                                               
         IF    (CPSFSUB,AND,('CLC KWRUSER(1),CPSUSER',NE)),EXIT                 
*                                                                               
         IF    (CPSGRP,EQ,KWRGRP),GETKEXIT                                      
         IF    CPSFSUB,EXIT        SUBADMIN and different groups                
         IF    (((KWRGRP,EQ,'B'),OR,(KWRGRP,EQ,'Y'),OR,                *        
               (KWRGRP,EQ,'Z'),OR,                                     *        
               (KWRGRP,EQ,'DQ'),OR,                                    *        
               (KWRGRP,EQ,'HH'),OR,(KWRGRP,EQ,'HN')),AND,              *        
               (CPSGRP,EQ,'B')),GETKEXIT                                        
         END                                                                    
*                                                                               
GETKCHK  CLEAR R0                  CHKKW flag                                   
         IF    (R5,EQ,-2),'LA R0,1'  Must provide correct password              
         LA    R1,KWR                                                           
         LCR   R1,R1               (KREAD already done)                         
         ACALL CHKKW                                                            
         END                                                                    
GETKEXIT LABEL ,                                                                
         PEND                                                                   
         DROP  KWR                                                              
         EJECT                                                                  
*box                                                                            
*                                                                               
*  KLOGCMPR -- Check the Kerberos authentication against the                    
*              KLOGIN list item.                                                
*                                                                               
*    On entry:                                                                  
*      R0,R1    - indicate the item to be checked                               
*      CPAUTHID - is the Kerberos principal                                     
*                                                                               
*    On exit:                                                                   
*      R15 = 0 if the Kerberos principal matches the item in                    
*            the KLOGIN list                                                    
*          = nonzero if the Kerberos principal does not match                   
*                                                                               
KLGCMPWA RECORD BEGIN                                                           
KLGCMPBL DS    F                                                                
KLGCMPBF DS    CL(L'CPAUTHID)                                                   
         END                                                                    
*                                                                               
KLOGCMPR XPROC KLGCMPWA                                                         
         MVC   KLGCMPBF,CVBLANKS                                                
         LR    R2,R0                                                            
         CEIL  R2,L'KLGCMPBF                                                    
         ST    R2,KLGCMPBL                                                      
         MOVE  R2,KLGCMPBF,@R1                                                  
*                                                                               
* See if the item in the list is fully-qualified. If not,                       
* try to match it using the Kerberos 5 and Kerberos 4 realms                    
* in sequence.                                                                  
*                                                                               
         TRT   KLGCMPBF,ATTRT      No realm appended                            
         IF    Z,BEGIN                                                          
         L     R1,KLGCMPBL                                                      
         LA    R1,L'K5REALM(,R1)                                                
         IF    (R1,LE,=A(L'KLGCMPBF)),BEGIN                                     
         LA    R1,KLGCMPBF                                                      
         A     R1,KLGCMPBL                                                      
         MVC   0(L'K5REALM,R1),K5REALM                                          
         IF    (KLGCMPBF,EQ,CPAUTHID),BEGIN                                     
         CLEAR R15                 Match K5 realm                               
         B     KLGCMPEX            Exit now                                     
         END                                                                    
         END                                                                    
         L     R1,KLGCMPBL                                                      
         LA    R1,L'K4REALM(,R1)                                                
         IF    (R1,LE,=A(L'KLGCMPBF)),BEGIN                                     
         LA    R1,KLGCMPBF                                                      
         A     R1,KLGCMPBL                                                      
         MVC   0(L'K4REALM,R1),K4REALM                                          
         END                                                                    
         END                                                                    
*                                                                               
         IF    (KLGCMPBF,EQ,CPAUTHID),'CLEAR R15'                               
         ELSE  'LA R15,4'                                                       
*                                                                               
KLGCMPEX LABEL ,                                                                
         PEND                                                                   
K4REALM  DC    C'@IR.STANFORD.EDU'                                              
K5REALM  DC    C'@stanford.edu'                                                 
*                                                                               
ATTRT    DC    XL256'00'                                                        
         ORG   ATTRT+C'@'                                                       
         DC    X'04'                                                            
         ORG                                                                    
         QLTORG                                                                 
         EJECT                                                                  
*box                                                                            
*                                                                               
*  KLOGINCK -- Check the Kerberos authentication against the                    
*              account's KLOGIN list.                                           
*                                                                               
*    On entry:                                                                  
*      CPCACCT  - is the account to be checked                                  
*      CPAUTHID - is the Kerberos principal                                     
*                                                                               
*    On exit:                                                                   
*      R15 = 0 if the Kerberos principal is listed in the                       
*            KLOGIN list                                                        
*          = > zero if the Kerberos principal is not listed                     
*            in the KLOGIN list for the account.                                
*          = < zero if the KLOGIN file doesn't exist or                         
*            cannot otherwise be accessed.                                      
*                                                                               
KLOGINCK XPROC                                                                  
         VCALL MARKHEAP                                                         
         LR    R5,R15              Remember this                                
         LA    R0,L'KRBREC+KRBMXDL#                                             
         VCALL GETHEAP                                                          
         LR    R2,R0                                                            
         LR    R3,R1                                                            
         USING KRBREC,R3                                                        
         MVC   KRBKEY,CPCACCT      Store key of record                          
         LA    R0,L'KRBKEY+L'KRBLEN                                             
         ST    R0,KRBLEN                                                        
         MVC   KRBKEY(2),CPCGRP                                                 
         MVI   KRBKEY+2,C'.'                                                    
         MVC   KRBKEY+3(3),CPCUSER                                              
         DROP  R3                                                               
         LA    R0,L'KRBREC+KRBMXDL#                                             
         LR    R2,R0                                                            
         IC    R4,=C'K'                                                         
         VCALL KEYGET              Get KLOGIN record                            
         IF    NZ,BEGIN                                                         
         XPUSH R15                                                              
         LR    R15,R5                                                           
         VCALL RELHEAP                                                          
         XPOP  R15                                                              
         LA    R15,4               Error accessing file                         
         LCR   R15,R15                                                          
         B     KLOGINEX                                                         
         END                                                                    
*                                                                               
         IF    (R0,GT,L'KRBREC+KRBMXDL#),BEGIN                                  
         LR    R15,R5                                                           
         VCALL RELHEAP                                                          
         B     KLOGINEX                                                         
         END                                                                    
*                                                                               
         LR    R2,R1               Point at returned record                     
         USING KRBREC,R2                                                        
         L     R0,KRBLEN                                                        
         S     R0,=A(L'KRBREC)                                                  
         LA    R1,KRBLIST                                                       
         DROP  R2                                                               
*                                                                               
* Scan through the KLOGIN list looking for a match                              
*                                                                               
         CLEAR R3                                                               
         LR    R2,R0                                                            
         LR    R4,R1                                                            
*                                                                               
         WHILE (R3,LT,R2),BEGIN                                                 
         LC    R0,@R4              Get length and location of next              
         LA    R4,1(,R4)                                                        
         LR    R1,R4                                                            
         AR    R3,R0               Update total length processed                
         LA    R3,1(,R3)                                                        
         AR    R4,R0               Now point to next element                    
         VCALL KLOGCMPR            Try and match the entry                      
         IF    Z,KLOGINEX          Found a match                                
         END                                                                    
*                                                                               
*   No match found                                                              
*                                                                               
         LA    R15,4                                                            
*                                                                               
KLOGINEX LABEL ,                                                                
         PEND                                                                   
         QLTORG                                                                 
         EJECT                                                                  
*                                                                               
* chkkw verifies that the user has the right to do the access                   
* requested for another user's resource (fetch, purge,                          
* save, scratch, etc.).  the password record is read in (unless                 
* it doesn't exist) and the user is prompted for the password.                  
* if the user enters the right password, or if a privileged person              
* enters 'ok' or 'yes', the access is permitted and a return                    
* is made with a zero return code.  otherwise the return flag                   
* is checked to see if return is to be made with a nonzero code;                
* if no return on failure is wanted chkkw goes to cverror.                      
* if the password record does not exist, the user is denied                     
* access unless he is privileged.  if he is privileged, an 'ok?'                
* prompt is made, to see if he really wants access.                             
*                                                                               
* input - r1 = points to a cleared password record area with                    
*              the initials and group set.                                      
*         r0 = flags (0=normal; 1=no priv bypass)                               
*                                                                               
* output - return if access is ok, otherwise go to cverror.                     
*                                                                               
*                                                                               
CHKKW    XPROC                                                                  
         SCPUSH                                                                 
*                                                                               
         LR    R5,R0               Save flag byte                               
         LTR   R6,R1               Set R6 to password area                      
         IF    NEG,'LCR R6,R6; B CHKKWT'  KREAD already done                    
         USING KWR,R6                                                           
CHKKWRD  KREAD (R6)                Read in password record                      
CHKKWT   TM    KWRIFL,KWRIFVAL     Is it a valid user                           
         IF    Z,BEGIN             No, in general error, unless privs           
         ACALL CHKNOREC            OK if return, err does not return            
         CLEAR R15                                                              
         B     CHKKEXIT                                                         
         END                                                                    
*-                                                                              
*-     Log "NOT YOURS/Password" for a SAVE command (for statistics).            
*-                                                                              
         IF    (CPCMNM,EQ,'SAV'),BEGIN  Only log SAVE command...                
         SETMSG CPCMD,LH:CPCMDLEN   Command text                                
         LA    R15,=CL8'ASKPASS'   SMF id                                       
         VCALL SMFLOG                                                           
         END                                                                    
*                                                                               
CHKREPR  SETMSG 'Password? '                                                    
         SET   CPFNECHO                                                         
*                                                                               
         IF    CPSFNECH,BEGIN      Half duplex terminal...                      
         TSEG  (R1),(R0)                                                        
         SETMSG KEYMASK                                                         
         CLEAR CPFNECHO                                                         
         END                                                                    
*                                                                               
         TREAD (R1),(R0)           Prompt for password                          
         BNZ   CVNOACTN                                                         
*                                                                               
         CLEAR CPFNECHO                                                         
*                                                                               
         SCINIT (R1),(R0)          Set scanner                                  
         IF    (CPSFSPR,AND,(R5,Z)),BEGIN                                       
         SCAN  CHKKWPRT                                                         
         SCANCHK                                                                
         END                                                                    
         ELSE  BEGIN                                                            
         SCAN  CHKKWPRN                                                         
         SCANCHK                                                                
         END                                                                    
         IF    (R15,Z),' LA R15,12' No zero returns                             
         IF    (R15,EQ,4),CHKREPR   Nothing entered, reprompt                   
         IF    (R15,EQ,8),BEGIN     Password ok                                 
         CLEAR R15                                                              
         END                                                                    
         ELSE  BEGIN                all else if fail                            
         LA    R15,4                                                            
         END                                                                    
*                                                                               
CHKKEXIT LABEL ,                                                                
         SCPOP                                                                  
         PEND                                                                   
*                                                                               
*                                                                               
CHKKWPRT SCKW  ,CHKKNULL,NULL                                                   
         SCKW  YES,CHKYES                                                       
         SCKW  Y,CHKYES                                                         
         SCKW  OK,CHKYES                                                        
         SCKW  ,CHKKWIN                                                         
*                                                                               
CHKKWPRN SCKW  ,CHKKNULL,NULL                                                   
         SCKW  ,CHKKWIN                                                         
*                                                                               
CHKKNULL PROC  ,                                                                
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
CHKYES   PROC  ,                   Password ok ..                               
         LA    R15,8                                                            
         PEND                                                                   
*                                                                               
CHKKWIN  PROC                                                                   
         DELAY                     Wait a bit ...                               
         AIF   (&KEYUPLO).KEYUPL3                                               
         SCUPTOK R1                                                             
.KEYUPL3 ANOP                                                                   
         IF    (KWRPASS,NE,@R1),BEGIN                                           
         ACALL WATCHKW                                                          
         ABORT 'Incorrect password.'                                            
         END                                                                    
         LA    R15,8               Password ok ..                               
         PEND                                                                   
*                                                                               
* no record found -- bad user or no password checking                           
*                                                                               
CHKNOREC PROC                                                                   
         IF    CPSFSPR,BEGIN       privs                                        
         SETMSG 'OK'                                                            
         VCALL YESREQ                                                           
         COMMENT                   If ok, return to caller                      
         END                                                                    
*                                                                               
         ELSE  BEGIN               No privs, take error exits                   
         TM    KWRHFL,KWRHFCK      Is there kwd checking now                    
         IF    O,BEGIN                                                          
         TSEG  'Account',,B                                                     
         TSEG  KWRGRP                                                           
         TSEG  '.'                                                              
         TSEG  KWRUSER,,B                                                       
         ABORT 'does not exist',,BADACCT                                        
         END                                                                    
         TSEG  'No password checking now.',,CR                                  
         B     CVNOACTN                                                         
         END                                                                    
*                                                                               
         PEND                                                                   
*                                                                               
*                                                                               
         DROP  KWR                                                              
         EJECT                                                                  
*box                                                                            
*                                                                               
*  READPW -- Routine to prompt for password.                                    
*                                                                               
*    On exit:                                                                   
*      R15 - reply text loc (in CPDOUB -- 8 bytes)                              
*      R0 - reply text len                                                      
*                                                                               
READPW   XPROC                                                                  
         SCPUSH                                                                 
*                                                                               
RDPWLOOP SETMSG 'Password? '                                                    
         SET   CPFNECHO                                                         
*                                                                               
         IF    CPSFNECH,BEGIN      Half duplex terminal...                      
         TSEG  (R1),(R0)                                                        
         SETMSG KEYMASK                                                         
         CLEAR CPFNECHO                                                         
         END                                                                    
*                                                                               
         TREAD (R1),(R0)           Prompt for password                          
         IF    NZ,BEGIN            Read failed (logout,attn...)                 
         CLEAR R0                                                               
         CLEAR R15                                                              
         B RDPWEXIT                                                             
         END                                                                    
*                                                                               
         CLEAR CPFNECHO            Reset noecho flag                            
*                                                                               
         SCINIT (R1),(R0)                                                       
         SCAN                                                                   
         IF     (R15,NZ),BEGIN                                                  
         TSEG  'Invalid password, re-enter.',,WR                                
         B     RDPWLOOP                                                         
         END                                                                    
         AIF   (&KEYUPLO).KEYUPL4                                               
         SCUPTOK R1                                                             
.KEYUPL4 ANOP                                                                   
         IF    (R0,Z),RDPWLOOP                                                  
         IF    ((@R1,EQ,''''),OR,(@R1,EQ,'"'),OR,(@R1,EQ,'(')),BEGIN            
         TSEG  'Invalid password, re-enter.',,WR                                
         B     RDPWLOOP                                                         
         END                                                                    
         IF    ((R0,EQ,1),AND,(@R1,EQ,'?')),BEGIN                               
         TSEG  'Please enter the correct password.',,WR                         
         B     RDPWLOOP                                                         
         END                                                                    
         B     RDPWGOOD                                                         
*                                                                               
RDPWGOOD MVC   CPDOUB,CVBLANKS                                                  
         LR    R15,R0                                                           
         CEIL  R15,L'CPDOUB                                                     
         DEX   R15,'MVC CPDOUB(0),@R1 '                                         
         LA    R15,CPDOUB                                                       
RDPWEXIT LABEL ,                                                                
         PRETURN (R0)                                                           
         SCPOP                                                                  
         PEND                                                                   
*                                                                               
KEYSTART DC    X'1FE7',8C'M',8X'16',8C'W',8X'16',8C'G',8X'16'                   
KEYMASK  EQU   KEYSTART,*-KEYSTART,C'C'                                         
*                                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  WATCHKW -- Routine to monitor unsucessful attempts supply the                
*    password.  After 20 attempts we start logging the                          
*    the commands, and after 40 attempts the user is logged off.                
*    If there have been no attempts in the last five minutes                    
*    then the counter is reset.                                                 
*                                                                               
WATCHTMO EQU   5*60                5 minute "timeout"                           
WATCHWC  EQU   20                  Start logging after 20 attempts              
WATCHLC  EQU   40                  Logoff after 40 attempts                     
*                                                                               
WATCHKW  XPROC                                                                  
         STCK  CPDOUB              Current time                                 
         L     R15,CPDOUB                                                       
         SL    R15,CPSECCLK        Time since last attempt                      
         IF    (R15,LGE,WATCHTMO),'CLEAR CPSECCNT'  reset counter               
         MVC   CPSECCLK,CPDOUB     Save new time                                
         INCR  R2,CPSECCNT         Count the attempt                            
         IF    (R2,LGE,WATCHWC),BEGIN  start to monitor...                      
         LA    R0,SMFWSEC          Security violation                           
         VCALL LOGKWR                                                           
         END                                                                    
         IF    (R2,LGE,WATCHLC),BEGIN  enough of this...                        
         TWRITE                                                                 
         TSEG  'You have made too many attempts to supply a',,B                 
         TSEG  'PASSWORD, please contact Accounting.',,CR                       
         IF    (CPSACCT,NZ),BEGIN                                               
         TSEG  'Session is now terminated.',,WR                                 
         END                                                                    
         L     R15,CVCURJCB                                                     
         WITH  (JCB,R15),'SET JCBAFALO'  Logoff (eventually)                    
         B     CVNEXT                                                           
         END                                                                    
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SEGDOL -- Routine to seg dollar amount as "$n.nn".                           
*                                                                               
*    On entry:                                                                  
*      R15 - dollar amount in .1 cents                                          
*                                                                               
SEGDOL   PROC                                                                   
         CLEAR R14                                                              
         D     R14,=F'10'                                                       
         IF    (R14,GE,5),'INCR R15'  Round                                     
*                                                                               
         LR    R2,R15                                                           
         TSEG  '$'                                                              
         BTR   CPDOUB,(0,2),(R2)                                                
         TSEG  (R1),(R0)                                                        
         PEND                                                                   
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SEGXDOL -- Routine to seg exact dollar amount.                               
*                                                                               
*    On entry:                                                                  
*      R15 - dollar amount                                                      
*                                                                               
SEGXDOL  PROC                                                                   
         LR    R2,R15                                                           
         IF    (R2,LGT,X'800000'),BEGIN  negative...                            
         O     R2,=A(X'FF000000')  Make it 32bit neg                            
         LCR   R2,R2                                                            
         TSEG  '-'                                                              
         END                                                                    
         TSEG  '$'                                                              
         BTD   CPDOUB,0,(R2)                                                    
         TSEG  (R1),(R0)                                                        
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
*                                                                               
         QLTORG                                                                 
         VLTORG                                                                 
*                                                                               
         END   .                                                                
