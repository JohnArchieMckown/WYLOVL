NFILE    TITLE 'WYLBUR''s File Access Commands'                                 
*******************************************************************             
*                                                                 *             
*     WYLBUR/370 - Release VI - Class I - Stanford Proprietary    *             
*                                                                 *             
*******************************************************************             
         HIBAL                                                                  
*                                                                               
WYLNFILE CSECT                                                                  
NFIL     IDENT 2025                11:49:27 01/25/02  (SLP)                     
*                                                                               
* Modification history:                                                         
*                                                                               
*    8-MAR-1995  M. Durket                                                      
*      Changed test in ZAPNET to make sure that the file name                   
*      doesn't just consist of only a '%' sign (because that                    
*      caused WYLBUR to failsoft later in the NET module). If                   
*      the filename is just '%' and nothing more, treat it as if                
*      it were not a network filename.                                          
*                                                                               
*    1-JUL-1997 M. Durket                                                       
*      Added support for using WINGS to do ACTIVE file recovery.                
*      To activate this, we'll need to turn it on in the SIGN                   
*      module. For now, ACTIVE file SAVEs via WINGS are turned off,             
*      but USEs (for AUTO USE at logon time) are turned on since                
*      it's no big deal if they don't work.                                     
*                                                                               
         REGS   FSR,,,,,,IOWAR,BR,(WAR,LSR),PAR,PBR,CPR,CVR,SPR,RAR             
         SPACE 2                                                                
         SYSDEFN ,                 Define installation params                   
         GBLC  &PUBUSER,&PUBGRP,&INSTALN                                        
         SPACE 2                                                                
         PUSH  DSECTS                                                           
         EJECT                                                                  
         COPY  CONTROL                                                          
         COPY  SYSDSNS                                                          
*                                                                               
KWR      RECORD BEGIN                                                           
         KWR                                                                    
         END                                                                    
         EJECT                                                                  
         POP   DSECTS                                                           
         EJECT                                                                  
         COPY  FFINFO                                                           
         EJECT                                                                  
SEGCB    RECORD 'SEGCB'                                                         
*                                                                               
         EJECT                                                                  
WYLNFILE CSECT                                                                  
         DC    C'Have a nice day'                                               
         TITLE 'RESAVE Command'                                                 
*                                                                               
*  THIS IS UNDOCUMENTED.                                                        
*  KEEP IT THAT WAY.  REMOVE THIS COMMAND IN FUTURE.                            
*  IT IS THE SAME AS 'SAVE .... REPLACE                                         
*                                                                               
*                                                                               
RESAVE   XPROC ,                                                                
*                                                                               
         ACALL MKFFINFO                                                         
         L     R5,CPFINFOP                                                      
         USING FFINFO,R5                                                        
*                                                                               
         COMMENT                   SET REPLACE                                  
         SET   FFFREPL                                                          
         SET   CPLFLG2.CPFSCRTC    ** DEBUG ** OLD IBM REPLACE FLAG             
*                                                                               
         COMMENT                   DO SAVE                                      
         ACALL SAVE                                                             
*                                                                               
         B     CVNEXT              ALL DONE                                     
*                                                                               
         PEND  ,                                                                
         DROP  R5                                                               
         TITLE 'SAVE Command'                                                   
*box                                                                            
*                                                                               
*  SAVE COMMAND                                                                 
*                                                                               
*  NOTE:                                                                        
*  IF FILE TYPE IS OLDIBM, THEN WE EVENTUALLY CALL THE                          
*  'OLDSAVE' ROUTINE.  THUS, WHEN WINGS GOES PRODUCTION                         
*  WE CAN DELETE THE 'OLDSAVE' CALL.  ALSO WE WILL BE                           
*  ABLE TO DELETE 'OLDFIN' ROUTINE COMPATABILITY CODE.                          
*  DIG IT.                                                                      
*                                                                               
*                                                                               
SVWA     RECORD BEGIN                                                           
SVFLAG1  FLAG  ,                                                                
         FLAG  SVFLINES            SAVE LINES                                   
         FLAG  SVFRECOV            SAVE .. RECOVERY (IE. MULT)                  
SVCMDLEN DS    F                   SAVE CMD LENGTH                              
SVCMDBUF DS    CL(&LINESZ+16)      SAVE CMD BUFFER                              
SVLINECT DS    F                   LINE COUNTER                                 
SVTRUCCT DS    F                   LINE TRUCATION COUNTER                       
SVRTRYCT DS    F                   OPEN RETRY COUNTER                           
         END                                                                    
*                                                                               
*                                                                               
SAVE     XPROC SVWA                                                             
*                                                                               
         COMMENT                   ** DEBUG ** EMERGENCY PATCH                  
         IF    (R0,NE,R0),' VCALL OLDSAVE '  *** DEBUG ***                      
*                                                                               
         LA    R6,SVWA                                                          
         USING SVWA,R6                                                          
         ST    R6,CPCWA                                                         
         CLEAR SVWA                                                             
*                                                                               
         ACALL MKFFINFO                                                         
         L     R5,CPFINFOP                                                      
         USING FFINFO,R5                                                        
*                                                                               
         MVC   CPCMNM(3),=CL3'SAV'                                              
*                                                                               
         COMMENT                   ** DEBUG ** WE SAVE CMD TEXT                 
         COMMENT                   IF OLDIBM, WE WILL REISSUE CMD               
         XPUSH R0,R1                                                            
         MVC   SVCMDBUF(16),=CL16'        OLDSAVE '                             
         SCINFO ,                  R1,R0 SAVE CMD TEXT LOC,LEN                  
         VCALL LRTRIM                                                           
         LR    R3,R0                                                            
         IF    (R3,GT,&LINESZ-32),'ERROR "Command buffer overflow."'            
         MOVE  R3,SVCMDBUF+16,@R1                                               
         A     R0,=F'16'                                                        
         ST    R0,SVCMDLEN                                                      
         IF    CPFTRY,BEGIN        IF TRY PREFIX                                
         MVC   SVCMDBUF(4),=CL4'TRY '                                           
         END                                                                    
         IF    CPFQUIET,BEGIN      IF QUIET PREFIX                              
         MVC   SVCMDBUF+4(4),=CL4'QUI '                                         
         END                                                                    
         IF    FFFREPL,BEGIN       IF RESAVE                                    
         LA    R3,SVCMDBUF                                                      
         L     R0,SVCMDLEN                                                      
         AR    R3,R0                                                            
         IF    (R0,EQ,16),BEGIN                                                 
         MVC   @R3(8),=CL8' * REP  '                                            
         END                                                                    
         ELSE  BEGIN                                                            
         MVC   @R3(8),=CL8'   REP  '                                            
         END                                                                    
         A     R0,=A(8)                                                         
         ST    R0,SVCMDLEN                                                      
         END                                                                    
         XPOP  R0,R1                                                            
*                                                                               
         COMMENT                   SET REQUEST TYPE                             
         IF    (FFRQTYPE,EQ,0),BEGIN     (MAY BE REPLACE, ALREADY)              
         SET   FFFWRITE            SET FILE WRITE FLAG                          
         END                                                                    
*                                                                               
         SET   CPLFLG1.CPFALL      Set ALL ok for range                         
*                                                                               
         COMMENT                   CHECK FOR NO OPERANDS                        
         SCPUSH ,                                                               
         SCANSTR ,                 Pick up next token                           
         SCANCHK ,                                                              
         SCPOP ,                                                                
         IF    ((R15,Z),AND,(R0,Z)),BEGIN  If no file name                      
         SCINIT '* VERIFY'         Default is "SAVE * VERIFY"                   
         END                                                                    
*                                                                               
         COMMENT                   SCAN FOR FILE NAME                           
         VCALL DOFNAME                                                          
         VCALL SCNEXFR             SEE IF SAVE ... .. EXEC                      
*                                                                               
         COMMENT                   SET PREFIX on save (PBT 5/91)                
         IF    CPFRDACT,BEGIN  Saving Active...                                 
         SET   CPLFLG3.CPFSET                                                   
         END                                                                    
*                                                                               
         COMMENT                   SCAN SAVE COMMAND                            
         SCAN  SAVEPRT                                                          
         SCANCHK                                                                
*                                                                               
         COMMENT                   FINISH FILE NAME PROCESSING                  
         VCALL FNAMEFIN                                                         
*                                                                               
         COMMENT                   IF OLDIBM SAVE, DO IT                        
         IF    FFFOLD,BEGIN        ** DEBUG **                                  
         COMMENT                   THE OLDIBM SAVE CODE IS KIND                 
         COMMENT                   OF YUCKKY, IT IS GOING AWAY SO               
         COMMENT                   THERE IS NO POINT TO FIX IT.                 
         L     R2,SVCMDLEN         SET UP 'OLDSAVE' CMD                         
         STH   R2,CPCMDLEN                                                      
         MOVE  R2,CPCMD,SVCMDBUF                                                
         SETMSG CPCMD,LH:CPCMDLEN                                               
         VCALL EDTCOMNH            GO DO 'OLDSAVE', DOES NOT RETURN             
         END                                                                    
*                                                                               
         COMMENT                   IF VERIFY, ASK 'OK TO SAVE ..??'             
* ** DEBUG ** HELP WE MAY NEED FULL NAME ??? DO BEFORE OPEN ?? AHHH!            
         IF    CPFVER,BEGIN        Verify...                                    
         TSEG  'OK to save '                                                    
         VCALL SEGDSN                                                           
         IF    (FFHOSTL,NE,0),BEGIN                                             
         TSEG  ' on '                                                           
         TSEG  FFHOST,L:FFHOSTL                                                 
         END                                                                    
         CLEAR R0                                                               
         VCALL YESREQ              Get Yes/No                                   
         END                                                                    
*                                                                               
         COMMENT                   SET DEFAULT RANGE IF NEEDED                  
         IF    (^CPFXMULT,AND,^SVFLINES),BEGIN                                  
         SCCLR                                                                  
         VCALL NDETRNG                                                          
         END                                                                    
*                                                                               
         COMMENT                   SET MISC STUFF, DO VALIDITY CHECKS           
         SET   CPFNCUR             Set not to change current                    
*                                                                               
*        DO OPEN                                                                
*                                                                               
         COMMENT                   OPEN EXTERNAL FILE                           
         VCALL EXTOPEN                                                          
*                                                                               
*        PROCESS OPEN ERRORS                                                    
*                                                                               
         COMMENT                   IF ERROR, RETRY OPEN ,,                      
         WHILE  (R15,NZ),BEGIN                                                  
         INCR  R2,SVRTRYCT         CHECK RETRY COUNT                            
         IF    (R2,GT,10),BEGIN                                                 
         B     CVERROR                                                          
         END                                                                    
         COMMENT                   FILE EXISTS ,,,                              
         COMMENT                   ASK IF OK TO REPLACE                         
         IF (CPERRID,EQ,'EXISTS  '),BEGIN                                       
         TWRITE ,                                                               
         CLEAR CPERRID                                                          
         ACALL REPOPEN                                                          
         END                                                                    
         COMMENT                   FILE NOT YOURS                               
         COMMENT                   ASK PASSWORD                                 
         ELSEIF ((CPERRID,EQ,'NOTYOURS'),AND,FFFWINGS),BEGIN                    
         COMMENT                   IF NO ACCESS, ASK FOR PASSWORD               
         TWRITE                                                                 
         CLEAR CPERRID                                                          
         ACALL PASSOPEN                                                         
         END                                                                    
         COMMENT                   FILE SAVED ON DIFFERENT VOL                  
         COMMENT                   ASK IF OK TO SAVE ON THIS VOL                
         ELSEIF ((CPERRID,EQ,'DIFFVOL'),AND,FFFWINGS),BEGIN                     
         TWRITE ,                                                               
         CLEAR CPERRID                                                          
         ACALL DIFFOPEN                                                         
         END                                                                    
         ELSEIF ((CPERRID,EQ,'CHANGFMT'),AND,FFFWINGS),BEGIN                    
         TWRITE ,                                                               
         CLEAR CPERRID                                                          
         ACALL CFMTOPEN                                                         
         END                                                                    
         COMMENT                   OTHER ERRS ,,, WE GIVE UP                    
         ELSE  BEGIN                                                            
         B     CVERROR                                                          
         END                                                                    
         END   , OF LOOP TRYING TO OPEN                                         
*                                                                               
*        DO SAVE.                                                               
*                                                                               
         COMMENT                   RECOVERY SAVE (IE. SAVE MULT)                
         IF    SVFRECOV,BEGIN                                                   
         ACALL SAVRECOV                                                         
         END                                                                    
*                                                                               
         COMMENT                   NORMAL SAVE                                  
         ELSE  BEGIN               Save current Active/Exec...                  
         IF    CPFRDACT,BEGIN                                                   
         RDRNG SAVERTN,(DESRTRN+LOCATRTN+UNPRST)                                
         END                                                                    
         ELSEIF CPFRDEXE,BEGIN                                                  
         RDRNG SAVERTN,(DESRTRN+LEXATRTN+UNPRST)                                
         END                                                                    
         END                                                                    
*                                                                               
         VCALL EXTCLOSE                                                         
         IF    CPFRCVY,BEGIN       Recovery save...                             
         SET   CPGFLG2.CPFACTSV    Set flag that recovery saved                 
         END                                                                    
         CLEAR CPACHCT             Clear change count                           
*                                                                               
         COMMENT                   SET PREFIX, IF APPROPRIATE                   
         IF    CPLFLG3.CPFSET,BEGIN                                             
         VCALL SETPFXNS                                                         
         END                                                                    
*                                                                               
         COMMENT                   DO CLEAR IF REQUESTED                        
         IF    CPFCLEAR+CPFKEEP,BEGIN                                           
         IF    CPFRDACT,BEGIN                                                   
         IF    SVFRECOV,BEGIN                                                   
         VCALL ACTRESET            Wipe them out - MPD                          
         END                                                                    
         ELSE  BEGIN                                                            
         VCALL CLRTEXT             Clear/Keep                                   
         END                                                                    
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   GIVE SAVED OK MESSAGE                        
         COMMENT                   ** DEBUG ** WINGS GENERATES MSG              
         COMMENT                   ** DEBUG ** SHOULD NET AND SAM ??            
         IF    FFFNET,BEGIN        MSG FOR NET                                  
         VCALL SEGDSN                                                           
         SETMSG 'saved'                                                         
         IF    FFFAPPD,'SETMSG "appended"'                                      
         TSEG  (R1),(R0)                                                        
         IF    (FFHOSTL,NE,0),BEGIN                                             
         TSEG  ' on '                                                           
         TSEG  FFHOST,L:FFHOSTL                                                 
         END                                                                    
         END                                                                    
         IF    FFFSAM,BEGIN        MSG FOR SAM                                  
         VCALL NRESOLVE            RESOLVE C: NAME                              
         VCALL SEGDSN                                                           
         TSEG  'saved'                                                          
         IF    (FFHOSTL,NE,0),BEGIN                                             
         TSEG  ' on '                                                           
         TSEG  FFHOST,L:FFHOSTL                                                 
         END                                                                    
         END                                                                    
*                                                                               
         B     CVNEXT              ALL DONE                                     
         PEND  ,                                                                
         QLTORG                                                                 
         EJECT                                                                  
*-                                                                              
*-       SAVE options                                                           
*-                                                                              
SAVEPRT  SCKW  LINES,SSNLINES,A                                                 
         SCKW  LINS,SSNLINES,A                                                  
         SCKW  EXECUTE,V(SCNNOOP),A                                             
         SCKW  REPLACE,SSNREPL,A                                                
         SCKW  APPEND,SSNAPPND,A                                                
         SCKW  SCRATCH,SSNREPL,A                                                
         SCKW  RECOVERY,SSNRECOV,A                                              
         SCKW  MULTIPLE,SSNRECOV,A                                              
         SCKW  NOCONDENSE,SSNNCOND,A                                            
         SCKW  SET,SSNSET                                                       
         SCKW  NOSET,SSNNOSET,A                                                 
         SCKW  ,V(CLSCRPSH),PUSH                                                
         SCKW  ,V(VERPSH),PUSH                                                  
         SCKW  ,FNAMPSHS,PUSH                                                   
         SCKW  ,V(COLLPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(SMSPSH),PUSH                                                  
*        SCKW  ,NREC,V(MATPARN)!!                                               
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SSNLINES PROC  ,                                                                
         IF    SVFLINES,BEGIN                                                   
         ERROR 'LINES: invalid.  LINES specified twice.'                        
         END                                                                    
         SET   SVFLINES                                                         
         VCALL NDETRNG                                                          
         CLEAR R15                                                              
         PEND  ,                                                                
*                                                                               
SSNREPL  PROC  ,                                                                
         SET   FFFREPL                                                          
         SET   CPLFLG2.CPFSCRTC    *** DEBUG *** NEEDED FOR SAM,NET             
         PEND  ,                                                                
*                                                                               
SSNAPPND PROC  ,                                                                
         SET   FFFAPPD                                                          
         PEND  ,                                                                
*                                                                               
SSNRECOV PROC  ,                                                                
         SET   CPFXMULT                                                         
         SET   SVFRECOV                                                         
         PEND  ,                                                                
*                                                                               
SSNNCOND PROC  ,                   NO CONDENSE, HEY WINGS GET SMAR!             
         SET   CPFNCOND                                                         
         PEND                                                                   
*                                                                               
SSNSET   PROC  ,                                                                
         SET   CPLFLG3.CPFSET                                                   
         PEND                                                                   
*                                                                               
SSNNOSET PROC  ,                                                                
         CLEAR CPLFLG3.CPFSET                                                   
         PEND                                                                   
*                                                                               
         DROP  R6                                                               
         DROP  R5                                                               
         EJECT                                                                  
*box                                                                            
*                                                                               
*  SAVERTN -- SAVE CO-ROUTINE                                                   
*                                                                               
*    ON ENTRY:                                                                  
*      R1,R0 - LINE LOCATION LENGTH                                             
*      CPLCNO - LINE NUMBER                                                     
*                                                                               
*                                                                               
SAVERTN  PROC  ,                                                                
*                                                                               
         COMMENT                   R1,R0 - LINE LOC,LEN                         
         COMMENT                   R2 - LINE NUMBER                             
         L     R2,CPLCNO                                                        
         VCALL EXTWRITE            PUT LINE INTO I/O BUFFER, ETC.               
         COMMENT                   RETURNS ONLY IF OK                           
         PEND                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
*  RSAVERTN - SAVE .. RECOVERY CO-ROUTINE                                       
*                                                                               
*    ON ENTRY:                                                                  
*      R1,R0 - LINE LOCATION LENGTH                                             
*      CPLCNO - LINE NUMBER                                                     
*                                                                               
*  NOTE:                                                                        
*  FOR SAVE RECOVERY WE ADD THE ACTUAL LINE NUMBER TO THE                       
*  START OF THE RECORD.  THE EXTERNAL LINE NUMBER IS JUST                       
*  SEQUENTIALLY UPDATED VALUE.                                                  
*                                                                               
SRWA     RECORD BEGIN                                                           
SRR0     DS    F                                                                
SRR1     DS    F                                                                
SRLINE   DS    CL(2*&LINESZ+8)                                                  
         END                                                                    
*                                                                               
*                                                                               
RSAVERTN PROC  SRWA,                                                            
         ST    R0,SRR0                                                          
         ST    R1,SRR1                                                          
*                                                                               
         L     R6,CPCWA                                                         
         USING SVWA,R6                                                          
*                                                                               
         COMMENT                   ADD LINE NUMBER TO START OF LINE             
         L     R15,CPLCNO                                                       
         LA    R1,SRLINE                                                        
         LA    R0,8                                                             
         VCALL BTDZEROS                                                         
         COMMENT                   COPY LINE TEXT                               
         LA    R2,SRLINE+8                                                      
         L     R3,SRR0                                                          
         L     R4,SRR1                                                          
         LR    R5,R3                                                            
         MVCL  R2,R4                                                            
*                                                                               
         COMMENT                   R1,R0 - LINE LOC,LEN                         
         LA    R1,SRLINE           R2 - LINE NUMBER                             
         L     R0,SRR0                                                          
         A     R0,=F'8'                                                         
         INCR  R2,SVLINECT                                                      
         VCALL EXTWRITE            PUT LINE INTO I/O BUFFER, ETC.               
         COMMENT                   RETURNS ONLY IF OK                           
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  SAVRECOV - DO RECOVERY SAVE OF MULTIPLE ACTIVE FILES                         
*                                                                               
*  ON ENTRY:                                                                    
*    R6 - SAVE WORK AREA         ** DEBUG **                                    
*                                                                               
*  WE SUPERIMPOSE, MULTIPLE FILES INTO ONE FILE                                 
*  WE SAVE CURRENT ACTIVE FILE LAST                                             
*                                                                               
*                                                                               
SVRWA    RECORD BEGIN                                                           
SVROACT  DS    F                   ORIGINAL ACTIVE NUMBER                       
SVRCACT  DS    F                   CURRENT ACTIVE NUMBER                        
         END                                                                    
*                                                                               
*                                                                               
SAVRECOV PROC  SVRWA                                                            
         CLEAR SVRWA                                                            
*                                                                               
         USING  SVWA,R6                                                         
*                                                                               
         COMMENT                   SAVE ORIGINAL ACT #                          
         L     R1,CPACTNO                                                       
         ST    R1,SVROACT                                                       
*                                                                               
         COMMENT                   WRITE MULTIPLE FORMAT HDR                    
         SETMSG '*CTL%%%%MULTIPLE FILE FORMAT VERSION 00.00'                    
         INCR  R2,SVLINECT                                                      
         VCALL EXTWRITE                                                         
*                                                                               
         COMMENT                   COMMENT LOOP THRU ALL ACTS                   
         LA    R1,=CL8'TEXT'                                                    
         CLEAR R15                                                              
         VCALL ACTNEXT                                                          
         WHILE NZ,BEGIN            WHILE MORE ACTS, LOOP                        
         ST    R15,SVRCACT                                                      
         VCALL ACTPICK                                                          
         IF    (CPALNCT,NZ),BEGIN  IF LINES,,,                                  
         IF    (SVRCACT,NE,SVROACT),BEGIN IF NOT ORIGINAL ACT ,,                
         COMMENT                   SAVE ACTS                                    
         COMMENT                   WRITE NEW ACT HDR                            
         SETMSG '*CTL%%%%OPEN NEW ACTIVE'                                       
         INCR  R2,SVLINECT                                                      
         VCALL EXTWRITE                                                         
         SCCLR ,                                                                
         SET   CPLFLG1.CPFALL                                                   
         VCALL NDETRNG                                                          
         COMMENT                   SAVE ACT                                     
         RDRNG RSAVERTN,(DESRTRN+LOCATRTN+UNPRST)                               
         END                                                                    
         END                                                                    
         LA    R1,=CL8'TEXT'                                                    
         L     R15,SVRCACT                                                      
         VCALL ACTNEXT             POINT TO NEXT ACT, LOOP                      
         END                                                                    
*                                                                               
         COMMENT                   SAVE CURRENT ACT                             
         L     R15,SVROACT                                                      
         VCALL ACTPICK                                                          
         IF    (CPALNCT,NZ),BEGIN  IF LINES,,,                                  
         COMMENT                   SAVE ACTS                                    
         COMMENT                   WRITE NEW ACT HDR                            
         SETMSG '*CTL%%%%OPEN NEW ACTIVE'                                       
         INCR  R2,SVLINECT                                                      
         VCALL EXTWRITE                                                         
         SCCLR ,                                                                
         SET   CPLFLG1.CPFALL                                                   
         VCALL NDETRNG                                                          
         COMMENT                   SAVE ACT                                     
         RDRNG RSAVERTN,(DESRTRN+LOCATRTN+UNPRST)                               
         END                                                                    
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  REPOPEN - ASK IF OK TO REPLACE EXISTING FILE                                 
*                                                                               
*  IF USER SAYS 'OK TO REPLACE' WE SET THE REPLACE OPTION                       
*  AND TRY TO OPEN AGAIN.  THIS ROUTINE APPLIES ONLY TO WINGS                   
*  FILE SYSTEM.                                                                 
*                                                                               
*                                                                               
REPOPEN  PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   ASK -- OK to replace                         
         SETMSG 'OK to replace'                                                 
         VCALL YESREQ                                                           
*                                                                               
         COMMENT                   SET REPLACE OPTION                           
         SET   FFFREPL                                                          
*                                                                               
         COMMENT                   TRY AGAIN                                    
         VCALL EXTOPEN                                                          
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  ACSSOPEN - SPECIAL ACCESS OPEN                                               
*                                                                               
*  USER HAS SPECIAL ACCESS TO THIS FILE (EG. SET ACCT ..  PASS..)               
*  SO WE OPEN THE FILE WITH 'ACCESS=YES' FLAG.                                  
*                                                                               
*                                                                               
ACSSOPEN PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SET NORACF ACCESS OPTION                     
         SET   FFFNRACF                                                         
*                                                                               
         COMMENT                   TRY AGAIN                                    
         VCALL EXTOPEN                                                          
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  GETPASSW - WE NEED PASSWORD TO ACCESS THIS FILE                              
*                                                                               
*  THIS ROUTINE ASKS USER FOR (MAINFRAME) PASSWORD.  IF USER                    
*  KNOWS PASSWORD, THIS ROUTINE SETS THE APPROPRIATE FLAG                       
*  IN THE FFINFO BLOCK.                                                         
*  THIS ROUTINE APPLIES ONLY TO WINGS *  FILE SYSTEM.                           
*                                                                               
*  ON ENTRY:                                                                    
*  'NOT YOURS' MSG IS TSEG'D.  WE DECIDE WHETHER TO PURGE                       
*  OR PRINT TSEG'D MSG BELOW.                                                   
*                                                                               
*  NOTE:                                                                        
*  IF 'SET ACCOUNT ... PASS ...' OWNS DATA SET WE DO NOT                        
*  ISSUE ERROR MSG, AND DO *NOT* PROMPT FOR PASSWORD.                           
*                                                                               
*  NOTE:                                                                        
*  IF NO ACCOUNT ASSOCIATED WITH THE DATA SET, THEN                             
*  WE PROMPT FOR THE ACCOUNT GS.WYL.  WHICH ONLY SYSTEMS                        
*  TYPES CAN GUESS.  YES!                                                       
*                                                                               
*                                                                               
GETPWWA  RECORD BEGIN                                                           
GETPWKWR DS    XL(L'KWR)                                                        
         END                                                                    
*                                                                               
*                                                                               
GETPASSW PROC  GETPWWA                                                          
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   IF NOT WINGS, ERR                            
         COMMENT ,                 (IE. NO 'NOTYOURS' FOR NET,                  
         IF    ^FFFWINGS,BEGIN      SAMSON, ETC.)                               
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         COMMENT                   SET UP KWR                                   
         LA    R4,GETPWKWR                                                      
         USING KWR,R4                                                           
         CLEAR KWR                                                              
*                                                                               
         COMMENT                   SET ACCOUNT FROM DATA SET NAME               
         ACALL NRESOLVE            GET FULL NAME                                
         SETMSG FFRNAME,L:FFRNAMEL                                              
         IF    ((R0,GT,11),AND,(@R1,EQ,'WYL.'),AND,                    X        
               (@R1+6,EQ,'.'),AND,(@R1+10,EQ,'.')),BEGIN                        
         MVC   KWRGRP,@R1+4        SET DATA SET ACCOUNT                         
         MVC   KWRUSER,@R1+7                                                    
         END                                                                    
         ELSE  BEGIN               SET DEFAULT OWNER ACCOUT                     
         MVC   KWRGRP,=CL2'GS'                                                  
         MVC   KWRUSER,=CL3'WYL'                                                
         END                                                                    
*                                                                               
         COMMENT                   CHECK PASSWORD                               
         CLEAR R0                  GETKWR OPTION                                
         LA    R1,KWR                                                           
         VCALL GETKWR                                                           
         CLEAR R15                 RETURNS ONLY IF OK                           
*                                                                               
         COMMENT                   IF PASSWORD OK, ADD TO OPTIONS               
         SET   FFFPASSW            PASSWORD IS OK                               
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R4                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  PASSOPEN - WE NEED PASSWORD TO OPEN THIS FILE                                
*                                                                               
*  THIS ROUTINE ASKS USER FOR (MAINFRAME) PASSWORD.  IF USER                    
*  KNOWS PASSWORD, WE WILL TRY AGAIN TO OPEN FILE WITH                          
*  PASSWORD=OK OPTION.  THIS ROUTINE APPLIES ONLY TO WINGS                      
*  FILE SYSTEM.                                                                 
*                                                                               
*  ON ENTRY:                                                                    
*  'NOT YOURS' MSG IS TSEG'D.  WE DECIDE WHETHER TO PURGE                       
*  OR PRINT TSEG'D MSG BELOW.                                                   
*                                                                               
*  NOTE:                                                                        
*  IF 'SET ACCOUNT ... PASS ...' OWNS DATA SET WE DO NOT                        
*  ISSUE ERROR MSG, AND DO *NOT* PROMPT FOR PASSWORD.                           
*                                                                               
*  NOTE:                                                                        
*  IF NO ACCOUNT ASSOCIATED WITH THE DATA SET, THEN                             
*  WE PROMPT FOR THE ACCOUNT GS.WYL.  WHICH ONLY SYSTEMS                        
*  TYPES CAN GUESS.  YES!                                                       
*                                                                               
*                                                                               
PWWA     RECORD BEGIN                                                           
PWKWR    DS    XL(L'KWR)                                                        
         END                                                                    
*                                                                               
*                                                                               
PASSOPEN PROC  PWWA                                                             
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   IF NOT WINGS, ERR                            
         COMMENT ,                 (IE. NO 'NOTYOURS' FOR NET,                  
         IF    ^FFFWINGS,BEGIN      SAMSON, ETC.)                               
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         IF    CPFRCVY,BEGIN       SKIP IF DOING RECOVERY                       
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         COMMENT                   SET UP KWR                                   
         LA    R4,PWKWR                                                         
         USING KWR,R4                                                           
         CLEAR KWR                                                              
*                                                                               
         COMMENT                   SET ACCOUNT FROM DATA SET NAME               
         ACALL NRESOLVE            GET FULL NAME                                
         SETMSG FFRNAME,L:FFRNAMEL                                              
         IF    ((R0,GT,11),AND,(@R1,EQ,'WYL.'),AND,                    X        
               (@R1+6,EQ,'.'),AND,(@R1+10,EQ,'.')),BEGIN                        
         MVC   KWRGRP,@R1+4        SET DATA SET ACCOUNT                         
         MVC   KWRUSER,@R1+7                                                    
         END                                                                    
         ELSE  BEGIN               SET DEFAULT OWNER ACCOUT                     
         MVC   KWRGRP,=CL2'GS'                                                  
         MVC   KWRUSER,=CL3'WYL'                                                
         END                                                                    
*                                                                               
         COMMENT                   CHECK PASSWORD                               
         CLEAR R0                  GETKWR OPTION                                
         LA    R1,KWR                                                           
         VCALL GETKWR                                                           
         CLEAR R15                 RETURNS ONLY IF OK                           
*                                                                               
         COMMENT                   IF PASSWORD OK, ADD TO OPTIONS               
         SET   FFFPASSW            PASSWORD IS OK                               
*                                                                               
         COMMENT                   TRY AGAIN                                    
         VCALL EXTOPEN                                                          
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R4                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  DIFFOPEN - ASK IF OK TO SAVE ON DIFFERENT VOLUME                             
*                                                                               
*  IF USER SAYS 'OK TO USE OTHER -VOLUME- WE LET WINGS TRY TO                   
*  SAVE (BUT NOT CAT) FILE.  THIS ROUTINE APPLIES ONLY TO WINGS                 
*  FILE SYSTEM.                                                                 
*                                                                               
*                                                                               
DIFFOPEN PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         IF    ^CPFRCVY,BEGIN                                                   
         COMMENT                   ASK -- OK to replace                         
         TSEG  'Do you want to save '                                           
         TSEG  FFHOST,L:FFHOSTL                                                 
         SETMSG ' anyway'                                                       
         VCALL YESRTN                                                           
         IF    NZ,BEGIN                                                         
         TSEG  'No action taken.'                                               
         B     CVNEXT                                                           
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   SET REPLACE OPTION                           
         SET   FFFDIFFV                                                         
*                                                                               
         COMMENT                   TRY AGAIN                                    
         VCALL EXTOPEN                                                          
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  CFMTOPEN - ASK IF OK TO CHANGE DATA SET FORMAT                               
*                                                                               
*  IF USER SAYS 'OK TO CHANGE DATA SET FORMAT' LET WINGS CHANGE                 
*  THE DATA SET FORMANT.  THIS ROUTINE APPLIES ONLY TO WINGS                    
*  FILE SYSTEM.                                                                 
*                                                                               
*                                                                               
CFMTOPEN PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         IF    ^CPFRCVY,BEGIN                                                   
         COMMENT                   ASK -- OK to change                          
         SETMSG 'OK to change data set format'                                  
         VCALL YESRTN                                                           
         IF    NZ,BEGIN                                                         
         TSEG  'No action taken.'                                               
         B     CVNEXT                                                           
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   SET REPLACE OPTION                           
         SET   FFFCHFMT                                                         
*                                                                               
         COMMENT                   TRY AGAIN                                    
         VCALL EXTOPEN                                                          
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*                                                                               
*                                                                               
*   USE COMMAND                                                                 
*                                                                               
*                                                                               
*                                                                               
USEWA    RECORD BEGIN                                                           
USESKIP  DS    F                                                                
USECOUNT DS    F                                                                
USETCNT  DS    F                                                                
USEFLAG1 FLAG  ,                                                                
         FLAG  USEFRECOV           RECOVERY                                     
         FLAG  USEFNOCTL           SKIP *CTL%%%% DIRECTIVES                     
         END                                                                    
*                                                                               
*                                                                               
USE      XPROC USEWA                                                            
*                                                                               
         LA    R6,USEWA                                                         
         USING USEWA,R6                                                         
         ST    R6,CPCWA                                                         
         CLEAR USEWA                                                            
*                                                                               
         ACALL MKFFINFO                                                         
         L     R5,CPFINFOP                                                      
         USING FFINFO,R5                                                        
         SET   FFFREAD                                                          
*                                                                               
         COMMENT                   SET SOME DEFAULTS                            
         SET   CPLFLG3.CPFSET                                                   
*                                                                               
         COMMENT                   SCAN DATA SET NAME                           
         VCALL DOFNAME                                                          
*                                                                               
         COMMENT                   SCAN 'USE ...' OPTIONS                       
         SCAN  USEPRT                                                           
         SCANCHK                                                                
*                                                                               
         COMMENT                   FINISH FILE NAME PROCESSING                  
         VCALL FNAMEFIN                                                         
*                                                                               
         COMMENT                   VALIDITY CHECK SOME OPTIONS                  
         IF    USEFRECOV,BEGIN                                                  
         IF    (USESKIP,NE,0),BEGIN                                             
         ERROR 'RECOVERY and SKIP options are incompatible.'                    
         END                                                                    
         IF    (USECOUNT,NE,0),BEGIN                                            
         ERROR 'RECOVERY and COUNT options are incompatible.'                   
         END                                                                    
         END                                                                    
         COMMENT                   WE IGNORE ALL FORMAT OPTIONS                 
         COMMENT                   YES OR NO ??                                 
*                                                                               
         COMMENT                   CLEAR CURRENT ACTIVE,                        
         VCALL CLRTEXT                                                          
*                                                                               
         COMMENT                   OPEN EXTERNAL FILE                           
         VCALL EXTOPEN                                                          
*                                                                               
         COMMENT                   IF ERROR, RETRY OPEN ,,                      
         IF    (R15,NZ),BEGIN                                                   
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         COMMENT                   SET SOME DEFAULTS                            
         COMMENT                   READ IN EXTERNAL RANGE                       
         SET   CPLFLG1.CPFALL                                                   
         SET   CPFRDEXT                                                         
         SCCLR ,                                                                
         VCALL NDETRNG                                                          
         SET   CPLFLG5.CPFNLST                                                  
         SET   CPFNCUR                                                          
         SET   CPFXALL                                                          
         IF    ^FFFOLD,BEGIN                                                    
         IF    (CPFAUSE),BEGIN     Auto recovery not abortable                  
         RDRNG USERTN,(DESRTRN+LXCATRTN)                                        
         END                                                                    
         ELSE  BEGIN                                                            
         RDRNG USERTN,(DESABORT+DESRTRN+LXCATRTN)                               
         END                                                                    
         END                                                                    
         ELSEIF FFFOLD,BEGIN                                                    
         RDRNG OLDRTN,(DESABORT+DESRTRN+LXCATRTN)                               
         END                                                                    
*                                                                               
         COMMENT                   IF ATTENTION HIT ,,,                         
         IF    (R15,NZ),BEGIN                                                   
         VCALL EXTCLOSE                                                         
         VCALL LASTLINE SHOW LAST LINE NUMBER                                   
         B     CVABORT                                                          
         END                                                                    
*                                                                               
         COMMENT                   CLOSE FILE                                   
         VCALL EXTCLOSE                                                         
         IF    (R15,NZ),BEGIN                                                   
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         COMMENT                   CHECK LINES READ                             
         IF    (USESKIP,GT,0),BEGIN                                             
         IF    (USETCNT,LE,USESKIP),BEGIN                                       
         L     R2,USETCNT                                                       
         TNUM  (R2)                                                             
         ERROR ' lines found, skip count too high.'                             
         END                                                                    
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND  ,                                                                
         DROP  R5                                                               
         EJECT                                                                  
*                                                                               
*  USE SCKW STUFF                                                               
*                                                                               
USEPRT   SCKW  SKIP,USNSKIP,(A,P,PI),99999999                                   
         SCKW  COUNT,USNCOUNT,(A,P,PI),99999                                    
         SCKW  RECOVERY,USNRECOV,A                                              
         SCKW  MULTIPLE,USNRECOV,A                                              
         SCKW  NOCATALOG,USNICAT,A                                              
         SCKW  NOCONTROL,USNOCTL,A                                              
         SCKW  DSORG,USNIDS,(P,A)                                               
         SCKW  SET,USSET                                                        
         SCKW  NOSET,USNOSET,A                                                  
         SCKW  ,V(CLRPSH),PUSH                                                  
         SCKW  ,V(FNAMPSHF),PUSH                                                
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
USNSKIP  PROC  ,                                                                
         ST    R0,USESKIP                                                       
         PEND  ,                                                                
*                                                                               
USNCOUNT PROC  ,                                                                
         ST    R0,USECOUNT                                                      
         PEND  ,                                                                
*                                                                               
USNRECOV PROC  ,                                                                
         SET   USEFRECOV                                                        
         PEND  ,                                                                
*                                                                               
USNOCTL  PROC  ,                                                                
         SET   USEFNOCTL                                                        
         PEND  ,                                                                
*                                                                               
USSET    PROC                                                                   
         SET   CPLFLG3.CPFSET                                                   
         PEND                                                                   
*                                                                               
USNOSET  PROC                                                                   
         CLEAR CPLFLG3.CPFSET                                                   
         PEND                                                                   
*                                                                               
USNICAT  PROC  ,                                                                
         TSEG  'NOCATALOG option ignored.',,CR                                  
         PEND  ,                                                                
*                                                                               
USNIDS   PROC  ,                                                                
         TSEG  'DSORG options ignored.',,CR                                     
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*                                                                               
*  USERTN - USE CO-ROUTINE                                                      
*                                                                               
*  ON ENTRY:                                                                    
*    R1,R0 - LINE TEXT LOCATION LENGTH                                          
*    CPLCNO - LINE NUMBER                                                       
*                                                                               
*                                                                               
*  NOTE:                                                                        
*  WE DO NOT HANDLE LONG LINES OR WHAT ??                                       
*                                                                               
*                                                                               
USERTN   PROC  ,                                                                
         L     R6,CPCWA                                                         
         USING USEWA,R6                                                         
*                                                                               
         COMMENT                   INCREMENT TOTAL COUNT                        
         INCR  R2,USETCNT                                                       
*                                                                               
         COMMENT                   CHECK FILE FOR CONTROL LINES                 
         XPUSH R0,R1                                                            
         IF    ((USETCNT,EQ,1),AND,(@R1,EQ,=CL8'*CTL%%%%')),BEGIN               
         IF    ((^USEFRECOV),AND,(^USEFNOCTL)),BEGIN                            
         LS    R2,R3,'*CTL%%%%MULTIPLE FILE FORMAT VERSION 00.00'               
         IF    (R3,EQ,R0),BEGIN                                                 
         DEX   R3,' CLC @R2(0),@R1 '                                            
         IF    EQ,BEGIN                                                         
         SET   USEFRECOV                                                        
         TSEG  'Processing multiple active files.',,CR                          
         TWRITE                                                                 
         IF    ((USESKIP,NE,0),OR,(USECOUNT,NE,0)),BEGIN                        
         TSEG  'SKIP and/or COUNT options ignored.',,CR                         
         TWRITE                                                                 
         END                                                                    
         END                                                                    
         END                                                                    
         END                                                                    
         END                                                                    
         XPOP  R0,R1                                                            
*                                                                               
         COMMENT                   IF MULTIPLE ACTIVES,                         
         COMMENT                   PROCESS SEPARATELY                           
         IF    USEFRECOV,BEGIN                                                  
         ACALL USEMULT                                                          
         B     URTNDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   FIGURE UPPER LIMIT IF ANY                    
         L     R3,=F'1000000000'                                                
         IF    (USECOUNT,NE,0),BEGIN                                            
         L     R3,USESKIP                                                       
         A     R3,USECOUNT         R3 - UPPER LIMIT                             
         END                                                                    
*                                                                               
         COMMENT                   PUT LINE IF SKIP/COUNT LIMIT OK              
         L     R2,USETCNT                                                       
         IF    ((R2,GT,USESKIP),AND,(R2,LE,R3)),BEGIN                           
         L     R15,CPLCNO                                                       
         VCALL PUTLINE                                                          
         END                                                                    
*                                                                               
         COMMENT                   IF MORE THAN COUNT, STOP                     
         L     R2,USETCNT                                                       
         IF    (R2,GT,R3),BEGIN                                                 
         SET   CPFRQUIT QUIT RANGE                                              
         END                                                                    
*                                                                               
URTNDONE LABEL ,                                                                
         PEND  ,                                                                
         EJECT                                                                  
*                                                                               
*                                                                               
*                                                                               
*  USEMULT - DO MULTIPLE ACTIVE FILE *CTL%%%% PROCESSING                        
*                                                                               
*  ON ENTRY:                                                                    
*    R1,R0 - LINE TEXT LOCATION LENGTH                                          
*    CPLCNO - LINE NUMBER                                                       
*                                                                               
*  REGISTER USAGE,                                                              
*    R2,R3 - LINE TEXT LOC, LENGTH                                              
*                                                                               
*  NOTE:                                                                        
*  WE DO NOT HANDLE LONG LINES.                                                 
*                                                                               
*                                                                               
LNNUMB   EQU   0,8                 OFFSETS FOR MULT FORMAT                      
LNTEXT   EQU   8                                                                
*                                                                               
USEMULT  PROC  ,                                                                
         L     R6,CPCWA                                                         
         USING USEWA,R6                                                         
*                                                                               
         COMMENT                   R2,R3 - INPUT LINE LOC, LEN                  
         LR    R2,R1                                                            
         LR    R3,R0                                                            
*                                                                               
         COMMENT                   VALIDITY CHECK FIRST LINE                    
         IF    (USETCNT,EQ,1),BEGIN                                             
         SETMSG '*CTL%%%%MULTIPLE FILE FORMAT VERSION 00.00'                    
         IF    (R3,NE,R0),BEGIN                                                 
         ERROR 'RECOVERY option invalid for this file.'                         
         END                                                                    
         LR    R4,R3                                                            
         DEX   R4,' CLC @R2(0),@R1 '                                            
         IF    NE,BEGIN                                                         
         ERROR 'RECOVERY option invalid for this file.'                         
         END                                                                    
         END                                                                    
*                                                                               
         ELSE  BEGIN                                                            
         COMMENT                   IF OPEN NEW ACTIVE REQ, DO IT                
         CLC   @R2(23),=CL23'*CTL%%%%OPEN NEW ACTIVE'                           
         IF    EQ,BEGIN                                                         
         IF    (CPALNCT,NE,0),BEGIN                                             
         VCALL ACTOPEN                                                          
         VCALL ACTVREST                                                         
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   STANDARD LINE, WRITE IT                      
         ELSE  BEGIN                                                            
         IF    (R3,LT,L'LNNUMB),BEGIN                                           
         TSEG  'RECOVERY option invalid for this file. '                        
         ERROR 'Command stopped.'                                               
         END                                                                    
         LA    R1,LNNUMB(R2)                                                    
         LA    R0,L'LNNUMB                                                      
         VCALL GTINTVAL                                                         
         LR    R0,R3                                                            
         LR    R1,R2                                                            
         LA    R1,LNTEXT(R1)                                                    
         S     R0,=AL4(L'LNNUMB)                                                
         VCALL PUTLINE                                                          
         END ,                                                                  
         END , OF NOT FIRST LINE                                                
*                                                                               
         PEND  ,                                                                
         EJECT                                                                  
* *** DEBUG ***  THIS ROUTINE AND CALLING SEQUENCE                              
* *** DEBUG ***  FOR OLD IBM ONLY                                               
*                                                                               
*                                                                               
*  OLDRTN - USE CO-ROUTINE FOR OLDIBM                                           
*                                                                               
*  ON ENTRY:                                                                    
*    R1,R0 - LINE TEXT LOCATION LENGTH                                          
*    CPLCNO - LINE NUMBER                                                       
*                                                                               
*                                                                               
*  NOTE:                                                                        
*  FOR OLD IBM FORMAT, WE GET YUCKED UP A BIT                                   
*  WE READ EITHER TYPE OF MULTIPLE ACTIVE FORMAT.                               
*  (IE. *CTL%%%% OR EXTENDED EDIT. ONE OR OTHER.)                               
*                                                                               
*                                                                               
*  NOTE:                                                                        
*  WE DO NOT HANDLE LONG LINES OR WHAT ??                                       
*                                                                               
*                                                                               
OLDRTN   PROC  ,                                                                
         L     R6,CPCWA                                                         
         USING USEWA,R6                                                         
*                                                                               
         COMMENT                   INCREMENT TOTAL COUNT                        
         INCR  R2,USETCNT                                                       
*-                                                                              
*-       Handle USE of multiple Active files.                                   
*-                                                                              
         L2    R2,CPNEDSET         Current set number                           
         N     R2,=A(X'7FFF')      High order bit is a flag                     
         IF    (R2,NE,CPUSESET),BEGIN  Stack Actives...                         
         STH   R2,CPUSESET         Save new set number                          
         IF    (CPALNCT,Z),EXIT    No Active file, don't switch                 
*                                                                               
         VCALL ACTOPEN             Open a new Active file                       
         VCALL ACTVREST            Set current view position                    
         END                                                                    
*-                                                                              
*-       Process control lines.                                                 
*-                                                                              
         IF    CPNEDSET.X'80',BEGIN  It's a control line...                     
         SET   USEFNOCTL             If extend edit, no *CTL%%%%                
         CLEAR USEFRECOV                                                        
         IF    (@R1,EQ,'VIEW='),BEGIN  Set VIEW info                            
         VCALL RTRIM                                                            
         VCALL SETVINFO                                                         
         END                                                                    
         B     ORTNDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   CHECK FILE FOR CONTROL LINES                 
         XPUSH R0,R1                                                            
         IF    ((USETCNT,EQ,1),AND,(@R1,EQ,=CL8'*CTL%%%%')),BEGIN               
         IF    ((^USEFRECOV),AND,(^USEFNOCTL)),BEGIN                            
         LS    R2,R3,'*CTL%%%%MULTIPLE FILE FORMAT VERSION 00.00'               
         IF    (R3,EQ,R0),BEGIN                                                 
         DEX   R3,' CLC @R2(0),@R1 '                                            
         IF    EQ,BEGIN                                                         
         SET   USEFRECOV                                                        
         TSEG  'Processing multiple active files.',,CR                          
         TWRITE                                                                 
         IF    ((USESKIP,NE,0),OR,(USECOUNT,NE,0)),BEGIN                        
         TSEG  'SKIP and/or COUNT options ignored.',,CR                         
         TWRITE                                                                 
         END                                                                    
         END                                                                    
         END                                                                    
         END                                                                    
         END                                                                    
         XPOP  R0,R1                                                            
*                                                                               
         COMMENT                   IF MULTIPLE ACTIVES,                         
         COMMENT                   PROCESS SEPARATELY                           
         IF    USEFRECOV,BEGIN                                                  
         ACALL USEMULT                                                          
         B     ORTNDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   FIGURE UPPER LIMIT IF ANY                    
         L     R3,=F'1000000000'                                                
         IF    (USECOUNT,NE,0),BEGIN                                            
         L     R3,USESKIP                                                       
         A     R3,USECOUNT                                                      
         END                                                                    
*                                                                               
         COMMENT                   PUT LINE IF SKIP/COUNT LIMIT OK              
         L     R2,USETCNT                                                       
         IF    ((R2,GT,USESKIP),AND,(R2,LE,R3)),BEGIN                           
         L     R15,CPLCNO                                                       
         VCALL PUTLINE                                                          
         END                                                                    
*                                                                               
         COMMENT                   IF MORE THAN COUNT, STOP                     
         L     R2,USETCNT                                                       
         IF    (R2,GT,R3),BEGIN                                                 
         SET   CPFRQUIT QUIT RANGE                                              
         END                                                                    
*                                                                               
ORTNDONE LABEL ,                                                                
         PEND  ,                                                                
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*                                                                               
*  DUMMY ROUTINES                                                               
*                                                                               
*                                                                               
CHKPASSW XPROC ,                   ASSUME PASSWD OK                             
         CLEAR R15                                                              
         PEND  ,                                                                
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
         TITLE 'OSRENAME Command'                                               
*                                                                               
*                                                                               
*  OSRENAME                                                                     
*                                                                               
*                                                                               
*  MINAMAL WORK DONE BY THIS ROUTINE.                                           
*  WE CALL DEVICE DEPENDENT ROUTINES TO DO RENAME.                              
*  WE CALL DEVICE DEPENDENT ROUTINES AS FOLLOWS:                                
*    R1,R0 - OLD NAME LENGTH                                                    
*    R2,R3 - NEW NAME LENGTH                                                    
*    ON EXIT FFRNAME IS NEW FULLY RESOLVED NAME.                                
*    DEVICE ROUTINE PRINTS MESSAGE ABOUT RENAME.                                
*                                                                               
*  NOTE,CAUTION!                                                                
*  THE RENAME IS A BIT GRIMY AND UNUSUAL IN THAT                                
*  IT HAS TO DEAL WITH 2 FILE NAMES. THE FILE NAME                              
*  SCANNING ROUTINES ARE NOT BUILT TO DO THAT. WE                               
*  THEREFORE TAKE SOME LIBERTIES WITH THE NAME                                  
*  RESOLVING ROUTINES BY RESOLVING 2 FILE NAMES.                                
*  I THINK THIS IS OK, BUT IT IS NOT AN EXPECTED                                
*  USE OF THESE FILE SCANING/NAME RESOLVING ROUTINES.                           
*                                                                               
*  NOTE:                                                                        
*  THE OLD FILE NAME DETERMINES THE FILE TYPE.                                  
*  THE FILE OPTIONS (EG. USER) ARE APPLIED TO BOTH                              
*  OLD AND NEW FILE NAMES BY NAME RESOLVE ROUTINE.                              
*  SEE ABOVE COMMENTS.                                                          
*                                                                               
*                                                                               
RNWA     RECORD BEGIN                                                           
RNCMDL   DS    F                                                                
RNCMD    DS    CL(&LINESZ)                                                      
RNNEWL   DS    F                   NEW NAME                                     
RNNEW    DS    CL(L'FFNAME)                                                     
RNRNEWL  DS    F                   FULL RESOLVED NEW NAME                       
RNRNEW   DS    CL(L'FFNAME)                                                     
RNOLDL   DS    F                   OLD NAME                                     
RNOLD    DS    CL(L'FFNAME)                                                     
RNROLDL  DS    F                   FULL RESOLVED OLD NAME                       
RNROLD   DS    CL(L'FFNAME)                                                     
         END                                                                    
*                                                                               
*                                                                               
OSRENAME XPROC RNWA                                                             
         LA    R6,RNWA                                                          
         USING RNWA,R6                                                          
         CLEAR RNWA                                                             
*                                                                               
         VCALL MKFFINFO                                                         
         L     R5,CPFINFOP                                                      
         USING FFINFO,R5                                                        
*                                                                               
         COMMENT                   SAVE RENAME COMMAND                          
         SCINFO                                                                 
         LR    R2,R0                                                            
         ST    R2,RNCMDL                                                        
         MOVE  R2,RNCMD,@R1                                                     
*                                                                               
         COMMENT                   SCAN FIRST NAME                              
         VCALL DOFNAME                                                          
*                                                                               
         COMMENT                   SCAN OTHER OPTIONS                           
         SCAN  RNAMEPRT                                                         
         SCANCHK                                                                
*                                                                               
         IF    (RNNEWL,Z),BEGIN                                                 
         ERROR 'Missing new file name.'                                         
         END                                                                    
*                                                                               
         COMMENT                   DETERMINE FILE TYPE                          
         VCALL FNAMEFIN                                                         
*                                                                               
         COMMENT                   PROCESS (RESOLVE) FILE NAMES                 
         COMMENT                   PROCESS OLD NAME                             
         IF    (FFFSAM,OR,FFFNET),BEGIN                                         
         VCALL NRESOLVE                                                         
         L     R2,FFNAMEL                                                       
         ST    R2,RNOLDL                                                        
         MOVE  R2,RNOLD,FFNAME                                                  
         L     R2,FFRNAMEL                                                      
         ST    R2,RNROLDL                                                       
         MOVE  R2,RNROLD,FFRNAME                                                
         COMMENT                   PROCESS NEW NAME                             
         CLEAR FFNAMEL                                                          
         CLEAR FFRNAME                                                          
         L     R2,RNNEWL                                                        
         ST    R2,FFNAMEL                                                       
         MOVE  R2,FFNAME,RNNEW                                                  
         VCALL NRESOLVE                                                         
         L     R2,FFRNAMEL                                                      
         ST    R2,RNRNEWL                                                       
         MOVE  R2,RNRNEW,FFRNAME                                                
         END                                                                    
*                                                                               
*                                                                               
         COMMENT                   IF SAMSON FILE                               
         IF    FFFSAM,BEGIN                                                     
         L     R0,RNROLDL                                                       
         LA    R1,RNROLD                                                        
         LA    R2,RNRNEW                                                        
         L     R3,RNRNEWL                                                       
         VCALL SAMREN              DO RENAME                                    
         BNZ   CVABORT                                                          
         IF    CPLFLG3.CPFSET,BEGIN                                             
         VCALL SETPFXNS                                                         
         END                                                                    
         TSEG  RNROLD,L:RNROLDL    GIVE MSG                                     
         TSEG  ' renamed to '                                                   
         TSEG  RNRNEW,L:RNRNEWL                                                 
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
*                                                                               
         COMMENT                   IF NET FILE,                                 
         IF    FFFNET,BEGIN                                                     
         L     R0,RNROLDL                                                       
         LA    R1,RNROLD                                                        
         LA    R2,RNRNEW                                                        
         L     R3,RNRNEWL                                                       
         VCALL NETREN              NOT IMPLEMENTED, DUMMY ROUTINE               
         BNZ   CVABORT                                                          
         IF    CPLFLG3.CPFSET,BEGIN                                             
         VCALL SETPFXNS                                                         
         END                                                                    
         TSEG  RNROLD,L:RNROLDL    GIVE MSG                                     
         TSEG  ' renamed to '                                                   
         TSEG  RNRNEW,L:RNRNEWL                                                 
         IF    (FFHOSTL,NZ),BEGIN                                               
         TSEG  ' on '                                                           
         TSEG  FFHOST,L:FFHOSTL                                                 
         END                                                                    
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
*                                                                               
         IF    (FFFWINGS,OR,FFFOLD),BEGIN                                       
         VCALL NRESOLVE            Get fully-qualified oldname                  
         L     R2,FFNAMEL                                                       
         ST    R2,RNOLDL                                                        
         MOVE  R2,RNOLD,FFNAME                                                  
         L     R2,FFRNAMEL                                                      
         ST    R2,RNROLDL                                                       
         MOVE  R2,RNROLD,FFRNAME     and put it in RNROLD                       
         COMMENT                   Check the old name to                        
         LA    R1,RNROLD             determine whether or not                   
         L     R0,RNROLDL              it includes a member                     
         VCALL RETFNAME                                                         
         IF    (R0,LT,RNROLDL),BEGIN   It's a member rename                     
*                                                                               
*  Create the newname by concatenating the dsname portion of                    
*  the oldname with a '#' followed by the newname (which must                   
*  be a membername).                                                            
*                                                                               
         LR    R2,R0                                                            
         MOVE  R2,FFNAME,@R1         Move in the old dsname                     
         L     R2,RNNEWL                                                        
         LA    R1,RNNEW                                                         
         IF    (@R1,NE,'#'),BEGIN    We need to add a '#'                       
         LA    R3,FFNAME                                                        
         AR    R3,R0                                                            
         MVI   0(R3),C'#'                                                       
         INCR  R0                                                               
         END                                                                    
         LR    R3,R0                 Append the newname                         
         AR    R3,R2                                                            
         ST    R3,FFNAMEL                                                       
         LA    R3,FFNAME                                                        
         AR    R3,R0                                                            
         MOVE  R2,@R3,@R1            Now have correct newname                   
         END                                                                    
         ELSE  BEGIN                 Simple dataset rename                      
         L     R2,RNNEWL                                                        
         ST    R2,FFNAMEL                                                       
         MOVE  R2,FFNAME,RNNEW                                                  
         END                                                                    
         CLEAR FFRNAME                                                          
         CLEAR FFRNAMEL                                                         
         VCALL NRESOLVE                                                         
         L     R2,FFRNAMEL                                                      
         ST    R2,RNRNEWL                                                       
         MOVE  R2,RNRNEW,FFRNAME                                                
         L     R2,RNROLDL                                                       
         ST    R2,FFNAMEL                                                       
         MOVE  R2,FFNAME,RNROLD                                                 
*                                                                               
*  New file name is already in FFRNAME                                          
*                                                                               
RENOK    VCALL WGSRENAM                                                         
         IF    NZ,BEGIN                                                         
         TWRITE  ,                                                              
*        IF (CPERRID,EQ,'NOTYOURS'),BEGIN                                       
*        COMMENT                   IF NO ACCESS, ASK FOR PASSWORD               
*        CLEAR CPFQUIET            Force warning to be printed                  
*        CLEAR CPERRID                                                          
*        ACALL RENGETPS                                                         
*        L     R2,RNRNEWL                                                       
*        ST    R2,FFRNAMEL                                                      
*        MOVE  R2,FFRNAME,RNRNEW                                                
*        B     RENOK                                                            
*        END                                                                    
         B     CVABORT                                                          
         END                                                                    
*  If SET requested, set existing to newdsn                                     
         IF    CPLFLG3.CPFSET,BEGIN                                             
         L     R2,RNRNEWL                                                       
         ST    R2,FFRNAMEL                                                      
         MOVE  R2,FFRNAME,RNRNEW                                                
         VCALL SETPFXNS            Set existing                                 
         END                                                                    
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
*                                                                               
         PEND                                                                   
         EJECT                                                                  
*                                                                               
*  RENAME OPTIONS                                                               
*                                                                               
RNAMEPRT SCKW  ,RNMISS,NULL                                                     
         SCKW  TO,RNAMETO                                                       
         SCKW  ,V(FNAMPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  SET,RENSET                                                       
         SCKW  NOSET,RENNOSET,A                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
RENSET   PROC  ,                                                                
         SET   CPLFLG3.CPFSET                                                   
         PEND                                                                   
*                                                                               
RENNOSET PROC  ,                                                                
         CLEAR CPLFLG3.CPFSET                                                   
         PEND                                                                   
*                                                                               
RNMISS   PROC                                                                   
         ERROR 'Missing new file name.'                                         
         PEND                                                                   
*                                                                               
RNAMETO  PROC                                                                   
         SCANSTR                                                                
         SCANCHK                                                                
         IF    (R0,Z),BEGIN                                                     
         ERROR 'Missing new file name.'                                         
         END                                                                    
         LR    R2,R0                                                            
         ST    R2,RNNEWL                                                        
         MOVE  R2,RNNEW,@R1                                                     
         CLEAR R15                                                              
         PEND                                                                   
*                                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  RENGETPS - WE NEED PASSWORD TO RENAME THIS FILE                              
*                                                                               
*  THIS ROUTINE ASKS USER FOR (MAINFRAME) PASSWORD.  IF USER                    
*  KNOWS PASSWORD, THIS ROUTINE SETS THE APPROPRIATE FLAG                       
*  IN THE FFINFO BLOCK.                                                         
*  THIS ROUTINE APPLIES ONLY TO WINGS *  FILE SYSTEM.                           
*                                                                               
*  ON ENTRY:                                                                    
*  'NOT YOURS' MSG IS TSEG'D.  WE DECIDE WHETHER TO PURGE                       
*  OR PRINT TSEG'D MSG BELOW.                                                   
*                                                                               
*  NOTE:                                                                        
*  IF 'SET ACCOUNT ... PASS ...' OWNS DATA SET WE DO NOT                        
*  ISSUE ERROR MSG, AND DO *NOT* PROMPT FOR PASSWORD.                           
*                                                                               
*  NOTE:                                                                        
*  IF NO ACCOUNT ASSOCIATED WITH THE DATA SET, THEN                             
*  WE PROMPT FOR THE ACCOUNT GS.WYL.  WHICH ONLY SYSTEMS                        
*  TYPES CAN GUESS.  YES!                                                       
*                                                                               
*                                                                               
RENGETPS PROC  GETPWWA                                                          
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   IF NOT WINGS, ERR                            
         COMMENT ,                 (IE. NO 'NOTYOURS' FOR NET,                  
         IF    ^FFFWINGS,BEGIN      SAMSON, ETC.)                               
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         COMMENT                   SET UP KWR                                   
         LA    R4,GETPWKWR                                                      
         USING KWR,R4                                                           
         CLEAR KWR                                                              
*                                                                               
         COMMENT                   SET ACCOUNT FROM DATA SET NAME               
         SETMSG FFRNAME,L:FFRNAMEL                                              
         IF    ((R0,GT,11),AND,(@R1,EQ,'WYL.'),AND,                    X        
               (@R1+6,EQ,'.'),AND,(@R1+10,EQ,'.')),BEGIN                        
         MVC   KWRGRP,@R1+4        SET DATA SET ACCOUNT                         
         MVC   KWRUSER,@R1+7                                                    
         END                                                                    
         ELSE  BEGIN               SET DEFAULT OWNER ACCOUT                     
         MVC   KWRGRP,=CL2'GS'                                                  
         MVC   KWRUSER,=CL3'WYL'                                                
         END                                                                    
*                                                                               
         COMMENT                   CHECK PASSWORD                               
         CLEAR R0                  GETKWR OPTION                                
         LA    R1,KWR                                                           
         VCALL GETKWR                                                           
         CLEAR R15                 RETURNS ONLY IF OK                           
*                                                                               
         COMMENT                   IF PASSWORD OK, ADD TO OPTIONS               
         SET   FFFPASSW            PASSWORD IS OK                               
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         DROP  R4                                                               
         EJECT                                                                  
         TITLE 'SCRATCH Command'                                                
*box                                                                            
*                                                                               
*  SCRATCH -- SCRATCH command.                                                  
*                                                                               
*  updated by ch 6/91.  some prep was done so that                              
*  command can handle future wings expansion.  it                               
*  allows net/samson to not be dependent on DSNWA.                              
*                                                                               
*  Modified 10/94 by MPD to add Wings support.                                  
*                                                                               
*                                                                               
SCRATCH  XPROC ,                                                                
         COMMENT                   Get file info dsect                          
         VCALL MKFFINFO                                                         
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   Scan file name, command                      
         VCALL DOFNAME                                                          
         SCAN  SCRPRT                                                           
         SCANCHK                                                                
         VCALL FNAMEFIN            Finish up dsnames                            
         VCALL NRESOLVE            (needed for set prefix)                      
*                                                                               
*                                                                               
         COMMENT                   If samson file scratch                       
         IF    FFFSAM,BEGIN                                                     
         VCALL SAMSCR              Do Samson SCRATCH                            
         BNZ   CVABORT             It didn't work, scram                        
         VCALL SEGDSN                                                           
         TSEG  'scratched '                                                     
         IF    (FFHOSTL,NZ),'TSEG "on "; TSEG FFHOST,L:FFHOSTL,T'               
         B     SCRSET                                                           
         END                                                                    
*                                                                               
*                                                                               
         COMMENT                   If network file scratch                      
         IF    FFFNET,BEGIN                                                     
         VCALL NETSCR              Do network SCRATCH                           
         BNZ   CVABORT             It didn't work, scram                        
         VCALL SEGDSN                                                           
         TSEG  'scratched '                                                     
         IF    (FFHOSTL,NZ),'TSEG "on "; TSEG FFHOST,L:FFHOSTL,T'               
         B     SCRSET                                                           
         END                                                                    
*                                                                               
         COMMENT                   If WINGS file scratch                        
         IF    FFFWINGS,BEGIN                                                   
SCRTOK   VCALL WGSCRTCH            Do Wings SCRATCH                             
         IF    NZ,BEGIN                                                         
         IF (CPERRID,EQ,'NOMEMBER'),BEGIN                                       
         IF    CPFDUMP,CVABORT                                                  
         SETMSG 'Scratch the entire library'                                    
         VCALL YESREQ              Go prompt user                               
         SET   FFFPDS              Set flag for dscratch                        
         CLEAR CPERRID                                                          
         B     SCRTOK              Go do scratch                                
         END                                                                    
*                                                                               
*        IF (CPERRID,EQ,'NOTPDS  '),BEGIN                                       
*        IF    CPFDUMP,CVABORT                                                  
*        SETMSG 'Scratch'                                                       
*        VCALL YESREQ              Go prompt user                               
*                                                                               
*   Remove the member name from the fully-qualified file                        
*   name and resubmit the command.                                              
*                                                                               
*        L     R0,FFRNAMEL                                                      
*        LA    R1,FFRNAME                                                       
*        VCALL RETFNAME                                                         
*        ST    R0,FFRNAMEL                                                      
*        CLEAR CPERRID                                                          
*        B     SCRTOK              Try scratch again                            
*        END                                                                    
*                                                                               
         IF (CPERRID,EQ,'NOTYOURS'),BEGIN                                       
         COMMENT                   IF NO ACCESS, ASK FOR PASSWORD               
         TWRITE                                                                 
         CLEAR CPERRID                                                          
         ACALL GETPASSW                                                         
         B     SCRTOK                                                           
         END                                                                    
         B     CVERROR                                                          
         END                                                                    
         END                                                                    
*                                                                               
* Scratch completed ok. Set the prefix if requested.                            
* WYLBUR used to set the prefix regardless of successful                        
* completion, but that's probably not a good idea.                              
*                                                                               
*    MPD 10/19/94                                                               
*                                                                               
SCRSET   IF    CPLFLG3.CPFSET,'VCALL SETPFXNS'  Set prefix                      
         B     CVNEXT                                                           
         PEND  ,                                                                
         QLTORG ,                                                               
         DROP  R6                                                               
         TITLE 'SCKWs and Remote MVCs'                                          
*-                                                                              
*-       Scratch command options.                                               
*-                                                                              
SCRPRT   SCKW  UNCATLG,FNAMEKW,A             (Compatability)                    
         SCKW  UNCATALOG,FNAMEKW,A           (Compatability)                    
         SCKW  NOCATALOG,FNAMEKW,A                                              
         SCKW  PDS,SCRPDS                                                       
         SCKW  EXPDT,SCREXPDT,A                                                 
         SCKW  ERASE,FNAMEKW,A                                                  
         SCKW  RETAIN,FNAMEKW,A                                                 
         SCKW  NORETAIN,FNAMEKW,A                                               
         SCKW  SET,SSNSET                                                       
         SCKW  NOSET,SSNNOSET,A                                                 
         SCKW  ,V(FNAMPSH),PUSH                                                 
         SCKW  ,V(QUIETPSH),PUSH                                                
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
SCRPDS   PROC                                                                   
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFPDS                                                           
         DROP  R6                                                               
         PEND                                                                   
*                                                                               
SCREXPDT PROC                                                                   
         IF    ^CPSFSPR,'VCALL NOTVALID'  priv'd request                        
         ACALL FNAMEKW                                                          
         PEND                                                                   
*                                                                               
         EJECT                                                                  
         TITLE 'ALLOCATE Command'                                               
*box                                                                            
*                                                                               
*  ALLOCATE -- ALLOCATE command.                                                
*                                                                               
ALLOCATE XPROC ,                                                                
         CLEAR (DSNWADSN,DSAVSIZ)                                               
*-                                                                              
*-      The following code is dedicated to a happy SPIRES community.            
*-       (If you don't have a happy SPIRES community, then feel free            
*-       to remove it!)                                                         
*-                                                                              
         IF    CPOFNPAS,BEGIN      SPIRES bit...                                
         OSCSAVE                                                                
         OSCAN ,                   (Dsname)                                     
         IF    (@R15,EQ,'ORV.'),'VCALL ORVCPASS'  Send to SPIRES                
         OSCRSTR                                                                
         END                                                                    
*                                                                               
         COMMENT                   Get file info dsect                          
         VCALL MKFFINFO                                                         
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   Scan file name, command                      
         VCALL DOFNAME                                                          
*                                                                               
         SET   CPFVER              Verify is the default                        
         SCAN  ALLOPRT                                                          
         SCANCHK                                                                
         VCALL FNAMEFIN            Finish up dsnames                            
         VCALL NRESOLVE            Resolve to exact filename                    
*                                                                               
         IF    ^FFFWINGS,BEGIN                                                  
         ERROR 'Allocate is only valid for MVS files'                           
         END                                                                    
*                                                                               
         IF    ((FFRNAMEL,EQ,15),AND,                                  X        
               (FFRNAME+11,EQ,'MAIL')),BEGIN                                    
         ERROR 'Please use the SET MAIL command to open a mailbox.'             
         END                                                                    
*                                                                               
*                                                                               
DOALLO   VCALL WGSALLOC            Do Wings Allocate                            
         IF    NZ,BEGIN                                                         
         IF (CPERRID,EQ,'NOTYOURS'),BEGIN                                       
         COMMENT                   IF NO ACCESS, ASK FOR PASSWORD               
         TWRITE                                                                 
         CLEAR CPERRID                                                          
         ACALL GETPASSW                                                         
         B     DOALLO                                                           
         END                                                                    
         IF (CPERRID,EQ,'DIFFVOL'),BEGIN                                        
         TWRITE ,                                                               
         CLEAR CPERRID                                                          
         TSEG  'Do you want to use '                                            
         TSEG  FFHOST,L:FFHOSTL                                                 
         SETMSG ' anyway'                                                       
         VCALL YESRTN                                                           
         IF    NZ,BEGIN                                                         
         TSEG  'No action taken.'                                               
         B     CVNEXT                                                           
         END                                                                    
         SET   FFFDIFFV                                                         
         B     DOALLO                                                           
         END                                                                    
         B     CVERROR                                                          
         END                                                                    
*                                                                               
* Allocate completed ok. Set the prefix if requested.                           
* WYLBUR used to set the prefix regardless of successful                        
* completion, but that's probably not a good idea.                              
*                                                                               
*    MPD 11/14/94                                                               
*                                                                               
         IF    CPLFLG3.CPFSET,'VCALL SETPFXNS'  Set prefix                      
         B     CVNEXT                                                           
         PEND  ,                                                                
         QLTORG ,                                                               
         DROP  R6                                                               
         EJECT                                                                  
ALLOPRT  SCKW TRACKS,FNAMEOPT,A                                                 
         SCKW SEQUENTIAL,FNAMEKW,A                                              
         SCKW BLOCKS,FNAMEOPT,A                                                 
         SCKW DIRECTORY,FNAMEOPT,A                                              
         SCKW MEMBERS,FNAMEOPT,A                                                
         SCKW KILOBYTES,FNAMEOPT,A                                              
         SCKW KBYTES,FNAMEOPT,A                                                 
         SCKW KB,FNAMEOPT                                                       
         SCKW MEGABYTES,FNAMEOPT,A                                              
         SCKW MBYTES,FNAMEOPT,A                                                 
         SCKW MB,FNAMEOPT                                                       
         SCKW CYLINDERS,FNAMEOPT,A                                              
         SCKW SECONDARY,FNAMEOPT,A                                              
         SCKW CATLG,FNAMEKW,A                                                   
         SCKW CATALOG,FNAMEKW,A                                                 
         SCKW NOCATALOG,FNAMEKW,A                                               
         SCKW ,V(FNAMPSHF),PUSH                                                 
         SCKW ,FNAMPSHS,PUSH                                                    
         SCKW ,V(VERPSH),PUSH                                                   
         SCKW ,V(QUIETPSH),PUSH                                                 
         SCKW ,V(SMSPSH),PUSH                                                   
         SCKW ,V(NOTVALID)                                                      
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
         TITLE 'CATALOG/UNCATALOG/RECATALOG Commands'                           
*box                                                                            
*                                                                               
*  CATALOG -- CATALOG/UNCATALOG/RECATALOG commands.                             
*                                                                               
CATALOG  XPROC ,                                                                
         CLEAR (DSNWADSN,DSAVSIZ)                                               
         IF    (CPCMNM,EQ,'U'),'SET CPFUNCAT'  Uncatalog                        
         IF    (CPCMNM,EQ,'R'),'SET CPFRECAT'  Recatalog                        
*                                                                               
         COMMENT                   Get file info dsect                          
         VCALL MKFFINFO                                                         
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   Scan file name, command                      
         VCALL DOFNAME                                                          
*                                                                               
         IF (CPFUNCAT),BEGIN                                                    
         SCAN  UNCATPRT                                                         
         END                                                                    
         ELSE  BEGIN                                                            
         SCAN  CATLGPRT                                                         
         END                                                                    
         SCANCHK                                                                
         VCALL FNAMEFIN            Finish up dsnames                            
         VCALL NRESOLVE            Resolve to exact filename                    
*                                                                               
         SET   FFFWINGS                                                         
*                                                                               
         IF    ((FFRNAMEL,EQ,15),AND,                                  X        
               (FFRNAME+11,EQ,'MAIL')),BEGIN                                    
         ERROR 'Please use the SET MAIL command to open a mailbox.'             
         END                                                                    
*                                                                               
         CLEAR R0                  Assume CATALOG                               
         IF    (CPFUNCAT),'LA R0,1'      Positive = UNCAT                       
         IF    (CPFRECAT),'BCTR R0,R0'   Negative = RECAT                       
         VCALL WGSCATLG            Do Wings Catalog                             
         IF    NZ,BEGIN                                                         
         B     CVERROR                                                          
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
         PEND  ,                                                                
         QLTORG ,                                                               
         DROP  R6                                                               
         EJECT                                                                  
CATLGPRT SCKW UNIT,FNAMEOPT,A                                                   
         SCKW FILESEQ,FNAMEOPT,A                                                
UNCATPRT SCKW ,V(FNAMPSH),PUSH                                                  
         SCKW ,V(QUIETPSH),PUSH                                                 
         SCKW ,V(NOTVALID)                                                      
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
         TITLE 'PRELIMINARY FILE NAME SCANNING'                                 
*box                                                                            
*                                                                               
*                                                                               
*  FILE NAME AND FILE SYSTEM PRELIMINARY SCANNING.                              
*                                                                               
*  THESE ROUTINES SCAN THE FILE NAME.                                           
*  THE NAMES ARE NOT PROCESSED HERE.  FILE NAMES                                
*  ARE RESOLVED BASED ON FILE SYSTEM TYPE BY EACH                               
*  SEPARATE OPEN ROUTINE.  HERE WE MERELY                                       
*  COLLECT THE FILE NAME,  FILE SYSTEM, AND                                     
*  FILE OPTIONS.                                                                
*                                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  MKFFINFO - CREATE (MAKE) AND INITIALIZE A FFINFO                             
*        DSECT WORK AREA ON THE HEAP.                                           
*                                                                               
*  ON EXIT:                                                                     
*    CPFINFOP - CONTAINS ADDRESS OF THE FFINFO DSECT                            
*                                                                               
*  NOTE:                                                                        
*  THIS ROUTINE MAY BE CALLED MULTIPLE TIMES, ONLY                              
*  ONE DSECT WILL BE CREATED.  THIS IS SO IF ONE                                
*  CAN BE AUTOMATICALLY OR EXPLICITLY CREATED FOR THE                           
*  CALLING ROUTINES.                                                            
*                                                                               
*  THE DSECT IS INITIALIZED TO ZEROS. WITH THE EXCEPTION                        
*  THAT THE PREVIOUS FILE NAME/HOST/TYPE IS SAVED IS THE                        
*  WORKAREA.  (NOTE; THE PREVIOUS REALLY IS THE CURRENT                         
*  FILE NAME/HOST/TYPE. BUT IT MAY SOON BE PREVIOUS IF                          
*  THIS IS A 'USE XYZ ..' COMMAND)                                              
*                                                                               
*                                                                               
MKFFINFO XPROC ,                                                                
*                                                                               
         COMMENT                   IF NEEDED, MAKE FFINFO DSECT                 
         IF    (CPFINFOP,EQ,0),BEGIN                                            
*                                                                               
         COMMENT                   GET HEAP SPACE                               
         L     R0,=A(L'FFINFO)                                                  
         VCALL GETHEAP                                                          
         ST    R1,CPFINFOP                                                      
*                                                                               
         LR    R6,R1                                                            
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   INITIALIZE                                   
         LA    R2,FFINFO                                                        
         LA    R3,L'FFINFO                                                      
         CLEAR R5                                                               
         MVCL  R2,R4               CLEAR FFINFO DSECT                           
         COMMENT                   SET PREVIOUS FILE NAME/HOST/TYPE             
         MVC   FFPTYPE,CPAFTYPE                                                 
         MVC   FFPNAMEL,CPAFNAMEL                                               
         MVC   FFPNAME,CPAFNAME                                                 
         MVC   FFPHOSTL,CPAHOSTL                                                
         MVC   FFPHOST,CPAHOST                                                  
*                                                                               
         END   , NEED NEW FFINFO DSECT                                          
*                                                                               
         PEND  ,                                                                
         EJECT                                                                  
*                                                                               
*                                                                               
*  DOFNAME - SCAN FILE NAME                                                     
*                                                                               
*  ON ENTRY:                                                                    
*  SCAN CONTROL BLOCK POINTS TO NAME TO SCAN                                    
*                                                                               
*  ALL ERRORS EXIT VIA CVERROR                                                  
*                                                                               
*                                                                               
DOFNAME  XPROC ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         ACALL MKFFINFO            CREATE FFINFO DSECT, IF NEEDED               
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SCAN FILE NAME                               
         COMMENT                   DO BLANK DELIMITED SCAN                      
         SCANSTR ,                 SKIP=' ', STOP=' ,=;'                        
         SCANCHK ,                                                              
*                                                                               
         COMMENT                   IF NORMAL SCAN                               
         IF    ((R15,Z),AND,(R0,POS)),BEGIN                                     
         IF    ((@R1,EQ,'"'),OR,(@R1,EQ,'''')),'VCALL LOGCMD'                   
         ST    R0,FFNAMEL                                                       
         LR    R3,R0                                                            
         DEX   R3,'MVC FFNAME(0),@R1'                                           
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    ((R15,Z),AND,(R0,NP)),BEGIN                                  
         ERROR 'Missing file name. '                                            
         END                                                                    
*                                                                               
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  FNAMESCN - SCAN FILE NAME                                                    
*                                                                               
*  ENTERED AS SCKW PROCESSING ROUTINE. EG. --                                   
*  SCKW FROM,V(DSNSCAN)                                                         
*  -- WE SCAN AND SAVE THE NAME.                                                
*                                                                               
*  ON ENTRY:                                                                    
*    SCAN CONTROL BLOCK POINTS TO FILE NAME TO SCAN                             
*                                                                               
*  ON EXIT:                                                                     
*    IF ERROR, R15=NZ, AND ERROR MSG PUT IN SCAN CONTROL BLOCK                  
*                                                                               
*                                                                               
*                                                                               
FNAMESCN XPROC ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         ACALL MKFFINFO            CREATE FFINFO DSECT, IF NEEDED               
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SCAN FILE NAME                               
         COMMENT                   DO BLANK DELIMITED SCAN                      
         SCANSTR ,                 SKIP=' ', STOP=' ,=;'                        
*                                                                               
         COMMENT                   IF SCAN ERROR,                               
         IF    (R15,NZ),BEGIN      JUST RETURN R15=NZ                           
         END                                                                    
         COMMENT                   IF NORMAL SCAN                               
         ELSEIF    ((R15,Z),AND,(R0,POS)),BEGIN                                 
         ST    R0,FFNAMEL                                                       
         LR    R3,R0                                                            
         DEX   R3,'MVC FFNAME(0),@R1'                                           
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    ((R15,Z),AND,(R0,NP)),BEGIN                                  
         SCSEGCLR                                                               
         SCSEG 'Missing file name. '                                            
         L     R15,=F'-4'                                                       
         END                                                                    
*                                                                               
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*                                                                               
*  SCAN FILE OPTIONS                                                            
*                                                                               
*                                                                               
FILEOPTS XPROC ,                                                                
         SCAN  FOPTSPRT                                                         
         SCANCHK                                                                
         PEND                                                                   
*                                                                               
FOPTSPRT SCKW  ,FNAMPSH,PUSH                                                    
         SCKW  ,V(SCNINVAL)                                                     
*                                                                               
*  SCAN FILE OPTIONS W/FORMAT OPTIONS INCLUDED                                  
*                                                                               
*                                                                               
FILFOPTS XPROC  ,                                                               
         SCAN   FFOPTSPRT                                                       
         SCANCHK                                                                
         PEND                                                                   
*                                                                               
FFOPTSPRT SCKW ,FNAMPSHF,PUSH                                                   
         SCKW  ,V(SCNINVAL)                                                     
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*                                                                               
*                                                                               
*   ROUTINES TO DO PRELIMINARY SCANNING OF FILE OPTIONS                         
*                                                                               
*                                                                               
*   FNAMPRTF - FILE NAME OPTIONS, FILE FORMAT OPTIONS, ETC                      
*   FNAMPRT - FILE NAME OPTIONS                                                 
*   FNONPRT - FILE SYSTEM NAME ONLY                                             
*                                                                               
*   NOTE:                                                                       
*   ALL FILE OPTIONS MUST BE LISTED IN THE FOLLOWING TABLE                      
*   EVEN THOUGH NO PROCESSING OF THESE OPTIONS TAKES PLACE                      
*   HERE.                                                                       
*                                                                               
*                                                                               
FNAMPSH  XPUSHRTN FNAMPRT                                                       
*                                                                               
FNAMPSHF XPUSHRTN FNAMPRTF                                                      
*                                                                               
FNAMPSHS PUSHRTN FNAMPRTS                                                       
*                                                                               
FNONPSH  XPUSHRTN FNONPRT                                                       
*                                                                               
SMSPSH   XPUSHRTN SMSPRT                                                        
*                                                                               
*  FILE NAME OPTIONS,  VALID ON SAVE, INCLUDES ALL OPTIONS                      
*                                                                               
FNAMPRTS SCKW  BLKSIZE,FNAMEOPT,A                                               
         SCKW  ,FNAMEKW,V(MPAREN) MATCH '(<NNNN>)' RECORD COUNT                 
         SCKW  RECFM,FNAMEOPT,A                                                 
         SCKW  TITLE,FNAMEOPT,A                                                 
         SCKW  CATALOG,FNAMEKW,A                                                
         SCKW  CATLG,FNAMEKW,A                                                  
         SCKW  NOCATALOG,FNAMEKW,A                                              
         SCKW  NOCATLG,FNAMEKW,A                                                
         SCKW  RECATALOG,FNAMEKW,A                                              
         SCKW  RECATLG,FNAMEKW,A                                                
         SCKW  UNCATALOG,FNAMEKW,A                                              
         SCKW  STREAM,FNAMEKW,A                                                 
         SCKW  EXPDT,FNAMEKW,A                                                  
*                                                                               
*  FILE NAME OPTIONS VALID ON USE, LIST FROM ,, COPY FROM ETC                   
*  INCLUDES FORMAT TYPE OPTIONS                                                 
*                                                                               
FNAMPRTF SCKW  EDIT,FNAMEKW,A                                                   
         SCKW  NEWEDIT,FNAMEKW,A                                                
         SCKW  OLDEDIT,FNAMEKW,A                                                
         SCKW  CARD,FNAMEKW,A                                                   
         SCKW  PRINT,FNAMEKW,A                                                  
         SCKW  TABS,FNAMEKW,A                                                   
         SCKW  NOTABS,FNAMEKW,A                                                 
         SCKW  UNFORMATTED,FNAMEKW,A                                            
         SCKW  FORMATTED,FNAMEKW,A                                              
         SCKW  TEXTONLY,FNAMEKW                                                 
         SCKW  TRANSPARENT,FNAMEKW,A                                            
         SCKW  DTRANSPARENT,FNAMEKW,A                                           
         SCKW  ASCII,FNAMEKW,A                                                  
         SCKW  EBCDIC,FNAMEKW,A                                                 
         SCKW  WRAP,FNAMEOPT,A                                                  
         SCKW  SPLIT,FNAMEOPT,A                                                 
         SCKW  LRECL,FNAMEOPT,A                                                 
         SCKW  CODE,FNAMEOPT,A                                                  
         SCKW  INTEGER,FNAMEKW,A                                                
         SCKW  UNNUMBERED,FNAMEKW,A                                             
         SCKW  NUMBERED,FNAMEKW,A                                               
         SCKW  NONUMBER,FNAMEKW,A                                               
         SCKW  SEQFLD,FNAMEOPT,A                                                
*                                                                               
*  FILE NAME OPTIONS, MINIMAL FILE NAME KEYWORDS                                
*  ALLOWS FOR USER/GROUP;  FILE HOST; FILE TYPE; ETC.                           
*                                                                               
FNAMPRT  SCKW  WINGS,FNWINGS                                                    
         SCKW  UNIX,FNUNIX                                                      
         SCKW  SAMSON,FNSAMSON,A                                                
         SCKW  NET,FNNET                                                        
         SCKW  OLDIBM,FNOLDIBM,A                                                
         SCKW  ON,FNAMEON,A                                                     
         SCKW  VOLUME,FNAMEVOL,A                                                
         SCKW  ACCOUNT,FNAMEOPT,A                                               
         SCKW  ACCT,FNAMEOPT,A                                                  
         SCKW  USER,FNAMEOPT,A                                                  
         SCKW  GROUP,FNAMEOPT,A                                                 
         SCKW  GRP,FNAMEOPT                                                     
         SCKW  TEMPORARY,FNAMEKW,A                                              
         SCKW  PUBLIC,FNAMEKW,A                                                 
         SCKW  GUEST,FNAMEKW,A                                                  
         SCKW  NOENQUEUE,FNAMEKW,A                                              
         SCKW  ,,END                                                            
*                                                                               
*  FNONPRT ??? WHAT IS THIS FOR ?? SHOULD BE THE                                
*  EQUIVALENT OF DSNONPRT IN OPT ?? OR WHAT CHECK IT                            
*  OUT I AM NOT SURE NOW - CH FEB. 25 91                                        
*                                                                               
FNONPRT  SCKW  ON,FNAMEON,A                                                     
         SCKW  ,,END                                                            
         EJECT                                                                  
*                                                                               
*  SMS options for ALLOCATE and SAVE                                            
*                                                                               
SMSPRT   SCKW  DATACLAS,FNAMEOPT,A                                              
         SCKW  MGMTCLAS,FNAMEOPT,A                                              
         SCKW  STORCLAS,FNAMEOPT,A                                              
         SCKW  ,,END                                                            
*                                                                               
*  SET FILE TYPE FLAGS                                                          
*                                                                               
*                                                                               
FNWINGS  PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFWINGS                                                         
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
FNUNIX   PROC  ,                                                                
         AIF   (&$PCODE).DOUNIX                                                 
         VCALL NOTVALID                                                         
         AGO   .ENDUNIX                                                         
.DOUNIX  ANOP                                                                   
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFUNIX                                                          
.ENDUNIX ANOP                                                                   
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
FNSAMSON PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFSAM                                                           
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
FNNET    PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFNET                                                           
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
FNOLDIBM PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFOLD                                                           
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  GOT FILE/FILE SYSTEM OPTION KEYWORD                                          
*                                                                               
*                                                                               
FNAMEKW  PROC  ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SEPARATE OPTIONS BY BLANK                    
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MVI   @R4,C' '                                                         
         INCR  R3,FFOPTSL                                                       
*                                                                               
         COMMENT                   ADD KEYWORD TO OPTIONS STRING                
         L     R5,FFOPTSL                                                       
         AR    R5,R0                                                            
         IF    (R5,GE,L'FFOPTS),BEGIN                                           
         SCSEGCLR                                                               
         SCSEG 'File specification overflow.'                                   
         L     R15,=F'-4'                                                       
         B     FNKWEXIT                                                         
         END                                                                    
         LR    R3,R0                                                            
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MOVE  R3,@R4,@R1                                                       
         ST    R5,FFOPTSL                                                       
*                                                                               
         CLEAR R15                                                              
*                                                                               
FNKWEXIT LABEL ,                                                                
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  GOT FILE/FILE SYSTEM OPTION KEYWORD AND VALUE                                
*                                                                               
*                                                                               
FNOWA    RECORD BEGIN                                                           
FNOPTLOC DS    F                                                                
FNOPTLEN DS    F                                                                
         END                                                                    
*                                                                               
*                                                                               
FNAMEOPT PROC  FNOWA                                                            
*                                                                               
         ST    R1,FNOPTLOC                                                      
         ST    R0,FNOPTLEN                                                      
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SEPARATE OPTIONS BY BLANK                    
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MVI   @R4,C' '                                                         
         INCR  R3,FFOPTSL                                                       
*                                                                               
         COMMENT                   ADD KEYWORD TO OPTIONS STRING                
         L     R5,FFOPTSL                                                       
         AR    R5,R0                                                            
         IF    (R5,GE,L'FFOPTS),BEGIN                                           
         SCSEGCLR                                                               
         SCSEG 'File specification overflow.'                                   
         L     R15,=F'-4'                                                       
         B     FNOPEXIT                                                         
         END                                                                    
         LR    R3,R0                                                            
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MOVE  R3,@R4,@R1                                                       
         ST    R5,FFOPTSL                                                       
*                                                                               
         COMMENT                   FOLLOW KEYWORD WITH '='                      
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MVI   @R4,C'='                                                         
         INCR  R3,FFOPTSL                                                       
*                                                                               
         COMMENT                   SCAN FOR KEYWORD VALUE                       
         SCAN  ,                                                                
*                                                                               
         COMMENT                   IF SCAN OK                                   
         IF    ((R15,Z),AND,(R0,POS)),BEGIN                                     
         L     R5,FFOPTSL                                                       
         AR    R5,R0                                                            
         IF    (R5,GE,L'FFOPTS),BEGIN                                           
         SCSEGCLR                                                               
         SCSEG 'File specification overflow.'                                   
         L     R15,=F'-4'                                                       
         B     FNOPEXIT                                                         
         END                                                                    
         LR    R3,R0                                                            
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MOVE  R3,@R4,@R1                                                       
         ST    R5,FFOPTSL                                                       
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    ((R15,Z),AND,(R0,NP)),BEGIN                                  
         SCSEGCLR                                                               
         L     R1,FNOPTLOC                                                      
         L     R0,FNOPTLEN                                                      
         SCSEG (R1),(R0)                                                        
         SCSEG ': missing option. '                                             
         L     R15,=F'-4'                                                       
         B     FNOPEXIT                                                         
         END                                                                    
         COMMENT                   IF SCAN ERROR,                               
         ELSEIF  (R15,NZ),BEGIN    JUST RETURN R15=NZ                           
         END                                                                    
*                                                                               
*                                                                               
         CLEAR R15                                                              
*                                                                               
FNOPEXIT LABEL ,                                                                
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  SCAN ON <FILE SYSTEM>                                                        
*                                                                               
*                                                                               
FNAMEON  PROC  ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SCAN FILE SYSTEM                             
         COMMENT                   USE BLANK DELIMITED SCAN                     
         SCANSTR ,                 SKIP='' STOP=' =,;'                          
*                                                                               
         COMMENT                   IF SCAN OK                                   
         IF    (R15,Z),BEGIN                                                    
         COMMENT                   IF NAME OK                                   
         IF    ((R0,POS),AND,(R0,LE,L'FFHOST)),BEGIN                            
         ST    R0,FFHOSTL                                                       
         LR    R3,R0                                                            
         DEX   R3,'MVC FFHOST(0),@R1'                                           
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF NAME TOO LONG                             
         ELSEIF (R0,GE,L'FFHOST),BEGIN                                          
         SCSEGCLR                                                               
         SCSEG 'File specification overflow.'                                   
         L     R15,=F'-4'                                                       
         B     FNONEXIT                                                         
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    (R0,NP),BEGIN                                                
         SCSEGCLR                                                               
         SCSEG 'Missing host name after "ON".'                                  
         L     R15,=F'-4'                                                       
         B     FNONEXIT                                                         
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   IF SCAN ERROR,                               
         ELSE  BEGIN               JUST RETURN R15=NZ                           
         END                                                                    
*                                                                               
FNONEXIT LABEL ,                                                                
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  SCAN VOL=<VOLUME>                                                            
*                                                                               
*                                                                               
FNAMEVOL PROC  ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SCAN FILE SYSTEM                             
         COMMENT                   USE BLANK DELIMITED SCAN                     
         SCANSTR ,                 SKIP='' STOP=' =,;'                          
*                                                                               
         COMMENT                   IF SCAN OK                                   
         IF    (R15,Z),BEGIN                                                    
         SCUPTOK (R2)                                                           
         IF    ((R0,EQ,6),OR,(@R2,EQ,'CAT')),BEGIN    IF NAME OK                
         ST    R0,FFHOSTL                                                       
         LR    R3,R0                                                            
         DEX   R3,'MVC FFHOST(0),@R1'                                           
         COMMENT                   FORCE FILE TYPE TO MVS FILE                  
         COMMENT  ** DEBUG **      SELECT OLDIBM OR WINGS AS DEFAULT            
         IF    (FFTYPE,EQ,0),BEGIN                                              
         ACALL FIBMTYPE                                                         
         IF    (R15,EQ,4),BEGIN                                                 
         SET   FFFWINGS                                                         
         END                                                                    
         IF    (R15,EQ,8),BEGIN                                                 
         SET   FFFOLD                                                           
         END                                                                    
         END                                                                    
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF NO NAME                                   
         ELSEIF (R0,NP),BEGIN                                                   
         SCSEGCLR                                                               
         SCSEG 'Missing volume name.'                                           
         L     R15,=F'-4'                                                       
         B     FNVOLXIT                                                         
         END                                                                    
         COMMENT                   IF NAME NOT OK                               
         ELSE  BEGIN                                                            
         SCSEGCLR                                                               
         SCSEG (R1),(R0)                                                        
         SCSEG ': invalid volume name.'                                         
         L     R15,=F'-4'                                                       
         B     FNVOLXIT                                                         
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   IF SCAN ERROR,                               
         ELSE  BEGIN               JUST RETURN R15=NZ                           
         END                                                                    
*                                                                               
FNVOLXIT LABEL ,                                                                
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
         QLTORG                                                                 
         TITLE 'PRELIMINARY FILE NAME SCANNING'                                 
*box                                                                            
*                                                                               
*                                                                               
*  FNAMEFIN - FINISH FILE NAME PROCESSING.                                      
*                                                                               
*  THE PURPOSE OF THIS ROUTINE IS TO DETERMINE THE                              
*  FILE SYSTEM TYPE.  (IE. FIND OUT WHICH TYPE OF FILE                          
*  OPEN TO DO.)  WE THEN PASS ALL THE FILE NAME AND                             
*  OPTIONS TO THE APPROPRIATE OPEN ROUTINE AND LET                              
*  THAT ROUTINE FIGURE OUT WHAT TO DO.                                          
*                                                                               
*  THIS ROUTINE ALSO APPLIES SOME ZAP TYPE LOGIC.                               
*  WE WANT ALL FILE NAMES TO BE OF THE FORM                                     
*    <file name> [on <host>] [file type]                                        
*  SO WE FIX ALL REFERENCES TO 'on <ibm volume>' TO BE                          
*  THE SAME AS 'WINGS VOL=<ibm volume>' AND SAMSON                              
*  FILENAMES C:NAME TO BE 'C:NAME SAMSON'.  IN SHORT                            
*  THERE IS SOME LOGIC TO MAKE OLD STUFF CONFORM TO                             
*  THE NEW.  THEN WE DO OUR THING WHICH IS TO FIND THE                          
*  FILE SYSTEM TYPE.                                                            
*                                                                               
*  WE DETERMINE FILE SYSTEM TYPE AS FOLLOWS:                                    
*   1. FILE SYSTEM EXPLICITLY SET                                               
*   2. ZAP ROUTINES IMPLY OLD FORMAT OLDIBM/WINGS/SAMSON                        
*   3. 'ON <HOST>' IMPLIES NET                                                  
*   4. '*' IMPLIES USE CURRENT FILE TYPE                                        
*   4. USE DEFAULT FILE TYPE                                                    
*                                                                               
*                                                                               
FNAMEFIN XPROC ,                                                                
         SCPUSH ,                  DO NOT CLOBBER SCANNER                       
*                                                                               
         L     R6,CPFINFOP         FFINFO DSECT POINTER                         
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   IF FILE TYPE ALREADY SET, DONE               
         IF    (FFTYPE,NE,0),FFINDONE                                           
*                                                                               
         COMMENT                   CHECK IF NETWORK STYLE (%) NAME              
         ACALL ZAPNET                                                           
         IF    Z,BEGIN                                                          
         B     FFINDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   CHECK IF OLD 'ON VOLUME'                     
         ACALL ZAPVOL                                                           
         IF    Z,BEGIN                                                          
         B     FFINDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   CHECK IF SAMSON STYLE FILE NAME              
         ACALL ZAPSAM                                                           
         IF    Z,BEGIN                                                          
         B     FFINDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   IF 'ON HOST', PRESUME NET                    
         IF    (FFHOSTL,GT,0),BEGIN IF ON ...                                   
         SET   FFFNET                                                           
         B     FFINDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   CHECK FOR '*' FILE NAME                      
         IF    ((FFNAMEL,GE,1),AND,(FFNAME,EQ,'*')),BEGIN                       
         LA    R1,FFTYPE                                                        
         MVC   FFTYPE,FFPTYPE                                                   
         IF    (FFTYPE,NE,0),FFINDONE                                           
         END                                                                    
*                                                                               
         COMMENT                   USE USER DEFAULT TYPE                        
         LA    R1,FFTYPE                                                        
         ACALL GETDTYPE                                                         
         IF    (FFTYPE,NE,0),FFINDONE                                           
*                                                                               
         COMMENT                   SELECT OLDIBM OR WINGS AS DEFAULT            
         ACALL FIBMTYPE                                                         
         IF    (R15,EQ,4),BEGIN                                                 
         SET   FFFWINGS                                                         
         END                                                                    
         IF    (R15,EQ,8),BEGIN                                                 
         SET   FFFOLD                                                           
         END                                                                    
*                                                                               
         IF    (FFTYPE,EQ,0),' BOMB '                                           
*                                                                               
         AIF   (NOT &$PCODE).NOUDEF                                             
         SET   FFFUNIX                                                          
.NOUDEF  ANOP                                                                   
*                                                                               
FFINDONE LABEL ,                                                                
*                                                                               
         COMMENT                   BACKWARDS COMPATABILITY                      
         COMMENT                   DO OLD DSN NAME PROCESSING                   
         IF    (FFFOLD),BEGIN                                                   
         ACALL OLDFIN                                                           
         END                                                                    
*                                                                               
         COMMENT                   Check SAMSON terminal type                   
         IF    (FFFSAM,AND,^CPSFSAM),BEGIN                                      
         TSEG  'Please issue a SET TERMINAL SAMSON command '                    
         TSEG  'before accessing SAMSON files.',,CR                             
         ABORT 'Type ? for more information.',,MICROTRM                         
         END                                                                    
*                                                                               
         SCPOP                                                                  
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  CHECK IF NETWORK STYLE FILE (%) NAME                                         
*                                                                               
*                                                                               
*  ON ENTRY:                                                                    
*    R6 - FFINFO DSECT                                                          
*                                                                               
*  ON EXIT:                                                                     
*    R15 - NZ, NO ZAP                                                           
*    R15 - ZERO, ZAPPED.  FFTYPE SET APPROPRIATELY.                             
*                                                                               
*                                                                               
*  NOTE:                                                                        
*  WE DO *NOT* STRIP '%' FROM FRONT OF FILE NAME.                               
*  THIS IS DONE FOR NOW BY THE OLD FILE NAME PROCESSING.                        
*  WHEN SAM MODULE IS FIXED TO USE DEFAULT HOST ON                              
*  SAM OPEN, IF ONE IS NOT GIVEN. THEN WE SHOULD STRIP                          
*  THE '%'.  THIS CODE IN PROGRESS.  AND SUBJECT TO CHANGE.                     
*                                                                               
*                                                                               
ZAPNET   XPROC ,                                                                
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   CHECK FOR LEADING '%'                        
         SETMSG FFNAME,L:FFNAMEL                                                
*                                                                               
         COMMENT                   IF '%', SET NET FILE TYPE                    
         COMMENT                   STRIP '%' OFF FILE NAME                      
         IF    ((R0,GT,1),AND,(@R1,EQ,'%')),BEGIN    ***MPD***                  
         SET   FFFNET              STRIP LEADING FILE NAME                      
         DECR  R0                                                               
         ST    R0,FFNAMEL                                                       
         LR    R2,R0                                                            
         MOVE  R2,FFNAME,FFNAME+1                                               
         CLEAR R15                                                              
         END                                                                    
*                                                                               
         COMMENT                   ELSE NOT NET FILE TYPE                       
         ELSE  BEGIN                                                            
         LA    R15,4                                                            
         END                                                                    
*                                                                               
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*  CHECK IF IBM TYPE 'on <volume>'                                              
*  OR SAMSON TYPE 'on <disk>'                                                   
*                                                                               
*  WE SET TYPE AS IS APPROPRIATE                                                
*                                                                               
*  ON ENTRY:                                                                    
*    R6 - FFINFO DSECT                                                          
*                                                                               
*  ON EXIT:                                                                     
*    R15 - NZ, NO ZAP                                                           
*    R15 - ZERO, ZAPPED.  FFTYPE SET APPROPRIATELY.                             
*                                                                               
*                                                                               
ZAPVOL   PROC  ,                                                                
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   IF NO 'ON VOL', NO ZAP                       
         IF    (FFHOSTL,EQ,0),BEGIN                                             
         LA    R15,4                                                            
         B     ZAPVDONE                                                         
         END                                                                    
*                                                                               
         COMMENT                   SCAN ON '...'                                
         SCPUSH ,                                                               
         SCCLR ,                                                                
         SCINIT FFHOST,L:FFHOSTL                                                
         SCAN  FVOLPRT                                                          
         SCANCHK                                                                
*                                                                               
         COMMENT ,                 SCAN ROUTINES SET UP FS DEFINITION           
*                                                                               
         COMMENT                                                                
         IF    (R15,EQ,4),BEGIN                                                 
         CLEAR R15                                                              
         END                                                                    
         ELSEIF (R15,EQ,8),BEGIN                                                
         LA    R15,4                                                            
         END                                                                    
         ELSE  BEGIN                                                            
         BOMB                                                                   
         END                                                                    
*                                                                               
ZAPVDONE LABEL ,                                                                
         SCPOP ,                                                                
         PEND  ,                                                                
         EJECT                                                                  
*                                                                               
*  SCAN VARIOUS VOLUMES/DISK NAMES                                              
*                                                                               
*  R15 - 4 ,,, SAMSON/WINGS                                                     
*  R15 - 8 ,,, NOT RECOGINZED                                                   
*                                                                               
*                                                                               
FVOLPRT  SCKW  A,SAMDISK                                                        
         SCKW  B,SAMDISK                                                        
         SCKW  C,SAMDISK                                                        
         SCKW  D,SAMDISK                                                        
         SCKW  E,SAMDISK                                                        
         SCKW  F,SAMDISK                                                        
         SCKW  G,SAMDISK                                                        
         SCKW  H,SAMDISK                                                        
         SCKW  I,SAMDISK                                                        
         SCKW  J,SAMDISK                                                        
         SCKW  K,SAMDISK                                                        
         SCKW  L,SAMDISK                                                        
         SCKW  M,SAMDISK                                                        
         SCKW  N,SAMDISK                                                        
         SCKW  O,SAMDISK                                                        
         SCKW  P,SAMDISK                                                        
         SCKW  Q,SAMDISK                                                        
         SCKW  R,SAMDISK                                                        
         SCKW  S,SAMDISK                                                        
         SCKW  T,SAMDISK                                                        
         SCKW  U,SAMDISK                                                        
         SCKW  V,SAMDISK                                                        
         SCKW  W,SAMDISK                                                        
         SCKW  X,SAMDISK                                                        
         SCKW  Y,SAMDISK                                                        
         SCKW  Z,SAMDISK                                                        
         SCKW  CLIP,SAMDISK                                                     
         SCKW  CLIPBOARD,SAMDISK                                                
         SCKW  CATLG,WINGSCAT,A                                                 
         SCKW  CATALOG,WINGSCAT,A                                               
         SCKW  ,WINGSVOL,A(MATVOL)                                              
         SCKW  ,ZVOTHER,NULL                                                    
         SCKW  ,ZVOTHER                                                         
*                                                                               
*                                                                               
*                                                                               
WINGSVOL PROC  ,                   WINGS VOLUME                                 
*                                                                               
* ** DEBUG **  EVENTUALLY SHOULD JUST SET WINGS. FOR NOW NEED                   
* ** DEBUG **  FIGURE IT OUT.                                                   
*                                                                               
         COMMENT                   SELECT OLDIBM OR WINGS AS DEFAULT            
         ACALL FIBMTYPE                                                         
         IF    (R15,EQ,4),BEGIN                                                 
         SET   FFFWINGS                                                         
         END                                                                    
         IF    (R15,EQ,8),BEGIN                                                 
         SET   FFFOLD                                                           
         END                                                                    
*                                                                               
         LA    R15,4                                                            
         PEND                                                                   
*                                                                               
*                                                                               
WINGSCAT PROC  ,                                                                
*                                                                               
* ** DEBUG **  EVENTUALLY SHOULD JUST SET WINGS. FOR NOW NEED                   
* ** DEBUG **  FIGURE IT OUT.                                                   
*                                                                               
         COMMENT                   SELECT OLDIBM OR WINGS AS DEFAULT            
         ACALL FIBMTYPE                                                         
         IF    (R15,EQ,4),BEGIN                                                 
         SET   FFFWINGS                                                         
         END                                                                    
         ELSE  BEGIN                                                            
         SET   FFFOLD                                                           
         LA    R15,4                                                            
         END                                                                    
         PEND  ,                                                                
*                                                                               
SAMDISK  PROC ,                    SAMSON                                       
         SET   FFFSAM                                                           
         LA    R15,4                                                            
         PEND ,                                                                 
*                                                                               
ZVOTHER  PROC ,                    OTHER                                        
         LA    R15,8                                                            
         PEND  ,                                                                
*                                                                               
*  MATCH ROUTINE FOR VOLUME                                                     
*                                                                               
*  SEE COMMENTS IN SCAN MODULE.                                                 
*    RETURN R15=0 IF FOUND, R15=NZ, NOT FOUND                                   
*                                                                               
MATVOL   PROC   ,                                                               
*                                                                               
         SCTOK ,                   R1,R0 - TOKEN LOC LEN                        
         SCUPTOK (R1)                                                           
*                                                                               
         IF    (R0,EQ,6),BEGIN                                                  
         VCALL CHECKVOL            IS IT A VALID VOLUME NAME                    
         IF    (R15,Z),BEGIN                                                    
         PRETURN (R0,R1)                                                        
         END                                                                    
         END                                                                    
         ELSE  BEGIN                                                            
         LA    R15,4 NOTVOL                                                     
         END                                                                    
*                                                                               
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*  CHECK FOR SAMSON FILE NAME                                                   
*                                                                               
*  WE SET TYPE AS SAMSON, IF SAMSON TYPE NAME FOUND                             
*                                                                               
*  ON ENTRY:                                                                    
*    R6 - FFINFO DSECT                                                          
*                                                                               
*  ON EXIT:                                                                     
*    R15 - NZ, NO ZAP                                                           
*    R15 - ZERO, ZAPPED.  FFTYPE SET APPROPRIATELY.                             
*                                                                               
*                                                                               
ZAPSAM   PROC  ,                                                                
         USING FFINFO,R6                                                        
         SCPUSH ,                                                               
         SCCLR ,                                                                
         SCINIT FFNAME,L:FFNAMEL                                                
         SCAN ,                                                                 
         SCANCHK ,                                                              
         SCUPTOK (R1)                                                           
         COMMENT                   CHECK FOR A: THRU Z:<NAME>                   
         IF    ((R0,GE,2),AND,(@R1+1,EQ,':')),BEGIN                             
         IF    ((@R1,GE,'A'),AND,(@R1,LE,'Z')),CKGOTSAM                         
         END                                                                    
         IF    ((R0,GE,5),AND,(@R1,EQ,'CLIP:')),CKGOTSAM                        
         IF    ((R0,GE,10),AND,(@R1,EQ,'CLIPBOARD:')),CKGOTSAM                  
         IF    ((R0,GT,8),AND,(@R1,EQ,'<SAMSON>')),BEGIN                        
         COMMENT  YUCK, STRIP '<SAMSON>' PART, SET SAMSON TYPE                  
         L     R0,FFNAMEL                                                       
         S     R0,=A(8)                                                         
         ST    R0,FFNAMEL                                                       
         LR    R3,R0                                                            
         DEX   R3,' MVC FFNAME(0),FFNAME+8'                                     
         B     CKGOTSAM                                                         
         END                                                                    
         IF    ((R0,GT,7),AND,(@R1,EQ,'<MICRO>')),BEGIN                         
         COMMENT  YUCK, STRIP '<MICRO>' PART, SET SAMSON TYPE                   
         L     R0,FFNAMEL                                                       
         S     R0,=A(7)                                                         
         ST    R0,FFNAMEL                                                       
         LR    R3,R0                                                            
         DEX   R3,' MVC FFNAME(0),FFNAME+7'                                     
         B     CKGOTSAM                                                         
         END                                                                    
         COMMENT                   WE FALL THRU IF NOT SAMSON TYPE              
*                                                                               
CKNOTSAM LABEL ,                                                                
         LA    R15,4                                                            
         B     CHKSDONE                                                         
*                                                                               
CKGOTSAM LABEL ,                                                                
         SET   FFFSAM                                                           
         CLEAR R15                                                              
*                                                                               
CHKSDONE LABEL ,                                                                
         DROP  R6                                                               
         PEND  ,                                                                
         EJECT                                                                  
*                                                                               
*  FIBMTYPE - FIND IBM TYPE -- WINGS OR OLDIBM                                  
*                                                                               
*                                                                               
*  ON EXIT:                                                                     
*    R15=4   IS WINGS                                                           
*    R15=8   IS OLDIBM                                                          
*                                                                               
*  LOOK AT FDEFAULT,                                                            
*  IF NO FDEFAULT SET WE LOOK AT CV FLAGS, IF NOT                               
*  WE FOR NOW DEFAULT TO OLDIBM (** DEBUG **)                                   
*                                                                               
FIBWA    RECORD BEGIN                                                           
FIBINFO  DS    XL(L'FFINFO)                                                     
         END                                                                    
*                                                                               
*                                                                               
FIBMTYPE PROC  FIBWA                                                            
*                                                                               
         LA    R6,FIBINFO                                                       
         USING FFINFO,R6                                                        
         CLEAR FFINFO                                                           
*                                                                               
         LA    R1,FFTYPE                                                        
         ACALL GETDTYPE                                                         
*                                                                               
         IF    FFFWINGS,FIBWINGS   USE USER DEFAULTS                            
         IF    FFFOLD,FIBOLD                                                    
         IF    CVFWINGS,FIBWINGS   THEN USE SYSTEM DEFAULTS                     
         IF    CVFOLDIBM,FIBOLD                                                 
*                                                                               
*** DEBUG EVENTUALLY SHOULD DEFAULT TO WINGS, FOR NOW DEFAULT IS                
*** DEBUG SETABLE (CVFWINGS/CVFOLDIBM), WITH ULTIMATE LAST DEFAULT              
*** DEBUG BEING FOR NOW OLDIBM.                                                 
*                                                                               
         COMMENT                   FINALLY, AS LAST RESORT                      
         COMMENT                      DEFAULT TO OLDIBM                         
         B     FIBOLD              ** DEBUG **  LAST DEFAULT: OLDIBM            
         COMMENT                   ** DEBUG **                                  
*                                                                               
FIBWINGS LABEL ,                                                                
         LA    R15,4                                                            
         B     FIBEXIT                                                          
*                                                                               
FIBOLD   LABEL ,                                                                
         LA    R15,8                                                            
         B     FIBEXIT                                                          
*                                                                               
FIBEXIT  LABEL ,                                                                
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
         QLTORG                                                                 
         EJECT                                                                  
*                                                                               
*  ** DEBUG                                                                     
*                                                                               
*  EXPCNAME - EXPORT FULL CURRENT NAME TO FFINFO DSECT                          
*             FROM DSN WORKARE                                                  
*                                                                               
*                                                                               
EXPCNAME XPROC ,                                                                
*                                                                               
         COMMENT                   MAKE SURE WORK AREA EXISTS                   
         ACALL MKFFINFO                                                         
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   EXPORT NAME BACK TO FFINFO                   
*                                                                               
         COMMENT                   DISK (OLDIBM) TYPE NAME                      
         IF    (DSNDTYPE,EQ,DSNDDISK),BEGIN                                     
         MVC   FFRNAME,CVBLANKS                                                 
         MVC   FFRNAME(L'DSNWADSN),DSNWADSN    DO FILE NAME                     
         LA    R2,FFRNAME                      R2 - NDX PTR                     
         WHILE (@R2,NE,' '),BEGIN                                               
         INCR  R2                                                               
         END                                                                    
         IF    (DSNWAMBR,NE,'        '),BEGIN  IF MEMBER, ADD IT                
         MVI   @R2,C'('                                                         
         INCR  R2                                                               
         MVC   @R2(L'DSNWAMBR),DSNWAMBR                                         
         WHILE (@R2,NE,' '),BEGIN                                               
         INCR  R2                                                               
         END                                                                    
         MVI   @R2,C')'                                                         
         INCR  R2                                                               
         END                                                                    
         LA    R1,FFRNAME                                                       
         SR    R2,R1                                                            
         ST    R2,FFRNAMEL                                                      
         END                                                                    
*                                                                               
         COMMENT                   NET NAME IS SPECIAL                          
         IF    (DSNDTYPE,EQ,DSNDNET),BEGIN                                      
         LH    R1,DSNWLEN                                                       
         ST    R1,FFRNAMEL                                                      
         MOVE  R1,FFRNAME,DSNWFILE                                              
         END                                                                    
*                                                                               
         COMMENT                   SAMSON NAME IS SPECIAL                       
         IF    (DSNDTYPE,EQ,DSNDSAM),BEGIN                                      
         LH    R1,DSNWANL                                                       
         ST    R1,FFRNAMEL                                                      
         MOVE  R1,FFRNAME,DSNWADSN                                              
         END                                                                    
*                                                                               
         COMMENT                   IF NO HOST, EXPORT HOST/VOL TOO              
         IF    (FFHOSTL,EQ,0),BEGIN                                             
         LA    R1,DSNON                                                         
         LA    R2,DSNON+L'DSNON                                                 
         DECR  R2                                                               
         WHILE ((R2,GE,R1),AND,((@R2,EQ,' '),OR,(@R2,EQ,0))),BEGIN              
         DECR  R2                                                               
         END                                                                    
         INCR  R2                                                               
         SR    R2,R1               R2 - DSNON LEN (MAY BE ZERO)                 
         ST    R2,FFHOSTL                                                       
         MOVE  R2,FFHOST,DSNON                                                  
         END                                                                    
*                                                                               
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
         QLTORG                                                                 
         AGO   .ALWAYS                                                          
         TITLE 'OLD DSN NAME/OPTION PARSING'                                    
*                                                                               
*  THESE ROUTINES IFDEF'ED OUT,,, THEY ARE NOT NEEDED.                          
*                                                                               
*  THESE 'Z' ROUTINES, ARE FOR OLD DATA SET NAME SCANNING.                      
*  THEY SET A BUNCH OF (DSN) FIELDS IN THE CP. THESE WILL                       
*  BE AXED IN TIME.  BUT WILL BE REQUIRED UNTIL OLDIBM                          
*  GOES AWAY. AND ALL OLD DATA SET NAME PROCESSING IS AXED!                     
*                                                                               
         SPACE 3                                                                
*                                                                               
*                                                                               
*  ZOFNAME - SCAN FILE NAME                                                     
*            ** OLD SCANNER VERSION **                                          
*                                                                               
*  ON ENTRY:                                                                    
*  SCAN CONTROL BLOCK POINTS TO NAME TO SCAN                                    
*                                                                               
*  ALL ERRORS EXIT VIA CVERROR                                                  
*                                                                               
*                                                                               
ZOFNAME  XPROC ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   IF NEEDED, GET FILE INFO AREA                
         IF    (CPFINFOP,EQ,0),BEGIN                                            
         L     R0,=A(L'FFINFO)                                                  
         VCALL GETHEAP                                                          
         ST    R1,CPFINFOP                                                      
         LR    R6,R1                                                            
         CLEAR FFINFO                                                           
         END                                                                    
*                                                                               
         COMMENT                   SCAN OPTION (MAY BE HOST NAME)               
         COMMENT                   DO BLANK DELIMITED SCAN                      
         OSCINFO ,                                                              
         SCCLR                                                                  
         SCINIT (R1),(R0)                                                       
         SCANSTR ,                 SKIP=' ', STOP=' ,=;'                        
         SCANCHK ,                                                              
         XPUSH R0,R1                                                            
         SCINFO  ,                                                              
         OSCINIT (R1),(R0)                                                      
         XPOP  R0,R1                                                            
*                                                                               
         COMMENT                   IF NORMAL SCAN                               
         IF    ((R15,Z),AND,(R0,POS)),BEGIN                                     
         ST    R0,FFNAMEL                                                       
         LR    R3,R0                                                            
         DEX   R3,'MVC FFNAME(0),@R1'                                           
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    ((R15,Z),AND,(R0,NP)),BEGIN                                  
         ERROR 'Missing file name. '                                            
         END                                                                    
*                                                                               
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  ZNAMESCN - SCAN FILE NAME                                                    
*                                                                               
*  ENTERED AS SCKW PROCESSING ROUTINE. EG. --                                   
*     SCKW  FROM,V(DSNSCAN)                                                     
*  -- WE SCAN AND SAVE THE NAME.                                                
*                                                                               
*  ON ENTRY:                                                                    
*    SCAN CONTROL BLOCK POINTS TO FILE NAME TO SCAN                             
*                                                                               
*  ON EXIT:                                                                     
*    IF ERROR, WE EXIT VIA CVERROR,,,                                           
*    THIS COULD BE CHANGED                                                      
*                                                                               
*                                                                               
*                                                                               
ZNAMESCN XPROC ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   IF NEEDED, GET FILE INFO AREA                
         IF    (CPFINFOP,EQ,0),BEGIN                                            
         L     R0,=A(L'FFINFO)                                                  
         VCALL GETHEAP                                                          
         ST    R1,CPFINFOP                                                      
         LR    R6,R1                                                            
         CLEAR FFINFO                                                           
         END                                                                    
*                                                                               
         COMMENT                   SCAN FILE NAME                               
         COMMENT                   DO BLANK DELIMITED SCAN                      
         OSCINFO ,                                                              
         SCCLR                                                                  
         SCINIT (R1),(R0)                                                       
         SCANSTR ,                 SKIP=' ', STOP=' ,=;'                        
         IF    (R15,NZ),BEGIN                                                   
         XPUSH R0,R1                                                            
         SCINFO  ,                                                              
         OSCINIT (R1),(R0)                                                      
         XPOP  R0,R1                                                            
         END                                                                    
*                                                                               
         COMMENT                   IF SCAN ERROR,                               
         IF    (R15,NZ),BEGIN      JUST RETURN R15=NZ                           
         END                                                                    
         COMMENT                   IF NORMAL SCAN                               
         ELSEIF    ((R15,Z),AND,(R0,POS)),BEGIN                                 
         ST    R0,FFNAMEL                                                       
         LR    R3,R0                                                            
         DEX   R3,'MVC FFNAME(0),@R1'                                           
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    ((R15,Z),AND,(R0,NP)),BEGIN                                  
         ERROR 'Missing file name. '                                            
         END                                                                    
*                                                                               
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*   ROUTINES TO DO PRELIMINARY SCANNING OF FILE OPTIONS                         
*                                                                               
*                                                                               
*   ZNAMPRTF - FILE NAME OPTIONS, FILE FORMAT OPTIONS, ETC                      
*   ZNAMPRT - FILE NAME OPTIONS                                                 
*   ZNONPRT - FILE SYSTEM NAME ONLY                                             
*                                                                               
*   NOTE:                                                                       
*   ALL FILE OPTIONS MUST BE LISTED IN THE FOLLOWING TABLE                      
*   EVEN THOUGH NO PROCESSING OF THESE OPTIONS TAKES PLACE                      
*   HERE.                                                                       
*                                                                               
*                                                                               
*  ZNAMPRTF IS THE SCANNER PRT USED BY USE, SAVE, COPY .. FROM                  
*  TO RECOGNIZE FILE NAME AND FILE (FORMAT) OPTIONS AS WELL AS                  
*  THE NORMAL FILE NAME KEYWORDS.                                               
*                                                                               
*                                                                               
ZNAMPRTF OSCKW EDIT,ZNAMEKW,A                                                   
         OSCKW CARD,ZNAMEKW,A                                                   
         OSCKW PRINT,ZNAMEKW,A                                                  
         OSCKW TABS,ZNAMEKW,A                                                   
         OSCKW TRANSPARENT,ZNAMEKW,A                                            
         OSCKW DTRANSPARENT,ZNAMEKW,A                                           
         OSCKW WRAP,ZNAMEOPT,A                                                  
         OSCKW SPLIT,ZNAMEOPT,A                                                 
         OSCKW LRECL,ZNAMEOPT,A                                                 
         OSCKW CODE,ZNAMEOPT,A                                                  
         OSCKW INTEGER,ZNAMEKW,A                                                
         OSCKW UNNUMBERED,ZNAMEKW,A                                             
         OSCKW NUMBERED,ZNAMEKW,A                                               
         OSCKW NONUMBER,ZNAMEKW,A                                               
         OSCKW SEQFLD,ZNAMEOPT,A                                                
*                                                                               
*  ZNAMPRT IS THE SCANNER PRT USED BY ALL OF WYLBUR TO                          
*  RECOGNIZE FILE NAME KEYWORDS                                                 
*                                                                               
ZNAMPRT  OSCKW WINGS,ZNWINGS                                                    
         OSCKW UNIX,ZNUNIX                                                      
         OSCKW SAMSON,ZNSAMSON,A                                                
         OSCKW NET,ZNNET                                                        
         OSCKW OLDIBM,ZNOLDIBM,A                                                
         OSCKW ON,ZNAMEON,A                                                     
         OSCKW ACCOUNT,ZNAMEOPT,A                                               
         OSCKW ACCT,ZNAMEOPT,A                                                  
         OSCKW USER,ZNAMEOPT,A                                                  
         OSCKW GROUP,ZNAMEOPT,A                                                 
         OSCKW GRP,ZNAMEOPT                                                     
         OSCKW TEMPORARY,ZNAMEKW,A                                              
         OSCKW SET,ZNAMEKW                                                      
         OSCKW NOSET,ZNAMEKW,A                                                  
         OSCKW PUBLIC,ZNAMEKW,A                                                 
         OSCKW GUEST,ZNAMEKW,A                                                  
         OSCKW NOENQUEUE,ZNAMEKW,A                                              
         OSCKW ,,POP                                                            
*                                                                               
*  ZNONPRT ??? WHAT IS THIS FOR ?? SHOULD BE THE                                
*  EQUIVALENT OF DSNONPRT IN OPT ?? OR WHAT CHECK IT                            
*  OUT I AM NOT SURE NOW - CH FEB. 25 91                                        
*                                                                               
ZNONPRT  OSCKW ON,ZNAMEON,A                                                     
         OSCKW ,,POP                                                            
         EJECT                                                                  
*                                                                               
*  SET FILE TYPE FLAGS                                                          
*                                                                               
*                                                                               
ZNWINGS  PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFWINGS                                                         
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
ZNUNIX   PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFUNIX                                                          
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
ZNSAMSON PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFSAM                                                           
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
ZNNET    PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFNET                                                           
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
*                                                                               
ZNOLDIBM PROC  ,                                                                
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
         SET   FFFOLD                                                           
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  GOT FILE/FILE SYSTEM OPTION KEYWORD                                          
*                                                                               
*                                                                               
ZNAMEKW  PROC  ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SEPARATE OPTIONS BY BLANK                    
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MVI   @R4,C' '                                                         
         INCR  R3,FFOPTSL                                                       
*                                                                               
         COMMENT                   ADD KEYWORD TO OPTIONS STRING                
         L     R5,FFOPTSL                                                       
         AR    R5,R0                                                            
         IF    (R5,GE,L'FFOPTS),BEGIN                                           
         ERROR 'File specification overflow.'                                   
         END                                                                    
         LR    R3,R0                                                            
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MOVE  R3,@R4,@R1                                                       
         ST    R5,FFOPTSL                                                       
*                                                                               
         CLEAR R15                                                              
*                                                                               
ZNKWEXIT LABEL ,                                                                
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
*  GOT FILE/FILE SYSTEM OPTION KEYWORD AND VALUE                                
*                                                                               
*                                                                               
ZNOWA    RECORD BEGIN                                                           
ZNOPTLOC DS    F                                                                
ZNOPTLEN DS    F                                                                
         END                                                                    
*                                                                               
*                                                                               
ZNAMEOPT PROC  ZNOWA                                                            
*                                                                               
         ST    R1,ZNOPTLOC                                                      
         ST    R0,ZNOPTLEN                                                      
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SEPARATE OPTIONS BY BLANK                    
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MVI   @R4,C' '                                                         
         INCR  R3,FFOPTSL                                                       
*                                                                               
         COMMENT                   ADD KEYWORD TO OPTIONS STRING                
         L     R5,FFOPTSL                                                       
         AR    R5,R0                                                            
         IF    (R5,GE,L'FFOPTS),BEGIN                                           
         ERROR 'File specification overflow.'                                   
         END                                                                    
         LR    R3,R0                                                            
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MOVE  R3,@R4,@R1                                                       
         ST    R5,FFOPTSL                                                       
*                                                                               
         COMMENT                   FOLLOW KEYWORD WITH '='                      
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MVI   @R4,C'='                                                         
         INCR  R3,FFOPTSL                                                       
*                                                                               
         COMMENT                   SCAN FOR KEYWORD VALUE                       
         COMMENT ,                 (MAY BE HOST NAME)                           
         COMMENT                   DO BLANK DELIMITED SCAN                      
         OSCINFO ,                                                              
         SCCLR                                                                  
         SCINIT (R1),(R0)                                                       
         SCANSTR ,                 SKIP=' ', STOP=' ,=;'                        
         SCANCHK ,                                                              
         XPUSH R0,R1                                                            
         SCINFO  ,                                                              
         OSCINIT (R1),(R0)                                                      
         XPOP  R0,R1                                                            
*                                                                               
         COMMENT                   IF SCAN OK                                   
         IF    ((R15,Z),AND,(R0,POS)),BEGIN                                     
         L     R5,FFOPTSL                                                       
         AR    R5,R0                                                            
         IF    (R5,GE,L'FFOPTS),BEGIN                                           
         ERROR 'File specification overflow.'                                   
         END                                                                    
         LR    R3,R0                                                            
         LA    R4,FFOPTS                                                        
         A     R4,FFOPTSL                                                       
         MOVE  R3,@R4,@R1                                                       
         ST    R5,FFOPTSL                                                       
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    ((R15,Z),AND,(R0,NP)),BEGIN                                  
         L     R1,ZNOPTLOC                                                      
         L     R0,ZNOPTLEN                                                      
         TSEG  (R1),(R0)                                                        
         ERROR ': missing option. '                                             
         END                                                                    
         COMMENT                   IF SCAN ERROR,                               
         ELSEIF  (R15,NZ),BEGIN    JUST RETURN R15=NZ                           
         END                                                                    
*                                                                               
*                                                                               
         CLEAR R15                                                              
*                                                                               
ZNOPEXIT LABEL ,                                                                
         PEND  ,                                                                
         DROP  R6                                                               
*                                                                               
*                                                                               
*  SCAN ON <FILE SYSTEM>                                                        
*                                                                               
*                                                                               
ZNAMEON  PROC  ,                                                                
*                                                                               
         COMMENT                   GET FILE INFO ADDR                           
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SCAN 'ON HOST'                               
         COMMENT                   DO BLANK DELIMITED SCAN                      
         OSCINFO ,                                                              
         SCCLR                                                                  
         SCINIT (R1),(R0)                                                       
         SCANSTR ,                 SKIP=' ', STOP=' ,=;'                        
         SCANCHK ,                                                              
         XPUSH R0,R1                                                            
         SCINFO  ,                                                              
         OSCINIT (R1),(R0)                                                      
         XPOP  R0,R1                                                            
*                                                                               
         COMMENT                   IF SCAN OK                                   
         IF    ((R15,Z),AND,(R0,POS)),BEGIN                                     
         IF    (R0,GE,L'FFHOST),BEGIN                                           
         ERROR 'File specification overflow.'                                   
         END                                                                    
         ST    R0,FFHOSTL                                                       
         LR    R3,R0                                                            
         DEX   R3,'MVC FFHOST(0),@R1'                                           
         CLEAR R15                                                              
         END                                                                    
         COMMENT                   IF MISSING NAME                              
         ELSEIF    ((R15,Z),AND,(R0,NP)),BEGIN                                  
         ERROR 'Missing host name after "ON".'                                  
         END                                                                    
         COMMENT                   IF SCAN ERROR,                               
         ELSEIF  (R15,NZ),BEGIN    JUST RETURN R15=NZ                           
         END                                                                    
*                                                                               
ZNONEXIT LABEL ,                                                                
         PEND                                                                   
         DROP  R6                                                               
*                                                                               
         QLTORG                                                                 
.ALWAYS  ANOP                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
*   OLD DSN SCAN FINISHED PROCESSING.                                           
*                                                                               
*   THIS IS FOR BACKWARDS COMPATABILITY.  WE MUST                               
*   SET ALL THE OLD DSN... FIELDS IN THE CP.  WE                                
*   DO THIS BY RUNNING FILE NAME AND FILE OPTION                                
*   STRINGS THROUGH THE OLD DSN... ROUTINES.                                    
*                                                                               
*   NOTE:                                                                       
*   THESE ROUTINES USE THE NEW SCANNER.  I MENTION                              
*   THIS JUST TO AVOID CONFUSION.  IT IS NO BIGGIE.                             
*                                                                               
*   COMMENT:                                                                    
*   ERRORS ARE HANDLED IN MISC UNKOWN FASHIONS.                                 
*                                                                               
OLDFWA   RECORD BEGIN                                                           
OLDNAMEL DS    F                                                                
OLDNAME  DS    XL256                                                            
OLDOPTSL DS    F                                                                
OLDOPTS  DS    XL256                                                            
         END                                                                    
*                                                                               
*                                                                               
OLDFIN   PROC  OLDFWA                                                           
         SCPUSH ,                                                               
         L     R6,CPFINFOP                                                      
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   SCAN FILE NAME IF ANY                        
         SETMSG FFNAME,L:FFNAMEL                                                
         LR    R2,R0                                                            
         MOVE  R2,OLDNAME,@R1                                                   
         ST    R0,OLDNAMEL                                                      
         IF    FFFSAM,BEGIN        IF SAMSON, preface with <MICRO>              
         SETMSG FFNAME,L:FFNAMEL                                                
         LR    R2,R0                                                            
         IF    (@R1,NE,'<'),BEGIN                                               
         MVC   OLDNAME(7),=CL7'<MICRO>'                                         
         MOVE  R2,OLDNAME+7,@R1                                                 
         A     R0,=A(7)                                                         
         ST    R0,OLDNAMEL                                                      
         END                                                                    
         END                                                                    
*                                                                               
         COMMENT                   DO FNAME !                                   
         SCCLR                                                                  
         SCINIT OLDNAME,L:OLDNAMEL                                              
         VCALL DODSNM              PROCESS DATA SET NAME                        
*                                                                               
         COMMENT                   DO FILE OPTIONS                              
         L     R3,FFOPTSL          MOVE FFOPTS TO OLDOPTS                       
         ST    R3,OLDOPTSL                                                      
         LA    R2,OLDOPTS                                                       
         L     R3,FFOPTSL                                                       
         LA    R4,FFOPTS                                                        
         LR    R5,R3                                                            
         MVCL  R2,R4               MOVE OPTIONS                                 
         IF    (FFHOSTL,GT,0),BEGIN   ADD 'ON HOST' TO OPTIONS                  
         SETMSG ' ON '                                                          
         LR    R3,R0                                                            
         LR    R4,R1                                                            
         LR    R5,R3                                                            
         MVCL  R2,R4               ' ON '                                       
         L     R3,FFHOSTL                                                       
         LA    R4,FFHOST                                                        
         LR    R5,R3                                                            
         MVCL  R2,R4               HOST                                         
         L     R3,FFOPTSL                                                       
         A     R3,=F'4'                                                         
         A     R3,FFHOSTL                                                       
         ST    R3,OLDOPTSL                                                      
         END                                                                    
         SCCLR                     SCAN FILE OPTIONS                            
         SCINIT OLDOPTS,L:OLDOPTSL                                              
         SCAN  OLDFPRT                                                          
         SCANCHK                                                                
*                                                                               
         COMMENT                   FINISH UP, OLD STYLE                         
         VCALL DSNFIN                                                           
*                                                                               
         ACALL EXPCNAME                                                         
*                                                                               
         SCPOP                                                                  
         PEND  ,                                                                
         DROP  R6                                                               
*                                                                               
*                                                                               
OLDFPRT  SCKW  BLKSIZE,V(SCNNOOP),(A,P)                                         
         SCKW  ,V(SCNNOOP),V(MPAREN) MATCH '(<NNNN>)' RECORD COUNT              
         SCKW  TITLE,V(SCNNOOP),(A,P)                                           
         SCKW  CATALOG,V(SCNNOOP),A                                             
         SCKW  CATLG,V(SCNNOOP),A                                               
         SCKW  NOCATALOG,V(SCNNOOP),A                                           
         SCKW  NOCATLG,V(SCNNOOP),A                                             
         SCKW  RECATALOG,V(SCNNOOP),A                                           
         SCKW  RECATLG,V(SCNNOOP),A                                             
         SCKW  UNCATALOG,V(SCNNOOP),A                                           
         SCKW  STREAM,STREAM,A                                                  
         SCKW  EXPDT,V(SCNNOOP),A                                               
         SCKW  ,V(DSNPSHF),PUSH                                                 
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
STREAM   PROC                                                                   
         SET   DSNFSTRM                                                         
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         TITLE  'MISC FILE SYSTEM INFO SAVE/GET ROUTINES'                       
*                                                                               
*  SETDHOST - SET DEFAULT FILE HOST                                             
*                                                                               
*  R1,R0 - HOST LOCATION AND LENGTH                                             
*                                                                               
*                                                                               
SETDHOST XPROC ,                                                                
         LA    R2,=CL16'DEF_FILE_HOST   '                                       
         VCALL SAVEDATA                                                         
         PEND                                                                   
*                                                                               
*  GETDHOST - GET DEFAULT FILE HOST                                             
*                                                                               
*  ON ENTRY:                                                                    
*    R1,R0 - LOCATION AND LENGTH OF AREA                                        
*                                                                               
*  ON EXIT:                                                                     
*    R0  - ACTUAL LENGTH                                                        
*    R1  - AREA                                                                 
*    R15 - CC=ZERO, ALL OK                                                      
*          CC=NZ, NOT FOUND                                                     
*                                                                               
*                                                                               
GETDHOST XPROC ,                                                                
         LA    R2,=CL16'DEF_FILE_HOST   '                                       
         VCALL GETDATA                                                          
         PRETURN (R0)                                                           
         PEND  ,                                                                
         EJECT                                                                  
*                                                                               
*  SETDTYPE - SET DEFAULT FILE TYPE                                             
*                                                                               
*  R1 - TYPE LOCATION AND LENGTH                                                
*                                                                               
*  NOTE:                                                                        
*  TYPE IS STORED AS 1 BYTE OF FLAGS.                                           
*  SEE FFFTYPE IN FFINFO DSECT.                                                 
*                                                                               
*                                                                               
SETDTYPE XPROC ,                                                                
         LA    R0,1                                                             
         LA    R2,=CL16'DEF_FILE_TYPE   '                                       
         VCALL SAVEDATA                                                         
         PEND                                                                   
*                                                                               
*  GETDTYPE - GET CURRENT FILE TYPE                                             
*                                                                               
*  ON ENTRY:                                                                    
*    R1,R0 - LOCATION AND LENGTH OF AREA                                        
*                                                                               
*  ON EXIT:                                                                     
*    R0  - ACTUAL LENGTH                                                        
*    R1  - AREA                                                                 
*    R15 - CC=ZERO, ALL OK                                                      
*          CC=NZ, NOT FOUND                                                     
*                                                                               
*                                                                               
GETDTYPE XPROC ,                                                                
         LA    R0,1                                                             
         LA    R2,=CL16'DEF_FILE_TYPE   '                                       
         VCALL GETDATA                                                          
         PEND  ,                                                                
         QLTORG                                                                 
         TITLE 'SET/SHOW FILE DEFAULT, FILE PREFIX'                             
         EJECT                                                                  
*                                                                               
*  SET FDEFAULT                                                                 
*                                                                               
*  SET FILE DEFAULT: TYPE, HOST, PATH (WINGS)                                   
*                                                                               
*                                                                               
*  WE TURN OFF FOR NOW,  PATCHABLE,,,                                           
*                                                                               
SFDWA    RECORD BEGIN                                                           
SFDINFO  DS    XL(L'FFINFO)                                                     
         END                                                                    
*                                                                               
*                                                                               
SETFDEF  XPROC SFDWA                                                            
*                                                                               
         COMMENT                   DISABLE COMMAND FOR ALL                      
         COMMENT                    BUT PJG,SCH,  PATCHABLE                     
         IF    (CPSACCT,EQ,'SCHGG'),SETALLOW                                    
         IF    (CPSACCT,EQ,'PJGGG'),SETALLOW                                    
         IF    (CPSACCT,EQ,'JDNGG'),SETALLOW                                    
         LA    R0,0                                                             
         LA    R1,0                                                             
         IF    (R0,EQ,R1),BEGIN                                                 
         B     CVNEXT                                                           
         END                                                                    
*                                                                               
SETALLOW LABEL ,                                                                
         COMMENT                   GET DUMMY FFINO AREA,,                       
         LA    R6,SFDINFO                                                       
         USING FFINFO,R6                                                        
         CLEAR FFINFO                                                           
         COMMENT                   SCAN OPTIONS                                 
         SCAN  SFDPRT                                                           
         SCANCHK                                                                
         COMMENT                   SET DEFAULT OPTIONS                          
         LA    R1,FFTYPE                                                        
         ACALL SETDTYPE                                                         
         PEND  ,                                                                
*                                                                               
SFDPRT   SCKW  ,SFDNULL,NULL                                                    
         SCKW  WINGS,SFDWINGS                                                   
*        SCKW  UNIX,SFDUNIX                                                     
*        SCKW  NET,SFDNET                                                       
*        SCKW  SAMSON,SFDSAM,A                                                  
         SCKW  OLDIBM,SFDOLD,A                                                  
         SCKW  ,V(NOTVALID)                                                     
*                                                                               
*                                                                               
SFDNULL  PROC  ,                                                                
         ERROR 'Missing options.'                                               
         PEND                                                                   
*                                                                               
*                                                                               
SFDWINGS PROC  ,                                                                
         SET   FFFWINGS                                                         
         PEND                                                                   
*                                                                               
*                                                                               
SFDUNIX  PROC  ,                                                                
         SET   FFFUNIX                                                          
         PEND                                                                   
*                                                                               
*                                                                               
SFDNET   PROC  ,                                                                
         SET   FFFNET                                                           
         PEND                                                                   
*                                                                               
*                                                                               
SFDSAM   PROC  ,                                                                
         SET   FFFSAM                                                           
         PEND                                                                   
*                                                                               
*                                                                               
SFDOLD   PROC  ,                                                                
         SET   FFFOLD                                                           
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*  SHOW FDEFAULT                                                                
*                                                                               
*  SHOW DEFAULT FILE SYSTEM                                                     
*                                                                               
*                                                                               
SHOWFDEF XPROC SFDWA                                                            
         LA    R6,SFDINFO                                                       
         USING FFINFO,R6                                                        
         CLEAR FFINFO                                                           
*                                                                               
         COMMENT                   GET TYPE                                     
         LA    R1,FFTYPE                                                        
         ACALL GETDTYPE                                                         
*                                                                               
         COMMENT                   TELL USER                                    
         IF    (FFTYPE,NZ),BEGIN                                                
         TSEG  'Your default file system is '                                   
         COMMENT                   OUTPUT TYPE INFO                             
         IF    FFFWINGS,' TSEG "Wings." '                                       
         ELSEIF    FFFUNIX,' TSEG "UNIX." '                                     
         ELSEIF    FFFNET,' TSEG "NET." '                                       
         ELSEIF    FFFSAM,' TSEG "SAMSON." '                                    
         ELSEIF    FFFOLD,' TSEG "OLDIBM." '                                    
         ELSE  BEGIN                                                            
         TSEG  'unknown. '                                                      
         END                                                                    
         END                                                                    
*                                                                               
         ELSE  BEGIN               IF NO USER DEFAULT SET                       
         IF    CVFWINGS,BEGIN                                                   
         TSEG  'Wylbur default file system is Wings.'                           
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  'Wylbur default file system is OLDIBM.'                          
         END                                                                    
         END                                                                    
*                                                                               
         B     CVNEXT                                                           
         PEND  ,                                                                
         DROP  R6                                                               
         EJECT                                                                  
MAXFPATH EQU   32                                                               
*                                                                               
*  SET FPATH (WINGS PATH NAME)                                                  
*                                                                               
*                                                                               
SETFPAT  XPROC ,                                                                
         SCAN  ,                                                                
         SCANCHK                                                                
         IF    (R15,Z),BEGIN                                                    
         IF    (R0,Z),BEGIN                                                     
         CLEAR CPWPATH                                                          
         END                                                                    
         IF    (R0,POS),BEGIN                                                   
         SCUPCASE CPWPATH                                                       
         END                                                                    
         END                                                                    
         B     CVNEXT                                                           
         PEND  ,                                                                
*                                                                               
*  SHOW FPATH                                                                   
*                                                                               
*                                                                               
SHOWFPAT XPROC                                                                  
         VCALL NOOPTS                                                           
         IF    (CPWPATH,EQ,0),BEGIN                                             
         TSEG  'No user specified WINGS path.  Default path used.'              
         END                                                                    
         ELSE  BEGIN                                                            
         TSEG  CPWPATH,8                                                        
         END                                                                    
         B     CVNEXT                                                           
         PEND                                                                   
*                                                                               
         QLTORG                                                                 
         TITLE 'NAME RESOLUTION ROUTINES'                                       
*                                                                               
*  NRESOLVE                                                                     
*                                                                               
*  RESOLVE FILE NAME                                                            
*                                                                               
*  ON ENTRY:                                                                    
*    FFINFO CONTAINS FFNAME, FFHOST, FFTYPE, AND FFOPTIONS                      
*    (IE, FILE NAME, FILE HOST, FILE TYPE, FILE OPTIONS)                        
*  ON EXIT:                                                                     
*    FFRNAME CONTAINS FULL NAME                                                 
*    R15=0 NAME RESOLVED.  R15=NZ IF ERROR, ERR MSG TSEG'D.                     
*                                                                               
*  NOTE:                                                                        
*    SOME ERRORS EXIT VIA CVERROR                                               
*                                                                               
*                                                                               
NRESOLVE XPROC ,                                                                
*                                                                               
         L     R6,CPFINFOP                                                      
         IF    (R6,Z),' BOMB '                                                  
         USING FFINFO,R6                                                        
*                                                                               
         COMMENT                   MUST HAVE FILE NAME, FILE TYPE               
         IF    (FFNAMEL,EQ,0),' BOMB '                                          
         IF    (FFTYPE,EQ,0),' BOMB '                                           
*                                                                               
         COMMENT                   RESOLVE NAME BASED ON FILE TYPE              
         LA     R1,FFINFO                                                       
         IF     FFFWINGS,BEGIN     WINGS NAME RESOLVE                           
         VCALL WGSRESLV                                                         
         IF    NZ,BEGIN            ERRORS EXIT VIA CVERROR                      
         IF    ^CPFDSNNE,BEGIN     UNLESS CPFDSNNE SET                          
         B     CVERROR                                                          
         END                                                                    
         END                                                                    
         END                                                                    
         ELSEIF FFFOLD,'ACALL DSNRESLV'                                         
         ELSEIF FFFNET,'VCALL NETRESLV'                                         
         ELSEIF FFFUNIX,'VCALL UFSRESLV'                                        
         ELSEIF FFFSAM,'VCALL SAMRESLV'                                         
*                                                                               
         PEND                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*                                                                               
DSNRESLV PROC                                                                   
         VCALL EXPCNAME            EXPORT NAME FROM DSN WORK AREA               
         CLEAR R15                                                              
         PEND                                                                   
         EJECT                                                                  
*                                                                               
         VLTORG                                                                 
         END   .                                                                
