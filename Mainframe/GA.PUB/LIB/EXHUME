; EXHUME version of 08/27/91 by Mark Lawrence
; 08/27/91:  RUN HOLD is default
; 06/01/88:  ATTN handling
; 11/10/87:  fix loop on bad library dsn
; 06/25/87:  save recovered file as permanent data set
; 08/18/86:  new variable names, open new active file, don't set
;            length, general cleanup
;
COMM EXHUME version of 08/27/91
COMM
CLEAR VARIABLES
DECLARE STRING OLDESC DV LIBDSN FILEOUT
DECLARE NUM IX USERACT
OLDESC = ESC
SET ESC &
USERACT = ACTNO
;

LIBDSN=UPPER(STRIP(PARM))
IF (LIBDSN NE '') EXE 300 ; got a name

READ STR S0 UPPER PROMPT 'Do you need instructions? ' ATTN=1200
IF (SIZE(S0) EQ 0) EXEC 150
IF (SUBSTR(S0,1,1) EQ 'N') EXEC 150
LIS 2001/2099 EXE UNN ATTN=150

;  library
;
COMM
REA STR LIBDSN UPP PRO 'Name of library (<CR>=&(LIBRARY))? '  ATTN=100
IF (SIZE(LIBDSN) EQ 0) LIBDSN = LIBRARY
   THEN EXEC 300
IF (INDEX('.HELP.?.','.&(LIBDSN).') EQ 0) EXEC 300 ; NOT HELP, IS DSN
; help dsn
TRY WRI 'Enter the name of the library to be exhumed.  If you just press RETURN,'
IF (~TRYATTN) WRI 'your default library &(LIBRARY) will be processed.'
EXEC 200

;  Library dsn check, qualify
TRY DV=DSNVER(LIBDSN)
IF (~TRYERR) EXEC 310
TRY WRI LIBDSN||':  INVALID.  Specify the library name as you would in a WYLBUR command.'
EXE 200 ; try again

; try succeeded (DSNVER didn't blow up)...
IF (DV EQ 'OK') EXEC 350 ; name ok, qualify it
TRY WRI LIBDSN||' data set is '||DV
EXEC 200 ; TRY AGAIN

; QUALIFY DSN
LIBDSN=DSNFORMAT(LIBDSN)

;  OUTPUT FILE
;
WRI ' '
REA STR FILEOUT UPP PRO 'Specify the data set name to be used for the dumped members: ' ATTN=200
IF (SIZE(FILEOUT) EQ 0) FILEOUT = 'PDSDUMP'
   THEN EXEC 730
IF (INDEX('.HELP.?.','.&(FILEOUT).') EQ 0) EXEC 730 ; not help
TRY WRI ' '
TRY WRI 'Specify the name to be assigned to the new file to be created by'
TRY WRI 'EXHUME.  This file must not exist now, as it will be created by'
TRY WRI 'this EXHUME job.'
EXE 700

;  DSNAME PREFIX CHECK
;
TRY FILEOUT=DSNFORMAT(FILEOUT)
IF (~TRYERR) EXEC 900 ; OK
WRI FILEOUT||':  Invalid data set name'
EXEC 700

;
;  BUILD JCL

OPEN EXHUME TITLE 'JCL generated by UTIL EXHUME'
S0 = LIBDSN                      ; LIB
IX=SIZE(LIBDSN)
IF (IX LT 14) S0 = 'EXHUME '||S0
IF (IX GT 20) S0 = SUBSTR(S0,IX-19)
;
PUTEND //   JOB  ,'&(S0)',TIME=(,15)
PUTEND // EXEC EXHUME,
PUTEND // LIB='&(LIBDSN)',
PUTEND // DUMPDSN='&(FILEOUT)'
PUTEND //DUMP  DD  UNIT=DISK
;
;  READY TO RUN
;
COMM
REA STR S0 UPP PRO 'RUN? ' ATTN=1100
IF (SIZE(S0) EQ 0) EXE 1030
IF (SUBSTR(S0,1,1) EQ 'Y') EXE 1030
IF (S0 EQ 'OK') EXEC 1030
IF (S0 EQ 'HOLD') EXE 1030         ; RUN HOLD
IF (S0 EQ 'NOHOLD') EXE 1031       ; RUN NOHOLD
IF (SUBSTR(S0,1,1) EQ 'N') EXE 1100
;
;  EXPLAIN RUN
;
COMM
COMM If you reply YES or "carriage return", the job will be submitted
COMM with a RUN command, and your previous active file will be restored.
COMM If you reply NO, EXHUME will not run the job and will leave the JCL in your
COMM active file for you to inspect or modify.  You will then have to issue a
COMM RUN command to actually submit the job, and a PICK command to
COMM restore your previous active file.
COMM
;
EXEC 1000
;
PUTEND /*JOBPARM HOLD=OUTPUT,PURGE=NO
RUN NUM
PICK &(USERACT)
EXE 1200

; DON'T RUN
;
COMM The JCL is in your active file; issue a RUN command to submit the job.
COMM Issue a PICK &(USERACT) command to restore your previous active file.
EXE 1200


; CLEAN UP
;
SET ESC '&(OLDESC)'
CLR EXE
; HELP

This execfile will submit a job to retrieve scratched members from a
WYLBUR library.  Members can be retrieved only if the library has
not been moved or condensed since they were scratched.

The recovered members will be placed in a new WYLBUR data set (not
a library).  You will need to search through this file to find the
recovered members.  The names of the members are not recovered,
only the contents.

EXHUME now saves the "recovered" file as a permanent data set, so
you may wish to scratch it once you have finished extracting
recovered members.

If you have problems with EXHUME, please use the CONSULT command to
obtain help.  While awaiting help, do not CONDENSE or LIBMOVE the
library; either of these will result in the complete loss of any
scratched members.
