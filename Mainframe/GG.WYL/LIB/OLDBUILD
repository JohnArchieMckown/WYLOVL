//&$KBLD JOB ,'KWR-BUILD',TIME=5
/*JOBPARM NOTIFY=YES,HOLD=OUTPUT
// EXEC PL1XCG
//PLI.SYSIN DD *
 /*  KWRFMT -- ROUTINE TO FORMAT KEYWORD FILE  */

 KWRFMT: PROC OPTIONS (MAIN);

   DCL  (KWRFILE DIRECT OUTPUT) FILE KEYED
        ENVIRONMENT (REGIONAL(2) F);

   OPEN FILE (KWRFILE) TITLE ('KWRFILE');  /* PL/I WILL FORMAT */
   CLOSE FILE (KWRFILE);

 END KWRFMT;
//GO.KWRFILE DD DSN=WYL.GG.JDN.KWRFILE,VOL=SER=PUB022,
// UNIT=DASD,SPACE=(CYL,(50,5),,CONTIG),DISP=(,CATLG),
// DCB=(DSORG=DA,RECFM=F,BLKSIZE=197,LRECL=197,KEYLEN=5)
//*
// EXEC HIBALCLG,TIME.GO=4
KWRBUILD TITLE 'PROGRAM TO RE-BUILD (COPY) THE KEYWORD FILE'
         HIBAL
         COPY  UTYPDEFN
*
KWRBUILD CSECT
*
         DATA  BEGIN
INFILE   DCB   DSORG=PS,MACRF=R,DDNAME=INFILE,KEYLEN=5,RECFM=F,        *
               EODAD=EOF
*
KWLIST   DC    0A(0),AL1(KWRCWR),AL3(KWR)
KWR      KWREC
         END
*
         BASE  R7
         LA    R13,STACK
         LR    R8,R13
*
         OPEN  (INFILE,(INPUT))
RDLOOP   READ  RDECB,SF,INFILE,KWR
         CHECK RDECB
         IF    (KWRUSER,EQ,X'FF'),RDLOOP  EMPTY RECORD
         XC    KWRUSER(5),=C'TTMCC'
         XC    KWRKEY,=C'EATATCIT'
         XC    KWRKEY+4(4),KWRKEY
*
         CLEAR KWRWRCT             SET REWR COUNT TO ZERO FOR ADD
*
         LA    R6,3
RETRY    LA    R1,KWLIST
         CLEAR R0                  (NO TTR)
         L     R15,=V(KWEXCP)
         BALR  R14,R15
WAIT     L     R1,=V(KWECB)
         WAIT  ECB=(1)
         L     R15,=V(KWWAIT)
         BALR  R14,R15
         B     WAIT                +0: RETURN FOR WAIT
         IF    KWRHFL.KWRHFUOK,RDLOOP  IT WORKED
         QSNAP 'RE-WRITE FAILED...'
         QSNAP KWRUSER,5
         BCT   R6,RETRY
         ABEND 1,DUMP              SHUCKS
*
EOF      ABEND 0                   ALL DONE
*
U        DS    X
*
BLANKS   DC    CL80' '
STACK    DS    512F
         END   .
//LKED.WYLBUR  DD DSN=WYL.GG.JDN.OBJECT,DISP=SHR
//LKED.SYSIN   DD *
 INCLUDE WYLBUR(WYLKWWR)
 ENTRY KWRBUILD
//*
//GO.SYSUDUMP DD SYSOUT=$
//GO.INFILE DD DSN=SYS2.TEST.COBOL.V2R3,DISP=SHR
//GO.KWRFILE DD DSN=WYL.GG.JDN.KWRFILE,DISP=SHR
