IEFU83   TITLE 'IEFU83 Exit for Type 30 SMF Records'                    00001000
         SPACE 2                                                        00002000
********************************************************************    00003000
********************************************************************    00004000
**                                                                **    00005000
**                          I E F U 8 3                           **    00006000
**                                                                **    00007000
**  Updates:                                                      **    00008000
**  1997/09/23 MCL - New version, only for type 30 processing.    **    00009000
**                   Previous version was also used for TLMS      **    00010000
**                   CLOSE processing, which has been moved into  **    00011000
**                   the IFG019FE exit.                           **    00012000
**                                                                **    00013000
********************************************************************    00014000
********************************************************************    00015000
*                                                                  *    00016000
*   This routine operates as the SMF exit IEFU83 and is entered    *    00017000
*   by SMF prior to writing any SMF record.  Only SMF calls        *    00018000
*   generated by the SVC interface are trapped by this module,     *    00019000
*   records generated by the branch interface to SMF are not       *    00020000
*   trapped.                                                       *    00021000
*                                                                  *    00022000
*   The type 30 SMF, subtype 2&3, record is processed to insert    *    00023000
*   the current time block value from the SCIPCVT.                 *    00024000
*                                                                  *    00025000
********************************************************************    00026000
*                                                                  *    00027000
*        %%Module:    iefu83                                       *    00028000
*        %%Langue:    asm                                          *    00029000
*        %%Compile:   .asm                                         *    00030000
*                                                                  *    00031000
********************************************************************    00032000
*                                                                  *    00033000
*   Input:                                                         *    00034000
*                                                                  *    00035000
*        On entry to this exit register one points to the address  *    00036000
*        of the SMF record to be written.  Standard entry          *    00037000
*        conventions are used.  Entry is in key zero and supervisor*    00038000
*        state.                                                    *    00039000
*                                                                  *    00040000
*   Output:                                                        *    00041000
*                                                                  *    00042000
*        A zero return code is passed back to SMF to allow the     *    00043000
*        writing of the SMF record.                                *    00044000
*                                                                  *    00045000
********************************************************************    00046000
                                                                        00047000
IEFU83   CSECT ,                   DECLARE CONTROL SECTION NAME         00048000
IEFU83   AMODE 31                  UTILIZE 31 BIT ADDRESSING            00049000
IEFU83   RMODE ANY                 ANY RESIDENCE MODE ALLOWED           00050000
         EJECT ,                                                        00051000
         REGISTER                                                       00052000
*BOX                                                                    00053000
*                                                                       00054000
*  DECLARE SYSTEM MAPPING MACROS                                        00055000
*                                                                       00056000
         SPACE 2                                                        00057000
**?      PRINT NOGEN                                                    00058000
         IECDIOCM ,                                                     00059000
         CVT   DSECT=YES                                                00060000
SCIPCVT  SCIPCVT ,                                                      00061000
         IFASMFR 30                GENERATE TYPE 30 MAPPING             00062000
         PRINT GEN                                                      00063000
         EJECT ,                                                        00064000
IEFU83   CSECT ,                   CONTINUE CONTROL SECTION             00065000
*BOX                                                                    00066000
*                                                                       00067000
*  MAIN ENTRY FOR IEFU83                                                00068000
*                                                                       00069000
*                                                                       00070000
                                                                        00071000
         USING IEFU83,R15                                               00072000
         B     IEFU83ID            SKIP MODULE IDENTIFIER               00073000
         DC    CL8'IEFU83'                                              00074000
         DC    CL8'&SYSTIME'                                            00075000
         DC    CL8'&SYSDATE'                                            00076000
IEFU83ID EQU   *                                                        00077000
         DROP  R15                 RELEASE TEMPORARY ADDRESSABILITY     00078000
         STM   R14,R12,12(R13)     SAVE CALLING REGISTERS               00079000
         LR    R7,R15                ESTABLISH PROGRAM ADDRESSABILITY   00080000
         USING IEFU83,R7               DECLARE ROUTINE ADDRESSABILITY   00081000
         SPACE ,                                                        00082000
*-                                                                      00083000
*-       GET ADDRESS OF SMF RECORD.                                     00084000
*-                                                                      00085000
         L     R11,0(R1)               POINT TO SMF RECORD              00086000
         SPACE 2                                                        00087000
*-                                                                      00088000
*-       PROCESS TYPE 30 REQUEST                                        00089000
*-                                                                      00090000
         USING SMFRCD30,R11        ADDRESSABILITY TO TYPE 30            00091000
         CLI   SMF30RTY,30         Type 30?                             00092000
         BNE   TLMRET0             skip it if not                       00093000
*-                                                                      00094000
*-       Test for type-30 SMF interval record, (subtype 2)              00095000
*-                                                                      00096000
         LT    R3,SMF30SOF         Retreive subsystem section offset    00097000
         BZ    TLMRET0             Ignore if missing section            00098000
         CLC   SMF30SON,=XL2'0000' Test count of sections               00099000
         BZ    TLMRET0             Ignore if count is zero              00100000
         ALR   R3,R11              Address of subsystem section         00101000
         USING SMF30PSS,R3                                              00102000
         CLC   SMF30TYP,=H'1'      Only want 2                          00103000
         BL    TLMRET0                or                                00104000
         CLC   SMF30TYP,=H'3'           3                               00105000
         BH    TLMRET0             ...skip all others                   00106000
*-                                                                      00107000
*-       Plug current time block from SCIPCVT into type-30 record       00108000
*-                                                                      00109000
         LT    R3,SMF30IOF         Offset of identification section     00110000
         BZ    TLMRET0             No identification section, ignore    00111000
         CLC   SMF30ION,=XL2'0000' Test count of ident sections         00112000
         BZ    TLMRET0             Ignore record if zero count          00113000
         ALR   R3,R11              Address of identification section    00114000
         USING SMF30ID,R3          Addressability to id section         00115000
         L     R15,CVTPTR          Access cvt address                   00116000
         L     R15,CVTUSER-CVT(,R15)   address of scip-cvt              00117000
         LTR   R15,R15             got an address                       00118000
         BZ    TLMRET0               no SCIPCVT yet, ignore             00119000
         USING SCIPCVT,R15                                              00120000
         MVC   SMF30JPT+1(1),USEBLOCK  Set execution time block         00121000
         USING SMF30PSS,R3         Addressability to subsystem          00122000
         B     TLMRET0             RETURN TO SMF                        00123000
         DROP  R3                                                       00124000
         DROP  R15                                                      00125000
         SPACE 2                                                        00126000
TLMRET0  LM    R14,R12,12(R13)       RESTORE REGISTERS                  00127000
         XR    R15,R15                 CLEAR RETURN CODE                00128000
         BR    R14                       AND RETURN TO SMF              00129000
         SPACE ,                                                        00130000
         LTORG ,                                                        00131000
         END                                                            00132000
