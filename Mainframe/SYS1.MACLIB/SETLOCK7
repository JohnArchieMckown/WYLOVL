         MACRO                                                          00050000
&NAME    SETLOCK7 &REQUEST,&TYPE=,&ADDR=,&MODE=,&DISABLE,&RELATED=,    X00100000
               &REGS=,&BRANCH=,&ASCB=,&LOCKHLD=                         00150000
.*                                                                      00200000
.*01*  COPYRIGHT =                                                      00250000
.*        5740-XC6 COPYRIGHT IBM CORP 1981,                             00300000
.*        LICENSED MATERIAL-PROGRAM; PROPERTY OF IBM;                   00350000
.*        REFER TO COPYRIGHT INSTRUCTIONS FORM NUMBER                   00400000
.*        G120-2083.                                                    00450000
.*                                                                      00500000
.*01*   STATUS = OS/VS2 HBB2102                                         00550000
.*                                                                      00600000
.*01*   CHANGE ACTIVITY =                                               00650000
.*               HBB2102 SUPPORT                                        00700000
.*                                                                      00750000
.*A-000000-999999                                              @G860PXD 00800000
.*                                                                      00850000
         GBLC  &MESSAGE                                                 00900000
         LCLA   &INDEX,&INDEX0                                          00950000
         LCLA  &OFSET,&MASK,&BYTE,&I                                    01000000
         LCLA  &LOCK,&LOCALX,&CMLX                                      01050000
         LCLB  &ADVALID,&COND(4)                                        01100000
         LCLB  &TYPEREG                                                 01150000
         LCLC  &MESSAG2,&REG1,&RADDR,&BRADR(4)                          01200000
         LCLC  &INSTR,&AREA,&LABEL,&REG2                                01250000
*        MACDATE = 06/30/81                                             01300000
         AIF   ('&REQUEST' EQ 'TEST').TEST                              01350000
&INDEX   SETA  0                                                        01400000
         AIF   (T'&RELATED NE 'O').RELATED                              01450000
.*       IHB001  RELATED OPERAND REQUIRED, NOT SPECIFIED                01500000
         IHBERMAC 1006,RELATED                                          01550000
         MEXIT                                                          01600000
.RELATED ANOP                                                           01650000
         AIF   (T'&BRANCH EQ 'O').NOBRNAM                               01700000
.*       IHB280 BRANCH INVALID WITH OBTAIN/RELEASE                      01750000
         IHBERMAC 1020,BRANCH,&REQUEST                                  01800000
         MEXIT                                                          01850000
.NOBRNAM ANOP                                                           01900000
         AIF   ('&REQUEST' EQ 'OBTAIN').OBTAIN                          01950000
         AIF   ('&REQUEST' EQ 'RELEASE').RELEASE                        02000000
         IHBERMAC 24                                                    02050000
         MEXIT                                                          02100000
.OBTAIN  AIF   (T'&TYPE EQ 'O').ERRTYPE                                 02150000
         AIF   ('&TYPE' EQ 'ALOCAL').EROALOC                            02200000
         AIF   ('&DISABLE' EQ '').OBTAIN2                               02250000
         AIF   ('&DISABLE' NE 'DISABLED').ERROD                         02300000
.OBTAIN2 ANOP                                                           02350000
         AIF   ('&MODE' EQ 'COND').COND      COND REQUIRES NO INCREMENT 02400000
         AIF   ('&MODE' EQ 'UNCOND').UNCOND                             02450000
         AIF   ('&MODE' NE '').MODERR                                   02500000
.*       IHB001  MODE OPERAND REQUIRED, NOT SPECIFIED                   02550000
         IHBERMAC 1006,MODE                                             02600000
         MEXIT                                                          02650000
.EROALOC ANOP                                                           02700000
.*       IHB280 ALOCAL INVALID WITH OBTAIN                              02750000
         IHBERMAC 1020,ALOCAL,OBTAIN                                    02800000
         MEXIT                                                          02850000
.MODERR  ANOP                                                           02900000
.*       IHB002  INVALID MODE OPERAND SPECIFIED - XXX                   02950000
               IHBERMAC 1001,MODE,&MODE                                 03000000
         MEXIT                                                          03050000
.ERROD   ANOP                                                           03100000
         AIF   ('&DISABLE' EQ 'DISABLED').ERROD1                        03150000
.*       IHB244  INVALID POSIT-NL XXX OPERAND                           03200000
.INVLDIS IHBERMAC 1008,&DISABLE,1                                       03250000
         MEXIT                                                          03300000
.ERROD1  ANOP                                                           03350000
&MESSAGE SETC  'COND OR SUSPEND LOCK OBTAIN'                            03400000
.*       IHB280  DISABLE INVALID WITH COND OR SUSPEND LOCK OBTAIN       03450000
         IHBERMAC 1020,&DISABLE,&MESSAGE                                03500000
         MEXIT                                                          03550000
.UNCOND  ANOP                                                           03600000
&INDEX   SETA  (&INDEX+12)              INCREMENT TO UNCOND OBTAIN      03650000
         AGO   .REGS                                                    03700000
.RELEASE AIF   (T'&MODE NE 'O').ERRMOD                                  03750000
         AIF   (T'&TYPE EQ 'O').ERRTYPE                                 03800000
         AIF   ('&TYPE' EQ 'ALOCAL').ERRALOC                            03850000
         AIF   ('&DISABLE' EQ 'DISABLED').TESTSUP  TEST FOR SUSPEND REQ 03900000
         AIF   ('&DISABLE' EQ '').RELSE                                 03950000
.*       IHB244  INVALID POSIT-NL XXX OPERAND                           04000000
         IHBERMAC 1008,&DISABLE,1                                       04050000
         MEXIT                                                          04100000
.ERRTYPE ANOP                                                           04150000
.*       IHB001 TYPE OPERAND REQUIRED, NOT SPECIFIED                    04200000
         IHBERMAC 1006,TYPE                                             04250000
         MEXIT                                                          04300000
.ERRMOD  ANOP                                                           04350000
.*       IHB280               MODE INVALID WITH RELEASE                 04400000
         IHBERMAC 1020,MODE,RELEASE                                     04450000
         MEXIT                                                          04500000
.ERRALOC ANOP                                                           04550000
.*       IHB280  ALOCAL INVALID WITH RELEASE                            04600000
         IHBERMAC 1020,ALOCAL,RELEASE                                   04650000
         MEXIT                                                          04700000
.RELSE   ANOP                                                           04750000
&INDEX   SETA  (&INDEX+24)              INCREMENT TO RELEASE W/O DISBLE 04800000
         AGO   .REGS                                                    04850000
.TESTSUP ANOP                                                           04900000
         AIF   ('&TYPE'(1,3) EQ 'CMS').ERRDIS                           04950000
         AIF   ('&TYPE' EQ 'LOCAL').ERRDIS                              05000000
         AIF   ('&TYPE' EQ 'CML').ERRDIS                                05050000
&INDEX   SETA  (&INDEX+36)              INCREMENT TO RELEASE DISABLE    05100000
         AGO   .REGS                                                    05150000
.ERRDIS  ANOP                                                           05200000
.*       IHB280  DISABLE INVALID WITH CMS/LOCAL/CML                     05250000
         IHBERMAC 1020,&DISABLE,&TYPE                                   05300000
         MEXIT                                                          05350000
.COND    ANOP                                                           05400000
         AIF   ('&DISABLE' NE '').ERROD                                 05450000
.REGS    ANOP                                                           05500000
         AIF   ('&REGS' EQ 'SAVE').TYPE SAVE IS VALID PARAMETER         05550000
         AIF   ('&REGS' EQ 'USE').TYPE  USE IS VALID PARAMETER          05600000
         AIF   ('&REGS' EQ '').TYPE     PARAMETER IS NOT REQUIRED       05650000
.*       IHB002 INVALID REGS OPERAND SPECIFIED - XXX                    05700000
         IHBERMAC 1001,REGS,&REGS                                       05750000
         MEXIT                                                          05800000
.TYPE    ANOP                                                           05850000
&INDEX0  SETA  &INDEX                                                   05900000
         AIF   ('&TYPE' EQ 'DISP').CODE1 HIGH LOCK INCR NOT REQ@G387PXR 05950000
&INDEX   SETA  (&INDEX+48)              INCREMENT FOR 1 SPIN LOCK ENTRY 06000000
         AIF   ('&TYPE' EQ 'IOSCAT').CODEA                              06050000
&INDEX   SETA  (&INDEX+48)                                              06100000
         AIF   ('&TYPE' EQ 'IOSUCB').CODEA                              06150000
&INDEX   SETA  (&INDEX+48)                                              06200000
         AIF   ('&TYPE' EQ 'IOSLCH').CODEA                              06250000
&INDEX   SETA  (&INDEX+48)                                              06300000
         AIF   ('&TYPE' EQ 'IOSYNCH').CODEA                             06350000
&INDEX   SETA  (&INDEX+48)                                              06400000
         AIF   ('&TYPE' EQ 'TPNCB').CODEA                               06450000
&INDEX   SETA  (&INDEX+48)                                              06500000
         AIF   ('&TYPE' EQ 'TPDNCB').CODEA                              06550000
&INDEX   SETA  (&INDEX+48)                                              06600000
         AIF   ('&TYPE' EQ 'TPACBDEB').CODEA                            06650000
&INDEX   SETA  (&INDEX+48)                                              06700000
         AIF   ('&TYPE' EQ 'ASM').CODEA                                 06750000
&INDEX   SETA  (&INDEX+48)                                              06800000
         AIF   ('&TYPE' EQ 'SALLOC').CODE1                              06850000
&INDEX   SETA  (&INDEX+48)                                              06900000
         AIF   ('&TYPE' EQ 'SRM').CODE1                                 06950000
&INDEX   SETA  (&INDEX+48)                                              07000000
         AIF   ('&TYPE' EQ 'CMS').CODE1                                 07050000
&INDEX   SETA  (&INDEX+36)                                              07100000
         AIF   ('&TYPE' EQ 'LOCAL').CODE1                               07150000
&INDEX   SETA  &INDEX+36-&INDEX0                                        07200000
         AIF   ('&TYPE' EQ 'CML').ADDICMS                               07250000
         AIF   ('&TYPE'(1,3) EQ 'CMS').ADDICMS                          07300000
         AIF   ('&REQUEST' NE 'RELEASE').BADTYPE                        07350000
         AIF   (T'&ADDR NE 'O').ERRADD                                  07400000
         AIF   ('&TYPE' EQ 'SPIN').RSPIN                                07450000
         AIF   ('&TYPE' EQ 'ALL').RALL                                  07500000
         AIF   ('&TYPE'(1,1) NE '(').BADTYPE                            07550000
         AIF   ('&TYPE'(K'&TYPE,1) EQ ')').RREG                         07600000
.ADDICMS ANOP                                                           07650000
&INDEX   SETA  (&INDEX+12+&INDEX0)                                      07700000
         AIF   ('&TYPE' EQ 'CMSEQDQ').CODE1                             07750000
&INDEX   SETA  (&INDEX+24)                                              07800000
         AIF   ('&TYPE' EQ 'CMSALL').CKALL                              07850000
&INDEX   SETA  (&INDEX+48)                                              07900000
         AIF   ('&TYPE' EQ 'CMSSMF').CODE1                              07950000
&INDEX   SETA  (&INDEX+36)                                              08000000
         AIF   ('&TYPE' EQ 'CML').CODE                                  08050000
         AGO   .BADTYPE                                                 08100000
.CKALL   ANOP                                                           08150000
         AIF   ('&MODE' NE 'COND').CODE1                                08200000
         MNOTE 8,'*** &TYPE CONDITIONAL OBTAIN NOT SUPPORTED'           08250000
         MEXIT                                                          08300000
.BADTYPE AIF   ('&TYPE' NE '').INVTYP                                   08350000
.*       IHB001 TYPE OPERAND REQUIRED NOT SPECIFIED                     08400000
         IHBERMAC 1006,TYPE                                             08450000
         MEXIT                                                          08500000
.INVTYP  ANOP                                                           08550000
.*       IHB002  INVALID TYPE OPERAND SPECIFIED                         08600000
         IHBERMAC 1001,TYPE,&TYPE                                       08650000
         MEXIT                                                          08700000
.CODE1   AIF   (T'&ASCB NE 'O').LOCASCB                                 08750000
         AIF   (T'&LOCKHLD EQ 'O').CODE                                 08800000
.*       IHB280 LOCKHLD INVALID WITH TYPE=XXX                           08850000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          08900000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                                 08950000
         MEXIT                                                          09000000
.LOCASCB ANOP                                                           09050000
.*       IHB280 ASCB INVALID WITH TYPE=XXX                              09100000
&MESSAGE SETC 'TYPE='.'&TYPE'                                           09150000
         IHBERMAC 1020,ASCB,&MESSAGE                                    09200000
         MEXIT                                                          09250000
.CODE    AIF   ('&ADDR' NE '').ERRADD                                   09300000
         AIF   ('&REGS' EQ 'SAVE').SAVE1                                09350000
         AIF   ('&REGS' EQ 'USE').USE1                                  09400000
&NAME    L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 09450000
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                09500000
         AIF   ('&TYPE' EQ 'CML').LOAD                                  09550000
         LM    11,13,&INDEX.(13)        LOAD ADDRESS OF THE LOCKWORD,   09600000
*                                       CLHT AND LOCK RTNS ENTRY POINT  09650000
         AGO   .MNLCODE                                                 09700000
.SAVE1   ANOP                                                           09750000
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          09800000
         STM   11,14,0(15)              SAVE REGISTERS                  09850000
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 09900000
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                09950000
         AIF   ('&TYPE' EQ 'CML').LOAD                                  10000000
         LM    11,13,&INDEX.(13)        LOAD ADDRESS OF THE LOCKWORD,   10050000
*                                       CLHT AND LOCK RTNS ENTRY POINT  10100000
         AGO   .MNLCODE                                                 10150000
.USE1    ANOP                                                           10200000
&NAME    LR    15,11                    SAVE REGISTER 11                10250000
         LR    0,12                     SAVE REGISTER 12                10300000
         LR    1,13                     SAVE REGISTER 13                10350000
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 10400000
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                10450000
         AIF   ('&TYPE' EQ 'CML').LOAD                                  10500000
         LM    11,13,&INDEX.(13)        LOAD ADDRESS OF THE LOCKWORD,   10550000
*                                       CLHT AND LOCK RTNS ENTRY POINT  10600000
         AGO   .MNLCODE                                                 10650000
.LOAD    ANOP                                                           10700000
&INDEX   SETA  (&INDEX+8)                                               10750000
         AIF   ('&TYPE' EQ 'CML').CODEB                                 10800000
         L     13,&INDEX.(0,13)        LOAD ADDRESS OF LOCK RTN         10850000
         AGO   .MNLCODE                                                 10900000
.ERRADD  ANOP                                                           10950000
.*       IHB280 ADDR INVALID WITH TYPE=XXX                              11000000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          11050000
         IHBERMAC 1020,ADDR,&MESSAGE                                    11100000
         MEXIT                                                          11150000
.CODEA   ANOP                                                           11200000
&INDEX   SETA  (&INDEX+4)     INCREMENT PAST LK ADDR                    11250000
         AIF   (T'&ASCB NE 'O').INVASCB                                 11300000
         AIF   (T'&LOCKHLD EQ 'O').CODEA1                               11350000
.*       IHB280 LOCKHLD INVALID WITH TYPE=XXX                           11400000
&MESSAGE SETC 'TYPE='.'&TYPE'                                           11450000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                                 11500000
         MEXIT                                                          11550000
.INVASCB ANOP                                                           11600000
.*       IHB280 ASCB INVALID WITH TYPE=XXX                              11650000
&MESSAGE SETC 'TYPE='.'&TYPE'                                           11700000
         IHBERMAC 1020,ASCB,&MESSAGE                                    11750000
         MEXIT                                                          11800000
.CODEA1  AIF   ('&ADDR' EQ '(11)').MR11 LK ADDR ALREADY LOADED          11850000
         AIF   ('&ADDR' NE '').ADRLA                                    11900000
.*       IHB001 ADDR OPERAND REQUIRED NOT SPECIFIED                     11950000
         IHBERMAC 1006,ADDR                                             12000000
         MEXIT                                                          12050000
.CODEB   ANOP                                                           12100000
         AIF   (T'&ASCB EQ 'O').ERRASCB                                 12150000
         AIF   ('&ASCB' EQ '(11)').CMLR11                               12200000
         AIF   ('&ASCB'(1,1) EQ '(').ERREG2                             12250000
         AIF   ('&ASCB' NE '').CMLLA                                    12300000
.ERRASCB ANOP                                                           12350000
.*       IHB001  ASCB OPERAND REQUIRED NOT SPECIFIED                    12400000
         IHBERMAC 1006,ASCB                                             12450000
         MEXIT                                                          12500000
.CMLR11  ANOP                                                           12550000
         L     13,&INDEX.(0,13)         LOAD ADDR OF LOCK RTN           12600000
         AGO   .MNLCODE                                                 12650000
.CMLLA   L     11,&ASCB                 LOAD ASCB ADDR FOR CML          12700000
         L     13,&INDEX.(0,13)         LOAD ADDR OF LOCK RTN           12750000
         AGO   .MNLCODE                                                 12800000
.ERREG2  ANOP                                                           12850000
&MESSAGE SETC  'REGISTER NOTATION'                                      12900000
.*       IHB280 REGISTER NOTATION INVALID WITH ASCB                     12950000
         IHBERMAC 1020,&MESSAGE,ASCB                                    13000000
         MEXIT                                                          13050000
.ERREG1  ANOP                                                           13100000
&MESSAGE SETC  'REGISTER NOTATION'                                      13150000
.*       IHB280 REGISTER NOTATION INVALID WITH ADDR                     13200000
         IHBERMAC 1020,&MESSAGE,ADDR                                    13250000
         MEXIT                                                          13300000
.ADRLA   ANOP                                                           13350000
         AIF   ('&ADDR'(1,1) EQ '(').ERREG1                             13400000
         AIF   ('&REGS' EQ 'SAVE').SAVE2                                13450000
         AIF   ('&REGS' EQ 'USE').USE2                                  13500000
&NAME    LA    11,&ADDR                 LOCKWORD ADDRESS                13550000
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 13600000
         LM    12,13,&INDEX.(13)        LOAD CLHT & ENTRY POINT ADDRESS 13650000
         AGO   .MNLCODE                                                 13700000
.SAVE2   ANOP                                                           13750000
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          13800000
         STM   11,14,0(15)              SAVE REGISTERS                  13850000
         LA    11,&ADDR                 LOCKWORD ADDRESS                13900000
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 13950000
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  14000000
         AGO   .MNLCODE                                                 14050000
.USE2    ANOP                                                           14100000
&NAME    LR    15,11                    SAVE REGISTER 11                14150000
         LR    0,12                     SAVE REGISTER 12                14200000
         LR    1,13                     SAVE REGISTER 13                14250000
         LA    11,&ADDR                 LOCKWORD ADDRESS                14300000
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 14350000
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  14400000
         AGO   .MNLCODE                                                 14450000
.MR11    ANOP                                                           14500000
         AIF   ('&REGS' EQ 'SAVE').SAVE3                                14550000
         AIF   ('&REGS' EQ 'USE').USE3                                  14600000
&NAME    L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 14650000
         LM    12,13,&INDEX.(13)        LOAD CLHT & ENTRY POINT ADDRESS 14700000
         AGO   .MNLCODE                                                 14750000
.SAVE3   ANOP                                                           14800000
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          14850000
         STM   11,14,0(15)              SAVE REGISTERS                  14900000
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 14950000
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  15000000
         AGO   .MNLCODE                                                 15050000
.USE3    ANOP                                                           15100000
&NAME    LR    15,11                    SAVE REGISTER 11                15150000
         LR    0,12                     SAVE REGISTER 12                15200000
         LR    1,13                     SAVE REGISTER 13                15250000
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 15300000
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  15350000
.MNLCODE ANOP                                                           15400000
         AIF   ('&MODE' EQ 'UNCOND').BALCK                              15450000
.MNLCOD2 ANOP                                                           15500000
         BALR  14,13                    BRANCH ENTER LOCK ROUTINE       15550000
.MNLCOD3 ANOP                                                           15600000
         AIF   ('&REGS' EQ 'SAVE').SAVE4                                15650000
         AIF   ('&REGS' NE 'USE').ENDIT                                 15700000
         LR    11,15                    RESTORE REGISTER 11             15750000
         LR    15,13                    PUT RETURN CODE IN REGISTER 15  15800000
         LR    12,0                     RESTORE REGISTER 12             15850000
         LR    13,1                     RESTORE REGISTER 13             15900000
         AGO   .ENDIT                                                   15950000
.BALCK   ANOP                                                           16000000
         AIF   ('&DISABLE' EQ '').MNLCOD2                               16050000
         AIF   ('&TYPE' EQ 'LOCAL').ERROD1                              16100000
         AIF   ('&TYPE' EQ 'CML').ERROD1                                16150000
         AIF   ('&TYPE'(1,3) EQ 'CMS').ERROD1                           16200000
         BAL   14,4(0,13)              BRANCH TO LOCK RTN AT DIS ENTRY  16250000
*        NOTE: YOU HAVE JUST SAID THAT YOU ARE DISABLED                 16300000
         AGO   .MNLCOD3                                                 16350000
.SAVE4   ST    13,16(0,15)              STORE RETURN CODE               16400000
         LM    11,15,0(15)              RESTORE REGS - RC IN REG 15     16450000
         MEXIT                                                          16500000
.RALL    ANOP                                                           16550000
         AIF   (T'&ASCB NE 'O').RALLASI                                 16600000
         AIF   (T'&LOCKHLD EQ 'O').RALLOK                               16650000
.*       IHB280 LOCKHLD INVALID WITH TYPE=ALL                           16700000
&MESSAGE SETC 'TYPE='.'&TYPE'                                           16750000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                                 16800000
         MEXIT                                                          16850000
.RALLASI ANOP                                                           16900000
.*       IHB280 ASCB INVALID WITH TYPE=ALL                              16950000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          17000000
         IHBERMAC 1020,ASCB,&MESSAGE                                    17050000
         MEXIT                                                          17100000
.RALLOK  ANOP                                                           17150000
         AIF   ('&NAME' EQ '').RALLNN                                   17200000
&NAME    DC    0H'0'                                                    17250000
.RALLNN  AIF   (T'&REGS EQ 'O').RCMS                                    17300000
         AIF   ('&REGS' EQ 'SAVE').RALLS                                17350000
         LR    15,11              SAVE REG11                            17400000
         LR    0,12               SAVE REG12                            17450000
         LR    1,13               SAVE REG13                            17500000
         AGO   .RCMS                                                    17550000
.RALLS   ANOP                                                           17600000
         LR    15,13              SAVE AREA ADDRESS                     17650000
         STM   11,14,0(15)        SAVE REG11 THRU R14                   17700000
.RCMS    ANOP                                                           17750000
&LABEL   SETC  'IHA&SYSNDX'                                             17800000
&LOCALX  SETA  596                INDEX IN IEAVELIT FO LOCAL            17850000
&CMLX    SETA  752                INDEX IN IEAVELIT FOR CML             17900000
         TM    PSAHLHI-PSA+3(0),2 IS A CROSS MEMORY SERVICES            17950000
*                                 LOCK HELD?                            18000000
         BZ    &LABEL.A           NO: SKIP CROSS MEMORY                 18050000
*                                 SERVICES RELEASE                      18100000
         L     13,PSALITA-FLC(0,0) ADDR OF LOCK INTERFACE TAB           18150000
         LM    11,13,672(13)      LOAD ADDR OF FIRST CROSS              18200000
*                                 MEMORY SERVICES LOCK IN SLA,          18250000
*                                 MASK FOR HLHI UPDATE, AND             18300000
*                                 LOCK RTNS ENTRY POINT                 18350000
         BALR  14,13              LINK TO LOCK RTN                      18400000
&LABEL.A DC    0H'0'              BRANCH LABEL                          18450000
         TM    PSAHLHI-PSA+3(0),1 IS LOCAL LOCK HELD?                   18500000
         BZ    &LABEL.B           NO: SKIP LOCAL LOCK RELEASE           18550000
         L     11,PSALOCAL-FLC(0,0) LOAD CLHT VALUE                     18600000
         LTR   11,11              VALUE ZERO?                           18650000
         BZ    &LABEL.C           BRANCH - LOCAL HELD                   18700000
         L     13,PSALITA-FLC(0,0) ADDR OF LOCK INTERFACE TAB           18750000
         L     13,&CMLX.(13)      LOAD LOCK ROUTINE ENTRY PT            18800000
         BALR  14,13              LINK TO LOCK ROUTINE                  18850000
         B     &LABEL.B           BRANCH AROUND LOCAL CODE              18900000
&LABEL.C DC    0H'0'              BRANCH LABEL                          18950000
         L     13,PSALITA-FLC(0,0) ADDR OF LOCK INTERFACE TAB           19000000
         L     13,&LOCALX.(0,13)  LOAD LOCK RTN ENTRY POINT             19050000
         BALR  14,13              LINK TO LOCK ROUTINE                  19100000
&LABEL.B DC    0H'0'              BRANCH LABEL                          19150000
         AGO   .RSPINC                                                  19200000
.RSPIN   ANOP                                                           19250000
         AIF   ('&NAME' EQ '').RSPINNN                                  19300000
&NAME    DC    0H'0'                                                    19350000
.RSPINNN AIF   (T'&REGS EQ 'O').RSPINC                                  19400000
         AIF   ('&REGS' EQ 'SAVE').RSPINS                               19450000
         LR    15,11              SAVE REG11                            19500000
         LR    0,12               SAVE REG12                            19550000
         LR    1,13               SAVE REG13                            19600000
         AGO   .RSPINC                                                  19650000
.RSPINS  ANOP                                                           19700000
         LR    15,13              SAVE AREA ADDRESS                     19750000
         STM   11,14,0(15)        SAVE REGS 11 THRU 14                  19800000
.RSPINC  ANOP                                                           19850000
         L     13,PSALITA-FLC(0,0) GET LOCK INTERFACE TABLE ADDR        19900000
         LM    11,13,&INDEX.(13)  GET PARM & EP ADDR FROM TABLE         19950000
         N     11,PSAHLHI-PSA(0,0) KEEP ONLY SPIN LOCKS HELD            20000000
         BZ    *+10               EXIT IF NONE HELD                     20050000
         AIF   (T'&DISABLE EQ 'O').RSPINE                               20100000
         AIF   ('&DISABLE' NE 'DISABLED').INVLDIS                       20150000
         MVI   PSAMPSW-PSA(0),X'00' INDICATE RETURN DISABLED            20200000
         AGO   .RSPINR                                                  20250000
.RSPINE  ANOP                                                           20300000
         MVI   PSAMPSW-PSA(0),X'03' INDICATE RETURN ENABLED             20350000
.RSPINR  ANOP                                                           20400000
         BALR  14,13              LINK TO LOCK MANAGER                  20450000
         AIF   (T'&REGS EQ 'O').RSPINX                                  20500000
         AIF   ('&REGS' EQ 'USE').RSPINU                                20550000
         LM    11,14,0(15)        RESTORE REGS 11 THRU 14               20600000
.RSPINX  MEXIT                                                          20650000
.RSPINU  ANOP                                                           20700000
         LR    11,15              RESTORE REG11                         20750000
         LR    12,0               RESTORE REG12                         20800000
         LR    13,1               RESTORE REG13                         20850000
         MEXIT                                                          20900000
.RREG    ANOP                                                           20950000
         AIF   ('&NAME' EQ '').RREGNN                                   21000000
&NAME    DC    0H'0'                                                    21050000
.RREGNN  AIF   (T'&REGS EQ 'O').RREGC                                   21100000
         AIF   ('&REGS' EQ 'SAVE').RREGS                                21150000
         LR    15,11              SAVE REG11                            21200000
         LR    0,12               SAVE REG12                            21250000
         LR    1,13               SAVE REG13                            21300000
         AGO   .RREGC                                                   21350000
.RREGS   ANOP                                                           21400000
         LR    15,13              SAVE AREA ADDRESS                     21450000
         STM   11,14,0(15)        SAVE REGS 11 THRU 14                  21500000
.RREGC   ANOP                                                           21550000
&LABEL   SETC  'IHA&SYSNDX'                                             21600000
&LOCALX  SETA  596                INDEX IN IEAVELIT FOR LOCAL           21650000
&CMLX    SETA  752                INDEX IN IEAVELIT FOR CML             21700000
         LR    11,&TYPE(1)        PUT STRING IN PROPER REGISTER         21750000
         N     11,PSAHLHI-PSA(0,0) ARE ALL SPECIFIED LOCKS              21800000
*                                 HELD                                  21850000
         CR    11,&TYPE(1)        COMPARE WITH INPUT                    21900000
         BE    &LABEL.A           ALL ARE HELD: RELEASE                 21950000
         ABEND X'073',DUMP,,SYSTEM   NOT ALL HELD: ABEND                22000000
&LABEL.A DC    0H'0'              BRANCH LABEL                          22050000
         LA    12,2               MASK TO CHECK FOR CROSS               22100000
*                                 MEMORY SERVICES RELEASE               22150000
         NR    12,&TYPE(1)        IS CROSS MEMORY SERVICES              22200000
*                                 RELEASE REQUESTED?                    22250000
         BZ    &LABEL.B           NO: GO TO CHECK FOR LOCAL             22300000
         L     13,PSALITA-FLC(0,0) ADDR OF LOCK INTERFACE TAB           22350000
         LM    11,13,672(13)      LOAD ADDR OF FIRST CROSS              22400000
*                                 MEMORY SERVICES LOCK IN SLA,          22450000
*                                 MASK FOR HLHI UPDATE, AND             22500000
*                                 LOCK RTNS ENTRY POINT                 22550000
         BALR  14,13              LINK TO LOCK RTN                      22600000
&LABEL.B DC    0H'0'              BRANCH LABEL                          22650000
         LA    12,1               MASK TO CHECK FOR LOCAL               22700000
         NR    12,&TYPE(1)        IS LOCAL RELEASE REQUESTED?           22750000
         BZ    &LABEL.C           NO: SKIP LOCAL RELEASE                22800000
         L     11,PSALOCAL-FLC(0,0) LOAD CLHT VALUE                     22850000
         LTR   11,11              VALUE ZERO?                           22900000
         BZ    &LABEL.E           BRANCH - LOCAL HELD                   22950000
         L     13,PSALITA-FLC(0,0) ADDR OF LOCK INTERFACE TAB           23000000
         L     13,&CMLX.(13)      LOAD CML RELEASE ENTRY POINT          23050000
         BALR  14,13              LINK TO LOCK ROUTINE                  23100000
         B     &LABEL.C           BRANCH AROUND LOCAL RELEASE           23150000
&LABEL.E DC    0H'0'              BRANCH LABEL                          23200000
         L     13,PSALITA-FLC(0,0) ADDR OF LOCK INTERFACE TAB           23250000
         L     13,&LOCALX.(0,13)  LOAD LOCK ROUTINE ENTYR PT            23300000
         BALR  14,13              LINK TO LOCK ROUTINE                  23350000
&LABEL.C DC    0H'0'              BRANCH LABEL                          23400000
         L     13,PSALITA-FLC(0,0) GET LOCK INTERFACE TABLE ADDRESS     23450000
         LM    11,13,&INDEX.(13)  GET PARM & EP ADDR FROM TABLE         23500000
         NR    11,&TYPE(1)        ANY SPIN LOCK SPECIFIED?              23550000
         BZ    &LABEL.D           NO: EXIT                              23600000
         AIF   (T'&DISABLE EQ 'O').RREGE                                23650000
         AIF   ('&DISABLE' NE 'DISABLED').INVLDIS                       23700000
         MVI   PSAMPSW-PSA(0),X'00' INDICATE RETURN DISABLED            23750000
         AGO   .RREGCMS                                                 23800000
.RREGE   ANOP                                                           23850000
         MVI   PSAMPSW-PSA(0),X'03' INDICATE RETURN ENABLED             23900000
.RREGCMS ANOP                                                           23950000
         BALR  14,13              LINK TO LOCK MANAGER                  24000000
&LABEL.D DC    0H'0'              BRANCH LABEL                          24050000
         AIF   (T'&REGS EQ 'O').RREGX                                   24100000
         AIF   ('&REGS' EQ 'USE').RREGU                                 24150000
         LM    11,14,0(15)        RESTORE REGS 11 THRU 14               24200000
.RREGX   MEXIT                                                          24250000
.RREGU   ANOP                                                           24300000
         LR    11,15              RESTORE REG11                         24350000
         LR    12,0               RESTORE REG12                         24400000
         LR    13,1               RESTORE REG13                         24450000
         MEXIT                                                          24500000
.TEST    ANOP                                                           24550000
         AIF   (T'&TYPE EQ 'O').ERTTYP                                  24600000
         AIF   (T'&MODE EQ 'O').TSTDIS                                  24650000
.*       IHB280 MODE INVALID WITH TEST                                  24700000
         IHBERMAC 1020,MODE,TEST                                        24750000
         MEXIT                                                          24800000
.TSTDIS  AIF   (T'&DISABLE EQ 'O').TSTADR                               24850000
.*       IHB280 DISABLED INVALID WITH TEST                              24900000
         IHBERMAC 1020,DISABLED,TEST                                    24950000
         MEXIT                                                          25000000
.TSTADR  AIF   (T'&ADDR EQ 'O').TSTREG                                  25050000
         AIF   ('&ADDR'(1,1) NE '(').TSTBADR                            25100000
         AIF   ('&ADDR'(K'&ADDR,1) EQ ')').TSTREG                       25150000
.*       IHB002  INVALID ADDR OPERAND SPECIFIED- XXX                    25200000
.TSTBADR IHBERMAC 1001,ADDR,&ADDR                                       25250000
         MEXIT                                                          25300000
.TSTREG  AIF   (T'&REGS EQ 'O').TSTBR                                   25350000
         AIF   ('&REGS'(1,1) NE '(').TSTBREG                            25400000
         AIF   ('&REGS'(K'&REGS,1) EQ ')').TSTBR                        25450000
.*       IHB002  INVALID REGS OPERAND SPECIFIED- XXX                    25500000
.TSTBREG IHBERMAC 1001,REGS,&REGS                                       25550000
         MEXIT                                                          25600000
.TSTBR   AIF   (T'&BRANCH EQ 'O').TSTTYPE                               25650000
         AIF   (N'&BRANCH EQ 2).TSTCOND                                 25700000
.*       IHB247 INCORRECT NUMBER OF BRANCH VALUES                       25750000
.TINVBR  IHBERMAC 1012,BRANCH                                           25800000
         MEXIT                                                          25850000
.TSTCOND ANOP                                                           25900000
         AIF   ('&BRANCH(1)' EQ 'HELD').TSTTYPE                         25950000
         AIF   ('&BRANCH(1)' EQ 'NOTHELD').TSTTYPE                      26000000
.INVCOND ANOP                                                           26050000
.*       IHB002 INVALID BRANCH OPERAND SPECIFIED- XXX                   26100000
         IHBERMAC 1001,BRANCH,&BRANCH(1)                                26150000
         MEXIT                                                          26200000
.TSTTYPE ANOP                                                           26250000
         AIF   (T'&TYPE EQ 'O').ERTTYP                                  26300000
&BYTE    SETA  2                                                        26350000
&OFSET   SETA  0                                                        26400000
&MASK    SETA  16                                                       26450000
         AIF   ('&TYPE' EQ 'DISP').TNAMSYS                              26500000
&OFSET   SETA  &OFSET+4                                                 26550000
&MASK    SETA  &MASK/2                                                  26600000
         AIF   ('&TYPE' EQ 'ASM').TNAMC                                 26650000
&OFSET   SETA  &OFSET+4                                                 26700000
&MASK    SETA  &MASK/2                                                  26750000
         AIF   ('&TYPE' EQ 'SALLOC').TNAMSYS                            26800000
&OFSET   SETA  &OFSET+4                                                 26850000
&MASK    SETA  &MASK/2                                                  26900000
         AIF   ('&TYPE' EQ 'IOSYNCH').TNAMC                             26950000
&OFSET   SETA  &OFSET+4                                                 27000000
&MASK    SETA  &MASK/2                                                  27050000
         AIF   ('&TYPE' EQ 'IOSCAT').TNAMC                              27100000
&BYTE    SETA  3                                                        27150000
&OFSET   SETA  &OFSET+4                                                 27200000
&MASK    SETA  128                                                      27250000
         AIF   ('&TYPE' EQ 'IOSUCB').TNAMC                              27300000
&OFSET   SETA  &OFSET+4                                                 27350000
&MASK    SETA  &MASK/2                                                  27400000
         AIF   ('&TYPE' EQ 'IOSLCH').TNAMC                              27450000
&OFSET   SETA  &OFSET+4                                                 27500000
&MASK    SETA  &MASK/2                                                  27550000
         AIF   ('&TYPE' EQ 'TPNCB').TNAMC                               27600000
&OFSET   SETA  &OFSET+4                                                 27650000
&MASK    SETA  &MASK/2                                                  27700000
         AIF   ('&TYPE' EQ 'TPDNCB').TNAMC                              27750000
&OFSET   SETA  &OFSET+4                                                 27800000
&MASK    SETA  &MASK/2                                                  27850000
         AIF   ('&TYPE' EQ 'TPACBDEB').TNAMC                            27900000
&OFSET   SETA  &OFSET+4                                                 27950000
&MASK    SETA  &MASK/2                                                  28000000
         AIF   ('&TYPE' EQ 'SRM').TNAMSYS                               28050000
&OFSET   SETA  &OFSET+4                                                 28100000
&MASK    SETA  &MASK/2                                                  28150000
         AIF   ('&TYPE' EQ 'CMS').TNAMSYS                               28200000
&OFSET   SETA  &OFSET+4                                                 28250000
&MASK    SETA  &MASK/2                                                  28300000
         AIF   ('&TYPE' EQ 'LOCAL').TNAMSYS                             28350000
         AIF   ('&TYPE' EQ 'CML').TNAMSYS                               28400000
         AIF   ('&TYPE' EQ 'ALOCAL').TNAMSYS                            28450000
         AIF   (T'&ADDR EQ 'O').TALL                                    28500000
.*       IHB280 ADDR INVALID WITH TYPE=ALL/REG                          28550000
.TADINVL ANOP                                                           28600000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          28650000
         IHBERMAC 1020,ADDR,&MESSAGE                                    28700000
         MEXIT                                                          28750000
.TALL    AIF   ('&TYPE' EQ 'ALL').TALLC                                 28800000
         AIF   ('&TYPE' EQ 'SPIN').TALLC                                28850000
.TREG    ANOP                                                           28900000
         AIF   ('&TYPE'(1,1) NE '(').TTYPINV                            28950000
         AIF   ('&TYPE'(K'&TYPE,1) EQ ')').TREGC                        29000000
.*       IHB002 INVALID TYPE OPERAND SPECIFIED- XXX                     29050000
.TTYPINV IHBERMAC 1001,TYPE,&TYPE                                       29100000
         MEXIT                                                          29150000
.*       IHB001 TYPE OPERAND REQUIRED NOT SPECIFIED                     29200000
.ERTTYP IHBERMAC 1006,TYPE                                              29250000
         MEXIT                                                          29300000
.TNAMSYS ANOP                                                           29350000
         AIF   (T'&ADDR NE 'O').TADINVL                                 29400000
.TNAMC   ANOP                                                           29450000
         AIF   ('&TYPE' EQ 'CML').TNAMCA                                29500000
         AIF   ('&TYPE' EQ 'ALOCAL').TALOCAL                            29550000
         AIF   (T'&ASCB NE 'O').TLOCASI                                 29600000
         AIF   (T'&LOCKHLD EQ 'O').TNAMCA                               29650000
.*       IHB280 LOCKHLD INVALID WITH TYPE=XXX                           29700000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          29750000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                                 29800000
         MEXIT                                                          29850000
.TLOCASI ANOP                                                           29900000
.*       IHB280 ASCB INVALID WITH TYPE=XXX                              29950000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          30000000
         IHBERMAC 1020,ASCB,&MESSAGE                                    30050000
         MEXIT                                                          30100000
.TNAMCA  AIF   (T'&REGS EQ 'O').TNAMC1                                  30150000
.*       IHB280 REGS INVALID WITH TYPE=NAME                             30200000
&MESSAGE SETC 'TYPE='.'&TYPE'                                           30250000
         IHBERMAC 1020,REGS,&MESSAGE                                    30300000
         MEXIT                                                          30350000
.TNAMC1  ANOP                                                           30400000
         AIF   ('&NAME' EQ '').TNAMNN                                   30450000
&NAME    DC    0H'0'                                                    30500000
.TNAMNN  AIF   ('&TYPE' EQ 'CML').TCMLCK                                30550000
         AIF   (T'&BRANCH NE 'O').TNAMCB                                30600000
         SR    15,15                    PRESET LOCK HELD RETURN CODE    30650000
.TNAMCB  AIF   (T'&ADDR EQ 'O').TNAMTM                                  30700000
         C     &ADDR(1),PSACLHT-PSA+&OFSET.(0,0) CHECK LKWD ADDR        30750000
*                                       IN CLHT                         30800000
         AIF   (T'&BRANCH EQ 'O').TNAMARC                               30850000
         AIF   ('&BRANCH(1)' EQ 'HELD').TNAMABH                         30900000
         BNE   &BRANCH(2)               BRANCH NOT HELD                 30950000
         MEXIT                                                          31000000
.TNAMABH BE    &BRANCH(2)               BRANCH HELD                     31050000
         MEXIT                                                          31100000
.TNAMARC BE    *+8                      BRANCH HELD                     31150000
         LA    15,4(0,0)                SET R. C. LOCK NOT HELD         31200000
         MEXIT                                                          31250000
.TNAMTM  TM    PSAHLHI-PSA+&BYTE.(0),&MASK  TEST BIT IN CPU LK HELD     31300000
*                                       STRING                          31350000
         AIF   ('&TYPE' EQ 'LOCAL').TLOCAL                              31400000
         AIF   (T'&BRANCH EQ 'O').TNAMTRC                               31450000
         AIF   ('&BRANCH(1)' EQ 'HELD').TNAMTBH                         31500000
         BZ    &BRANCH(2)               BRANCH NOT HELD                 31550000
         MEXIT                                                          31600000
.TNAMTBH BO    &BRANCH(2)               BRANCH HELD                     31650000
         MEXIT                                                          31700000
.TNAMTRC BO    *+8                      BRANCH HELD                     31750000
         LA    15,4(0,0)                SET R. C. LOCK NOT HELD         31800000
         MEXIT                                                          31850000
.TLOCAL  ANOP                                                           31900000
&LABEL   SETC  'IHA&SYSNDX'                                             31950000
         AIF   (T'&BRANCH EQ 'O').TLOCRC                                32000000
         AIF   ('&BRANCH(1)' EQ 'HELD').TLOCBH                          32050000
         BZ    &BRANCH(2)               BRANCH NOT HELD                 32100000
         AGO   .TLOCCL                                                  32150000
.TLOCRC  ANOP                                                           32200000
         BZ    &LABEL.A                 BRANCH NOT HELD                 32250000
         AGO   .TLOCCL                                                  32300000
.TLOCBH  BZ    &LABEL.B                 BRANCH NOT HELD                 32350000
.TLOCCL  ANOP                                                           32400000
         CLC   PSALOCAL-FLC(4,0),PSAFZERO-FLC(0) LOCAL HELD?            32450000
         AIF   (T'&BRANCH EQ 'O').TLOCRC1                               32500000
         AIF   ('&BRANCH(1)' EQ 'HELD').TLOCBH1                         32550000
         BNE   &BRANCH(2)               BRANCH LOCK NOT HELD            32600000
         MEXIT                                                          32650000
.TLOCRC1 ANOP                                                           32700000
         BE    *+8                      BRANCH LOCK HELD                32750000
&LABEL.A LA    15,4(0,0)                SET R.C.=4 NOT HELD             32800000
         MEXIT                                                          32850000
.TLOCBH1 ANOP                                                           32900000
         BE    &BRANCH(2)               BRANCH LOCK HELD                32950000
&LABEL.B DC    0H'0'                    BRANCH LABEL                    33000000
         MEXIT                                                          33050000
.TALLC   ANOP                                                           33100000
         AIF   (T'&REGS NE 'O').TALLCR                                  33150000
.*       IHB001 WITH TYPE=ALL, REGS OPERAND REQUIRED NOT SPECIFIED      33200000
&MESSAGE SETC  'WITH TYPE='.'&TYPE'.', REGS'                            33250000
         IHBERMAC 1006,&MESSAGE                                         33300000
         MEXIT                                                          33350000
.TALLCR  ANOP                                                           33400000
         AIF   ('&NAME' EQ '').TALLCNA                                  33450000
&NAME    DC    0H'0'                                                    33500000
.TALLCNA ANOP                                                           33550000
         AIF   (T'&ASCB NE 'O').TALLCA                                  33600000
         AIF   (T'&LOCKHLD NE 'O').TALLCAR                              33650000
         AIF   (T'&BRANCH NE 'O').TALLCNS                               33700000
         SR    15,15               PRESET R. C. AT LEAST ONE LOCK HELD  33750000
.TALLCNS AIF   ('&TYPE' EQ 'SPIN').TSPINC                               33800000
         L     &REGS(1),PSAHLHI-PSA(0,0)  GET CPU LOCKS HELD            33850000
*                                  STRING                               33900000
         AGO   .TALLCOM                                                 33950000
.TSPINC  LA    &REGS(1),4(0,0)     GET VALUE TO GENERATE MASK           34000000
         LCR   &REGS(1),&REGS(1)   GENERATE MASK TO CHECK ONLY SPIN LKS 34050000
         N     &REGS(1),PSAHLHI-PSA(0,0) KEEP ONLY HELD SPIN LOCKS,     34100000
*                                  IF ANY                               34150000
.TALLCOM ANOP                                                           34200000
         LTR   &REGS(1),&REGS(1)   CHECK FOR ZERO                       34250000
         AIF   (T'&BRANCH EQ 'O').TALLRC                                34300000
         AIF   ('&BRANCH(1)' EQ 'HELD').TALLBH                          34350000
         BZ    &BRANCH(2)          BRANCH NO LOCK HELD                  34400000
         MEXIT                                                          34450000
.TALLBH  BNZ   &BRANCH(2)          BRANCH AT LEAST ONE LOCK HELD        34500000
         MEXIT                                                          34550000
.TALLRC  BNZ   *+8                 BRANCH AT LEAST ONE LOCK HELD        34600000
         LA    15,4(0,0)           SET R. C. NO LOCK HELD               34650000
         MEXIT                                                          34700000
.TALLCA  ANOP                                                           34750000
.*       IHB280 ASCB INVALID WITH TYPE=ALL                              34800000
&MESSAGE SETC 'TYPE='.'&TYPE'                                           34850000
         IHBERMAC 1020,ASCB,&MESSAGE                                    34900000
         MEXIT                                                          34950000
.TALLCAR ANOP                                                           35000000
.*       IHB280 LOCKHLD INVALID WITH TYPE=ALL                           35050000
&MESSAGE SETC 'TYPE='.'&TYPE'                                           35100000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                                 35150000
         MEXIT                                                          35200000
.TREGC   ANOP                                                           35250000
         AIF (T'&ASCB NE 'O').TREGCA                                    35300000
         AIF (T'&LOCKHLD NE 'O').TREGCR                                 35350000
         AIF (T'&BRANCH EQ 'O').TREGCNB                                 35400000
         AIF (T'&REGS NE 'O').TREGCBR                                   35450000
.*       IHB001 WITH BRANCH OPTION OF TYPE=REG,REGS REQUIRED NOT SPECI- 35500000
.*       FIED                                                           35550000
&MESSAGE SETC  'WITH BRANCH OPTION OF TYPE='.'&TYPE'.', REGS'           35600000
         IHBERMAC 1006,&MESSAGE                                         35650000
         MEXIT                                                          35700000
.TREGCBR ANOP                                                           35750000
         AIF   ('&NAME' EQ '').TREGCNN                                  35800000
&NAME    DC    0H'0'                                                    35850000
.TREGCNN LR    &REGS(1),&TYPE(1)        SAVE INPUT STRING               35900000
         N     &REGS(1),PSAHLHI-PSA(0,0) COMPARE TO LOCKS HELD          35950000
*                                       STRING                          36000000
         CR    &REGS(1),&TYPE(1)        ARE ALL SPECIFIED LOCKS HELD    36050000
         AIF   ('&BRANCH(1)' EQ 'HELD').TREGCBH                         36100000
         BNE   &BRANCH(2)               BRANCH NOT ALL HELD             36150000
         MEXIT                                                          36200000
.TREGCBH BE    &BRANCH(2)               BRANCH ALL HELD                 36250000
         MEXIT                                                          36300000
.TREGCNB ANOP                                                           36350000
         AIF   ('&NAME' EQ '').TREGRNN                                  36400000
&NAME    DC    0H'0'                                                    36450000
.TREGRNN LR    15,&TYPE(1)              SAVE INPUT STRING               36500000
&REG1    SETC  '&TYPE(1)'                                               36550000
         AIF   (T'&REGS EQ 'O').TREGCNR                                 36600000
&REG1    SETC  '&REGS(1)'                                               36650000
         LR    &REG1,&TYPE(1)           MOVE STRING IN WORK REG         36700000
.TREGCNR N     &REG1,PSAHLHI-PSA(0,0)   COMPARE TO LOCKS HELD           36750000
*                                       STRING                          36800000
         XR    15,&REG1                 SET RC=0 IF ALL HELD            36850000
         BZ    *+8                      EXIT ALL HELD                   36900000
         LA    15,4(0,0)                SET RC NOT ALL HELD             36950000
         MEXIT                                                          37000000
.TREGCA  ANOP                                                           37050000
.*       IHB280 ASCB INVALID WITH TYPE=REG                              37100000
&MESSAGE SETC   'TYPE='.'&TYPE'                                         37150000
         IHBERMAC 1020,ASCB,&MESSAGE                                    37200000
         MEXIT                                                          37250000
.TREGCR  ANOP                                                           37300000
.*       IHB280 LOCKHLD INVALID WITH TYPE=REG                           37350000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          37400000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                                 37450000
         MEXIT                                                          37500000
.TCMLCK  ANOP                                                           37550000
         AIF   (T'&ASCB NE 'O').TCMLAS                                  37600000
         AIF   (T'&LOCKHLD NE 'O').TCMLREG                              37650000
.*       IHB001 LOCKHLD/ASCB OPERAND REQUIRED NOT SPECIFIED             37700000
         IHBERMAC 1006,LOCKHLD/ASCB                                     37750000
         MEXIT                                                          37800000
.TCMLAS  ANOP                                                           37850000
         AIF   (T'&LOCKHLD EQ 'O').TCMLASC                              37900000
.*       IHB280 LOCKHLD INVALID WITH ASCB                               37950000
         IHBERMAC 1020,LOCKHLD,ASCB                                     38000000
         MEXIT                                                          38050000
.TCMLREG ANOP                                                           38100000
         AIF   ('&LOCKHLD'(1,1) NE '(').TCMLRNV                         38150000
         AIF   ('&LOCKHLD'(K'&LOCKHLD,1) EQ ')').TCMLROK                38200000
.*       IHB002 INVALID LOCKHLD OPERAND SPECIFIED - XXX                 38250000
.TCMLRNV IHBERMAC 1001,LOCKHLD,&LOCKHLD                                 38300000
         MEXIT                                                          38350000
.TCMLROK AIF   (T'&BRANCH NE 'O').TCMLR                                 38400000
         SR    15,15                    .PRESET LOCK HELD R.C.          38450000
.TCMLR   AIF   (T'&ADDR EQ 'O').TCMLRTM                                 38500000
         IHB280 ADDR INVALID WITH CML                                   38550000
         IHBERMAC 1020,ADDR,CML                                         38600000
         MEXIT                                                          38650000
.TCMLRTM ANOP                                                           38700000
&LABEL   SETC  'IHA&SYSNDX'                                             38750000
&REG2    SETC  '&LOCKHLD(1)'                                            38800000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD             38850000
         AIF   (T'&BRANCH EQ 'O').TCMLRC                                38900000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLBH                          38950000
         BZ    &BRANCH(2)               .BRANCH CML NOT HELD            39000000
         AGO   .TCMLRCL                                                 39050000
.TCMLRC  BZ    &LABEL.A                 .BRANCH CML NOT HELD            39100000
         AGO   .TCMLRCL                                                 39150000
.TCMLBH  BZ    &LABEL.B                 .BRANCH CML NOT HELD            39200000
.TCMLRCL ANOP                                                           39250000
         L     &REG2,PSALOCAL-FLC(0,0)  .LOAD CLHT CML VALUE            39300000
         LTR   &REG2,&REG2              .CML LOCK HELD?                 39350000
         AIF   (T'&BRANCH EQ 'O').TCMLRC1                               39400000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLRBH                         39450000
         BZ    &BRANCH(2)               .BRANCH CML NOT HELD            39500000
         MEXIT                                                          39550000
.TCMLRC1 ANOP                                                           39600000
         BNZ   *+8                      .BRANCH - CML HELD              39650000
&LABEL.A LA    15,4(0,0)                .SET R.C.=4 NOT HELD            39700000
         MEXIT                                                          39750000
.TCMLRBH BNZ   &BRANCH(2)               .BRANCH - LOCK HELD             39800000
&LABEL.B DC    0H'0'                                                    39850000
         MEXIT                                                          39900000
.TCMLASC ANOP                                                           39950000
         AIF   ('&ASCB'(1,1) NE '(').TCMLANV                            40000000
         AIF   ('&ASCB'(K'&ASCB,1) EQ ')').TCMLAOK                      40050000
.*       IHB002  INVALID ASCB OPERAND SPECIFIED - XXX                   40100000
.TCMLANV IHBERMAC 1001,ASCB,&ASCB                                       40150000
         MEXIT                                                          40200000
.TCMLAOK AIF   (T'&BRANCH NE 'O').TCMLASA                               40250000
         SR    15,15                    .PRESET LOCK HELD R.C.          40300000
.TCMLASA AIF   (T'&ADDR EQ 'O').TCMLATM                                 40350000
.*       IHB280 ADDR INVALID WITH CML                                   40400000
         IHBERMAC 1020,ADDR,CML                                         40450000
         MEXIT                                                          40500000
.TCMLATM ANOP                                                           40550000
&LABEL   SETC  'IHA&SYSNDX'                                             40600000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD             40650000
         AIF   (T'&BRANCH EQ 'O').TCMLARC                               40700000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLABH                         40750000
         BZ    &BRANCH(2)               .BRANCH - LOCK NOT HELD         40800000
         AGO   .TCMLACL                                                 40850000
.TCMLARC BZ    &LABEL.B                 .BRANCH - LOCK NOT HELD         40900000
         AGO   .TCMLACL                                                 40950000
.TCMLABH BZ    &LABEL.C                 .BRANCH - LOCK NOT HELD         41000000
.TCMLACL ANOP                                                           41050000
         CLC   PSAFZERO-FLC(4,0),PSALOCAL-FLC(0)  .CML HELD?            41100000
         BNE   &LABEL.D                 .YES CONTINUE CHECKS            41150000
         CL    &ASCB(1),PSAAOLD-FLC(0,0) .ASCB SPECIFIED=HOME?          41200000
         AIF   (T'&BRANCH EQ 'O').TCMLAR1                               41250000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLAH1                         41300000
         BNE   &BRANCH(2)               .BRANCH LOCK NOT HELD           41350000
         B     &LABEL.C                 .BRANCH LOCK HELD               41400000
         AGO   .TCMLAC1                 .CONTINUE CHECKS                41450000
.TCMLAR1 ANOP                                                           41500000
         BE    &LABEL.C                 .BRANCH LOCK HELD               41550000
         B     &LABEL.B                 .BRANCH - SET R.C.              41600000
         AGO   .TCMLAC1                                                 41650000
.TCMLAH1 ANOP                                                           41700000
         BE    &BRANCH(2)               .BRANCH  LOCK HELD              41750000
         B     &LABEL.C                 .BRANCH  LOCK NOT HELD          41800000
.TCMLAC1 ANOP                                                           41850000
&LABEL.D CL    &ASCB(1),PSALOCAL-FLC(0,0) .CML LOCK HELD?               41900000
         AIF   (T'&BRANCH EQ 'O').TCMLAR2                               41950000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLAH2                         42000000
         BNE   &BRANCH(2)               .BRANCH NOT HELD                42050000
         AGO   .TCMLEND                 .END OF CML CHECKS              42100000
.TCMLAR2 ANOP                                                           42150000
         BE    &LABEL.C                 .BRANCH LOCK HELD               42200000
         AGO   .TCMLAR3                                                 42250000
.TCMLAH2 ANOP                                                           42300000
         BE    &BRANCH(2)               .BRANCH LOCK HELD               42350000
         AGO   .TCMLEND                                                 42400000
.TCMLAR3 ANOP                                                           42450000
&LABEL.B LA    15,4(0,0)                .LOCK NOT HELD R.C.             42500000
.TCMLEND ANOP                                                           42550000
&LABEL.C DC    0H'0'                    .BRANCH LABEL                   42600000
         MEXIT                                                          42650000
.* THIS SECTION OF CODE IS FOR THE TYPE=ALOCAL TEST                     42700000
.TALOCAL ANOP                                                           42750000
&LABEL   SETC  'IHA&SYSNDX'                                             42800000
&REG2    SETC  '&LOCKHLD(1)'                                            42850000
         AIF   ('&NAME' EQ '').TALOCNN                                  42900000
&NAME    DC    0H'0'                                                    42950000
.TALOCNN AIF   (T'&ASCB EQ 'O').TALOCRG                                 43000000
.*       IHB280 ASCB INVALID WITH ALOCAL                                43050000
         IHBERMAC  1020,ASCB,ALOCAL                                     43100000
         MEXIT                                                          43150000
.TALOCRG ANOP                                                           43200000
         AIF   (T'&LOCKHLD EQ 'O').TALOCBR                              43250000
         AIF   ('&LOCKHLD'(1,1) NE '(').TALOCRI                         43300000
         AIF   ('&LOCKHLD'(K'&LOCKHLD,1) EQ ')').TALOCOK                43350000
.*       IHB002 INVALID LOCKHLD OPERAND SPECIFIED - XXX                 43400000
.TALOCRI IHBERMAC 1001,LOCKHLD,&LOCKHLD                                 43450000
         MEXIT                                                          43500000
.TALOCOK ANOP                                                           43550000
         AIF   (T'&BRANCH NE 'O').TALOC1                                43600000
         LA    15,4(0,0)               .PRESET NOT HELD R.C.            43650000
.TALOC1  ANOP                                                           43700000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD             43750000
         AIF   (T'&BRANCH EQ 'O').TALOCRC                               43800000
         AIF   ('&BRANCH(1)' EQ 'HELD').TALOCHD                         43850000
         BZ    &BRANCH(2)              .BRANCH NOT HELD                 43900000
         L     &REG2,PSALOCAL-FLC(0,0)     .LOAD ASCB ADDR OF           43950000
*                                      .LOCKED ADDR. SPACE              44000000
         MEXIT                                                          44050000
.TALOCHD ANOP                                                           44100000
         BZ    &LABEL.A                .BRANCH NOT HELD                 44150000
         L     &REG2,PSALOCAL-FLC(0,0)     .LOAD ASCB ADDR              44200000
*                                      .OF LOCKED ADDR. SPACE           44250000
         B     &BRANCH(2)              .BRANCH HELD                     44300000
&LABEL.A DC    0H'0'                   .BRANCH LABEL                    44350000
         MEXIT                                                          44400000
.TALOCRC ANOP                                                           44450000
         BZ    &LABEL.B                .BRANCH NOT HELD                 44500000
         L     &REG2,PSALOCAL-FLC(0,0)     .LOAD ASCB ADDR              44550000
*                                      .OF LOCKED ADDR. SPACE           44600000
         SLR   15,15                   .SET LOCK HELD R.C.              44650000
&LABEL.B DC    0H'0'                   .BRANCH LABEL                    44700000
         MEXIT                                                          44750000
.TALOCBR ANOP                                                           44800000
.* NOTE - TEST IS FOR ALOCAL WITH NO LOCKHLD PARM SPECIFIED             44850000
         AIF   (T'&BRANCH NE 'O').TALOC2                                44900000
         SLR   15,15                   .PRESET LOCK HELD R.C.           44950000
.TALOC2  ANOP                                                           45000000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD             45050000
         AIF   (T'&BRANCH EQ 'O').TALOCR1                               45100000
         AIF   ('&BRANCH(1)' EQ 'HELD').TALOCH1                         45150000
         BZ    &BRANCH(2)              .BRANCH NOT HELD                 45200000
         MEXIT                                                          45250000
.TALOCH1 ANOP                                                           45300000
         BNZ   &BRANCH(2)              .BRANCH HELD                     45350000
         MEXIT                                                          45400000
.TALOCR1 ANOP                                                           45450000
         BNZ   &LABEL.C                .BRANCH NOT HELD                 45500000
         LA    15,4(0,0)               .SET LOCK NOT HELD R.C.          45550000
&LABEL.C DC    0H'0'                   .BRANCH LABEL                    45600000
         MEXIT                                                          45650000
.ENDIT   ANOP                                                           45700000
         MEND                                                           45750000
