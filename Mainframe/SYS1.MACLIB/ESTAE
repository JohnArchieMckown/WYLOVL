*/*                                                            @G860P38 00021300
*********************************************************************** 00042700
*                                                                       00051100
*01* MACRO NAME: ESTAE                                                  00059500
*                                                                       00067900
*01* DESCRIPTIVE NAME: EXTENDED SPECIFY TASK ABNORMAL EXIT              00076300
*                                                                       00084700
*01* PROPRIETARY STATEMENT:                                             00093100
*                                                                       00101500
*    LICENSED MATERIALS - PROPERTY OF IBM                               00110600
*    THIS MACRO IS "RESTRICTED MATERIALS OF IBM"                        00111200
*    5647-A01 (C) COPYRIGHT IBM CORP. 1980, 2000                        00112100
*                                                                       00113000
*    STATUS = HBB7703                                                   00113600
*                                                                       00114200
*01* FUNCTION:  Provides the interface between the caller and RTM to    00114800
*               manage ESTAE recovery routines.                         00115400
*                                                                       00116000
*01* EXTERNAL CLASSIFICATION:                                           00116600
*                                                                       00117200
*02* PI: BASE                                                           00117800
*                                                                       00118400
*02* NONE: FIELDS                                                       00119000
*          TCB                                                          00119600
*          ESTAR                                                        00120200
*          TKNPASS                                                      00120800
*                                                                       00121400
*01* END OF EXTERNAL CLASSIFICATION:                                    00122000
*                                                                       00122600
*01* MODULE TYPE:  ASSEM MACRO                                          00123200
*                                                                       00123800
*02*   PROCESSOR:  ASSEM                                                00124400
*                                                                       00125000
*01* COMPONENT:  SCRTM                                                  00125600
*                                                                       00126200
*01* DISTRIBUTION LIBRARY: AMACLIB                                      00126800
*                                                                       00127400
*                                                                       00129700
*    COMMENT   WHEN RESERVED BITS / BYTES ARE ASSIGNED, THE    @ZMD0006 00136200
*              IMPLEMENTATION MUST TAKE INTO ACCOUNT           @ZMD0006 00139800
*              DOWNWARD COMPATIBILITY. THAT IS, THE CODE       @ZMD0006 00143400
*              MUST ENSURE THAT PREVIOUS FAILURES TO CLEAN     @ZMD0006 00147000
*              THE RESERVED BITS / BYTES DO NOT RESULT IN      @ZMD0006 00150600
*              USAGE OF UNINTENDED (NEW) FUNCTIONS. THE        @ZMD0006 00154200
*              ABILITY TO SET A BIT FUNCTION ON ONE            @ZMD0006 00157800
*              INVOCATION AND CONTINUE TO APPLY ON SUBSEQUENT  @ZMD0006 00161400
*              INVOCATIONS MUST ALSO BE CONSIDERED, ACCORDING  @ZMD0006 00165000
*              TO THE REQUIREMENTS OF THE NEW FUNCTION.        @ZMD0006 00168600
*                                                                       00168900
*                                                                       00170100
*01* CHANGE ACTIVITY:                                                   00170400
*               G860P38 - MVS/SYSTEM PRODUCT HBB2102           @G860P38 00170800
*    $L1=AR     ,HBB3310,850917,PDA8: SUPPORT FOR ARS              @L1A 00171000
*    $D1=DCR0059,HBB3310,861029,PDU8: CANCEL KEYWORD SUPPORT       @D1A 00171100
*    $P1=PC40724,HBB3310,870209,PDU8: SET ESTAENCL ON EXECUTE FORM @P1A 00171200
*    $01=OW06372 HBB3310 940629 PDKD: Fix continuation for FLGS    @01A 00171500
*    $P2=PN71728 HBB5520 941007 PDKD: Fix up prolog                @P2A 00171600
*    $P3=PR20011 HBB6601 950908 PDKD: SC1CM compid split           @P3A 00171700
*   $L2=64BITRTM HBB7703 980223 PDKD: SDWALOC31                         00171800
*   $P4=PXD0184  HBB7703 990630 PDXB: "128+" -> "128*"                  00171900
*********************************************************************** 00172000
         MACRO                                                          00172200
&NAME    ESTAE &EXIT,&TYPE,&PARAM=I,&XCTL=NO,&MF=I,&PURGE=,&ASYNCH=,   J00175800
               &TCB=,&ESTAR=,&TERM=,&RECORD=,&BRANCH=,&SVEAREA=,       J00179400
               &SDWALOC31=,                                        @L2AJ00181200
               &CANCEL=,&RELATED=,&KEY=,&TOKEN=,&TKNPASS=NO        @D1C 00183000
         GBLC  &SYSSPLV                                        @G860P1C 00186400
         SPLEVEL TEST    INVOKE SPLEVEL MACRO                  @G860P1C 00189800
         AIF   ('&SYSSPLV' EQ '1').S370 S/370 LEVEL REQUESTED  @G860P1C 00193200
*    MACDATE   10/01/94                                        @G860P1C 00195000
         GBLC  &SYSASCE                 DEFINE GLOBAL VARIABLE     @L1A 00196900
         GBLC  &SYSAM64                 DEFINE GLOBAL VARIABLE     @L2A 00197000
         SYSSTATE TEST                  TEST ASC ENVIRONMENT       @L1A 00197200
         AIF ('&SYSASCE' EQ 'P').OKPRIM ONLY SYSASCE = 'P' IS ALLOWED  X00197500
                                        FOR SVC ENTERED ESTAE      @L1A 00197800
         MNOTE 12,'*** ESTAE IS INVALID BECAUSE ASCENV=AR/ANY SPECIFIEDX00198100
                ON PREVIOUSLY ISSUED SYSSTATE MACRO. ***'          @L1A 00198400
         MEXIT                          TERMINATE MACRO PROCESSING @L1A 00198700
.OKPRIM  ANOP  OK TO CONTINUE SINCE SYSASCE INDICATES PRIMARY MODE @L1A 00199000
         LCLA  &LENGTH                                                  00200000
         LCLA  &FLAGS                                                   00250002
         LCLA  &FLGS                                                    00260002
         LCLA  &ANDOFF                                                  00300002
         LCLA  &TESTF                                                   00305004
         LCLA  &FLAGS2                                                  00310002
         LCLA  &FLAGS3                                                  00310402
         LCLA  &TURNOFF                                                 00312002
         LCLA  &EXITL                                                   00316002
         LCLA  &KEYVAL                                                  00318004
         LCLA  &FLAGS4                                       @G81CP2F   00318900
         LCLA  &FLAGS8                                       @G860P1C   00319400
         LCLB  &TERMON                                                  00320002
         LCLB  &SDWALOC31ON                                        @L2A 00325000
         LCLB  &RECON                                                   00330002
         LCLB  &BRNCHON                                                 00340002
         LCLB  &NCNL           CANCEL=NO BIT                       @D1A 00345000
         LCLB  &ASY                                                     00350002
         LCLB  &ASY1                                                    00360002
         LCLB  &HALT                                                    00400002
         LCLB  &NONE                                                    00450002
         LCLB  &PNONE                                                   00460002
         LCLB  &TCBON                                                   00500002
         LCLB  &NCNLOFF        CANCEL=NO NOT SPECIFIED             @D1A 00525000
         LCLB  &ASYOFF                                                  00550002
         LCLB  &PRGOFF                                                  00600002
         LCLB  &TERMOFF                                                 00610002
         LCLB  &SDWALOC31OFF                                       @L2A 00615000
         LCLB  &RECOFF                                                  00620002
         LCLB  &BRANOFF                                                 00630002
         LCLB  &ESTA                                                    00644002
         LCLB  &TOK                                          @G81CP2F   00646900
         LCLB  &EXIT31B                                      @G860P1C   00648400
         LCLC  &GNAME                                                   00650000
         LCLC  &LNAME                                                   00700002
         LCLC  &EXITR                                                   00705002
&EXIT31B SETB  1                                             @G860P1C   00707500
&NCNL    SETB  ('&CANCEL' EQ 'NO')                                 @D1A 00708700
&ASY1    SETB  ('&ASYNCH' EQ 'YES')                                     00710002
&ASY     SETB  ('&ASYNCH' EQ 'YES' OR '&ASYNCH' EQ '')                  00750002
&HALT    SETB  ('&PURGE' EQ 'HALT')                                     00800002
&NONE    SETB  ('&PURGE' EQ 'NONE' OR '&PURGE' EQ '')                   00850002
&PNONE   SETB  ('&PURGE' EQ 'NONE')                                     00860002
&TOK     SETB  ('&TOKEN' NE '')                              @G81CP2F   00900000
&TCBON   SETB  ('&TCB' NE '')                                           00906000
&ESTA    SETB  1               ESTAE INDICATOR                          00918000
&FLAGS   SETA  128*&TCBON+32*&NCNL+16*&ESTA+8*&TOK+4*&ASY+2*&NONE+&HALTX00925000
                                                                   @D1C 00932000
&FLGS    SETA  128*&TCBON+32*&NCNL+16*&ESTA+8*&TOK+4*&ASY1+2*&PNONE+&HAX00939000
               LT                                                  @01C 00946000
&FLAGS4  SETA  128*&TCBON+32*&NCNL+16*&ESTA+4*&ASY+2*&NONE+&HALT   @D1C 00953000
&TERMON  SETB  ('&TERM' EQ 'YES')                                       00960002
&SDWALOC31ON SETB ('&SDWALOC31' EQ 'YES')                          @L2A 00965000
&RECON   SETB  ('&RECORD' EQ 'YES')                                     00970002
&BRNCHON SETB  ('&BRANCH' EQ 'YES')                                     00980002
&FLAGS2  SETA  (128*&SDWALOC31ON+64*&TERMON+32*&RECON)             @L2A 00986000
&FLAGS8  SETA  &EXIT31B                                      @G860P38   00992000
&LENGTH  SETA  28                                            @G860P1C   00994000
         AIF   ('&KEY' NE '' AND '&BRANCH' EQ '').NOKEY                 00996004
         AIF   ('&KEY' NE '' AND '&BRANCH' EQ 'NO').NOKEY               00997004
         AIF   ('&TCB' EQ '').NOSTAI                                    01000002
         AIF   ('&XCTL' EQ 'NO').NIXXCTL                                01100000
         IHBERMAC 1020,XCTL,TCB                                         01150000
         MEXIT                                                          01200000
.NOKEY  MNOTE    8,'**** KEY OPERAND ONLY ALLOWED WITH BRANCH'          01220004
        MEXIT                                                           01230004
.NIXXCTL ANOP                                                           01250000
         AIF   ('&EXIT' EQ '0').ER1                                     01300000
         AIF   ('&TYPE' EQ 'OV').ER2                                    01350000
         AIF   ('&BRANCH' EQ 'YES').ER4                                 01410002
         AGO   .NOSTAI                                                  01450002
.ER1     ANOP                                                           01500000
         IHBERMAC 1020,EXIT/0,TCB                                       01550000
         MEXIT                                                          01600000
.ER2     ANOP                                                           01650000
         IHBERMAC 1020,TYPE/OV,TCB                                      01700000
         MEXIT                                                          01750000
.ER4     ANOP                                                           01910002
         IHBERMAC 1020,BRANCH,TCB                                       01920002
         MEXIT                                                          01930002
.NOSTAI  ANOP                                                           01950002
         AIF   ('&TCB' EQ '' AND '&TYPE' EQ 'PROP').ER10                02000002
         AIF   ('&ESTAR' NE '' AND '&ESTAR' NE 'NO').ESTARER   @G860P38 02048000
         AIF   (('&EXIT' EQ '0') AND ('&TYPE' NE '' OR '&PARAM' NE 'I' J02096002
               OR '&XCTL' NE 'NO' OR '&PURGE' NE '' OR '&ASYNCH' NE '' J02096700
               OR '&SDWALOC31' NE ''                                   J02097400
               OR '&TERM' NE '' OR '&RECORD' NE '')).CANERR        @L2C 02098100
         AIF   (('&EXIT' EQ '0') AND ('&TKNPASS' NE 'NO'               J02098800
               OR '&CANCEL' NE '')).CANERR                         @D1C 02099200
.RESUME  ANOP                                                           02099802
         AIF   ('&CANCEL' NE '' AND '&CANCEL' NE 'NO' AND '&CANCEL'    C02112300
               NE 'YES').NCNLERR                                   @D1C 02124800
         AIF   ('&ASYNCH' NE '' AND '&ASYNCH' NE 'NO' AND '&ASYNCH' NE C02137300
               'YES').ERRASY                                            02150002
         AIF   ('&PURGE' NE '' AND '&PURGE' NE 'HALT' AND '&PURGE' NE  C02200000
               'NONE' AND '&PURGE' NE 'QUIESCE').PURERR                 02250002
         AIF   ('&TERM' NE '' AND '&TERM' NE 'YES' AND '&TERM' NE      J02260002
               'NO').TERMERR                                            02270002
         AIF   ('&SDWALOC31' NE '' AND '&SDWALOC31' NE 'YES'           J02273300
               AND '&SDWALOC31' NE 'NO').SDWALOC31ERR                   02276600
         AIF   ('&RECORD' NE '' AND '&RECORD' NE 'YES' AND '&RECORD'   J02280002
               NE 'NO').RECERR                                          02290002
         AIF   ('&BRANCH' NE '' AND '&BRANCH' NE 'YES' AND '&BRANCH'   J02292002
               NE 'NO').BRNERR                                          02294002
         AIF   ('&TYPE' NE 'PROP' AND '&TYPE' NE 'CT' AND '&TYPE'      J02296002
               NE 'OV' AND '&TYPE' NE '').BADOPT                        02298002
         AIF   ('&MF(1)' EQ 'L').LROUT                                  02350000
         AIF   ('&BRANCH' EQ 'YES' AND '&SVEAREA' EQ '').SAVERR         02352002
         AIF   ('&KEY' EQ 'SAVE' OR '&KEY' EQ '').OK1                   02354004
         AIF  ('&KEY' GT '15' OR '&KEY' LT '0').BADKEY                  02356004
.OK1     AIF   ('&MF(1)' EQ 'I').IROUT                                  02366004
         AIF   ('&MF(1)' EQ 'E').EROUTA                                 02400000
         IHBERMAC 35,,&MF(1)            INVALID MF= OPERAND             02450000
         MEXIT                                                          02500000
.ER10    ANOP                                                           02516900
         MNOTE 12,'***     TCB MUST BE SPECIFIED WITH TYPE/PROP'        02533800
         MEXIT                                                          02550700
.CANERR  ANOP                                                           02567602
         MNOTE 0,'***   EXCESS PARAMETERS W/ CANCEL IGNORED' @G38NP38   02573100
         AGO   .RESUME                                                  02578602
.SAVERR  ANOP                                                           02580602
         MNOTE 12,'***   SVEAREA MUST BE SPECIFIED WITH BRANCH/YES'     02582602
         MEXIT                                                          02583002
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        02583302
.*                                                                      02600002
.*       EXECUTE ROUTE       MF=E                                       02650002
.*                                                                      02700002
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        02750002
.EROUTA  AIF   (N'&MF GT 2).EXCESSA                                     02800000
.EROUT   AIF   ('&MF(2)' NE '').EXEC                                    02850000
.NOPARM  IHBERMAC 24                    REQ'D. PARMS. MISSING           02900000
         MEXIT                                                          02950000
.EXEC    ANOP                                                           03000000
&NCNLOFF SETB  ('&CANCEL' EQ 'NO')                                 @D1A 03025000
&ASYOFF  SETB  ('&ASYNCH' EQ 'NO')                                      03050002
&PRGOFF  SETB  ('&PURGE' NE '')                                         03100002
&ANDOFF  SETA  255-(64+32*&NCNLOFF+4*&ASYOFF+3*&PRGOFF)            @D1C 03130000
&TERMOFF SETB  ('&TERM' EQ 'NO')                                        03160002
&SDWALOC31OFF SETB ('&SDWALOC31' EQ 'NO')                          @L2A 03165000
&RECOFF  SETB  ('&RECORD' EQ 'NO')                                      03170002
&BRANOFF SETB  ('&BRANCH' EQ 'NO')                                      03180002
&TURNOFF SETA  255-(128*&SDWALOC31OFF+64*&TERMOFF+32*&RECOFF)      @L2A 03187500
         AIF   ('&EXIT' EQ '0').CANCEL1                        @ZMB0628 03195000
&NAME    IHBINNRA &MF(2)               LOAD LIST ADDR IN REG 1          03200002
         AIF   ('&EXIT' EQ '').TSTPX                                    03250000
         AIF   ('&EXIT'(1,1) EQ '(').ST1                                03400000
         IHBINNRA ,&EXIT               LOAD NEW EXIT ADDR IN REG 0      03450002
         ST    0,20(1)                 STORE USER EXIT ADDRESS @G860P38 03500000
         AGO   .TSTPX                                                   03600000
.ST1     ANOP                                                           03650002
         ST    &EXIT(1),20(1)          STORE USER EXIT ADDRESS @G860P38 03750000
.TSTPX   ANOP                                                           03850002
         AIF   (&ANDOFF EQ 255).TESTOR                                  03900002
&TESTF   SETA  (&FLGS+64+32*&NCNLOFF+8+4*&ASYOFF+3*&PRGOFF)        @D1C 03910000
         AIF   (&TESTF GE 255).MVI1                                     03920004
         NI    0(1),&ANDOFF            TURN OFF FLAG BITS               03950004
.TESTOR  ANOP                                                           04000002
         OI    0(1),&FLGS              FLAGS FOR TCB,PURGE,ASYNCH,     X04050000
                                       AND CANCEL                  @D1C 04100000
         AGO   .MVISKP1                                                 04170004
.MVI1    MVI   0(1),&FLGS              SET FLAGS FOR TCB,PURGE,        X04196600
                                       ASYNCH, AND CANCEL          @D1C 04223200
.MVISKP1 AIF   ('&PARAM' EQ 'I').ETSTTCB                                04250004
         AIF   ('&PARAM'(1,1) EQ '(').ST2                               04300000
         IHBINNRA ,&PARAM                                               04350000
         ST    0,4(0,1)                MODIFY REMOTE LIST - PARM ADDR   04400004
         AGO   .ETSTTCB                                                 04450002
.ST2     ST    &PARAM(1),4(0,1)        MODIFY LIST - PARAM ADDR         04500004
.ETSTTCB AIF   ('&TCB' EQ '').TSTPX2                                    04550002
         AIF   ('&TCB'(1,1) EQ '(').ST3                                 04600002
         IHBINNRA ,&TCB                                                 04650002
         ST    0,8(0,1)                MODIFY LIST - TCB ADDR.          04700004
         AGO   .TSTPX2                                                  04750002
.ST3     ST    &TCB(1),8(0,1)          MODIFY LIST - TCB ADDR           04800004
.TSTPX2  ANOP                                                           04802002
&TESTF SETA (&FLAGS2+128*&SDWALOC31OFF+64*&TERMOFF+32*&RECOFF+16+4+3)  *04802400
                                                                   @L2A 04802800
         AIF    (&TESTF GE 255).MVI2                                    04803204
         AIF   (&TURNOFF EQ 255).TSTORF                                 04804002
         NI    12(1),&TURNOFF          TURN OFF FLAG BITS               04806004
.TSTORF  ANOP                                                           04816002
         AIF   (&FLAGS2 EQ 0).TSTTOK                         @G81CP2F   04826000
         OI    12(1),&FLAGS2          FLAGS FOR TERM,RECORD,SDWALOC31   04835700
         AGO   .TSTTOK                                       @G81CP2F   04845400
.MVI2    MVI   12(1),&FLAGS2          FLAGS FOR TERM,RECORD,SDWALOC31   04855100
.TSTTOK  ANOP                                                @G81CP2F   04864800
         AIF   ('&TOKEN' EQ '').TSTOPT                       @G81CP2F   04874500
         AIF   ('&TOKEN'(1,1) EQ '(').ST4                    @G81CP2F   04884200
         AIF   (T'&TOKEN EQ 'N').SELFDEF                     @G81CP2F   04893900
         AIF   ('&EXIT' NE '0' AND '&TYPE' NE 'OV').TSTOPT   @G81CP2F   04903600
         L     0,&TOKEN            LOAD TOKEN VALUE          @G81CP2F   04913300
         ST    0,16(0,1)           MODIFY LIST - TOKEN VALUE @G81CP2F   04923000
         AGO   .TSTOPT                                       @G81CP2F   04932700
.ST4     ANOP                                                @G81CP2F   04942400
         AIF   ('&EXIT' NE '0' AND '&TYPE' NE 'OV').TSTOPT   @G81CP2F   04952100
         ST    &TOKEN(1),16(0,1)   MODIFY LIST - TOKEN VALUE @G81CP2F   04961800
.TSTOPT  ANOP                                                           04971500
         AIF   ('&EXIT' EQ '0').CANCEL                                  04981200
         AIF   ('&TOKEN' NE '' OR '&TKNPASS' EQ 'YES').INIT      @P1C   04983600
         NI    0(1),B'11110111'      INIT BIT 5 TO 0             @P1C   04984800
         AGO   .INIT                                         @ZMD0006   04986000
.INIT    NI    12(1),B'11100100'     INIT BIT 4,5,7,8 TO O       @L2C   04987600
         MVI   13(1),&FLAGS8 FLAG FOUR BYTE EXIT ADDR        @G860P1C   04989200
         XC    14(2,1),14(1)         INIT RESERVED FLD TO 0  @G860P1C   04990000
         AGO   .OPTTST                                                  04990900
.EXCESSA MNOTE 0,'***     EXCESS PARAMETERS W/MF=E IGNORED'  @G38NP38   05000600
         AGO   .EROUT                                                   05010300
.SELFDEF MNOTE 12,'***     VALUE SPECIFIED FOR TOKEN IS SELF-DEFINING'  05020000
.*                                                           @G81CP2F   05029700
         MEXIT                                               @G81CP2F   05039400
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        05050002
.*                                                                      05100002
.*       LIST ROUTE          MF=L                                       05150002
.*                                                                      05200002
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        05250002
.LROUT   AIF   (N'&MF GT 1).EXCESS                                      05300002
.LROUT1  ANOP                                                           05350002
         AIF   ('&XCTL' EQ 'YES').XCTLIG                                05352002
.LROUT3  ANOP                                                           05354002
&FLAGS3  SETA  128*&SDWALOC31ON+64*&TERMON+32*&RECON               @P3C 05362000
         AIF   ('&BRANCH' NE '' AND '&SVEAREA' NE '').IGNORE            05370002
.LROUT2  ANOP                                                           05380002
         DS    0F                                                       05400000
         AIF   ('&TOKEN' NE '').IGNORE2                      @G81CP2F   05450000
&NAME    DC    AL1(&FLAGS)             FLAGS FOR TCB,PURGE,ASYNCH,     X05459400
                                       AND CANCEL                  @D1C 05468800
         AGO   .LROUT5                                       @G81CP2F   05478400
.LROUT4  ANOP                                                @G81CP2F   05492600
&NAME    DC    AL1(&FLAGS4)            FLAGS FOR TCB,PURGE,ASYNCH,     X05506800
                                       AND CANCEL                  @D1C 05521000
.LROUT5  ANOP                                                @G81CP2F   05535200
         DC    AL3(0)                  FIELD NO LONGER USED  @G860P1C   05585200
.LREGB   AIF   ('&PARAM' NE 'I').LREGC                                  05800000
         DC    A(0)                    PARM. LIST ADDR. NOT SPECIFIED   05850004
         AGO   .LREGD                                                   05900002
.LREGC   AIF   ('&PARAM'(1,1) EQ '(').LISTERR                           05950000
         DC    A(&PARAM)               STAE EXIT PARM. LIST ADDR.       06000004
.LREGD   AIF   ('&TCB' EQ '').LREGE                                     06050002
         AIF   ('&TCB'(1,1) EQ '(').LISTERR                             06100002
         DC    A(&TCB)                 TCB ADDRESS                      06150004
         AGO   .LREGF                                                   06200002
.LREGE   DC    A(0)                    TCB NOT SPECIFIED                06250004
.LREGF   DC    AL1(&FLAGS3)            FLAGS                            06270004
         DC    AL1(&FLAGS8)            THIRD FLAG BYTE       @G860P1C   06284900
         DC    AL2(0)                  RESERVED              @G860P1C   06299800
         DC    A(0)                    TOKEN VALUE AREA      @G81CP2F   06314900
         AIF   ('&EXIT' NE '').LREGG                         @G860P1C   06315500
         DC    AL4(0)                  EXIT ADDR NOT SPECD   @G860P1C   06316100
         AGO   .LREGH                                        @G860P1C   06316700
.LREGG   ANOP                                                @G860P1C   06317300
         AIF   ('&EXIT'(1,1) EQ '(').LISTERR                 @G860P1C   06317900
         DC    AL4(&EXIT)              FOUR BYTE EXIT ADDR   @G860P1C   06318500
.LREGH   ANOP                                                @G860P1C   06319100
         MEXIT                                                          06320002
.EXCESS  MNOTE 0,'***     EXCESS PARAMETERS W/MF=L IGNORED'  @G38NP38   06350000
         AGO   .LROUT1                                                  06400000
.IGNORE  ANOP                                                           06410002
         MNOTE 0,'***    BRANCH/SVEAREA IGNORED W/MF=L'      @G38NP38   06420000
         AGO   .LROUT2                                                  06430002
.IGNORE2 ANOP                                                @G81CP2F   06432400
         MNOTE 0,'***    TOKEN IGNORED W/MF=L'               @G38NP38   06434800
         AGO   .LROUT4                                       @G81CP2F   06437200
.XCTLIG  ANOP                                                           06440002
         MNOTE 0,'***     XCTL=YES IGNORED W/MF=L'           @G38NP38   06442000
         AGO   .LROUT3                                                  06444002
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        06450002
.*                                                                      06500002
.*       REGULAR ROUTE       MF=I                                       06550002
.*                                                                      06600002
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        06650002
.IROUT   AIF   ('&EXIT' EQ '').NOPARM                                   06700000
         AIF   ('&EXIT' NE '0').STDA                                    06750000
.CANCEL1 ANOP                                                @ZMB0628   06775000
&NAME    DS    0H                                                       06800000
.CANCEL AIF  ('&BRANCH' EQ 'YES').BECAN                                 06810002
         AIF   ('&TOKEN' EQ '').NOTOK2                       @G81CP2F   06850000
         AIF   ('&TOKEN'(1,1) EQ '(').CAN2                   @G81CP2F   06853400
         AIF   (T'&TOKEN EQ 'N').SELFDEF                     @G81CP2F   06856800
         L     1,&TOKEN                LOAD TOKEN VALUE      @G81CP2F   06860200
         LA    0,164(0,0)              CANCEL W/TOKEN CODE   @G81CP2F   06863600
         AGO   .SVC1                                         @G81CP2F   06867000
.CAN2    LR    1,&TOKEN(1)             LOAD TOKEN VALUE      @G81CP2F   06870400
         LA    0,164(0,0)              CANCEL W/TOKEN CODE   @G81CP2F   06873800
         AGO   .SVC1                                         @G81CP2F   06877200
.NOTOK2  LA    0,132(0,0)              INDICATE CANCEL OPTION           06880600
         AGO   .SVC1                                                    06884000
.BECAN   ANOP                                                           06887400
         L     15,FLCCVT-PSA(0,0)      LOAD CVT ADDRESS                 06890800
         AIF   ('&TOKEN' EQ '').NOTOK                        @G81CP2F   06894200
         AIF   ('&TOKEN'(1,1) EQ '(').BEC2                   @G81CP2F   06897600
         AIF   (T'&TOKEN EQ 'N').SELFDEF                     @G81CP2F   06901000
         L     1,&TOKEN             LOAD TOKEN VALUE         @G81CP2F   06904400
         LA    0,180(0,0)       BR ENTRY W/TOKEN CANCEL CODE @G81CP2F   06907800
         AGO   .BRENTRY                                      @G81CP2F   06911200
.BEC2    LR    1,&TOKEN(1)          LOAD TOKEN VALUE         @G81CP2F   06914600
         LA    0,180(0,0)       BR ENTRY W/TOKEN CANCEL CODE @G81CP2F   06918000
         AGO   .BRENTRY                                      @G81CP2F   06921400
.NOTOK   LA    0,148(0,0)           BRANCH ENTRY CANCEL CODE @G81CP2F   06924800
         AGO   .BRENTRY                                                 06930002
.STDA    CNOP  0,4                     ESTAB. FULL WD. BOUND. ALIGN.    06950004
&LNAME   SETC  'IHB'.'&SYSNDX'                                          07000002
&NAME    BAL   1,*+&LENGTH             LIST ADDR IN REG1 SKIP LIST      07050004
&LNAME   EQU   *                                                        07100000
         DC    AL1(&FLAGS)             FLAGS FOR TCB, PURGE,           X07150000
                                       ASYNCH AND CANCEL           @D1C 07200000
         DC    AL3(0)                  FIELD NO LONGER USED  @G860P38   07250000
         AIF   ('&PARAM' EQ 'I' OR '&PARAM'(1,1) EQ '(').STDC1          07500000
         DC    A(&PARAM)               STAE EXIT PARM. LIST ADDR.       07550004
         AGO   .TCBTST                                                  07600002
.STDC1   DC    A(0)                    SPACE FOR PARM LIST ADDR         07650004
.TCBTST  ANOP                                                           07660002
         AIF   ('&TCB' EQ '').TCBREG                                    07710002
         AIF   ('&TCB'(1,1) EQ '(').TCBREG                              07750002
         DC    A(&TCB)                 TCB ADDR                         07800004
         DC    AL1(&FLAGS2)            FLAGS FOR TERM,RECORD,SDWALOC31  07807000
         DC    AL1(&FLAGS8)            THIRD FLAG BYTE       @G860P1C   07814100
         DC    AL2(0)                  RESERVED              @G860P1C   07818200
         DC    A(0)                    SPACE FOR TOKEN       @G81CP2F   07822400
         AIF   ('&EXIT'(1,1) EQ '(').EXREG1                  @G860P38   07822800
         DC    AL4(&EXIT)              FOUR BYTE EXIT ADDR   @G860P1C   07823200
         AGO   .EXEND1                                       @G860P1C   07823600
.EXREG1  DC    AL4(0)                  SPACE FOR EXIT ADDR   @G860P1C   07824000
.EXEND1  ANOP                                                @G860P1C   07824400
         AIF   ('&TOKEN' EQ '').TSTSW                        @G81CP2F   07824800
         AIF   ('&TOKEN'(1,1) EQ '(').TOKREG                 @G81CP2F   07827200
         AIF   (T'&TOKEN EQ 'N').SELFDEF                     @G81CP2F   07829600
         AIF   ('&TYPE' NE 'OV').TSTSW                       @G81CP2F   07832000
         L     0,&TOKEN                LOAD TOKEN VALUE      @G81CP2F   07834400
         ST    0,&LNAME+16             PUT TOKEN IN LIST     @G81CP2F   07836800
         AGO   .TSTSW                                        @G81CP2F   07839200
.TOKREG  ANOP                                                @G81CP2F   07841600
         AIF   ('&TYPE' NE 'OV').TSTSW                       @G81CP2F   07844000
         ST    &TOKEN(1),&LNAME+16     PUT TOKEN IN LIST     @G81CP2F   07846400
         AGO   .TSTSW                                                   07850002
.TCBREG  DC    A(0)                    SPACE FOR TCB ADDR               07900004
         DC    AL1(&FLAGS2)            FLAGS FOR TERM,RECORD,SDWALOC31  07907300
         DC    AL1(&FLAGS8)            THIRD FLAG BYTE       @G860P1C   07914600
         DC    AL2(0)                  RESERVED              @G860P1C   07922200
         DC    A(0)                    SPACE FOR TOKEN       @G81CP2F   07930000
         AIF   ('&EXIT'(1,1) EQ '(').EXREG2                  @G860P1C   07930200
         DC    AL4(&EXIT)              FOUR BYTE EXIT ADDR   @G860P1C   07930400
         AGO   .EXEND2                                       @G860P1C   07930600
.EXREG2  DC    AL4(0)                  SPACE FOR EXIT ADDR   @G860P1C   07930800
.EXEND2  ANOP                                                @G860P1C   07931000
         AIF   ('&TOKEN' EQ '').STTCB                        @G81CP2F   07931600
         AIF   ('&TOKEN'(1,1) EQ '(').TOKREG2                @G81CP2F   07933200
         AIF   (T'&TOKEN EQ 'N').SELFDEF                     @G81CP2F   07934800
         AIF   ('&TYPE' NE 'OV').STTCB                       @G81CP2F   07936400
         L     0,&TOKEN                LOAD TOKEN VALUE      @G81CP2F   07938000
         ST    0,&LNAME+16             PUT TOKEN IN LIST     @G81CP2F   07939600
         AGO   .STTCB                                        @G81CP2F   07941200
.TOKREG2 ANOP                                                @G81CP2F   07942800
         AIF   ('&TYPE' NE 'OV').STTCB                       @G81CP2F   07944400
         ST    &TOKEN(1),&LNAME+16     PUT TOKEN IN LIST     @G81CP2F   07946000
.STTCB   AIF   ('&TCB' EQ '').TSTSW                          @G81CP2F   07947600
         ST    &TCB(1),&LNAME+8        PUT TCB ADDR IN LIST             07950004
.TSTSW   ANOP                                                           08000002
         AIF   ('&EXIT'(1,1) NE '(').CHKPARM                            08050002
         ST    &EXIT(1),&LNAME+20      PUT EXIT ADDR IN LIST @G860P1C   08100000
.CHKPARM ANOP                                                           08250002
         AIF   ('&PARAM'(1,1) NE '(').OPTTST                            08300000
         ST    &PARAM(1),&LNAME+4      PUT PARAM ADDR. IN LIST          08350000
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        08400002
.*                                                                      08450002
.*       COMMON TO E ROUTE AND I ROUTE                                  08500002
.*                                                                      08550002
.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*        08600002
.OPTTST  ANOP                                                           08650002
         AIF    ('&BRANCH' NE 'YES').SKBR                               08660004
         L     15,FLCCVT-PSA(0,0)      ACCESS CVT ADDRESS               08670004
.SKBR    AIF   (('&TYPE' EQ '') OR ('&TYPE' EQ 'CT')).CREATE            08700004
         AIF   ('&TYPE' EQ 'OV').OVRLAY                                 08750000
         AGO   .PROP                                                    08760002
.BADOPT  IHBERMAC  49,,&TYPE           INVALID OPTION-STD. FORM         08800002
         MEXIT                                                          08850000
.CREATE  ANOP                                                           08900002
         LA    0,256(0,0)              CREATE & PARMLST EQ 0   @ZMD0006 08950000
         AGO   .SVC                                                     08975000
.PROP    ANOP                                                           09000000
         LA    0,258(0,0)              PROPAGTE & PARMLST EQ 0 @ZMD0006 09025000
         AGO   .SVC                                                     09050000
.OVRLAY  LA    0,264(0,0)              OVERLAY & PARMLST EQ 0  @ZMD0006 09075000
.SVC     AIF   ('&XCTL' EQ 'NO').NOXCTL                                 09100000
         AIF   ('&XCTL' NE 'YES').BADXCTL                               09150000
         AIF   ('&MF' EQ 'I').SVC1                                      09200000
&GNAME   SETC  'IHB'.'&SYSNDX'                                          09250002
         CNOP  0,4                     FORCE FULL WORD ALIGNMENT        09300004
         O     1,&GNAME                XCTL=YES - MAKE REG 1 NEGATIVE   09350004
         B     *+8                     BRANCH AROUND CONSTANT           09380004
&GNAME   DC    X'80000000'             MASK TO SET REG 1 NEGATIVE       09450004
.SVC1    ANOP                                                           09460002
         AIF   ('&BRANCH' EQ 'YES').BRENTRY                             09470002
         SVC   60                      ISSUE STAE SVC                   09500004
         AGO   .TOKBACK                                      @G81CP2F   09550000
.BRENTRY ANOP                                                           09560002
         AIF   ('&SYSAM64' NE 'YES').NOT64B1                       @L2A 09560300
         LLGT  15,CVTSV60-CVTMAP(0,15) BRANCH ENTRY ADDRESS             09560600
         AGO   .NOT64B2                                            @L2A 09560900
.NOT64B1 ANOP                                                      @L2A 09561200
         L     15,CVTSV60-CVTMAP(0,15) BRANCH ENTRY ADDRESS             09561704
.NOT64B2 ANOP                                                      @L2A 09562500
         AIF   ('&SVEAREA'(1,1) EQ '(').LR13                            09563300
         LA    13,&SVEAREA(1)          ACCESS ADDRESS OF USER SAVE AREA 09564004
         AGO   .GOBRNCH                                                 09566002
.LR13    ANOP                                                           09568002
         AIF   ('&SVEAREA(1)' EQ '13').GOBRNCH                          09568204
         LR    13,&SVEAREA(1)          ACCESS ADDRESS OF USER SAVE AREA 09568402
.GOBRNCH ANOP                                                           09568802
         AIF   ('&KEY' EQ 'SAVE').SAVKEY                                09570804
         AGO   .KEY2                                                    09572804
.SAVKEY  IPK                           SAVE CURRENT KEY IN REG2         09574804
.KEY2    AIF    ('&KEY' EQ '').KEY3                                     09576804
         SPKA  0(0)                    SET KEY 0 FOR BRANCH ENTRY       09578804
.KEY3    ANOP                                                           09580804
         BALR  14,15                   BRANCH ENTER SVC 60              09590004
         AIF   ('&KEY' EQ 'SAVE').RESTKEY                               09590204
         AIF   ('&KEY' EQ '').TOKBACK                        @G81CP2F   09590400
         AIF   ('&KEY' EQ '0').TOKBACK                       @G81CP2F   09590900
         AIF   ('&KEY' GT '0' AND '&KEY' LT '16').SETKEY                09591400
.BADKEY  MNOTE  8,'**** INVALID KEY VALUE SPECIFIED '                   09591900
         AGO   .TOKBACK                                      @G81CP2F   09592400
.RESTKEY SPKA  0(2)                    RESTORE KEY SAVED IN REG2        09592900
         AGO   .TOKBACK                                      @G81CP2F   09593400
.SETKEY  ANOP                                                           09593900
&KEYVAL  SETA   (&KEY*16)                                               09594400
         SPKA  &KEYVAL.(0)             SET SPECIFIED KEY                09594900
.TOKBACK ANOP                                                @G81CP2F   09595400
         AIF   ('&EXIT' EQ '0' OR '&TYPE' EQ 'OV').END       @G81CP2F   09595900
         AIF   ('&TOKEN' EQ '').END                          @G81CP2F   09596400
         AIF   ('&TOKEN'(1,1) EQ '(').TOKRET                 @G81CP2F   09596900
         ST    0,&TOKEN                RETURN TOKEN VALUE    @G81CP2F   09597400
         MEXIT                                               @G81CP2F   09597900
.TOKRET  LR    &TOKEN(1),0             RETURN TOKEN VALUE    @G81CP2F   09598400
.END     MEXIT                                                          09598900
.NOXCTL  ANOP                                                           09600002
         AIF   ('&MF(1)' EQ 'E' AND '&MF(2)' NE '(1)').SVC1  @ZMD0006   09650000
         LA    1,0(0,1)                MAKE REG1 POS.  XCTL=NO          09700004
         AGO   .SVC1                                                    09750000
.BADXCTL MNOTE 8,'***     XCTL=&XCTL - PARAMETER INVALID'               09800000
         MEXIT                                                          09850000
.LISTERR IHBERMAC 69                    REG NOTE W/MF=L - INVALID       09900000
         MEXIT                                                          09950002
.ERRASY  ANOP                                                           10000002
         IHBERMAC  54,,&ASYNCH                                          10050002
         MEXIT                                                          10100002
.PURERR  ANOP                                                           10150002
         IHBERMAC  54,,&PURGE                                           10200002
         MEXIT                                                          10210002
.TERMERR ANOP                                                           10220002
         IHBERMAC 54,,&TERM                                             10230002
         MEXIT                                                          10240002
.SDWALOC31ERR ANOP                                                 @L2A 10240500
         IHBERMAC 54,,&SDWALOC31                                   @L2A 10241000
         MEXIT                                                     @L2A 10241500
.RECERR  ANOP                                                           10242002
         IHBERMAC  54,,&RECORD                                          10244002
         MEXIT                                                          10246002
.BRNERR  ANOP                                                           10248002
         IHBERMAC  54,,&BRANCH                                          10248402
         MEXIT                                                          10248802
.NCNLERR ANOP                                                      @D1A 10248900
         IHBERMAC  54,,&CANCEL                                     @D1A 10249000
         MEXIT                                                     @D1A 10249100
.ESTARER ANOP                                                           10249202
         IHBERMAC  54,,&ESTAR                                           10249602
         MEXIT                                                @G860P1C  10255200
.S370    ANOP     INVOKE SYSTEM 370 COMPATIBLE LEVEL OF ESTAE  @G860P1C 10260800
&NAME    ESTAE7 &EXIT,&TYPE,PARAM=&PARAM,XCTL=&XCTL,MF=&MF,            J10266400
               PURGE=&PURGE,ASYNCH=&ASYNCH,TCB=&TCB,ESTAR=&ESTAR,      J10272000
               TERM=&TERM,RECORD=&RECORD,BRANCH=&BRANCH,               J10277600
               SVEAREA=&SVEAREA,RELATED=&RELATED,KEY=&KEY,             J10283200
               TOKEN=&TOKEN,TKNPASS=&TKNPASS                   @G860P1C 10288800
         MEND                                                           10294400
*                                                            @G860P38*/ 10322200
*%ESTAE: MACRO KEYS(PARAM,XCTL,MF,PURGE,ASYNCH,TERM,RECORD,CANCEL,      10350000
*                   SDWALOC31,                            /*     @L2A*/ 10400000
*              BRANCH,SVEAREA,KEY,RELATED,TOKEN,TKNPASS); /*     @D1C*/ 10450000
* ANS ('?'||MACLABEL||'ESTAEP '||MACLIST||MACKEYS||';');  /* @G860P38*/ 10500000
* %END;                                                   /* @G860P38*/ 10550000
