*%/*                                                                    00050000
         MACRO                                                          00100000
&NAME    SETLOCK8 &REQUEST,&TYPE=,&ADDR=,&MODE=,&DISABLE,&RELATED=,    X00150000
               &REGS=,&BRANCH=,&ASCB=,&LOCKHLD=,&SCOPE=,&LOCK= @G860PXA 00200000
.**************************************************************         00250000
.*01*  MACRO NAME = SETLOCK8                                            00300000
.*                                                                      00350000
.*01*  PROPRIETARY STATEMENT =                                     @L1A 00400000
.*        LICENSED MATERIALS - PROPERTY OF IBM                          00600000
.*        THIS MACRO IS "RESTRICTED MATERIALS OF IBM"                   00612500
.*        5695-047 (C)COPYRIGHT IBM CORP 1990                           00625000
.*        SEE COPYRIGHT INSTRUCTIONS                                    00637500
.*                                                                      00650000
.*01*  STATUS = HBB4410                                            @L1A 00700000
.*                                                                      00750000
.*01*  FUNCTION = GENERATE THE LINKAGE TO SPIN AND SUSPEND              00800000
.*                LOCK MANAGER                                          00850000
.*                                                                      00900000
.*01*  COMPONENT = SC1C5 (SUPERVISOR CONTROL)                           00950000
.*                                                                      01000000
.*01*  MACLIB = AMACLIB                                                 01050000
.*                                                                      01100000
.*02*   NOTES =                                                         01150000
.*        AR-MODE INVOKERS:                                        @L3A 01200000
.*          SYSSTATE IS USED TO TEST FOR AN AR-MODE INVOKER.            01250000
.*          FOR INSTRUCTIONS SUCH AS LM WITH NO INDEX REGISTER, THE     01300000
.*            AR OF THE BASE REGISTER IS SET BEFOREHAND.                01350000
.*          PRIMARY MODE IS ENTERED BEFORE THE CALL, AND AR-MODE        01400000
.*            IS REENTERED AFTER THE CALL.                              01450000
.*          R14 HOLDS THE PSALITA RATHER THAN R13 TO CONFORM TO THE     01500000
.*            PL/AS SUPPORT.                                            01550000
.*          FOR REGS=SAVE, THE STM IS DONE OFF R13 SINCE AR13 MUST HAVE 01600000
.*            BEEN ESTABLISHED BY AN AR-MODE INVOKER.                   01650000
.*          FOR REGS=SAVE, UPON RETURN, SINCE AR13 IS NEEDED TO DO THE  01700000
.*            LM, BUT THE ADDRESS IS IN R15 WITH THE RETURN CODE IN     01750000
.*            R13, THE TWO REGS ARE SWAPPED BEFORE DOING THE LM.        01800000
.*            THIS SAVES A STORAGE REFERENCE.                           01850000
.*          FOR LM OF ONLY 2 REGS, RATHER THAN SETTING THE AR, 2 LOADS  01900000
.*            ARE DONE SPECIFYING INDEX RATHER THAN BASE REG.           01950000
.*                                                                      02000000
.*01*   CHANGE ACTIVITY =                                               02050000
.*    OZ35343 - CHANGE REFERENCES TO PSA LOCATIONS TO USE EXPLICIT      02100000
.*              ADDRESSABILITY SO THAT A USING PSA,0 IS NOT NEEDED TO   02150000
.*              INVOKE THE MACRO                                        02200000
.*                                                                      02250000
.*  $L1=AR       HBB3310  850801  PD16H4:  ACCESS REGISTER SUPPORT      02300000
.*  $L2=DATASPAC HBB3310  860220  PD22XB:  AR-MODE INVOKER SUPPORT      02350000
.*  $L3=DATASPAC HBB3310  860903  PD16Q4:  RSMDS LOCK                   02400000
.*  $D1=DCR0031  HBB3310  860903  PD16Q4:  IOS LOCK                     02450000
.*  $P1=PC40381  HBB3310  861101  PD16H4:  LOAD PARMS BEFORE PSALITA    02500000
.*  $P2=PC40337  HBB3310  861229  PD16Q4:  TEST FOR LOCK PARM WHEN      02550000
.*                                         TYPE=HIER IS NOT SPECIFIED   02600000
.*                                         ON TEST OPTION               02650000
.*  $L0=LOCKR    HBB4410  870831  PD16BN:  LOCK RESTRUCTURE             02675000
.*                                                                      02700000
.*                                                                      02750000
.**************************************************************@G50EPXS 02800000
.*                                                                      02850000
.*   CMSSMF LOCK SUPPORT                                       @G741PXT 02900000
.*   CML LOCK SUPPORT                                          @G387PXR 02950000
.*   DELETE IOSCAT,IOSLCH LOCKS                                @G860PXB 03000000
.*   CHANGES FOR SALLOC LOCK BREAKUP                           @G860PXA 03050000
.*   ADD CPU LOCK                                              @G860PXA 03100000
.*   CML TEST SUPPORT                                          @G382PXR 03150000
.*   ADD TEST SUPPORT FOR THE SALLOC LOCK BREAKUP              @G860PXA 03200000
.*   SUPPORT NEW INTERFACE FOR RELEASE ALL AND RELEASE REG     @G860PXA 03250000
.*   CPU TEST SUPPORT                                          @G860PXK 03300000
.*   ADD RSMCM LOCK                                            @G860PXJ 03350000
.*   ADD TEST SUPPORT FOR TYPE=HIER                            @G860PXA 03400000
.*   ADD "MODE=(COND,IN)" SUPPORT FOR CML LOCK OBTAIN              @L1A 03450000
.*   ADD RSMDS LOCK                                                @L3A 03500000
.*   ADD IOS LOCK                                                  @D1A 03550000
.**************************************************************@G860PXK 03600000
.*                                                                      03650000
         GBLC  &SYSASCE            GLOBAL FOR SYSSTATE MACRO       @L2A 03700000
         SYSSTATE TEST             OBTAIN DEFAULT SYSASCE          @L2A 03750000
         GBLC  &SYSSPLV            GLOBAL FOR SPLEVEL MACRO    @G860PXD 03800000
         SPLEVEL TEST              OBTAIN DEFAULT SYSSPLV      @G860PXD 03850000
         AIF   ('&SYSSPLV' EQ '1').LEVEL1  GO GEN DOWNWARD     @G860PXD 03900000
.*                                 COMPATIBLE MACRO            @G860PXD 03950000
         GBLC  &MESSAGE                                                 04000000
         LCLA  &INDEX,&INDEX0                                  @G860PXD 04050000
         LCLA  &OFSET,&MASK,&BYTE,&I                                    04100000
         LCLA  &LOCALX,&CMLX                                   @G860PXA 04150000
         LCLB  &ADVALID,&COND(4)                                        04200000
         LCLB  &TYPEREG                                                 04250000
         LCLC  &MESSAG2,&REG1,&RADDR,&BRADR(4)                 @G387PXR 04300000
         LCLC  &INSTR,&AREA,&LABEL,&REG2                       @G387PXR 04350000
&LABEL   SETC  'IHA&SYSNDX'                                    @G860PXA 04400000
*        MACDATE = 09/15/87                                             04450000
         AIF   ('&REQUEST' EQ 'TEST').TEST                              04500000
&INDEX   SETA  0                                                        04550000
         AIF   (T'&BRANCH EQ 'O').NOBRNAM                               04600000
.*       IHB280 BRANCH INVALID WITH OBTAIN/RELEASE                      04650000
         IHBERMAC 1020,BRANCH,&REQUEST                                  04700000
         MEXIT                                                          04750000
.NOBRNAM ANOP                                                           04800000
         AIF   ('&REQUEST' EQ 'OBTAIN').OBTAIN                          04850000
         AIF   ('&REQUEST' EQ 'RELEASE').RELEASE                        04900000
         IHBERMAC 24                                                    04950000
         MEXIT                                                          05000000
.OBTAIN  AIF   (T'&TYPE EQ 'O').ERRTYPE                        @G387PXR 05050000
         AIF   ('&TYPE' EQ 'ALOCAL').EROALOC                   @G387PXR 05100000
         AIF   ('&DISABLE' EQ '').OBTAIN2                               05150000
         AIF   ('&DISABLE' NE 'DISABLED').ERROD                         05200000
.* NOTE THAT ON AN OBTAIN, TYPE=CPU, DISABLED IS NOT SUPPORTED @G860PXA 05250000
         AIF   ('&TYPE' NE 'CPU').OBTAIN2                      @G860PXA 05300000
.*       IHB280  DISABLE INVALID WITH CPU                      @G860PXA 05350000
         IHBERMAC 1020,&DISABLE,&TYPE                          @G860PXA 05400000
         MEXIT                                                 @G860PXA 05450000
.OBTAIN2 ANOP                                                           05500000
         AIF   ('&TYPE' NE 'CPU').MODECK                       @G860PXA 05550000
         AIF   (T'&MODE EQ 'O').COND                           @G860PXA 05600000
         MNOTE 0,'*** MODE IGNORED WITH TYPE=CPU'              @G860PXA 05650000
         AGO   .COND                                           @G860PXA 05700000
.MODECK  ANOP                                                  @G860PXA 05750000
         AIF   ('&MODE' EQ 'COND').COND      COND REQUIRES NO INCREMENT 05800000
         AIF   ('&MODE' EQ 'UNCOND').UNCOND                             05850000
         AIF   ('&MODE' EQ '(COND,IN)').CONDIN                     @L1A 05900000
         AIF   ('&MODE' NE '').MODERR                                   05950000
.*       IHB001  MODE OPERAND REQUIRED, NOT SPECIFIED                   06000000
         IHBERMAC 1006,MODE                                             06050000
         MEXIT                                                          06100000
.EROALOC ANOP                                                  @G387PXR 06150000
.*       IHB280 ALOCAL INVALID WITH OBTAIN                     @G387PXR 06200000
         IHBERMAC 1020,ALOCAL,OBTAIN                           @G387PXR 06250000
         MEXIT                                                 @G387PXR 06300000
.MODERR  ANOP                                                           06350000
.*       IHB002  INVALID MODE OPERAND SPECIFIED - XXX                   06400000
               IHBERMAC 1001,MODE,&MODE                                 06450000
         MEXIT                                                          06500000
.ERROD   ANOP                                                           06550000
         AIF   ('&DISABLE' EQ 'DISABLED').ERROD1                        06600000
.*       IHB244  INVALID POSIT-NL XXX OPERAND                           06650000
.INVLDIS IHBERMAC 1008,&DISABLE,1                                       06700000
         MEXIT                                                          06750000
.ERROD1  ANOP                                                           06800000
&MESSAGE SETC  'COND OR SUSPEND LOCK OBTAIN'                            06850000
.*       IHB280  DISABLE INVALID WITH COND OR SUSPEND LOCK OBTAIN       06900000
         IHBERMAC 1020,&DISABLE,&MESSAGE                                06950000
         MEXIT                                                          07000000
.UNCOND  ANOP                                                           07050000
&INDEX   SETA  (&INDEX+12)              INCREMENT TO UNCOND OBTAIN      07100000
         AGO   .REGS                                                    07150000
.RELEASE AIF   (T'&MODE NE 'O').ERRMOD                         @G387PXR 07200000
         AIF   (T'&TYPE EQ 'O').ERRTYPE                        @G387PXR 07250000
         AIF   ('&TYPE' EQ 'ALOCAL').ERRALOC                   @G387PXR 07300000
         AIF   ('&DISABLE' EQ 'DISABLED').TESTSUP  TEST FOR SUSPEND REQ 07350000
         AIF   ('&DISABLE' EQ '').RELSE                                 07400000
.*       IHB244  INVALID POSIT-NL XXX OPERAND                           07450000
         IHBERMAC 1008,&DISABLE,1                                       07500000
         MEXIT                                                          07550000
.ERRTYPE ANOP                                                  @G387PXR 07600000
.*       IHB001 TYPE OPERAND REQUIRED, NOT SPECIFIED           @G387PXR 07650000
         IHBERMAC 1006,TYPE                                    @G387PXR 07700000
         MEXIT                                                 @G387PXR 07750000
.ERRMOD  ANOP                                                           07800000
.*       IHB280               MODE INVALID WITH RELEASE                 07850000
         IHBERMAC 1020,MODE,RELEASE                                     07900000
         MEXIT                                                          07950000
.ERRALOC ANOP                                                  @G387PXR 08000000
.*       IHB280  ALOCAL INVALID WITH RELEASE                   @G387PXR 08050000
         IHBERMAC 1020,ALOCAL,RELEASE                          @G387PXR 08100000
         MEXIT                                                 @G387PXR 08150000
.RELSE   ANOP                                                           08200000
&INDEX   SETA  (&INDEX+12)                                     @G860PXA 08250000
.* NOTE THAT THE LITA OFFSET FOR RELEASE WITH TYPE=CPU IS +12  @G860PXA 08300000
         AIF   ('&TYPE' EQ 'CPU').REGS                         @G860PXA 08350000
&INDEX   SETA  (&INDEX+12)     INCREMENT TO RELEASE W/O DISBLE @G860PXA 08400000
         AGO   .REGS                                                    08450000
.TESTSUP ANOP                      CHECK DISABLE INVALID CASES @G860PXA 08500000
         AIF   ('&TYPE'(1,3) EQ 'CMS').ERRDIS                  @G741PXT 08550000
         AIF   ('&TYPE' EQ 'LOCAL').ERRDIS                              08600000
         AIF   ('&TYPE' EQ 'CML').ERRDIS                       @G387PXR 08650000
         AIF   ('&TYPE' EQ 'CPU').ERRDIS                       @G860PXA 08700000
&INDEX   SETA  (&INDEX+36)              INCREMENT TO RELEASE DISABLE    08750000
         AGO   .REGS                                                    08800000
.ERRDIS  ANOP                                                           08850000
.*       IHB280  DISABLE INVALID WITH CMS/LOCAL/CML/CPU        @G860PXA 08900000
         IHBERMAC 1020,&DISABLE,&TYPE                                   08950000
         MEXIT                                                          09000000
.COND    ANOP                                                           09050000
         AIF   ('&DISABLE' NE '').ERROD                                 09100000
.REGS    ANOP                                                           09150000
         AIF   ('&REGS' EQ 'SAVE').TYPE SAVE IS VALID PARAMETER         09200000
         AIF   ('&REGS' EQ 'USE').TYPE  USE IS VALID PARAMETER          09250000
         AIF   ('&REGS' EQ '').TYPE     PARAMETER IS NOT REQUIRED       09300000
.BADREGS ANOP                                                      @L1A 09350000
.*       IHB002 INVALID REGS OPERAND SPECIFIED - XXX                    09400000
         IHBERMAC 1001,REGS,&REGS                                       09450000
         MEXIT                                                          09500000
.TYPE    ANOP                                                           09550000
&INDEX0  SETA  &INDEX                                                   09600000
         AIF   ('&TYPE' EQ 'DISP').CODE1 HIGH LOCK INCR NOT REQ@G387PXR 09650000
&INDEX   SETA  (&INDEX+48)              INCREMENT FOR 1 SPIN LOCK ENTRY 09700000
         AIF   ('&TYPE' EQ 'IOSCAT').INVTYP                    @G860PXB 09750000
         AIF   ('&TYPE' EQ 'RSMDS').CODEA                          @L3A 09800000
&INDEX   SETA  (&INDEX+48)                                              09850000
         AIF   ('&TYPE' EQ 'IOSUCB').CODEA                              09900000
&INDEX   SETA  (&INDEX+48)                                              09950000
         AIF   ('&TYPE' EQ 'IOSLCH').INVTYP                    @G860PXB 10000000
&INDEX   SETA  (&INDEX+48)                                              10050000
         AIF   ('&TYPE' EQ 'IOSYNCH').CODEA                             10100000
&INDEX   SETA  (&INDEX+48)                                              10150000
         AIF   ('&TYPE' EQ 'TPNCB').CODEA                               10200000
&INDEX   SETA  (&INDEX+48)                                              10250000
         AIF   ('&TYPE' EQ 'TPDNCB').CODEA                              10300000
&INDEX   SETA  (&INDEX+48)                                              10350000
         AIF   ('&TYPE' EQ 'TPACBDEB').CODEA                            10400000
&INDEX   SETA  (&INDEX+48)                                              10450000
         AIF   ('&TYPE' EQ 'ASM').CODEA                                 10500000
&INDEX   SETA  (&INDEX+48)                                              10550000
         AIF   ('&TYPE' EQ 'SALLOC').CODE1                     @G387PXR 10600000
&INDEX   SETA  (&INDEX+48)                                              10650000
         AIF   ('&TYPE' EQ 'SRM').CODE1                        @G387PXR 10700000
&INDEX   SETA  (&INDEX+48)                                              10750000
         AIF   ('&TYPE' EQ 'CMS').CODE1                        @G387PXR 10800000
&INDEX   SETA  (&INDEX+36)                                              10850000
         AIF   ('&TYPE' EQ 'LOCAL').CODE1                      @G387PXR 10900000
&INDEX   SETA  &INDEX+36-&INDEX0                                        10950000
         AIF   ('&TYPE' EQ 'CML').ADDICMS                      @G387PXR 11000000
         AIF   ('&TYPE'(1,3) EQ 'CMS').ADDICMS                 @G50EPXS 11050000
         AIF   ('&TYPE' EQ 'SPIN').CKSPIN                      @G860PXA 11100000
         AIF   ('&TYPE' EQ 'ALL').CKSPIN                       @G860PXA 11150000
         AIF   ('&TYPE'(1,1) NE '(').CKLOCKS                   @G860PXA 11200000
.CKSPIN  ANOP                                                  @G860PXA 11250000
         AIF   ('&REQUEST' NE 'RELEASE').BADTYPE                        11300000
         AIF   (T'&ADDR NE 'O').ERRADD                                  11350000
         AIF   ('&TYPE' EQ 'SPIN').RSPIN                                11400000
         AIF   ('&TYPE' EQ 'ALL').RALL                                  11450000
         AIF   ('&TYPE'(K'&TYPE,1) EQ ')').RREG                         11500000
         AGO .INVTYP       INDICATE TYPE OPERAND IS INVALID    @G387PXR 11550000
.ADDICMS ANOP                                                  @G50EPXS 11600000
&INDEX   SETA  (&INDEX+12+&INDEX0)                             @G50EPXS 11650000
         AIF   ('&TYPE' EQ 'CMSEQDQ').CODE1                    @G387PXR 11700000
&INDEX   SETA  (&INDEX+24)                                     @G50EPXS 11750000
         AIF   ('&TYPE' EQ 'CMSALL').CKALL                     @G741PXT 11800000
&INDEX   SETA  (&INDEX+48)                                     @G741PXT 11850000
         AIF   ('&TYPE' EQ 'CMSSMF').CODE1                     @G387PXR 11900000
&INDEX   SETA  (&INDEX+36)                                     @G387PXR 11950000
         AIF   ('&TYPE' EQ 'CML').CODE                         @G387PXR 12000000
         AGO   .BADTYPE                                        @G741PXT 12050000
.CKALL   ANOP                                                  @G741PXT 12100000
         AIF   ('&MODE' NE 'COND').CODE1                       @G387PXR 12150000
         MNOTE 8,'*** &TYPE CONDITIONAL OBTAIN NOT SUPPORTED'  @G50EPXS 12200000
         MEXIT                                                 @G50EPXS 12250000
.CKLOCKS ANOP                                                  @G860PXA 12300000
&INDEX   SETA  (&INDEX+156+&INDEX0) UPDATE PTR TO TRACE ENTRY  @G860PXA 12350000
         AIF   ('&TYPE' EQ 'TRACE').SCOPE                      @G860PXA 12400000
&INDEX   SETA  (&INDEX+96) UPDATE LITA PTR TO VSMPAG ENTRY     @G860PXA 12450000
         AIF   ('&TYPE' EQ 'VSMPAG').CODE1                     @G860PXA 12500000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO RSM ENTRY    @G860PXA 12550000
         AIF   ('&TYPE' EQ 'RSM').SCOPE                        @G860PXA 12600000
&INDEX   SETA  (&INDEX+96) UPDATE LITA POINTER TO RSMAD ENTRY  @G860PXA 12650000
         AIF   ('&TYPE' EQ 'RSMAD').CODEA                      @G860PXA 12700000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO RSMXM ENTRY  @G860PXA 12750000
         AIF   ('&TYPE' EQ 'RSMXM').CODEA                      @G860PXA 12800000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO RSMST ENTRY  @G860PXA 12850000
         AIF   ('&TYPE' EQ 'RSMST').CODEA                      @G860PXA 12900000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO ASMGL ENTRY  @G860PXA 12950000
         AIF   ('&TYPE' EQ 'ASMGL').CODEA                      @G860PXA 13000000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO VSMFIX ENTRY @G860PXA 13050000
         AIF   ('&TYPE' EQ 'VSMFIX').CODE1                     @G860PXA 13100000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO RSMGL ENTRY  @G860PXA 13150000
         AIF   ('&TYPE' EQ 'RSMGL').CODEA                      @G860PXA 13200000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO CPU ENTRY    @G860PXA 13250000
         AIF   ('&TYPE' EQ 'CPU').CODE1                        @G860PXA 13300000
&INDEX   SETA  (&INDEX+72) UPDATE LITA POINTER TO RSMCM ENTRY  @G860PXJ 13350000
         AIF   ('&TYPE' EQ 'RSMCM').CODEA                      @G860PXJ 13400000
&INDEX   SETA  (&INDEX+64) UPDATE LITA POINTER TO IOS ENTRY        @D1A 13450000
         AIF   ('&TYPE' EQ 'IOS').SCOPE                            @D1A 13500000
.BADTYPE AIF   ('&TYPE' NE '').INVTYP                                   13550000
.*       IHB001 TYPE OPERAND REQUIRED NOT SPECIFIED                     13600000
         IHBERMAC 1006,TYPE                                             13650000
         MEXIT                                                          13700000
.INVTYP  ANOP                                                           13750000
.*       IHB002  INVALID TYPE OPERAND SPECIFIED                         13800000
         IHBERMAC 1001,TYPE,&TYPE                                       13850000
         MEXIT                                                          13900000
.SCOPE   ANOP         CHECK LOCKS THAT REQUIRE SCOPE KEYWORD   @G860PXA 13950000
         AIF   (T'&SCOPE EQ 'O').SCOPREQ                       @G860PXA 14000000
         AIF   ('&SCOPE' EQ 'SHR').CODE1A                      @G860PXA 14050000
&INDEX   SETA  (&INDEX+48) UPDATE LITA POINTER TO EXCL ENTRY   @G860PXA 14100000
         AIF   ('&SCOPE' EQ 'EXCL').CODE1A                     @G860PXA 14150000
.*       IHB002 INVALID SCOPE OPERAND SPECIFIED-XXXX           @G860PXA 14200000
         IHBERMAC 1001,SCOPE,&SCOPE                            @G860PXA 14250000
         MEXIT                                                 @G860PXA 14300000
.SCOPREQ ANOP                                                  @G860PXA 14350000
.*       IHB001 SCOPE OPERAND REQUIRED NOT SPECIFIED           @G860PXA 14400000
         IHBERMAC 1006,SCOPE                                   @G860PXA 14450000
         MEXIT                                                 @G860PXA 14500000
.NOSCOPE ANOP                                                  @G860PXA 14550000
.*       IHB280 SCOPE INVALID WITH TYPE=XXX                    @G860PXA 14600000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G860PXA 14650000
         IHBERMAC 1020,SCOPE,&MESSAGE                          @G860PXA 14700000
         MEXIT                                                 @G860PXA 14750000
.CODE1   ANOP         CHECK CASES WHERE SCOPE IS NOT ALLOWED   @G860PXA 14800000
         AIF   (T'&SCOPE NE 'O').NOSCOPE                       @G860PXA 14850000
.CODE1A  AIF   (T'&ASCB NE 'O').LOCASCB                        @G860PXA 14900000
         AIF   (T'&LOCKHLD EQ 'O').CODE                        @G387PXR 14950000
.*       IHB280 LOCKHLD INVALID WITH TYPE=XXX                  @G387PXR 15000000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G387PXR 15050000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                        @G387PXR 15100000
         MEXIT                                                 @G387PXR 15150000
.LOCASCB ANOP                                                  @G387PXR 15200000
.*       IHB280 ASCB INVALID WITH TYPE=XXX                     @G387PXR 15250000
&MESSAGE SETC 'TYPE='.'&TYPE'                                  @G387PXR 15300000
         IHBERMAC 1020,ASCB,&MESSAGE                           @G387PXR 15350000
         MEXIT                                                 @G387PXR 15400000
.CODE    AIF   ('&ADDR' NE '').ERRADD                                   15450000
         AIF   ('&REGS' EQ 'SAVE').SAVE1                                15500000
         AIF   ('&REGS' EQ 'USE').USE1                                  15550000
&NAME    DS    0H                                                  @P1A 15600000
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                15650000
         AIF   ('&TYPE' EQ 'CML').LOAD                         @G387PXR 15700000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @P1A 15750000
         AIF   ('&SYSASCE' EQ 'P').NOAR1                           @L2A 15800000
         LAE   14,0(14,0)               GET ALET OF 0              @L2A 15850000
.NOAR1   ANOP                                                           15900000
         LM    11,13,&INDEX.(14)        LOAD ADDRESS OF THE LOCKWORD,  *15950000
                                        PARM LIST POINTER, AND         *16000000
                                        LOCK RTNS ENTRY POINT.     @L2C 16050000
         AGO   .MNLCODE                                                 16100000
.SAVE1   ANOP                                                           16150000
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          16200000
         STM   11,14,0(13)              SAVE REGISTERS             @L2C 16250000
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                16300000
         AIF   ('&TYPE' EQ 'CML').LOAD                         @G387PXR 16350000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @P1A 16400000
         AIF   ('&SYSASCE' EQ 'P').NOAR3                           @L2A 16450000
         LAE   14,0(14,0)               GET ALET OF 0              @L2A 16500000
.NOAR3   ANOP                                                           16550000
         LM    11,13,&INDEX.(14)        LOAD ADDRESS OF THE LOCKWORD,  *16600000
                                        PARM LIST POINTER, AND         *16650000
                                        LOCK RTNS ENTRY POINT.     @L2C 16700000
         AGO   .MNLCODE                                                 16750000
.USE1    ANOP                                                           16800000
&NAME    LR    15,11                    SAVE REGISTER 11                16850000
         LR    0,12                     SAVE REGISTER 12                16900000
         LR    1,13                     SAVE REGISTER 13                16950000
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                17000000
         AIF   ('&TYPE' EQ 'CML').LOAD                         @G387PXR 17050000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @P1A 17100000
         AIF   ('&SYSASCE' EQ 'P').NOAR5                           @L2A 17150000
         LAE   14,0(14,0)               GET ALET OF 0              @L2A 17200000
.NOAR5   ANOP                                                           17250000
         LM    11,13,&INDEX.(14)        LOAD ADDRESS OF THE LOCKWORD,  *17300000
                                        PARM LIST POINTER, AND         *17350000
                                        LOCK RTNS ENTRY POINT.     @L2C 17400000
         AGO   .MNLCODE                                                 17450000
.LOAD    ANOP                                                           17500000
&INDEX   SETA  (&INDEX+8)                                               17550000
         AIF   ('&TYPE' EQ 'CML').CODEB                        @G387PXR 17600000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @P1A 17650000
         L     13,&INDEX.(14,0)         LOAD ADDRESS OF LOCK RTN   @L2C 17700000
         AGO   .MNLCODE                                                 17750000
.ERRADD  ANOP                                                           17800000
.*       IHB280 ADDR INVALID WITH TYPE=XXX                              17850000
&MESSAGE SETC  'TYPE='.'&TYPE'                                          17900000
         IHBERMAC 1020,ADDR,&MESSAGE                                    17950000
         MEXIT                                                          18000000
.CODEA   ANOP                                                           18050000
&INDEX   SETA  (&INDEX+4)     INCREMENT PAST LK ADDR                    18100000
.* SCOPE KEYWORD IS NOT ALLOWED FOR LOCKS IN THIS PATH         @G860PXA 18150000
         AIF   (T'&SCOPE NE 'O').NOSCOPE                       @G860PXA 18200000
         AIF   (T'&ASCB NE 'O').INVASCB                        @G387PXR 18250000
         AIF   (T'&LOCKHLD EQ 'O').CODEA1                      @G387PXR 18300000
.*       IHB280 LOCKHLD INVALID WITH TYPE=XXX                  @G387PXR 18350000
&MESSAGE SETC 'TYPE='.'&TYPE'                                  @G387PXR 18400000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                        @G387PXR 18450000
         MEXIT                                                 @G387PXR 18500000
.INVASCB ANOP                                                  @G387PXR 18550000
.*       IHB280 ASCB INVALID WITH TYPE=XXX                     @G387PXR 18600000
&MESSAGE SETC 'TYPE='.'&TYPE'                                  @G387PXR 18650000
         IHBERMAC 1020,ASCB,&MESSAGE                           @G387PXR 18700000
         MEXIT                                                 @G387PXR 18750000
.CODEA1  AIF   ('&ADDR' EQ '(11)').MR11 LK ADDR ALREADY LOADED @G387PXR 18800000
         AIF   ('&ADDR' NE '').ADRLA                                    18850000
.*       IHB001 ADDR OPERAND REQUIRED NOT SPECIFIED                     18900000
         IHBERMAC 1006,ADDR                                             18950000
         MEXIT                                                          19000000
.CODEB   ANOP                                                  @G387PXR 19050000
         AIF   (T'&ASCB EQ 'O').ERRASCB                        @G387PXR 19100000
         AIF   ('&ASCB' EQ '(11)').CMLR11                      @G387PXR 19150000
         AIF   ('&ASCB'(1,1) EQ '(').ERREG2                    @G387PXR 19200000
         AIF   ('&ASCB' NE '').CMLLA                           @G387PXR 19250000
.ERRASCB ANOP                                                  @G387PXR 19300000
.*       IHB001  ASCB OPERAND REQUIRED NOT SPECIFIED           @G387PXR 19350000
         IHBERMAC 1006,ASCB                                    @G387PXR 19400000
         MEXIT                                                 @G387PXR 19450000
.CMLR11  ANOP                                                  @G387PXR 19500000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @P1A 19550000
         L     13,&INDEX.(14,0)         LOAD ADDR OF LOCK RTN      @L2C 19600000
         AGO   .MNLCODE                                        @G387PXR 19650000
.CMLLA   L     11,&ASCB                 LOAD ASCB ADDR FOR CML @G387PXR 19700000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @P1A 19750000
         L     13,&INDEX.(14,0)         LOAD ADDR OF LOCK RTN      @L2C 19800000
         AGO   .MNLCODE                                        @G387PXR 19850000
.ERREG2  ANOP                                                  @G387PXR 19900000
&MESSAGE SETC  'REGISTER NOTATION'                             @G387PXR 19950000
.*       IHB280 REGISTER NOTATION INVALID WITH ASCB            @G387PXR 20000000
         IHBERMAC 1020,&MESSAGE,ASCB                           @G387PXR 20050000
         MEXIT                                                 @G387PXR 20100000
.ERREG1  ANOP                                                           20150000
&MESSAGE SETC  'REGISTER NOTATION'                                      20200000
.*       IHB280 REGISTER NOTATION INVALID WITH ADDR                     20250000
         IHBERMAC 1020,&MESSAGE,ADDR                                    20300000
         MEXIT                                                          20350000
.ADRLA   ANOP                                                           20400000
         AIF   ('&ADDR'(1,1) EQ '(').ERREG1                             20450000
         AIF   ('&REGS' EQ 'SAVE').SAVE2                                20500000
         AIF   ('&REGS' EQ 'USE').USE2                                  20550000
&NAME    LA    11,&ADDR                 LOCKWORD ADDRESS                20600000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @L2C 20650000
         AIF   ('&SYSASCE' EQ 'P').NOAR6                           @L2A 20700000
         L     12,&INDEX.(14,0)         OBTAIN PARM POINTER        @L2A 20750000
         L     13,&INDEX.+4(14,0)       OBTAIN ENTRY POINT         @L2A 20800000
         AGO   .MNLCODE                                            @L2A 20850000
.NOAR6   ANOP                                                           20900000
         LM    12,13,&INDEX.(14)        OBTAIN PARM POINTER &          *20950000
                                        LOCK RTNS ENTRY POINT.     @L2C 21000000
         AGO   .MNLCODE                                                 21050000
.SAVE2   ANOP                                                           21100000
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          21150000
         STM   11,14,0(13)              SAVE REGISTERS             @L2A 21200000
         LA    11,&ADDR                 LOCKWORD ADDRESS                21250000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @L2C 21300000
         AIF   ('&SYSASCE' EQ 'P').NOAR9                           @L2A 21350000
         L     12,&INDEX.(14,0)         OBTAIN PARM POINTER        @L2A 21400000
         L     13,&INDEX.+4(14,0)       OBTAIN ENTRY POINT         @L2A 21450000
         AGO   .MNLCODE                                            @L2A 21500000
.NOAR9   ANOP                                                           21550000
         LM    12,13,&INDEX.(14)        OBTAIN PARM POINTER &          *21600000
                                        LOCK RTNS ENTRY POINT.     @L2C 21650000
         AGO   .MNLCODE                                                 21700000
.USE2    ANOP                                                           21750000
&NAME    LR    15,11                    SAVE REGISTER 11                21800000
         LR    0,12                     SAVE REGISTER 12                21850000
         LR    1,13                     SAVE REGISTER 13                21900000
         LA    11,&ADDR                 LOCKWORD ADDRESS                21950000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @L2C 22000000
         AIF   ('&SYSASCE' EQ 'P').NOAR11                          @L2A 22050000
         L     12,&INDEX.(14,0)         OBTAIN PARM POINTER        @L2A 22100000
         L     13,&INDEX.+4(14,0)       OBTAIN ENTRY POINT         @L2A 22150000
         AGO   .MNLCODE                                            @L2A 22200000
.NOAR11  ANOP                                                           22250000
         LM    12,13,&INDEX.(14)        OBTAIN PARM POINTER &          *22300000
                                        LOCK RTNS ENTRY POINT.     @L2C 22350000
         AGO   .MNLCODE                                                 22400000
.MR11    ANOP                                                           22450000
         AIF   ('&REGS' EQ 'SAVE').SAVE3                                22500000
         AIF   ('&REGS' EQ 'USE').USE3                                  22550000
&NAME    L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @L2C 22600000
         AIF   ('&SYSASCE' EQ 'P').NOAR13                          @L2A 22650000
         L     12,&INDEX.(14,0)         OBTAIN PARM POINTER        @L2A 22700000
         L     13,&INDEX.+4(14,0)       OBTAIN ENTRY POINT         @L2A 22750000
         AGO   .MNLCODE                                            @L2A 22800000
.NOAR13  ANOP                                                           22850000
         LM    12,13,&INDEX.(14)        OBTAIN PARM POINTER &          *22900000
                                        LOCK RTNS ENTRY POINT.     @L2C 22950000
         AGO   .MNLCODE                                                 23000000
.SAVE3   ANOP                                                           23050000
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          23100000
         STM   11,14,0(13)              SAVE REGISTERS             @L2A 23150000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @L2C 23200000
         AIF   ('&SYSASCE' EQ 'P').NOAR15                          @L2A 23250000
         L     12,&INDEX.(14,0)         OBTAIN PARM POINTER        @L2A 23300000
         L     13,&INDEX.+4(14,0)       OBTAIN ENTRY POINT         @L2A 23350000
         AGO   .MNLCODE                                            @L2A 23400000
.NOAR15  ANOP                                                           23450000
         LM    12,13,&INDEX.(14)        OBTAIN PARM POINTER &          *23500000
                                        LOCK RTNS ENTRY POINT.     @L2C 23550000
         AGO   .MNLCODE                                                 23600000
.USE3    ANOP                                                           23650000
&NAME    LR    15,11                    SAVE REGISTER 11                23700000
         LR    0,12                     SAVE REGISTER 12                23750000
         LR    1,13                     SAVE REGISTER 13                23800000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @L2C 23850000
         AIF   ('&SYSASCE' EQ 'P').NOAR17                          @L2A 23900000
         L     12,&INDEX.(14,0)         OBTAIN PARM POINTER        @L2A 23950000
         L     13,&INDEX.+4(14,0)       OBTAIN ENTRY POINT         @L2A 24000000
         AGO   .MNLCODE                                            @L2A 24050000
.NOAR17  ANOP                                                           24100000
         LM    12,13,&INDEX.(14)        OBTAIN PARM POINTER &          *24150000
                                        LOCK RTNS ENTRY POINT.     @L2C 24200000
.MNLCODE ANOP                                                           24250000
         AIF   ('&MODE' EQ 'UNCOND').BALCK                              24300000
.MNLCOD2 ANOP                                                           24350000
         AIF   ('&SYSASCE' EQ 'P').NOAR36                          @L2A 24400000
         SAC   0                        PRIMARY MODE               @L2A 24450000
.NOAR36  ANOP                                                           24500000
         BALR  14,13                    BRANCH ENTER LOCK ROUTINE       24550000
         AIF   ('&SYSASCE' EQ 'P').NOAR37                          @L2A 24600000
         SAC   X'200'                   AR MODE                    @L2A 24650000
.NOAR37  ANOP                                                           24700000
.MNLCOD3 ANOP                                                           24750000
         AIF   ('&REGS' EQ 'SAVE').SAVE4                                24800000
         AIF   ('&REGS' NE 'USE').ENDIT                                 24850000
         LR    11,15                    RESTORE REGISTER 11             24900000
         LR    15,13                    PUT RETURN CODE IN REGISTER 15  24950000
         LR    12,0                     RESTORE REGISTER 12             25000000
         LR    13,1                     RESTORE REGISTER 13             25050000
         AGO   .ENDIT                                                   25100000
.BALCK   ANOP                                                           25150000
         AIF   ('&DISABLE' EQ '').MNLCOD2                               25200000
         AIF   ('&TYPE' EQ 'LOCAL').ERROD1                              25250000
         AIF   ('&TYPE' EQ 'CML').ERROD1                       @G387PXR 25300000
         AIF   ('&TYPE'(1,3) EQ 'CMS').ERROD1                  @G741PXT 25350000
         AIF   ('&SYSASCE' EQ 'P').NOAR42                          @L2A 25400000
         SAC   0                        PRIMARY MODE               @L2A 25450000
.NOAR42  ANOP                                                           25500000
         BAL   14,4(0,13)              BRANCH TO LOCK RTN AT DIS ENTRY  25550000
         AIF   ('&SYSASCE' EQ 'P').NOAR43                          @L2A 25600000
         SAC   X'200'                   AR MODE                    @L2A 25650000
.NOAR43  ANOP                                                           25700000
*        NOTE: YOU HAVE JUST SAID THAT YOU ARE DISABLED                 25750000
         AGO   .MNLCOD3                                                 25800000
.SAVE4   ANOP                                                           25850000
.LMEXIT  XR    13,15                    STEP 1, SWAP R13,R15       @L2A 25900000
         XR    15,13                    STEP 2, SWAP R13,R15       @L2A 25950000
         XR    13,15                    STEP 3, SWAP R13,R15       @L2A 26000000
         LM    11,14,0(13)              RESTORE REGS               @L2C 26050000
         MEXIT                                                          26100000
.*                                                                      26150000
.*************************************************************          26200000
.*           PROCESS "COND,IN" REQUEST                                  26250000
.*************************************************************          26300000
.*                                                                      26350000
.CONDIN  ANOP                                                      @L1A 26400000
         AIF   ('&TYPE' NE 'CML').CONDIN7 COND,IN REQUEST VALID    @L1A 26450000
.*                                      ONLY FOR CML LOCK OBTAIN        26500000
.*                                                                      26550000
         AIF   (T'&DISABLE NE 'O').ERROD  DISABLED IS NOT VALID    @L1A 26600000
.*                                      FOR CONDITIONAL OBTAIN          26650000
.*                                                                      26700000
         AIF   (T'&SCOPE NE 'O').NOSCOPE  SCOPE IS INVALID         @L1A 26750000
.*                                                                      26800000
         AIF   (T'&LOCKHLD NE 'O').CONDIN6 LOCKHLD IS INVALID      @L1A 26850000
.*                                                                      26900000
         AIF   (T'&ADDR NE 'O').ERRADD  ADDR IS INVALID            @L1A 26950000
.*                                                                      27000000
         AIF   (T'&LOCK NE 'O').CONDIN5 LOCK IS INVALID            @L1A 27050000
.*                                                                      27100000
         AIF   (T'&ASCB EQ 'O').ERRASCB ASCB MUST BE SPECIFIED     @L1A 27150000
.*                                                                      27200000
         AIF   ('&ASCB' EQ '(11)').CONDIN0 ASCB=(11) IS OK         @L1A 27250000
         AIF   ('&ASCB'(1,1) EQ '(').ERREG2 ASCB MUST NOT BE       @L1A 27300000
.*                                      A REGISTER EXCEPT (11)          27350000
.*                                                                      27400000
.CONDIN0 ANOP                                                      @L1A 27450000
         AIF   (T'&NAME EQ 'O').CONDIN1 BRANCH IF LABEL WAS NOT    @L1A 27500000
.*                                      SPECIFIED                       27550000
&NAME    DS    0H                                                  @L1A 27600000
.*                                                                      27650000
.CONDIN1 ANOP                                                      @L1A 27700000
         AIF   ('&REGS' EQ 'SAVE').CONDIN2                         @L1A 27750000
         AIF   ('&REGS' EQ 'USE').CONDIN3                          @L1A 27800000
         AIF   (T'&REGS EQ 'O').CONDIN4                            @L1A 27850000
.*                                                                      27900000
         AGO   .BADREGS                 REGS PARAMETER IS BAD      @L1A 27950000
.*                                                                      28000000
.*                                                                      28050000
.CONDIN2 ANOP                                                      @L1A 28100000
         LR    15,13                    LOAD SAVE AREA ADDRESS     @L1A 28150000
         STM   11,14,0(13)              SAVE REGISTERS             @L2C 28200000
         AGO   .CONDIN4                                                 28250000
.*                                                                      28300000
.CONDIN3 ANOP                                                      @L1A 28350000
         LR    15,11                    SAVE REGISTER 11           @L1A 28400000
         LR    0,12                     SAVE REGISTER 12           @L1A 28450000
         LR    1,13                     SAVE REGISTER 13           @L1A 28500000
.*                                                                      28550000
.CONDIN4 ANOP                                                      @L1A 28600000
         AIF   ('&ASCB' EQ '(11)').CONDIN4A BRANCH IF ASCB IN R11  @P1A 28650000
.*                                                                      28700000
         L     11,&ASCB                 LOAD ASCB ADDRESS          @L1A 28750000
.*                                                                      28800000
.CONDIN4A ANOP                                                     @P1A 28850000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @P1A 28900000
         L     13,1416(14,0)            LOCK ROUTINE ENTRY POINT   @L2C 28950000
.*                                                                      29000000
         AGO   .MNLCOD2                                            @L1A 29050000
.*                                                                      29100000
.CONDIN5 ANOP                                                      @L1A 29150000
.*       IHB280 LOCK INVALID WITH OBTAIN                           @L1A 29200000
         IHBERMAC 1020,LOCK,&REQUEST                               @L1A 29250000
         MEXIT                                                     @L1A 29300000
.*                                                                      29350000
.CONDIN6 ANOP                                                      @L1A 29400000
.*       IHB280 LOCKHLD INVALID WITH OBTAIN                        @L1A 29450000
         IHBERMAC 1020,LOCKHLD,&REQUEST                            @L1A 29500000
         MEXIT                                                     @L1A 29550000
.*                                                                      29600000
.CONDIN7 ANOP                                                      @L1A 29650000
.*       IHB280 MODE=(COND,IN) INVALID WITH TYPE=&TYPE             @L1A 29700000
&MESSAGE SETC 'MODE=(COND,IN)'                                     @L1A 29750000
&MESSAG2 SETC 'TYPE='.'&TYPE'                                      @L1A 29800000
         IHBERMAC 1020,&MESSAGE,&MESSAG2                           @L1A 29850000
         MEXIT                                                     @L1A 29900000
.************************************************************* @G860PXA 29950000
.*           BEGINNING OF RELEASE TYPE=REG PROCESSING          @G860PXA 30000000
.************************************************************* @G860PXA 30050000
.RREG    ANOP                                                           30100000
&INDEX   SETA  1332                    RELEASE REG ENABLED     @G860PXA 30150000
         AGO   .RELCOMM                COMMON PROCESSING       @G860PXA 30200000
.************************************************************* @G860PXA 30250000
.*         BEGINNING OF RELEASE ALL PROCESSING                 @G860PXA 30300000
.************************************************************* @G860PXA 30350000
.RALL    ANOP                                                           30400000
&INDEX   SETA  1308                    RELEASE ALL ENABLED     @G860PXA 30450000
.************************************************************* @G860PXA 30500000
.*  BEGINNING OF RELEASE ALL OR REG COMMON PROCESSING        * @G860PXA 30550000
.************************************************************* @G860PXA 30600000
.RELCOMM AIF   (T'&ASCB NE 'O').RALLASI                        @G860PXA 30650000
         AIF   (T'&LOCKHLD EQ 'O').RALLOK                      @G387PXR 30700000
.RLKHLD  ANOP                                                  @G860PXA 30750000
.*       IHB280 LOCKHLD INVALID WITH TYPE=ALL|REG              @G860PXA 30800000
&MESSAGE SETC 'TYPE='.'&TYPE'                                  @G387PXR 30850000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                        @G387PXR 30900000
         MEXIT                                                 @G387PXR 30950000
.RALLASI ANOP                                                  @G387PXR 31000000
.*       IHB280 ASCB INVALID WITH TYPE=ALL|REG                 @G860PXA 31050000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G387PXR 31100000
         IHBERMAC 1020,ASCB,&MESSAGE                           @G387PXR 31150000
         MEXIT                                                 @G387PXR 31200000
.RALLOK  ANOP                                                  @G387PXR 31250000
.************************************************************* @G860PXA 31300000
         AIF   (T'&DISABLE EQ 'O').RALL1                       @G860PXA 31350000
         AIF   ('&DISABLE' NE 'DISABLED').INVLDIS              @G860PXA 31400000
&INDEX   SETA  (&INDEX+12)             INCREMENT TO RELEASE    @G860PXA 31450000
.*                                     DISABLED ENTRY          @G860PXA 31500000
.RALL1   AIF   ('&NAME' EQ '').RALLNN                          @G860PXA 31550000
&NAME    DC    0H'0'                                                    31600000
.RALLNN  AIF   (T'&REGS EQ 'O').RALL4                          @G860PXA 31650000
         AIF   ('&REGS' EQ 'SAVE').RALL3                       @G860PXA 31700000
         LR    15,11              SAVE REG11                   @G860PXA 31750000
         LR    0,12               SAVE REG12                            31800000
         LR    1,13               SAVE REG13                            31850000
         AGO   .RALL4                                          @G860PXA 31900000
.RALL3   LR    15,13              SAVE AREA ADDRESS            @G860PXA 31950000
         STM   11,14,0(13)        SAVE REGS 11 THRU 14             @L2C 32000000
.RALL4   L     14,PSALITA-FLC(0,0) ADDR OF LOCK INTERFACE TAB      @L2C 32050000
         AIF   ('&SYSASCE' EQ 'P').NOAR33                          @L2A 32100000
         LAE   14,0(14,0)               GET ALET OF 0              @L2A 32150000
.NOAR33  ANOP                                                           32200000
         AIF   ('&TYPE' EQ 'ALL').RALL5                        @G860PXA 32250000
         AIF   ('&TYPE' EQ '(11)').RALL50                      @ZMC0388 32300000
         LR    11,&TYPE(1)        PUT STRING IN PROPER REG     @G860PXA 32350000
.RALL50  ANOP                                                  @ZMC0388 32400000
&INDEX   SETA  (&INDEX+4)         INCREMENT TO SECOND WORD OF  @G860PXA 32450000
.*                                PARM LIST.                   @G860PXA 32500000
         LM    12,13,&INDEX.(14)  OBTAIN PARM & EP ADDRESS         @L2C 32550000
         AGO   .RALL6                                          @G860PXA 32600000
.RALL5   LM    11,13,&INDEX.(14)  OBTAIN PARM & EP ADDRESS         @L2C 32650000
.RALL6   ANOP                                                           32700000
         AIF   ('&SYSASCE' EQ 'P').NOAR38                          @L2A 32750000
         SAC   0                        PRIMARY MODE               @L2A 32800000
.NOAR38  ANOP                                                           32850000
         BALR  14,13              LINK TO LOCK ROUTINE         @G387PXR 32900000
         AIF   ('&SYSASCE' EQ 'P').NOAR39                          @L2A 32950000
         SAC   X'200'                   AR MODE                    @L2A 33000000
.NOAR39  ANOP                                                           33050000
         AIF   (T'&REGS EQ 'O').RALL9                          @G860PXA 33100000
         AIF   ('&REGS' EQ 'SAVE').LMEXIT                          @L2C 33150000
.RALL7   LR    11,15              RESTORE REG11                @G860PXA 33200000
         LR    15,13              PUT RETURN CODE IN REGISTER  @ZMC0683 33250000
*                                 15                           @ZMC0683 33300000
         LR    12,0               RESTORE REG12                @G860PXA 33350000
         LR    13,1               RESTORE REG13                @G860PXA 33400000
.RALL9   MEXIT                                                 @G860PXA 33450000
.************************************************************* @G860PXA 33500000
.*           BEGINNING OF RELEASE TYPE=SPIN PROCESSING         @G860PXA 33550000
.************************************************************* @G860PXA 33600000
.RSPIN   ANOP                                                           33650000
         AIF   ('&NAME' EQ '').RSPINNN                                  33700000
&NAME    DC    0H'0'                                                    33750000
.RSPINNN AIF   (T'&REGS EQ 'O').RSPINC                                  33800000
         AIF   ('&REGS' EQ 'SAVE').RSPINS                               33850000
         LR    15,11              SAVE REG11                            33900000
         LR    0,12               SAVE REG12                            33950000
         LR    1,13               SAVE REG13                            34000000
         AGO   .RSPINC                                                  34050000
.RSPINS  ANOP                                                           34100000
         LR    15,13              SAVE AREA ADDRESS                     34150000
         STM   11,14,0(13)        SAVE REGS 11 THRU 14             @L2C 34200000
.RSPINC  ANOP                                                           34250000
         AIF   (T'&DISABLE EQ 'O').RSPINE                      @ZMC0587 34300000
         AIF   ('&DISABLE' NE 'DISABLED').INVLDIS              @ZMC0587 34350000
         MVI   PSAMPSW-PSA(0),X'00' INDICATE RETURN DISABLED   @ZMC0587 34400000
         AGO   .RSPINR                                         @ZMC0587 34450000
.RSPINE  ANOP                                                  @ZMC0587 34500000
         MVI   PSAMPSW-PSA(0),X'03' INDICATE RETURN ENABLED    @ZMC0587 34550000
.RSPINR  ANOP                                                  @ZMC0587 34600000
         L     14,PSALITA-FLC(0,0)      LOCK INTERFACE TABLE ADDR  @L2C 34650000
         AIF   ('&SYSASCE' EQ 'P').NOAR34                          @L2A 34700000
         L     12,&INDEX.+4(14,0)       OBTAIN PARM POINTER        @L2A 34750000
         L     13,&INDEX.+8(14,0)       OBTAIN ENTRY POINT         @L2A 34800000
         SAC   0                        PRIMARY MODE               @L2A 34850000
         AGO   .AR34                                               @L2A 34900000
.NOAR34  ANOP                                                           34950000
         LM    12,13,&INDEX.+4(14)  OBTAIN PARM & EP ADDRESS       @L2C 35000000
.AR34    BALR  14,13              LINK TO LOCK MANAGER                  35050000
         AIF   ('&SYSASCE' EQ 'P').NOAR41                          @L2A 35100000
         SAC   X'200'                   AR MODE                    @L2A 35150000
.NOAR41  ANOP                                                           35200000
         AIF   (T'&REGS EQ 'O').RSPINX                                  35250000
         AIF   ('&REGS' EQ 'USE').RSPINU                                35300000
         AGO   .LMEXIT            SAVE RETURN CODE, RESTORE REGS   @L2C 35350000
.RSPINX  MEXIT                                                          35400000
.RSPINU  ANOP                                                           35450000
         LR    11,15              RESTORE REG11                         35500000
         LR    15,13              PUT RETURN CODE IN REGISTER  @ZMC0683 35550000
*                                 15                           @ZMC0683 35600000
         LR    12,0               RESTORE REG12                         35650000
         LR    13,1               RESTORE REG13                         35700000
         MEXIT                                                          35750000
.************************************************************* @G860PXA 35800000
.* BEGINNING OF TEST SUPPORT                                   @G860PXA 35850000
.************************************************************* @G860PXA 35900000
.TEST    ANOP                                                           35950000
         AIF   (T'&TYPE EQ 'O').TERR002                        @G860PXA 36000000
         AIF   (T'&MODE EQ 'O').TSTDIS                                  36050000
.*       IHB280 MODE INVALID WITH TEST                                  36100000
         IHBERMAC 1020,MODE,TEST                                        36150000
         MEXIT                                                          36200000
.TSTDIS  AIF   (T'&DISABLE EQ 'O').TSTHIER                     @G860PXA 36250000
.*       IHB280 DISABLED INVALID WITH TEST                              36300000
         IHBERMAC 1020,&DISABLE,TEST                           @G860PXA 36350000
         MEXIT                                                          36400000
.TSTHIER AIF   ('&TYPE' NE 'HIER').TSTADR                      @G860PXA 36450000
.************************************************************* @G860PXA 36500000
.* BEGINNING OF TEST,TYPE=HIER PROCESSING                      @G860PXA 36550000
.************************************************************* @G860PXA 36600000
         AIF   (T'&ADDR NE 'O').TERR001                        @G860PXA 36650000
         AIF   (T'&ASCB NE 'O').TERR003                        @G860PXA 36700000
         AIF   (T'&LOCKHLD NE 'O').TERR005                     @G860PXA 36750000
         AIF   (T'&SCOPE NE 'O').TERR004                       @G860PXA 36800000
         AIF   (T'&LOCK EQ 'O').TERR007                        @G860PXA 36850000
         AIF   ('&LOCK' EQ 'DISP').HIER02                      @G860PXA 36900000
&INDEX   SETA  16                                              @G860PXA 36950000
         AIF   ('&LOCK' EQ 'IOSUCB').HIER02                    @G860PXA 37000000
&INDEX   SETA  32                                              @G860PXA 37050000
         AIF   ('&LOCK' EQ 'IOSYNCH').HIER02                   @G860PXA 37100000
&INDEX   SETA  48                                              @G860PXA 37150000
         AIF   ('&LOCK' EQ 'TPNCB').HIER02                     @G860PXA 37200000
&INDEX   SETA  64                                              @G860PXA 37250000
         AIF   ('&LOCK' EQ 'TPDNCB').HIER02                    @G860PXA 37300000
&INDEX   SETA  80                                              @G860PXA 37350000
         AIF   ('&LOCK' EQ 'TPACBDEB').HIER02                  @G860PXA 37400000
&INDEX   SETA  96                                              @G860PXA 37450000
         AIF   ('&LOCK' EQ 'ASM').HIER02                       @G860PXA 37500000
&INDEX   SETA  112                                             @G860PXA 37550000
         AIF   ('&LOCK' EQ 'SALLOC').HIER02                    @G860PXA 37600000
&INDEX   SETA  128                                             @G860PXA 37650000
         AIF   ('&LOCK' EQ 'SRM').HIER02                       @G860PXA 37700000
&INDEX   SETA  192                                             @G860PXA 37750000
         AIF   ('&LOCK' EQ 'TRACE').HIER02                     @G860PXA 37800000
&INDEX   SETA  208                                             @G860PXA 37850000
         AIF   ('&LOCK' EQ 'VSMPAG').HIER02                    @G860PXA 37900000
&INDEX   SETA  224                                             @G860PXA 37950000
         AIF   ('&LOCK' EQ 'RSM').HIER02                       @G860PXA 38000000
&INDEX   SETA  240                                             @G860PXA 38050000
         AIF   ('&LOCK' EQ 'RSMAD').HIER02                     @G860PXA 38100000
&INDEX   SETA  256                                             @G860PXA 38150000
         AIF   ('&LOCK' EQ 'RSMXM').HIER02                     @G860PXA 38200000
&INDEX   SETA  272                                             @G860PXA 38250000
         AIF   ('&LOCK' EQ 'RSMST').HIER02                     @G860PXA 38300000
&INDEX   SETA  288                                             @G860PXA 38350000
         AIF   ('&LOCK' EQ 'ASMGL').HIER02                     @G860PXA 38400000
&INDEX   SETA  304                                             @G860PXA 38450000
         AIF   ('&LOCK' EQ 'VSMFIX').HIER02                    @G860PXA 38500000
&INDEX   SETA  320                                             @G860PXA 38550000
         AIF   ('&LOCK' EQ 'RSMGL').HIER02                     @G860PXA 38600000
&INDEX   SETA  352                                             @G860PXA 38650000
         AIF   ('&LOCK' EQ 'RSMCM').HIER02                         @L3C 38700000
&INDEX   SETA  368                                                 @L3A 38750000
         AIF   ('&LOCK' EQ 'RSMDS').HIER02                         @D1C 38800000
&INDEX   SETA  384                                                 @D1A 38850000
         AIF   ('&LOCK' NE 'IOS').TERR008                          @D1A 38900000
.HIER02  ANOP                                                  @G860PXA 38950000
         AIF   (T'&REGS EQ 'O').HIER04                         @G860PXA 39000000
         AIF   ('&REGS'(1,1) NE '(').TSTBREG                   @G860PXA 39050000
         AIF   ('&REGS'(K'&REGS,1) NE ')').TSTBREG             @G860PXA 39100000
         AIF   (N'&REGS NE 2).TSTBREG                          @G860PXA 39150000
&REG1    SETC  '&REGS(1)'                                      @G860PXA 39200000
&REG2    SETC  '&REGS(2)'                                      @G860PXA 39250000
         AGO   .HIER06                                         @G860PXA 39300000
.HIER04  ANOP                                                  @G860PXA 39350000
&REG1    SETC  '11'                                            @G860PXA 39400000
&REG2    SETC  '12'                                            @G860PXA 39450000
.HIER06  ANOP                                                  @G860PXA 39500000
         AIF   (T'&BRANCH EQ 'O').HIER08                       @G860PXA 39550000
         AIF   (N'&BRANCH NE 2).TINVBR                         @G860PXA 39600000
         AIF   ('&BRANCH(1)' EQ 'HELD').HIER08                 @G860PXA 39650000
         AIF   ('&BRANCH(1)' NE 'NOTHELD').INVCOND             @G860PXA 39700000
.HIER08  ANOP                                                  @G860PXA 39750000
&NAME    DC    0H'0'                                           @G860PXA 39800000
         AIF   (T'&BRANCH NE 'O').HIER10                       @G860PXA 39850000
         SLR   15,15                    PRESET NO HIERARCHY    @G860PXA 39900000
*                                       VIOLATION RETURN CODE  @G860PXA 39950000
.HIER10  L     &REG1,PSALKPT-FLC(0,0)   OBTAIN PARM TABLE ADDR @G860PXA 40000000
         L     &REG2,&INDEX.+4(&REG1,0) LOCK OBTAIN MASK           @L2C 40050000
         X     &REG2,&INDEX.+8(&REG1,0) FORM HIERARCHY MASK        @L2C 40100000
         N     &REG2,PSACLHS-FLC(0,0)   HIGHER LOCKS HELD?     @G860PXA 40150000
         AIF   (T'&BRANCH EQ 'O').HIER14                       @G860PXA 40200000
         AIF   ('&BRANCH(1)' EQ 'HELD').HIER12                 @G860PXA 40250000
         BZ    &BRANCH(2)               BRANCH IF NO HIGHER    @G860PXA 40300000
*                                       LOCKS HELD             @G860PXA 40350000
         MEXIT                                                 @G860PXA 40400000
.HIER12  ANOP                                                  @G860PXA 40450000
         BNZ   &BRANCH(2)               BRANCH IF HIGHER LOCKS @G860PXA 40500000
*                                       HELD                   @G860PXA 40550000
         MEXIT                                                 @G860PXA 40600000
.HIER14  ANOP                                                  @G860PXA 40650000
         BZ    *+8                      BRANCH IF HIGHER LOCKS @G860PXA 40700000
*                                       NOT HELD               @G860PXA 40750000
         LA    15,4(0,0)                SET HIGHER LOCKS HELD  @G860PXA 40800000
*                                       RETURN CODE            @G860PXA 40850000
         MEXIT                                                 @G860PXA 40900000
.************************************************************* @G860PXA 40950000
.* END OF TEST,TYPE=HIER PROCESSING                            @G860PXA 41000000
.************************************************************* @G860PXA 41050000
.TSTADR  AIF   (T'&LOCK NE 'O').TINVLO                             @P2C 41100000
         AIF   (T'&ADDR EQ 'O').TSTREG                             @P2C 41150000
         AIF   ('&ADDR'(1,1) NE '(').TSTBADR                            41200000
         AIF   ('&ADDR'(K'&ADDR,1) EQ ')').TSTREG                       41250000
.*       IHB002  INVALID ADDR OPERAND SPECIFIED- XXX                    41300000
.TSTBADR IHBERMAC 1001,ADDR,&ADDR                                       41350000
         MEXIT                                                          41400000
.TSTREG  AIF   (T'&REGS EQ 'O').TSTBR                                   41450000
         AIF   ('&REGS'(1,1) NE '(').TSTBREG                            41500000
         AIF   ('&REGS'(K'&REGS,1) EQ ')').TSTBR                        41550000
.*       IHB002  INVALID REGS OPERAND SPECIFIED- XXX                    41600000
.TSTBREG IHBERMAC 1001,REGS,&REGS                                       41650000
         MEXIT                                                          41700000
.TSTBR   AIF   (T'&BRANCH EQ 'O').TSTTYPE                               41750000
         AIF   (N'&BRANCH EQ 2).TSTCOND                                 41800000
.*       IHB247 INCORRECT NUMBER OF BRANCH VALUES                       41850000
.TINVBR  IHBERMAC 1012,BRANCH                                           41900000
         MEXIT                                                          41950000
.TSTCOND ANOP                                                           42000000
         AIF   ('&BRANCH(1)' EQ 'HELD').TSTTYPE                         42050000
         AIF   ('&BRANCH(1)' EQ 'NOTHELD').TSTTYPE                      42100000
.INVCOND ANOP                                                           42150000
.*       IHB002 INVALID BRANCH OPERAND SPECIFIED- XXX                   42200000
         IHBERMAC 1001,BRANCH,&BRANCH(1)                                42250000
         MEXIT                                                          42300000
.TINVLO  ANOP                                                      @P2A 42350000
&MESSAGE SETC  'TYPE='.'&TYPE'                                     @P2A 42400000
.*       IHB280 LOCK INVALID WITH TYPE=TYPE                        @P2A 42450000
         IHBERMAC 1020,LOCK,&MESSAGE                               @P2A 42500000
         MEXIT                                                     @P2A 42550000
.TSTTYPE ANOP                                                           42600000
&BYTE    SETA  0                   CLHS BYTE ZERO SELECTED     @G860PXA 42650000
&OFSET   SETA  96                  CLHT ENTRY FOR CPU LOCK     @G860PXA 42700000
&MASK    SETA  128                 CLHS POSITION FOR CPU LOCK  @G860PXA 42750000
         AIF   ('&TYPE' EQ 'CPU').TNAMSYS                      @G860PXA 42800000
.*                                                             @G860PXA 42850000
&OFSET   SETA  80                  CLHT ENTRY FOR RSM          @G860PXA 42900000
&MASK    SETA  8                   CLHS POSITION FOR RSM       @G860PXA 42950000
         AIF   ('&TYPE' EQ 'RSM').TNAMSYS                      @G860PXA 43000000
.*                                                             @G860PXA 43050000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR TRACE        @G860PXA 43100000
&MASK    SETA  &MASK/2             CLHS POSITION FOR TRACE     @G860PXA 43150000
         AIF   ('&TYPE' EQ 'TRACE').TNAMSYS                    @G860PXA 43200000
.*                                                                 @D1A 43250000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR IOS              @D1A 43300000
&MASK    SETA  &MASK/2             CLHS POSITION FOR IOS           @D1A 43350000
         AIF   ('&TYPE' EQ 'IOS').TNAMSYS                          @D1A 43400000
.*                                                             @G860PXA 43450000
&BYTE    SETA  1                   CLHS BYTE ONE SELECTED      @G860PXA 43500000
&OFSET   SETA  72                  CLHT ENTRY FOR RSMCM        @G860PXJ 43550000
&MASK    SETA  16                  CLHS POSITION FOR RSMCM     @G860PXJ 43600000
         AIF   ('&TYPE' EQ 'RSMCM').TNAMC                      @G860PXJ 43650000
.*                                                             @G860PXA 43700000
&OFSET   SETA  44                  CLHT ENTRY FOR RSMGL        @ZMC0568 43750000
&MASK    SETA  &MASK/2             CLHS POSITION FOR RSMGL     @G860PXJ 43800000
         AIF   ('&TYPE' EQ 'RSMGL').TNAMC                      @G860PXA 43850000
.*                                                             @G860PXA 43900000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR VSMFIX       @G860PXA 43950000
&MASK    SETA  &MASK/2             CLHS POSITION FOR VSMFIX    @G860PXA 44000000
         AIF   ('&TYPE' EQ 'VSMFIX').TNAMSYS                   @G860PXA 44050000
.*                                                             @G860PXA 44100000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR ASMGL        @G860PXA 44150000
&MASK    SETA  &MASK/2             CLHS POSITION FOR ASMGL     @G860PXA 44200000
         AIF   ('&TYPE' EQ 'ASMGL').TNAMC                      @G860PXA 44250000
.*                                                             @G860PXA 44300000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR RSMST        @G860PXA 44350000
&MASK    SETA  &MASK/2             CLHS POSITION FOR RSMST     @G860PXA 44400000
         AIF   ('&TYPE' EQ 'RSMST').TNAMC                      @G860PXA 44450000
.*                                                             @G860PXA 44500000
&BYTE    SETA  2                   CLHS BYTE 2 SELECTED        @G860PXA 44550000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR RSMXM        @G860PXA 44600000
&MASK    SETA  128                 CLHS POSITION FOR RSMXM     @G860PXA 44650000
         AIF   ('&TYPE' EQ 'RSMXM').TNAMC                      @G860PXA 44700000
.*                                                             @G860PXA 44750000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR RSMAD        @G860PXA 44800000
&MASK    SETA  &MASK/2             CLHS POSITION FOR RSMAD     @G860PXA 44850000
         AIF   ('&TYPE' EQ 'RSMAD').TNAMC                      @G860PXA 44900000
.*                                                             @G860PXA 44950000
&OFSET   SETA  &OFSET+4            CLHT ENTRY FOR VSMPAG       @G860PXA 45000000
&MASK    SETA  &MASK/2             CLHS POSITION FOR VSMPAG    @G860PXA 45050000
         AIF   ('&TYPE' EQ 'VSMPAG').TNAMSYS                   @G860PXA 45100000
.*                                                             @G860PXA 45150000
&OFSET   SETA  0                   CLHT ENTRY FOR DISP         @G860PXA 45200000
&MASK    SETA  &MASK/2             CLHS POSITION FOR DISP      @G860PXA 45250000
         AIF   ('&TYPE' EQ 'DISP').TNAMSYS                              45300000
&OFSET   SETA  &OFSET+4                                                 45350000
&MASK    SETA  &MASK/2                                                  45400000
         AIF   ('&TYPE' EQ 'ASM').TNAMC                                 45450000
&OFSET   SETA  &OFSET+4                                                 45500000
&MASK    SETA  &MASK/2                                                  45550000
         AIF   ('&TYPE' EQ 'SALLOC').TNAMSYS                            45600000
&OFSET   SETA  &OFSET+4                                                 45650000
&MASK    SETA  &MASK/2                                                  45700000
         AIF   ('&TYPE' EQ 'IOSYNCH').TNAMC                             45750000
&OFSET   SETA  &OFSET+4                                                 45800000
&MASK    SETA  &MASK/2                                                  45850000
         AIF   ('&TYPE' EQ 'IOSCAT').TTYPINV                   @G860PXB 45900000
         AIF   ('&TYPE' EQ 'RSMDS').TNAMC                          @L3A 45950000
&BYTE    SETA  3                                                        46000000
&OFSET   SETA  &OFSET+4                                                 46050000
&MASK    SETA  128                                                      46100000
         AIF   ('&TYPE' EQ 'IOSUCB').TNAMC                              46150000
&OFSET   SETA  &OFSET+4                                                 46200000
&MASK    SETA  &MASK/2                                                  46250000
         AIF   ('&TYPE' EQ 'IOSLCH').TTYPINV                   @G860PXB 46300000
&OFSET   SETA  &OFSET+4                                                 46350000
&MASK    SETA  &MASK/2                                                  46400000
         AIF   ('&TYPE' EQ 'TPNCB').TNAMC                               46450000
&OFSET   SETA  &OFSET+4                                                 46500000
&MASK    SETA  &MASK/2                                                  46550000
         AIF   ('&TYPE' EQ 'TPDNCB').TNAMC                              46600000
&OFSET   SETA  &OFSET+4                                                 46650000
&MASK    SETA  &MASK/2                                                  46700000
         AIF   ('&TYPE' EQ 'TPACBDEB').TNAMC                            46750000
&OFSET   SETA  &OFSET+4                                                 46800000
&MASK    SETA  &MASK/2                                                  46850000
         AIF   ('&TYPE' EQ 'SRM').TNAMSYS                               46900000
&OFSET   SETA  &OFSET+4                                                 46950000
&MASK    SETA  &MASK/2                                                  47000000
         AIF   ('&TYPE' EQ 'CMS').TNAMSYS                               47050000
&OFSET   SETA  &OFSET+4                                                 47100000
&MASK    SETA  &MASK/2                                                  47150000
         AIF   ('&TYPE' EQ 'LOCAL').TNAMSYS                             47200000
         AIF   ('&TYPE' EQ 'CML').TNAMSYS                      @G387PXR 47250000
         AIF   ('&TYPE' EQ 'ALOCAL').TNAMSYS                   @G387PXR 47300000
         AIF   (T'&ADDR NE 'O').TERR001                        @G860PXA 47350000
         AIF   ('&TYPE' EQ 'ALL').TALLC                        @G860PXA 47400000
         AIF   ('&TYPE' EQ 'SPIN').TALLC                                47450000
.TREG    ANOP                                                           47500000
         AIF   ('&TYPE'(1,1) NE '(').TTYPINV                            47550000
         AIF   ('&TYPE'(K'&TYPE,1) EQ ')').TREGC                        47600000
.*       IHB002 INVALID TYPE OPERAND SPECIFIED- XXX                     47650000
.TTYPINV IHBERMAC 1001,TYPE,&TYPE                                       47700000
         MEXIT                                                          47750000
.TNAMSYS ANOP                                                           47800000
         AIF   (T'&ADDR NE 'O').TERR001                        @G860PXA 47850000
         AIF (NOT('&TYPE' EQ 'TRACE' OR '&TYPE' EQ 'RSM' OR '&TYPE' EQ +47900000
                'IOS')).TNAMC                                      @D1C 47950000
         AIF   (T'&SCOPE EQ 'O').TNAMC0                        @G860PXA 48000000
         AIF  ('&SCOPE' EQ 'SHR' OR '&SCOPE' EQ 'EXCL').TNAMC0 @G860PXA 48050000
.*       IHB002 INVALID SCOPE OPERAND SPECIFIED-XXXX           @G860PXA 48100000
         IHBERMAC 1001,SCOPE,&SCOPE                            @G860PXA 48150000
         MEXIT                                                 @G860PXA 48200000
.TNAMC   ANOP                                                           48250000
         AIF   (T'&SCOPE NE 'O').TERR004                       @G860PXA 48300000
.TNAMC0  AIF   ('&TYPE' EQ 'CML').TNAMCA                       @G860PXA 48350000
         AIF   ('&TYPE' EQ 'ALOCAL' OR '&TYPE' EQ 'CPU').TALOC @G860PXK 48400000
         AIF   (T'&ASCB NE 'O').TERR003                        @G860PXA 48450000
         AIF   (T'&LOCKHLD NE 'O').TERR005                     @G860PXA 48500000
.TNAMCA  AIF   (T'&REGS NE 'O').TERR006                        @G860PXA 48550000
.TNAMC1  ANOP                                                           48600000
         AIF   ('&NAME' EQ '').TNAMNN                                   48650000
&NAME    DC    0H'0'                                                    48700000
.TNAMNN  AIF   ('&TYPE' EQ 'CML').TCMLCK                       @G387PXR 48750000
         AIF   (T'&BRANCH NE 'O').TNAMCB                                48800000
         SR    15,15                    PRESET LOCK HELD RETURN CODE    48850000
.TNAMCB  AIF   (T'&ADDR EQ 'O').TSCOPE3                        @G860PXA 48900000
         C     &ADDR(1),PSACLHT-PSA+&OFSET.(0,0) CHECK LKWD ADDR        48950000
*                                       IN CLHT                @ZA35343 49000000
         AIF   (T'&BRANCH EQ 'O').TNAMARC                               49050000
         AIF   ('&BRANCH(1)' EQ 'HELD').TNAMABH                         49100000
         BNE   &BRANCH(2)               BRANCH NOT HELD                 49150000
         MEXIT                                                          49200000
.TNAMABH BE    &BRANCH(2)               BRANCH HELD                     49250000
         MEXIT                                                          49300000
.TNAMARC BE    *+8                      BRANCH HELD                     49350000
         LA    15,4(0,0)                SET R. C. LOCK NOT HELD         49400000
         MEXIT                                                          49450000
.TSCOPE3 AIF   (T'&SCOPE EQ 'O').TNAMTM                        @G860PXA 49500000
         AIF   ('&SCOPE' EQ 'EXCL').TEXCL                      @G860PXA 49550000
.*********** PROCESS SCOPE=SHR REQUEST *********************** @G860PXA 49600000
         TM    PSACLHT-PSA+&OFSET.(0),X'80' IS LOCK HELD EXCL? @G860PXA 49650000
         AIF   (T'&BRANCH EQ 'O').TSCOPE4                      @G860PXA 49700000
         AIF   ('&BRANCH(1)' NE 'HELD').TSCOPE5                @G860PXA 49750000
.TSCOPE4 BO    &LABEL.G                 BRANCH IF HELD EXCL    @G860PXA 49800000
         AGO   .TNAMTM                                         @G860PXA 49850000
.TSCOPE5 BO    &BRANCH(2)               BRANCH IF HELD EXCL    @G860PXA 49900000
         AGO   .TNAMTM                                         @G860PXA 49950000
.TEXCL   TM    PSACLHT-PSA+&OFSET.(0),X'80' IS LOCK HELD EXCL? @G860PXA 50000000
         AIF   (T'&BRANCH EQ 'O').TNAMTRC                      @G860PXA 50050000
         AIF   ('&BRANCH(1)' EQ 'NOTHELD').TSCOPE6             @G860PXA 50100000
         BO    &BRANCH(2)               BRANCH IF HELD EXCL    @G860PXA 50150000
         MEXIT                                                 @G860PXA 50200000
.TNAMTM  TM    PSAHLHI-PSA+&BYTE.(0),&MASK TEST BIT IN CURRENT @G860PXA 50250000
*                                       LOCK HELD STRING       @G860PXA 50300000
         AIF   ('&TYPE' EQ 'LOCAL').TLOCAL                     @G387PXR 50350000
         AIF   (T'&BRANCH EQ 'O').TNAMTRC                               50400000
         AIF   ('&BRANCH(1)' EQ 'HELD').TNAMTBH                         50450000
.TSCOPE6 BZ    &BRANCH(2)               BRANCH NOT HELD        @G860PXA 50500000
         MEXIT                                                          50550000
.TNAMTBH BO    &BRANCH(2)               BRANCH HELD                     50600000
         AIF   (T'&SCOPE EQ 'O').TSCOPE7                       @G860PXA 50650000
         AIF   ('&SCOPE' NE 'SHR').TSCOPE7                     @G860PXA 50700000
&LABEL.G DC 0H'0'                       BRANCH LABEL           @G860PXA 50750000
.TSCOPE7 ANOP                                                  @G860PXA 50800000
         MEXIT                                                          50850000
.TNAMTRC BO    *+8                      BRANCH HELD                     50900000
         AIF   (T'&SCOPE EQ 'O').TSCOPE8                       @G860PXA 50950000
         AIF   ('&SCOPE' NE 'SHR').TSCOPE8                     @G860PXA 51000000
&LABEL.G DC 0H'0'                       BRANCH LABEL           @G860PXA 51050000
.TSCOPE8 LA    15,4(0,0)                SET R. C. LOCK NOT HELD@G860PXA 51100000
         MEXIT                                                          51150000
.TERR001 ANOP                                                  @G860PXA 51200000
.*       IHB280 ADDR INVALID WITH TYPE=ALL|REG|HIER            @G860PXA 51250000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G860PXA 51300000
         IHBERMAC 1020,ADDR,&MESSAGE                           @G860PXA 51350000
         MEXIT                                                 @G860PXA 51400000
.*       IHB001 TYPE OPERAND REQUIRED NOT SPECIFIED            @G860PXA 51450000
.TERR002 IHBERMAC 1006,TYPE                                    @G860PXA 51500000
         MEXIT                                                 @G860PXA 51550000
.TERR003 ANOP                                                  @G387PXR 51600000
.*       IHB280 ASCB INVALID WITH TYPE=XXX                     @G387PXR 51650000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G387PXR 51700000
         IHBERMAC 1020,ASCB,&MESSAGE                           @G387PXR 51750000
         MEXIT                                                 @G387PXR 51800000
.TERR004 ANOP                                                  @G860PXA 51850000
.*       IHB280 SCOPE INVALID WITH TYPE=XXX                    @G860PXA 51900000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G860PXA 51950000
         IHBERMAC 1020,SCOPE,&MESSAGE                          @G860PXA 52000000
         MEXIT                                                 @G860PXA 52050000
.TERR005 ANOP                                                  @G860PXA 52100000
.*       IHB280 LOCKHLD INVALID WITH TYPE=XXX                  @G387PXR 52150000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G387PXR 52200000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                        @G387PXR 52250000
         MEXIT                                                 @G387PXR 52300000
.TERR006 ANOP                                                  @G860PXA 52350000
.*       IHB280 REGS INVALID WITH TYPE=NAME                    @G860PXA 52400000
&MESSAGE SETC 'TYPE='.'&TYPE'                                  @G860PXA 52450000
         IHBERMAC 1020,REGS,&MESSAGE                           @G860PXA 52500000
         MEXIT                                                 @G860PXA 52550000
.TERR007 ANOP                                                  @G860PXA 52600000
.*       IHB001 LOCK OPERAND REQUIRED NOT SPECIFIED            @G860PXA 52650000
         IHBERMAC 1006,LOCK                                    @G860PXA 52700000
         MEXIT                                                 @G860PXA 52750000
.TERR008 ANOP                                                  @G860PXA 52800000
.*       IHB002 INVALID LOCK OPERAND SPECIFIED                 @G860PXA 52850000
         IHBERMAC 1001,LOCK,&LOCK                              @G860PXA 52900000
         MEXIT                                                 @G860PXA 52950000
.************************************************************* @G860PXA 53000000
.*  BEGINNING OF TEST,TYPE=LOCAL LOCK PROCESSING               @G860PXA 53050000
.************************************************************* @G860PXA 53100000
.TLOCAL  ANOP                                                  @G387PXR 53150000
         AIF   (T'&BRANCH EQ 'O').TLOCRC                       @G387PXR 53200000
         AIF   ('&BRANCH(1)' EQ 'HELD').TLOCBH                 @G387PXR 53250000
         BZ    &BRANCH(2)               BRANCH NOT HELD        @G387PXR 53300000
         AGO   .TLOCCL                                         @G387PXR 53350000
.TLOCRC  ANOP                                                  @G387PXR 53400000
         BZ    &LABEL.A                 BRANCH NOT HELD        @G387PXR 53450000
         AGO   .TLOCCL                                         @G387PXR 53500000
.TLOCBH  BZ    &LABEL.B                 BRANCH NOT HELD        @G387PXR 53550000
.TLOCCL  ANOP                                                  @G387PXR 53600000
         CLC   PSALOCAL-FLC(4,0),PSAFZERO-FLC(0) LOCAL HELD?   @ZMP0008 53650000
         AIF   (T'&BRANCH EQ 'O').TLOCRC1                      @G387PXR 53700000
         AIF   ('&BRANCH(1)' EQ 'HELD').TLOCBH1                @G387PXR 53750000
         BNE   &BRANCH(2)               BRANCH LOCK NOT HELD   @ZMP0008 53800000
         MEXIT                                                 @G387PXR 53850000
.TLOCRC1 ANOP                                                  @G387PXR 53900000
         BE    *+8                      BRANCH LOCK HELD       @ZMP0008 53950000
&LABEL.A LA    15,4(0,0)                SET R.C.=4 NOT HELD    @G387PXR 54000000
         MEXIT                                                 @G387PXR 54050000
.TLOCBH1 ANOP                                                  @G387PXR 54100000
         BE    &BRANCH(2)               BRANCH LOCK HELD       @ZMP0008 54150000
&LABEL.B DC    0H'0'                    BRANCH LABEL           @G387PXR 54200000
         MEXIT                                                 @G387PXR 54250000
.*                                                             @G860PXA 54300000
.************************************************************* @G860PXA 54350000
.*    BEGINNING OF TEST,TYPE=ALL OR SPIN PROCESSING            @G860PXA 54400000
.************************************************************* @G860PXA 54450000
.*                                                             @G860PXA 54500000
.TALLC   ANOP                                                           54550000
         AIF   (T'&REGS NE 'O').TALLCR                                  54600000
.*       IHB001 WITH TYPE=ALL, REGS OPERAND REQUIRED NOT SPECIFIED      54650000
&MESSAGE SETC  'WITH TYPE='.'&TYPE'.', REGS'                            54700000
         IHBERMAC 1006,&MESSAGE                                         54750000
         MEXIT                                                          54800000
.TALLCR  ANOP                                                           54850000
         AIF   ('&NAME' EQ '').TALLCNA                                  54900000
&NAME    DC    0H'0'                                                    54950000
.TALLCNA ANOP                                                           55000000
         AIF   (T'&ASCB NE 'O').TALLCA                         @G387PXR 55050000
         AIF   (T'&LOCKHLD NE 'O').TALLCAR                     @G387PXR 55100000
         AIF   (T'&BRANCH NE 'O').TALLCNS                               55150000
         SR    15,15               PRESET R. C. AT LEAST ONE LOCK HELD  55200000
.TALLCNS AIF   ('&TYPE' EQ 'SPIN').TSPINC                               55250000
         L     &REGS(1),PSAHLHI-PSA(0,0)  GET CURRENT LOCKS    @G860PXA 55300000
*                                  HELD STRING                 @G860PXA 55350000
         AGO   .TALLCOM                                                 55400000
.TSPINC  LA    &REGS(1),4(0,0)     GET VALUE TO GENERATE MASK           55450000
         LCR   &REGS(1),&REGS(1)   GENERATE MASK TO CHECK ONLY SPIN LKS 55500000
         N     &REGS(1),PSAHLHI-PSA(0,0) KEEP ONLY HELD SPIN LOCKS,     55550000
*                                  IF ANY                      @ZA35343 55600000
         AGO   .TALLCM2            DON'T NEED LTR AFTER N      @G860PXB 55650000
.TALLCOM ANOP                                                           55700000
         LTR   &REGS(1),&REGS(1)   CHECK FOR ZERO                       55750000
.TALLCM2 ANOP                                                  @G860PXB 55800000
         AIF   (T'&BRANCH EQ 'O').TALLRC                                55850000
         AIF   ('&BRANCH(1)' EQ 'HELD').TALLBH                          55900000
         BZ    &BRANCH(2)          BRANCH NO LOCK HELD                  55950000
         MEXIT                                                          56000000
.TALLBH  BNZ   &BRANCH(2)          BRANCH AT LEAST ONE LOCK HELD        56050000
         MEXIT                                                          56100000
.TALLRC  BNZ   *+8                 BRANCH AT LEAST ONE LOCK HELD        56150000
         LA    15,4(0,0)           SET R. C. NO LOCK HELD               56200000
         MEXIT                                                          56250000
.TALLCA  ANOP                                                  @G387PXR 56300000
.*       IHB280 ASCB INVALID WITH TYPE=ALL                     @G387PXR 56350000
&MESSAGE SETC 'TYPE='.'&TYPE'                                  @G387PXR 56400000
         IHBERMAC 1020,ASCB,&MESSAGE                           @G387PXR 56450000
         MEXIT                                                 @G387PXR 56500000
.TALLCAR ANOP                                                  @G387PXR 56550000
.*       IHB280 LOCKHLD INVALID WITH TYPE=ALL                  @G387PXR 56600000
&MESSAGE SETC 'TYPE='.'&TYPE'                                  @G387PXR 56650000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                        @G387PXR 56700000
         MEXIT                                                 @G387PXR 56750000
.************************************************************* @G860PXA 56800000
.*   BEGINNING OF TEST,TYPE=REG PROCESSING                     @G860PXA 56850000
.************************************************************* @G860PXA 56900000
.TREGC   ANOP                                                           56950000
         AIF (T'&ASCB NE 'O').TREGCA                           @G387PXR 57000000
         AIF (T'&LOCKHLD NE 'O').TREGCR                        @G387PXR 57050000
         AIF (T'&BRANCH EQ 'O').TREGCNB                                 57100000
         AIF (T'&REGS NE 'O').TREGCBR                                   57150000
.*       IHB001 WITH BRANCH OPTION OF TYPE=REG,REGS REQUIRED NOT SPECI- 57200000
.*       FIED                                                           57250000
&MESSAGE SETC  'WITH BRANCH OPTION OF TYPE='.'&TYPE'.', REGS'           57300000
         IHBERMAC 1006,&MESSAGE                                         57350000
         MEXIT                                                          57400000
.TREGCBR ANOP                                                           57450000
         AIF   ('&NAME' EQ '').TREGCNN                                  57500000
&NAME    DC    0H'0'                                                    57550000
.TREGCNN LR    &REGS(1),&TYPE(1)        SAVE INPUT STRING               57600000
         N     &REGS(1),PSAHLHI-PSA(0,0) COMPARE TO LOCKS HELD          57650000
*                                       STRING                 @ZA35343 57700000
         CR    &REGS(1),&TYPE(1)        ARE ALL SPECIFIED LOCKS HELD    57750000
         AIF   ('&BRANCH(1)' EQ 'HELD').TREGCBH                         57800000
         BNE   &BRANCH(2)               BRANCH NOT ALL HELD             57850000
         MEXIT                                                          57900000
.TREGCBH BE    &BRANCH(2)               BRANCH ALL HELD                 57950000
         MEXIT                                                          58000000
.TREGCNB ANOP                                                           58050000
         AIF   ('&NAME' EQ '').TREGRNN                                  58100000
&NAME    DC    0H'0'                                                    58150000
.TREGRNN LR    15,&TYPE(1)              SAVE INPUT STRING               58200000
&REG1    SETC  '&TYPE(1)'                                      @G387PXR 58250000
         AIF   (T'&REGS EQ 'O').TREGCNR                                 58300000
&REG1    SETC  '&REGS(1)'                                      @G387PXR 58350000
         LR    &REG1,&TYPE(1)           MOVE STRING IN WORK REG@G387PXR 58400000
.TREGCNR N     &REG1,PSAHLHI-PSA(0,0)   COMPARE TO LOCKS HELD  @G387PXR 58450000
*                                       STRING                 @ZA35343 58500000
         XR    15,&REG1                 SET RC=0 IF ALL HELD   @G387PXR 58550000
         BZ    *+8                      EXIT ALL HELD                   58600000
         LA    15,4(0,0)                SET RC NOT ALL HELD             58650000
         MEXIT                                                          58700000
.TREGCA  ANOP                                                  @G387PXR 58750000
.*       IHB280 ASCB INVALID WITH TYPE=REG                     @G387PXR 58800000
&MESSAGE SETC   'TYPE='.'&TYPE'                                @G387PXR 58850000
         IHBERMAC 1020,ASCB,&MESSAGE                           @G387PXR 58900000
         MEXIT                                                 @G387PXR 58950000
.TREGCR  ANOP                                                  @G387PXR 59000000
.*       IHB280 LOCKHLD INVALID WITH TYPE=REG                  @G387PXR 59050000
&MESSAGE SETC  'TYPE='.'&TYPE'                                 @G387PXR 59100000
         IHBERMAC 1020,LOCKHLD,&MESSAGE                        @G387PXR 59150000
         MEXIT                                                 @G387PXR 59200000
.************************************************************* @G860PXA 59250000
.*   BEGINNING OF TEST,TYPE=CML PROCESSING                     @G860PXA 59300000
.************************************************************* @G860PXA 59350000
.TCMLCK  ANOP                                                  @G387PXR 59400000
         AIF   (T'&ASCB NE 'O').TCMLAS                         @G387PXR 59450000
         AIF   (T'&LOCKHLD NE 'O').TCMLREG                     @G387PXR 59500000
.*       IHB001 LOCKHLD/ASCB OPERAND REQUIRED NOT SPECIFIED    @G387PXR 59550000
         IHBERMAC 1006,LOCKHLD/ASCB                            @G387PXR 59600000
         MEXIT                                                 @G387PXR 59650000
.TCMLAS  ANOP                                                  @G387PXR 59700000
         AIF   (T'&LOCKHLD EQ 'O').TCMLASC                     @G387PXR 59750000
.*       IHB280 LOCKHLD INVALID WITH ASCB                      @G387PXR 59800000
         IHBERMAC 1020,LOCKHLD,ASCB                            @G387PXR 59850000
         MEXIT                                                 @G387PXR 59900000
.TCMLREG ANOP                                                  @G387PXR 59950000
         AIF   ('&LOCKHLD'(1,1) NE '(').TCMLRNV                @G387PXR 60000000
         AIF   ('&LOCKHLD'(K'&LOCKHLD,1) EQ ')').TCMLROK       @G387PXR 60050000
.*       IHB002 INVALID LOCKHLD OPERAND SPECIFIED - XXX        @G387PXR 60100000
.TCMLRNV IHBERMAC 1001,LOCKHLD,&LOCKHLD                        @G387PXR 60150000
         MEXIT                                                 @G387PXR 60200000
.TCMLROK AIF   (T'&BRANCH NE 'O').TCMLR                        @G387PXR 60250000
         SR    15,15                    .PRESET LOCK HELD R.C. @G387PXR 60300000
.TCMLR   AIF   (T'&ADDR EQ 'O').TCMLRTM                        @G387PXR 60350000
         IHB280 ADDR INVALID WITH CML                          @G387PXR 60400000
         IHBERMAC 1020,ADDR,CML                                @G387PXR 60450000
         MEXIT                                                 @G387PXR 60500000
.TCMLRTM ANOP                                                  @G387PXR 60550000
&REG2    SETC  '&LOCKHLD(1)'                                   @G387PXR 60600000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD    @G387PXR 60650000
         AIF   (T'&BRANCH EQ 'O').TCMLRC                       @G387PXR 60700000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLBH                 @G387PXR 60750000
         BZ    &BRANCH(2)               .BRANCH CML NOT HELD   @G387PXR 60800000
         AGO   .TCMLRCL                                        @G387PXR 60850000
.TCMLRC  BZ    &LABEL.A                 .BRANCH CML NOT HELD   @G387PXR 60900000
         AGO   .TCMLRCL                                        @G387PXR 60950000
.TCMLBH  BZ    &LABEL.B                 .BRANCH CML NOT HELD   @G387PXR 61000000
.TCMLRCL ANOP                                                  @G387PXR 61050000
         L     &REG2,PSALOCAL-FLC(0,0)  .LOAD CLHT CML VALUE   @G387PXR 61100000
         LTR   &REG2,&REG2              .CML LOCK HELD?        @G387PXR 61150000
         AIF   (T'&BRANCH EQ 'O').TCMLRC1                      @G387PXR 61200000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLRBH                @G387PXR 61250000
         BZ    &BRANCH(2)               .BRANCH CML NOT HELD   @G387PXR 61300000
         MEXIT                                                 @G387PXR 61350000
.TCMLRC1 ANOP                                                  @G387PXR 61400000
         BNZ   *+8                      .BRANCH - CML HELD     @G387PXR 61450000
&LABEL.A LA    15,4(0,0)                .SET R.C.=4 NOT HELD   @G387PXR 61500000
         MEXIT                                                 @G387PXR 61550000
.TCMLRBH BNZ   &BRANCH(2)               .BRANCH - LOCK HELD    @G387PXR 61600000
&LABEL.B DC    0H'0'                                           @G387PXR 61650000
         MEXIT                                                 @G387PXR 61700000
.TCMLASC ANOP                                                  @G387PXR 61750000
         AIF   ('&ASCB'(1,1) NE '(').TCMLANV                   @G387PXR 61800000
         AIF   ('&ASCB'(K'&ASCB,1) EQ ')').TCMLAOK             @G387PXR 61850000
.*       IHB002  INVALID ASCB OPERAND SPECIFIED - XXX          @G387PXR 61900000
.TCMLANV IHBERMAC 1001,ASCB,&ASCB                              @G387PXR 61950000
         MEXIT                                                 @G387PXR 62000000
.TCMLAOK AIF   (T'&BRANCH NE 'O').TCMLASA                      @G387PXR 62050000
         SR    15,15                    .PRESET LOCK HELD R.C. @G387PXR 62100000
.TCMLASA AIF   (T'&ADDR EQ 'O').TCMLATM                        @G387PXR 62150000
.*       IHB280 ADDR INVALID WITH CML                          @G387PXR 62200000
         IHBERMAC 1020,ADDR,CML                                @G387PXR 62250000
         MEXIT                                                 @G387PXR 62300000
.TCMLATM ANOP                                                  @G387PXR 62350000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD    @G387PXR 62400000
         AIF   (T'&BRANCH EQ 'O').TCMLARC                      @G387PXR 62450000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLABH                @G387PXR 62500000
         BZ    &BRANCH(2)               .BRANCH - LOCK NOT HELD@G387PXR 62550000
         AGO   .TCMLACL                                        @G387PXR 62600000
.TCMLARC BZ    &LABEL.B                 .BRANCH - LOCK NOT HELD@G387PXR 62650000
         AGO   .TCMLACL                                        @G387PXR 62700000
.TCMLABH BZ    &LABEL.C                 .BRANCH - LOCK NOT HELD@G387PXR 62750000
.TCMLACL ANOP                                                  @G387PXR 62800000
         CLC   PSAFZERO-FLC(4,0),PSALOCAL-FLC(0) .CML LOCK     @ZMB0398 62850000
*                                       HELD?                  @ZMB0398 62900000
         BNE   &LABEL.D                 .YES CONTINUE CHECKS   @G382PXR 62950000
         CL    &ASCB(1),PSAAOLD-FLC(0,0) .ASCB SPECIFIED=HOME? @G382PXR 63000000
         AIF   (T'&BRANCH EQ 'O').TCMLAR1                      @G387PXR 63050000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLAH1                @G387PXR 63100000
         BNE   &BRANCH(2)               .BRANCH LOCK NOT HELD  @G387PXR 63150000
         B     &LABEL.C                 .BRANCH LOCK HELD      @G382PXR 63200000
         AGO   .TCMLAC1                 .CONTINUE CHECKS       @G382PXR 63250000
.TCMLAR1 ANOP                                                  @G382PXR 63300000
         BE    &LABEL.C                 .BRANCH LOCK HELD      @G382PXR 63350000
         B     &LABEL.B                 .BRANCH - SET R.C.     @G382PXR 63400000
         AGO   .TCMLAC1                                        @G382PXR 63450000
.TCMLAH1 ANOP                                                  @G382PXR 63500000
         BE    &BRANCH(2)               .BRANCH  LOCK HELD     @G382PXR 63550000
         B     &LABEL.C                 .BRANCH  LOCK NOT HELD @G382PXR 63600000
.TCMLAC1 ANOP                                                  @G382PXR 63650000
&LABEL.D CL    &ASCB(1),PSALOCAL-FLC(0,0) .CML LOCK HELD?      @G382PXR 63700000
         AIF   (T'&BRANCH EQ 'O').TCMLAR2                      @G382PXR 63750000
         AIF   ('&BRANCH(1)' EQ 'HELD').TCMLAH2                @G382PXR 63800000
         BNE   &BRANCH(2)               .BRANCH NOT HELD       @G382PXR 63850000
         AGO   .TCMLEND                 .END OF CML CHECKS     @G382PXR 63900000
.TCMLAR2 ANOP                                                  @G382PXR 63950000
         BE    &LABEL.C                 .BRANCH LOCK HELD      @G382PXR 64000000
         AGO   .TCMLAR3                                        @G382PXR 64050000
.TCMLAH2 ANOP                                                  @G382PXR 64100000
         BE    &BRANCH(2)               .BRANCH LOCK HELD      @G382PXR 64150000
         AGO   .TCMLEND                                        @G382PXR 64200000
.TCMLAR3 ANOP                                                  @G382PXR 64250000
&LABEL.B LA    15,4(0,0)                .LOCK NOT HELD R.C.    @G382PXR 64300000
.TCMLEND ANOP                                                  @G382PXR 64350000
&LABEL.C DC    0H'0'                    .BRANCH LABEL          @G382PXR 64400000
         MEXIT                                                 @G387PXR 64450000
.************************************************************* @G860PXK 64500000
.* BEGINNING OF TEST PROCESSING; TYPE = ALOCAL OR CPU        * @G860PXK 64550000
.************************************************************* @G860PXK 64600000
.TALOC   ANOP                                                  @G860PXK 64650000
&REG2    SETC  '&LOCKHLD(1)'                                   @G387PXR 64700000
         AIF   ('&NAME' EQ '').TALOCNN                         @G387PXR 64750000
&NAME    DC    0H'0'                                           @G387PXR 64800000
.TALOCNN AIF   (T'&ASCB EQ 'O').TALOCRG                        @G387PXR 64850000
.*       IHB280 ASCB INVALID WITH XXXXXX                       @G860PXK 64900000
         IHBERMAC  1020,ASCB,&TYPE                             @G860PXK 64950000
         MEXIT                                                 @G387PXR 65000000
.TALOCRG ANOP                                                  @G387PXR 65050000
         AIF   (T'&LOCKHLD EQ 'O').TALOCBR                     @G387PXR 65100000
         AIF   ('&LOCKHLD'(1,1) NE '(').TALOCRI                @G387PXR 65150000
         AIF   ('&LOCKHLD'(K'&LOCKHLD,1) EQ ')').TALOCOK       @G387PXR 65200000
.*       IHB002 INVALID LOCKHLD OPERAND SPECIFIED - XXX        @G387PXR 65250000
.TALOCRI IHBERMAC 1001,LOCKHLD,&LOCKHLD                        @G387PXR 65300000
         MEXIT                                                 @G387PXR 65350000
.TALOCOK ANOP                                                  @G387PXR 65400000
         AIF   (T'&BRANCH NE 'O').TALOC1                       @G387PXR 65450000
         LA    15,4(0,0)               .PRESET NOT HELD R.C.   @G387PXR 65500000
.TALOC1  ANOP                                                  @G387PXR 65550000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD    @G387PXR 65600000
         AIF   (T'&BRANCH EQ 'O').TALOCRC                      @G387PXR 65650000
         AIF   ('&BRANCH(1)' EQ 'HELD').TALOCHD                @G387PXR 65700000
         BZ    &BRANCH(2)              .BRANCH NOT HELD        @G387PXR 65750000
         AIF   ('&TYPE' EQ 'CPU').TCPU1                        @G860PXK 65800000
         L     &REG2,PSALOCAL-FLC(0,0) .LOAD ASCB ADDR OF      @ZM50156 65850000
*                                      .LOCKED ADDR. SPACE     @G387PXR 65900000
         MEXIT                                                 @G387PXR 65950000
.TCPU1   ANOP                                                  @G860PXK 66000000
         L     &REG2,PSACPUL-FLC(0,0)  .LOAD CPU LOCKS HELD CNT@G860PXK 66050000
         MEXIT                                                 @G860PXK 66100000
.TALOCHD ANOP                                                  @G387PXR 66150000
         BZ    &LABEL.A                .BRANCH NOT HELD        @G387PXR 66200000
         AIF   ('&TYPE' EQ 'CPU').TCPU2                        @G860PXK 66250000
         L     &REG2,PSALOCAL-FLC(0,0) .LOAD ASCB ADDR         @ZM50156 66300000
*                                      .OF LOCKED ADDR. SPACE  @G387PXR 66350000
         AGO   .TCPU2A                                         @G860PXK 66400000
.TCPU2   ANOP                                                  @G860PXK 66450000
         L     &REG2,PSACPUL-FLC(0,0)  .LOAD CPU LOCKS HELD CNT@G860PXK 66500000
.TCPU2A  ANOP                                                  @G860PXK 66550000
         B     &BRANCH(2)              .BRANCH HELD            @G387PXR 66600000
&LABEL.A DC    0H'0'                   .BRANCH LABEL           @G387PXR 66650000
         MEXIT                                                 @G387PXR 66700000
.TALOCRC ANOP                                                  @G387PXR 66750000
         BZ    &LABEL.B                .BRANCH NOT HELD        @G387PXR 66800000
         AIF   ('&TYPE' EQ 'CPU').TCPU3                        @G860PXK 66850000
         L     &REG2,PSALOCAL-FLC(0,0) .LOAD ASCB ADDR         @ZM50156 66900000
*                                      .OF LOCKED ADDR. SPACE  @G387PXR 66950000
         AGO   .TCPU3A                                         @G860PXK 67000000
.TCPU3   ANOP                                                  @G860PXK 67050000
         L     &REG2,PSACPUL-FLC(0,0)  .LOAD CPU LOCKS HELD CNT@G860PXK 67100000
.TCPU3A  ANOP                                                  @G860PXK 67150000
         SLR   15,15                   .SET LOCK HELD R.C.     @G387PXR 67200000
&LABEL.B DC    0H'0'                   .BRANCH LABEL           @G387PXR 67250000
         MEXIT                                                 @G387PXR 67300000
.TALOCBR ANOP                                                  @G387PXR 67350000
.* NOTE - TEST - NO LOCKHLD PARM SPECIFIED                     @G860PXK 67400000
         AIF   (T'&BRANCH NE 'O').TALOC2                       @G387PXR 67450000
         SLR   15,15                   .PRESET LOCK HELD R.C.  @G387PXR 67500000
.TALOC2  ANOP                                                  @G387PXR 67550000
         TM    PSAHLHI-FLC+&BYTE.(0),&MASK .CHECK LOCK HELD    @G387PXR 67600000
         AIF   (T'&BRANCH EQ 'O').TALOCR1                      @G387PXR 67650000
         AIF   ('&BRANCH(1)' EQ 'HELD').TALOCH1                @G387PXR 67700000
         BZ    &BRANCH(2)              .BRANCH NOT HELD        @G387PXR 67750000
         MEXIT                                                 @G387PXR 67800000
.TALOCH1 ANOP                                                  @G387PXR 67850000
         BNZ   &BRANCH(2)              .BRANCH HELD            @G387PXR 67900000
         MEXIT                                                 @G387PXR 67950000
.TALOCR1 ANOP                                                  @G387PXR 68000000
         BNZ   &LABEL.C                .BRANCH HELD            @G860PXK 68050000
         LA    15,4(0,0)               .SET LOCK NOT HELD R.C. @G387PXR 68100000
&LABEL.C DC    0H'0'                   .BRANCH LABEL           @G387PXR 68150000
         MEXIT                                                 @G387PXR 68200000
.ENDIT   ANOP                                                           68250000
         MEXIT                                                 @G860PXD 68300000
.LEVEL1  ANOP                                                  @G860PXD 68350000
&NAME    SETLOCK7 &REQUEST,TYPE=&TYPE,ADDR=&ADDR,MODE=&MODE,   @G860PXD-68400000
               RELATED=&RELATED,REGS=&REGS,BRANCH=&BRANCH,     @G860PXD-68450000
               ASCB=&ASCB,LOCKHLD=&LOCKHLD,&DISABLE            @G860PXD 68500000
         MEXIT                                                 @G860PXD 68550000
         MEND                                                           68600000
* */                                                                    68650000
*  SETLOCK8 :                                                           68700000
*  MACRO                                                                68750000
*  KEYS(TYPE,ADDR,MODE,DISABLED,ASCB,SCOPE,REGS,LOCK,      /*@ZMC0463*/ 68800000
*       BRANCH,LOCKHLD,RELATED);                           /*@G860PXK*/ 68850000
*  ANS('?'||MACLABEL||'SETLCKP8 '||MACLIST||MACKEYS||';');              68900000
*% END;                                                                 68950000
